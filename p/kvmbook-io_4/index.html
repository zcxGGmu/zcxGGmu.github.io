<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="1 I/OËôöÊãüÂåñÊ¶ÇËø∞ CPUËÆøÈóÆÂ§ñÈÉ®ËÆæÂ§áÁöÑ‰∏ªË¶ÅÊé•Âè£ÊòØËÆæÂ§áÊèê‰æõÁöÑI/OËµÑÊ∫êÔºåÁÑ∂ËÄå‰∏Ä‰∏™ËÆ°ÁÆóÊú∫Á≥ªÁªüÁöÑÁâ©ÁêÜÂ§ñÈÉ®ËÆæÂ§áËµÑÊ∫êÊòØÊúâÈôêÁöÑ„ÄÇÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåÂÖ®ÈÉ®ËôöÊãüÊú∫ÊâÄÈúÄË¶ÅÁöÑI/OËÆæÂ§áÈÄöÂ∏∏‰ºöÂ§ö‰∫éÁ°¨‰ª∂ÊâÄËÉΩÊèê‰æõÁöÑI/OËÆæÂ§áËµÑÊ∫ê„ÄÇ\n">
<title>Kvmbook Io_4</title>

<link rel='canonical' href='https://zcxggmu.github.io/p/kvmbook-io_4/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Kvmbook Io_4">
<meta property='og:description' content="1 I/OËôöÊãüÂåñÊ¶ÇËø∞ CPUËÆøÈóÆÂ§ñÈÉ®ËÆæÂ§áÁöÑ‰∏ªË¶ÅÊé•Âè£ÊòØËÆæÂ§áÊèê‰æõÁöÑI/OËµÑÊ∫êÔºåÁÑ∂ËÄå‰∏Ä‰∏™ËÆ°ÁÆóÊú∫Á≥ªÁªüÁöÑÁâ©ÁêÜÂ§ñÈÉ®ËÆæÂ§áËµÑÊ∫êÊòØÊúâÈôêÁöÑ„ÄÇÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåÂÖ®ÈÉ®ËôöÊãüÊú∫ÊâÄÈúÄË¶ÅÁöÑI/OËÆæÂ§áÈÄöÂ∏∏‰ºöÂ§ö‰∫éÁ°¨‰ª∂ÊâÄËÉΩÊèê‰æõÁöÑI/OËÆæÂ§áËµÑÊ∫ê„ÄÇ\n">
<meta property='og:url' content='https://zcxggmu.github.io/p/kvmbook-io_4/'>
<meta property='og:site_name' content='zcxGGmu'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-10-17T10:06:54&#43;08:00'/><meta property='article:modified_time' content='2024-10-17T10:06:54&#43;08:00'/>
<meta name="twitter:title" content="Kvmbook Io_4">
<meta name="twitter:description" content="1 I/OËôöÊãüÂåñÊ¶ÇËø∞ CPUËÆøÈóÆÂ§ñÈÉ®ËÆæÂ§áÁöÑ‰∏ªË¶ÅÊé•Âè£ÊòØËÆæÂ§áÊèê‰æõÁöÑI/OËµÑÊ∫êÔºåÁÑ∂ËÄå‰∏Ä‰∏™ËÆ°ÁÆóÊú∫Á≥ªÁªüÁöÑÁâ©ÁêÜÂ§ñÈÉ®ËÆæÂ§áËµÑÊ∫êÊòØÊúâÈôêÁöÑ„ÄÇÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåÂÖ®ÈÉ®ËôöÊãüÊú∫ÊâÄÈúÄË¶ÅÁöÑI/OËÆæÂ§áÈÄöÂ∏∏‰ºöÂ§ö‰∫éÁ°¨‰ª∂ÊâÄËÉΩÊèê‰æõÁöÑI/OËÆæÂ§áËµÑÊ∫ê„ÄÇ\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu16968365064894999835.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">zcxGGmu</a></h1>
            <h2 class="site-description">riscv, linux-kernel/kvm, llm-app/infer</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/zcxGGmu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#1-ioËôöÊãüÂåñÊ¶ÇËø∞">1 I/OËôöÊãüÂåñÊ¶ÇËø∞</a>
      <ol>
        <li><a href="#11-ioËøáÁ®ã">1.1 I/OËøáÁ®ã</a>
          <ol>
            <li><a href="#pio">PIO</a></li>
            <li><a href="#dma">DMA</a></li>
          </ol>
        </li>
        <li><a href="#12-ioËôöÊãüÂåñÁöÑÂü∫Êú¨‰ªªÂä°">1.2 I/OËôöÊãüÂåñÁöÑÂü∫Êú¨‰ªªÂä°</a>
          <ol>
            <li><a href="#ËÆøÈóÆÊçïËé∑">ËÆøÈóÆÊçïËé∑</a></li>
            <li><a href="#Êèê‰æõioËÆøÈóÆÊé•Âè£">Êèê‰æõI/OËÆøÈóÆÊé•Âè£</a></li>
            <li><a href="#ÂÆûÁé∞ËÆæÂ§áÁöÑÂäüËÉΩ">ÂÆûÁé∞ËÆæÂ§áÁöÑÂäüËÉΩ</a></li>
          </ol>
        </li>
        <li><a href="#13-ËΩØ‰ª∂ÂÆûÁé∞ÁöÑioËôöÊãüÂåñ">1.3 ËΩØ‰ª∂ÂÆûÁé∞ÁöÑI/OËôöÊãüÂåñ</a>
          <ol>
            <li><a href="#ËÆæÂ§áÊ®°Êãü-ÂÖ®ËôöÊãüÂåñ">ËÆæÂ§áÊ®°Êãü (ÂÖ®ËôöÊãüÂåñ)</a></li>
            <li><a href="#ÂçäËôöÊãüÂåñ">ÂçäËôöÊãüÂåñ</a></li>
          </ol>
        </li>
        <li><a href="#14-Á°¨‰ª∂ËæÖÂä©ÁöÑioËôöÊãüÂåñ">1.4 Á°¨‰ª∂ËæÖÂä©ÁöÑI/OËôöÊãüÂåñ</a>
          <ol>
            <li><a href="#ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ">ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ</a></li>
            <li><a href="#sr-iov">SR-IOV</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#2-ioËôöÊãüÂåñÁöÑÂÆûÁé∞ÊñπÂºè">2 I/OËôöÊãüÂåñÁöÑÂÆûÁé∞ÊñπÂºè</a>
      <ol>
        <li><a href="#21-pciËÆæÂ§áÁÆÄ‰ªã">2.1 PCIËÆæÂ§áÁÆÄ‰ªã</a></li>
        <li><a href="#22-ËÆæÂ§áÊ®°Êãü">2.2 ËÆæÂ§áÊ®°Êãü</a></li>
        <li><a href="#23-ioÂçäËôöÊãüÂåñ">2.3 I/OÂçäËôöÊãüÂåñ</a>
          <ol>
            <li><a href="#virtio-pci">virtio-pci</a></li>
            <li><a href="#virtqueue">virtqueue</a>
              <ol>
                <li><a href="#descriptor-table">descriptor table</a></li>
                <li><a href="#available-ring">available ring</a></li>
                <li><a href="#used-ring">used ring</a></li>
                <li><a href="#virtqueueÂàùÂßãÂåñ">virtqueueÂàùÂßãÂåñ</a></li>
              </ol>
            </li>
            <li><a href="#virtio-net">virtio-net</a></li>
            <li><a href="#vhost">vhost</a>
              <ol>
                <li><a href="#vhost-user-todo">vhost-user //TODO</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#24-ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ">2.4 ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ</a></li>
        <li><a href="#25-vfio">2.5 VFIO</a></li>
        <li><a href="#26-sr-iov">2.6 SR-IOV</a></li>
      </ol>
    </li>
    <li><a href="#3-qemukvmËôöÊãüËÆæÂ§áÁöÑÂÆûÁé∞">3 QEMU/KVMËôöÊãüËÆæÂ§áÁöÑÂÆûÁé∞</a>
      <ol>
        <li><a href="#31-qemuÂØπË±°Ê®°Âûã">3.1 QEMUÂØπË±°Ê®°Âûã</a>
          <ol>
            <li><a href="#ËÆæÂ§áÂØπË±°Á±ªÊ≥®ÂÜå">ËÆæÂ§áÂØπË±°Á±ªÊ≥®ÂÜå</a></li>
            <li><a href="#ËÆæÂ§áÂØπË±°Á±ªÂàõÂª∫">ËÆæÂ§áÂØπË±°Á±ªÂàõÂª∫</a></li>
            <li><a href="#ËÆæÂ§áÂØπË±°ÂÆû‰æãÂàõÂª∫">ËÆæÂ§áÂØπË±°ÂÆû‰æãÂàõÂª∫</a></li>
            <li><a href="#ËÆæÂ§áÂØπË±°ÂÆû‰æãÂÖ∑Áé∞Âåñ">ËÆæÂ§áÂØπË±°ÂÆû‰æãÂÖ∑Áé∞Âåñ</a></li>
          </ol>
        </li>
        <li><a href="#32-‰∏ªÊùøËäØÁâáÁªÑ‰∏éÊÄªÁ∫øÊ®°Êãü">3.2 ‰∏ªÊùøËäØÁâáÁªÑ‰∏éÊÄªÁ∫øÊ®°Êãü</a>
          <ol>
            <li><a href="#i440fxËäØÁâáÂàùÂßãÂåñ">I440FXËäØÁâáÂàùÂßãÂåñ</a></li>
            <li><a href="#pciËÆæÂ§áÊ≥®ÂÜåÂà∞ÊÄªÁ∫ø‰∏ä">PCIËÆæÂ§áÊ≥®ÂÜåÂà∞ÊÄªÁ∫ø‰∏ä</a></li>
          </ol>
        </li>
        <li><a href="#33-qemukvmËÆæÂ§áËÆøÈóÆÁöÑÊ®°Êãü">3.3 QEMU/KVMËÆæÂ§áËÆøÈóÆÁöÑÊ®°Êãü</a>
          <ol>
            <li><a href="#ËôöÊãüÊú∫ÂèëËµ∑pioËÆøÈóÆ">ËôöÊãüÊú∫ÂèëËµ∑PIOËÆøÈóÆ</a>
              <ol>
                <li><a href="#‰ªévm-exitÂà∞Â§ÑÁêÜio">‰ªéVM-ExitÂà∞Â§ÑÁêÜIO</a></li>
                <li><a href="#kvmÁöÑioÂ§ÑÁêÜÂáΩÊï∞-ÂÜÖÊ†∏ÊÄÅ">KVMÁöÑIOÂ§ÑÁêÜÂáΩÊï∞ (ÂÜÖÊ†∏ÊÄÅ)</a></li>
              </ol>
            </li>
            <li><a href="#ËôöÊãüÊú∫ÂèëËµ∑mmioËÆøÈóÆ">ËôöÊãüÊú∫ÂèëËµ∑MMIOËÆøÈóÆ</a>
              <ol>
                <li><a href="#qemuËÆæÂ§áÂàùÂßãÂåñ">QEMUËÆæÂ§áÂàùÂßãÂåñ</a></li>
                <li><a href="#kvmÂàùÂßãÂåñËÆæÁΩÆ">KVMÂàùÂßãÂåñËÆæÁΩÆ</a></li>
                <li><a href="#kvm‰∏≠mmioÂ§ÑÁêÜ">KVM‰∏≠MMIOÂ§ÑÁêÜ</a></li>
                <li><a href="#qemu‰∏≠piommioÂ§ÑÁêÜ">QEMU‰∏≠PIO/MMIOÂ§ÑÁêÜ</a></li>
              </ol>
            </li>
            <li><a href="#qemuÊ®°ÊãüËÆæÂ§áÂäüËÉΩ">QEMUÊ®°ÊãüËÆæÂ§áÂäüËÉΩ</a></li>
          </ol>
        </li>
        <li><a href="#34-ÂÆûÈ™å-‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®">3.4 ÂÆûÈ™å: ‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®</a>
          <ol>
            <li><a href="#eduËÆæÂ§áÂäüËÉΩÊ®°Êãü">eduËÆæÂ§áÂäüËÉΩÊ®°Êãü</a></li>
            <li><a href="#‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®">‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®</a>
              <ol>
                <li><a href="#pci_probe">pci_probe</a></li>
                <li><a href="#irq_handler">irq_handler</a></li>
                <li><a href="#edu_ioctl">edu_ioctl</a></li>
              </ol>
            </li>
            <li><a href="#Êï¥‰ΩìÂÆûÈ™åÊµÅÁ®ã">Êï¥‰ΩìÂÆûÈ™åÊµÅÁ®ã</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#4-todo-giantvm‰∏≠ÁöÑioÂ§ÑÁêÜ">4 //TODO: GiantVM‰∏≠ÁöÑI/OÂ§ÑÁêÜ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/kvmbook-io_4/">Kvmbook Io_4</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-10-17</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 84 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="1-ioËôöÊãüÂåñÊ¶ÇËø∞">1 I/OËôöÊãüÂåñÊ¶ÇËø∞
</h1><p>CPUËÆøÈóÆÂ§ñÈÉ®ËÆæÂ§áÁöÑ‰∏ªË¶ÅÊé•Âè£ÊòØËÆæÂ§áÊèê‰æõÁöÑI/OËµÑÊ∫êÔºåÁÑ∂ËÄå‰∏Ä‰∏™ËÆ°ÁÆóÊú∫Á≥ªÁªüÁöÑÁâ©ÁêÜÂ§ñÈÉ®ËÆæÂ§áËµÑÊ∫êÊòØÊúâÈôêÁöÑ„ÄÇÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåÂÖ®ÈÉ®ËôöÊãüÊú∫ÊâÄÈúÄË¶ÅÁöÑI/OËÆæÂ§áÈÄöÂ∏∏‰ºöÂ§ö‰∫éÁ°¨‰ª∂ÊâÄËÉΩÊèê‰æõÁöÑI/OËÆæÂ§áËµÑÊ∫ê„ÄÇ</p>
<p>ËôöÊãüÊú∫‰Ωú‰∏∫‰∏ÄÂè∞‚ÄúËôöÊãü‚ÄùÁöÑÊú∫Âô®ÔºåËøêË°åÂú®ËôöÊãüÊú∫‰∏≠ÁöÑÂ∫îÁî®Á®ãÂ∫èÂêåÊ†∑ÊúâËÆøÈóÆÂ§ñËÆæÁöÑÈúÄÊ±ÇÔºåÊâÄ‰ª•Â¶Ç‰ΩïÂ§ÑÁêÜËôöÊãüÊú∫ÂèëËµ∑ÁöÑI/OËØ∑Ê±ÇÊòØI/OËôöÊãüÂåñÊâÄË¶ÅËß£ÂÜ≥ÁöÑÈóÆÈ¢ò„ÄÇHypervisorÈúÄË¶ÅÂ∞ÜËôöÊãüÊú∫‰∏≠ÁöÑI/OËØ∑Ê±ÇËΩ¨Êç¢‰∏∫ÂØπÂÆûÈôÖÁâ©ÁêÜËÆæÂ§áÁöÑËÆøÈóÆ„ÄÇ‰æãÂ¶ÇÔºåÂΩìËôöÊãüÊú∫‰∏≠ÁöÑÂ∫îÁî®ÂèëËµ∑ÂØπËôöÊãüÁ£ÅÁõòÁöÑËØªËØ∑Ê±ÇÊó∂ÔºåHypervisorÈúÄË¶ÅÂÆö‰ΩçÂà∞Áâ©ÁêÜÁ£ÅÁõòÁöÑÂØπÂ∫îÊâáÂå∫ÔºåÂπ∂Â∞ÜËØ•ÊâáÂå∫ÂØπÂ∫îÁöÑÊï∞ÊçÆËøîÂõûÁªôËôöÊãüÊú∫‰∏≠ÁöÑÂ∫îÁî®Á®ãÂ∫è„ÄÇ‰∏∫‰∫ÜÂÆûÁé∞Ëøô‰∏ÄËΩ¨Êç¢ÔºåHypervisor‰ºöÈÄöËøá‰∏ÄÁ≥ªÂàóËΩØÁ°¨‰ª∂Êú∫Âà∂Êà™Ëé∑ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂèëËµ∑ÁöÑPIO„ÄÅMMIOÂíåDMAÁ≠âI/OËÆøÈóÆËØ∑Ê±ÇÔºåÂπ∂Â§ÑÁêÜËôöÊãüÊú∫‰∏≠ÈúÄË¶ÅÊâßË°åÁöÑI/OÊìç‰ΩúÔºåÊúÄÂêéÂêëÂÆ¢Êà∑Êú∫ÂÜÖÁöÑÈ©±Âä®Á®ãÂ∫èËøîÂõûÊ≠£Á°ÆÁöÑI/OÁªìÊûú„ÄÇ‰∏äËø∞ËΩ¨Êç¢ËøáÁ®ãÁß∞‰∏∫I/OËôöÊãüÂåñ„ÄÇ</p>
<p>I/OËôöÊãüÂåñÂú®ÂÆûÁé∞ËøáÁ®ã‰∏≠Â≠òÂú®‰∏Ä‰∫õÈóÆÈ¢òÔºåËøô‰∫õÈóÆÈ¢ò‰πüÊòØËôöÊãüÂåñÊäÄÊúØ‰∏ÄÁõ¥‰ª•Êù•ÁöÑÈöæÁÇπ„ÄÇÈ¶ñÂÖàI/OËÆæÂ§áÁßçÁ±ªÁπÅÂ§öÂπ∂‰∏îÂºÇÊûÑÊÄßÂº∫Ôºå‰∏çÂêåËÆæÂ§áÂèØËÉΩÈÄÇÁî®‰∫é‰∏çÂêåÁöÑËôöÊãüÂåñÊñπÂºèÔºåËøôÂ¢ûÂ§ß‰∫ÜÁ≥ªÁªüÂÆûÁé∞ÁöÑÂ§çÊùÇÂ∫¶„ÄÇÂÖ∂Ê¨°Âú®Á∫ØËΩØ‰ª∂ÂÆûÁé∞ÁöÑÊÉÖÂÜµ‰∏ãÔºåI/OËôöÊãüÂåñÈúÄË¶ÅÁªèËøáËôöÊãüÊú∫‰∏éÁâ©ÁêÜÊú∫‰∏≠ÁöÑ‰∏§Â±ÇI/OÊ†àÔºåÂØºËá¥I/OÊÄßËÉΩÂ§ßÂπÖ‰∏ãÈôçÔºåËøô‰ΩøÂæóI/OËôöÊãüÂåñÊàê‰∏∫ËôöÊãüÂåñÁöÑÊÄßËÉΩÁì∂È¢à„ÄÇ</p>
<h2 id="11-ioËøáÁ®ã">1.1 I/OËøáÁ®ã
</h2><p>I/OËøáÁ®ãÊòØCPU‰∏éÂ§ñÈÉ®ËÆæÂ§áÁõ∏‰∫íËÆøÈóÆÂíåÊï∞ÊçÆ‰∫§Êç¢ÁöÑÊ∏†ÈÅì„ÄÇÂ§ñÈÉ®ËÆæÂ§á‰ºö‰∏∫CPUÊèê‰æõÂåÖÊã¨<strong>ËÆæÂ§áÂØÑÂ≠òÂô®ÂíåËÆæÂ§áRAM</strong>ÔºàRandom Access MemoryÔºåÈöèÊú∫Â≠òÂÇ®Âô®ÔºâÂú®ÂÜÖÁöÑËÆæÂ§áÊé•Âè£ÔºåCPUËÉΩÂ§üÈÄöËøáËØªÂÜôËÆæÂ§áÊé•Âè£ÂÆåÊàêÂØπËÆæÂ§áÁöÑËÆøÈóÆÂíåÊìç‰Ωú„ÄÇ</p>
<p>ËÆæÂ§áÂØÑÂ≠òÂô®‰πüÁß∞‰∏∫‚ÄúI/OÁ´ØÂè£‚ÄùÔºåÈÄöÂ∏∏ÂåÖÊã¨<strong>ÊéßÂà∂ÂØÑÂ≠òÂô®„ÄÅÁä∂ÊÄÅÂØÑÂ≠òÂô®ÂíåÊï∞ÊçÆÂØÑÂ≠òÂô®</strong>‰∏âÂ§ßÁ±ª„ÄÇ</p>
<ul>
<li>ÊéßÂà∂ÂØÑÂ≠òÂô®Áî®Êù•Â≠òÊîæCPUÂêëËÆæÂ§áÂèëÂá∫ÁöÑÊéßÂà∂ÂëΩ‰ª§Ôºõ</li>
<li>Áä∂ÊÄÅÂØÑÂ≠òÂô®Áî®Êù•ÊåáÁ§∫Â§ñËÆæÂΩìÂâçÁä∂ÊÄÅÔºõ</li>
<li>Êï∞ÊçÆÂØÑÂ≠òÂô®Áî®‰∫éÂ≠òÊîæCPU‰∏éÂ§ñËÆæ‰πãÈó¥ÈúÄË¶Å‰∫§Êç¢ÁöÑÊï∞ÊçÆ„ÄÇ</li>
</ul>
<p>Âú®Êìç‰ΩúÁ≥ªÁªü‰∏≠ÔºåÊâÄÊúâÊéßÂà∂Â§ñÈÉ®ËÆæÂ§áÁöÑÊìç‰ΩúÂøÖÈ°ªÁî±ËÆæÂ§áÂØπÂ∫îÁöÑÈ©±Âä®Á®ãÂ∫èÊù•ÂÆåÊàê„ÄÇÊìç‰ΩúÁ≥ªÁªüÈúÄË¶Å‰∏∫‰∏çÂêåËÆæÂ§áÊèê‰æõÁõ∏Â∫îÁöÑÈ©±Âä®Á®ãÂ∫èÔºåÂõ†Ê≠§Âú®Êìç‰ΩúÁ≥ªÁªüÁöÑÊ∫êÁ†Å‰∏≠Ôºå‰∏éËÆæÂ§áÈ©±Âä®Áõ∏ÂÖ≥ÁöÑ‰ª£Á†ÅÂç†ÊúâÂæàÂ§ßÁöÑÊØî‰æã„ÄÇ**‰∏çÂêåÂéÇÂïÜÁîü‰∫ßÁöÑÂêå‰∏ÄÁßçËÆæÂ§áÔºåÂç≥‰ΩøÂÖ∂ÂÜÖÈÉ®ÈÄªËæëÁîµË∑ØÂíåÂõ∫‰ª∂ÂèØËÉΩ‰ºöÊúâÊâÄ‰∏çÂêåÔºå‰ΩÜÈÉΩÈÅµÂæ™Âêå‰∏ÄÁßçÊé•Âè£Ê†áÂáÜÔºå‰∏∫È©±Âä®Á®ãÂ∫èÊèê‰æõÁõ∏ÂêåÁöÑËÆæÂ§áÊé•Âè£ÔºåÂç≥I/OÁ´ØÂè£„ÄÇ**ÂΩìÈ©±Âä®Á®ãÂ∫èËÆøÈóÆI/OÁ´ØÂè£Êó∂ÔºåÂ§ñËÆæ‰ºöÊ†πÊçÆÊé•Âè£Ê†áÂáÜ‰∏≠ÁöÑË¶ÅÊ±ÇÈÄöËøáËÆæÂ§áÂõ∫‰ª∂ÂÆûÁé∞Áõ∏ÂÖ≥ÂäüËÉΩ„ÄÇËøôÁßçËÆæËÆ°‰ΩøÂæóÊìç‰ΩúÁ≥ªÁªüÊó†È°ª‰∏∫ÊØè‰∏™Â§ñËÆæÂéÇÂïÜÊèê‰æõ‰∏çÂêåÁöÑÈ©±Âä®Á®ãÂ∫èÔºå‰æãÂ¶ÇÔºöÂΩìÁî®Êà∑Êõ¥Êç¢‰∏çÂêåÂéÇÂïÜÁöÑÈº†Ê†áÊó∂ÔºåÁ≥ªÁªü‰∏≠ÁöÑÈº†Ê†áÈ©±Âä®Á®ãÂ∫è‰ºöËá™Âä®ÈÄÇÈÖçËØ•Èº†Ê†áËÆæÂ§á„ÄÇ</p>
<p>Ê†πÊçÆÊï∞ÊçÆ‰º†ÈÄÅËøáÁ®ãÊòØÂê¶ÈúÄË¶ÅCPUÁöÑÂèÇ‰∏éÔºåÂèØ‰ª•Â∞ÜI/OÊñπÂºèÂàÜ‰∏∫‰∏§Á±ªÔºåÂç≥ÂèØÁºñÁ®ãI/O(Programmed I/O)‰∏éDMA„ÄÇ</p>
<h3 id="pio">PIO
</h3><p>Âú®ÂèØÁºñÁ®ãI/OÊñπÂºè‰∏ãÔºåÂ§ñËÆæÊé•Âè£ÈúÄË¶ÅÈÄöËøá‰∏ÄÂÆöÁöÑÊñπÂºèË¢´Êò†Â∞ÑÂà∞Á≥ªÁªüÁöÑÂú∞ÂùÄÁ©∫Èó¥ÊâçËÉΩË¢´CPUËÆøÈóÆ„ÄÇÊ†πÊçÆÊò†Â∞ÑÂú∞ÂùÄÁ©∫Èó¥ÁöÑ‰∏çÂêåÔºåÂèàÂèØ‰ª•Â∞Ü<strong>ÂèØÁºñÁ®ãI/OÂàÜ‰∏∫PMIO‰∏éMMIO</strong>„ÄÇÁõ∏ËæÉ‰∫éPMIOÔºåMMIOÁöÑÂ∫îÁî®Êõ¥Âä†ÂπøÊ≥õÔºåÂá†‰πéÊâÄÊúâÁöÑCPUÊû∂ÊûÑÈÉΩÊîØÊåÅMMIOÔºåMMIO‰ΩøÁî®ÁöÑÂú∞ÂùÄÁ©∫Èó¥ÊòØÂÜÖÂ≠òÊâÄÂú®ÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥„ÄÇ</p>
<p>RISCÔºàReduced Instruction Set ComputerÔºåÁ≤æÁÆÄÊåá‰ª§ÈõÜËÆ°ÁÆóÊú∫ÔºâÁöÑCPUÔºàÂ¶ÇARM„ÄÅPowerPCÁ≠âÔºâÂè™ÊîØÊåÅMMIOÔºåÈááÁî®Áªü‰∏ÄÁºñÂùÄÁöÑÊñπÂºèÂ∞ÜI/OÁ´ØÂè£ÁºñÂùÄÂà∞Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑÁâπÂÆöÂå∫ÂüüÔºåÈÄöËøáÂÜÖÂ≠òËÆøÈóÆÊåá‰ª§ÂÆûÁé∞ÂØπI/OÁ´ØÂè£ÁöÑËÆøÈóÆ„ÄÇÁÑ∂ËÄåÊüê‰∫õÊû∂ÊûÑ‰πüÊîØÊåÅÂ∞ÜI/OÁ´ØÂè£Êò†Â∞ÑÂà∞‰∏ìÈó®ÁöÑI/OÂú∞ÂùÄÁ©∫Èó¥Ôºå‰æãÂ¶Çx86Êû∂ÊûÑ‰∏ÄÂÖ±Êúâ65536‰∏™8‰ΩçÁöÑI/OÁ´ØÂè£ÔºåÁºñÂè∑‰ªé0Âà∞0xffffÔºåËøôÊ†∑Â∞±ÂΩ¢Êàê‰∫Ü‰∏Ä‰∏™Áã¨Á´ã‰∫éÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑ64KBÁöÑI/OÂú∞ÂùÄÁ©∫Èó¥„ÄÇ</p>
<p>‰∏∫‰∫ÜÂå∫ÂàÜÁâ©ÁêÜÂú∞ÂùÄËÆøÈóÆÂíåI/OÁ©∫Èó¥ËÆøÈóÆÔºåx86Êû∂ÊûÑÊèê‰æõ‰∫Ü‰∏ìÁî®‰∫éÁ´ØÂè£ËÆøÈóÆÁöÑÊåá‰ª§‚Äî‚ÄîIN/OUT„ÄÇCPUÂèØ‰ª•ÈÄöËøáIN/OUTÊåá‰ª§ÂêëÊé•Âè£ÁîµË∑Ø‰∏≠ÁöÑÂØÑÂ≠òÂô®ÂèëÈÄÅÂëΩ‰ª§„ÄÅËØªÂèñÁä∂ÊÄÅÂíå‰º†ÈÄÅÊï∞ÊçÆ„ÄÇÂΩìIN/OUTÊåá‰ª§ËøêË°åÂú®ÂÜÖÊ†∏ÊÄÅÊó∂ÔºåÂèØ‰ª•ËÆøÈóÆÊï¥‰∏™I/OÂú∞ÂùÄÁ©∫Èó¥ÔºåÂ¶ÇÊûúËøêË°åÂú®CPUÁöÑ‰ΩéÁâπÊùÉÁ∫ßÔºåÂàôÂè™ËÉΩÊ†πÊçÆI/O‰ΩçÂõæ(I/O bitmap)ÁöÑÂÜÖÂÆπËÆøÈóÆÂÖÅËÆ∏ËÆøÈóÆÁöÑÁ´ØÂè£„ÄÇ</p>
<p>‰∏ãÂõæÂ±ïÁ§∫‰∫Ü<strong>ÈùûËôöÊãüÂåñÁéØÂ¢É</strong>‰∏ãÁöÑ‰∏ÄÊ¨°Á´ØÂè£Êò†Â∞ÑI/OÊµÅÁ®ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171544859.png" alt="image-20231117085628429" style="zoom:50%;" />
<h3 id="dma">DMA
</h3><p>DMAÊòØ‰∏ÄÁßçÂú®Â§ñËÆæ‰∏éÂÜÖÂ≠ò‰πãÈó¥‰∫§Êç¢Êï∞ÊçÆÁöÑÊé•Âè£ÊäÄÊúØÔºåÊï∞ÊçÆ‰º†ËæìËøáÁ®ãÊó†È°ªCPUÊéßÂà∂„ÄÇDMAÂÆûÁé∞‰∫ÜÂ§ñËÆæ‰∏éÂÜÖÂ≠ò‰πãÈó¥ÁöÑÁõ¥Êé•Êï∞ÊçÆ‰º†ËæìÔºå‰º†ËæìÈÄüÂ∫¶Âü∫Êú¨ÂèñÂÜ≥‰∫éÂ≠òÂÇ®Âô®ÂíåÂ§ñËÆæÊú¨Ë∫´ÁöÑÈÄüÂ∫¶ÔºåÈÄÇÁî®‰∫é‰∏Ä‰∫õÈ´òÈÄüI/OËÆæÂ§áËøõË°åÂ§ßÊâπÈáèÊï∞ÊçÆ‰º†ÈÄÅÁöÑÊÉÖÊôØ„ÄÇ</p>
<p>DMAÁöÑËøáÁ®ãÁî±DMACÔºàDMA ControllerÔºåDMAÊéßÂà∂Âô®ÔºâÊéßÂà∂ÔºåÂÆÉÊòØÂÜÖÂ≠òÂÇ®Âô®‰∏éÂ§ñËÆæ‰πãÈó¥ËøõË°åÈ´òÈÄüÊï∞ÊçÆ‰º†ÈÄÅÁöÑÁ°¨‰ª∂ÊéßÂà∂ÁîµË∑ØÔºåÊòØ‰∏ÄÁßçÂÆûÁé∞Áõ¥Êé•Êï∞ÊçÆ‰º†ËæìÁöÑ‰∏ìÁî®Â§ÑÁêÜÂô®„ÄÇDMACÂèØ‰ª•‰ªéCPUÊöÇÊó∂Êé•ÁÆ°Âú∞ÂùÄÊÄªÁ∫øÁöÑÊéßÂà∂ÊùÉÔºåÂπ∂ÂØπÂÜÖÂ≠òËøõË°åÂØªÂùÄÔºåÂêåÊó∂ËÉΩÂ§üÂä®ÊÄÅ‰øÆÊîπÂú∞ÂùÄÊåáÈíàÔºåÂÆåÊàêÊï∞ÊçÆÂú®Â§ñËÆæ‰∏éÂÜÖÂ≠ò‰πãÈó¥ÁöÑ‰º†ÈÄÅ„ÄÇ</p>
<p>Âú®ÂèëËµ∑DMAËÆøÈóÆÂâçÔºåËÆæÂ§áÈ©±Âä®‰ºöÂêëÂ§ñËÆæÊèê‰æõ‰∏ÄÁªÑÂÜÖÂ≠òÊèèËø∞Á¨¶ÔºåÊØè‰∏™ÂÜÖÂ≠òÊèèËø∞Á¨¶‰ºöÊåáÂÆöËÆæÂ§áDMAÂÜÖÂ≠òÂå∫ÂüüÁöÑÂü∫Âú∞ÂùÄÂíåÈïøÂ∫¶„ÄÇÊØèÊ¨°DMAÊìç‰ΩúËÆøÈóÆÁöÑÊòØÂÜÖÂ≠òÊèèËø∞Á¨¶ÂØπÂ∫îÁöÑËøûÁª≠ÂÜÖÂ≠òÁ©∫Èó¥Ôºå‰ΩÜÂ§ö‰∏™ÂÜÖÂ≠òÊèèËø∞Á¨¶‰ª£Ë°®ÁöÑÂÜÖÂ≠òÂùó‰πãÈó¥Âπ∂‰∏ç‰∏ÄÂÆöËøûÁª≠„ÄÇ</p>
<p>Âú®DMAËøáÁ®ã‰∏≠ÔºåDMAÊéßÂà∂Âô®Áõ¥Êé•‰ΩøÁî®Áâ©ÁêÜÂú∞ÂùÄËÆøÈóÆÂÜÖÂ≠òÔºåÂπ∂‰∏çÈúÄË¶ÅÁ∫øÊÄßÂú∞ÂùÄÂà∞Áâ©ÁêÜÂú∞ÂùÄÁöÑËΩ¨Êç¢ËøáÁ®ã„ÄÇÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåËôöÊãüÊú∫ÁöÑÈ©±Âä®Á®ãÂ∫èÊèê‰æõÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÂπ∂‰∏çÊòØÂÆûÈôÖÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåËøô‰ΩøÂæóËÆæÂ§áDMAÊìç‰ΩúÂèØËÉΩ‰ºöËÆøÈóÆÂà∞‰∏çÂ±û‰∫éËØ•ÂÆ¢Êà∑Êú∫ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂØπËôöÊãüÂåñÁéØÂ¢ÉÁöÑÂÆâÂÖ®ÊÄßÂíåÈöîÁ¶ªÊÄßÈÄ†ÊàêÁ†¥Âùè„ÄÇÁî±‰∫éDMAÊéßÂà∂Âô®ÊòØ‰∏Ä‰∏™Á°¨‰ª∂ÊéßÂà∂ÁîµË∑ØÔºåHypervisorÊó†Ê≥ïÈÄöËøáËΩØ‰ª∂ÁöÑÊñπÂºèÊà™Ëé∑ËÆæÂ§áÁöÑDMAÊìç‰ΩúÔºå‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢òÔºåIntelÊé®Âá∫‰∫ÜVT-dÔºàVirtualization Technology for Direct I/OÔºåÁõ¥Êé•I/OËôöÊãüÂåñÊäÄÊúØÔºâÊäÄÊúØÔºåÊòØIOMMUÁöÑÊ†áÂáÜÂÆûÁé∞„ÄÇ</p>
<h2 id="12-ioËôöÊãüÂåñÁöÑÂü∫Êú¨‰ªªÂä°">1.2 I/OËôöÊãüÂåñÁöÑÂü∫Êú¨‰ªªÂä°
</h2><h3 id="ËÆøÈóÆÊçïËé∑">ËÆøÈóÆÊçïËé∑
</h3><p>I/OËôöÊãüÂåñÁöÑ‰∏Ä‰∏™Âü∫Êú¨Ë¶ÅÊ±ÇÊòØËÉΩÂ§üÈöîÁ¶ªÂíåÈôêÂà∂ËôöÊãüÊú∫ÂØπÁúüÂÆûÁâ©ÁêÜËÆæÂ§áÁöÑÁõ¥Êé•ËÆøÈóÆ„ÄÇÂú®ËôöÊãüÊú∫Êú™Ë¢´ÂàÜÈÖçÊòéÁ°ÆÁöÑÁâ©ÁêÜËÆæÂ§áÊó∂ÔºåHypervisor‰∏çÂÖÅËÆ∏ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÁõ¥Êé•‰∏éI/OËÆæÂ§áËøõË°å‰∫§‰∫í„ÄÇ</p>
<p>‰ª•Á£ÅÁõòËÆæÂ§á‰∏∫‰æãÔºåHypervisor„ÄÅÂÆø‰∏ªÊú∫ÂíåËôöÊãüÊú∫‰ºöÂÖ±‰∫´Á£ÅÁõò‰∏äÁöÑÂ≠òÂÇ®Á©∫Èó¥„ÄÇÂ¶ÇÊûúÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÈ©±Âä®Á®ãÂ∫èÊã•ÊúâÂØπÁ£ÅÁõòÁöÑÁõ¥Êé•Êìç‰ΩúÊùÉÈôêÔºåÂàôÂèØËÉΩ‰ºöËÆøÈóÆÂà∞‰∏çÂ±û‰∫éËØ•ËôöÊãüÊú∫ÁöÑÁ£ÅÁõòÊâáÂå∫ÔºåËøôÊ†∑ËΩªÂàôÂØºËá¥Êï∞ÊçÆÊ≥ÑÈú≤Âíå‰∏¢Â§±Ôºå‰∏•ÈáçÊó∂‰ºöÂ®ÅËÉÅÂÖ∂‰ªñËôöÊãüÊú∫ÁîöËá≥ÊòØÂÆø‰∏ªÊú∫ÁöÑËøêË°åÂÆâÂÖ®ÔºåÊó†Ê≥ïÊª°Ë∂≥ËôöÊãüÂåñÊ®°Âûã‰∏≠ÁöÑÈöîÁ¶ªÊÄßË¶ÅÊ±Ç„ÄÇ‰∏∫‰∫ÜÈÅøÂÖçËøô‰∏™ÈóÆÈ¢òÔºå<strong>HypervisorÂøÖÈ°ªËÉΩÂ§ü‰ª•ÊüêÁßçÂΩ¢ÂºèÊà™Ëé∑ÂÆ¢Êà∑Êú∫ÁöÑI/OËØ∑Ê±ÇÔºåÈò≤Ê≠¢ÂÆ¢Êà∑Êú∫ËÆøÈóÆÂà∞‰∏çÂ±û‰∫éÂÆÉÁöÑÂ§ñÈÉ®ËÆæÂ§áÔºåÂêåÊó∂‰ΩøÂÆ¢Êà∑Êú∫‰øùÊåÅËØ•Á±ªËÆæÂ§áÂèØ‰ª•Ë¢´ËÆøÈóÆÁöÑÈîôËßâ„ÄÇ</strong></p>
<h3 id="Êèê‰æõioËÆøÈóÆÊé•Âè£">Êèê‰æõI/OËÆøÈóÆÊé•Âè£
</h3><p>‰∏äÊñáÊèêÂà∞ÔºåËÆ°ÁÆóÊú∫‰ΩøÁî®‰∏Ä‰∏™Â§ñËÆæÈúÄË¶ÅÊìç‰ΩúÁ≥ªÁªüÁöÑÈ©±Âä®Á®ãÂ∫èÂíåÂ§ñËÆæÂÜÖÈÉ®Âõ∫‰ª∂ÁöÑÈÖçÂêà„ÄÇ‰ΩÜÊòØÊìç‰ΩúÁ≥ªÁªüÈÄöÂ∏∏Âπ∂‰∏çÂÖ≥ÂøÉÂ§ñËÆæÂÜÖÈÉ®ÁöÑÈÄªËæëÔºåÂè™ÈúÄË¶ÅËÆøÈóÆÂ§ñËÆæÊèê‰æõÁªôÊìç‰ΩúÁ≥ªÁªüÁöÑËÆæÂ§áÊé•Âè£„ÄÇÂõ†Ê≠§HypervisorÂèØ‰ª•ÈÄöËøáÊ®°ÊãüÁõÆÊ†áËÆæÂ§áÁöÑÂ§ñÈÉ®ËÆøÈóÆÊé•Âè£ÔºåÂπ∂Â∞ÜÊ®°ÊãüÁöÑËΩØ‰ª∂Êé•Âè£Êèê‰æõÁªôËôöÊãüÊú∫Ôºå‰ªéËÄå‰ΩøÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËÉΩÂ§üÈÄöËøáËá™Ë∫´È©±Âä®Á®ãÂ∫èÂèëËµ∑ÂØπÂ§ñËÆæÁöÑI/OÊìç‰Ωú„ÄÇÈÄöÂ∏∏ËôöÊãüÊú∫ÂèëËµ∑ÁöÑI/OÊìç‰ΩúË¢´Áß∞‰∏∫‚ÄúËôöÊãüI/O‚ÄùÔºå‰∏é‰πãÂØπÂ∫îÁöÑÊòØÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÂèëËµ∑ÁöÑËÉΩÂ§üÁõ¥Êé•ÊéßÂà∂Áâ©ÁêÜÂ§ñËÆæÁöÑ‚ÄúÁâ©ÁêÜI/O‚Äù„ÄÇ‰∏é‚ÄúÁâ©ÁêÜI/O‚Äù‰∏çÂêåÁöÑÊòØÔºå‚ÄúËôöÊãüI/O‚ÄùÊìç‰ΩúÁöÑÊòØHypervisorÊèê‰æõÁöÑËôöÊãüËÆæÂ§áÊé•Âè£„ÄÇ</p>
<h3 id="ÂÆûÁé∞ËÆæÂ§áÁöÑÂäüËÉΩ">ÂÆûÁé∞ËÆæÂ§áÁöÑÂäüËÉΩ
</h3><p>Âú®Â§ÑÁêÜËôöÊãüÊú∫ÂèëËµ∑ÁöÑI/OÊìç‰ΩúËøáÁ®ã‰∏≠ÔºåHypervisor‰∏ç‰ªÖÈúÄË¶ÅÊà™Ëé∑ËôöÊãüÊú∫ÂØπËÆæÂ§áÁöÑËÆøÈóÆÔºåËøòÈúÄË¶ÅÂÆûÁé∞ËôöÊãüÊú∫‚ÄúÊúüÊúõ‚ÄùÁöÑËÆæÂ§áÂäüËÉΩÔºåÂêëËôöÊãüÊú∫ËøîÂõûÊ≠£Á°ÆÁöÑÁªìÊûú„ÄÇ‰∏çÂêåËΩØ‰ª∂Êû∂ÊûÑÁöÑHypervisorÂÆûÁé∞ËôöÊãüËÆæÂ§áÂäüËÉΩÁöÑÊñπÂºè‰ºöÊúâÊâÄ‰∏çÂêåÔºå‰ΩÜ<strong>Âü∫Êú¨ÊÄùË∑ØÈÉΩÊòØËß£ÊûêËôöÊãüÊú∫ÁöÑI/OËØ∑Ê±ÇÔºåÂπ∂‰∫§Áî±ÂÆûÈôÖÁöÑÁâ©ÁêÜËÆæÂ§áÊâßË°åÔºåÊúÄÁªàÂêëÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËøîÂõûI/OÊìç‰ΩúÁªìÊûú„ÄÇ</strong></p>
<h2 id="13-ËΩØ‰ª∂ÂÆûÁé∞ÁöÑioËôöÊãüÂåñ">1.3 ËΩØ‰ª∂ÂÆûÁé∞ÁöÑI/OËôöÊãüÂåñ
</h2><p>ËôΩÁÑ∂Âú®‰∏çÂêåÁöÑËôöÊãüÂåñÊ®°Âºè‰∏ãÔºåI/OËôöÊãüÂåñÁöÑÂü∫Êú¨‰ªªÂä°Áõ∏ÂêåÔºå‰ΩÜÂ¶Ç‰ΩïÂÆûÁé∞‰∏äËø∞Âü∫Êú¨‰ªªÂä°Â≠òÂú®ÁùÄÂ§öÁßçÈÄâÊã©„ÄÇ‰æãÂ¶Ç<strong>HypervisorÂèØ‰ª•‰ΩøÁî®ËΩØ‰ª∂Ê®°ÊãüËôöÊãüËÆæÂ§áÁöÑÊé•Âè£Ôºå‰πüÂèØ‰ª•Âú®Á°¨‰ª∂Â±ÇÈù¢Â∞ÜÁâ©ÁêÜËÆæÂ§áÁ´ØÂè£Êö¥Èú≤ÁªôËôöÊãüÊú∫„ÄÇ<strong>Âõ†Ê≠§Ôºå‰∏éCPUËôöÊãüÂåñÂíåÂÜÖÂ≠òËôöÊãüÂåñÁ±ª‰ººÔºåI/OËôöÊãüÂåñÂÆûÁé∞ÊñπÂºè‰πüÂèØ‰ª•Ê†πÊçÆÊòØÂê¶ÈúÄË¶ÅÁ°¨‰ª∂ÊîØÊåÅÂàÜ‰∏∫</strong>Á∫ØËΩØ‰ª∂I/OËôöÊãüÂåñÂíåÁ°¨‰ª∂ËæÖÂä©I/OËôöÊãüÂåñ</strong>‰∏§Áßç„ÄÇÂêåÊó∂Á∫ØËΩØ‰ª∂ÂÆûÁé∞ÁöÑI/OËôöÊãüÂåñ‰πüÂèØ‰ª•Ê†πÊçÆÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËÉΩÂê¶Áõ¥Êé•‰ΩøÁî®ÂéüÁîüËÆæÂ§áÈ©±Âä®Ëøõ‰∏ÄÊ≠•ÂàÜ‰∏∫<strong>I/OÂÖ®ËôöÊãüÂåñÂíåI/OÂçäËôöÊãüÂåñ„ÄÇ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    I/OËôöÊãüÂåñÂàÜÁ±ª 		/* ÊòØÂê¶ÈúÄË¶ÅÁ°¨‰ª∂ÊîØÊåÅÔºü */</span>
</span></span><span class="line"><span class="cl">    <span class="o">+-&gt;</span> <span class="err">Á∫ØËΩØ‰ª∂</span><span class="n">I</span><span class="o">/</span><span class="n">OËôöÊãüÂåñ</span>  <span class="cm">/* guest osÊòØÂê¶Áõ¥Êé•‰ΩøÁî®ÂéüÁîüËÆæÂ§áÈ©±Âä®Ôºü */</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-&gt;</span> <span class="n">I</span><span class="o">/</span><span class="n">OÂÖ®ËôöÊãüÂåñ</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-&gt;</span> <span class="n">I</span><span class="o">/</span><span class="n">OÂçäËôöÊãüÂåñ</span>
</span></span><span class="line"><span class="cl">    <span class="o">+-&gt;</span> <span class="err">Á°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñ</span>
</span></span><span class="line"><span class="cl"><span class="err">*/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ËÆæÂ§áÊ®°Êãü-ÂÖ®ËôöÊãüÂåñ">ËÆæÂ§áÊ®°Êãü (ÂÖ®ËôöÊãüÂåñ)
</h3><blockquote>
<p><strong>ËÆæÂ§áÊ®°ÊãüÂ±û‰∫éÁ∫ØËΩØ‰ª∂ÂÆûÁé∞ÁöÑI/OÂÖ®ËôöÊãüÂåñÊñπÂºè„ÄÇËÆæÂ§áÊ®°ÊãüÁöÑÂ∫îÁî®ÂçÅÂàÜÂπøÊ≥õÔºåÁõÆÂâçÁªùÂ§ßÈÉ®ÂàÜHypervisorÔºå‰æãÂ¶ÇVMware Workstation„ÄÅKVM„ÄÅXen„ÄÅXvisorÈÉΩÊîØÊåÅËÆæÂ§áÊ®°Êãü„ÄÇ</strong></p>
</blockquote>
<p>Âú®ÂÖ®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºå‰∏∫‰∫ÜÊª°Ë∂≥ËôöÊãüÊú∫‰πãÈó¥ÁöÑÈöîÁ¶ªÊÄßÂíåÂÆâÂÖ®ÊÄßÁ≠âË¶ÅÊ±ÇÔºåËôöÊãüÊú∫Âπ∂‰∏çËÉΩÁõ¥Êé•ËÆøÈóÆÁúüÂÆûÁöÑÁâ©ÁêÜÂ§ñËÆæÔºåËôöÊãüÊú∫ÂÜÖÈÉ®È©±Âä®Á®ãÂ∫èÊìç‰ΩúÁöÑËÆæÂ§áÊòØÁî±HypervisorÊèê‰æõÁöÑ‰∏Ä‰∏™ËôöÊãüÁöÑËÆæÂ§áÊäΩË±°ÔºåÊï¥‰ΩìÊµÅÁ®ãÊòØËøôÊ†∑Ôºö</p>
<ul>
<li>ËôöÊãüÊú∫ÂêØÂä®ËøáÁ®ã‰∏≠ÔºåËøô‰∫õÁî±HypervisorÊèê‰æõÁöÑËôöÊãüËÆæÂ§á‰ºöË¢´ËôöÊãüBIOSÂíåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÊ£ÄÊµãÂà∞ÔºåÁÑ∂ÂêéÊåÇËΩΩÂà∞ËôöÊãüÁöÑËÆæÂ§áÊÄªÁ∫øÔºõ</li>
<li>ÂΩìÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÂØπÂ∫îÁöÑÈ©±Âä®Á®ãÂ∫èÂêëËôöÊãüËÆæÂ§áÂèëËµ∑I/OËØ∑Ê±ÇÊó∂ÔºåÁî±‰∫éI/OÊåá‰ª§ÊòØÊïèÊÑüÊåá‰ª§Ôºå‰ºöÂºïÂèëVM-ExitÈô∑ÂÖ•Hypervisor„ÄÇ‰πãÂêé‰∏éËøô‰∫õI/OËØ∑Ê±ÇÁõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØ‰ºöË¢´HypervisorÊà™Ëé∑ÔºåÂèëÈÄÅÂà∞Áõ∏ÂÖ≥ÁöÑËΩØ‰ª∂Ê®°ÂùóËøõË°åÂ§ÑÁêÜÔºõ</li>
<li>ÊúÄÂêéËΩØ‰ª∂Ê®°Âùó‰ºöÊ®°ÊãüËøô‰∫õI/OËØ∑Ê±ÇÂπ∂Â∞ÜI/OÁªìÊûúËøîÂõûÁªôËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑËÆæÂ§áÈ©±Âä®Á®ãÂ∫è„ÄÇ</li>
</ul>
<p>Âú®‰ª•‰∏äËøáÁ®ã‰∏≠ÔºåI/OËØ∑Ê±ÇÁöÑÊà™Ëé∑ÂíåÂ§ÑÁêÜÂØπ‰∫éÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÊù•ËØ¥ÊòØÈÄèÊòéÁöÑÔºåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂßãÁªàËÆ§‰∏∫Ëá™Â∑±ËøêË°åÂú®‰∏Ä‰∏™ÁúüÂÆûÁöÑÁâ©ÁêÜÁ°¨‰ª∂Âπ≥Âè∞ÔºåËÄå<strong>ÂÆûÁé∞ËÆæÂ§áÊ®°Êãü‰ª•ÂèäÂ§ÑÁêÜI/OËØ∑Ê±ÇÂíåËøîÂõûI/OÊìç‰ΩúÁªìÊûúÁöÑËΩØ‰ª∂Ê®°ÂùóÂàôÁß∞‰∏∫ËÆæÂ§áÊ®°Âûã (device model)„ÄÇ</strong></p>
<p>ËÆæÂ§áÊ®°Âûã‰∏ªË¶ÅÁî±‰∏§ÈÉ®ÂàÜÁªÑÊàêÔºö</p>
<ol>
<li>‰∏ÄÈÉ®ÂàÜÊòØ**‰ª•ËΩØ‰ª∂ÂÆûÁé∞ÁöÑÂΩ¢ÂºèÂêëÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÊèê‰æõÁöÑÁõÆÊ†áËÆæÂ§áÊé•Âè£Ôºå**ËØ•Êé•Âè£‰∏ªË¶ÅÁî®ÂÆ¢Êà∑Êú∫Êìç‰ΩúËôöÊãüËÆæÂ§áÔºõ</li>
<li>Âè¶‰∏ÄÈÉ®ÂàÜÊòØ**ËÆæÂ§áÂÖ∑‰ΩìÂäüËÉΩÁöÑËΩØ‰ª∂ÂÆûÁé∞Ôºå**ËØ•ÈÉ®ÂàÜ‰ºöÂØπÊà™Ëé∑ÁöÑI/OËØ∑Ê±ÇËøõË°åËß£ÊûêÔºå‰πãÂêéÊ†πÊçÆËÆæÂ§áÊ®°ÂûãÊâÄÂ§ÑÁöÑËøêË°åÁéØÂ¢ÉÊâßË°åÁõ∏Â∫îÁöÑI/OÂ§ÑÁêÜËøáÁ®ãÔºåÊúÄÁªàÁªôÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËøîÂõûI/OÊìç‰ΩúÁªìÊûú„ÄÇ</li>
</ol>
<p>Áî±‰∫éËÆæÂ§áÊ®°ÂûãÊòØÈÄöËøáÁ∫ØËΩØ‰ª∂ÂÆûÁé∞ÁöÑÔºåÊ®°ÊãüÁöÑËôöÊãüËÆæÂ§á‰∏éÂÆø‰∏ªÊú∫ÁöÑÁ°¨‰ª∂Âπ∂‰∏çÂ≠òÂú®Áõ¥Êé•ÂÖ≥ËÅîÔºåÂõ†Ê≠§ËÆæÂ§áÊ®°ÂûãÁîöËá≥ÂèØ‰ª•Ê®°ÊãüÂÆûÈôÖ‰∏çÂ≠òÂú®ÁöÑËÆæÂ§á„ÄÇËÆæÂ§áÊ®°ÂûãÂèØ‰ª•ËøêË°åÂú®ÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÁöÑÁî®Êà∑ÊÄÅÔºå‰πüÂèØ‰ª•ËøêË°åÂú®HypervisorÔºåÁîöËá≥ÂèØ‰ª•ËøêË°åÂú®ÂÖ∂‰ªñÁâπÊùÉËôöÊãüÊú∫„ÄÇ‰∏ãÂõæÂ±ïÁ§∫‰∫ÜËÆæÂ§áÊ®°ÂûãËøêË°åÂú®ÂÆø‰∏ªÊú∫Áî®Êà∑ÊÄÅÂíåHypervisorËøô‰∏§ÁßçÊÉÖÂÜµ„ÄÇ</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171042348.png"
	
	
	
	loading="lazy"
	
		alt="image-20231117104259203"
	
	
></p>
<p>QEMU/KVMÊòØÊääËÆæÂ§áÊ®°ÂûãËøêË°åÂú®Áî®Êà∑ÊÄÅ‰∏äËøô‰∏ÄÁ±ªHypervisorÁöÑÂÖ∏Âûã‰ª£Ë°®„ÄÇÂú®QEMU/KVM‰∏≠ÔºåËÆæÂ§áÊ®°Âûã‰Ωú‰∏∫Áî®Êà∑ËøõÁ®ãËøêË°åÂú®ÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÁöÑÁî®Êà∑Á©∫Èó¥„ÄÇÂú®ÂÆø‰∏ªÊú∫‰∏≠ÔºåËÆæÂ§áÊ®°ÂûãÂèØ‰ª•ÈÄöËøá‰ΩøÁî®LinuxÊèê‰æõÁöÑÁ≥ªÁªüË∞ÉÁî®‰ª•ÂèäÂêÑÁßçÂ∫ìÂáΩÊï∞ÂÆåÊàêÂØπËôöÊãüÊú∫ÂÜÖI/OËÆøÈóÆÁöÑÊ®°Êãü„ÄÇÂõæ(a)Â±ïÁ§∫‰∫ÜÁî®Êà∑ÊÄÅËÆæÂ§áÊ®°ÂûãÁöÑI/OÊ®°ÊãüÊµÅÁ®ãÔºåÂú®ËøôÁßçÊ®°Âºè‰∏ãÔºå‰∏ÄÊ¨°I/OÊ®°ÊãüËøáÁ®ã‰ºöÂèëÁîüÂ§öÊ¨°‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÂåÖÊã¨Ôºö</p>
<blockquote>
<p><strong>È¶ñÂÖàÔºåÂÆ¢Êà∑Êú∫I/OÊìç‰Ωú‰ºöËß¶ÂèëVM-ExitÔºåÂèëÁîüÁî±ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂà∞HypervisorÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢ÔºõÁÑ∂ÂêéHypervisorÂ∞ÜI/OÊìç‰ΩúÈÄöËøáI/OÂÖ±‰∫´È°µ‰º†ÈÄíÁªôËÆæÂ§áÊ®°ÂûãÔºåÊ≠§Êó∂‰ºöÂàáÊç¢Âà∞Áî®Êà∑Á©∫Èó¥ÁöÑËÆæÂ§áÊ®°ÊãüËøõÁ®ãÔºõÊúÄÂêéËÆæÂ§áÊ®°ÂûãÂèëËµ∑Á≥ªÁªüË∞ÉÁî®ÔºåÂàáÊç¢Âà∞ÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÊ†∏ÊÄÅ„ÄÇ</strong></p>
</blockquote>
<p>‰∏é Xvisor Á±ª‰ººÁöÑËôöÊãüÂåñÊñπÊ°àÂàôÂ∞ÜËÆæÂ§áÊ®°ÂûãÊï¥ÂêàÂú®Hypervisor‰∏≠„ÄÇËÆæÂ§áÊ®°Âûã‰Ωú‰∏∫HypervisorÁöÑ‰∏ÄÈÉ®ÂàÜÔºå‰∏éÁúüÂÆûÁöÑËÆæÂ§áÈ©±Âä®ÂÖ±ÂêåËøêË°åÂú®ÂÜÖÊ†∏ÊÄÅ„ÄÇÂõæ(b)Â±ïÁ§∫‰∫ÜËØ•Ê®°Âºè‰∏ãÁöÑI/OÊ®°ÊãüÊµÅÁ®ãÔºåËÆæÂ§áÊ®°Âûã‰ºöËß£ÊûêHypervisorÊã¶Êà™ÁöÑÂÆ¢Êà∑Êú∫ËÆæÂ§áÈ©±Âä®ÂèëÂá∫ÁöÑI/OËØ∑Ê±ÇÔºåÂπ∂Â∞ÜËß£ÊûêÂêé‰∫ßÁîüÁöÑÁâ©ÁêÜI/OËØ∑Ê±ÇÂèëÈÄÅÁªôÁõ∏Â∫îÁöÑÁúüÂÆûÁâ©ÁêÜÈ©±Âä®ÊâßË°åÔºåÊúÄÂêéËÆæÂ§áÊ®°Âûã‰ºöÂ∞ÜÁâ©ÁêÜÈ©±Âä®Ëé∑ÂæóÁöÑI/OÁªìÊûúÂèëÈÄÅÁªôÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü„ÄÇÁõ∏ÊØî‰∫éËøêË°åÂú®Áî®Êà∑ÊÄÅÔºåËøôÁßçÂÆûÁé∞ÊñπÂºèÈÅøÂÖç‰∫ÜÁ≥ªÁªüË∞ÉÁî®ÊâÄ‰∫ßÁîüÁöÑÂ§ßÈáè‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÁº©Áü≠‰∫ÜËôöÊãüÊú∫I/OÁöÑÊ®°ÊãüË∑ØÂæÑÔºåÊèêÈ´ò‰∫ÜI/OÁöÑÊÄßËÉΩ„ÄÇ‰ΩÜÁî±‰∫éÂ§ßÈáèÁâ©ÁêÜÈ©±Âä®ÂÆûÁé∞Âú®Hypervisor‰∏≠ÔºåÂ¢ûÂä†‰∫ÜHypervisorËÆæËÆ°ÁöÑÂ§çÊùÇÊÄßÔºåÂπ∂ÈôêÂà∂‰∫ÜÊñπÊ°àÁöÑÂèØÁßªÊ§çÊÄßÂíåÈÄöÁî®ÊÄß„ÄÇ</p>
<h3 id="ÂçäËôöÊãüÂåñ">ÂçäËôöÊãüÂåñ
</h3><blockquote>
<p><strong>‰∏∫‰∫ÜËß£ÂÜ≥ËÆæÂ§áÊ®°Êãü‰∏≠Áî±‰∫éÈ¢ëÁπÅÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢ÂØºËá¥ÁöÑI/OÊÄßËÉΩÂ§ßÂπÖ‰∏ãÈôçÈóÆÈ¢òÔºåI/OÂçäËôöÊãüÂåñÊäÄÊúØÂ∫îËøêËÄåÁîüÔºåÂÖ∂‰∏≠ÁöÑÂÖ∏Âûã‰ª£Ë°®ÊòØXenÂíåvirtio„ÄÇ‰∏ãÂõæÂ±ïÁ§∫‰∫ÜXenÂâçÂêéÁ´ØËÆæÂ§áÈ©±Âä®Ê®°Âûã„ÄÇ</strong></p>
</blockquote>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171546237.png" alt="image-20231117104712640" style="zoom:50%;" />
<p>Âú®I/OÂçäËôöÊãüÂåñÊñπÂºè‰∏ãÔºåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑÂéüÁîüÈ©±Âä®‰ºöË¢´ÁßªÈô§ÔºåÂèñËÄå‰ª£‰πãÁöÑÊòØÁÆÄÂåñÂêéÁöÑÂâçÁ´ØËÆæÂ§áÈ©±Âä®„ÄÇHypervisor‰ºöÂ∞ÜÂéüÁîüÁâ©ÁêÜÈ©±Âä®‰øùÁïôÂú®ÊåáÂÆöÁöÑÁâπÊùÉËôöÊãüÊú∫(Domain 0)‰∏≠ÔºåËØ•ÁâπÊùÉËôöÊãüÊú∫ÈÄöÂ∏∏Ë¥üË¥£ÁÆ°ÁêÜÂÖ∂‰ªñÈùûÁâπÊùÉËôöÊãüÊú∫(Domain U)ÁöÑÁîüÂëΩÂë®ÊúüÔºå‰æãÂ¶ÇÂêØÂä®„ÄÅÈîÄÊØÅËôöÊãüÊú∫„ÄÇÁâπÊùÉËôöÊãüÊú∫‰∏≠ÂÆâË£ÖÊúâÂêéÁ´ØËÆæÂ§áÈ©±Âä®ÔºåÂêéÁ´ØËÆæÂ§áÈ©±Âä®ÁöÑÂäüËÉΩÊòØÊé•Êî∂Âπ∂Ëß£ÊûêÊù•Ëá™ÈùûÁâπÊùÉËôöÊãüÊú∫‰∏≠ÂâçÁ´ØËÆæÂ§áÈ©±Âä®ÁöÑI/OËØ∑Ê±ÇÔºåÂπ∂Â∞ÜI/OËØ∑Ê±ÇËΩ¨ÂèëÂà∞ÂØπÂ∫îËÆæÂ§áÁöÑÂéüÁîüÁâ©ÁêÜËÆæÂ§áÈ©±Âä®ÊâßË°åÔºåÊúÄÂêéÂ∞ÜI/OÊìç‰ΩúÁªìÊûúËøîÂõûÁªôÈùûÁâπÊùÉËôöÊãüÊú∫‰∏≠ÁöÑÂâçÁ´ØËÆæÂ§áÈ©±Âä®„ÄÇ</p>
<p>Âú®ÂçäËôöÊãüÂåñÊ®°Âºè‰∏≠ÔºåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂØπËá™Ë∫´ÊâÄÂ§ÑÁöÑËôöÊãüÂåñÁéØÂ¢ÉÂÖ∑ÊúâÊ∏ÖÊô∞ÁöÑËÆ§ËØÜÔºåËøôÊ†∑ÂÅöÁöÑÂ•ΩÂ§ÑÊòØÔºö</p>
<ul>
<li><strong><font color='red'>ÂÆ¢Êà∑Êú∫ËÉΩÂ§ü‰ª•Ë∞ÉÁî®ÊúçÂä°ÁöÑÂΩ¢Âºè‰∏ªÂä®ÂêëHypervisorÂèëËµ∑ÊâπÈáèÁöÑÂºÇÊ≠•I/OËØ∑Ê±Ç„ÄÇÁõ∏ÊØî‰∫éËÆæÂ§áÊ®°Êãü‰∏≠ÊØèÊ¨°I/OËØ∑Ê±ÇÈÉΩÈúÄË¶ÅË¢´HypervisorÊà™Ëé∑ÔºåI/OÂçäËôöÊãüÂåñÊñπÂºèÊûÅÂ§ßÂú∞ÂáèÂ∞ë‰∫Ü‰∏ä‰∏ãÊñáÂàáÊç¢ÁöÑÂºÄÈîÄ„ÄÇ</font></strong></li>
<li><strong>ËÄå‰∏îÂâçÁ´ØÈ©±Âä®Âè™ÈúÄÂú®ÈÅµÂÆàÊ†áÂáÜÁöÑÂâçÂêéÁ´ØÊé•Âè£ÂçèËÆÆÁöÑÂü∫Á°Ä‰∏äÂ∞ÜI/OËØ∑Ê±ÇËΩ¨ÂèëÔºåÊó†È°ªÂÆûÁé∞ÂéüÁîüËÆæÂ§áÈ©±Âä®‰∏≠Â§çÊùÇÁöÑÈÄªËæëÔºåÂ§ßÂπÖÁÆÄÂåñ‰∫ÜÂâçÁ´ØÈ©±Âä®ÁöÑÂÆûÁé∞Â§çÊùÇÂ∫¶„ÄÇ</strong></li>
</ul>
<p>ÂΩìÁÑ∂ÔºåI/OÂçäËôöÊãüÂåñÊñπÂºèÂπ∂‰∏çÊòØÂÆåÁæéÁöÑ„ÄÇÁî±‰∫éÈúÄË¶Å‰øÆÊîπÊìç‰ΩúÁ≥ªÁªüÊ∫êÁ†ÅÔºåÂØºËá¥I/OÂçäËôöÊãüÂåñÊñπÊ≥ïÈöæ‰ª•Âú®Èó≠Ê∫êÁöÑÊìç‰ΩúÁ≥ªÁªü‰∏äÂ∫îÁî®„ÄÇ</p>
<h2 id="14-Á°¨‰ª∂ËæÖÂä©ÁöÑioËôöÊãüÂåñ">1.4 Á°¨‰ª∂ËæÖÂä©ÁöÑI/OËôöÊãüÂåñ
</h2><p>‰∏äËäÇ‰ªãÁªç‰∫ÜI/OËôöÊãüÂåñ‰∏ªË¶ÅÁöÑ‰∏§ÁßçËΩØ‰ª∂ÂÆûÁé∞ÊñπÂºè‚Äî‚ÄîËÆæÂ§áÊ®°ÊãüÂíåÂçäËôöÊãüÂåñ„ÄÇËÆæÂ§áÊ®°Âûã‰∏∫ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÊèê‰æõËôöÊãüÁöÑËÆæÂ§áËÆøÈóÆÊé•Âè£Ôºå‰ΩÜÂÖ∑‰ΩìÁöÑËΩØ‰ª∂ÂÆûÁé∞ÂØπÊìç‰ΩúÁ≥ªÁªüÈÄèÊòéÔºåÊâÄ‰ª•‰ΩøÁî®ËÆæÂ§áÊ®°ÊãüÁöÑÊñπÂºèÂèØ‰ª•ËøêË°åÊú™Áªè‰øÆÊîπÁöÑÂéüÁîüÊìç‰ΩúÁ≥ªÁªüÔºåÂÖ∑ÊúâËæÉÂº∫ÁöÑÈÄöÁî®ÊÄß„ÄÇ‰ΩÜÊòØÂ≠òÂú®Â¶Ç‰∏ãÈóÆÈ¢òÔºö</p>
<ul>
<li>Áî±‰∫éI/OÊìç‰ΩúÊ∂âÂèäÂ§ßÈáèÁöÑËÆæÂ§áÂØÑÂ≠òÂô®ËÆøÈóÆÔºåÂú®ÂÖ®ËôöÊãüÂåñÁéØÂ¢É‰∏ã‰ºöÂØºËá¥ÈùûÂ∏∏Â§öÁöÑ VM-ExitÔºå‰ªéËÄåÈúÄË¶ÅËøõË°åÈ¢ëÁπÅÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢Ôºõ</li>
<li>ÂÖ®ËôöÊãüÂåñÈúÄË¶ÅÁªèËøáÂÆ¢Êà∑Êú∫ÂíåÂÆø‰∏ªÊú∫ÁöÑ‰∏§Â±ÇI/OÊ†àÔºåÂØºËá¥I/OÁöÑË∑ØÂæÑÂèòÈïøËÄå‰∏îÊï∞ÊçÆÈúÄË¶ÅÂú®ÂÜÖÂ≠ò‰∏≠Â§çÂà∂Â§öÊ¨°Ôºõ</li>
<li>ÂçäËôöÊãüÂåñI/OÊñπÊ°à‰ΩøÁî®ÂâçÂêéÁ´ØÈ©±Âä®ÁöÑÊñπÂºèÔºåËÉΩÂ§üÊâπÈáèÂ§ÑÁêÜËôöÊãüÊú∫‰∏≠ÁöÑI/OËØ∑Ê±ÇÔºå‰ΩøÂæóËôöÊãüÊú∫ËÉΩÂ§üËé∑Âæó‰∏éÂéüÁîüÁ≥ªÁªüÁõ∏ËøëÁöÑI/OÊÄßËÉΩ„ÄÇ‰ΩÜÊòØ‰ΩøÁî®ÂçäËôöÊãüÂåñI/OÊñπÂºèÈúÄË¶ÅÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÁöÑÈÖçÂêàÔºåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂøÖÈ°ªÊ∏ÖÊ•öËá™Â∑±ËøêË°åÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏≠ÔºåÂπ∂‰∏îÈúÄË¶ÅÂÆâË£ÖÁâπÂÆöÁöÑÈ©±Âä®Á®ãÂ∫èÂêåÊó∂‰øÆÊîπÊìç‰ΩúÁ≥ªÁªüÁöÑÊ∫êÁ†ÅÔºåËøôÊ†∑Â∞±ÈôêÂà∂‰∫ÜI/OÂçäËôöÊãüÂåñÊñπÊ°àÁöÑÈÄöÁî®ÊÄß„ÄÇ</li>
</ul>
<p>‰∏∫‰∫ÜËß£ÂÜ≥I/OËôöÊãüÂåñËΩØ‰ª∂ÂÆûÁé∞ÊñπÊ°àÂ≠òÂú®ÁöÑÂºäÁ´ØÔºåIntel„ÄÅAMD„ÄÅARMÁ≠âÂ§ÑÁêÜÂô®ÂéÇÂïÜÊé®Âá∫‰∫ÜÂêÑËá™ÁöÑÁ°¨‰ª∂ËæÖÂä©I/OËôöÊãüÂåñÊäÄÊúØ„ÄÇ‰∏ãÂõæÂ±ïÁ§∫‰∫Ü<strong>ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆÊ®°Âûã‰∏éSR-IOV</strong>Ëøô‰∏§ÁßçÊúÄÂÖ∑‰ª£Ë°®ÊÄßÁöÑÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à„ÄÇ</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171057433.png"
	
	
	
	loading="lazy"
	
		alt="image-20231117105707381"
	
	
></p>
<h3 id="ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ">ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ
</h3><p>ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆÁöÑÂÆûÁé∞‰∏ªË¶Å‰æùËµñ‰∫éËÆæÂ§áÂíåÂÜÖÂ≠ò‰πãÈó¥ÁöÑIOMMUÔºàInput-Output Memory Management UnitÔºåËæìÂÖ•ËæìÂá∫ÂÜÖÂ≠òÁÆ°ÁêÜÂçïÂÖÉÔºâ„ÄÇIOMMU‰∏éMMUÁ±ª‰ººÔºå‰Ωç‰∫é‰∏ªÂ≠òÂíåËÆæÂ§á‰πãÈó¥Ôºå‰∏∫ÊØè‰∏™ËÆæÂ§áÂàõÂª∫‰∏Ä‰∏™IOVAÔºàI/O Virtual AddressÔºåËôöÊãüI/OÂú∞ÂùÄÁ©∫Èó¥ÔºâÔºåÂπ∂Êèê‰æõ‰∏ÄÁßçÂ∞ÜIOVAÂä®ÊÄÅÊò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄÁöÑÊú∫Âà∂„ÄÇÂΩìËôöÊãüÊú∫ÂèëËµ∑DMAÊó∂ÔºåËÆæÂ§áÈ©±Âä®‰ºö‰ΩøÁî®IOVA‰Ωú‰∏∫DMAÂú∞ÂùÄÔºå‰πãÂêéËÆæÂ§á‰ºöËØïÂõæËÆøÈóÆIOVAÔºåËøôÊó∂IOMMU‰ºöÂ∞ÜIOVAÈáçÊñ∞Êò†Â∞ÑÂà∞ÂêàÊ≥ïÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ</p>
<blockquote>
<p><strong>Âú®ËôöÊãüÂåñÁéØÂ¢É‰∏≠ÔºåIOMMUÁöÑÂºïÂÖ•ËÉΩÂ§üÂú®Á°¨‰ª∂Â±ÇÈù¢ÈôêÂà∂ËÆæÂ§áÂØπÂÜÖÂ≠òËÆøÈóÆÁöÑËåÉÂõ¥ÔºåÂÆûÁé∞‰∏çÂêåËôöÊãüÊú∫‰πãÈó¥I/OËµÑÊ∫êÁöÑÈöîÁ¶ª„ÄÇIOMMU‰Ωú‰∏∫‰∏ÄÁßçÈÄöÁî®ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºåÂá†‰πéÊâÄÊúâÁü•ÂêçÂ§ÑÁêÜÂô®ÂéÇÂïÜÈÉΩÊé®Âá∫‰∫ÜÊîØÊåÅIOMMUÁöÑCPU„ÄÇÊú¨ËäÇÈÄâÊã©‰ªãÁªçIntelÊèêÂá∫ÁöÑVT-dÊäÄÊúØ„ÄÇ</strong></p>
</blockquote>
<p>VT-dÊäÄÊúØÊòØIntel‰∏∫‰∫ÜÊèêÂçáI/OËôöÊãüÂåñÊÄßËÉΩÊèêÂá∫ÁöÑÁ°¨‰ª∂ÊñπÊ°àÔºå‰∏éVT-xÊäÄÊúØÂêåÂ±û‰∫éIntelÁ°¨‰ª∂ËôöÊãüÂåñÊäÄÊúØ„ÄÇÂ¶Ç‰∏äÂõæÊâÄÁ§∫ÔºåVT-dÊñπÊ°àÁõ¥Êé•Â∞ÜÁâ©ÁêÜËÆæÂ§áÂàÜÈÖçÁªôÁâπÂÆöÁöÑËôöÊãüÊú∫Ôºå‰ΩøÂæóÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑÂéüÁîüÈ©±Âä®Á®ãÂ∫èÂèØ‰ª•ÈÄöËøáÂ§ñËÆæÊé•Âè£Áõ¥ÈÄöËÆøÈóÆÂπ∂Êìç‰ΩúÁâ©ÁêÜÂ§ñËÆæÔºåËØ•ËøáÁ®ãÊó†È°ª‰∏ãÈô∑Âà∞Hypervisor‰∏≠Â§ÑÁêÜ„ÄÇÂêåÊó∂Áî±‰∫éI/OË∑ØÂæÑÈïøÂ∫¶Âá†‰πéÁ≠âÂêå‰∫éÈùûËôöÊãüÂåñÁéØÂ¢É‰∏ãÁöÑI/OË∑ØÂæÑÈïøÂ∫¶ÔºåÂõ†Ê≠§ËôöÊãüÊú∫ËÉΩÂ§üËé∑Âæó‰∏éË£∏Êú∫‰∏ÄËá¥ÁöÑI/OÊÄßËÉΩ„ÄÇ</p>
<p>Âú®ÂºïÂÖ•VT-dÊäÄÊúØÁöÑCPU‰∏äÔºåHypervisorÊó†È°ªÊ®°ÊãüÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂèëËµ∑ÁöÑI/OÊìç‰ΩúÔºåËøôÊûÅÂ§ßÂú∞Èôç‰Ωé‰∫ÜHypervisorËÆæËÆ°ÁöÑÂ§çÊùÇÂ∫¶„ÄÇ‰æãÂ¶ÇÂÆåÂÖ®ÈááÁî®ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆÁöÑÊñπÂºè‰∏∫ËôöÊãüÊú∫ÂàÜÈÖçÁâ©ÁêÜÂ§ñËÆæËµÑÊ∫êÁöÑJailhouseÔºàË•øÈó®Â≠êÂºÄÂèëÁöÑHypervisorÔºâÔºåÂÖ∂‰ª£Á†ÅË°åÊï∞Âè™Êúâ‰∏çÂà∞4‰∏áË°åÔºåËÄåÂêå‰∏∫Type IÂûãHypervisorÁöÑXenÔºåÁî±‰∫éÂêåÊó∂ËøòÊîØÊåÅËÆæÂ§áÊ®°ÂûãÔºåÂÖ∂‰ª£Á†ÅË°åÊï∞ËøúË∂ÖJailhouseÔºåÁ∫¶‰∏∫30‰∏áË°å„ÄÇ</p>
<h3 id="sr-iov">SR-IOV
</h3><p>ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆËôΩÁÑ∂ËÉΩÂ§üÂ∞Ü‰∏Ä‰∏™Áâ©ÁêÜËÆæÂ§áÂàÜÈÖçÁªôËôöÊãüÊú∫Áã¨Âç†‰ΩøÁî®Ôºå‰ΩÜËøôÁßçËÆæÂ§áÁã¨Âç†ÁöÑÊñπÂºèÈôç‰Ωé‰∫ÜËÆæÂ§áÁöÑÂà©Áî®ÁéáÔºå‰ºöÂ§ßÂπÖÂ¢ûÂä†ËÆæÂ§áÁöÑÁ°¨‰ª∂ÊàêÊú¨ÔºåÂú®ÊüêÁßçÁ®ãÂ∫¶‰∏ä ‚ÄúËøùËÉå‚Äù ‰∫ÜËôöÊãüÂåñÁöÑÂàùË°∑ÔºåÂπ∂‰∏î‰∏çÂÖ∑Â§áÂèØÊâ©Â±ïÊÄß„ÄÇ‰æãÂ¶ÇÔºåÁõÆÂâçÂ∏ÇÈù¢‰∏äÁöÑÁΩëÂç°ËÆæÂ§á‰∏ÄËà¨ÈÉΩÊã•ÊúâËæÉÈ´òÁöÑÂ∏¶ÂÆΩÔºåÂêåÊó∂Ê≠£Â∏∏ÊÉÖÂÜµ‰∏ãÁ≥ªÁªüÂπ∂‰∏ç‰ºö‰∏ÄÁõ¥‰ΩøÁî®ÁΩëÁªúÂäüËÉΩ„ÄÇÂ¶ÇÊûú‰ΩøÁî®ËÆæÂ§áÁõ¥ÈÄöÊñπÂºèÔºåÂæàÂÆπÊòìÈÄ†ÊàêÁΩëÂç°Â∏¶ÂÆΩËµÑÊ∫êÁöÑÊµ™Ë¥π„ÄÇ</p>
<p>‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢òÔºåËÆæÂ§áÂéÇÂïÜ**Âú®Á°¨‰ª∂Â±ÇÈù¢Â∞Ü‰∏Ä‰∏™Áâ©ÁêÜËÆæÂ§áËôöÊãüÊàêÂ§ö‰∏™ËÆæÂ§áÔºåÁÑ∂ÂêéÂ∞ÜËôöÊãüÂá∫Êù•ÁöÑËÆæÂ§áÂàÜÈÖçÁªôËôöÊãüÊú∫Ôºå‰ΩøÂæóÁâ©ÁêÜËÆæÂ§áÂèØ‰ª•ÂêåÊó∂Ë¢´Â§ö‰∏™ËôöÊãüÊú∫ÂÖ±‰∫´„ÄÇ<strong>Âá∫‰∫éÂÖºÂÆπÊÄßËÄÉËôëÔºåPCI-SIGÂà∂ÂÆö‰∫ÜSR-IOVËßÑËåÉ„ÄÇSR-IOVËßÑËåÉ</strong>ÂÖÅËÆ∏ËôöÊãüÊú∫ËÉΩÂ§üÂú®Ê≤°ÊúâËΩØ‰ª∂ÂèÇ‰∏éÁöÑÊÉÖÂÜµ‰∏ãÂÖ±‰∫´ËÆæÂ§áI/OÁ´ØÂè£ÁöÑÁâ©ÁêÜÂäüËÉΩÔºå**ÂêåÊó∂ÂèØ‰ª•Ëé∑ÂæóÂ™≤ÁæéÈùûËôöÊãüÂåñÁéØÂ¢ÉI/OÊÄßËÉΩ„ÄÇ</p>
<h1 id="2-ioËôöÊãüÂåñÁöÑÂÆûÁé∞ÊñπÂºè">2 I/OËôöÊãüÂåñÁöÑÂÆûÁé∞ÊñπÂºè
</h1><p>‰∏éCPUÂíåÂÜÖÂ≠òÁõ∏ÊØîÔºåÂ§ñËÆæÁöÑÁßçÁ±ªÁπÅÂ§öÔºå‰∏çÂêåËÆæÂ§áÈÅµÂæ™ÁöÑÊÄªÁ∫øÂçèËÆÆ‰πüÊúâÊâÄ‰∏çÂêå„ÄÇÂ∏∏ËßÅÁöÑËÆæÂ§áÊúâPCIËÆæÂ§á„ÄÅISAËÆæÂ§á„ÄÅUSBËÆæÂ§áÁ≠â„ÄÇÁõÆÂâçPCIËÆæÂ§áÊòØÂ∫îÁî®ÊúÄÂπøÊ≥õÁöÑËÆæÂ§áÔºåÂá†‰πéÊâÄÊúâ‰∏ªÊùøÈÉΩÊîØÊåÅPCIËÆæÂ§áÔºåÊâÄ‰ª•Êú¨Á´†Â∞ÜÂü∫‰∫éx86Êû∂ÊûÑÔºå‰ª•PCIËÆæÂ§á‰∏∫‰æã‰ªãÁªçËÆæÂ§áÊ®°Êãü„ÄÅÂçäËôöÊãüÂåñ„ÄÅËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ„ÄÅSR-IOVËøôÂõõÁßçI/OËôöÊãüÂåñÊñπÂºèÁöÑÂÖ∑‰ΩìÂÆûÁé∞„ÄÇ</p>
<h2 id="21-pciËÆæÂ§áÁÆÄ‰ªã">2.1 PCIËÆæÂ§áÁÆÄ‰ªã
</h2><p>PCIÊÄªÁ∫øÂèØ‰ª•Ë¢´Áúã‰ΩúÁ≥ªÁªüÊÄªÁ∫øÁöÑÂª∂Â±ïÔºåÂêåÊó∂‰Ωú‰∏∫CPUÁöÑÂ±ÄÈÉ®ÊÄªÁ∫øËøûÊé•Â§ñÈÉ®ËÆæÂ§á„ÄÇPCIÊÄªÁ∫øÊòØ‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑÊ†ëÁªìÊûÑÔºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171217715.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰ªéÂõæ‰∏≠ÁúãÔºå‰∏éPCIÊÄªÁ∫øÁõ∏ÂÖ≥ÁöÑÊ®°ÂùóÂåÖÊã¨Ôºö</p>
<ol>
<li>
<p><em><strong><code>Host Bridge</code></strong></em></p>
<p>ÊØîÂ¶ÇPC‰∏≠Â∏∏ËßÅÁöÑ<code>North BridgeÔºàÂåóÊ°•Ôºâ</code>„ÄÇÂõæ‰∏≠Â§ÑÁêÜÂô®„ÄÅCache„ÄÅÂÜÖÂ≠òÂ≠êÁ≥ªÁªüÈÄöËøáHost BridgeËøûÊé•Âà∞PCI‰∏äÔºåHost BridgeÁÆ°ÁêÜPCIÊÄªÁ∫øÂüüÔºåÊòØËÅîÁ≥ªÂ§ÑÁêÜÂô®ÂíåPCIËÆæÂ§áÁöÑÊ°•Ê¢ÅÔºåÂÆåÊàêÂ§ÑÁêÜÂô®‰∏éPCIËÆæÂ§áÈó¥ÁöÑÊï∞ÊçÆ‰∫§Êç¢„ÄÇÂÖ∂‰∏≠Êï∞ÊçÆ‰∫§Êç¢ÔºåÂåÖÂê´<strong>Â§ÑÁêÜÂô®ËÆøÈóÆPCIËÆæÂ§áÁöÑÂú∞ÂùÄÁ©∫Èó¥</strong>Âíå<strong>PCIËÆæÂ§á‰ΩøÁî®DMAÊú∫Âà∂ËÆøÈóÆ‰∏ªÂ≠òÂÇ®Âô®</strong>ÔºåÂú®PCIËÆæÂ§áÁî®DMAËÆøÈóÆÂ≠òÂÇ®Âô®Êó∂Ôºå‰ºöÂ≠òÂú®Cache‰∏ÄËá¥ÊÄßÈóÆÈ¢òÔºåËøô‰∏™‰πüÊòØHost BridgeËÆæËÆ°Êó∂ÈúÄË¶ÅËÄÉËôëÁöÑ„ÄÇÊ≠§Â§ñÔºåHost BridgeËøòÂèØÈÄâÁöÑÊîØÊåÅ‰ª≤Ë£ÅÊú∫Âà∂ÔºåÁÉ≠ÊèíÊãîÁ≠âÔºõ</p>
</li>
<li>
<p><em><strong><code>PCI Local Bus</code></strong></em></p>
<p>PCIÊÄªÁ∫øÔºåÁî±Host BridgeÊàñËÄÖPCI-to-PCI BridgeÁÆ°ÁêÜÔºåÁî®Êù•ËøûÊé•ÂêÑÁ±ªËÆæÂ§áÔºåÊØîÂ¶ÇÂ£∞Âç°„ÄÅÁΩëÂç°„ÄÅIDEÊé•Âè£Á≠â„ÄÇÂèØ‰ª•ÈÄöËøáPCI-to-PCI BridgeÊù•Êâ©Â±ïPCIÊÄªÁ∫øÔºåÂπ∂ÊûÑÊàêÂ§öÁ∫ßÊÄªÁ∫øÁöÑÊÄªÁ∫øÊ†ëÔºåÊØîÂ¶ÇÂõæ‰∏≠ÁöÑ<code>PCI Local Bus #0</code>Âíå<code>PCI Local Bus #1</code>‰∏§Êù°PCIÊÄªÁ∫øÂ∞±ÊûÑÊàê‰∏ÄÈ¢óÊÄªÁ∫øÊ†ëÔºåÂêåÂ±û‰∏Ä‰∏™ÊÄªÁ∫øÂüüÔºõ</p>
</li>
<li>
<p><em><strong><code>PCI-To-PCI Bridge</code></strong></em></p>
<p>PCIÊ°•ÔºåÁî®‰∫éÊâ©Â±ïPCIÊÄªÁ∫øÔºå‰ΩøÈááÁî®PCIÊÄªÁ∫øËøõË°åÂ§ßËßÑÊ®°Á≥ªÁªü‰∫íËÅîÊàê‰∏∫ÂèØËÉΩÔºåÁÆ°ÁêÜ‰∏ãÊ∏∏ÊÄªÁ∫øÔºåÂπ∂ËΩ¨Âèë‰∏ä‰∏ãÊ∏∏ÊÄªÁ∫ø‰πãÈó¥ÁöÑ‰∫ãÂä°Ôºõ</p>
</li>
<li>
<p><em><strong><code>PCI Device</code></strong></em></p>
<ul>
<li>**PCI‰ªéËÆæÂ§áÔºö**Ë¢´Âä®Êé•Êî∂Êù•Ëá™Host BridgeÊàñËÄÖÂÖ∂‰ªñPCIËÆæÂ§áÁöÑËØªÂÜôËØ∑Ê±ÇÔºõ</li>
<li><strong>PCI‰∏ªËÆæÂ§á</strong>ÔºöÂèØ‰ª•ÈÄöËøáÊÄªÁ∫ø‰ª≤Ë£ÅËé∑ÂæóPCIÊÄªÁ∫øÁöÑ‰ΩøÁî®ÊùÉÔºå‰∏ªÂä®ÂêëÂÖ∂‰ªñPCIËÆæÂ§áÊàñ‰∏ªÂ≠òÂÇ®Âô®ÂèëËµ∑ËØªÂÜôËØ∑Ê±ÇÔºõ</li>
<li>**Ê°•ËÆæÂ§áÔºö**ÁÆ°ÁêÜ‰∏ãÊ∏∏ÁöÑPCIÊÄªÁ∫øÔºåÂπ∂ËΩ¨Âèë‰∏ä‰∏ãÊ∏∏ÊÄªÁ∫ø‰πãÈó¥ÁöÑÊÄªÁ∫ø‰∫ãÂä°ÔºåÂåÖÊã¨PCIÊ°•„ÄÅPCI-to-ISAÊ°•„ÄÅPCI-to-CardbusÊ°•Á≠âÔºõ</li>
</ul>
</li>
</ol>
<hr>
<p>‰∏Ä‰∏™ÊèíÂÖ•Âú®PCIÊèíÊßΩ‰∏≠ÁöÑÁâ©ÁêÜPCIËÆæÂ§áÂèØËÉΩÂÖ∑ÊúâÂ§ö‰∏™ÂäüËÉΩÂçïÂÖÉÔºåÂÖ∂‰∏≠ÊØè‰∏™ÂäüËÉΩÂçïÂÖÉÁî®ÂäüËÉΩÂè∑ (Function Number) Ë°®Á§∫„ÄÇÊìç‰ΩúÁ≥ªÁªü‰ºöÂ∞ÜÊüê‰∏ÄÁâ©ÁêÜPCIËÆæÂ§áÁöÑ‰∏çÂêåÈÄªËæëËÆæÂ§áËßÜ‰ΩúÂ§ö‰∏™Áã¨Á´ãÁöÑÈÄªËæëËÆæÂ§á„ÄÇÊú¨Ë¥®‰∏äÔºåCPUÈÄöËøáI/OËÆøÈóÆÁöÑÊòØPCIËÆæÂ§áÁöÑÊüê‰∏™ÈÄªËæëËÆæÂ§á„ÄÇÈÄöËøáPCIÊÄªÁ∫øÁöÑÂàÜÂ±ÇÁªìÊûÑÂèØ‰ª•Ê†πÊçÆÊÄªÁ∫øÂè∑ÂíåËÆæÂ§áÂè∑Á°ÆÂÆöÊüê‰∏™Áâ©ÁêÜPCIËÆæÂ§áÔºåËøõËÄå<strong>‰∏Ä‰∏™PCIÈÄªËæëËÆæÂ§áÂèØ‰ª•Áî±ÊÄªÁ∫øÂè∑„ÄÅËÆæÂ§áÂè∑„ÄÅÂäüËÉΩÂè∑‰∏â‰∏™ÂèÇÊï∞ÂîØ‰∏ÄÁ°ÆÂÆöÔºåËøô‰∏â‰∏™ÂèÇÊï∞Â∞±ÊûÑÊàê‰∫ÜPCIËÆæÂ§áÊ†áËØÜÁ¨¶„ÄÇ</strong></p>
<p>Êìç‰ΩúÁ≥ªÁªüÈÄöËøáÊØè‰∏™PCIËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥ËØÜÂà´ÂíåËÆøÈóÆPCIËÆæÂ§á„ÄÇPCIÈÖçÁΩÆÁ©∫Èó¥ÁöÑÂ§ßÂ∞è‰∏∫256Â≠óËäÇÔºåÂÆûÈôÖ‰∏äÊòØ‰∏ÄÁªÑËøûÁª≠ÁöÑËÆæÂ§áÂØÑÂ≠òÂô®„ÄÇÂ¶ÇÂõæ‰∏ãÊâÄÁ§∫ÔºåÂÖ∂‰∏≠Ââç64Â≠óËäÇÁß∞‰∏∫ÈÖçÁΩÆÂ§¥ÔºåÁî±PCIÊ†áÂáÜÁªü‰∏ÄËßÑÂÆöÊ†ºÂºèÂíåÁî®ÈÄî„ÄÇÈÖçÁΩÆÂ§¥ÁöÑ‰∏ªË¶ÅÂäüËÉΩÊòØËØÜÂà´ËÆæÂ§á„ÄÅÂÆö‰πâ‰∏ªÊú∫ËÆøÈóÆPCIÂç°ÁöÑÊñπÂºèÔºå‰æãÂ¶ÇËÆæÂ§áÂè∑(Device ID)ÂíåÂéÇÂïÜÂè∑(Vendor ID)Áî®‰∫éË°®Á§∫ËÆæÂ§áÁöÑÁ±ªÂûãÂíåÁîü‰∫ßËØ•ËÆæÂ§áÁöÑÂéÇÂïÜ„ÄÇPCIÈÖçÁΩÆÁ©∫Èó¥ÁöÑÂâ©‰Ωô192Â≠óËäÇÁî±PCIËÆæÂ§áËá™Â∑±ÂÆö‰πâ„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171551319.png" alt="image-20231117111936708" style="zoom:67%;" />
<p>PCIÈÖçÁΩÆÁ©∫Èó¥Êúâ6‰∏™BARÔºàBase Address RegistersÔºåÂü∫Âú∞ÂùÄÂØÑÂ≠òÂô®ÔºâÔºåÂç≥PCI BARÔºå‰ª£Ë°®ÊØè‰∏™PCIËÆæÂ§áÊúÄÂ§öËÉΩÊò†Â∞Ñ6ÊÆµÂú∞ÂùÄÁ©∫Èó¥ÔºåÁºñÂè∑ÂàÜÂà´‰∏∫i=0Ôºå1Ôºå2Ôºå‚Ä¶Ôºå5„ÄÇBARËÆ∞ÂΩïËÆæÂ§áÊâÄÈúÄË¶ÅÁöÑÂú∞ÂùÄÁ©∫Èó¥ÁöÑÁ±ªÂûãÔºàÂÜÖÂ≠òÁ©∫Èó¥ÊàñËÄÖI/OÁ©∫Èó¥ÔºåÁî®BARÁöÑÊúÄÂêé‰∏Ä‰ΩçÂå∫ÂàÜÔºâ„ÄÅÂü∫Âú∞ÂùÄ‰ª•ÂèäÂÖ∂‰ªñÂ±ûÊÄß„ÄÇ</p>
<p>PCIËÆæÂ§áÊ†áËØÜÁ¨¶ÂèØ‰ª•Ë¢´ËßÜ‰∏∫ËÆæÂ§áPCIÈÖçÁΩÆÁ©∫Èó¥Âú∞ÂùÄÁöÑ‰∏ÄÈÉ®ÂàÜÔºå‰∏ªÊ°•ËÉΩÂ§üÊ†πÊçÆPCIËÆæÂ§áÊ†áËØÜÁ¨¶ÈÄâÊã©ÂØπÂ∫îPCIËÆæÂ§áÂπ∂Ê†πÊçÆÂØÑÂ≠òÂô®ÂÅèÁßªÂú∞ÂùÄËé∑ÂèñËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥ÁöÑ‰ø°ÊÅØ„ÄÇ</p>
<p><strong>PCIÈÖçÁΩÆÁ©∫Èó¥Âú∞ÂùÄÁöÑÁªìÊûÑ</strong>Â¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171120161.png"
	
	
	
	loading="lazy"
	
		alt="image-20231117112036102"
	
	
></p>
<p>ÂÖ∂‰∏≠ <code>[23‚à∂8]</code> ‰∏∫ËÆæÂ§áÊ†áËØÜÁ¨¶ÔºåÈ´ò8‰ΩçÊÄªÁ∫øÁºñÂè∑ (Bus number) Â≠óÊÆµ‰ª£Ë°®ËÆæÂ§áÊâÄÂú®ÁöÑÊÄªÁ∫øÔºå‰∏≠Èó¥ 5 ‰ΩçËÆæÂ§áÁºñÂè∑ (Device number) Â≠óÊÆµÊåáÁ§∫ÊÄªÁ∫ø‰∏äÁöÑÂÖ∑‰ΩìÊüê‰∏™Áâ©ÁêÜËÆæÂ§áÔºåÊúÄÂêé 3 ‰ΩçÂäüËÉΩÁºñÂè∑ (Function number) Â≠óÊÆµÊ†áËØÜÁâ©ÁêÜËÆæÂ§á‰∏äÁöÑÊüê‰∏™ÈÄªËæëËÆæÂ§á„ÄÇÊ†πÊçÆÊØè‰∏™Â≠óÊÆµÁöÑ‰ΩçÊï∞ÔºåÁ≥ªÁªüÊúÄÂ§öÂèØ‰ª•Êúâ 256 Êù°PCIÊÄªÁ∫øÔºåÊØèÊù°ÊÄªÁ∫ø‰∏äÊúÄÂ§öÊúâ 32 ‰∏™Áâ©ÁêÜËÆæÂ§áÔºåÂêåÊó∂ÊØè‰∏™ËÆæÂ§áÊúÄÂ§öÊã•Êúâ 8 ‰∏™ÂäüËÉΩÂçïÂÖÉÔºåÂç≥ÈÄªËæëËÆæÂ§á„ÄÇ‰∏∫‰∫ÜÊñπ‰æøË°®ËææÔºåÊú¨Êñá‰ª• 3 ‰∏™Â≠óÊÆµÁöÑÈ¶ñÂ≠óÊØçÁº©ÂÜô<code>BDF</code> ‰ª£Ë°®PCIËÆæÂ§áÊ†áËØÜÁ¨¶„ÄÇ</p>
<h2 id="22-ËÆæÂ§áÊ®°Êãü">2.2 ËÆæÂ§áÊ®°Êãü
</h2><p>Áî±‰∫éÂ§ñËÆæÁöÑÁßçÁ±ªÁπÅÂ§öÔºåËÆæÂ§áÊ®°ÂûãÈúÄË¶ÅÊ®°ÊãüÊØè‰∏™ËÆæÂ§áÊã•ÊúâÁöÑ‰∏çÂêåÊé•Âè£ÂíåÂäüËÉΩÔºåÂπ∂‰∏îÊèê‰æõÂ§öÁßçËÆæÂ§áËÆøÈóÆÊñπÂºèÔºåËøôÂØºËá¥ËÆæÂ§áÊ®°ÂûãÁöÑÂÆûÁé∞ÂçÅÂàÜÂ§çÊùÇ„ÄÇ‰ΩÜÊòØÊÄª‰ΩìÊù•ÁúãÔºåËôΩÁÑ∂ÊØè‰∏™ËÆæÂ§áÁöÑÊé•Âè£Êï∞Èáè‰ª•ÂèäÂÜÖÈÉ®ÈÄªËæëÊúâÊâÄÂ∑ÆÂºÇÔºå‰ΩÜ<strong>CPUÊú¨Ë¥®‰∏äÈÉΩÊòØÈÄöËøáËØªÂÜô‰∏ÄÁªÑËÆæÂ§áÂØÑÂ≠òÂô®ÊàñËÆæÂ§áRAMÂÆûÁé∞ÂØπËÆæÂ§áÁöÑËÆøÈóÆÔºåËøôÂ∞±‰Ωø‰∏çÂêåËôöÊãüËÆæÂ§áÁöÑÂ∫ïÂ±ÇÂÆûÁé∞‰πãÈó¥ÂÖ∑ÊúâÁõ∏‰ººÊÄß„ÄÇ<strong>Êú¨ËäÇÂ∞Ü‰ªé</strong>PIO„ÄÅMMIO„ÄÅDMAÂíåPCIÈÖçÁΩÆÁ©∫Èó¥</strong>ËÆøÈóÆÂõõ‰∏™ÊñπÈù¢‰ªãÁªçËÆæÂ§áÊ®°ÊãüÁöÑÂÆûÁé∞„ÄÇ</p>
<blockquote>
<p><em><strong>PMIO</strong></em></p>
</blockquote>
<p>x86Êû∂ÊûÑÊèê‰æõ‰∫Ü <code>IN/OUT</code>„ÄÅ<code>INS/OUTS</code> Á≠âÊåá‰ª§ËÆøÈóÆ‰∏éËÆæÂ§áÂØÑÂ≠òÂô®Áõ∏ÂÖ≥ÁöÑI/OÁ´ØÂè£„ÄÇHypervisorÂ∞ÜËøôÂõõÊù°Êåá‰ª§ËÆæÂÆö‰∏∫‰ºöËß¶ÂèëVM-ExitÁöÑÊïèÊÑüÊåá‰ª§ÔºåÂΩìÂÆ¢Êà∑Êú∫ÈÄöËøáÂèëËµ∑ËøôÂõõÊù°Êåá‰ª§ËøõË°åÁ´ØÂè£I/OÊìç‰ΩúÊó∂‰ºöËß¶ÂèëVM-ExitÔºåÈô∑ÂÖ•Hypervisor„ÄÇÂêåÊó∂Hypervisor‰ºö‰øùÂ≠òËÆøÈóÆÁöÑÁ´ØÂè£Âè∑„ÄÅËÆøÈóÆÊï∞ÊçÆÂÆΩÂ∫¶„ÄÅÊï∞ÊçÆ‰º†ËæìÊñπÂêëÁ≠âÁõ∏ÂÖ≥‰ø°ÊÅØÔºå‰ª•ËææÂà∞Êà™Ëé∑ÂÆ¢Êà∑Êú∫Á´ØÂè£I/OÊìç‰ΩúÁöÑÁõÆÁöÑ„ÄÇ‰∏ãÂõæÂ±ïÁ§∫‰∫ÜHypervisorÊ®°ÊãüËôöÊãüÊú∫ÂèëËµ∑‰∏ÄÊ¨°PMIOËÆøÈóÆÁöÑËøáÁ®ã„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171551625.png" alt="image-20231117132217144" style="zoom:67%;" />
<ol>
<li><strong>out Êåá‰ª§Ëß¶Âèë VM-ExitÔºõ</strong></li>
<li><strong>Ê®°Êãü out Êåá‰ª§Âπ∂ËøîÂõûÂÆ¢Êà∑Êú∫Ôºõ</strong></li>
</ol>
<p>ËÆæÂ§áÊ®°ÂûãÂú®ÂàùÂßãÂåñÈò∂ÊÆµ‰ºöÂ∞ÜËôöÊãüËÆæÂ§áÊ∂âÂèäÁöÑPMIOÂ§ÑÁêÜÂáΩÊï∞Âú®Hypervisor‰∏≠ËøõË°åÊ≥®ÂÜåÔºåÂπ∂‰ª•Êï∞ÁªÑÁöÑÂΩ¢ÂºèÂ≠òÂÇ®I/OÂ§ÑÁêÜÂáΩÊï∞ÁöÑÊåáÈíà„ÄÇHypervisor‰ºöÊ†πÊçÆÊà™Ëé∑ÁöÑÁ´ØÂè£Âè∑ÂíåËÆøÈóÆÁöÑÊï∞ÊçÆÂÆΩÂ∫¶‰∏éÁõ∏Â∫îÁöÑPMIOÂ§ÑÁêÜÂáΩÊï∞ËøõË°åÂåπÈÖçÔºåÊâæÂà∞Áõ∏ÂÖ≥ÂáΩÊï∞ÁöÑÊåáÈíàÂêéÔºå‰∫§Áî±PIOÂ§ÑÁêÜÂáΩÊï∞ËøõË°åËøõ‰∏ÄÊ≠•ÁöÑÊ®°ÊãüËøáÁ®ã„ÄÇ</p>
<blockquote>
<p><em><strong>MMIO</strong></em></p>
</blockquote>
<p>ÂÜÖÂ≠òÊò†Â∞ÑI/OÁõ∏ËæÉ‰∫éÁ´ØÂè£I/OÊòØ‰∏ÄÁßçÂ∫îÁî®Êõ¥Âä†ÂπøÊ≥õÁöÑI/OÂΩ¢Âºè„ÄÇMMIOÂú∞ÂùÄÁ©∫Èó¥Â±û‰∫éÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥‰∏≠ÁöÑÈ´òÂú∞ÂùÄÈÉ®ÂàÜÔºåÁ®ãÂ∫èÂèØ‰ª•‰ΩøÁî®ÂÜÖÂ≠òËÆøÈóÆÊåá‰ª§ËøõË°åMMIO„ÄÇ‰∏éÁ´ØÂè£I/OÊ∂âÂèäÁöÑIN/OUTÊåá‰ª§‰∏çÂêåÁöÑÊòØÔºåÂÜÖÂ≠òËÆøÈóÆÊåá‰ª§Âπ∂‰∏çÂ±û‰∫éMMIOÁöÑ‰∏ìÂ±ûÊåá‰ª§ÔºåHypervisor‰∏çËÉΩÂ∞ÜÂÖ∂ËÆæ‰∏∫ÊïèÊÑüÊåá‰ª§„ÄÇÈÇ£ÈíàÂØπMMIOËÆøÈóÆËØ•Â¶Ç‰ΩïËß¶ÂèëVM ExitÂë¢Ôºü</p>
<ul>
<li><font color='red'><strong>‰∏∫‰∫ÜÊà™Ëé∑ÂÆ¢Êà∑Êú∫ÁöÑMMIOÊìç‰ΩúÔºåHypervisor‰∏ç‰ºöÂ∞ÜËôöÊãüÊú∫‰∏≠MMIOÊâÄÂú®ÁöÑÁâ©ÁêÜÂú∞ÂùÄËåÉÂõ¥Êò†Â∞ÑÂà∞‰∏ªÊú∫ÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÂç≥ÂΩ±Â≠êÈ°µË°®‰∏≠‰∏çÂ≠òÂú®Áõ∏Â∫îÁöÑÈ°µË°®È°π„ÄÇÊØèÊ¨°ÂΩìÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂèëËµ∑MMIOÊó∂ÔºåÈÉΩ‰ºö‰∫ßÁîü‰∏Ä‰∏™Áº∫È°µÂºÇÂ∏∏Ôºå‰∫ßÁîüVM-ExitÔºåËøôÊ†∑Â∞±ÂèØ‰ª•Êà™Ëé∑ÂÆ¢Êà∑Êú∫ÁöÑMMIOËÆøÈóÆÂπ∂‰∫§Áî±Áõ∏ÂÖ≥Â§ÑÁêÜÂáΩÊï∞Ê®°Êãü„ÄÇ</strong></font></li>
</ul>
<p>MMIOÁõ∏ÂÖ≥ÁöÑÂ§ÑÁêÜÂáΩÊï∞ÁöÑÁªÑÁªáÂΩ¢ÂºèÈÄöÂ∏∏‰∏çÈááÁî®PMIO‰∏≠ÁöÑÊï∞ÁªÑÂΩ¢Âºè„ÄÇËøôÊòØÂõ†‰∏∫MMIOÂç†Áî®ÁöÑÂÜÖÂ≠òÂå∫ÂüüËæÉÂ§ßÔºå‰∏ÄËà¨Êúâ‰∏äÁôæÂÖÜÂ≠óËäÇÔºåÂ¶ÇÊûú‰ΩøÁî®Êï∞ÁªÑ‰øùÂ≠òÊØè‰∏™Á´ØÂè£ÁöÑÂ§ÑÁêÜÂáΩÊï∞‰ºöÂØºËá¥Â∑®Â§ßÁöÑÂÜÖÂ≠òÂç†Áî®„ÄÇÈÄöÂ∏∏ÊØè‰∏™MMIOÁõ∏ÂÖ≥ÁöÑÂ§ÑÁêÜÂáΩÊï∞ËÉΩÂ§üÂ§ÑÁêÜÂØπÊüê‰∏ÄÁâáÂÜÖÂ≠òÂå∫ÂüüÂèëËµ∑ÁöÑMMIOËÆøÈóÆÔºåËøôÊ†∑Â∞±Â§ßÂ§ßÂáèÂ∞ë‰∫ÜÂ§ÑÁêÜÂáΩÊï∞ÁöÑÊï∞ÈáèÔºå‰ªéËÄåÈôç‰Ωé‰∫ÜÂØπÂÜÖÂ≠òÁöÑÂç†Áî®„ÄÇ</p>
<p>ËÆæÂ§áÊ®°ÂûãÈ¶ñÂÖà‰ºöÂêëHypervisorÁî≥ËØ∑MMIOÂå∫ÂüüÂπ∂Ê≥®ÂÜåËØ•MMIOÁöÑÂ§ÑÁêÜÂáΩÊï∞Ôºå‰πãÂêéÂΩìËôöÊãüÊú∫ÂèëËµ∑MMIOËÆøÈóÆÊó∂ÔºåHypervisor‰ºöÊ†πÊçÆ‰∫ßÁîüÂºÇÂ∏∏ÁöÑÂÜÖÂ≠òÂú∞ÂùÄÊâæÂà∞ÂØπÂ∫îÁöÑMMIOÂå∫ÂüüÔºåÊúÄÂêéËØ•MMIOÂå∫ÂüüÊ≥®ÂÜåÁöÑÂ§ÑÁêÜÂáΩÊï∞‰ºöÂÆö‰ΩçÂà∞Ë¶ÅËÆøÈóÆÁöÑI/OÁ´ØÂè£Âπ∂ÊâßË°åÁõ∏ÂÖ≥ËΩØ‰ª∂Ê®°ÊãüËøáÁ®ã„ÄÇ</p>
<blockquote>
<p><em><strong>DMA</strong></em></p>
</blockquote>
<p>‰∏éISAËÆæÂ§á‰∏çÂêåÁöÑÊòØÔºåPCIËÆæÂ§áÊû∂ÊûÑ‰∏≠Âπ∂‰∏çÂ≠òÂú®DMAÊéßÂà∂Âô®Ôºå‰ªª‰Ωï‰∏Ä‰∏™PCIËÆæÂ§áÈÉΩÂèØ‰ª•ÂêëPCIÊÄªÁ∫øÊéßÂà∂Âô®ÂèëËµ∑ÊÄªÁ∫øËØ∑Ê±ÇÔºåËé∑ÂæóÂØπÊÄªÁ∫øÁöÑÊéßÂà∂ÊùÉ„ÄÇ<strong>PCIËÆæÂ§áÂèëËµ∑DMAÁöÑËøáÁ®ãÊòØÁî±Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑËÆæÂ§áÈ©±Âä®Á®ãÂ∫èËÆøÈóÆ‰∏éDMAÊìç‰ΩúÁõ∏ÂÖ≥ÁöÑÁâπÂÆöÁ°¨‰ª∂ÂØÑÂ≠òÂô®ÁªÑÂÆûÁé∞ÁöÑ„ÄÇËÆæÂ§áÈ©±Âä®‰∏ç‰ªÖÂèØ‰ª•ÈÄöËøáÂÜôÂÖ•Áõ∏ÂÖ≥Á°¨‰ª∂ÂØÑÂ≠òÂô®ËÆæÁΩÆDMAÊìç‰ΩúÁöÑÁõÆÁöÑÂú∞ÂùÄÔºåËÄå‰∏îÂèØ‰ª•ÈÄöËøáÂêëDMAÂëΩ‰ª§ÂØÑÂ≠òÂô®ÂÜôÂÖ•DMAÂëΩ‰ª§ÂèëËµ∑DMAËØ∑Ê±Ç„ÄÇ</strong></p>
<p>ËÆæÂ§áÈ©±Âä®Á®ãÂ∫èÂè™ËÉΩ‰ª•PMIOÊàñMMIOÁöÑÊñπÂºèËÆøÈóÆÂ§ñËÆæÂØÑÂ≠òÂô®ÔºåÊâÄ‰ª•HypervisorÈÄöËøáÊà™Ëé∑ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂèëËµ∑ÁöÑPMIOÂíåMMIOÂç≥ÂèØÂÆûÁé∞ÂØπÂÆ¢Êà∑Êú∫DMAËØ∑Ê±ÇÁöÑÊã¶Êà™„ÄÇ‰πãÂêéHypervisor‰ºöÊâßË°åDMAÁõ∏ÂÖ≥Â§ÑÁêÜÊµÅÁ®ã„ÄÇÈ¶ñÂÖàÔºåËÆæÂ§áÊ®°Âûã‰ºöÂÄüÂä©HypervisorÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÂ≠êÁ≥ªÁªüÔºåÂ∞ÜÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÊåáÂÆöÁöÑDMAÂÜÖÂ≠òÊò†Â∞ÑÂà∞Ëá™Ë∫´ÁöÑÂú∞ÂùÄÁ©∫Èó¥‰∏≠„ÄÇ‰πãÂêéËÆæÂ§áÊ®°Âûã‰ºöÊâßË°åÁõ∏Â∫îÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºåÂ∞ÜÊï∞ÊçÆ‰ª•DMAÁöÑÊñπÂºèËØªÂÜôÂà∞HypervisorÊò†Â∞ÑÁöÑDMAÂÜÖÂ≠ò„ÄÇÊúÄÂêéÂΩìÊï∞ÊçÆ‰º†ËæìÂÆåÊØïÔºåËÆæÂ§áÊ®°Âûã‰ºöÈÄöËøáËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®Â∞ÜÂØπÂ∫îÁöÑËôöÊãüËÆæÂ§á‰∏≠Êñ≠Ê≥®ÂÖ•Âà∞ËôöÊãüÊú∫‰∏≠ÔºåËôöÊãüÊú∫ÁªìÊùüÊ≠§Ê¨°DMAÊìç‰Ωú„ÄÇ</p>
<blockquote>
<p><em><strong>PCIÈÖçÁΩÆÁ©∫Èó¥</strong></em></p>
</blockquote>
<p>x86Êû∂ÊûÑÂú®I/OÂú∞ÂùÄÁ©∫Èó¥Êèê‰æõ‰∫Ü‰∏§‰∏™32‰ΩçÂØÑÂ≠òÂô®ÔºåÁî®‰∫éËÆøÈóÆPCIËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥Ôºö</p>
<ul>
<li><code>config_address</code> ÂØÑÂ≠òÂô®ÔºàÁ´ØÂè£Âú∞ÂùÄ‰∏∫0xcf8ÔºâÁî®‰∫éÂ≠òÊîæÁõÆÊ†áPCIËÆæÂ§áÁöÑËÆæÂ§áÊ†áËØÜÁ¨¶Ôºå‰ª•ÂèäË¶ÅËÆøÈóÆÁöÑËÆæÂ§áÂØÑÂ≠òÂô®Âú®ÈÖçÁΩÆÁ©∫Èó¥ÁöÑÂ≠óËäÇÂÅèÁßªÔºõ</li>
<li><code>config_data</code> ÂØÑÂ≠òÂô®ÔºàÁ´ØÂè£Âú∞ÂùÄ‰∏∫0xcfcÔºâÁî®‰∫éÂ≠òÊîæËÆæÂ§áÂØÑÂ≠òÂô®ÁöÑÊï∞ÊçÆÔºõ</li>
</ul>
<p>CPUËØªÂèñÈÖçÁΩÆÁ©∫Èó¥Êó∂ÔºåCPUÈ¶ñÂÖàÂ∞ÜPCIÈÖçÁΩÆÁ©∫Èó¥Âú∞ÂùÄÂÜôÂÖ• <code>config_address</code>Ôºå‰πãÂêéPCI‰∏ªÊ°•ÊääËÆæÂ§áÂè∑ <code>config_address[11:15]</code> ËΩ¨ËØëÂà∞PCIÊÄªÁ∫øÂπ∂ÈÄöÁü•ÂØπÂ∫îPCIËÆæÂ§áÔºåPCIËÆæÂ§á‰ºöÊääÂØπÂ∫îÂØÑÂ≠òÂô®Êï∞ÊçÆÊîæÂÖ•Âú∞ÂùÄÊÄªÁ∫øÔºå‰πãÂêéPCI‰∏ªÊ°•ËØªÂõûÊï∞ÊçÆÔºåÊîæÂà∞ <code>config_data</code> ‰∏≠„ÄÇÊúÄÂêéCPU‰æøÂèØ‰ª•ÈÄöËøá <code>config_data</code>ËÆøÈóÆÈÖçÁΩÆÁ©∫Èó¥ÁöÑÂÜÖÂÆπ„ÄÇÁî±‰∫éËÆøÈóÆËøáÁ®ãÊ∂âÂèäIN/OUTËøô‰∏§‰∏™Á´ØÂè£ËÆøÈóÆÊåá‰ª§ÔºåÊâÄ‰ª•ÂèØ‰ª•ÈÄöËøá‰∏éPMIO‰∏ÄÊ†∑ÁöÑÂΩ¢ÂºèÊ®°ÊãüÂÆ¢Êà∑Êú∫ÂØπPCIÈÖçÁΩÆÁ©∫Èó¥ÁöÑËÆøÈóÆ„ÄÇ</p>
<h2 id="23-ioÂçäËôöÊãüÂåñ">2.3 I/OÂçäËôöÊãüÂåñ
</h2><p><strong>ËÆæÂ§áÂâçÂêéÁ´ØÂàÜÁ¶ª</strong>ÊòØ I/O ÂçäËôöÊãüÂåñÁöÑÊ†∏ÂøÉÊÄùÊÉ≥„ÄÇÂú®ËØ•ÊñπÊ≥ï‰∏ãÔºåËôöÊãüÊú∫‰ΩøÁî®‰∏ìÈó®ÁöÑÂâçÁ´ØÈ©±Âä®Á®ãÂ∫èÔºåÈÄöËøáÁâπÂÆöÊï∞ÊçÆ‰º†ËæìÊé•Âè£‰∏éÁâπÊùÉËôöÊãüÊú∫ÊàñHypervisor‰∏≠ÁöÑÂêéÁ´ØËÆæÂ§á‰∫§‰∫íÔºåÂêéÁ´ØËÆæÂ§áÂàôÈÄöËøáÁâ©ÁêÜÈ©±Âä®Á®ãÂ∫èÂÆåÊàêÂØπÂ§ñËÆæÁöÑËÆøÈóÆ„ÄÇÂú®I/OÂçäËôöÊãüÂåñÈ¢ÜÂüüÔºå‰∏Ä‰∫õÁü•ÂêçÁöÑHypervisorÈÉΩÊé®Âá∫‰∫ÜËá™Â∑±ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºå‰æãÂ¶ÇXenÊèê‰æõÁöÑÂçäËôöÊãüÂåñÈ©±Âä®„ÄÅVMwareÊèê‰æõÁöÑguest toolsÔºåÊú¨ËäÇÂ∞Ü‰ªãÁªç‰∏ÄÁßçË¢´ÂπøÊ≥õ‰ΩøÁî®ÁöÑÂçäËôöÊãüÂåñÊñπÊ°à‚Äî‚Äî <code>virtio</code>„ÄÇ</p>
<p>Linux‰Ωú‰∏∫‰ΩøÁî®ÊúÄÂπøÊ≥õÁöÑÂºÄÊ∫êÊìç‰ΩúÁ≥ªÁªüÔºåËÉΩÂ§üË¢´‰ºóÂ§öËôöÊãüÂåñÊñπÊ°àÊîØÊåÅÔºå‰æãÂ¶ÇXen„ÄÅKVM„ÄÅVMwareÁ≠â„ÄÇËôΩÁÑ∂Ëøô‰∫õHypervisorÈÉΩÊîØÊåÅLinuxÔºå‰ΩÜÊòØÂú®virtioÂá∫Áé∞‰πãÂâçÔºå‰ºóÂ§öHypervisorÂÜÖÈÉΩÊã•ÊúâÂ±û‰∫éËá™Â∑±ÁöÑÂùóËÆæÂ§á„ÄÅÁΩëÁªúËÆæÂ§áÈ©±Âä®ÔºåËÄå‰∏îËøòÈúÄË¶ÅÁª¥Êä§ÂäüËÉΩÈáçÂè†‰ΩÜÂÆûÁé∞ÂèàÊúâÊâÄ‰∏çÂêåÁöÑËÆæÂ§áÊ®°ÂûãÔºåËøôÂ∞±ÁªôÊó•Â∏∏Áª¥Êä§‰ª•ÂèäÊÄßËÉΩ‰ºòÂåñÂ∏¶Êù•‰∫ÜÂæàÂ§ßÁöÑÈ∫ªÁÉ¶„ÄÇ</p>
<p>‰∏∫‰∫ÜËß£ÂÜ≥‰∏äËø∞ÈóÆÈ¢òÔºåIBMÊé®Âá∫‰∫ÜvirtioÔºå**virtioÁöÑ‰∏ªË¶ÅÁõÆÊ†áÊòØ‰∏∫ÂçäËôöÊãüÂåñÊèê‰æõ‰∏Ä‰∏™Áªü‰∏ÄÁöÑÂâçÂêéÁ´ØËÆæÂ§áÊé•Âè£Ê†áÂáÜ„ÄÇ**virtioÂ∞Ü‰∏ÄÁªÑÈ´òÊïà‰∏îÈÄöÁî®ÁöÑLinuxÂâçÁ´ØvirtioÈ©±Âä®Âä†ÂÖ•LinuxÊ∫êÁ†ÅÊ†ë‰∏≠ÔºåÂπ∂Êèê‰æõ‰∫Ü‰∏ÄÁ≥ªÂàóËÉΩÂ§üÂ∫îÁî®‰∫é‰∏çÂêåHypervisorÁöÑÂêéÁ´ØvirtioËÆæÂ§áÔºåËøôÊ†∑ÊòæËëóÈôç‰Ωé‰∫ÜÊó•Â∏∏Áª¥Êä§ÁöÑÊàêÊú¨„ÄÇÂÖ∂‰∏≠Ôºö</p>
<ul>
<li>virtioÈ©±Âä®Á®ãÂ∫èÊòØËôöÊãüÊú∫‰∏≠ÁöÑËΩØ‰ª∂ÈÉ®ÂàÜÔºåÂÆÉ‰æùÊçÆvirtioËßÑËåÉ‰∏évirtioËÆæÂ§áËøõË°åÈÄö‰ø°Ôºå‰∏ªË¶Å‰ΩúÁî®ÊòØÂèëÁé∞virtioËÆæÂ§áÂπ∂Âú®ËôöÊãüÊú∫‰∏≠ÂàÜÈÖçÁî®‰∫éÂâçÂêéÁ´ØÈÄö‰ø°ÁöÑÂÖ±‰∫´ÂÜÖÂ≠òÔºõ</li>
<li>virtioËÆæÂ§á‰ºöÂÖ¨ÂºÄvirtioÊé•Âè£ÔºåÁî®‰∫éÁÆ°ÁêÜÂíå‰∫§Êç¢‰ø°ÊÅØ„ÄÇvirtioÊé•Âè£‰∏ÄËà¨ÂåÖÊã¨ËÆæÂ§áÁä∂ÊÄÅ(Device Status)„ÄÅËÆæÂ§áÊîØÊåÅÁöÑÁâπÊÄß(Virtio Feature)‰ª•ÂèäÂâçÂêéÁ´ØÊï∞ÊçÆ‰º†ËæìÁöÑÈÄöÈÅìÔºàVirtqueueÈòüÂàóÔºâ„ÄÇÂâçÂêéÁ´ØÊ∂àÊÅØÈÄöÁü•Êú∫Âà∂ (Notification) ÂêåÊ†∑‰πüÂ±û‰∫évirtioÊé•Âè£ÁöÑ‰∏ÄÈÉ®ÂàÜÔºåÁî®‰∫éÊèêÈÜíÂâçÂêéÁ´ØÂ§ÑÁêÜÂà∞Êù•ÁöÑ‰ø°ÊÅØ„ÄÇ</li>
</ul>
<p>virtio‰Ωú‰∏∫‰∏Ä‰∏™ÈÄöÁî®ÂçäËôöÊãüÂåñÊ°ÜÊû∂ÔºåÂèØ‰ª•Âú®‰∏çÂêåÁ±ªÂûãËÆæÂ§áÊÄªÁ∫ø‰πã‰∏äÂÆûÁé∞ÔºåÊú¨ÊñáÂ∞ÜÂü∫‰∫éÊúÄÊôÆÈÅçÁöÑPCIÊÄªÁ∫ø‰ªãÁªçvirtioÁöÑÂÖ∑‰ΩìÂÆûÁé∞„ÄÇ</p>
<hr>
<h3 id="virtio-pci">virtio-pci
</h3><p>‰∏∫‰∫ÜÊîØÊåÅPCIÊÄªÁ∫øÔºåÊØèÁßçvirtioËÆæÂ§áÈúÄË¶ÅÂØπÂ∫î‰∏Ä‰∏™ <code>virtio-pci</code> ‰ª£ÁêÜËÆæÂ§á„ÄÇ<code>virtio-pci</code> ‰ª£ÁêÜËÆæÂ§áËÉΩÂ§üÈÄöËøá‰∏éPCIËÆæÂ§áÁõ∏‰ººÁöÑÊñπÂºèË¢´ËôöÊãüÊú∫‰∏≠ÁöÑBIOSÊàñÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËØÜÂà´ÔºåÂπ∂ÊåÇËΩΩÂà∞PCIÊÄªÁ∫ø„ÄÇ<strong><code>virtio-pci</code> ‰ª£ÁêÜËÆæÂ§áÁöÑ‰∏Ä‰∏™ÈáçË¶Å‰ΩúÁî®ÊòØÊèê‰æõvirtioËÆæÂ§áÁöÑËÆøÈóÆÊé•Âè£ÔºåÂÆÉ‰ºöÂàõÂª∫‰∏ÄÊù°virtioÊÄªÁ∫øÔºåÂπ∂Â∞ÜvirtioËÆæÂ§áÊåÇËΩΩÂà∞virtioÊÄªÁ∫øÔºåËøôÊ†∑virtioÈ©±Âä®‰æøËÉΩÂ§üËÆøÈóÆvirtioËÆæÂ§á„ÄÇ</strong></p>
<p><code>virtio-pci</code> ËÆæÂ§áÊã•Êúâ‰∏ìÂ±ûÁöÑÂéÇÂïÜÂè∑ <code>0x1a4</code> ‰ª•ÂèäÁâπÂÆöÁöÑËÆæÂ§áÂè∑ÁöÑÂå∫Èó¥ <code>0x1000-0x10ff</code>„ÄÇÁ≥ªÁªüÂèØ‰ª•ÈÄöËøáÂéÇÂïÜÂè∑ËØÜÂà´Âá∫ËØ•PCIËÆæÂ§á‰∏∫ <code>virtio-pci</code> ËÆæÂ§á„ÄÇÂ≠êÁ≥ªÁªüÂéÇÂïÜÂè∑ (Subsystem Vendor ID) ÂíåËÆæÂ§áÂè∑ÂèØ‰ª•Áî®‰∫éÊåáÁ§∫ËØ• <code>virtio-pci</code> ËÆæÂ§áÊîØÊåÅÁöÑvirtioËÆæÂ§áÁ±ªÂûã„ÄÇ</p>
<p>Á≥ªÁªüÈÄöÂ∏∏‰ºö‰ΩøÁî® <code>virtio-pci</code> ËÆæÂ§áÁöÑÁ¨¨‰∏Ä‰∏™BARÊåáÁ§∫ÁöÑI/OÁ©∫Èó¥ÂØπ <code>virtio-pci</code> ËÆæÂ§áËøõË°åÈÖçÁΩÆ„ÄÇËØ•I/OÂå∫ÂüüÂåÖÊã¨‰∏Ä‰∏™ <code>virtio-header</code> ÁªìÊûÑÔºåÁî®‰∫éÂ≠òÊîævirtioËÆæÂ§áÁöÑÈÄöÁî®ÈÖçÁΩÆÈ°π‰ª•ÂèäËÆæÂ§áÁöÑ‰∏ìÂ±ûÈÖçÁΩÆ„ÄÇ‰∏ãÂõæÂ±ïÁ§∫‰∫Ü <code>virtio-header</code> ‰∏≠ÁöÑÈÄöÁî®ÈÖçÁΩÆÈ°πÔºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171342096.png"
	
	
	
	loading="lazy"
	
		alt="image-20231117134249051"
	
	
></p>
<p>Áî±‰∫évirtioËÆæÂ§áÈúÄË¶ÅÊåÇËΩΩÂà∞ <code>virtio-pci</code> ËÆæÂ§áÊèê‰æõÁöÑvirtioÊÄªÁ∫øÔºåÊâÄ‰ª•virtioËÆæÂ§áÊé¢Êµã‰∏éÈ©±Âä®Âä†ËΩΩÈúÄË¶ÅÂú® <code>virtio-pci</code> ÂàùÂßãÂåñÂÆåÊàêÁöÑÂâçÊèê‰∏ãËøõË°å„ÄÇÂõ†Ê≠§Êï¥‰∏™virtioÂâçÁ´ØÂàùÂßãÂåñËøáÁ®ãÂèØ‰ª•ÂàÜ‰∏∫Ôºö<strong>virtio-pciËÆæÂ§áÊé¢ÊµãÂíåÈ©±Âä®Âä†ËΩΩ</strong>Âíå<strong>virtioËÆæÂ§áÂàùÂßãÂåñÂíåÈ©±Âä®Âä†ËΩΩ</strong>‰∏§‰∏™Èò∂ÊÆµ„ÄÇ</p>
<p><code>virtio-pci</code> ËÆæÂ§á‰Ωú‰∏∫PCIËÆæÂ§áÁöÑ‰∏ÄÁßçÔºåÂèØ‰ª•ÈÄöËøá‰∏éÂÖ∂‰ªñPCIËÆæÂ§á‰∏ÄÊ†∑ÁöÑÊñπÂºèË¢´Êé¢Êµã„ÄÇËôöÊãüÊú∫ÂêØÂä®Êó∂ÔºåËôöÊãüBIOSÂíåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰ºöÊâ´ÊèèPCIÊÄªÁ∫øÔºåËøõË°åPCIËÆæÂ§áÊûö‰∏æËøáÁ®ã„ÄÇËØ•ËøáÁ®ã‰ºöÊé¢ÊµãÂà∞ <code>virtio-pci</code> ËÆæÂ§áÔºåÂπ∂Â∞Ü <code>virtio-pci</code> ËÆæÂ§áÊ≥®ÂÜåÂà∞PCIÊÄªÁ∫ø„ÄÇ‰πãÂêéÔºå‰∏éËÆæÂ§áÂíåÈ©±Âä®ÂåπÈÖçÁõ∏ÂÖ≥ÁöÑmatchÂáΩÊï∞Â∞ÜÊ†πÊçÆPCIÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑÂéÇÂïÜÂè∑„ÄÅËÆæÂ§áÂè∑„ÄÅÂ≠êÁ≥ªÁªüÂéÇÂïÜÂè∑ÂíåÂ≠êËÆæÂ§áÂè∑‰∏∫ËÆæÂ§áÁªëÂÆöÂØπÂ∫îÈ©±Âä®„ÄÇ</p>
<ul>
<li>
<p>PCIËÆæÂ§áÂíåÈ©±Âä®ÂåπÈÖçÁöÑ‰æùÊçÆÈÄöÂ∏∏ÊòØÈ©±Âä®‰∏≠ÁöÑ‰∏Ä‰∏™Áî±<code>pci_device_id</code> ÁªÑÊàêÁöÑ <code>id_table</code> Êï∞ÁªÑ„ÄÇÂú® <code>virtio-pci</code> ËÆæÂ§áÈ©±Âä®‰∏≠ÔºåÂ∞ÜÂéÇÂïÜÂè∑ËÆæÁΩÆ‰∏∫0x1a4ÔºåËÄåËÆæÂ§áÂè∑„ÄÅÂ≠êÁ≥ªÁªüÂéÇÂïÜÂè∑„ÄÅÂ≠êËÆæÂ§áÂè∑ÈÉΩË¢´ÁΩÆ‰∏∫PCI_ANY_IDÔºåË°®Á§∫ÂèØ‰ª•ÂåπÈÖç‰ªª‰ΩïID„ÄÇËøôÊ†∑Êó†ËÆ∫ÊòØÂì™‰∏ÄÁßç <code>virtio-pci</code> ËÆæÂ§áÔºåÈÉΩËÉΩ‰∏éÂÖ±Áî®ÁöÑ<code>virtio-pci</code> ËÆæÂ§áÈ©±Âä®ÁªëÂÆö„ÄÇ<code>virtio-pci</code> ËÆæÂ§á‰∏é <code>virtio-pci</code> ËÆæÂ§áÈ©±Âä®ÁªëÂÆöÂêéÔºå‰ºöËøõÂÖ• <code>virtio-pci</code> ËÆæÂ§áÊé¢ÊµãÈò∂ÊÆµ„ÄÇ</p>
</li>
<li>
<p><code>virtio-pci</code> ËÆæÂ§áÊé¢ÊµãÈò∂ÊÆµÈÄöÂ∏∏‰ΩøÁî® <code>virtio_pci_device</code> ÁªìÊûÑ‰ΩìË°®Á§∫ <code>virtio-pci</code> ËÆæÂ§á„ÄÇËØ•Èò∂ÊÆµ‰ºö‰ΩøËÉΩ <code>virtio-pci</code> ËÆæÂ§áÂπ∂ÂàùÂßãÂåñÁõ∏Â∫îÁöÑvirtioËÆæÂ§áÂíåvirtioÊÄªÁ∫ø„ÄÇ</p>
</li>
<li>
<p>ÊúÄÂêévirtioËÆæÂ§á‰ºöË¢´Ê≥®ÂÜåÂà∞virtioÊÄªÁ∫ø‰∏äÔºåËØ•ËøáÁ®ã‰ºöËß¶ÂèëvirtioÊÄªÁ∫ø‰∏ävirtioËÆæÂ§á‰∏évirtioÈ©±Âä®‰πãÈó¥ÁöÑÂåπÈÖçÊìç‰Ωú„ÄÇÂåπÈÖçÊìç‰ΩúÊàêÂäü‰πãÂêéÔºåvirtioÈ©±Âä®‰ºöËøõË°åvirtioËÆæÂ§áÊé¢ÊµãËøáÁ®ãÔºà‰æãÂ¶Ç <code>virtioblk_probe</code> Ôºâ„ÄÇvirtioËÆæÂ§áÊé¢ÊµãÁöÑ‰∏ªË¶Å‰ªªÂä°ÊòØËØªÂèñ <code>virtio-pci</code> ÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÂÖ≥‰∫évirtioËÆæÂ§áÈÖçÁΩÆÁöÑÂÜÖÂÆπ(<code>virtio-header</code>)Ôºå‰πãÂêéÊåâÁÖßvirtioÈÖçÁΩÆÂàùÂßãÂåñvirtqueueÔºåÂπ∂Ê†πÊçÆvirtioËÆæÂ§áÁöÑÁâπÊÄßÂàùÂßãÂåñÂØπÂ∫îÁöÑÁâ©ÁêÜËÆæÂ§á„ÄÇ</p>
</li>
</ul>
<p>‰∏ãÂõæÂ±ïÁ§∫‰∫Ü virtio ÂâçÂêéÁ´ØÊû∂ÊûÑÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171550642.png" alt="image-20231117134345199" style="zoom:50%;" />
<p>‰∏ªË¶ÅÂåÖÂê´‰∏âÈÉ®ÂàÜÔºåÂâçÁ´ØÈ©±Âä®„ÄÅÂêéÁ´ØËÆæÂ§á„ÄÅvirtqueueÔºö</p>
<ul>
<li><strong>ÂâçÁ´ØÈ©±Âä®</strong>‰Ωç‰∫éÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂÜÖÈÉ®ÔºåÂåÖÊã¨ <code>virtio/virtio-pci</code> ËÆæÂ§áÈ©±Âä®ÔºåÂÖ∂‰ΩúÁî®ÊòØÊé•Êî∂Áî®Êà∑ÊÄÅËØ∑Ê±ÇÔºåÁÑ∂ÂêéÊ†πÊçÆ‰º†ËæìÂçèËÆÆÂ∞ÜÂ∞ÅË£ÖÂêéÁöÑI/OËØ∑Ê±ÇÊîæÂÖ•virtqueueÔºåÂπ∂ÂêëÂêéÁ´ØÂèëÈÄÅ‰∏Ä‰∏™ÈÄöÁü•Ôºõ</li>
<li><strong>ÂêéÁ´ØËÆæÂ§á</strong>‰Ωç‰∫éQEMUÊàñÂÆø‰∏ªÊú∫ÂÜÖÊ†∏‰∏≠ÔºåÂåÖÊã¨ <code>virtio/virtio-pci</code> ËÆæÂ§á„ÄÇÂêéÁ´ØËÆæÂ§á‰ªévirtqueue‰∏≠Êé•Êî∂ÂâçÁ´ØÈ©±Âä®ÂèëÂá∫ÁöÑI/OËØ∑Ê±ÇÁöÑÂü∫Êú¨‰ø°ÊÅØÔºåÁÑ∂ÂêéË∞ÉÁî®Áõ∏ÂÖ≥ÂáΩÊï∞ÂÆåÊàêI/OÊìç‰ΩúÔºåÊúÄÂêéÂêëÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂâçÁ´ØÈ©±Âä®ÂèëËµ∑‰∏≠Êñ≠Ôºõ</li>
<li>‰∏çÂêåvirtioËÆæÂ§áÂèØËÉΩÊã•Êúâ‰∏çÂêåÊï∞ÈáèÁöÑ**virtqueueÔºå**‰æãÂ¶ÇvirtioÂùóËÆæÂ§áÂè™Êúâ‰∏Ä‰∏™virtqueueÔºåËÄåvirtioÁΩëÂç°ËÆæÂ§áÂàôÊúâ‰∏§‰∏™virtqueueÔºå‰∏Ä‰∏™Áî®‰∫éÂèëÈÄÅÊï∞ÊçÆÂè¶‰∏Ä‰∏™Áî®‰∫éÊé•Êî∂Êï∞ÊçÆ„ÄÇ</li>
</ul>
<hr>
<h3 id="virtqueue">virtqueue
</h3><p>**vring ÊòØ virtqueue Êú∫Âà∂ÁöÑÂÖ∑‰ΩìÂÆûÁé∞„ÄÇ**vringÂú®ËôöÊãüÊú∫ÂíåQEMU‰πãÈó¥ÂºïÂÖ•‰∏ÄÊÆµÂÖ±‰∫´ÁöÑÁéØÂΩ¢ÁºìÂÜ≤Âå∫‰Ωú‰∏∫ÂâçÂêéÁ´ØÊï∞ÊçÆÈÄö‰ø°ÁöÑËΩΩ‰Ωì„ÄÇÁõ∏ËæÉ‰∫é‰º†ÁªüÁöÑI/OÊñπÂºèÔºåÁéØÂΩ¢ÁºìÂÜ≤Âå∫ÁöÑÂºïÂÖ•‰ΩøÂæóÂèØ‰ª•‰∏ÄÊ¨°Â§ÑÁêÜÂ§ö‰∏™I/OËØ∑Ê±ÇÔºåÊèêÈ´ò‰∫ÜÊØèÊ¨°I/O‰º†ÈÄíÁöÑÊï∞ÊçÆÈáèÔºåÂπ∂‰∏îÊòæËëóÂáèÂ∞ë‰∫Ü‰∏ä‰∏ãÊñáÂàáÊç¢ÁöÑÊ¨°Êï∞„ÄÇ</p>
<blockquote>
<p><em><strong>virtqueue ‰º†ËæìÊú∫Âà∂ÊòØ virtio Ê°ÜÊû∂ËÉΩÂ§üÊèêÂçá I/O ËôöÊãüÂåñÊÄßËÉΩÁöÑÂÖ≥ÈîÆ„ÄÇ</strong></em></p>
</blockquote>
<p>vring‰∏ªË¶ÅÁî±‰∏â‰∏™ÈÉ®ÂàÜÁªÑÊàêÔºöÊèèËø∞Á¨¶Ë°® (descriptor table) „ÄÅÂèØÁî®ÁöÑÊèèËø∞Á¨¶ÁéØ (available ring) ÂíåÂ∑≤Áî®ÊèèËø∞Á¨¶ÁéØ (used ring)„ÄÇ</p>
<h4 id="descriptor-table">descriptor table
</h4><p>ÊèèËø∞Á¨¶Ë°®Áî®‰∫é‰øùÂ≠ò‰∏ÄÁ≥ªÂàóÊèèËø∞Á¨¶ÔºåÊØè‰∏Ä‰∏™ÊèèËø∞Á¨¶ÈÉΩË¢´Áî®Êù•ÊèèËø∞ÂÆ¢Êà∑Êú∫ÂÜÖÁöÑ‰∏ÄÂùóÂÜÖÂ≠òÂå∫Âüü„ÄÇÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂâçÁ´ØÈ©±Âä®Ë¥üË¥£ÁÆ°ÁêÜËøô‰∫õÂÜÖÂ≠òÂå∫ÂüüÁöÑÂàÜÈÖçÂíåÂõûÊî∂„ÄÇÊèèËø∞Á¨¶ÈÄöËøáÂ¶Ç‰∏ãÂ≠óÊÆµÊåáÂÆöÂÜÖÂ≠òÂå∫ÂüüÁöÑÂêÑÈ°πÂ±ûÊÄßÔºö</p>
<ul>
<li><code>addr</code>ÔºöËØ•Â≠óÊÆµË°®Á§∫ÂÜÖÂ≠òÂå∫ÂüüÂú®ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÁ©∫Èó¥‰∏≠ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºõ</li>
<li><code>flag</code>ÔºöËØ•Â≠óÊÆµÁî®Êù•Ê†áËØÜÊèèËø∞Á¨¶Ëá™Ë∫´ÁöÑÁâπÊÄßÔºå‰∏ÄÂÖ±Êúâ‰∏âÁßçÂèØÈÄâÂÄº„ÄÇ
<ul>
<li><code>VRING_DESC_F_WRITE</code>ÔºöË°®Á§∫ÂΩìÂâçÂÜÖÂ≠òÂå∫ÂüüÊòØÂè™ÂÜôÁöÑÔºåÂç≥ËØ•ÂÜÖÂ≠òÂå∫ÂüüÂè™ËÉΩË¢´ÂêéÁ´ØËÆæÂ§áÁî®Êù•ÂêëÂâçÁ´ØÈ©±Âä®‰º†ÈÄíÊï∞ÊçÆÔºõ</li>
<li><code>VRING_DESC_F_NEXT</code>ÔºöË°®ÊòéËØ•ÊèèËø∞Á¨¶ÁöÑnextÂ≠óÊÆµÊòØÂê¶ÊúâÊïàÔºõ</li>
<li><code>VRING_DESC_F_INDIRECT</code>ÔºöË°®ÊòéËØ•ÊèèËø∞Á¨¶ÊòØÂê¶ÊåáÂêë‰∏Ä‰∏™‰∏≠Èó¥ÊèèËø∞Á¨¶Ë°®Ôºõ</li>
</ul>
</li>
<li><code>len</code>ÔºöËØ•Â≠óÊÆµÁöÑÊÑè‰πâÂèñÂÜ≥‰∫éËØ•ÂÜÖÂ≠òÂå∫ÂüüÁöÑËØªÂÜôÂ±ûÊÄß„ÄÇÂ¶ÇÊûúËØ•Âå∫ÂüüÊòØÂè™ÂÜôÁöÑÔºåÊï∞ÊçÆ‰º†ÈÄíÊñπÂêëÂè™ËÉΩ‰ªéÂêéÁ´ØËÆæÂ§áÂà∞ÂâçÁ´ØÈ©±Âä®ÔºåÊ≠§Êó∂ len Ë°®Á§∫ËÆæÂ§áÊúÄÂ§öÂèØ‰ª•ÂêëËØ•ÂÜÖÂ≠òÂùóÂÜôÂÖ•ÁöÑÊï∞ÊçÆÈïøÂ∫¶ÔºõÂèç‰πãÔºåÂ¶ÇÊûúËØ•Âå∫ÂüüÊòØÂè™ËØªÁöÑÔºåÊ≠§Êó∂ len Ë°®Á§∫ÂêéÁ´ØËÆæÂ§áÂøÖÈ°ªËØªÂèñÁöÑÊù•Ëá™ÂâçÁ´ØÈ©±Âä®ÁöÑÊï∞ÊçÆÈáèÔºõ</li>
<li><code>next</code>ÔºöÂú®virtio‰∏≠Ôºå‰∏ÄÊ¨°Ââç„ÄÅÂêéÁ´ØÁöÑÊï∞ÊçÆ‰∫§‰∫íËØ∑Ê±ÇÂæÄÂæÄ‰ºöÂåÖÂê´Â§ö‰∏™I/OËØ∑Ê±ÇÂêàÂπ∂ÔºåËÄå‰∏î‰∏Ä‰∏™I/OÂêàÂπ∂‰πüÂèØËÉΩÊ∂âÂèäÂ§ö‰∏™‰∏çËøûÁª≠ÁöÑÂÜÖÂ≠òÂå∫Âüü„ÄÇÈÄöÂ∏∏ÁöÑÂÅöÊ≥ïÊòØÂ∞ÜÊèèËø∞Á¨¶ÁªÑÁªáÊàêÊèèËø∞Á¨¶ÈìæË°®ÁöÑÂΩ¢ÂºèÊù•Ë°®Á§∫ÊâÄÊúâÁöÑÂÜÖÂ≠òÂå∫Âüü„ÄÇnextÂ≠óÊÆµ‰æøÊòØÁî®Êù•ÊåáÂêë‰∏ã‰∏Ä‰∏™ÊèèËø∞Á¨¶„ÄÇÈÄöËøáflagÂ≠óÊÆµ‰∏≠ÁöÑÂÄºVRING_DESC_F_NEXTÔºåÂ∞±ÂèØ‰ª•Èó¥Êé•Âú∞Á°ÆÂÆöËØ•ÊèèËø∞Á¨¶ÊòØÂê¶‰∏∫ÊèèËø∞Á¨¶ÈìæË°®ÁöÑÊúÄÂêé‰∏Ä‰∏™„ÄÇ</li>
</ul>
<h4 id="available-ring">available ring
</h4><p>ÂèØÁî®ÊèèËø∞Á¨¶ÁéØÊòØ virtqueue ‰∏≠ÁöÑ‰∏ÄÂùóÂå∫ÂüüÔºåÁî®‰∫é**‰øùÂ≠òÂâçÁ´ØÈ©±Âä®Êèê‰æõÁªôÂêéÁ´ØËÆæÂ§á‰∏îÂêéÁ´ØËÆæÂ§áÂèØ‰ª•‰ΩøÁî®ÁöÑÊèèËø∞Á¨¶„ÄÇ**ÂèØÁî®ÊèèËø∞Á¨¶ÁéØÁî±‰∏Ä‰∏™flagsÂ≠óÊÆµ„ÄÅidxÁ¥¢ÂºïÂ≠óÊÆµ‰ª•Âèä‰∏Ä‰∏™‰ª•Êï∞ÁªÑÂΩ¢ÂºèÂÆûÁé∞ÁöÑÁéØring[]ÁªÑÊàê„ÄÇÂÖ∂‰∏≠Ôºö</p>
<ul>
<li>flagsÂ≠óÊÆµÊúâ0Âíå1‰∏§ÁßçÂèñÂÄºÔºå1 Ë°®ÊòéÂêéÁ´ØËÆæÂ§á‰ΩøÁî®ÂÆåÂâçÁ´ØÈ©±Âä®ÂàÜÈÖçÁöÑÊèèËø∞Á¨¶Êó∂Êó†È°ªÂêëËôöÊãüÊú∫ÂèëÈÄÅ‰∏≠Êñ≠Ôºõ</li>
<li>idx Áî®Êù•Á¥¢ÂºïÊï∞ÁªÑ ring ‰∏≠‰∏ã‰∏Ä‰∏™ÂèØÁî®ÁöÑ‰ΩçÁΩÆ„ÄÇÊï∞ÁªÑring‰∏≠Â≠òÊîæÁöÑÊòØÊèèËø∞Á¨¶ÈìæË°®‰∏≠‰Ωú‰∏∫ÈìæË°®Â§¥ÁöÑÊèèËø∞Á¨¶Âú®ÊèèËø∞Á¨¶Ë°®‰∏≠ÁöÑÁ¥¢ÂºïÔºåÊâÄ‰ª•ÂèØ‰ª•ÈÄöËøáÊï∞ÁªÑring‰∏≠ÂÖÉÁ¥†ÁöÑÂÄºÊâæÂà∞ÂØπÂ∫îÊèèËø∞Á¨¶ÈìæË°®„ÄÇÂΩìÂâçÁ´ØÈ©±Âä®‰∏∫ÂêéÁ´ØËÆæÂ§áÁªÑÁªáÂ•Ω‰∏Ä‰∏™ÂèØÁî®ÊèèËø∞Á¨¶ÈìæË°®Êó∂ÔºåÂâçÁ´ØÈ©±Âä®‰ºöÊ†πÊçÆidxÁöÑÂÄºÂ∞ÜËØ•ÂèØÁî®ÊèèËø∞Á¨¶ÈìæË°®Â§¥Âú®ÊèèËø∞Á¨¶Ë°®‰∏≠ÁöÑÁ¥¢ÂºïÂä†ÂÖ•Êï∞ÁªÑringÁöÑÁõ∏Â∫î‰ΩçÁΩÆ„ÄÇ</li>
</ul>
<p>ÊØèÊ¨°ÂêéÁ´ØËÆæÂ§áÂèñÂèØÁî®ÊèèËø∞Á¨¶Êó∂ÔºåÈúÄË¶ÅÁü•ÈÅìÂâ©‰ΩôÂèØÁî®ÊèèËø∞Á¨¶Âú®Êï∞ÁªÑring‰∏≠ÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇÂêéÁ´ØËÆæÂ§á‰ºöÁª¥Êä§‰∏Ä‰∏™ÂèòÈáè <code>last_avail_idx</code>ÔºåÁî®Êù•Ê†áËÆ∞Ëøô‰∏™‰ΩçÁΩÆ„ÄÇÂΩìÂàáÊç¢Âà∞‰∏ªÊú∫‰∏≠Êó∂ÔºåÂêéÁ´ØËÆæÂ§áÂ∞ÜÊ£ÄÊü• <code>last_avail_idx/idx</code> ÁöÑÂÄºÔºåÊï∞ÁªÑring‰∏≠‰Ωç‰∫é <code>last_avail_idx ~ idx-1</code>‰πãÈó¥ÁöÑÈÉ®ÂàÜÂ∞±ÊòØÂèØ‰æõÂêéÁ´ØËÆæÂ§á‰ΩøÁî®ÁöÑÂå∫Âüü„ÄÇ</p>
<h4 id="used-ring">used ring
</h4><p>Â∑≤Áî®ÊèèËø∞Á¨¶ÁéØÁöÑÁªÑÊàêÁªìÊûÑ‰∏éÂèØÁî®ÊèèËø∞Á¨¶ÁéØÁ±ª‰ººÔºåÁî®‰∫é**‰øùÂ≠òÂêéÁ´ØÈ©±Âä®Â∑≤ÁªèÂ§ÑÁêÜËøáÂπ∂‰∏îÂ∞öÊú™ÂèçÈ¶àÁªôÈ©±Âä®ÁöÑÊèèËø∞Á¨¶„ÄÇ**‰∏éÂèØÁî®ÊèèËø∞Á¨¶ÁéØ‰∏çÂêåÁöÑÊòØÔºåÂ∑≤Áî®ÊèèËø∞Á¨¶ÁéØ‰∏≠Êï∞ÁªÑringÁöÑÊØè‰∏™ÂÖÉÁ¥†‰∏ç‰ªÖÂåÖÂê´ÂêéÁ´ØËÆæÂ§áÂ∑≤ÁªèÂ§ÑÁêÜÁöÑÊèèËø∞Á¨¶ÈìæË°®ÁöÑÂ§¥ÈÉ®ÊèèËø∞Á¨¶Âú®ÊèèËø∞Á¨¶Ë°®‰∏≠ÁöÑÁ¥¢ÂºïÔºåËÄå‰∏îÁî±‰∫éÂêéÁ´ØËÆæÂ§áÂèØËÉΩ‰ºöÂêëÂâçÁ´ØÈ©±Âä®ÂÜôÂõûÊï∞ÊçÆÊàñÈúÄË¶ÅÂëäÁü•È©±Âä®ÂÜôÊìç‰ΩúÁöÑÁä∂ÊÄÅÔºåËøòÈúÄË¶ÅÂåÖÊã¨‰∏Ä‰∏™lenÂ≠óÊÆµÊù•ËÆ∞ÂΩïËÆæÂ§áÂÜôÂõûÊï∞ÊçÆÁöÑÈïøÂ∫¶„ÄÇ</p>
<ul>
<li>ÂΩìÂêéÁ´ØËÆæÂ§áÂ§ÑÁêÜÂÆå‰∏Ä‰∏™Êù•Ëá™ÂèØÁî®ÊèèËø∞Á¨¶Êï∞ÁªÑÁöÑÊèèËø∞Á¨¶ÈìæË°®ÂêéÔºåÈúÄË¶ÅÂ∞ÜÈìæË°®Â§¥ÁöÑÊèèËø∞Á¨¶Âú®ÊèèËø∞Á¨¶Ë°®‰∏≠ÁöÑÁ¥¢Âºï‰ª•ÂèäÂÜôÂõûÊï∞ÊçÆÁöÑÈïøÂ∫¶‰∏ÄËµ∑Âä†ÂÖ•Êï∞ÁªÑring‰∏≠„ÄÇidxÂú®ËØ•ËøáÁ®ã‰∏≠ÁöÑ‰ΩúÁî®‰∏éÂú®ÂèØÁî®ÊèèËø∞Á¨¶ÁéØ‰∏≠Áõ∏Âêå„ÄÇ</li>
</ul>
<p>ÂêåÊ†∑ÁöÑÔºåÂΩìËÆæÂ§áÈ©±Âä®ÂõûÊî∂Â∑≤Áî®ÁöÑËÆæÂ§áÊèèËø∞Á¨¶Êó∂ÔºåÈúÄË¶ÅÁü•ÈÅìÂâ©‰ΩôÂ∑≤Áî®Ê†áËØÜÁ¨¶Âú®Êï∞ÁªÑring‰∏≠ÁöÑËµ∑Âßã‰ΩçÁΩÆÔºåÂâçÁ´ØÈ©±Âä®‰ºöÁª¥Êä§‰∏Ä‰∏™ÂèòÈáè <code>last_used_idx</code>ÔºåÁî®Êù•Ê†áËÆ∞Ëøô‰∏™‰ΩçÁΩÆ„ÄÇÂΩìÂàáÊç¢Âà∞ËôöÊãüÊú∫‰∏≠Êó∂ÔºåÂâçÁ´ØÈ©±Âä®Â∞ÜÊ£ÄÊü• <code>last_used_idx/idx</code> ÁöÑÂÄºÔºåÊï∞ÁªÑring‰∏≠‰Ωç‰∫é <code>last_used_idx ~ idx-1</code> ‰πãÈó¥ÁöÑÈÉ®ÂàÜ‰æøÊòØÂèØ‰æõÂâçÁ´ØÈ©±Âä®ÂõûÊî∂ÁöÑÂå∫Âüü„ÄÇ</p>
<h4 id="virtqueueÂàùÂßãÂåñ">virtqueueÂàùÂßãÂåñ
</h4><p>Âú®ÂâçÁ´ØÈ©±Âä®ÂèëËµ∑I/OÊìç‰ΩúÂâçÔºåÈ©±Âä®‰Ωú‰∏∫virtqueueÁöÑÊâÄÊúâËÄÖÈúÄË¶ÅÂàùÂßãÂåñÂ∞ÜË¶ÅÁî®Âà∞ÁöÑvirtqueue„ÄÇ‰∏ãÈù¢ÊòØvirtqueueÂàùÂßãÂåñÁöÑÂÖ∑‰ΩìËøáÁ®ãÔºö</p>
<ol>
<li>Âú®virtioÊ°ÜÊû∂‰∏ãÔºåvirtqueueÁöÑÁõ∏ÂÖ≥ÂèÇÊï∞Ôºà‰æãÂ¶ÇÂú∞ÂùÄÂíåÂ§ßÂ∞èÔºâÈÉΩ‰øùÂ≠òÂú®‰∏äÊñá‰∏≠ÊèêÂà∞ÁöÑvirtio-header‰∏≠„ÄÇvirtio-headerÂ≠òÊîæÂú®virtio-pciËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥Á¨¨‰∏Ä‰∏™BARÊåáÂêëÁöÑI/OÂå∫ÂüüÔºåÊâÄ‰ª•Â∞ÜËØ•Âå∫ÂüüÊò†Â∞ÑËøõÂÜÖÊ†∏ÂèØ‰ª•Ëé∑ÂæóvirtqueueÁõ∏ÂÖ≥Â±ûÊÄßÔºõ</li>
<li>Ê†πÊçÆÂêéÁ´ØËÆæÂ§áÁßçÁ±ª‰∏çÂêåÔºå‰∏Ä‰∏™ÂâçÁ´ØÈ©±Âä®ÂèØËÉΩÊã•ÊúâÂ§ö‰∏™ÈòüÂàó„ÄÇÂèØ‰ª•Â∞ÜvirtqueueÁöÑÁ¥¢ÂºïÂÜôÂÖ•virtio-header‰∏≠ÁöÑQueue SelectÂØÑÂ≠òÂô®Êù•ÈÄöÁü•ËÆæÂ§áÊâÄË¶ÅÂàùÂßãÂåñÁöÑÂÖ∑‰ΩìÈòüÂàóÔºõ</li>
<li>‰∏∫‰∫ÜÁªôvirtqueueÂàÜÈÖçÁ©∫Èó¥ÔºåÈ©±Âä®ËøòÈúÄË¶ÅÁü•ÈÅìvirtqueueÁöÑÂ§ßÂ∞è„ÄÇÂâçÁ´ØÈ©±Âä®ÈÄöËøáËØªvirtio-header‰∏≠ÁöÑQueue SizeÂØÑÂ≠òÂô®ÔºåËé∑ÂæóvirtqueueÂÜÖÊèèËø∞Á¨¶ÁöÑÊï∞ÈáèÔºõ</li>
<li>Ê†πÊçÆÊèèËø∞Á¨¶Êï∞ÈáèËÆ°ÁÆóÂπ∂‰∏∫virtqueueÂàÜÈÖçÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂπ∂Â∞ÜÂÜÖÂ≠òÁ©∫Èó¥ÁöÑËµ∑ÂßãÂú∞ÂùÄÈô§‰ª•4096ÔºåËΩ¨Êç¢Êàê‰ª•È°µ‰∏∫Âçï‰ΩçÁöÑÂú∞ÂùÄÂêéÂÜôÂÖ•virtio-header‰∏≠ÁöÑQueue AddressÂØÑÂ≠òÂô®Ôºõ</li>
<li>ÂêéÁ´ØËÆæÂ§áÊî∂Âà∞ËØ•Âú∞ÂùÄÂêéÔºåÂ∞ÜËØ•Âú∞ÂùÄÂ∑¶Áßª12‰ΩçËé∑ÂæóvirtqueueÁöÑGPAÔºåÊúÄÂêéÂ∞ÜËØ•GPAËΩ¨Êç¢‰∏∫HVA„ÄÇ</li>
</ol>
<h3 id="virtio-net">virtio-net
</h3><p>virtioËÉΩÂ§üÊîØÊåÅÂêÑÁßç‰∏çÂêåÁöÑËÆæÂ§áÔºåÂÖ∂‰∏≠ËôöÊãüÁΩëÂç°ËÆæÂ§áÊòØvirtio‰∏≠ÊØîËæÉÂ§çÊùÇÁöÑËÆæÂ§á„ÄÇÂü∫‰∫évirtioÂÆûÁé∞ÁöÑÁΩëÁªúÊû∂ÊûÑÈÄöÂ∏∏Ë¢´Áß∞‰∏∫ <code>virtio-net</code>„ÄÇ‰∏ãÂõæÊèèËø∞‰∫Ü<code>virtio-net</code> ÁöÑ‰∏ÄÊ¨°ÁΩëÁªúÂåÖÂèëÈÄÅËøáÁ®ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171533411.png" alt="image-20231117134849702" style="zoom:50%;" />
<ol>
<li>ËøêË°åÂú®ÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Á©∫Èó¥ÁöÑ virtio-net È©±Âä®‰ºöÂ∞ÜË¶ÅÂèëÈÄÅÁöÑÊï∞ÊçÆÂåÖÊîæÁΩÆÂú®ËôöÊãüÊú∫ÁöÑÂÜÖÂ≠òÁºìÂÜ≤Âå∫‰∏≠Ôºõ</li>
<li>virtio-net È©±Âä®‰∏∫Êï∞ÊçÆÂåÖÊâÄÂú®ÁöÑÂÜÖÂ≠òÁºìÂÜ≤Âå∫ÂàõÂª∫‰∏ÄÁ≥ªÂàóÊèèËø∞Á¨¶ÔºåÂπ∂ÁªÑÁªáÊàêÊèèËø∞Á¨¶ÈìæÂä†ÂÖ•ÂèØÁî®ÊèèËø∞Á¨¶ÁéØ‰∏≠Ôºõ</li>
<li>virtio-net È©±Âä®‰ª• MMIO ÁöÑÊñπÂºèÂÜôÁâπÂÆöÂú∞ÂùÄÔºåÈÄ†Êàê VM-ExitÔºåÈô∑ÂÖ• KVM ‰∏≠Ôºõ</li>
<li>KVM ÂàÜÊûê VM-Exit ÁöÑÂéüÂõ†ÔºåÂ∞ÜÊéßÂà∂ÊµÅËΩ¨ÂèëÁªô QEMU ‰∏≠ÁöÑ virtio-net ÂêéÁ´ØËÆæÂ§áÔºõ</li>
<li>virtio-net ÂêéÁ´ØËÆæÂ§á‰ªéÂèØÁî®ÊèèËø∞Á¨¶ÁéØ‰∏≠Ëé∑ÂæóÊï∞ÊçÆÂåÖÊâÄÂú®ÁöÑÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄÔºåÁî±‰∫éËôöÊãüÊú∫ÁöÑÂÜÖÂ≠òÁ©∫Èó¥Áî±QEMUÂàÜÈÖçÔºåÊâÄ‰ª•QEMUËÉΩÂ§üÂ∞ÜÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄËΩ¨Êç¢‰∏∫QEMUÂú®‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑËôöÊãüÂú∞ÂùÄÔºõ</li>
<li>virtio-net ÂêéÁ´ØËÆæÂ§áÊ†πÊçÆ‰∏ä‰∏ÄÊ≠•ËΩ¨ÂåñÂæóÂà∞ÁöÑ‰∏ªÊú∫ËôöÊãüÂú∞ÂùÄÂæóÂà∞ÁΩëÁªúÂåÖÊï∞ÊçÆÔºõ</li>
<li>virtio-net ÂêéÁ´ØËÆæÂ§á‰ª•Á≥ªÁªüË∞ÉÁî®ÁöÑÊñπÂºèÂ∞ÜÁΩëÁªúÂåÖÈÄöËøáÂÜÖÊ†∏ÁΩëÁªúÊ†àÂèëÂá∫Ôºå‰πãÂêéÂ∞ÜÊèèËø∞Á¨¶Âä†ÂÖ•Â∑≤Áî®ÊèèËø∞Á¨¶ÁéØ‰∏≠Ôºõ</li>
<li>QEMU‰ª•‰∏≠Êñ≠Ê≥®ÂÖ•ÁöÑÂΩ¢ÂºèÂêëËôöÊãüÊú∫ÂèëÈÄÅI/OÂÆåÊàêÈÄöÁü•ÔºåÂπ∂ÊúÄÁªàÂ∞ÜÊéßÂà∂ÊµÅ‰∫§ËøòÁªôËôöÊãüÊú∫„ÄÇ</li>
</ol>
<h3 id="vhost">vhost
</h3><p>‰∏äÊñá‰∏ªË¶Å‰ªãÁªç‰∫ÜÂêéÁ´ØËÆæÂ§á‰Ωç‰∫éÁî®Êà∑ÊÄÅQEMUËøõÁ®ã‰∏≠ÁöÑÊÉÖÂÜµ„ÄÇÂú®ËØ•Âú∫ÊôØ‰∏ãÔºå‰∏ÄÊ¨°virtioËÆøÈóÆ‰ºöÊ∂âÂèäËôöÊãüÊú∫ÂÜÖÊ†∏‰∏é‰∏ªÊú∫KVMÊ®°Âùó‰πãÈó¥„ÄÅKVMÊ®°Âùó‰∏é‰∏ªÊú∫Áî®Êà∑ÊÄÅQEMUËøõÁ®ã‰πãÈó¥„ÄÅQEMUËøõÁ®ã‰∏é‰∏ªÊú∫ÂÜÖÊ†∏‰∏≠ÁöÑÈ©±Âä®Á®ãÂ∫è‰πãÈó¥ÁöÑÂ§öÊ¨°ÁâπÊùÉÁ∫ßÂàáÊç¢„ÄÇÊØèÊ¨°ÁâπÊùÉÁ∫ßÂàáÊç¢ÈÉΩÈúÄË¶Å‰øùÂ≠ò‰∏ä‰∏ãÊñáÔºåÈÄ†Êàê‰∫ÜÊûÅÂ§ßÁöÑÊÄßËÉΩÊçüÂ§±„ÄÇ</p>
<p>ËøòÊúâ‰∏ÄÁßçÂ∞ÜËÆæÂ§áÊ®°ÂûãÁΩÆ‰∫éHypervisorÁöÑËÆæÂ§áÊ®°ÊãüÊñπÂºèÔºåËØ•ÊñπÂºèÈÅøÂÖç‰∫ÜÁ≥ªÁªüË∞ÉÁî®ÊâÄ‰∫ßÁîüÁöÑÂ§ßÈáè‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÁº©Áü≠‰∫ÜËôöÊãüÊú∫I/OÁöÑÊ®°ÊãüË∑ØÂæÑÔºåÊèêÈ´ò‰∫ÜI/OÁöÑÊÄßËÉΩ„ÄÇvhostÂ∞±ÊòØËØ•ÊñπÂºèÁöÑ‰∏ÄÁßçÂÖ∑‰ΩìÂÆûÁé∞ÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171526711.png" alt="image-20231117152613809" style="zoom:50%;" />
<p>vhostÈááÁî®‰∫Ü‰∏é‰πãÁ±ª‰ººÁöÑÊñπÂºè‰ºòÂåñ‰º†ÁªüÁöÑvirtio„ÄÇvhost APIÊòØ‰∏Ä‰∏™Âü∫‰∫éÊ∂àÊÅØÁöÑÂçèËÆÆÔºåÂÆÉÂÖÅËÆ∏HypervisorÂ∞ÜÊï∞ÊçÆ‰∫§‰∫íÁöÑÂ∑•‰ΩúÂç∏ËΩΩÂà∞ËøêË°åÂú®ÂÆø‰∏ªÊú∫ÂÜÖÊ†∏ÊÄÅÁöÑÂè¶‰∏Ä‰∏™ÁªÑ‰ª∂‚Äî‚Äî <code>handler</code>„ÄÇhandlerËÉΩÂ§üÂ∞ÜÊï∞ÊçÆËΩ¨ÂèëÁöÑ‰ªªÂä°‰ªéQEMUÁöÑËÆæÂ§áÊ®°Âûã‰∏≠Ëß£ËÄ¶„ÄÇ‰ΩøÁî®Ê≠§ÂçèËÆÆÔºåHypervisor (QEMU) ÈúÄË¶ÅÂêëhandlerÂèëÈÄÅHypervisorÁöÑÂÜÖÂ≠òÂ∏ÉÂ±Ä (MemoryLayout) Âíå‰∏ÄÂØπÊñá‰ª∂ÊèèËø∞Á¨¶ <code>ioeventfd/irqfd</code>„ÄÇÂÜÖÂ≠òÂ∏ÉÂ±ÄÁî®‰∫éÂÆö‰Ωç virtqueue ÈòüÂàóÂíåÊï∞ÊçÆÁºìÂ≠òÂú®QEMUÂÜÖÂ≠ò‰∏≠ÁöÑ‰ΩçÁΩÆ„ÄÇÊñá‰ª∂ÊèèËø∞Á¨¶Áî®‰∫éhandlerÂèëÈÄÅÂíåÊé•Êî∂ÈÄöÁü•„ÄÇËøô‰∫õÊñá‰ª∂ÊèèËø∞Á¨¶Âú®handlerÂíåKVM‰πãÈó¥ÂÖ±‰∫´ÔºåÂõ†Ê≠§handlerÂèØ‰ª•ÂíåKVMÁõ¥Êé•ÈÄö‰ø°Ôºå‰∏çÈúÄË¶ÅQEMUÁöÑÂπ≤È¢Ñ„ÄÇ</p>
<p>vhost-netÊòØ‰∏Ä‰∏™ÂÜÖÊ†∏È©±Âä®Á®ãÂ∫èÔºåÊòØ‰∏ÄÁßçvhostÂçèËÆÆÂ§ÑÁêÜÁ®ãÂ∫èÔºåÁî®‰∫éÂÆûÁé∞Êï∞ÊçÆÂåÖÁöÑÂø´ÈÄüËΩ¨ÂèëÔºö</p>
<ul>
<li>Âä†ËΩΩvhost-netÂÜÖÊ†∏È©±Âä®Á®ãÂ∫èÊó∂Ôºå‰ºöÂú® <code>/dev/vhost-net</code> ‰∏äÂÖ¨ÂºÄ‰∏Ä‰∏™Â≠óÁ¨¶ËÆæÂ§á„ÄÇÂΩìQEMUÂú®vhost-netÁöÑÊîØÊåÅ‰∏ãÂêØÂä®Êó∂ÔºåQEMU‰ºö‰ΩøÁî®Âá†‰∏™ioctlË∞ÉÁî®Êù•ÂàùÂßãÂåñvhost-netÔºõ</li>
<li>Âú®ÂàùÂßãÂåñËøáÁ®ã‰∏≠ÔºåQEMUËøõÁ®ã‰ºö‰∏évhost-netÁõ∏ÂÖ≥ËÅîÔºåÂπ∂Â∞Üvirtio feature„ÄÅÁî®‰∫éÂèëÈÄÅÂíåÊé•Êî∂ÈÄöÁü•ÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÅÁâ©ÁêÜÂÜÖÂ≠òÊò†Â∞Ñ‰º†ÈÄíÁªôvhost-net„ÄÇvhost-netÂÜÖÊ†∏È©±Âä®Á®ãÂ∫è‰ºö‰∏∫ÂÆ¢Êà∑Êú∫ÂàõÂª∫ÂØπÂ∫îÂÜÖÊ†∏Á∫øÁ®ã„ÄÇËøô‰∏™Á∫øÁ®ãÁß∞‰∏∫ ‚ÄúvhostÂ∑•‰ΩúÁ∫øÁ®ã‚Äù „ÄÇ</li>
</ul>
<p>QEMUÂàÜÈÖçÊñá‰ª∂ÊèèËø∞Á¨¶ <code>ioeventfd</code> Âπ∂Â∞ÜÂÖ∂Ê≥®ÂÜåÂà∞vhostÂíåKVMÔºåËØ•Êñá‰ª∂ÊèèËø∞Á¨¶Ë¥üË¥£‰º†ÈÄíI/O‰∫ã‰ª∂ÈÄöÁü•„ÄÇÂΩìËôöÊãüÊú∫ËÆøÈóÆÁâπÂÆöÁ´ØÂè£Êó∂ÔºåKVMÂêë<code>ioeventfd</code> ÂÜôÂÖ•‰∏éËØ•ËÆøÈóÆÁõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÔºåÂêåÊó∂vhostÂÜÖÊ†∏Á∫øÁ®ã‰ºö‰∏çÊñ≠ËΩÆËØ¢ <code>ioeventfd</code> Âπ∂Á´ãÂç≥Ëé∑ÂæóÈÄöÁü•„ÄÇÂõ†Ê≠§ÂØπÁâπÂÆöÂÆ¢Êà∑Êú∫ÂÜÖÂ≠òÂú∞ÂùÄÔºà‰æãÂ¶ÇMMIOÂÜÖÂ≠òÂå∫ÂüüÔºâÁöÑËØª/ÂÜôÊìç‰Ωú‰∏çÈúÄË¶ÅÂàáÊç¢Âà∞QEMU‰∏≠ÔºåÂèØ‰ª•Áõ¥Êé•Ë∑ØÁî±Âà∞ vhost Â∑•‰ΩúÁ∫øÁ®ãÔºåËøôÊ†∑Â∞±ÂÆûÁé∞‰∫ÜÂºÇÊ≠•Â§ÑÁêÜÔºå‰∏çÈúÄË¶ÅÁªàÊ≠¢vCPUÁöÑÊâßË°åÔºåÈÅøÂÖç‰∫Ü‰∏ä‰∏ãÊñáÂàáÊç¢ÁöÑÂºÄÈîÄ„ÄÇ</p>
<p>Âè¶Â§ñÔºåQEMUÂàÜÈÖçÂè¶‰∏Ä‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶ <code>irqfd</code> Âπ∂ÂÜçÊ¨°Â∞ÜÂÖ∂Ê≥®ÂÜåÂà∞KVMÂíåvhost‰∏äÔºåËØ•Êñá‰ª∂ÊèèËø∞Á¨¶Ë¥üË¥£‰º†ÈÄívCPU‰∏≠Êñ≠Ê∂àÊÅØ„ÄÇvhostÂ∑•‰ΩúÁ∫øÁ®ãÂÆåÊàêÊï∞ÊçÆÂåÖËØªÂÜô‰πãÂêéÔºå‰ºöÂØπ <code>irqfd</code> ËøõË°åÂÜôÊìç‰ΩúÔºå‰πãÂêéKVM‰ªé <code>irqfd</code> ‰∏≠ËØªÂèñ‰∏évCPUÁõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØÔºåÊúÄÂêéÂ∞ÜvCPU‰∏≠Êñ≠Ê≥®ÂÖ•ÂÆ¢Êà∑Êú∫„ÄÇËØ•ËøáÁ®ã‰πüÊòØÂºÇÊ≠•ÁöÑÔºåËøôÁßçÂºÇÊ≠•ÈÄöÁü•Êú∫Âà∂‰ΩøÂæóÂú®Êï∞ÊçÆÂ§ÑÁêÜËøáÁ®ã‰∏≠ÔºåvCPUÂèØ‰ª•ÁªßÁª≠ËøêË°åÔºåÊòæËëóÂáèÂ∞ë‰∫ÜÊÄßËÉΩÊçüÂ§±„ÄÇ<strong>vhostÁöÑÂºïÂÖ•ÊîπÂèò‰∫ÜÂèëÁîüVM-Exit‰πãÂêéKVMÂíåQEMUÁöÑÂ∑•‰ΩúÊµÅÁ®ãÔºå‰ΩÜÂπ∂‰∏çÂΩ±ÂìçÂâçÁ´ØÈ©±Âä®ÁöÑÂõ∫ÊúâËÆæËÆ°ÔºåvhostÂØπÂâçÁ´ØÈ©±Âä®Êù•ËØ¥ÊòØÈÄèÊòéÁöÑ„ÄÇ</strong></p>
<h4 id="vhost-user-todo">vhost-user //TODO
</h4><p>‰∏äÊñáÁöÑvhost-netÊñπÊ°àÊØîËæÉÈÄÇÂêàÂÆ¢Êà∑Êú∫‰∏é‰∏ªÊú∫ÁΩëÁªúÊéßÂà∂Âô®‰πãÈó¥ÁöÑÈÄö‰ø°ÊàñËÄÖÂÆ¢Êà∑Êú∫‰∏éÂ§ñËÆæ‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂÆ¢Êà∑Êú∫‰∏éÂêéÁ´ØËÆæÂ§áÁöÑÈÄö‰ø°Âè™ÂèëÁîü‰∏ÄÊ¨°Êï∞ÊçÆÂ§çÂà∂‰∏éÁî®Êà∑ÊÄÅÂàáÊç¢„ÄÇ‰ΩÜÊòØvhost-netÂπ∂‰∏çÈÄÇÁî®‰∫éÂÆ¢Êà∑Êú∫‰∏é‰∏ªÊú∫‰∏äÁöÑÊüê‰∫õÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∫§‰∫í„ÄÇÂõ†‰∏∫Â¶ÇÊûú‰ΩøÁî®vhost-netÊñπÊ°àÔºåÂÆ¢Êà∑Êú∫ÂíåKVMÊ®°Âùó‰πãÈó¥„ÄÅÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏éÂêéÁ´ØËÆæÂ§á‰πãÈó¥ÈÉΩ‰ºö‰∫ßÁîü‰∏ä‰∏ãÊñáÂàáÊç¢‰ª•ÂèäÊï∞ÊçÆÂ§çÂà∂„ÄÇÁî±‰∫éÂÆ¢Êà∑Êú∫ÂíåÁî®Êà∑ÊÄÅÁ®ãÂ∫èÈÉΩ‰Ωç‰∫éÁî®Êà∑ÊÄÅÔºåÊï∞ÊçÆÂèØ‰ª•Áõ¥Êé•Âú®Áî®Êà∑ÊÄÅËøõË°å‰º†ÈÄíÔºåÊó†È°ªÁªèËøá‚ÄúÁî®Êà∑ÊÄÅ‚Äî‚ÄîÂÜÖÊ†∏ÊÄÅ‚Äî‚ÄîÁî®Êà∑ÊÄÅ‚ÄùËøô‰∏§Ê¨°Â§çÂà∂ËøáÁ®ã„ÄÇ</p>
<p>‰∏ÄÁßçÂ∞Üvhost‰ªéÂÜÖÊ†∏ÊÄÅËøÅÁßªÂà∞Áî®Êà∑ÊÄÅÁöÑvhost-userÊñπÊ°àÂ∫îËøêËÄåÁîü„ÄÇvhost-user‰ΩøÁî®‰∫ÜÂíåvhost-net‰∏ÄÊ†∑ÁöÑvhostÂçèËÆÆÔºåÂç≥ÈÉΩ‰ΩøÁî®‰∫ÜvringÂÆåÊàêÂâçÂêéÁ´ØÊï∞ÊçÆ‰∫§‰∫íÔºåËÄå‰∏îËøò‰ΩøÁî®‰∫ÜÁõ∏ÂêåÁöÑ‰∫ã‰ª∂ÈÄöÁü•Êú∫Âà∂„ÄÇ‰∏çÂêåÁöÑÊòØÔºåvhostÂ∞ÜÂêéÁ´ØÂÆûÁé∞Âú®ÂÜÖÊ†∏ÊÄÅËÄåvhost-userÂÆûÁé∞Âú®Áî®Êà∑Á©∫Èó¥‰∏≠ÔºåÁî®‰∫éÁî®Êà∑Á©∫Èó¥‰∏≠‰∏§‰∏™ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇËÄå‰∏î‰∫ã‰ª∂ÈÄöÁü•ÂíåÊï∞ÊçÆ‰∫§‰∫íÁöÑÂÖ∑‰ΩìÂÆûÁé∞ÊñπÂºè‰∏§ËÄÖ‰πüÊúâÊâÄ‰∏çÂêå„ÄÇvhost-userÂü∫‰∫éÂÆ¢Êà∑/ÊúçÂä°ÁöÑÊ®°ÂºèÔºåÈááÁî®UNIXÂüüÂ•óÊé•Â≠ó(UNIX domain socket)Êù•Âª∫Á´ãQEMUËøõÁ®ã‰∏évhost-user‰πãÈó¥ÁöÑËÅîÁ≥ªÔºåËøõËÄåÂ∞Üvirtio feature„ÄÅÁî®‰∫éÂèëÈÄÅÂíåÊé•Êî∂ÈÄöÁü•ÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÅÁâ©ÁêÜÂÜÖÂ≠òÊò†Â∞Ñ‰º†ÈÄíÁªôvhost-userÔºåËÄåvhost-net‰∏≠‰ΩøÁî®ÁöÑÊòØioctlÁöÑÊñπÂºè„ÄÇvhost-userÈááÁî®Â•óÊé•Â≠óÁöÑÊñπÂºèÂ§ßÂ§ßÁÆÄÂåñ‰∫ÜÊìç‰Ωú„ÄÇvhost-userÂü∫‰∫évringËøôÂ•óÈÄöÁî®ÁöÑÂÖ±‰∫´ÂÜÖÂ≠òÈÄö‰ø°ÊñπÊ°àÔºåÂè™Ë¶ÅÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Á´ØÊåâÁÖßvringÊèê‰æõÁöÑÊé•Âè£ÂÆûÁé∞ÊâÄÈúÄÂäüËÉΩÂç≥ÂèØ„ÄÇÂ∏∏ËßÅÁöÑÂÆûÁé∞ÊñπÊ°àÊòØÂ∞ÜÂÆ¢Êà∑Á´ØÈõÜÊàêÂú®ÂÆ¢Êà∑Êú∫ÁöÑvirtioÈ©±Âä®‰∏äÔºåÊúçÂä°Á´ØÂÆûÁé∞Âú®DPDKÔºàData Plane Development KitÔºåÊï∞ÊçÆÂπ≥Èù¢ÂºÄÂèëÂ•ó‰ª∂Ôºâ[ÊèíÂõæ]Á≠âÁî®‰∫éÁΩëÁªúÂä†ÈÄüÁöÑÁî®Êà∑ÊÄÅÂ∫îÁî®‰∏≠</p>
<p>Âõæ4-12Â±ïÁ§∫‰∫Üvhost-user/virtio-net-pmdÊû∂ÊûÑ‰∏ã‰∏ÄÊ¨°ÁΩëÁªúÂåÖÁöÑÂèëÈÄÅËøáÁ®ãÔºåÂÖ∑‰ΩìËøáÁ®ãÂ¶Ç‰∏ã„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171532248.png" style="zoom:50%;" />
<p>(1)ËôöÊãüÊú∫‰∏≠‰∏éDPDKÂ∫ìÈìæÊé•ÁöÑÂ∫îÁî®Á®ãÂ∫èÈÄöËøáÁî®Êà∑ÊÄÅvirtio-pmdÈ©±Âä®ÂèëÈÄÅÊï∞ÊçÆÂåÖ„ÄÇÈ¶ñÂÖàÂ∞ÜÊï∞ÊçÆÂåÖÂÜôÂÖ•ÁºìÂÜ≤Âå∫ÔºåÂπ∂Âú®ÂèØÁî®ÁöÑÊèèËø∞Á¨¶ÁéØ‰∏≠Ê∑ªÂä†ÂÆÉ‰ª¨ÂØπÂ∫îÁöÑÊèèËø∞Á¨¶„ÄÇ(2)‰∏ªÊú∫‰∏≠ÁöÑvhost-user PMDÔºàPoll Mode DriverÔºåËΩÆËØ¢Ê®°ÂºèÈ©±Âä®Ôºâ‰ºö‰∏çÊñ≠ËΩÆËØ¢virtqueueÔºåÂõ†Ê≠§ÂÆÉ‰ºöÁ´ãÂç≥Ê£ÄÊµãÂà∞Êñ∞ÁöÑÊèèËø∞Á¨¶ÔºåÂπ∂ËøõË°åÂ§ÑÁêÜ„ÄÇ(3)ÂØπ‰∫éÊØè‰∏™ÊèèËø∞Á¨¶Ôºåvhost-user PMDÈÄöËøáÊü•ËØ¢ËÆæÂ§áTLBËé∑ÂæóÁºìÂÜ≤Âå∫ÁöÑHVA„ÄÇÂ¶ÇÊûúÂèëÁîüTLBÊú™ÂëΩ‰∏≠ÔºåÂ∞ÜÂèëÈÄÅ‰∏Ä‰∏™ÂØπQEMUÁöÑËØ∑Ê±ÇÊõ¥Êñ∞ËÆæÂ§áTLB„ÄÇËøôÁßçÊÉÖÂÜµÂπ∂‰∏çÂ§öËßÅÔºåÂõ†‰∏∫DPDK‰ΩøÁî®‰∫ÜÂ§ßÈ°µÊú∫Âà∂ÔºåTLBÊú™ÂëΩ‰∏≠ÁöÑÊ¶ÇÁéáÂæà‰Ωé„ÄÇ(4)vhost-user PMDÂ∞ÜÁºìÂÜ≤Âå∫ÁöÑÊï∞ÊçÆÂ§çÂà∂Âà∞mbufÔºàDPDKÂ∫îÁî®Á®ãÂ∫è‰ΩøÁî®ÁöÑÊ∂àÊÅØÁºìÂÜ≤Âå∫Ôºâ„ÄÇÁºìÂÜ≤Âå∫ÊèèËø∞Á¨¶Ë¢´vhost-userÊ∑ªÂä†Âà∞usedÊèèËø∞Á¨¶ÁéØ‰∏≠„ÄÇËøôÊó∂ËôöÊãüÊú∫‰∏≠ÂêåÊ†∑‰∏ÄÁõ¥Âú®ËΩÆËØ¢virtqueueÁöÑvirtio-net-pmdÈ©±Âä®‰ºöÁ´ãÂç≥ÂõûÊî∂usedÊèèËø∞Á¨¶„ÄÇ(5)ÊúÄÂêé‰∏ªÊú∫‰∏≠ÁöÑDPDK APPÔºàÂ∫îÁî®Á®ãÂ∫èÔºâÂ§ÑÁêÜmbuf„ÄÇDPDKÁªïËøáLinuxÂÜÖÊ†∏ÁΩëÁªúÊ†àÔºåÁõ¥Êé•Â∞ÜÊï∞ÊçÆÂåÖÂèëÈÄÅÂà∞NICÔºàNetwork Interface ControllerÔºåÁΩëÁªúÊé•Âè£ÊéßÂà∂Âô®Ôºâ‰∏≠ÔºåÂÆûÁé∞Êï∞ÊçÆÂåÖÁöÑÂø´ÈÄüËΩ¨Âèë„ÄÇ</p>
<p>ÂÆπÂô®‰Ωú‰∏∫‰∏ÄÁßçËøõÁ®ãÁ∫ßÂà´ÁöÑËôöÊãüÂåñÊäÄÊúØÂú®NFVÔºàNetwork Functions VirtualizationÔºåÁΩëÁªúÂäüËÉΩËôöÊãüÂåñÔºâÈ¢ÜÂüüÂÖ∑ÊúâÂæàÂ§ßÁöÑÂ∫îÁî®ÊΩúÂäõ„ÄÇÂÆπÂô®ÈÄöÂ∏∏‰ΩøÁî®ÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÁöÑÁΩëÁªúÊ†àÊù•ÂÆûÁé∞ÁΩëÁªúÊï∞ÊçÆÂåÖËΩ¨Âèë„ÄÇÁÑ∂ËÄåÂá∫‰∫é‰∏≠Êñ≠Â§ÑÁêÜ„ÄÅÁΩëÁªúÂåÖÂ§çÂà∂Á≠âÂéüÂõ†ÔºåÂÜÖÊ†∏ÁΩëÁªúÊ†àÊØèÁßíÊúÄÂ§öÂè™ËÉΩÁéØÂõû1Áôæ‰∏á~2Áôæ‰∏á‰∏™Êï∞ÊçÆÂåÖÔºåÂπ∂‰∏çËÉΩÊª°Ë∂≥NFVÂú®ÂêûÂêêÈáè„ÄÅÂª∂ËøüÂíåÊÄßËÉΩÊäñÂä®Á≠âÊñπÈù¢ÁöÑË¶ÅÊ±Ç„ÄÇ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢òÔºåÁªïËøáLinuxÁΩëÁªúÊ†àÔºåÊèêÂçáÂÆπÂô®‰∏≠ÁöÑÁΩëÁªúÊÄßËÉΩÔºåIntelÂú®2017Âπ¥Â∞ÜvhostÂçèËÆÆÁßªÊ§çÂà∞‰∫ÜÂÆπÂô®[ÊèíÂõæ]ÔºåÊèêÂá∫‰∫ÜÂ¶ÇÂõæ4-13ÊâÄÁ§∫ÁöÑvirtio-userËß£ÂÜ≥ÊñπÊ°à„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171536228.png" alt="image-20231117153553755" style="zoom:50%;" />
<p>virtio-userÊñπÊ°àÂú®DPDKÊ°ÜÊû∂‰∏≠Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÂûãÁöÑËôöÊãüËÆæÂ§ávirtio-userÔºåËØ•ËÆæÂ§áÊúâ‰∏§Áßç‰∏çÂêåÁ±ªÂûãÁöÑÁΩëÁªúÊé•Âè£„ÄÇvhost-kernelÊé•Âè£Áî®‰∫éËøûÊé•‰∏ªÊú∫ÂÜÖÊ†∏‰∏≠ÁöÑvhost-netÊ®°Âùó„ÄÇvhost-userÊé•Âè£ÈÅµÂæ™‰∏äÊñáÊèêÂà∞ÁöÑvhost-userËßÑËåÉÔºå‰∏éËøêË°åÂú®Áî®Êà∑Á©∫Èó¥ÁöÑËôöÊãüÊú∫‰∫§Êç¢Êú∫ËøûÊé•ÔºåÂπ∂ÈÄöËøáËôöÊãüÊú∫‰∫§Êç¢Êú∫Áõ¥Êé•‰∏éÁΩëÂç°‰∫§‰∫í„ÄÇ‰∏éQEMU/KVM‰∏çÂêåÁöÑÊòØÔºåQEMUÂ∞ÜÊï¥‰∏™ÂÜÖÂ≠òÁ©∫Èó¥Â∏ÉÂ±Ä‰∏évhostÂêéÁ´ØÂÖ±‰∫´Ôºåvhost-userÂè™‰∏évhostÂêéÁ´ØÂÖ±‰∫´ÂÆπÂô®ÂÜÖÂ≠òÁ©∫Èó¥‰∏≠Áî±DPDKÂ∫îÁî®Á®ãÂ∫èÁÆ°ÁêÜÁöÑÂå∫Âüü„ÄÇ</p>
<h2 id="24-ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ">2.4 ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ
</h2><p>ÂâçÊñáÊõæÊèêÂà∞ÔºåI/OËôöÊãüÂåñÁöÑ‰∏Ä‰∏™ÊúÄÂü∫Êú¨Ë¶ÅÊ±ÇÊòØËÉΩÂ§ü**ÈôêÂà∂ÂíåÈöîÁ¶ªËôöÊãüÊú∫ËÆøÈóÆ‰∏çÂ±û‰∫éËá™Ë∫´ÁöÑI/OËÆæÂ§á„ÄÇ**Âú®ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆ‰∏≠‰∏∫‰∫ÜÊª°Ë∂≥Ëøô‰∏ÄË¶ÅÊ±ÇÔºåHypervisorÈúÄË¶ÅÂÅöÂà∞Ôºö</p>
<ul>
<li>Â∞ÜÂ§ñËÆæÂàÜÈÖçÁªô‰∏çÂêåÁöÑËôöÊãüÊú∫ÔºåËøô‰∫õËÆæÂ§áÁß∞‰∏∫ËØ•ËôöÊãüÊú∫ÁöÑÊåáÂÆöËÆæÂ§áÔºåËôöÊãüÊú∫‰∏≠ÁöÑvCPUÊó†Ê≥ïËÆøÈóÆÂà∞ÂÖ∂‰ªñËôöÊãüÊú∫ÁöÑËÆæÂ§áÔºõ</li>
<li>ÊåáÂÆöËÆæÂ§áÁöÑÈ©±Âä®Á®ãÂ∫èÂè™Âú®Êã•ÊúâËØ•ËÆæÂ§áÁöÑËôöÊãüÊú∫‰∏≠ËøêË°åÔºåÂπ∂‰∏îËÉΩÂú®‰∏çÂèëÁîüÊàñÂèëÁîüÂ∞ëÈáèVM-ExitÊÉÖÂÜµ‰∏ãÁõ¥Êé•‰∏éËÆæÂ§áÁ°¨‰ª∂‰∫§‰∫íÔºõ</li>
<li>ÂêåÊó∂Ôºå‰∏Ä‰∏™ËôöÊãüÊú∫ÁöÑÊåáÂÆöËÆæÂ§áÂè™ËÉΩËÆøÈóÆÂ±û‰∫éËØ•ËôöÊãüÊú∫ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåËÄå‰∏îÂøÖÈ°ªÂ∞Ü‰∏≠Êñ≠ÂèëÈÄÅÁªôËôöÊãüÊú∫ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®Ôºõ</li>
</ul>
<p>ÂâçÊñáÊèêÂà∞ËøáÔºåCPUÈÄöËøáPCIÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑBARËé∑ÂèñI/OÁ©∫Èó¥Âú∞ÂùÄÊàñÁâ©ÁêÜÂú∞ÂùÄÊù•ËÆøÈóÆÂ§ñËÆæÊèê‰æõÁöÑI/OËµÑÊ∫ê„ÄÇ‰∏ÄËà¨ÊÉÖÂÜµ‰∏ãÔºåÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÈ©±Âä®Á®ãÂ∫è‰ΩøÁî®ÁöÑÂè™ÊòØËôöÊãüÁöÑÂ§ñËÆæI/OÂú∞ÂùÄÊàñÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºàGPAÔºâÔºåÂ¶ÇÊûúÁõ¥Êé•‰ΩøÁî®ËØ•Âú∞ÂùÄËÆøÈóÆËÆæÂ§á‰ºö‰∫ßÁîü‰∏ÄÁ≥ªÂàóÈóÆÈ¢ò„ÄÇ</p>
<p>‰æãÂ¶ÇÔºåÂΩì‰∏Ä‰∏™ËôöÊãüÊú∫‰∏≠ÁöÑÁâ©ÁêÜÈ©±Âä®Á®ãÂ∫è‰∏∫I/OËÆæÂ§áÊåáÂÆö‰∏ÄÂùóÁî®‰∫éDMAÊìç‰ΩúÁöÑÂÜÖÂ≠òÂå∫ÂüüÊó∂ÔºåÈ©±Âä®‰ΩøÁî®ÁöÑDMAÂú∞ÂùÄÂπ∂‰∏çÊòØÂÆûÈôÖÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÔºåÂ¶ÇÊûúËÆæÂ§áÁõ¥Êé•‰ΩøÁî®ËØ•Âú∞ÂùÄÂèØËÉΩ‰ºöËÆøÈóÆÂà∞Â±û‰∫éÂÖ∂‰ªñËôöÊãüÊú∫ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåÁîöËá≥ÊòØHypervisorÊâÄÂú®ÂÜÖÂ≠òÂå∫ÂüüÔºåÁªôÊï¥‰∏™Á≥ªÁªüÂ∏¶Êù•È£éÈô©„ÄÇËÆæÂ§áÊ®°ÊãüÂíåÂçäËôöÊãüÂåñÁ≠âËΩØ‰ª∂ÊñπÊ°àÂèØ‰ª•ÈÄöËøáÊâßË°åÂØπÂ∫îÁöÑI/OÂ§ÑÁêÜÂáΩÊï∞ÔºåÂ∞ÜËôöÊãüÊú∫‰∏≠È©±Âä®Á®ãÂ∫è‰ΩøÁî®ÁöÑÂú∞ÂùÄËΩ¨Êç¢‰∏∫ÂÆûÈôÖÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÂπ∂ËÉΩÂ§üÂØπÂú∞ÂùÄÁöÑÂêàÊ≥ïÊÄßËøõË°åÊ£ÄÊü•„ÄÇËÄåÂú®ËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆÊñπÊ°à‰∏≠ÔºåHypervisorÂπ∂‰∏ç‰ºöÂèÇ‰∏éI/OÊìç‰ΩúÁöÑÊ®°ÊãüÔºå‰πüÂ∞±Êó†Ê≥ïÂ∏ÆÂä©ËôöÊãüÊú∫ÂÆåÊàêÂú∞ÂùÄËΩ¨Êç¢ËøáÁ®ãÔºå<strong>ËøôÂ∞±ÁªôËôöÊãüÊú∫Áõ¥Êé•ËÆøÈóÆÁâ©ÁêÜI/OËÆæÂ§áÂ∏¶Êù•‰∫Ü‰∏â‰∏™ÈóÆÈ¢òÔºö</strong></p>
<ol>
<li><strong>Á¨¨‰∏Ä‰∏™ÈóÆÈ¢ò</strong>ÊòØÂ¶Ç‰Ωï‰øùËØÅËôöÊãüÊú∫ÁöÑÂéüÁîüÈ©±Âä®ËÉΩÂ§üÁõ¥Êé•ÈÄöËøáÁúüÂÆûÁöÑI/OÂú∞ÂùÄÁ©∫Èó¥Êù•Êìç‰ΩúI/OËÆæÂ§áÔºü</li>
<li><strong>Á¨¨‰∫å‰∏™ÈóÆÈ¢ò</strong>ÊòØÂú®DMAËøáÁ®ã‰∏≠ÔºåÂ¶Ç‰ΩïÊéßÂà∂Â§ñËÆæËÆøÈóÆÂà∞ËôöÊãüÊú∫ÊâÄÂú®ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÔºü</li>
<li><strong>Á¨¨‰∏â‰∏™ÈóÆÈ¢ò</strong>ÊòØÂ¶Ç‰ΩïÂ∞ÜËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠ÂèëÈÄÅÂà∞ËôöÊãüÊú∫ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®‰∏≠Ôºü</li>
</ol>
<p>ÂÖ∂‰∏≠Á¨¨‰∏â‰∏™ÈóÆÈ¢òÁïôÂú®‰∏≠Êñ≠ËôöÊãüÂåñÊñáÊ°£‰∏≠ÂÖ∑‰ΩìÂàÜÊûêÔºåÊú¨ÊñáÂ∞Ü‰ªé<strong>PIO„ÄÅMMIO„ÄÅDMA</strong>‰∏â‰∏™ÊñπÈù¢ÂõûÁ≠îÂâç‰∏§‰∏™ÈóÆÈ¢ò„ÄÇ</p>
<blockquote>
<p><em><strong>PIO</strong></em></p>
</blockquote>
<p>Âú®ÂÜÖÂ≠òËôöÊãüÂåñ‰∏≠ÔºåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÁöÑÈ°µË°®‰∏≠Â≠òÊîæÁöÑÊòØËôöÊãüÊú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄ (GPA)ÔºåÈúÄË¶ÅÈÄöËøá‰∏ÄÂÆöÊñπÂºèÔºà‰æãÂ¶ÇÂΩ±Â≠êÈ°µË°®„ÄÅEPTÁ≠âÔºâÂ∞ÜËôöÊãüÊú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄËΩ¨Êç¢‰∏∫‰∏ªÊú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄ (HPA)Ôºå‰ªéËÄåÂÆûÁé∞ÂêÑËôöÊãüÊú∫‰πãÈó¥ÂÜÖÂ≠òÁöÑÈöîÁ¶ª„ÄÇËÆæÂ§áÁõ¥ÈÄöËÆøÈóÆÂêåÊ†∑‰πüÈúÄË¶ÅÂª∫Á´ãËôöÊãüÊú∫I/OÂú∞ÂùÄÁ©∫Èó¥‰∏éÂÆûÈôÖÂ§ñËÆæI/OÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊò†Â∞Ñ„ÄÇ</p>
<p>Âú®CPUÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñ‰∏≠VMCS‰∏≠Â≠òÂú®I/O‰ΩçÂõæËøô‰∏ÄÊ¶ÇÂøµÔºåI/O‰ΩçÂõæÁöÑ‰∏Ä‰∏™‰ΩúÁî®ÊòØÂÜ≥ÂÆöËôöÊãüÊú∫ÊòØÂê¶ÂèØ‰ª•Áõ¥Êé•ËÆøÈóÆÊüê‰∏™Á´ØÂè£Ôºå‰ΩøÂæóHypervisorËÉΩÂ§üÁªÜÁ≤íÂ∫¶Âú∞ÁÆ°ÊéßI/O„ÄÇÂú®VM-ExcutionÊéßÂà∂ÂüüÂÜÖÊúâ‰∏Ä‰∏™I/O‰ΩçÂõæÂú∞ÂùÄÂ≠óÊÆµ (I/O bitmap Addresses)„ÄÇËØ•Â≠óÊÆµÂåÖÊã¨‰∏§‰∏™64‰ΩçÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåËøô‰∏§‰∏™Âú∞ÂùÄÂàÜÂà´ÊåáÂêë‰∏§‰∏™Â§ßÂ∞è‰∏∫4KBÁöÑI/O‰ΩçÂõæ„ÄÇ</p>
<p>I/O‰ΩçÂõæ‰∏≠ÁöÑÊØè‰∏™‰ΩçÂØπÂ∫î‰∏Ä‰∏™I/OÁ´ØÂè£„ÄÇÂΩìHypervisorÂ∞ÜVM-ExcutionÊéßÂà∂Âüü‰∏≠ÁöÑÂêØÁî®I/O‰ΩçÂõæ (Use I/O bitmaps) Â≠óÊÆµÁΩÆ1Êó∂ÔºåÊÑèÂë≥ÁùÄHypervisor‰ºö‰ΩøÁî®I/O‰ΩçÂõæÊéßÂà∂ËôöÊãüÊú∫‰∏≠ÁöÑI/OÊåá‰ª§„ÄÇ<strong>ÂΩìÂÆ¢Êà∑Êú∫ÂèëËµ∑ÂØπÊüê‰∏™Áâ©ÁêÜÁ´ØÂè£ÁöÑI/OÊìç‰ΩúÊó∂ÔºåÂ¶ÇÊûúËØ•Á´ØÂè£Âú®I/O‰ΩçÂõæ‰∏≠ÂØπÂ∫îÁöÑ‰ΩçÂÄº‰∏∫0ÔºåÊ≠§Êó∂‰∏ç‰ºöÂèëÁîüVM-ExitÔºåÂÆ¢Êà∑Êú∫‰ºöÁõ¥Êé•ËÆøÈóÆËØ•Áâ©ÁêÜÁ´ØÂè£„ÄÇ</strong></p>
<p>ÁõÆÂâçÂæàÂ§öHypervisorÔºà‰æãÂ¶ÇXen„ÄÅXvisorÁ≠âÔºâÈÉΩÊîØÊåÅÂ§öÁßçI/OËôöÊãüÂåñÊñπÂºè„ÄÇÊ†πÊçÆÂ∫îÁî®Âú∫ÊôØÁöÑÈúÄË¶ÅÔºåËôöÊãüÊú∫Êã•ÊúâÁöÑI/OËÆæÂ§áÔºåÂÖ∂‰∏≠ÈÉ®ÂàÜÊòØËÆæÂ§áÊ®°ÊãüÊäÄÊúØÊèê‰æõÁöÑËôöÊãüËÆæÂ§áÔºåÂè¶‰∏ÄÈÉ®ÂàÜÂàôÊòØHypervisorÁõ¥Êé•ÂàÜÈÖçÁöÑÁâ©ÁêÜËÆæÂ§á„ÄÇÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåËôöÊãüËÆæÂ§áÁöÑPCI BARÁî±ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑËôöÊãüBIOSÈÖçÁΩÆÔºåÂèØËÉΩ‰ºö‰∏éÁõ¥Êé•ÂàÜÈÖçÁöÑÁâ©ÁêÜËÆæÂ§áÁöÑPCI BAR‰∫ßÁîüÂÜ≤Á™ÅÔºåÊâÄ‰ª•‰∏çËÉΩÁõ¥Êé•‰ΩøÁî®‰∏äÊñá‰ªãÁªçÁöÑÁõ¥Êé•ËÆøÈóÆÁâ©ÁêÜÁ´ØÂè£ÁöÑÊñπÂºè„ÄÇ<strong>Hypervisor‰ºöÁª¥Êä§‰∏Ä‰∏™Áõ¥ÈÄöËÆæÂ§áÁöÑËôöÊãüPCI BAR‰∏éÁúüÂÆûPCI BAR‰πãÈó¥ÁöÑÊò†Â∞ÑË°®ÔºåÂπ∂Â∞ÜËôöÊãüPCI BAR‰∏≠ÁöÑÁ´ØÂè£Âú®I/O‰ΩçÂõæ‰∏≠ÂØπÂ∫îÁöÑ‰ΩçÁΩÆ‰∏∫1„ÄÇËøôÊ†∑ËôöÊãüÊú∫ÈÄöËøáÁõ¥ÈÄöËÆæÂ§áÁöÑËôöÊãüPCI BARÂèëËµ∑I/OËÆøÈóÆÊó∂‰ºö‰∫ßÁîüVM-ExitÈô∑ÂÖ•Hypervisor‰∏≠ÔºåÁÑ∂ÂêéHypervisor‰ºöÊ†πÊçÆÊò†Â∞ÑË°®Â∞ÜËÆøÈóÆËØ∑Ê±ÇÂèëÈÄÅÁªôÁõ¥ÈÄöËÆæÂ§áÁöÑÁúüÂÆûI/OÁ´ØÂè£„ÄÇ</strong></p>
<blockquote>
<p><em><strong>MMIO</strong></em></p>
</blockquote>
<p>Áî±‰∫éÂÜÖÂ≠ò‰∏éMMIOÂêåÂ±û‰∫éÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥Ôºå‰∏îMMIO‰ΩøÁî®‰∏éÂÜÖÂ≠òËÆøÈóÆÁõ∏ÂêåÁöÑËÆøÂ≠òÊåá‰ª§ÈÄöËøáÁâ©ÁêÜÂú∞ÂùÄÂÆåÊàêÂØπI/OËµÑÊ∫êÁöÑËÆøÈóÆÔºåÊâÄ‰ª•ÁêÜËÆ∫‰∏äÂèØ‰ª•‰ΩøÁî®ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁõ∏ÂÖ≥Êú∫Âà∂Ëß£ÂÜ≥MMIOÈóÆÈ¢ò„ÄÇ</p>
<p>Âú®ÂÜÖÂ≠òËôöÊãüÂåñÁ´†ËäÇ‰∏≠Ôºå‰ªãÁªç‰∫ÜIntel VTÊèê‰æõÁöÑÂÜÖÂ≠òËôöÊãüÂåñÊîØÊåÅÔºåÊâ©Â±ïÂêéÁöÑMMUËÉΩÂ§üÊü•ËØ¢EPTÔºå‰ª•Á°¨‰ª∂ÂÆûÁé∞ÁöÑÊñπÂºèÂÆåÊàêGPAÂà∞HPAÁöÑÊò†Â∞ÑËøáÁ®ã„ÄÇÂú®ÂºÄÂêØEPTÂäüËÉΩÁöÑÁâ©ÁêÜÊú∫‰∏äÔºåHypervisorÂèØ‰ª•Âú®ÂÆ¢Êà∑Êú∫ÁßÅÊúâÁöÑEPT‰∏≠Âª∫Á´ãÂèçÊò†ËôöÊãüMMIOÁâ©ÁêÜÂú∞ÂùÄ‰∏éÂÆûÈôÖMMIOÁâ©ÁêÜÂú∞ÂùÄ‰πãÈó¥Êò†Â∞ÑÂÖ≥Á≥ªÁöÑÈ°µË°®È°π„ÄÇ‰πãÂêéÂΩìÂÆ¢Êà∑Êú∫‰ª•MMIOÁöÑÊñπÂºèËÆøÈóÆÈÇ£‰∫õÂàÜÈÖçÁªôÂÆÉÁöÑÁâ©ÁêÜÂ§ñËÆæÊó∂ÔºåEPTÊú∫Âà∂‰ºöÂú®‰∏ç‰∫ßÁîüVM-ExitÁöÑÊÉÖÂÜµ‰∏ãÔºàÂÅáËÆæ‰∏çÂèëÁîüEPT MisconfigurationÂíåEPT ViolationÔºâÂÆåÊàêÂØπÁâ©ÁêÜÂ§ñËÆæÁöÑËÆøÈóÆ„ÄÇ</p>
<blockquote>
<p><em><strong>DMA</strong></em></p>
</blockquote>
<p>‰∏∫‰∫ÜËß£ÂÜ≥Á¨¨‰∫å‰∏™ÈóÆÈ¢òÔºåÂ∞ÜDMAËøáÁ®ã‰∏≠ÂØπÂÜÖÂ≠òÁöÑËÆøÈóÆÈôêÂà∂Âú®ÂèëËµ∑DMAÁöÑËÆæÂ§áÊâÄÂú®ËôöÊãüÊú∫ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂå∫ÂüüÔºåIntelÁöÑVT-dÊäÄÊúØÊèê‰æõ‰∫ÜDMAÈáçÊò†Â∞ÑÊú∫Âà∂ÔºåÂú®‰Ωç‰∫éPCIÊÄªÁ∫øÊ†ëÊ†πÈÉ®ÁöÑÂåóÊ°•ËäØÁâá‰∏≠ÂºïÂÖ•‰∫ÜDMAÈáçÊò†Â∞ÑÁ°¨‰ª∂„ÄÇ</p>
<p>Âú®ÂêØÂä®DMAÈáçÊò†Â∞ÑÁ°¨‰ª∂ÁöÑÁ≥ªÁªü‰∏äÔºåÂΩìÊ†πËäÇÁÇπ‰∏ãÁöÑPCIËÆæÂ§áÂ∞ùËØïÈÄöËøáDMAÁöÑÊñπÂºèËÆøÈóÆÂÜÖÂ≠òÊó∂ÔºåDMAÈáçÊò†Â∞ÑÁ°¨‰ª∂‰ºöÊã¶Êà™ËØ•ËÆøÈóÆÔºåÂπ∂ÈÄöËøáÊü•ËØ¢I/OÈ°µË°®ÁöÑÊñπÂºèÊù•Á°ÆÂÆöÊú¨Ê¨°ËÆøÈóÆÊòØÂê¶Ë¢´ÂÖÅËÆ∏ÔºåÂπ∂ÈáçÊò†Â∞ÑÂà∞ÂÜÖÂ≠òËÆøÈóÆÁöÑÂÆûÈôÖ‰ΩçÁΩÆ„ÄÇ**I/OÈ°µË°®ÊòØ‰∏éÂàÜÈ°µÊú∫Âà∂Á±ª‰ººÁöÑÈ°µË°®ÁªìÊûÑÔºåI/OÈ°µË°®ÁöÑÂàõÂª∫ÂíåÁª¥Êä§Áî±HypervisorË¥üË¥£Ôºå**ÂêéÈù¢Â∞Ü‰ºöËØ¶ÁªÜ‰ªãÁªçI/OÈ°µË°®„ÄÇ</p>
<p>Âú®I/OËôöÊãüÂåñ‰∏≠ÔºåÊØè‰∏™ËôöÊãüÊú∫ÈÉΩÊã•Êúâ‰∏é‰∏ªÊú∫Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥‰∏çÂêåÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ËßÜÂõæ„ÄÇDMAÈáçÊò†Â∞ÑÁ°¨‰ª∂Â∞Ü‰ªéI/OËÆæÂ§áÂèëËøáÊù•ÁöÑËÆøÈóÆËØ∑Ê±Ç‰∏≠ÂåÖÂê´ÁöÑÂú∞ÂùÄÁúã‰ΩúÊòØDMAÂú∞ÂùÄ„ÄÇÊ†πÊçÆ‰∏çÂêåÁöÑ‰ΩøÁî®ÈÖçÁΩÆÔºå**ËÆæÂ§áÁöÑDMAÂú∞ÂùÄÂèØ‰ª•ÊòØÂàÜÈÖçÁªôÂÆÉÁöÑËôöÊãüÊú∫ÁöÑGPA„ÄÅÂèëËµ∑DMAËØ∑Ê±ÇÁöÑÂÆø‰∏ªÊú∫ËøõÁ®ãÁöÑHVA„ÄÅÂÆ¢Êà∑Êú∫ËøõÁ®ãÁöÑGVA‰ª•ÂèäIOVA„ÄÇ**Ê†πÊçÆDMAÂú∞ÂùÄÁ©∫Èó¥ÁöÑ‰∏çÂêåÔºåDMAÈáçÊò†Â∞ÑÁ°¨‰ª∂Â∞ÜÊù•Ëá™I/OÂ≠êÁ≥ªÁªüÁöÑDMAËÆøÈóÆËØ∑Ê±ÇÂàÜ‰∏∫Â¶Ç‰∏ã‰∏§Á±ªÔºö</p>
<ol>
<li>**‰∏çÂ∏¶PASIDÔºàProcess Address Space IdentifierÔºåËøõÁ®ãÂú∞ÂùÄÁ©∫Èó¥Ê†áËØÜÁ¨¶ÔºâÁöÑËØ∑Ê±ÇÔºö**ËøôÁ±ªËØ∑Ê±Ç‰ΩøÁî®ÁöÑDMAÂú∞ÂùÄ‰∏ÄËà¨ÊòØGPAÂíåIOVAÔºåÂπ∂‰∏îÈÄöÂ∏∏‰ºöË°®ÊòéËØ•ËØ∑Ê±ÇÁöÑÁ±ªÂûãÔºàËØª„ÄÅÂÜôÊàñÂéüÂ≠êÊìç‰ΩúÔºâ„ÄÅDMAÁõÆÊ†áÁöÑÂú∞ÂùÄ„ÄÅÂ§ßÂ∞èÂíåÂèëËµ∑ËØ∑Ê±ÇÁöÑÊ∫êËÆæÂ§áÁöÑIDÁ≠â‰ø°ÊÅØÔºõ</li>
<li>**Â∏¶ÊúâPASIDÁöÑËØ∑Ê±ÇÔºö**ËøôÁ±ªËØ∑Ê±Ç‰ΩøÁî®ÁöÑDMAÂú∞ÂùÄ‰∏ÄËà¨ÊòØGVAÂíåHVAÔºåÂè™ÊúâÂÖ∑Â§áËôöÊãüÂú∞ÂùÄÂäüËÉΩ (Virtual Address Capability) ÁöÑPCIËÆæÂ§áÊâçËÉΩÂèëÂá∫ËøôÁ±ªËØ∑Ê±Ç„ÄÇÈô§‰∫Ü <code>1</code> ÊèêÂà∞ÁöÑ‰ø°ÊÅØ‰πãÂ§ñÔºåËøôÁ±ªËØ∑Ê±ÇËøòÂ∏¶ÊúâÁî®‰∫éÂÆö‰ΩçËøõÁ®ãÂú∞ÂùÄÁ©∫Èó¥ÁöÑPASIDÂíå‰∏Ä‰∫õÂÖ∂‰ªñ‰ø°ÊÅØ„ÄÇ</li>
</ol>
<p>ËôΩÁÑ∂I/OÂ≠êÁ≥ªÁªüÁöÑÂÜÖÂ≠òËÆøÈóÆËØ∑Ê±ÇÊúâ‰∏çÂêåÁßçÁ±ªÔºåDMAÂú∞ÂùÄÁöÑÁ±ªÂûã‰πüÊúâÊâÄ‰∏çÂêåÔºå‰ΩÜ**ÈáçÊò†Â∞ÑÁ°¨‰ª∂ÁöÑÊúÄÁªà‰ªªÂä°ÈÉΩÊòØË¶ÅÂ∞ÜDMAÂú∞ÂùÄËΩ¨Êç¢ÊàêHPAÔºåÂπ∂ÂÆûÁé∞ÂØπÁâ©ÁêÜÂú∞ÂùÄÁöÑËÆøÈóÆ„ÄÇ**DMAÂú∞ÂùÄÈáçÊò†Â∞ÑÂèëÁîüÂú®Âú∞ÂùÄËß£Á†Å„ÄÅÊü•ËØ¢Â§ÑÁêÜÂô®ÁºìÂ≠òÊàñËΩ¨ÂèëÂà∞ÂÜÖÂ≠òÊéßÂà∂Âô®Á≠âËøõ‰∏ÄÊ≠•ÁöÑÁ°¨‰ª∂Êìç‰Ωú‰πãÂâç„ÄÇ‰∏ãÂõæÊòØDMAÂú∞ÂùÄÈáçÊò†Â∞ÑÁöÑ‰∏Ä‰∏™‰æãÂ≠êÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201455554.png" alt="image-20231120145508683" style="zoom: 50%;" />
<p>È¶ñÂÖàÔºåI/OËÆæÂ§á1ÂíåI/OËÆæÂ§á2ÂàÜÂà´Ë¢´ÂàÜÈÖçÁªôËôöÊãüÊú∫1ÂíåËôöÊãüÊú∫2„ÄÇ‰πãÂêéÔºåHypervisor‰∏∫‰∏§‰∏™ËôöÊãüÊú∫ÂàÜÈÖçÁ≥ªÁªüÁâ©ÁêÜÂÜÖÂ≠òÔºåÂπ∂ÂºÄÂêØDMAÂú∞ÂùÄÈáçÊò†Â∞ÑÂäüËÉΩ„ÄÇËÆæÂ§á1ÂíåËÆæÂ§á2ÂàÜÂà´ÂèëËµ∑‰∏éÁõÆÁöÑÁâ©ÁêÜÂú∞ÂùÄÁõ∏ÂêåÁöÑDMAËØ∑Ê±ÇÔºå‰ΩÜÁî±‰∫éËÆæÂ§áÂàÜÂ±û‰∫é‰∏çÂêåÁöÑËôöÊãüÊú∫ÔºåDMAÈáçÊò†Â∞ÑÁ°¨‰ª∂‰ºöÂ∞ÜÂÖ∂ÂàÜÂà´ËΩ¨Êç¢‰∏∫ËÆæÂ§áÊâÄÂú®ËôöÊãüÊú∫ÁöÑÂÆûÈôÖÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ</p>
<hr>
<p>DMAÈáçÊò†Â∞ÑÁ°¨‰ª∂ÊØèÊ¨°ÊçïËé∑ËÆæÂ§áDMAËØ∑Ê±ÇÊó∂ÔºåÈúÄË¶ÅÂÖàËØÜÂà´ÂèëËµ∑ËØ•ËØ∑Ê±ÇÁöÑÂ§ñËÆæ„ÄÇ‰∏ÄËà¨‰ΩøÁî®Ê∫êÊ†áËØÜÁ¨¶ (Source Identifier) Ê†áËØÜÂèëËµ∑DMAÊìç‰ΩúÁöÑËÆæÂ§á„ÄÇÈáçÊò†Â∞ÑÁ°¨‰ª∂ÂèØ‰ª•Ê†πÊçÆËÆæÂ§áÁöÑÁ±ªÂà´‰ª•ÂèäI/O‰∫ãÂä°ÁöÑÂÖ∑‰ΩìÂÆûÁé∞ÊñπÂºèÁ°ÆÂÆöÂ§ñËÆæÁöÑÊ∫êÊ†áËØÜÁ¨¶„ÄÇ‰æãÂ¶ÇÔºå‰∏Ä‰∫õI/OÊÄªÁ∫øÂçèËÆÆ‰∏≠ÔºåÊ∫êÊ†áËØÜÁ¨¶ÊòØI/O‰∫ãÂä°ÁöÑ‰∏Ä‰∏™ÁªÑÊàêÈÉ®ÂàÜ„ÄÇ<strong>ÂØπ‰∫éPCIËÆæÂ§áÔºåPCIËÆæÂ§áÊ†áËØÜÁ¨¶ËÉΩÂ§üÂîØ‰∏ÄÁ°ÆÂÆöÊüê‰∏™PCIËÆæÂ§áÔºåÂõ†Ê≠§PCIÊÄªÁ∫ø‰ΩøÁî®PCIËÆæÂ§áÊ†áËØÜÁ¨¶‰Ωú‰∏∫Ê∫êÊ†áËØÜÁ¨¶„ÄÇ</strong></p>
<p>Âú®x86Êû∂ÊûÑ‰∏ãÔºåÂÜÖÂ≠òÁöÑÈ°µË°®Âü∫Âú∞ÂùÄ‰ºöÂ≠òÂÇ®Âú®CR3ÂØÑÂ≠òÂô®‰∏≠ÔºåCPUÈÄöËøáËØªÂèñCR3ÁöÑÂÄºÂç≥ÂèØËé∑ÂæóÂΩìÂâçËøõÁ®ãÁöÑÈ°µË°®„ÄÇ‰πãÂêéÔºåÈÄöËøáÊü•ËØ¢È°µË°®ËøáÁ®ãÂç≥ÂèØ‰ª•ÂÆåÊàêËôöÊãüÂú∞ÂùÄ‰∏éÁâ©ÁêÜÂú∞ÂùÄÁöÑËΩ¨Êç¢„ÄÇËÆæÂ§áÁöÑI/OÂú∞ÂùÄËΩ¨Êç¢ËøáÁ®ãÂàôËæÉ‰∏∫Â§çÊùÇÔºåDMAÈáçÊò†Â∞ÑÁ°¨‰ª∂ÊîØÊåÅ‰∏§Â±ÇÂú∞ÂùÄËΩ¨Êç¢ÔºåÁ¨¨‰∏ÄÁ∫ßËΩ¨Êç¢ (First-level Translation) Ë¥üË¥£Â∞ÜGVAÈáçÊñ∞Êò†Â∞ÑÂà∞GPAÔºåÁ¨¨‰∫åÁ∫ßËΩ¨Êç¢ÂàôÂ∞ÜGPAÈáçÊñ∞Êò†Â∞ÑÂà∞HPA„ÄÇI/OËÆæÂ§áÁöÑDMAËØ∑Ê±ÇÊúâ‰∏§Áßç‚Äî‚Äî‰∏çÂ∏¶PASIDÂíåÂ∏¶ÊúâPASIDÔºåÁî±‰∫éÂâçËÄÖ‰ΩøÁî®ÁöÑÊòØGPAÔºåÊâÄ‰ª•Âè™ÈúÄË¶ÅÁ¨¨‰∫åÁ∫ßËΩ¨Êç¢ÔºåËÄåÂêéËÄÖ‰ΩøÁî®ÁöÑÊòØGVAÔºåÂàôÈúÄË¶Å‰∏§Â±ÇÂú∞ÂùÄËΩ¨Êç¢ËøáÁ®ã„ÄÇ</p>
<p>VT-dÊèê‰æõ‰∏§ÁßçÂú∞ÂùÄÁøªËØëÊ®°ÂºèÔºå‰º†Áªü (Legacy) Âú∞ÂùÄËΩ¨Êç¢Ê®°Âºè‰∏éÂèØÊâ©Â±ï (Scalable) Âú∞ÂùÄËΩ¨Êç¢Ê®°Âºè„ÄÇ‰º†ÁªüÊ®°Âºè‰ªÖÊîØÊåÅÁ¨¨‰∫åÁ∫ßÂú∞ÂùÄËΩ¨Êç¢ÔºåÊâÄ‰ª•Âè™ËÉΩÂ∫îÁî®‰∫é‰∏çÂ∏¶PASIDÁöÑËØ∑Ê±Ç„ÄÇÂèØÊâ©Â±ïÊ®°ÂºèÊîØÊåÅ‰∏§Â±ÇÂú∞ÂùÄËΩ¨Êç¢ÔºåËÉΩÂ§üÂêåÊó∂ÊîØÊåÅ‰∏çÂ∏¶PASIDÂíåÂ∏¶ÊúâPASIDÁöÑDMAËØ∑Ê±Ç„ÄÇ‰∏ãÊñáÂàÜÂà´‰ªãÁªçËøô‰∏§ÁßçÊ®°Âºè„ÄÇ</p>
<p>Âú®‰º†ÁªüÊ®°Âºè‰∏≠ÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÊ†πÊù°ÁõÆË°®‰Ωú‰∏∫ÊúÄÈ°∂Â±ÇÁöÑÁªìÊûÑÂ∞ÜËÆæÂ§áÊò†Â∞ÑÂà∞ÂêÑËá™ÁöÑËôöÊãüÊú∫ÔºåÊâÄ‰ª•Ê†πÊù°ÁõÆË°®‰πüÊòØDMAÂú∞ÂùÄËΩ¨Êç¢ÁöÑËµ∑ÁÇπ„ÄÇÊ†πÊù°ÁõÆË°®Âú®Á≥ªÁªüÂÜÖÂ≠ò‰∏≠ÁöÑ‰ΩçÁΩÆÊòØÁî±Ê†πÊù°ÁõÆË°®Âú∞ÂùÄÂØÑÂ≠òÂô® <code>RTADDR_REG</code> ÂÜ≥ÂÆöÁöÑ„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201457361.png" alt="image-20231120145707208" style="zoom: 33%;" />
<p>‰∏ãÂõæÊèèËø∞‰∫Ü <code>RTADDR_REG</code> ÁöÑÂ≠óÊÆµÂàÜÂ∏ÉÊÉÖÂÜµ„ÄÇÊ†πÊù°ÁõÆË°®Âú∞ÂùÄÂØÑÂ≠òÂô®ÁöÑËΩ¨Êç¢Ë°®Ê®°ÂºèÂ≠óÊÆµ (RTADDR_REG.TTM) Áî®‰∫éË°®Á§∫ÁõÆÂâçÊâÄ‰ΩøÁî®ÁöÑÂú∞ÂùÄÁøªËØëÊ®°Âºè„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201458559.png" alt="image-20231120145805586" style="zoom: 50%;" />
<hr>
<p>ÂΩì<code>RTADDR_REG</code> ÁöÑTTMÂ≠óÊÆµ‰∏∫00Êó∂Ôºå‰ª£Ë°®Â§Ñ‰∫é‰º†ÁªüÊ®°ÂºèÔºå<code>RTADDR_REG</code> ÁöÑÊ†πÊù°ÁõÆË°®Âú∞ÂùÄÂ≠óÊÆµ (RTADDR_REG.RTA) ‰øùÂ≠òÁöÑÊòØÊåáÂêëÊ†πÊù°ÁõÆË°®ÁöÑÊåáÈíà„ÄÇ</p>
<p>Ê†πÊù°ÁõÆË°® (Root Table) ÁöÑÂ§ßÂ∞è‰∏∫4KBÔºåÂåÖÂê´256‰∏™Ê†πÊù°ÁõÆÔºåÊØè‰∏™Ê†πÊù°ÁõÆÂØπÂ∫î‰∏ÄÊù°PCIÊÄªÁ∫ø„ÄÇÂú®Ê£ÄÁ¥¢Ê†πÊù°ÁõÆË°®Êó∂Ôºå‰ΩøÁî®Ê∫êÊ†áËØÜÁ¨¶Â≠óÊÆµ‰∏≠ÁöÑÊÄªÁ∫øÂè∑ÔºàÈ´ò8‰ΩçÔºâ‰Ωú‰∏∫Á¥¢ÂºïÂÆö‰ΩçÂà∞ÂèëËµ∑DMAÁöÑËÆæÂ§áÊâÄÂú®ÊÄªÁ∫øÂØπÂ∫îÁöÑÊ†πÊù°ÁõÆ„ÄÇÊ†πÊù°ÁõÆ‰∏≠ÂåÖÂê´‰∏Ä‰∏™‰∏ä‰∏ãÊñáÊù°ÁõÆË°®ÁöÑÊåáÈíàÔºåËØ•ÊåáÈíàÁî®‰∫éËé∑ÂèñÊÄªÁ∫ø‰∏äÊâÄÊúâËÆæÂ§áÂÖ±ÂêåÁöÑ‰∏ä‰∏ãÊñáÊù°ÁõÆË°®„ÄÇÊØè‰∏™‰∏ä‰∏ãÊñáÊù°ÁõÆË°®ÂåÖÂê´256‰∏™Êù°ÁõÆÔºåÊØè‰∏™Êù°ÁõÆÂØπÂ∫î‰∫éÊÄªÁ∫ø‰∏äÁöÑÊüê‰∏™PCIËÆæÂ§á„ÄÇÂØπ‰∫éPCIËÆæÂ§áÔºåÂ∞Ü‰ΩøÁî®Ê∫êÊ†áËØÜÁ¨¶ÁöÑËÆæÂ§áÂè∑ÂíåÂäüËÉΩÂè∑ÔºàËæÉ‰ΩéÁöÑ8‰ΩçÔºâÁ¥¢Âºï‰∏ä‰∏ãÊñáÊù°ÁõÆË°®Ôºå‰ª•Ëé∑ÂæóÁõÆÊ†áËÆæÂ§áÂØπÂ∫îÁöÑ‰∏ä‰∏ãÊñáÊù°ÁõÆ„ÄÇ‰∏ä‰∏ãÊñáÊù°ÁõÆ‰∏≠‰øùÂ≠òÊúâ‰∏Ä‰∏™Á¨¨‰∫åÁ∫ßËΩ¨Êç¢È°µË°®ÁöÑÂü∫Âú∞ÂùÄ„ÄÇ‰ΩøÁî®DMAÂú∞ÂùÄÊü•ËØ¢ËØ•ËΩ¨Êç¢È°µË°®Êó∂Ôºå‰ºö‰æùÊ¨°Êò†Â∞ÑÂà∞I/OÈ°µË°®ÁöÑÂ§öÁ∫ßÂú∞ÂùÄËΩ¨Êç¢ÁªìÊûÑÔºåÂπ∂ÊúÄÁªàÂ∞ÜDMAËØ∑Ê±Ç‰∏≠ÁöÑGPAËΩ¨Êç¢‰∏∫HPA„ÄÇ</p>
<hr>
<p>ÂΩì <code>RTADDR_REG.TTM</code> ‰∏∫01bÊó∂ÔºåÊ≠§Êó∂DMAÈáçÊò†Â∞ÑÁ°¨‰ª∂Â§Ñ‰∫é‰∏ãÂõæÊâÄÁ§∫ÁöÑÂèØÊâ©Â±ïÂú∞ÂùÄËΩ¨Êç¢Ê®°ÂºèÔºå<code>RTADDR_REG</code> ÁöÑRTAÂ≠óÊÆµ‰øùÂ≠òÊåáÂêëÂèØÊâ©Â±ïÊ®°Âºè‰∏ãÊ†πÊù°ÁõÆË°®ÁöÑÊåáÈíà„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201500746.png" alt="image-20231120150008640" style="zoom: 33%;" />
<p>ÂèØÊâ©Â±ïÊ®°ÂºèÊ†πÊù°ÁõÆË°®‰∏éÊ†πÊù°ÁõÆË°®Á±ª‰ººÔºåÂ§ßÂ∞èÈÉΩÊòØ4KBÔºåÂπ∂‰∏îÂêåÊ†∑ÂåÖÂê´256‰∏™Ê†πÊù°ÁõÆÔºåÊØè‰∏™Ê†πÊù°ÁõÆÂØπÂ∫î‰∏ÄÊù°PCIÊÄªÁ∫ø„ÄÇ‰∏éÊ†πÊù°ÁõÆ‰∏≠Â∞Ü <code>[64‚à∂127]</code> ËÆæ‰∏∫‰øùÁïôÂ≠óÊÆµ‰∏çÂêåÁöÑÊòØÔºåÊØè‰∏™ÂèØÊâ©Â±ïÊ®°ÂºèÊ†πÊù°ÁõÆÂàÜ‰∏∫[0‚à∂63]‰∏é[64‚à∂127]‰∏§ÈÉ®ÂàÜ„ÄÇÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºå‰Ωé64‰Ωç‰∏≠ÁöÑLCTPÔºàLower Context Table PointerÔºå‰Ωé‰∏ä‰∏ãÊñáË°®ÊåáÈíàÔºâÂ≠óÊÆµÊåáÂêë‰∏ãÂçäÈÉ®(lower)‰∏ä‰∏ãÊñáÊù°ÁõÆË°®ÔºåÈ´ò64‰Ωç‰∏≠ÁöÑUCTPÔºàUpper Context Table PointerÔºåÈ´ò‰∏ä‰∏ãÊñáË°®ÊåáÈíàÔºâÂ≠óÊÆµÊåáÂêë‰∏äÂçäÈÉ®(upper)‰∏ä‰∏ãÊñáÊù°ÁõÆË°®„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201501812.png" alt="image-20231120150118733" style="zoom: 50%;" />
<p>‰∏ãÂçäÈÉ®‰∏ä‰∏ãÊñáÊù°ÁõÆË°®ÁöÑÂ§ßÂ∞è‰∏∫4KBÔºåÂåÖÂê´128‰∏™ÂèØÊâ©Â±ïÊ®°Âºè‰∏ä‰∏ãÊñáÊù°ÁõÆÔºåÂØπÂ∫îÊÄªÁ∫ø‰∏äËÆæÂ§áÂè∑Âú® <code>0~15</code> ÁöÑPCIËÆæÂ§á„ÄÇ‰∏äÂçäÈÉ®‰∏ä‰∏ãÊñáÊù°ÁõÆË°®ÁöÑÂ§ßÂ∞è‰πüÊòØ4KBÔºåÂåÖÂê´128‰∏™ÂèØ‰º∏Áº©Ê®°Âºè‰∏ä‰∏ãÊñáÊù°ÁõÆÔºåÂØπÂ∫îÊÄªÁ∫ø‰∏äËÆæÂ§áÂè∑Âú® <code>16~31</code> ÁöÑPCIËÆæÂ§á„ÄÇÂú®ÂèØÊâ©Â±ïÊ®°Âºè‰∏ãÔºåÂ§ÑÁêÜ‰∏çÂ∏¶PASIDÁöÑËØ∑Ê±Ç‰∏éÂ∏¶ÊúâPASIDÁöÑËØ∑Ê±ÇÁ±ª‰ººÔºå‰∏ÄÊ†∑ÂèØ‰ª•‰ªéÂèØÊâ©Â±ïÊ®°Âºè‰∏ä‰∏ãÊñáÊù°ÁõÆÁöÑRID_PASIDÂ≠óÊÆµ‰∏≠Ëé∑ÂæóPASIDÂÄº„ÄÇÂèØÊâ©Â±ïÊ®°Âºè‰∏ä‰∏ãÊñáÊù°ÁõÆÁöÑPASIDDIRPTRÂ≠óÊÆµÂåÖÂê´ÊåáÂêëÂèØÊâ©Â±ïÊ®°ÂºèPASIDÁõÆÂΩïÁöÑÊåáÈíà„ÄÇ</p>
<p>ËØ∑Ê±ÇÁöÑPASIDÂÄºÁöÑÈ´ò14‰Ωç (19‚à∂6) ‰ºöÁî®‰∫éÁ¥¢ÂºïÂèØ‰º∏Áº©Ê®°ÂºèÁöÑPASIDÁõÆÂΩï„ÄÇÊØè‰∏™Áé∞ÊúâÁöÑÂèØ‰º∏Áº©Ê®°ÂºèPASIDÁõÆÂΩïÊù°ÁõÆÁöÑSMPTBLPTRÂ≠óÊÆµÈÉΩÂåÖÂê´‰∏Ä‰∏™ÊåáÂêëÂèØ‰º∏Áº©Ê®°ÂºèPASIDË°®ÁöÑÊåáÈíà„ÄÇËØ∑Ê±ÇÁöÑPASIDÂÄºÁöÑËæÉ‰Ωé6‰Ωç(5‚à∂0)Ë¢´Áî®‰∫éÁ¥¢ÂºïÂèØ‰º∏Áº©Ê®°ÂºèÁöÑPASIDË°®„ÄÇPASIDË°®Êù°ÁõÆÁöÑFLPTPTRÂ≠óÊÆµÂíåSLPTRÂ≠óÊÆµÂàÜÂà´ÂåÖÂê´Á¨¨‰∏ÄÁ∫ßÂú∞ÂùÄËΩ¨Êç¢ÂíåÁ¨¨‰∫åÁ∫ßËΩ¨Êç¢È°µË°®ÁöÑÊåáÈíà„ÄÇÂêåÊó∂ÔºåPASIDË°®Êù°ÁõÆÁöÑPGTTÂ≠óÊÆµË°®ÊòéÈúÄË¶ÅËøõË°åÂì™‰∫õÂú∞ÂùÄËΩ¨Êç¢ËøáÁ®ãÔºåPGTT‰∏∫001bÊó∂‰ª£Ë°®Âè™ËøõË°åÁ¨¨‰∏ÄÈò∂ÊÆµÂú∞ÂùÄËΩ¨Êç¢Ôºå010b‰ª£Ë°®Âè™ËøõË°åÁ¨¨‰∫åÈò∂ÊÆµÂú∞ÂùÄËΩ¨Êç¢Ôºå011bÂàôÊÑèÂë≥ÁùÄÈúÄË¶ÅÊâßË°åÂµåÂ•óËΩ¨Êç¢‰ª•ËææÂà∞ÂèåÂ±ÇÂú∞ÂùÄËΩ¨Êç¢ÁöÑÁõÆÁöÑ„ÄÇ</p>
<p>DMAÈáçÊò†Â∞ÑÂú®Á¨¨‰∏ÄÁ∫ßÂú∞ÂùÄËΩ¨Êç¢ÂíåÁ¨¨‰∫åÁ∫ßÂú∞ÂùÄËΩ¨Êç¢‰∏≠ÈÉΩ‰ΩøÁî®‰∫ÜÂ§öÁ∫ßÈ°µË°®ÁªìÊûÑ„ÄÇÁ¨¨‰∏ÄÁ∫ßÂú∞ÂùÄËΩ¨Êç¢ÊîØÊåÅ4Á∫ßÁªìÊûÑÊàñ5Á∫ßÁªìÊûÑ„ÄÇÁ¨¨‰∫åÁ∫ßÂú∞ÂùÄËΩ¨Êç¢ÊîØÊåÅNÁ∫ßÁªìÊûÑÔºåÂÖ∂‰∏≠NÁöÑÂÄºÂèñÂÜ≥‰∫éÁî± <code>Capability</code> ÂØÑÂ≠òÂô®ÊîØÊåÅÁöÑGAWÔºàGuest Address WidthÔºåÂÆ¢Êà∑Êú∫Âú∞ÂùÄÂÆΩÂ∫¶Ôºâ„ÄÇÊØèÁ∫ßÈ°µË°®ÁöÑÂ§ßÂ∞èÈÉΩ‰∏∫4KBÔºåÊã•Êúâ512‰∏™È°µË°®È°π„ÄÇÈ°µË°®ÁöÑÁøªËØëËøáÁ®ã‰∏éÂÜÖÂ≠òÂàÜÈ°µÊú∫Âà∂Á±ª‰ººÔºåÂú®Ê≠§‰∏çÂÜçËøáÂ§ö‰ªãÁªç„ÄÇI/OÈ°µË°®ÂêåÊ†∑ÊîØÊåÅ4KB„ÄÅ2MB„ÄÅ1GBÁ≠âÁ≤íÂ∫¶ÁöÑÈ°µÈù¢Â§ßÂ∞è„ÄÇÈÄöËøá <code>Capability</code> ÂØÑÂ≠òÂô®ÂèØ‰ª•Êü•ËØ¢Á≥ªÁªüÊîØÊåÅÈ°µÈù¢Â§ßÂ∞èÁöÑÁ≤íÂ∫¶‰ø°ÊÅØ„ÄÇ</p>
<hr>
<p>Âú®ÂÜÖÂ≠òÂàÜÈ°µÊú∫Âà∂‰∏≠ÔºåCPUËÉΩÂ§üÂÄüÂä©Cache„ÄÅTLBÁ≠âÁºìÂ≠òÊú∫Âà∂Êù•Âä†ÈÄüCPUÂØπÂÜÖÂ≠òÁöÑËÆøÈóÆËøáÁ®ã„ÄÇÈáçÊò†Â∞ÑÁ°¨‰ª∂‰πüÂèØ‰ª•ÈÄöËøáÁºìÂ≠ò‰∏éÈáçÊò†Â∞ÑÂú∞ÂùÄËΩ¨Êç¢Áõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÁªìÊûÑÊù•Âä†ÈÄüÂú∞ÂùÄËΩ¨Êç¢ËøáÁ®ã„ÄÇ</p>
<p>‰∏ãÈù¢ÊòØÈáçÊò†Â∞ÑÁ°¨‰ª∂Âú∞ÂùÄÁøªËØëÁºìÂ≠ò (Translation Cache) ÁöÑÂá†ÁßçÁ±ªÂûãÔºö</p>
<ol>
<li>**‰∏ä‰∏ãÊñáÊù°ÁõÆÁºìÂ≠òÔºö**ËØ•ÁºìÂ≠òÁöÑ‰ΩúÁî®ÊòØÁºìÂ≠ò‰∏ä‰∏ãÊñáÊù°ÁõÆÔºåÁî®‰∫éÂú∞ÂùÄÁøªËØëËØ∑Ê±Ç„ÄÇÁøªËØëËØ∑Ê±Ç‰∏≠ÁöÑÊ∫êÊ†áËØÜÁ¨¶Áî®‰∫éÁ¥¢ÂºïÂØπÂ∫îÁöÑÁºìÂ≠òÊù°ÁõÆÔºõ</li>
<li>**PASIDÁºìÂ≠òÔºö**ËØ•ÁºìÂ≠òÁöÑ‰ΩúÁî®ÊòØÁºìÂ≠òÂèØ‰º∏Áº©Ê®°ÂºèÁöÑPASIDË°®Êù°ÁõÆÔºåËøô‰∫õÊù°ÁõÆÁî®‰∫éÂú∞ÂùÄËΩ¨Êç¢„ÄÇËØ•ÁºìÂ≠òÂè™Âú®ÂêØÁî®ÂèØÁº©ÊîæÊ®°ÂºèËΩ¨Êç¢Êó∂‰ΩøÁî®Ôºõ</li>
<li>**IOTLBÔºö**IOTLBÔºàI/O Translation Lookaside BufferÔºåI/OÁøªËØëÂêéÂ§áÁºìÂ≠òÂô®Ôºâ‰∏≠ÁöÑÊØè‰∏™Êù°ÁõÆË¥üË¥£‰øùÂ≠òËØ∑Ê±ÇÂú∞ÂùÄÁöÑÈ°µÂè∑‰∏éÂØπÂ∫îÁâ©ÁêÜÈ°µ‰πãÈó¥ÁöÑÊò†Â∞ÑÔºõ</li>
<li>**ÂàÜÈ°µÁªìÊûÑÁºìÂ≠òÔºö**ËØ•ÁºìÂ≠òÁöÑ‰ΩúÁî®ÊòØÁºìÂ≠òÁªèÂ∏∏‰ΩøÁî®ÁöÑÂàÜÈ°µÁªìÊûÑÊù°ÁõÆÔºåËøô‰∫õÊù°ÁõÆÁî®‰∫éÂºïÁî®ÂÖ∂‰ªñÂàÜÈ°µÁªìÊûÑÊù°ÁõÆ„ÄÇÁºìÂ≠òÁöÑÂàÜÈ°µÁªìÊûÑÊù°ÁõÆÂèØ‰ª•ÊòØPML5ÁºìÂ≠ò„ÄÅPML4ÁºìÂ≠ò„ÄÅPDPEÁºìÂ≠òÊàñPDEÁºìÂ≠ò„ÄÇ</li>
</ol>
<p>Âú®ÈáçÊò†Â∞ÑÁ°¨‰ª∂‰∏äÔºåÁøªËØëÁºìÂ≠òÂèØ‰ª•ÊîØÊåÅÂ§ö‰∏™Â§ñÈÉ®ËÆæÂ§áÁöÑËØ∑Ê±Ç„ÄÇ**ÁºìÂ≠òÊïàÁéáÂèñÂÜ≥‰∫éÂπ≥Âè∞‰∏≠ÂêåÊó∂Ê¥ªÂä®ÁöÑDMAÊµÅÁöÑÊï∞ÈáèÂíåDMAËÆøÈóÆÁöÑÂú∞ÂùÄÂ±ÄÈÉ®ÊÄß„ÄÇ**ÈáçÊò†Â∞ÑÁ°¨‰ª∂ÊåÅÊúâÁöÑÁøªËØëÁºìÂ≠òËµÑÊ∫êÂçÅÂàÜÊúâÈôêÔºåÊüê‰∫õÊÉÖÂÜµ‰∏ãÂèØËÉΩÊó†Ê≥ïÊª°Ë∂≥ËÆæÂ§á‰ΩøÁî®ÈúÄÊ±Ç„ÄÇ‰∏ÄÁßçÊâ©Â±ïÁºìÂ≠òËµÑÊ∫êÁöÑÊñπÂºèÊòØËÆ©Â§ñËÆæÂèÇ‰∏éÈáçÊò†Â∞ÑËøáÁ®ãÔºåÂ∞ÜÁøªËØëÁºìÂ≠òÂÆûÁé∞Âú®Â§ñËÆæ‰∏≠„ÄÇËÆæÂ§á‰∏äÁöÑËøô‰∫õÁøªËØëÁºìÂ≠òÁß∞‰∏∫ËÆæÂ§áTLB„ÄÇËÆæÂ§áTLBÂáèËΩª‰∫ÜÂåóÊ°•ËäØÁâá‰∏≠ÁøªËØëÁºìÂ≠òÁöÑÂéãÂäõÔºåÂêåÊó∂‰ΩøËÆæÂ§áÂú®ÂèëËµ∑DMAËØ∑Ê±Ç‰πãÂâçÔºåÈÄöËøáÁøªËØëÁºìÂ≠ò‰ΩøÂÆûÁé∞Âú∞ÂùÄËΩ¨Êç¢Êàê‰∏∫ÂèØËÉΩ„ÄÇËÆæÂ§áTLBÂèØ‰ª•Áî®‰∫éÂØπËÆøÈóÆÂª∂ËøüË¶ÅÊ±ÇËæÉÈ´òÁöÑËÆæÂ§áÔºàÂ¶ÇÂÆûÊó∂ËÆæÂ§áÔºâÔºå‰ª•ÂèäÂÖ∑ÊúâÈ´òDMAÂ∑•‰ΩúË¥üËΩΩÊàñÂ§ö‰∏™DMAÊµÅÁöÑËÆæÂ§á„ÄÇ</p>
<h2 id="25-vfio">2.5 VFIO
</h2><p>Áî±‰∫éLinuxÈÅµÂæ™GPLÔºàGeneral Public LicenseÔºåÈÄöÁî®ÂÖ¨ÂÖ±ËÆ∏ÂèØËØÅÔºâÂºÄÊ∫êÂçèËÆÆÔºåÊ†πÊçÆGPLÂçèËÆÆÂÜÖÂÆπÔºåÊâÄÊúâÂü∫‰∫éÂÜÖÊ†∏ÁöÑÈ©±Âä®Á®ãÂ∫èÂêåÊ†∑Â∫îËØ•ÈÅµÂÆàGPLÂºÄÊ∫êÂçèËÆÆ„ÄÇ‰∏Ä‰∫õÂïÜ‰∏öÂÖ¨Âè∏Êé®Âá∫ÁöÑËÆæÂ§áÈ©±Âä®‰ºöÈááÁî®Èó≠Ê∫êÁ≠ñÁï•Ôºå‰æãÂ¶ÇËã±‰ºüËææÂÖ¨Âè∏ÁöÑGPUÈ©±Âä®Âü∫Êú¨ÊòØÈó≠Ê∫êÁöÑ„ÄÇAMDÂÖ¨Âè∏ËôΩÁÑ∂ÁßØÊûÅÂèÇ‰∏éLinux GPUÈ©±Âä®ÂºÄÊ∫êÂ∑•‰ΩúÔºå‰ΩÜÊòØAMDÈó≠Ê∫êGPUÈ©±Âä®ÁöÑÊÄßËÉΩÈÄöÂ∏∏‰ºò‰∫éÂºÄÊ∫êÈ©±Âä®„ÄÇ‰∏∫‰∫ÜÁªïËøáLinuxÁöÑGPLÂçèËÆÆÔºåÂéÇÂïÜÈÄöÂ∏∏‰ΩøÁî®Áî®Êà∑ÊÄÅÈ©±Âä®Ê°ÜÊû∂Êù•ËææÂà∞Âú®Linux‰∏äÈó≠Ê∫êÁöÑÁõÆÁöÑÔºå‰æãÂ¶ÇËã±‰ºüËææÂÖ¨Âè∏Â∞ÜCUDAÈ©±Âä®ÂíåOpenGLÈ©±Âä®ÂÆûÁé∞Âú®Áî®Êà∑ÊÄÅ„ÄÇ<strong>Èô§‰∫ÜËÉΩÂ§üÁªïÂºÄÂºÄÊ∫êÂçèËÆÆÔºåËøôÁßçUIOÔºàUserspace I/OÔºåÁî®Êà∑Á©∫Èó¥I/OÔºâÊã•ÊúâÂºÄÂèëÂ∑•‰ΩúÈáèÂ∞ë„ÄÅÊòì‰∫éË∞ÉËØï‰ª•ÂèäËÉΩÂ§üÈõÜÊàêÂà∞ÁâπÂÆöÂ∫îÁî®Á®ãÂ∫èÔºà‰æãÂ¶ÇÂâçÊñáÊèêÂà∞ÁöÑDPDKÔºâ‰∏≠Á≠â‰ºòÂäø„ÄÇ</strong></p>
<p>UIOËôΩÁÑ∂Êã•Êúâ‰∏äËø∞ËØ∏Â§ö‰ºòÂäøÔºå‰ΩÜÊòØ‰Ωú‰∏∫‰∏Ä‰∏™ËøêË°åÂú®Áî®Êà∑ÊÄÅÁöÑÈ©±Âä®ÂÆÉÊúâ‰∏Ä‰∏™Ëá¥ÂëΩÁöÑÁº∫ÁÇπÔºåÂ∞±ÊòØÊó†Ê≥ïÂä®ÊÄÅÁî≥ËØ∑DMAÂå∫Âüü„ÄÇÂõ†‰∏∫Â¶ÇÊûúUIOÂèØ‰ª•ÈöèÊÑèÂèëËµ∑DMAËØ∑Ê±ÇÔºåÈÇ£‰πàÊÑèÂë≥ÁùÄÊôÆÈÄöÁî®Êà∑ÂèØ‰ª•ËØªÂÜô‰ªª‰ΩïÁâ©ÁêÜÂú∞ÂùÄÁöÑÂÜÖÂÆπÔºåËøôÊ†∑Â∞±‰ºöÁªôÁ≥ªÁªüÁöÑÂÆâÂÖ®ÊÄßÈÄ†ÊàêÊûÅÂ§ßÁöÑÂ®ÅËÉÅ„ÄÇÂπ∏ËøêÁöÑÊòØËØ•ÈóÆÈ¢òËÉΩÂ§üË¢´‰∏äÊñá‰ªãÁªçÁöÑVT-dÔºà<code>GVA/HVA -&gt; HPA</code>ÔºâÊäÄÊúØËß£ÂÜ≥ÔºåÂõ†Ê≠§Âü∫‰∫éIOMMUÁöÑÂè¶Â§ñ‰∏ÄÂ•óÁî®Êà∑ÊÄÅÈ©±Âä®Ê°ÜÊû∂‚Äî‚ÄîVFIOÔºàVirtual Function I/OÔºåËôöÊãüÂäüËÉΩI/OÔºâÂ∫îËøêËÄåÁîü„ÄÇ</p>
<p>VFIO‰ºö‰∏∫Áî®Êà∑ÊÄÅËøõÁ®ãÊèê‰æõ‰∏ÄÁ≥ªÂàó‰∫§‰∫íÊé•Âè£„ÄÇÂêåUIO‰∏ÄÊ†∑ÔºåVFIO‰ΩøÁî®‰∏Ä‰∏™ÈùûÂ∏∏ÁÆÄÂçïÁöÑÂÜÖÊ†∏Ê®°Âùó‰∏∫Áî®Êà∑Êèê‰æõÂêç‰∏∫ <code>/dev/vfio/$Group</code> ÁöÑÁî®‰∫éËÆæÂ§áËÆøÈóÆÁöÑÊñá‰ª∂Êé•Âè£„ÄÇÁî®Êà∑ËøõÁ®ãÂèØ‰ª•ÈÄöËøá‰∏ÄÁªÑioctl‰∏éVFIOËøõË°å‰∫§‰∫íÔºå‰æãÂ¶ÇioctlÂáΩÊï∞ÂèØ‰ª•ÈÖçÁΩÆIOMMUÔºåÂπ∂Â∞ÜDMAÂú∞ÂùÄÊò†Â∞ÑÂà∞ËøõÁ®ãÂú∞ÂùÄÁ©∫Èó¥Ôºå‰ªéËÄåÂÖÅËÆ∏Áî®Êà∑ÊÄÅÈ©±Âä®ÂèëËµ∑DMAÊìç‰ΩúÔºåÈô§Ê≠§‰πãÂ§ñÔºåËøòÂèØ‰ª•ÈÄöËøáioctlÈÖçÁΩÆÂØπÂ∫îÁöÑPCIÈÖçÁΩÆÁ©∫Èó¥„ÄÅËé∑ÂèñÁõ∏ÂÖ≥‰∏≠Êñ≠‰ø°ÊÅØÂπ∂Ê≥®ÂÜå‰∏≠Êñ≠Â§ÑÁêÜÂáΩÊï∞„ÄÇVFIOÁõ∏ËæÉ‰∫éUIOÊõ¥Âä†ÂÆâÂÖ®ÔºåËÉΩÂ§üÈôêÂà∂Áî®Êà∑ÊÄÅÈ©±Âä®ÂØπÂÜÖÂ≠òÂú∞ÂùÄÁöÑËÆøÈóÆÔºåËøô‰∏ÄÁâπÊÄß‰ΩøÂæóVFIOËÉΩÂ§üÂ∫îÁî®‰∫éËôöÊãüÂåñÁéØÂ¢É„ÄÇÂêåÊó∂VFIO‰πüÂèØ‰ª•Ë¢´ÈõÜÊàêÂú®DPDKÁ≠âÁâπÂÆöÂ∫îÁî®Á®ãÂ∫è‰∏≠ÔºåÁõ∏ËæÉ‰∫éUIOÔºåVFIOÁöÑ‰ΩøÁî®‰ºòÂÖàÁ∫ßÊõ¥È´ò„ÄÇ</p>
<h2 id="26-sr-iov">2.6 SR-IOV
</h2><p>SR-IOVÊû∂ÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201651581.png" alt="image-20231120165130908" style="zoom:50%;" />
<p>È¶ñÂÖà‰ªãÁªç <code>PF/VF</code> ÁöÑÊ¶ÇÂøµÔºö</p>
<ul>
<li>**PFÊòØ‰∏ÄÁßçÊîØÊåÅSR-IOVÂäüËÉΩÁöÑPCIÂäüËÉΩÔºå**ÂÆÉÂèØ‰ª•ÂØπËÆæÂ§áÊâÄÊúâÁöÑÁâ©ÁêÜËµÑÊ∫êËøõË°åÈÖçÁΩÆÔºåÂ∞ÜÂÖ∂ÂàíÂàÜ‰∏∫Â§ö‰∏™ËµÑÊ∫êÂ≠êÈõÜÔºåÂπ∂Âú®ËµÑÊ∫êÂ≠êÈõÜ‰πã‰∏äËôöÊãüÂá∫VFÔºõ</li>
<li>**VFÊòØ‰∏ÄÁßçËΩªÈáèÁ∫ßPCIeÂäüËÉΩÔºå**ÂèØ‰ª•Áúã‰ΩúÊòØ‰ªéPF‰∏≠ÂàÜÁ¶ªÂá∫Êù•ÁöÑÈÉ®ÂàÜI/OÂäüËÉΩÔºåÂÆÉ‰∏éPFÁõ∏ÂÖ≥ËÅîÔºåÊã•ÊúâÂ±û‰∫éËá™Â∑±ÁöÑ‰∏ÄÁªÑÁî®‰∫éÊï∞ÊçÆ‰∫§‰∫íÁöÑËµÑÊ∫ê„ÄÇËøô‰∫õËµÑÊ∫êÂåÖÊã¨Áî®‰∫éÊï∞ÊçÆ‰º†ËæìÁöÑÂÜÖÂ≠òÂú∞ÂùÄÁ©∫Èó¥„ÄÅ‰∏≠Êñ≠‰ª•ÂèäI/OÁ´ØÂè£Á≠âÔºåËøô‰∫õËµÑÊ∫ê‰ºöËÆ∞ÂΩïÂú®VF‰∏ìÂ±ûÁöÑÈÖçÁΩÆÁ©∫Èó¥‰∏≠„ÄÇ</li>
</ul>
<p>Âú®SR-IOVÊ†áÂáÜ‰∏ãÔºåHypervisorÊàñËÄÖÊüê‰∏ÄÁâπÊùÉËôöÊãüÊú∫ÈÄöËøáË∞ÉÁî®PFÈ©±Âä®ÔºåÂºÄÂêØËÆæÂ§áÁöÑSR-IOVÂäüËÉΩÔºåÂπ∂ÂàõÂª∫ÂíåÁÆ°ÁêÜÂ§ö‰∏™VFËÆæÂ§á„ÄÇ‰πãÂêé‰ΩøÁî®Á±ª‰ºº‰∫éÁõ¥ÈÄöËÆøÈóÆÁöÑÊ®°ÂºèÔºåÂ∞ÜVFËÆæÂ§áÂàÜÈÖçÁªôÂÖ∂‰ªñËôöÊãüÊú∫„ÄÇËôöÊãüÊú∫Êó†È°ªÈÄöËøáHypervisorÊèê‰æõËôöÊãüËÆæÂ§áÊù•ËÆøÈóÆI/OËÆæÂ§áÔºåÂèØ‰ª•ÈÄöËøáPIO„ÄÅMMIO„ÄÅDMAÁ≠âÊñπÂºèÁõ¥Êé•‰∏éVF‰∫§‰∫í„ÄÇ</p>
<p>Âú®Á≥ªÁªüÂêØÂä®Êó∂ÔºåÁâ©ÁêÜBIOS‰ºöËá™Ë°å‰∏∫VFÂàÜÈÖçÈÖçÁΩÆÁ©∫Èó¥Âπ∂ÂàùÂßãÂåñÔºåÂπ∂Â∞ÜÂàÜÈÖçÁªôËÆæÂ§áÁöÑÂÜÖÂ≠òÂú∞ÂùÄ„ÄÅI/OÁ´ØÂè£Âú∞ÂùÄËÆ∞ÂΩïÂú®BAR‰∏≠„ÄÇÂá∫‰∫éÂÆâÂÖ®ÊÄßÂíåÈöîÁ¶ªÊÄßÁ≠âÊñπÈù¢ÁöÑËÄÉËôëÔºåÂÆ¢Êà∑Êú∫Âπ∂‰∏çËÉΩÁõ¥Êé•‰ΩøÁî®BAR‰∏≠‰øùÂ≠òÁöÑHPAÔºå‰πü‰∏çËÉΩÁõ¥Êé•‰øÆÊîπVFÈÖçÁΩÆÁ©∫Èó¥„ÄÇHypervisorÈúÄË¶Å‰∏∫ÂÆ¢Êà∑Êú∫Êèê‰æõËôöÊãüÁöÑVFÈÖçÁΩÆÁ©∫Èó¥ÔºåÂ∞ÜÈÖçÁΩÆÁ©∫Èó¥ÁöÑÂú∞ÂùÄ‰ø°ÊÅØÊõøÊç¢‰∏∫GPAÔºåÂêåÊó∂Âª∫Á´ãÂπ∂Áª¥Êä§GPAÂà∞HPAÁöÑÊò†Â∞ÑË°®„ÄÇ<strong>Hypervisor‰ºöÊà™Ëé∑ÂÆ¢Êà∑Êú∫ÂØπVFÁöÑËÆøÈóÆËØ∑Ê±ÇÔºåÁÑ∂ÂêéÊ†πÊçÆGPA‰∏éHPAÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÂÆö‰ΩçÂà∞ÂÆûÈôÖÁöÑÂú∞ÂùÄÁ©∫Èó¥ÊâßË°å„ÄÇ</strong></p>
<h1 id="3-qemukvmËôöÊãüËÆæÂ§áÁöÑÂÆûÁé∞">3 QEMU/KVMËôöÊãüËÆæÂ§áÁöÑÂÆûÁé∞
</h1><p>Êú¨ËäÇÂ∞Ü‰ª•QEMU/KVM‰∏∫Âü∫Á°ÄÔºåÊ∑±ÂÖ•‰ª£Á†ÅÂ±ÇÈù¢‰ªãÁªçI/OËôöÊãüÂåñÂú®Hypervisor‰∏≠ÁöÑÂÆûÁé∞„ÄÇ</p>
<p>Êú¨ËäÇÈÄâÊã©MasarykÂ§ßÂ≠¶ÁºñÂÜôÁöÑeduËÆæÂ§á‰Ωú‰∏∫Á§∫‰æãÔºåeduËÆæÂ§áÂ±û‰∫éPCIËÆæÂ§áÔºåËÆæÂ§áÊ∫ê‰ª£Á†Å‰Ωç‰∫éQEMUÁöÑ <code>/hw/misc</code> Ë∑ØÂæÑ‰∏ã„ÄÇ**eduËÆæÂ§áÁªìÊûÑÊØîËæÉÁÆÄÂçïÔºåÂπ∂‰∏î‰∏ç‰∏éÂÆûÈôÖÁöÑÁâ©ÁêÜËÆæÂ§á‰∫§‰∫íÔºåÊòØ‰∏Ä‰∏™Á∫ØÁ≤πÁöÑ ‚ÄúËôöÊãü‚Äù ËÆæÂ§áÔºå**‰ΩÜÂÆÉÁöÑÂäüËÉΩËæÉ‰∏∫ÂÖ®Èù¢Ôºå‰ª•ËØ•ËÆæÂ§á‰∏∫‰æãËÉΩÂ§üÊ∏ÖÊô∞Âú∞Â±ïÁ§∫Âú®QEMU‰∏≠ÂÆûÁé∞‰∏Ä‰∏™ËôöÊãüËÆæÂ§áÁöÑÊï¥‰∏™ËøáÁ®ã„ÄÇ</p>
<p>Êú¨ËäÇÁöÑËÆ≤Ëß£ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<blockquote>
<ol>
<li>È¶ñÂÖà‰ºöÈÄöËøáÊèèËø∞QEMU‰∏≠ÁöÑ<strong>QOM</strong>ÔºàQEMU Object ModelÔºåQEMUÂØπË±°Ê®°ÂûãÔºâÊú∫Âà∂Êù•Â±ïÁ§∫eduËÆæÂ§áÂØπË±°ÁöÑÊ≥®ÂÜå‰∏éÂàõÂª∫ËøáÁ®ãÔºõ</li>
<li>‰πãÂêé‰ºö‰ªãÁªç<strong>‰∏ªÊùøËäØÁâáÁöÑÊ®°ÊãüÂíåPCIÊÄªÁ∫øÁªìÊûÑÁöÑÂàõÂª∫‰∏éÂàùÂßãÂåñËøáÁ®ãÔºõ</strong></li>
<li>ÁÑ∂Âêé‰ªãÁªç<strong>PIOÂíåMMIO</strong>Âú®QEMU‰∏≠ÁöÑÂ§ÑÁêÜËøáÁ®ãÔºõ</li>
<li>ÊúÄÂêéÔºåÊàë‰ª¨Â∞Ü‰ª•ÂÆûÈ™åÁöÑÂΩ¢Âºè**‰∏∫eduËÆæÂ§áÁºñÂÜôÈÖçÂ•óÁöÑËÆæÂ§áÈ©±Âä®Ôºå**Êù•Â±ïÁ§∫Âú®QEMU‰∏≠Â¶Ç‰ΩïÊ®°Êãü‰∏Ä‰∏™ËôöÊãüPCIËÆæÂ§áÔºåÂåÖÊã¨Ê®°ÊãüËôöÊãüËÆæÂ§áÁöÑËÆøÈóÆÊé•Âè£„ÄÅÂÆûÁé∞ËÆæÂ§áDMA‰ª•ÂèäËá™ÂÆö‰πâÁöÑËÆæÂ§áÂäüËÉΩ„ÄÅÂÆåÊàêËÆæÂ§á‰∏≠Êñ≠ÂèëÈÄÅÁ≠âËøáÁ®ã„ÄÇ</li>
</ol>
</blockquote>
<h2 id="31-qemuÂØπË±°Ê®°Âûã">3.1 QEMUÂØπË±°Ê®°Âûã
</h2><p>Âú®QEMU/KVMÊû∂ÊûÑ‰∏≠ÔºåQEMUÂú®Êï¥‰∏™Êû∂ÊûÑ‰∏≠‰Ωú‰∏∫‰∏Ä‰∏™Áî®Êà∑ÊÄÅËøõÁ®ãËøêË°åÂú®VMXÊ†πÊ®°ÂºèÁöÑRing3ÁâπÊùÉÁ∫ßÔºå**‰∏évCPUÂàõÂª∫ÂíåËÆæÂ§áÊ®°ÊãüÁõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÁî±QEMUË¥üË¥£„ÄÇ**ÁªèËøáÂ§öÂπ¥ÁöÑÂèëÂ±ïÔºåQEMUËÉΩÂ§üÊ®°ÊãüÂ§öÁßçÊû∂ÊûÑÁöÑCPUÂíåÂ§ßÈáèÁöÑËÆæÂ§á„ÄÇ‰∏çÂêåÊû∂ÊûÑÁöÑCPU‰πãÈó¥‰ª•ÂèäÂêåÁßçÊû∂ÊûÑ‰∏çÂêåÂûãÂè∑CPU‰πãÈó¥Êã•ÊúâÈÄöÁî®Â±ûÊÄßÂêåÊó∂‰πüÊúâËá™Ë∫´ÁöÑÁâπÊÄß„ÄÇÂØπ‰∫éËÆæÂ§áÊù•ËØ¥‰πüÂ≠òÂú®ËøôÁßçÊÉÖÂÜµ„ÄÇ‰æãÂ¶ÇÁΩëÂç°‰Ωú‰∏∫‰∏ÄÁßçPCIËÆæÂ§áÔºåÊã•ÊúâËá™Â∑±ÁöÑÂäüËÉΩÔºå‰πüÈÅµÂæ™PCIÈÄöÁî®Ê†áÂáÜÔºåÂêåÊ†∑PCIËÆæÂ§á‰πüÂ±û‰∫éËÆæÂ§áÁöÑ‰∏ÄÁßçÁ±ªÂà´„ÄÇ</p>
<blockquote>
<p>ÁÜüÊÇâÈù¢ÂêëÂØπË±°ÁºñÁ®ãËØ≠Ë®ÄÁöÑÊúãÂèãÂ∫îËØ•‰ºöÊÉ≥Âà∞ËøôÁßçÊÉÖÂÜµÈÄÇÂêàÈù¢ÂêëÂØπË±°ÁöÑÊÄùÊÉ≥ÔºåÂèØ‰ª•Â∞Ü‰∏çÂêåÁ±ªÂûãËÆæÂ§á‰πãÈó¥ÁöÑÂÖ±ÊÄßÊäΩË±°Êàê‰∏Ä‰∏™ËÆæÂ§áÁà∂Á±ªÔºåÊüê‰∏ÄÁ±ªËÆæÂ§áÂêåÊó∂‰πüÊòØÁâπÂÆöËÆæÂ§áÁöÑÁà∂Á±ª„ÄÇ</p>
</blockquote>
<p>CËØ≠Ë®ÄÊú¨Ë∫´Âπ∂‰∏çÊîØÊåÅÈù¢ÂêëÂØπË±°ÔºåÊó©ÊúüQEMUÁöÑÊØèÁßçËÆæÂ§áÈÉΩÊúâ‰∏çÂêåÁöÑË°®Á§∫ÊñπÂºèÔºåÊó†Ê≥ïÂà©Áî®‰∏çÂêåËÆæÂ§á‰πãÈó¥ÁöÑÂÖ±ÊÄßÔºåÂØºËá¥‰ª£Á†ÅÊ∑∑‰π±‰∏îÂÜó‰Ωô„ÄÇ‰∏∫‰∫ÜÊîπÂèòËøô‰∏ÄÊÉÖÂÜµÔºåQEMUÊé®Âá∫‰∫ÜQOM„ÄÇ‰ªéÊüêÁßçÁ®ãÂ∫¶‰∏äÊù•ËØ¥Ôºå**QOM‰πüÂèØ‰ª•Áúã‰ΩúQEMUÂú®CËØ≠Ë®ÄÁöÑÂü∫Á°Ä‰∏äÂÆûÁé∞ÁöÑ‰∏ÄÂ•óÈù¢ÂêëÂØπË±°Êú∫Âà∂Ôºå**Ë¥üË¥£Â∞ÜCPU„ÄÅÂÜÖÂ≠ò„ÄÅÊÄªÁ∫ø„ÄÅËÆæÂ§áÁ≠âÈÉΩÊäΩË±°‰∏∫ÂØπË±°ÔºåÂÖ∂‰∏≠ÊÄªÁ∫øÂíåËÆæÂ§áÊ®°ÊãüÂç†‰∫ÜÂæàÂ§ßÁöÑÊØîÈáç„ÄÇÊâÄ‰ª•Âú®ËÆ≤ÊÄªÁ∫øÂíåËÆæÂ§áÂàùÂßãÂåñ‰πãÂâçÔºåÈ¶ñÂÖà‰ª•eduËÆæÂ§áÂØπË±°ÁöÑÂàùÂßãÂåñ‰∏∫‰æã‰ªãÁªçQOM„ÄÇ</p>
<hr>
<p>Âú®QOM‰∏≠Ôºå‰∏ÄÁ±ªËÆæÂ§áË¢´ÊäΩË±°‰∏∫‰∏Ä‰∏™ÂØπË±°Á±ªÔºå‰∏Ä‰∏™ËÆæÂ§áÂÆû‰æãË¢´ÊäΩË±°‰∏∫‰∏Ä‰∏™ÂØπË±°ÂÆû‰æãÔºåÂØπË±°ÂíåÂØπË±°ÂÆû‰æãÂùáÂ≠òÂú®ÁªßÊâøÂÖ≥Á≥ªÔºåÂÖ∂‰∏≠ObjectClassÊòØÊâÄÊúâÂØπË±°Á±ªÁöÑÂü∫Á±ªÔºåObjectÊòØÊâÄÊúâÂØπË±°ÂÆû‰æãÁöÑÂü∫ÂØπË±°ÔºåÊúâÁÇπÁ±ª‰ºº‰∫éC++‰∏≠ÁöÑÁ±ªÂíåÂØπË±°„ÄÇ</p>
<p>Èô§‰∫Ü‰∏äËø∞ÂØπË±°Á±ªÂíåÂØπË±°ÂÆû‰æãÂ§ñÔºåQOMÂØπË±°ÂàùÂßãÂåñËøòÊ∂âÂèäTypeInfoÂíåTypeImpl‰∏§‰∏™Êï∞ÊçÆÁªìÊûÑ„ÄÇTypeInfoÊòØÂØπÂØπË±°Á±ªÁöÑÊèèËø∞ÔºåÂæÄÂæÄÂåÖÂê´Á±ªÂêç„ÄÅÁà∂Á±ªÂêç„ÄÅÁ±ªÂàùÂßãÂåñÂáΩÊï∞„ÄÅÁ±ªÂÆû‰æãÂ§ßÂ∞èÁ≠âÊèèËø∞ÊÄß‰ø°ÊÅØ„ÄÇTypeImplÁî±TypeInfoÊ≥®ÂÜåÂæóÂà∞ÔºåÂ≠òÂÇ®Âú®ÂÖ®Â±Ätype_table‰∏≠„ÄÇTypeImpl‰∏éTypeInfoÊúÄÂ§ßÁöÑ‰∏çÂêåÂú®‰∫éÔºåTypeImplÊåÅÊúâÂØπÂÖ∂ÂØπË±°Á±ªÁöÑÂºïÁî®ÔºåÂõ†Ê≠§Ë¶Å‰ªéTypeInfoÂæóÂà∞ObjectClassÔºåÂøÖÈ°ªÂÖàÂ∞ÜTypeInfoËΩ¨Âåñ‰∏∫TypeImpl„ÄÇ</p>
<p>QOM‰∏≠ÂØπË±°ÁöÑÂàùÂßãÂåñÂèØÂàÜ‰∏∫ÂõõÊ≠•Ôºö<strong>‚ë†Â∞ÜTypeInfoÊ≥®ÂÜå‰∏∫TypeImplÔºõ‚ë°ÂàõÂª∫ÂØπË±°Á±ªÔºõ‚ë¢ÂàõÂª∫ÂØπË±°ÂÆû‰æãÔºõ‚ë£ÂÖ∑Áé∞ÂØπË±°ÂÆû‰æã„ÄÇ</strong></p>
<hr>
<h3 id="ËÆæÂ§áÂØπË±°Á±ªÊ≥®ÂÜå">ËÆæÂ§áÂØπË±°Á±ªÊ≥®ÂÜå
</h3><p><strong>TypeInfoÊ≥®ÂÜå‰∏∫TypeImpl</strong>ÂåÖÂê´‰∏§‰∏™Ê≠•È™§Ôºö</p>
<ol>
<li>È¶ñÂÖàÂ∞ÜTypeInfoËΩ¨Êç¢‰∏∫ModuleEntryÔºõ</li>
<li>ÁÑ∂ÂêéÈÄöËøáModuleEntryÂ≠òÂÇ®ÁöÑÂàùÂßãÂåñÂáΩÊï∞Â∞ÜTypeInfoËΩ¨Êç¢‰∏∫TypeImplÔºåÂπ∂Ê∑ªÂä†Âà∞ÂÖ®Â±Ätype_table‰∏≠„ÄÇ</li>
</ol>
<p>‰ª•eduËÆæÂ§á‰∏∫‰æãÔºåTypeInfoËΩ¨Êç¢‰∏∫ModuleEntryÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211520066.png" alt="image-20231121152025262" style="zoom:33%;" />
<p>eduËÆæÂ§á‰ª£Á†Å‰∏≠‰ºöÈùôÊÄÅÂÆö‰πâTypeInfoÔºàÂç≥ <code>edu_info</code>ÔºâÔºå<code>type_init</code> ÂáΩÊï∞ÂàôÊòØÁî±CRT (Crun-time) Ë¥üË¥£ÊâßË°å„ÄÇ</p>
<p><code>type_init</code> ÂáΩÊï∞Êé•Âèó‰∏Ä‰∏™ÂàùÂßãÂåñÂáΩÊï∞ÊåáÈíà‰Ωú‰∏∫ÂèÇÊï∞ÔºåÂàõÂª∫‰∏Ä‰∏™ModuleEntryÂ≠òÂÇ®ÂàùÂßãÂåñÂáΩÊï∞ÊåáÈíàÂèäModuleEntryÁöÑÁ±ªÂûã„ÄÇQEMU‰∏≠ÂÆö‰πâ‰∫ÜÂá†Áßç‰∏çÂêåÁ±ªÂûãÁöÑModuleEntryÁªìÊûÑ‰ΩìÔºåÂêå‰∏ÄÁßçÁ±ªÂûãÁöÑModuleEntryÈìæÊé•‰∏∫ModuleTypeListÔºåÂÖ®ÈÉ®ModuleTypeListÂàôÂ≠òÂÇ®‰∫éÂÖ®Â±ÄÊï∞ÁªÑ <code>init_type_list</code> ‰∏≠„ÄÇÁªÑÁªáÁªìÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211521448.png" alt="image-20231121152120418" style="zoom:50%;" />
<p><code>edu_info</code> Ê≥®ÂÜåÁöÑModuleEntryÂØπÂ∫îÁöÑÁ±ªÂûã‰∏∫MODULE_INIT_QOMÔºåÂÖ∂‰ΩôÁ±ªÂûãËøòÊúâMODULE_INIT_BLOCK„ÄÅMODULE_INIT_OPTSÁ≠â„ÄÇ‰∏∫edu_infoÊ≥®ÂÜåÂØπÂ∫îÁöÑMod-uleEntryÂêéÔºåÈÄöËøá <code>module_call_init</code> ÂáΩÊï∞‰æøÂèØ‰ª•Â∞Üedu_infoËΩ¨Êç¢‰∏∫TypeImplÔºåÊï¥‰∏™ÂáΩÊï∞ÁöÑË∞ÉÁî®ÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211523394.png" alt="image-20231121152309536" style="zoom:50%;" />
<p><code>module_call_init</code> ÂáΩÊï∞ÈÅçÂéÜModuleTypeList‰∏≠ÁöÑModuleEntryÂπ∂ÊâßË°åÂÖ∂Â≠òÂÇ®ÁöÑÂàùÂßãÂåñÂáΩÊï∞„ÄÇÂØπ‰∫éedu_infoËÄåË®ÄÔºåÂÖ∂ÂØπÂ∫îÁöÑÂàùÂßãÂåñÂáΩÊï∞Â∞±ÊòØ<code>type_init</code> ÂáΩÊï∞‰º†ÂÖ•ÁöÑÂáΩÊï∞ÊåáÈíàÔºåÂç≥ <code>type_register_static(&amp;edu_info)</code> ÂáΩÊï∞„ÄÇ</p>
<p><code>type_register_static</code> ÂáΩÊï∞ÈÄöËøá <code>type_register</code> Ë∞ÉÁî® <code>type_register_internal</code> ÂáΩÊï∞Ê≥®ÂÜåeduËÆæÂ§áÁöÑTypeInfo„ÄÇtype_register_internalÂáΩÊï∞Ë∞ÉÁî® <code>type_new</code> ÂáΩÊï∞Â∞ÜTypeInfoËΩ¨Êç¢‰∏∫TypeImplÔºåÂπ∂Ë∞ÉÁî® <code>type_table_add</code> ÂáΩÊï∞Â∞ÜÂæóÂà∞ÁöÑTypeImplÊ∑ªÂä†Âà∞ÂÖ®Â±ÄÁöÑ <code>type_table</code> ‰∏≠„ÄÇ</p>
<hr>
<h3 id="ËÆæÂ§áÂØπË±°Á±ªÂàõÂª∫">ËÆæÂ§áÂØπË±°Á±ªÂàõÂª∫
</h3><p>ÂÆåÊàêeduËÆæÂ§áÂØπË±°Á±ªÊ≥®ÂÜå‰πãÂêéËøòÈúÄË¶ÅÂàõÂª∫ËØ•ÂØπË±°Á±ª„ÄÇÂàõÂª∫ÂØπË±°Á±ªÊúâ‰∏§ÁßçÊñπÂºèÔºö</p>
<ol>
<li>‰∏ÄÁßçÊòØ‰∏ªÂä®Ë∞ÉÁî® <code>object_class_get_list</code> Êé•Âè£ÂáΩÊï∞ÔºåÊØîÂ¶Ç <code>object_class_get_list(TYPE_DEVICE,false)</code> ÂáΩÊï∞ÔºåÂàõÂª∫TYPE_DEVICEÁ±ªÂûãÁöÑObjectClassÔºõ</li>
<li>Âè¶‰∏ÄÁßçÊòØË¢´Âä®Ë∞ÉÁî®ÔºåÂ¶Ç <code>object_class_by_name</code> ÂáΩÊï∞„ÄÅ<code>object_class_get_parent</code>ÂáΩÊï∞„ÄÅ<code>object_new_with_type</code>ÂáΩÊï∞Ôºå<code>object_initialize_with_type</code> ÂáΩÊï∞„ÄÇ</li>
</ol>
<p>Êó†ËÆ∫ÊòØ‰∏ªÂä®Ë∞ÉÁî®ËøòÊòØË¢´Âä®Ë∞ÉÁî®Ôºå<strong>Ëøô‰∫õÊé•Âè£ÊúÄÁªàÈÉΩ‰ºöË∞ÉÁî® <code>type_initialize</code> ÂáΩÊï∞Ôºå</strong><code>type_initialize</code> ÁöÑË∞ÉÁî®ËøáÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211528763.png" alt="image-20231121152541705" style="zoom:50%;" />
<p><code>type_initialize</code> ÂáΩÊï∞Êé•Âèó‰∏Ä‰∏™TypeImplÁªìÊûÑ‰Ωì‰Ωú‰∏∫ÂèÇÊï∞Ôºå‰ª£Á†ÅÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>È¶ñÂÖà‰∏∫ËØ•TypeImplÂØπÂ∫îÁöÑÂØπË±°Á±ªÂàÜÈÖçÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂπ∂Â∞ÜTypeImplÁöÑclassÊàêÂëòÊåáÂêëËØ•ÂÜÖÂ≠òÂå∫ÂüüÔºõ</li>
<li>ÁÑ∂ÂêéË∞ÉÁî® <code>type_get_parent</code> ÂáΩÊï∞Ëé∑ÂèñÂÖ∂Áà∂ÂØπË±°Á±ªÁöÑTypeImplÔºõ<code>type_get_parent</code> ÂáΩÊï∞ÊúÄÂêé‰ºöË∞ÉÁî® <code>type_get_by_name</code> ÂáΩÊï∞ÔºåËÄåÂâçÈù¢ÊèêÂà∞<code>type_get_by_name</code> ÂáΩÊï∞ÊúÄÁªà‰πü‰ºöË∞ÉÁî® <code>type_initialize</code> ÂáΩÊï∞Ôºå‰ªéËÄåÂÆûÁé∞ÂØπÁà∂Á±ªÁöÑÂàùÂßãÂåñ„ÄÇ<strong>ËøôÊ†∑Â∞±ÂΩ¢Êàê‰∫ÜÈÄíÂΩíË∞ÉÁî®ÔºåÈÄêÁ∫ßÂêë‰∏äÂàùÂßãÂåñÁà∂ÂØπË±°Á±ªÔºåÁõ¥Ëá≥Âà∞ËææÊ†πÂØπË±°Á±ªObjectClassÔºõ</strong></li>
<li><code>type_initialize</code> ÂáΩÊï∞ÈöèÂêéË∞ÉÁî® <code>memcpy</code> ÂáΩÊï∞Â∞ÜÁà∂ÂØπË±°Á±ªÂ§çÂà∂Âà∞ÂÖ∂ÂÜÖÂ≠òÁ©∫Èó¥ÁöÑÂâçÈù¢ÔºåËøôÊ†∑Âè™Ë¶ÅÁü•ÈÅìÁà∂ÂØπË±°Á±ªÂíåÂ≠êÂØπË±°Á±ªÁöÑÂ§ßÂ∞èÔºåÂ∞±ÂèØ‰ª•ËΩªÊùæÂÆûÁé∞Áà∂Á±ªÂíåÂ≠êÁ±ª‰πãÈó¥ÁöÑËΩ¨Êç¢Ôºõ</li>
<li>ÊúÄÂêé <code>type_initialize</code> ÂáΩÊï∞Â∞ÜË∞ÉÁî®Áà∂Á±ªÁöÑ <code>class_base_init</code> ÂáΩÊï∞ÂíåËØ•TypeImplÁöÑ <code>class_init</code> ÂáΩÊï∞ËøõË°åÂàùÂßãÂåñ„ÄÇedu_infoÂÆö‰πâeduÂØπË±°Á±ªÁöÑ <code>class_init</code> ÂáΩÊï∞‰∏∫ <code>edu_class_init</code> ÂáΩÊï∞„ÄÇ</li>
</ol>
<p><code>edu_class_init</code> ÂáΩÊï∞ËÆæÁΩÆ‰∫ÜeduËÆæÂ§áÁöÑrealizeÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Áî®‰∫é‰∏ãÊñáÊèêÂà∞ÁöÑeduÂØπË±°ÂÆû‰æãÂÖ∑Áé∞ÂåñÔºåÂêåÊó∂ËøòËÆæÁΩÆ‰∫ÜeduËÆæÂ§áÁöÑÂéÇÂïÜÂè∑‰∏éËÆæÂ§áÂè∑Á≠âËÆæÂ§áÂ±ûÊÄß„ÄÇ<code>edu_class_init</code> ÂáΩÊï∞ÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211528957.png" alt="image-20231121152629444" style="zoom:33%;" />
<hr>
<h3 id="ËÆæÂ§áÂØπË±°ÂÆû‰æãÂàõÂª∫">ËÆæÂ§áÂØπË±°ÂÆû‰æãÂàõÂª∫
</h3><p>QOMÂ∞Ü‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑËÆæÂ§áÊäΩË±°‰∏∫‰∏Ä‰∏™ÂØπË±°ÂÆû‰æãÔºåÊØè‰∏™ÂØπË±°ÂÆû‰æãÈÉΩÂØπÂ∫î‰∏Ä‰∏™ <code>XXXState</code> ÁªìÊûÑ‰ΩìÔºåËÆ∞ÂΩïËÆæÂ§áËá™Ë∫´‰ø°ÊÅØ„ÄÇÂú®eduËÆæÂ§áÊ∫êÁ†Å‰∏≠ÂÆö‰πâ‰∫ÜeduËÆæÂ§áÂØπË±°ÁöÑÁªìÊûÑ‰ΩìEduStateÔºåEduState‰∏≠ÂåÖÂê´MMIOÂÜÖÂ≠òÂå∫Âüü‰ø°ÊÅØ„ÄÅËÆæÂ§áÁä∂ÊÄÅ„ÄÅ‰∏≠Êñ≠ËøîÂõûÁä∂ÊÄÅ„ÄÅDMAÁõ∏ÂÖ≥‰ø°ÊÅØÁ≠âÂ±ûÊÄß„ÄÇÂÆö‰πâEduStateÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211527799.png" alt="image-20231121152735918" style="zoom:33%;" />
<p>**ÂØπË±°ÂÆû‰æã‰∏éÂØπË±°Á±ªÁ±ª‰ººÔºå‰πüÂ≠òÂú®ÁªßÊâøÂÖ≥Á≥ªÔºå**ObjectÊï∞ÊçÆ‰ΩìÊòØÊâÄÊúâÂØπË±°ÂÆû‰æãÁöÑÊ†πÂØπË±°ÂÆû‰æã„ÄÇÂÆö‰πâObjectÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/include/qom/object.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211531175.png" alt="image-20231121153127362" style="zoom:33%;" />
<p>Ê†πÊçÆ‰∏äËø∞ÂÆö‰πâÔºåÂØπË±°ÂÆû‰æãÊåÅÊúâÂØπÂÖ∂ÊâÄËø∞ÂØπË±°Á±ªÁöÑÂºïÁî®„ÄÇÂõ†Ê≠§Âú®ÂàõÂª∫ÂØπË±°ÂÆû‰æãÊó∂ÔºåÈúÄË¶ÅÂàõÂª∫Áõ∏Â∫îÁöÑÂØπË±°Á±ªÔºå‰πüÂ∞±ÊòØ‰∏äÊñáÊèêÂà∞ÁöÑË¢´Âä®ÂàõÂª∫ÂØπË±°Á±ª„ÄÇÂú®ÂÆåÊàêeduËÆæÂ§áÂØπË±°Á±ªÁöÑÂàùÂßãÂåñÂêéÔºåQEMUÂ∑≤ÁªèËÉΩÂ§üÂàõÂª∫eduËÆæÂ§áÂØπË±°ÂÆû‰æã„ÄÇ‰∏ÄËà¨ÁöÑÂÅöÊ≥ïÊòØÂú®QEMUÂêØÂä®ÂëΩ‰ª§Ë°å‰∏≠Ê∑ªÂä† <code>-device edu</code> ÂèÇÊï∞„ÄÇQEMUÂú®Ê£ÄÊü•Âà∞ËØ•ÂèÇÊï∞ÂêéÔºå‰ºöË∞ÉÁî® <code>qdev_device_add</code> ÂáΩÊï∞Ê∑ªÂä†eduËÆæÂ§á„ÄÇ</p>
<p>Áî®‰∫éÂàõÂª∫ÂØπË±°ÂÆû‰æãÁöÑÊé•Âè£ÂåÖÊã¨ <code>object_new</code> ÂáΩÊï∞Âíå <code>object_new_with_props</code> ÂáΩÊï∞ÔºåÂÆÉ‰ª¨ÊúÄÁªàÈÉΩ‰ºöË∞ÉÁî® <code>object_new_with_type</code> ÂáΩÊï∞Ôºå<code>qdev_device_add</code> ÂáΩÊï∞‰ΩøÁî®ÁöÑÊòØ <code>object_new</code> Êé•Âè£ÂáΩÊï∞„ÄÇ<code>object_new_with_type</code> ÂáΩÊï∞ÁöÑË∞ÉÁî®Ë∑ØÂæÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211531688.png" alt="image-20231121153057611" style="zoom:50%;" />
<p><code>object_new_with_type</code> ÂáΩÊï∞Êé•Êî∂eduËÆæÂ§áÁöÑTypeImplÁªìÊûÑ‰Ωì‰Ωú‰∏∫ÂèÇÊï∞Ôºå‰ª£Á†ÅÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>È¶ñÂÖàË∞ÉÁî® <code>type_initialize</code> ÂáΩÊï∞Á°Æ‰øùeduËÆæÂ§áÂØπË±°Á±ªË¢´ÂàùÂßãÂåñÔºõ</li>
<li>ÁÑ∂Âêé‰∏∫eduÂØπË±°ÂÆû‰æãÂàÜÈÖçÂ§ßÂ∞è‰∏∫ sizeof(EduState) ÁöÑÂÜÖÂ≠òÁ©∫Èó¥Ôºõ</li>
<li>ÊúÄÂêéË∞ÉÁî® <code>object_initialize_with_type</code> ÂáΩÊï∞ÂàùÂßãÂåñÂØπË±°ÂÆû‰æã„ÄÇ
<ul>
<li><code>object_initialize_with_type</code> ÂáΩÊï∞È¶ñÂÖà‰∏∫EduState‰∏≠ÁöÑÂ±ûÊÄßÂàÜÈÖçHashË°®Ôºõ</li>
<li>ÁÑ∂ÂêéË∞ÉÁî® <code>object_init_with_type</code> ÂáΩÊï∞„ÄÇ
<ul>
<li><code>object_init_with_type</code> ÂáΩÊï∞È¶ñÂÖàÂà§Êñ≠ËØ•ÂÆû‰æãÂØπË±°ÊòØÂê¶ÊúâÁà∂ÂÆû‰æãÂØπË±°ÔºåËã•ÊúâÔºåÂàôÈÄíÂΩíË∞ÉÁî®<code>object_init_with_type</code> ÂáΩÊï∞ÂØπÂÖ∂Áà∂ÂÆû‰æãÂØπË±°ËøõË°åÂàùÂßãÂåñÔºõ</li>
<li>ÊúÄÂêéË∞ÉÁî®TypeImplÁöÑ <code>instance_init</code> ÂáΩÊï∞„ÄÇTypeImpl‰∏≠ÁöÑ <code>instance_init</code> ÂáΩÊï∞Âú®TypeInfoÊ≥®ÂÜå‰∏∫TypeImplÊó∂ËÆæÁΩÆÔºåeduËÆæÂ§áÂú®edu_info‰∏≠Â∞ÜËØ•ÂáΩÊï∞ËÆæÁΩÆ‰∏∫ <code>edu_instance_init</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Â∞ÜÂàùÂßãÂåñEduStateÂπ∂ËÆæÁΩÆeduËÆæÂ§áÁöÑDMAÊé©Á†Å„ÄÇeduËÆæÂ§áÁöÑDMAÊé©Á†ÅÈªòËÆ§‰∏∫28‰ΩçÔºåÂç≥Âè™ÊîØÊåÅ256MBÂú∞ÂùÄËåÉÂõ¥„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><code>edu_instance_init</code> ÂáΩÊï∞ÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211532507.png" alt="image-20231121153229127" style="zoom:33%;" />
<p>ÂâçÈù¢ÊèêÂà∞ÔºåÊâÄÊúâÂØπË±°ÂÆû‰æãÁöÑÊ†πÂØπË±°ÂÆû‰æãÈÉΩÊòØObjectÔºåÂêÑÂØπË±°ÂÆû‰æã‰πãÈó¥ÁöÑÁªßÊâøÂÖ≥Á≥ªÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÊ≠§Â§Ñ‰ªÖÂàóÂá∫ÂÆÉ‰ª¨ÁöÑÁ±ªÂûãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211533606.png" alt="image-20231121153301999" style="zoom: 50%;" />
<hr>
<h3 id="ËÆæÂ§áÂØπË±°ÂÆû‰æãÂÖ∑Áé∞Âåñ">ËÆæÂ§áÂØπË±°ÂÆû‰æãÂÖ∑Áé∞Âåñ
</h3><p>Ê≠§Êó∂Â∑≤ÁªèÂàõÂª∫‰∫ÜeduËÆæÂ§áÂØπË±°ÂÆû‰æãÂπ∂Ë∞ÉÁî®‰∫ÜÂÆû‰æãÂàùÂßãÂåñÂáΩÊï∞ <code>edu_instance_init</code>Ôºå‰ΩÜÁî±‰∫éÊ≠§Êó∂EduStateÈáåÁöÑÂ±ûÊÄßÂπ∂Êú™ÂàÜÈÖçÔºåÊâÄ‰ª•Âπ∂‰∏çËÉΩÁ´ãÂç≥‰ΩøÁî®ÔºåÂøÖÈ°ªÂÖ∑Áé∞ÂåñËØ•ÂØπË±°ÂÆû‰æã„ÄÇ</p>
<blockquote>
<p>ÊâÄË∞ìÂÖ∑Áé∞ÂØπË±°ÂÆû‰æãÊòØÊåáË∞ÉÁî®ËÆæÂ§áÂØπË±°ÂÆû‰æãÁöÑrealizeÂáΩÊï∞ÔºàÂ¶ÇÂàõÂª∫‰∏Ä‰∏™Á£ÅÁõòËÆæÂ§áÂØπË±°ÂÆû‰æãÔºâÂêéÔºåÂÆÉ‰ªç‰∏çËÉΩ‰ΩøÁî®Ôºå<strong>Âè™ÊúâÂú®realizeÂáΩÊï∞‰∏≠Â∞ÜÂÖ∂ÊåÇËΩΩÂà∞ÊÄªÁ∫ø‰∏äÂêéÔºåÁõ∏Â∫îÁöÑI/OÊåá‰ª§ÊâçËÉΩÁúüÊ≠£ËÆøÈóÆÂà∞ËØ•ËÆæÂ§á„ÄÇ</strong></p>
</blockquote>
<p>Ê≠§Â§Ñ‰ªç‰ª•eduËÆæÂ§á‰∏∫‰æãËøõË°åËØ¥ÊòéÔºåTYPE_DEVICEÁ±ªÂûãÁöÑÂØπË±°ÂÆû‰æãÂØπÂ∫îÁöÑTypeInfoÁªìÊûÑ‰Ωì‰∏∫ <code>device_type_info</code>ÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/core/qdev.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211536302.png" alt="image-20231121153348502" style="zoom:33%;" />
<p>Ê†πÊçÆ‰∏äËø∞ÂÆö‰πâÔºåËÆæÂ§áÂØπË±°ÂÆû‰æãÂØπÂ∫îÁöÑÁªìÊûÑ‰Ωì‰∏∫DeviceStateÔºåÂÆÉÁöÑ <code>instance_init</code> ÂáΩÊï∞‰∏∫ <code>device_initfn</code> ÂáΩÊï∞„ÄÇÂâçÈù¢ÊèêÂà∞ÂàõÂª∫ÂØπË±°ÂÆû‰æãÊó∂‰ºöÈÄêÁ∫ßÂêë‰∏äÈÄíÂΩíË∞ÉÁî®ÂÖ∂Áà∂Á±ªÂûãÁöÑ <code>instance_init</code> ÂáΩÊï∞ÔºåÊâÄ‰ª•Âú®ÂàõÂª∫eduËÆæÂ§áÂØπË±°ÂÆû‰æãÊó∂‰ºöË∞ÉÁî® <code>device_initfn</code> ÂáΩÊï∞„ÄÇ</p>
<p><code>device_initfn</code> ÂáΩÊï∞Âàô‰ºöË∞ÉÁî® <code>object_property_add_bool</code> ÂáΩÊï∞‰∏∫ËÆæÂ§áÂØπË±°ÂÆû‰æãÊ∑ªÂä†‰∏Ä‰∏™Âêç‰∏∫realizedÁöÑÂ±ûÊÄß„ÄÇ‰∏éÂ±ûÊÄßÂêç‰∏ÄÂêå‰º†ÂÖ•ÁöÑËøòÊúâ‰∏§‰∏™ÂõûË∞ÉÂáΩÊï∞Ôºå<code>device_get_realized</code> ÂáΩÊï∞Âíå <code>device_set_realized</code> ÂáΩÊï∞ÔºåÂÆÉ‰ª¨ÂàÜÂà´‰∏∫realizedÂ±ûÊÄßÁöÑ <code>getter/setter</code> ÂáΩÊï∞„ÄÇ</p>
<p>Ëã•ÂêéÁª≠Ë∞ÉÁî® <code>object_property_get_bool/object_property_set_bool</code> ÂáΩÊï∞ËØªÂèñ/ËÆæÁΩÆrealizedÂ±ûÊÄßÊó∂ÊúÄÁªà‰ºöË∞ÉÁî®Âà∞<code>device_get_realized/device_set_realized</code> ÂáΩÊï∞Ôºå<code>device_set_realized</code> ÂáΩÊï∞Âàô‰ºöË∞ÉÁî®DeviceState‰∏≠Â≠òÂÇ®ÁöÑrealizeÊàêÂëò„ÄÇ**Âõ†Ê≠§ÊØèÊ¨°Ë∞ÉÁî®<code>object_set_property_bool</code> ËÆæÁΩÆrealizedÂ±ûÊÄßÊó∂‰ºöËß¶ÂèëËÆæÂ§áÁöÑrealizeÂõûË∞É„ÄÇ**ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/core/qdev.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211537565.png" alt="image-20231121153657609" style="zoom:33%;" />
<p>‰∏çÂêåËÆæÂ§áÂØπË±°ÂÆû‰æãÂØπÂ∫îÁöÑrealizeÂáΩÊï∞‰∏çÂêåÔºå‰∏äÊñáÊèêÂà∞ÔºåeduËÆæÂ§áÂØπË±°ÂÆû‰æãÂú®ÂÖ∂Á±ªÂÆû‰æãÂàùÂßãÂåñÂáΩÊï∞ <code>edu_class_init</code> ‰∏≠Â∞ÜrealizeÂáΩÊï∞ËÆæÁΩÆ‰∏∫<code>pci_edu_realize</code> ÂáΩÊï∞„ÄÇÂú®Ê≠§ÁÆÄË¶Å‰ªãÁªçËØ•ÂáΩÊï∞ÁöÑÂäüËÉΩ„ÄÇ<code>pci_edu_realize</code> ÂáΩÊï∞ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211536857.png" alt="image-20231121153553028" style="zoom:33%;" />
<p><code>pci_edu_realize</code> ÂáΩÊï∞‰ºöÂàùÂßãÂåñeduËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑÈÉ®ÂàÜÊï∞ÊçÆÂπ∂ËÆæÁΩÆËÆæÂ§áÁöÑÂäüËÉΩÔºå‰ª£Á†ÅÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>ËØ•ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>pci_config_set_interrupt_pin</code> ÂáΩÊï∞ÔºåÂ∞ÜPCIÈÖçÁΩÆÁ©∫Èó¥‰∏≠Interrupt PinÂØÑÂ≠òÂô®(0X3D)ÁöÑÂÄºËÆæÁΩÆ‰∏∫1ÔºåËøôÊÑèÂë≥ÁùÄeduËÆæÂ§á‰ΩøÁî®INTA#ËÑöÁî≥ËØ∑‰∏≠Êñ≠Ôºõ</li>
<li>‰πãÂêéË∞ÉÁî® <code>msi_init</code> ÂáΩÊï∞ËÆæÁΩÆPCIÈÖçÁΩÆÁ©∫Èó¥‰ª•ÂºÄÂêØMSIÂäüËÉΩÔºõ</li>
<li><code>timer_init_ms</code> ÂáΩÊï∞Áî®‰∫éÊ≥®ÂÜåÂÆöÊó∂Âô®Ôºå‰∏çÈó¥Êñ≠Âú∞Êü•ÁúãÊòØÂê¶ÊúâDMA‰º†ÈÄÅÈúÄÊ±ÇÔºõ</li>
<li><code>qemu_thread_create</code> ÂáΩÊï∞Áî®‰∫éÂàõÂª∫‰∏Ä‰∏™Á∫øÁ®ãÔºåËØ•Á∫øÁ®ãÁî®‰∫éÈò∂‰πòËÆ°ÁÆóÔºåÂ±û‰∫éeduËÆæÂ§áÁöÑ‰∏Ä‰∏™ÁâπÂÆöÂäüËÉΩÔºõ</li>
<li><code>memory_region_init_io</code> ÂáΩÊï∞ÂàùÂßãÂåñ‰∏Ä‰∏™MMIOÂÜÖÂ≠òÂå∫ÂüüÔºåËØ•ÂÜÖÂ≠òÂå∫ÂüüÂ§ßÂ∞è‰∏∫1MBÔºåÂπ∂ÊåáÂÆöËØ•MMIOÂÜÖÂ≠òÂå∫ÂüüÁöÑËØªÂÜôÂáΩÊï∞edu_mmio_ops„ÄÇÂú® <code>edu_mmio_ops</code> ÂáΩÊï∞‰∏≠ÊåáÂÆö <code>edu_mmio_read/edu_mmio_write</code> ÂáΩÊï∞‰Ωú‰∏∫MMIOËØªÂÜôÂõûË∞ÉÂáΩÊï∞ÔºåËØ•ÂõûË∞ÉÂáΩÊï∞Â∞±ÊòØÂÜÖÂ≠òËôöÊãüÂåñÊñáÊ°£‰∏≠ÊèêÂà∞ÁöÑMMIOÂ§ÑÁêÜÂáΩÊï∞ÔºåË¥üË¥£Ê®°ÊãüËôöÊãüËÆæÂ§áÁöÑMMIOËÆøÈóÆÔºõ</li>
<li><code>pci_register_bar</code> ÂáΩÊï∞Êää‰∏ä‰∏ÄÊ≠•ËÆæÁΩÆÂ•ΩÁöÑMMIOÂèÇÊï∞Ê≥®ÂÜåÂà∞ËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥ÁöÑÁ¨¨0Âè∑BAR„ÄÇ</li>
</ol>
<p>Ëá≥Ê≠§eduËÆæÂ§áÁöÑÂÖ∑Áé∞Âåñ‰æøÂÆåÊàê‰∫ÜÔºåÊ≠§Êó∂Áî®Êà∑ÊàñÂÆ¢Êà∑Êú∫ÂèØ‰ª•ÈÄöËøáËÆæÂ§áÈ©±Âä®‰ΩøÁî®ËØ•ËÆæÂ§á„ÄÇ</p>
<blockquote>
<p>Êú¨ËäÇÈÄöËøáeduËÆæÂ§áËøô‰∏Ä‰æãÂ≠êÔºå‰ªãÁªç‰∫ÜQEMU‰∏≠‰ΩøÁî®ÁöÑQOMÂ∑•‰ΩúÊú∫Âà∂ÔºåÈòêËø∞‰∫Ü‰∏Ä‰∏™PCIËÆæÂ§áÂú®QEMU‰∏≠Ê≥®ÂÜåÂπ∂ÂàùÂßãÂåñÂØπË±°Á±ª„ÄÅÂàõÂª∫ÂíåÂàùÂßãÂåñÂØπË±°ÂÆû‰æã‰ª•ÂèäÊúÄÁªàÂÖ∑Áé∞ÂåñÂØπË±°ÂÆû‰æãÁöÑËøáÁ®ã„ÄÇ‰ΩÜ<strong>Êú¨ËäÇÂπ∂Êú™Ê∂âÂèä‰∏éPCIËÆæÂ§áÂú®ÊÄªÁ∫ø‰∏äÊ≥®ÂÜå</strong>Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÔºåËøôÈÉ®ÂàÜÂÜÖÂÆπ‰ºöÂú®3.2ËäÇ‰ªãÁªç„ÄÇ</p>
</blockquote>
<h2 id="32-‰∏ªÊùøËäØÁâáÁªÑ‰∏éÊÄªÁ∫øÊ®°Êãü">3.2 ‰∏ªÊùøËäØÁâáÁªÑ‰∏éÊÄªÁ∫øÊ®°Êãü
</h2><p>Âú®ËôöÊãüÊú∫ÂêØÂä®‰πãÂâçÔºåQEMU‰ºöÊ®°ÊãüÂπ∂ÂàùÂßãÂåñ‰∏ªÊùø‰∏äÁöÑËäØÁâáÁªÑÔºå‰æãÂ¶ÇÂçóÂåóÊ°•ËäØÁâá„ÄÇÂú®ÂëΩ‰ª§Ë°åËæìÂÖ• <code>qemu-system-x86_64-machine help</code>ÔºåÁªàÁ´Ø‰ºöÊòæÁ§∫QEMUÊîØÊåÅ <code>i440FX+PIIX</code> Âíå <code>Q35+ICH9</code> Ëøô‰∏§ÁßçËäØÁâáÁªÑ„ÄÇQEMUÊúÄÂàùÂè™Êèê‰æõ <code>I440FX+PIIX</code> Êû∂ÊûÑÔºåËØ•Êû∂ÊûÑËØûÁîüÂπ¥‰ª£‰πÖËøúÔºå‰∏çÊîØÊåÅPCIe„ÄÅAHCIÁ≠âÁâπÊÄßÔºå‰∏∫‰∫ÜÈ°∫Â∫îËäØÁâáÁªÑÁöÑÂèëÂ±ïÔºåJason BaronÂú®2012Âπ¥ÁöÑKVM forum‰∏ä‰∏∫QEMUÂä†ÂÖ•Q35ËäØÁâáÁªÑÊîØÊåÅ„ÄÇ</p>
<blockquote>
<p>Êú¨Êñá‰ªÖ‰ªãÁªçQEMUÈªòËÆ§ÁöÑI440FXÊû∂ÊûÑÔºåÂØπQEMU‰∏≠‰∏éQ35Êû∂ÊûÑÁõ∏ÂÖ≥ÂÜÖÂÆπÂèØ‰ª•ÈòÖËØªQEMUÊèê‰æõÁöÑÊñáÊ°£‰∏éÊ∫êÁ†Å„ÄÇ</p>
</blockquote>
<p>I440FXÊòØIntelÂÖ¨Âè∏Âú®1996Âπ¥Êé®Âá∫ÁöÑÁ¨¨‰∏ÄÊ¨æËÉΩÂ§üÊîØÊåÅPentium ‚Ö°ÁöÑ‰∏ªÊùøËäØÁâáÔºåÂÆÉÈõÜÊàê‰∫ÜÂ§öÁßçÁ≥ªÁªüÂäüËÉΩÔºåÂú®‰∏ªÊùø‰∏ä‰Ωú‰∏∫ÂåóÊ°•ÔºåË¥üË¥£‰∏é‰∏ªÊùø‰∏äÈ´òÈÄüËÆæÂ§á‰ª•ÂèäCPUÁöÑËøûÊé•„ÄÇPIIXÔºàPCI ISA IDE XceleratorÔºåÂçóÊ°•ËäØÁâáÔºâÊú¨Ë¥®‰∏äÊòØ‰∏Ä‰∏™Â§öÂäüËÉΩPCIËÆæÂ§áÔºåË¢´Áß∞‰ΩúÂçóÊ°•ÔºåPIIXÁî±I440FXÂºïÂá∫ÔºåË¥üË¥£‰∏é‰∏ªÊùø‰∏ä‰ΩéÈÄüËÆæÂ§áÁöÑËøûÊé•„ÄÇ‰∏ãÂõæ‰∏∫**QEMU‰∏≠Ê®°ÊãüÁöÑI440FX‰∏ªÊùøÊû∂ÊûÑÔºå**ËØ•ÂõæÊâÄÁ§∫ÁöÑÊû∂ÊûÑ‰∏éËäØÁâáÁªÑÂÆûÈôÖÊû∂ÊûÑÂü∫Êú¨ÂØπÂ∫îÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211836392.png" alt="image-20231121183537175" style="zoom:50%;" />
<p>I440FX‰∏≠ÁöÑPMCÔºàPCI Bridge and Memory ControllerÔºåPCIÊ°•ÂÜÖÂ≠òÊéßÂà∂Âô®ÔºâÊèê‰æõ‰∫ÜÊéßÂà∂ÂÜÖÂ≠òËÆøÈóÆÁöÑÊé•Âè£ÔºåPCI‰∏ªÊ°•Âàô‰Ωú‰∏∫ÊéßÂà∂ÂíåËøûÊé•PCIÊÄªÁ∫øÁ≥ªÁªüÁöÑPCIÊ†πÊÄªÁ∫øÊé•Âè£ÔºåÂõ†Ê≠§I440FXÂèØ‰ª•Âêë‰∏ãËøûÊé•ÂÜÖÂ≠òÂπ∂‰∏îÂèØ‰ª•ÈÄöËøáPCIÊ†πÊÄªÁ∫øÊé•Âè£Êâ©Â±ïÂá∫Êï¥‰∏™PCIËÆæÂ§áÊ†ëÔºåÂÖ∂‰∏≠PIIXÂçóÊ°•ËäØÁâá‰Ωç‰∫éPCI 0Âè∑ÊÄªÁ∫ø„ÄÇI440FXÂêåÊó∂ËøòÂèØ‰ª•ÈÄöËøáËøûÊé•HOSTÊÄªÁ∫øÂêë‰∏ä‰∏éÂ§ö‰∏™CPUÁõ∏Ëøû„ÄÇÂ¶Ç‰∏äÂõæÊâÄÁ§∫ÔºåPIIX‰Ωú‰∏∫ÂçóÊ°•ÂèØ‰ª•‰∏éIDEÊéßÂà∂Âô®„ÄÅMAÊéßÂà∂Âô®„ÄÅUSBÊéßÂà∂Âô®„ÄÅSMBusÊÄªÁ∫øÊéßÂà∂Âô®„ÄÅX-BusÊéßÂà∂Âô®„ÄÅUSBÊéßÂà∂„ÄÅPIT„ÄÅRTCÔºàReal Time ClockÔºåÂÆûÊó∂Êó∂ÈíüÔºâ„ÄÅPICËÆæÂ§áÁõ∏ËøûÔºåÂêåÊó∂PIIXËøòÊèê‰æõ‰∫ÜPCI-ISAÊ°•ÔºåÁî®‰∫éËøûÊé•ISAÊÄªÁ∫øËøõËÄåÂÆûÁé∞‰∏é‰º†ÁªüISAËÆæÂ§áÁöÑËøûÊé•„ÄÇ</p>
<hr>
<h3 id="i440fxËäØÁâáÂàùÂßãÂåñ">I440FXËäØÁâáÂàùÂßãÂåñ
</h3><p>Âú®QOMÂ∑•‰ΩúÊú∫Âà∂‰∏≠ÔºåQEMUÁöÑÊâÄÊúâËÆæÂ§áÈÉΩË¢´ÊäΩË±°‰∏∫ÂØπË±°ÔºåÂØπ‰∫éÊï¥‰∏™Êú∫Âô®Êù•ËØ¥‰πü‰∏ç‰æãÂ§ñÔºåËôöÊãüÊú∫ÂêåÊ†∑Êã•ÊúâÂ±û‰∫éËá™Â∑±ÁöÑÂØπË±°Á±ªÂûã„ÄÇÂú®QEMU‰∏≠ÂÆö‰πâ‰∫ÜÊú∫Âô®ÁöÑÂØπË±°Á±ªÂûãÔºå‰ΩøÁî® <code>MachineClass</code> Êï∞ÊçÆÁªìÊûÑË°®Á§∫„ÄÇ<code>MachineClass</code> ÁöÑÁ±ªÂà´‰∏é‰∏ªÊùøËäØÁâáÁ±ªÂûãÁõ∏ÂÖ≥ËÅîÔºåÈÄöÂ∏∏Áî±ÁâπÂÆöÁöÑÂÆèÊù•ÂÆö‰πâ„ÄÇ‰æãÂ¶Ç<code>DEFINE_Q35_MACHINE/DEFINE_I440FX_MACHINE</code> ÂàÜÂà´ÂÆö‰πâ‰∫ÜQ35‰∏ªÊùøÊû∂ÊûÑ‰∏éI440FX‰∏ªÊùøÊû∂ÊûÑÁöÑÊú∫Âô®„ÄÇ</p>
<p>‰∏ãÈù¢Â∞Ü‰ªãÁªç**I440FXÊû∂ÊûÑÂàùÂßãÂåñËøáÁ®ãÔºå**ÈÉ®ÂàÜ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/i386/pc_piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211835760.png" alt="image-20231121183343798" style="zoom:33%;" />
<p><code>DEFINE_I440FX_MACHINE</code> ÂÆèÁî±‰∏§ÈÉ®ÂàÜÁªÑÊàêÔºö</p>
<ul>
<li>È¶ñÂÖàËØ•ÂÆèÂÆö‰πâ‰∫ÜI440FXËôöÊãüÊú∫ÁöÑÂàùÂßãÂåñÂáΩÊï∞ <code>pc_init_# #suffix</code>ÔºåÂÖ∂‰∏≠suffix‰ª£Ë°®I440FXÁöÑÁâàÊú¨ÔºåËØ•ÂáΩÊï∞ÈÄöËøáË∞ÉÁî® <code>pc_init1</code> ÂáΩÊï∞Êù•ÂÆåÊàêÂØπÊï¥‰∏™ËôöÊãüÊú∫ÁöÑÂàùÂßãÂåñ„ÄÇ<code>pc_init1</code> ÂáΩÊï∞ÊòØÊï¥‰∏™ËôöÊãüÊú∫ÂàùÂßãÂåñÁöÑÊ†∏ÂøÉÔºåÊ∂µÁõñËôöÊãüÊú∫ÁöÑÊñπÊñπÈù¢Èù¢ÔºåI440FX‰∏ªÊùøËäØÁâáÁªÑÁöÑÂàùÂßãÂåñ‰πüÁî±ËØ•ÂáΩÊï∞Ë¥üË¥£„ÄÇ</li>
<li>Á¨¨‰∫åÈÉ®ÂàÜ <code>DEFINE_PC_MACHINE</code> ‰πüÊòØ‰∏Ä‰∏™ÂÆèÔºåÂú®‰∏çÂêå‰∏ªÊùøÊû∂ÊûÑÁöÑÊú∫Âô®Èó¥ÈÄöÁî®Ôºå**Ë¥üË¥£ËôöÊãüÊú∫ÂØπË±°Á±ªÂûãÁöÑÊ≥®ÂÜå‰∏éÂàùÂßãÂåñ„ÄÇ**ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ul>
<p><code>qemu-4.1.1/include/hw/i386/pc.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211834265.png" alt="image-20231121183441819" style="zoom:33%;" />
<p>ËØ•ÂÆèÁöÑÂÖ∑‰ΩìÂ∑•‰ΩúÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÂÆö‰πâ‰∫ÜËôöÊãüÊú∫ÂØπÂ∫îÁöÑTypeInfoÔºåÂç≥ <code>pc_machine_type_##suffix</code>ÔºåÂπ∂Â∞ÜÁà∂Á±ªÂûãËÆæÁΩÆ‰∏∫TYPE_PC_MACHINEÔºåÂêåÊó∂Êää <code>class_init</code> ÂáΩÊï∞ËÆæÁΩÆ‰∏∫<code>pc_machine_##suffix##_class_init</code> ÂáΩÊï∞„ÄÇËØ•ÂáΩÊï∞Ë¥üË¥£ÂàõÂª∫ËôöÊãüÊú∫ÂØπË±°Á±ªÂûãÔºåÂπ∂ÊääÁ±ªÁöÑÂàùÂßãÂåñÂáΩÊï∞ËÆæÁΩÆ‰∏∫‰∏äÊñáÊèêÂà∞ÁöÑ <code>pc_init_##suffix</code> ÂáΩÊï∞„ÄÇ</li>
<li>‰πãÂêé <code>type_init(pc_machine_init_##suffix)</code> ÂáΩÊï∞Ë¥üË¥£Ê≥®ÂÜåËôöÊãüÊú∫ÂØπË±°Á±ªÂûãÔºåÊ≥®ÂÜåÁöÑÂÖ∑‰ΩìËøáÁ®ã‰∏äÊñáÂ∑≤Áªè‰ªãÁªçÔºå‰∏çÂÜçËµòËø∞„ÄÇ</li>
</ul>
<p>Âú®ËôöÊãüÊú∫ÂàùÂßãÂåñËøáÁ®ã‰∏≠Ôºå‰πãÂâçÊèêÂà∞ÁöÑ <code>pc_init1</code> ÂáΩÊï∞‰ºöÂØπI440FX‰∏ªÊùøËøõË°åÂàùÂßãÂåñ„ÄÇÂÖ∂‰∏≠ <code>i440fx_init</code> ÂáΩÊï∞Âíå <code>piix3_create</code> ÂáΩÊï∞ÂàÜÂà´ÊòØI440FXÂåóÊ°•ËäØÁâáÂíåPIIX3ÂçóÊ°•ËäØÁâáÁöÑÂàùÂßãÂåñÂáΩÊï∞„ÄÇ<code>pc_init1</code> ÂáΩÊï∞ÁöÑÈÉ®ÂàÜ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/i386/pc_piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211836503.png" alt="image-20231121183647998" style="zoom:33%;" />
<p><code>i440fx_init</code> ÂáΩÊï∞ÈúÄË¶Å‰º†ÂÖ•Â§ö‰∏™ÂèÇÊï∞ÔºåËøôÈáå‰∏ªË¶ÅÂÖ≥Ê≥®Ââç‰∏â‰∏™ÂèÇÊï∞„ÄÇÂÖ∂‰∏≠host_type‰∏épci_typeÂèÇÊï∞ÂØπÂ∫î‰∫é <code>pc_init1</code> ÂáΩÊï∞ÁöÑÂêé‰∏§‰∏™ÂÆèÂÆö‰πâÂèÇÊï∞Ôºö</p>
<ul>
<li><code>host_type</code> ‰ª£Ë°®I440FXËäØÁâáÁöÑPCI‰∏ªÊ°•ÈÉ®ÂàÜÔºõ</li>
<li><code>pci_type</code> ‰ª£Ë°®I440FXËäØÁâáÂú®PCIÊÄªÁ∫ø‰∏äÁöÑÈÉ®ÂàÜ„ÄÇ</li>
</ul>
<p>ËØ•PCIËÆæÂ§áÁöÑËÆæÂ§áÂÆû‰æãÁî®PCII440FXStateË°®Á§∫„ÄÇ<code>&amp;i440fx_state</code> ÂèÇÊï∞‰º†ÂÖ•ÁöÑÊòØ <code>pc_init1</code> ÂáΩÊï∞‰∏≠ÂÆö‰πâÁöÑPCII440FXStateÁ±ªÂûãÊåáÈíà„ÄÇÂÆèÂÆö‰πâÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/include/hw/i386/pc.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211837879.png" alt="image-20231121183732909" style="zoom:33%;" />
<hr>
<p>‰∏éI440FXËäØÁâáÁöÑÁªìÊûÑÁõ∏ÂØπÂ∫îÔºå<strong>I440FXËäØÁâáÂàùÂßãÂåñÂàÜ‰∏∫PCI‰∏ªÊ°•ÔºàÂç≥ÂåóÊ°•ÔºâÂíåPCII440FXÂàùÂßãÂåñ</strong>‰∏§ÈÉ®ÂàÜ„ÄÇ<code>i440fx_init</code> ÂáΩÊï∞ÁöÑÊ†∏ÂøÉ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211840893.png" alt="image-20231121184006678" style="zoom:33%;" />
<ul>
<li>
<p><code>qdev_new(host_type)</code> ÂáΩÊï∞ÁöÑ‰ΩúÁî®ÊòØÂàõÂª∫PCI‰∏ªÊ°•ÔºåËØ•ÂáΩÊï∞‰∏éÊ∑ªÂä†eduËÆæÂ§áÊó∂Ë∞ÉÁî®ÁöÑ <code>qdev_device_add</code> ÂáΩÊï∞Á±ª‰ººÔºåÈÉΩÊòØÈÄöËøáË∞ÉÁî®<code>object_new</code> Êé•Âè£ÂáΩÊï∞ÔºåÊ†πÊçÆ‰º†ÂÖ•ÁöÑËÆæÂ§áÁ±ªÂûãÂàõÂª∫ËÆæÂ§áÂØπË±°ÂÆû‰æãÔºõ</p>
</li>
<li>
<p>x86Êû∂ÊûÑÂú®PCI‰∏ªÊ°•Êèê‰æõ <code>config_address</code> ÂØÑÂ≠òÂô®ÔºàÁ´ØÂè£Âú∞ÂùÄ‰∏∫0xCF8Ôºâ‰∏é <code>config_data</code> ÂØÑÂ≠òÂô®ÔºàÁ´ØÂè£Âú∞ÂùÄ‰∏∫0xCFCÔºâËøô‰∏§‰∏™32‰ΩçÂØÑÂ≠òÂô®ÔºåÁî®‰∫éËÆøÈóÆPCIËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥„ÄÇÂú®PCI‰∏ªÊ°•ËÆæÂ§áÂÆû‰æãÂàõÂª∫ÂíåÂÖ∑Áé∞ÂåñËøáÁ®ã‰∏≠ÂÆåÊàêÂØπËøô‰∏§‰∏™ÂØÑÂ≠òÂô®ÁöÑÂàùÂßãÂåñÔºåÂπ∂Â∞ÜÂÖ∂Âä†ÂÖ•I/OÂú∞ÂùÄÁ©∫Èó¥‰∏≠„ÄÇÂú®pci_host.cÊñá‰ª∂‰∏≠ÂÆö‰πâ‰∫ÜÂáΩÊï∞ <code>pci_host_config_write</code>„ÄÅ<code>pci_host_config_read</code>„ÄÅ<code>pci_host_data_write</code> Âíå <code>pci_host_data_read</code>„ÄÇËøôÂõõ‰∏™ÂáΩÊï∞Ë¥üË¥£ <code>config_address</code> ÂØÑÂ≠òÂô®Âíå <code>config_data</code> ÂØÑÂ≠òÂô®ÁöÑËØªÂÜô„ÄÇ</p>
</li>
<li>
<p>PCI‰∏ªÊ°•ËÆæÂ§áÂÆû‰æãÂàõÂª∫ÂíåÂÖ∑Áé∞ÂåñÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code> <strong>ÂàõÂª∫ÂÆû‰æã</strong></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211839597.png" alt="image-20231121183922089" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code> <strong>ÂÖ∑Áé∞Âåñ</strong></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211843908.png" alt="image-20231121184115096" style="zoom:33%;" />
</li>
<li>
<p>ÁÑ∂Âêé <code>pci_root_bus_new</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>qbus_create</code> ÂáΩÊï∞ÂàõÂª∫‰∏ÄÊù°PCIÊÄªÁ∫øÔºåËØ•ÊÄªÁ∫ø‰πüÁß∞‰∏∫0Âè∑ÊÄªÁ∫øÔºå‰πãÂêéË∞ÉÁî® <code>pci_root_bus_init</code> ÂáΩÊï∞ÂØπÊÄªÁ∫øËøõË°åÂàùÂßãÂåñÂπ∂Â∞ÜÂÖ∂ÊåÇËΩΩÂà∞PCI‰∏ªÊ°•Ôºõ</p>
</li>
<li>
<p>ÁÑ∂Âêé‰ªé <code>pci_root_bus_new</code> ÂáΩÊï∞ÈÄÄÂá∫ÔºåÊâßË°å <code>i440fx_init</code> ÂáΩÊï∞‰∏≠ÁöÑ <code>qdev_init_nofail</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî®<code>object_property_set_bool(OBJECT(dev)Ôºå&quot;realized&quot;ÔºåtrueÔºåerrp)</code> ÂáΩÊï∞„ÄÇ<code>object_property_set_bool</code> ÂáΩÊï∞‰ºöÂ∞ÜÂåóÊ°•ËÆæÂ§áÁöÑrealizedÂ±ûÊÄßËÆæÁΩÆ‰∏∫trueÔºåËß¶ÂèëÂåóÊ°•ËÆæÂ§áÂÖ∑Áé∞ÂåñÂáΩÊï∞ÁöÑÂõûË∞É„ÄÇ<code>pci_root_bus_new</code> ÂáΩÊï∞ÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci/pci.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211843177.png" alt="image-20231121184212241" style="zoom:33%;" />
</li>
</ul>
<p><strong>Ëá≥Ê≠§ÔºåI440FXËäØÁâáÁ¨¨‰∏ÄÈò∂ÊÆµÁöÑPCI‰∏ªÊ°•ÂàùÂßãÂåñÁªìÊùü„ÄÇ</strong></p>
<hr>
<p>Âú®I440FXÂàùÂßãÂåñÁ¨¨‰∫åÈò∂ÊÆµÔºå<code>pci_create_simple</code> ÂáΩÊï∞Áõ¥Êé•Ë∞ÉÁî® <code>pci_create_simple_multifunction</code> Êé•Âè£ÂáΩÊï∞ÔºåÂπ∂ÊúÄÁªàË∞ÉÁî® <code>object_new</code> ÂáΩÊï∞‰∏é <code>object_property_set_bool</code> ÂáΩÊï∞ÂÆåÊàêPCI I440FXËÆæÂ§áÁöÑÂàõÂª∫ÂíåÂÖ∑Ë±°ÂåñËøáÁ®ã„ÄÇÊúÄÁªàPCI I440FXËÆæÂ§á‰ºöË¢´ÊåÇËΩΩÂà∞PCI 0Âè∑ÊÄªÁ∫øÔºàÊ†πÊÄªÁ∫øÔºâÁöÑ0Âè∑ÊèíÊßΩ„ÄÇ</p>
<p>Âú®ËæÉÊñ∞ÁâàÊú¨ÁöÑQEMUÊ∫êÁ†Å‰∏≠ÔºåI440FXÂíåPIIX3ÁöÑÂàùÂßãÂåñÁî± <code>pc_init1</code> ÂáΩÊï∞‰∏≠ÁöÑ‰∏§‰∏™ <code>i440fx_init</code> ÂáΩÊï∞Âíå <code>piix3_create</code> ÂáΩÊï∞ÂàÜÂà´ÊâßË°å„ÄÇ<code>i440fx_init</code> ÊâßË°åÁªìÊùüÂêé‰ºöÊääPCIÊ†πÊÄªÁ∫øËøîÂõûÁªô <code>pc_init1</code> ÂáΩÊï∞ÔºåÈöèÂêé <code>pc_init1</code> ÂáΩÊï∞‰ºöÂ∞ÜPCIÊ†πÊÄªÁ∫ø‰Ωú‰∏∫ÂèÇÊï∞‰º†ÂÖ• <code>piix3_create</code> ÂáΩÊï∞„ÄÇÁÑ∂ËÄåÂú®QEMU 4.1.1ÁâàÊú¨ÔºåPIIX3ËÆæÂ§áÁöÑÂàõÂª∫ËøáÁ®ã‰πüÁî± <code>i440fx_init</code> ÂáΩÊï∞ÊâßË°åÔºå<code>i440fx_init</code> ÂáΩÊï∞‰ΩøÁî®‰∏éPCI I440FXËÆæÂ§áÁõ∏ÂêåÁöÑ<code>pci_create_simple_multifunction</code> Êé•Âè£ÂàõÂª∫ÂíåÂÖ∑Áé∞ÂåñPIIX3ËÆæÂ§á„ÄÇ</p>
<p>Âú®PIIX3ËÆæÂ§áÂØπË±°ÁöÑÂÖ∑Áé∞ÂåñÂáΩÊï∞ <code>piix3_realize</code> ‰∏≠Ôºå‰ºöÈÄöËøá <code>isa_bus_new</code> ÂáΩÊï∞ÂàõÂª∫‰∏ÄÊù°ISAÊÄªÁ∫øÔºåËØ•ISAÊÄªÁ∫ø‰ºöÊåÇËΩΩÂà∞PIIX3‰∏ã„ÄÇÊúÄÂêé <code>pci_bus_irqs</code> ÂáΩÊï∞Âíå <code>pci_bus_set_route_irq_fn</code> ÂáΩÊï∞‰ºöËÆæÁΩÆPCIÊ†πÊÄªÁ∫øÁöÑ‰∏≠Êñ≠Ë∑ØÁî±‰ø°ÊÅØ„ÄÇQEMU 4.1.1ÁâàÊú¨PIIX3ËÆæÂ§áÂàõÂª∫ÁöÑÈÉ®ÂàÜ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211843642.png" alt="image-20231121184312174" style="zoom:33%;" />
<p>PCIÊÄªÁ∫øÊòØ‰∏Ä‰∏™Â§öÁ∫ßÁªìÊûÑÔºåPCIËÆæÂ§á„ÄÅPCI-PCIÊ°•„ÄÅPCI-ISAÊ°•ËÆæÂ§á‰ºöÊ≥®ÂÜåÂà∞ÊÄªÁ∫ø‰∏ä„ÄÇÊ°•ËÆæÂ§á‰ºöÊâ©Â±ïPCIÊÄªÁ∫øÁªìÊûÑÔºå‰æãÂ¶ÇPCI-PCIÊ°•ËÆæÂ§á‰ºöÂàõÂª∫‰∏ã‰∏ÄÁ∫ßPCIÊÄªÁ∫ø„ÄÇËøôÊ†∑Â∞±ÂΩ¢Êàê‰∫Ü ‚ÄúÊÄªÁ∫ø‚ÄîËÆæÂ§á‚ÄîÊÄªÁ∫ø‚ÄîËÆæÂ§á‚Äù ÁöÑÊ†ëÂΩ¢ÁªìÊûÑ„ÄÇÁõÆÂâç <code>pci_root_bus_new</code> ÂáΩÊï∞Â∑≤ÁªèÂú®‰∏ªÊ°•‰∏ãÂàõÂª∫‰∫ÜPCIÊ†πÊÄªÁ∫øÔºå<code>pc_init1</code> ÂáΩÊï∞‰πãÂêé‰ºöÂ∞ÜÁ≥ªÁªüÈªòËÆ§ÁöÑ‰∏Ä‰∫õPCIËÆæÂ§áÔºà‰æãÂ¶Çe1000ÁΩëÂç°„ÄÅVGAÊéßÂà∂Âô®ÔºâÊ≥®ÂÜåÂà∞PCIÊ†πÊÄªÁ∫ø‰∏ä„ÄÇ</p>
<hr>
<h3 id="pciËÆæÂ§áÊ≥®ÂÜåÂà∞ÊÄªÁ∫ø‰∏ä">PCIËÆæÂ§áÊ≥®ÂÜåÂà∞ÊÄªÁ∫ø‰∏ä
</h3><p>**PCIËÆæÂ§áÁöÑÊ≥®ÂÜåÊòØÂú®PCIËÆæÂ§áÂÖ∑Áé∞ÂåñËøáÁ®ã‰∏≠ÂÆåÊàêÁöÑ„ÄÇ**‰∏ãÊñá‰ªç‰ª•eduËÆæÂ§á‰∏∫‰æã‰ªãÁªçPCIËÆæÂ§áÁöÑÂÖ∑Áé∞ÂåñËøáÁ®ã„ÄÇ</p>
<p>3.1ËäÇÊèêÂà∞ÔºåeduËÆæÂ§áÂàùÂßãÂåñËøáÁ®ã‰ºöË∞ÉÁî®Áà∂Á±ªÂûãÁöÑÂÆû‰æãÂàùÂßãÂåñÂáΩÊï∞„ÄÇeduËÆæÂ§áÂ±û‰∫éPCIËÆæÂ§áÔºåÂÖ∂Áà∂Á±ªÂûã‰∏∫PCIDeviceClassÔºåËØ•Á±ªÂûãÁöÑÂàùÂßãÂåñÂáΩÊï∞‰∏∫<code>pci_device_class_init</code> ÂáΩÊï∞„ÄÇ<code>pci_device_class_init</code> ÂáΩÊï∞‰ºöÂ∞ÜPCIDeviceClassÁöÑrealizeÂáΩÊï∞ËÆæ‰∏∫ÈªòËÆ§ÁöÑ <code>pci_qdev_realize</code> ÂáΩÊï∞„ÄÇ<code>pci_device_class_init</code> ÂáΩÊï∞ÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci/pci.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211844371.png" alt="image-20231121184439478" style="zoom:33%;" />
<p><code>pci_qdev_realize</code> ÂáΩÊï∞È¶ñÂÖà‰ºöË∞ÉÁî® <code>do_pci_register_device</code> ÂáΩÊï∞ÊâßË°åÈÄöÁî®ÁöÑPCIËÆæÂ§áÂàùÂßãÂåñÊµÅÁ®ãÔºåÂåÖÊã¨ËÆæÁΩÆeduËÆæÂ§áÂú®ÂØπÂ∫îÊÄªÁ∫ø‰∏äÁöÑÊèíÊßΩÂè∑„ÄÅÂàùÂßãÂåñeduËÆæÂ§áÁöÑÂú∞ÂùÄÁ©∫Èó¥„ÄÅÂàÜÈÖçeduËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥Âπ∂ÂàùÂßãÂåñÈÖçÁΩÆÁ©∫Èó¥ÈáåÁöÑÈÉ®ÂàÜÂØÑÂ≠òÂô®„ÄÅËÆæÁΩÆÈÖçÁΩÆÁ©∫Èó¥ÁöÑËØªÂÜôÂáΩÊï∞„ÄÅÂ∞ÜeduËÆæÂ§áÂä†ÂÖ•ÊâÄÂú®ÊÄªÁ∫øÁöÑdevicesÊï∞ÁªÑ‰∏≠„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci/pci.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211846218.png" alt="image-20231121184529677" style="zoom:33%;" />
<p>‰πãÂêé <code>pci_qdev_realize</code> ÂáΩÊï∞‰ºöÊâßË°åeduËÆæÂ§áÁöÑrealizeÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÁöÑ‰ΩúÁî®3.1ËäÇÂ∑≤Áªè‰ªãÁªçÔºåÊ≠§Â§Ñ‰∏çÂÜçËµòËø∞„ÄÇÈÉ®ÂàÜPCIËÆæÂ§áÂèØËÉΩ‰ºöÊúâ‰∏ìÂ±ûÁöÑËÆæÂ§áROMÔºåÂú® <code>pci_qdev_realize</code> ÂáΩÊï∞‰∏≠ÔºåÊúÄÂêé‰ºöÊâßË°å <code>pci_add_option_rom</code> ÂáΩÊï∞Â∞ÜROMÊñá‰ª∂Ê≥®ÂÜåÂà∞PCIËÆæÂ§áÁöÑBAR‰∏≠„ÄÇÂ¶ÇÊûúeduËÆæÂ§á‰∏çÂ≠òÂú®ROMÔºåËøõÂÖ• <code>pci_add_option_rom</code> ÂáΩÊï∞Âêé‰ºöÁõ¥Êé•ËøîÂõû„ÄÇ</p>
<p><strong>Ëá≥Ê≠§ÔºåeduËÆæÂ§á‰æøË¢´ÂÆåÂÖ®ÂàùÂßãÂåñÂπ∂ÊåÇËΩΩÂà∞ÂØπÂ∫îÁöÑPCIÊÄªÁ∫ø‰πã‰∏ä„ÄÇ</strong></p>
<h2 id="33-qemukvmËÆæÂ§áËÆøÈóÆÁöÑÊ®°Êãü">3.3 QEMU/KVMËÆæÂ§áËÆøÈóÆÁöÑÊ®°Êãü
</h2><blockquote>
<p>Êú¨ËäÇÂ∞ÜÂÆåÊï¥‰ªãÁªçQEMU/KVMÊû∂ÊûÑÂ§ÑÁêÜËôöÊãüÊú∫ÂèëËµ∑ÁöÑPIO‰∏éMMIOËØ∑Ê±ÇËøáÁ®ã„ÄÇ</p>
</blockquote>
<p>Âú®QEMU/KVMÊû∂ÊûÑ‰∏ãÔºåKVM‰ºöÂ∞Üx86Êû∂ÊûÑÊèê‰æõÁöÑÁî®‰∫éÁ´ØÂè£ËÆøÈóÆÁöÑ <code>IN/OUT</code>„ÄÅ<code>INS/OUTS</code> Êåá‰ª§ËÆæÁΩÆ‰∏∫ÊïèÊÑüÊåá‰ª§Ôºå‰ΩøÂæóËôöÊãüÊú∫Âú®ÂèëËµ∑PIOÊó∂‰ºö‰∫ßÁîüVM-ExitÔºåËøõËÄåÈô∑ÂÖ•KVMÂíåQEMU‰∏≠ËøõË°åÂ§ÑÁêÜ„ÄÇÂú®‰ªãÁªçQEMU/KVMÂ¶Ç‰ΩïÂ∞Ü‰∏äËø∞Êåá‰ª§ËÆæÁΩÆ‰∏∫ÊïèÊÑüÊåá‰ª§‰πãÂâçÔºåÈ¶ñÂÖàÂõûÈ°æ‰∏Ä‰∏ãI/O‰ΩçÂõæÁöÑÁõ∏ÂÖ≥Ê¶ÇÂøµ„ÄÇ</p>
<p><code>VM-Excution</code> ÊéßÂà∂ÂüüÁöÑI/O‰ΩçÂõæÂú∞ÂùÄÂ≠óÊÆµ‰ºöÂåÖÂê´‰∏§‰∏™64‰ΩçÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåËøô‰∏§‰∏™Áâ©ÁêÜÂú∞ÂùÄÂàÜÂà´ÊåáÂêë‰∏§‰∏™Â§ßÂ∞è‰∏∫4KBÁöÑI/O‰ΩçÂõæAÂíåI/O‰ΩçÂõæB„ÄÇ‰∏§‰∏™I/O‰ΩçÂõæ‰∏≠ÁöÑÊØè‰ΩçÈÉΩÂØπÂ∫î‰∏Ä‰∏™I/OÁ´ØÂè£ÔºåÂÖ∂‰∏≠I/O‰ΩçÂõæAÂåÖÂê´ÁöÑI/OÁ´ØÂè£Âú∞ÂùÄËåÉÂõ¥‰∏∫ <code>0x0000~0x7fff</code>ÔºåI/O‰ΩçÂõæBÂåÖÂê´ÁöÑI/OÁ´ØÂè£Âú∞ÂùÄËåÉÂõ¥‰∏∫<code>0x8000~0xffff</code>„ÄÇ<strong>ÂΩìÊüê‰∏™I/OÁ´ØÂè£Âú®I/O‰ΩçÂõæ‰∏≠ÁöÑÂØπÂ∫î‰Ωç‰∏∫1Êó∂Ôºå‰ª£Ë°®ÂΩìËôöÊãüÊú∫ËÆøÈóÆËØ•Á´ØÂè£Êó∂‰ºöÂèëÁîüVM-Exit„ÄÇÂõ†Ê≠§ÔºåKVMÈÄöËøáÂ∞ÜVMCS‰∏≠ÁöÑI/O‰ΩçÂõæÂÖ®ÈÉ®ÁΩÆ‰∏∫1Ôºå‰æøÂèØ‰ª•ÂÆûÁé∞ÂØπËôöÊãüÊú∫‰∏≠Á´ØÂè£ËÆøÈóÆÊåá‰ª§ÁöÑÊà™Ëé∑„ÄÇ</strong></p>
<hr>
<h3 id="ËôöÊãüÊú∫ÂèëËµ∑pioËÆøÈóÆ">ËôöÊãüÊú∫ÂèëËµ∑PIOËÆøÈóÆ
</h3><h4 id="‰ªévm-exitÂà∞Â§ÑÁêÜio">‰ªéVM-ExitÂà∞Â§ÑÁêÜIO
</h4><p>ÂΩìvCPUÂõ†ËôöÊãüÊú∫ÊâßË°åPIOÊåá‰ª§ÂèëÁîüVM-ExitÊó∂Ôºå<code>vmx_vcpu_run</code> ÂáΩÊï∞Â∞Ü <code>vmx-&gt;exit_reason</code> ËÆæÁΩÆ‰∏∫EXIT_REASON_IO_INSTRUCTIONÂêé‰ºöËøîÂõûËá≥<code>vcpu_enter_guest</code> ÂáΩÊï∞„ÄÇ‰πãÂêé <code>vcpu_enter_guest</code> ÂáΩÊï∞ÈÄöËøákvm_x86_opsÁöÑhandle_exitÊàêÂëòË∞ÉÁî® <code>vmx_handle_exit</code> ÂáΩÊï∞„ÄÇ</p>
<p><code>vmx_handle_exit</code> ÂáΩÊï∞Ê†πÊçÆÂâçÈù¢ÁöÑ <code>vmx-&gt;exit_reason</code> ‰∏∫EXIT_REASON_IO_INSTRUCTIONÔºåËøõËÄåË∞ÉÁî®ÂÖ®Â±ÄÊï∞ÁªÑ <code>kvm_vmx_exit_handlers</code> ‰∏≠Áî®‰∫éÂ§ÑÁêÜPIO‰∫ßÁîüÁöÑVM-ExitÁöÑÂ§ÑÁêÜÂáΩÊï∞ <code>handle_io</code> „ÄÇËØ•ËøáÁ®ãÁöÑÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212017846.png" alt="image-20231121201715921" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212017101.png" alt="image-20231121201744240" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212018209.png" alt="image-20231121201822227" style="zoom:33%;" />
<h4 id="kvmÁöÑioÂ§ÑÁêÜÂáΩÊï∞-ÂÜÖÊ†∏ÊÄÅ">KVMÁöÑIOÂ§ÑÁêÜÂáΩÊï∞ (ÂÜÖÊ†∏ÊÄÅ)
</h4><p><code>handle_io</code> ÂáΩÊï∞È¶ñÂÖà‰ºöË∞ÉÁî® <code>vmcs_readl</code> ÂáΩÊï∞‰ªéVMCS‰∏≠ËØªÂèñVM-ExitÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂåÖÊã¨Á´ØÂè£ËÆøÈóÆÊñπÂºèinÔºàËØªÊàñÂÜôÔºâ„ÄÅËÆøÈóÆÊï∞ÊçÆÂ§ßÂ∞èsize‰ª•ÂèäÁ´ØÂè£Âè∑port„ÄÇÁÑ∂Âêé <code>handle_io</code> ÂáΩÊï∞‰ºöÂ∞Ü‰∏äËø∞‰ø°ÊÅØ‰Ωú‰∏∫ÂèÇÊï∞‰º†ÈÄíÁªô <code>kvm_fast_pio</code> ÂáΩÊï∞ÂÅöËøõ‰∏ÄÊ≠•Â§ÑÁêÜÔºåÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212021482.png" alt="image-20231121201933882" style="zoom:33%;" />
<p><code>kvm_fast_pio</code> ÂáΩÊï∞Ê†πÊçÆinÁöÑÂÄºË∞ÉÁî® <code>kvm_fast_pio_in</code> ÂáΩÊï∞Êàñ <code>kvm_fast_pio_out</code> ÂáΩÊï∞„ÄÇÂú®Ê≠§‰ª• <code>kvm_fast_pio_out</code> ÂáΩÊï∞‰∏∫‰æã:</p>
<ol>
<li><code>kvm_fast_pio_out</code> ÂáΩÊï∞È¶ñÂÖà‰ºöË∞ÉÁî® <code>kvm_register_read</code> ÂáΩÊï∞Ëé∑ÂèñË¶ÅÂÜôÂÖ•ÁöÑÊï∞ÊçÆÔºõ</li>
<li>‰πãÂêéËøõÂÖ• <code>emulator_pio_out_emulated</code> ÂáΩÊï∞Â∞ÜÂÜôÂÖ•ÁöÑÊï∞ÊçÆÂ§çÂà∂Âà∞ <code>vcpu-&gt;arch.pio_data</code> ‰∏≠Ôºõ</li>
<li>ÊúÄÁªàÊéßÂà∂ÊµÅ‰ºöËøõÂÖ• <code>emulator_pio_in_out</code> ÂáΩÊï∞Ôºå<code>emulator_pio_in_out</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kernel_pio</code> ÂáΩÊï∞ÔºåÂ∞ùËØïÂú®KVM‰∏≠Â§ÑÁêÜËØ•PIOËØ∑Ê±ÇÔºåËã•KVMÊó†Ê≥ïÂ§ÑÁêÜÔºåÂÆÉÂ∞Ü <code>vcpu-&gt;run-&gt;exit_reason</code> ËÆæÁΩÆ‰∏∫KVM_EXIT_IOÂπ∂ÊúÄÁªàËøîÂõû0ÔºåËøôÂØºËá¥ <code>vcpu_run</code> ÂáΩÊï∞ÈÄÄÂá∫Âæ™ÁéØÂπ∂ËøîÂõûËá≥QEMU‰∏≠ËøõË°åÂ§ÑÁêÜ„ÄÇ</li>
</ol>
<p>ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212020609.png" alt="image-20231121202032665" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212022516.png" alt="image-20231121202147157" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212022664.png" alt="image-20231121202243890" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212023020.png" alt="image-20231121202324810" style="zoom:33%;" />
<blockquote>
<p>Ê≥®ÔºöQEMUÂØπPIOÂíåMMIOÁöÑÂ§ÑÁêÜÊîæÂú®‰∏ÄËµ∑ÂàÜÊûêÔºåÂú®‰∏ã‰∏ÄËäÇ„ÄÇ</p>
</blockquote>
<h3 id="ËôöÊãüÊú∫ÂèëËµ∑mmioËÆøÈóÆ">ËôöÊãüÊú∫ÂèëËµ∑MMIOËÆøÈóÆ
</h3><p>Áî±‰∫éMMIOÈúÄË¶ÅÂ∞ÜI/OÁ´ØÂè£ÂíåËÆæÂ§áRAMÊò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÂπ∂‰∏îCPUÈúÄË¶Å‰ΩøÁî®ÂÜÖÂ≠òËÆøÈóÆÊåá‰ª§ËøõË°åÂØπËÆæÂ§áËøõË°åMMIOËÆøÈóÆÔºåÊâÄ‰ª•QEMU/KVMÊû∂ÊûÑ‰∏ãÂØπMMIOÁöÑÊ®°Êãü‰πüÈúÄË¶ÅÂà©Áî®EPTÊú∫Âà∂„ÄÇ</p>
<p>‰∏éPIOÁöÑÂ§ÑÁêÜËøáÁ®ãÁ±ª‰ººÔºåÂΩìËôöÊãüÊú∫ÂèëËµ∑MMIOËÆøÈóÆÊó∂ÔºåÂêåÊ†∑‰ºöÂèëÁîüVM-ExitÈô∑ÂÖ•KVMÂíåQEMU‰∏≠ËøõË°åÂ§ÑÁêÜ„ÄÇ**‰ΩÜ‰∏éPIO‰∏çÂêåÁöÑÊòØÔºåMMIOÊòØÈÄöËøáÁº∫È°µÂºÇÂ∏∏‰∫ßÁîüVM-ExitÔºå**‰ª•‰∏ãÊòØQEMU/KVM‰∏≠ÁöÑÂÖ∑‰ΩìÂÆûÁé∞ËøáÁ®ã„ÄÇ</p>
<hr>
<h4 id="qemuËÆæÂ§áÂàùÂßãÂåñ">QEMUËÆæÂ§áÂàùÂßãÂåñ
</h4><p>È¶ñÂÖàQEMUÂú®ËÆæÂ§áÂàùÂßãÂåñÁöÑËøáÁ®ã‰∏≠Ôºå‰ºöÈÄöËøáÂâçÊñáeduËÆæÂ§áÂÖ∑Áé∞Âåñ‰∏≠‰ªãÁªçÁöÑ <code>memory_region_init_io</code> ÂáΩÊï∞ÂàùÂßãÂåñ‰∏Ä‰∏™MMIOÂÜÖÂ≠òÂå∫ÂüüÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/memory.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212025477.png" alt="image-20231121202452889" style="zoom:33%;" />
<p>Âú®Â¶Ç‰∏äÁöÑ <code>memory_region_init_io</code> ÂáΩÊï∞ÁöÑÂéüÂûã‰∏≠ÔºåËØ•ÂáΩÊï∞Âπ∂Êú™Ë∞ÉÁî® <code>memory_region_init_ram</code> ËÆæÁΩÆmr-&gt;ramÔºåÂõ†Ê≠§ËØ•MemoryRegionÂπ∂Êú™ÂÆûÈôÖÂàÜÈÖçÂÜÖÂ≠ò„ÄÇÊ≠§Êó∂ÔºåËØ•MemoryRegionË¢´Âä†ÂÖ•MemoryRegionÊ†ëÔºå‰ºöËß¶ÂèëKVMÁöÑlistenerÔºå‰ªéËÄåË∞ÉÁî®listenerÁöÑ <code>kvm_region_add</code> ÂáΩÊï∞„ÄÇÁÑ∂Âêé<code>kvm_region_add</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>kvm_set_phys_mem</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞‰ºöÊ£ÄÊü•MemoryRegionÁöÑÁ±ªÂûãÔºåÂ¶ÇÊûú‰∏çÊòØRAMÁ±ªÂûãÔºåÂàôÁõ¥Êé•ËøîÂõû„ÄÇ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/accel/kvm/kvm-all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212025495.png" alt="image-20231121202532043" style="zoom:33%;" />
<p><code>qemu-4.1.1/accel/kvm/kvm-all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212026864.png" alt="image-20231121202607259" style="zoom:33%;" />
<h4 id="kvmÂàùÂßãÂåñËÆæÁΩÆ">KVMÂàùÂßãÂåñËÆæÁΩÆ
</h4><p>Âú®KVMÂàùÂßãÂåñËøáÁ®ã‰∏≠Ôºå‰ºöÊâßË°å <code>kvm_arch_hardware_setup</code> ÂáΩÊï∞ËøõË°åÁ°¨‰ª∂ËÆæÁΩÆ„ÄÇËØ•ÂáΩÊï∞‰ºöÈÄöËøákvm_x86_opsÁöÑ <code>hardware_setup</code> ÂáΩÊï∞ÊúÄÁªàË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>ept_set_mmio_spte_mask</code> ÂáΩÊï∞ÔºåÂ∞ÜÂÖ®Â±ÄÂèòÈáè <code>shadow_mmio_mask</code> ÁöÑÊúÄ‰Ωé‰∏â‰ΩçËÆæÁΩÆ‰∏∫110b„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212029212.png" alt="image-20231121202807746" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/mmu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212030643.png" alt="image-20231121203019843" style="zoom:33%;" />
<h4 id="kvm‰∏≠mmioÂ§ÑÁêÜ">KVM‰∏≠MMIOÂ§ÑÁêÜ
</h4><p>ÂΩìËôöÊãüÊú∫Á¨¨‰∏ÄÊ¨°ËÆøÈóÆËôöÊãüËÆæÂ§áÁöÑMMIO MemoryRegionÊó∂ÔºåÁî±‰∫éÂÖàÂâçÊ≤°ÊúâÁªôËØ•MRÂàÜÈÖçRAMÔºåÂõ†Ê≠§‰ºö‰∫ßÁîü‰∏Ä‰∏™EPT ViolationÁº∫È°µÂºÇÂ∏∏„ÄÇÂú®EPTÈ°µË°®Áº∫È°µÁöÑÊÉÖÂÜµ‰∏ãÔºåKVM‰ºöË∞ÉÁî®Áº∫È°µÂºÇÂ∏∏Â§ÑÁêÜÂáΩÊï∞ <code>tdp_page_fault</code>ÔºåÂÆåÂñÑEPT„ÄÇÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li><code>tdp_page_fault</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>try_async_pf</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞‰ºöÊ£ÄÊü•ÂèÇÊï∞ <code>gfn</code> ÊòØÂê¶Âú®KVMÁöÑmemslotsÁöÑËåÉÂõ¥‰∏≠„ÄÇÂ¶ÇÊûú‰∏çÂú®ÔºåÂàôÂêëpfn‰∏≠ÂÜôÂÖ•KVM_PFN_NOSLOTÔºõ</li>
<li>ÊúÄÂêé <code>tdp_page_fault</code> ÂáΩÊï∞‰ºöËøõÂÖ• <code>_direct_map</code> ÂáΩÊï∞ÔºåÂπ∂ÁªèËøá <code>mmu_set_spte -&gt; set_spte -&gt; set_mmio_spte</code> ÂáΩÊï∞Ë∞ÉÁî®ÈìæÊúÄÁªàËøõÂÖ•<code>set_mmio_spte</code> ÂáΩÊï∞„ÄÇ</li>
</ol>
<p>ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/mmu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212031905.png" alt="image-20231121203117652" style="zoom:33%;" />
<p><code>set_mmio_spte</code> ÂáΩÊï∞‰ºöÊ£ÄÊü•ÂΩìÂâçpfn‰∏≠ÊòØÂê¶Ë¢´ÂÜôÂÖ•KVM_PFN_NOSLOTÔºåÂ¶ÇÊûúË¢´ÂÜôÂÖ•ÔºåÂàôÂ∞ÜEPT‰∏≠ËøôÊÆµÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÔºàÂç≥gfnÔºâÂØπÂ∫îÁöÑEPTÈ°µË°®Â±ûÊÄßÊ†áËÆ∞‰∏ä‰ª£Ë°®MMIOÁöÑÁâπÊÆäÂÄº‚Äî‚Äî <code>shadow_mmio_mask</code>Ôºå‰ª•ÂêéÁöÑËØªÂÜôÈÉΩ‰ºöÂºïËµ∑ <code>EXIT_REASON_EPT_MISCONFIG</code> Á±ªÂûãÁöÑVM-Exit„ÄÇ</p>
<blockquote>
<p>Ê≠§Â§Ñ‰∏çËÆ®ËÆ∫Âª∫Á´ãEPTÊò†Â∞ÑÁöÑËøáÁ®ãÔºåÂÖ≥‰∫éÂ§ÑÁêÜEPTÁº∫È°µÂºÇÂ∏∏Ê∂âÂèäÁöÑÂáΩÊï∞ÔºåËØ∑ÈòÖËØªÂÜÖÂ≠òËôöÊãüÂåñÊñáÊ°£„ÄÇ</p>
</blockquote>
<p>Âú®ÂÖ®Â±ÄÊï∞ÁªÑ <code>kvm_vmx_exit_handlers</code> ‰∏≠Ôºå<code>EXIT_REASON_EPT_MISCONFIG</code> ÂØπÂ∫îÁöÑVM-ExitÂ§ÑÁêÜÂáΩÊï∞‰∏∫ <code>handle_ept_misconfig</code>„ÄÇËØ•ÂáΩÊï∞‰ºöÂÖàÂ∞ùËØïË∞ÉÁî® <code>kvm_io_bus_write</code> ÂáΩÊï∞ÔºåÂú®KVM‰∏≠ÂØªÊâæËÉΩÂ§üÂ§ÑÁêÜÊú¨Ê¨°MMIOËØ∑Ê±ÇÁöÑËÆæÂ§áÔºåÂ¶ÇÊûúKVMÊó†Ê≥ïÂ§ÑÁêÜÔºåÂàô‰ºöË∞ÉÁî® <code>kvm_mmu_page_fault</code> ÂáΩÊï∞Ôºå‰ªéËÄåËøõÂÖ• <code>handle_mmio_page_fault</code> ÂáΩÊï∞‰∏≠Â§ÑÁêÜ„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212032678.png" alt="image-20231121203217947" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/mmu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212033659.png" alt="image-20231121203259111" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/mmu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212034680.png" alt="image-20231121203404817" style="zoom:33%;" />
<p><code>handle_mmio_page_fault</code> ÂáΩÊï∞ÁöÑÂ§ÑÁêÜ‰∏ªË¶ÅÊúâ‰∏â‰∏™Èò∂ÊÆµÔºö</p>
<ul>
<li>Á¨¨‰∏Ä‰∏™Èò∂ÊÆµÊòØÈÄöËøá <code>mmio_info_in_cache</code> ÂáΩÊï∞Ê£ÄÊü•MMIOÂØπÂ∫îÁöÑÂú∞ÂùÄÊòØÂê¶Âú®ÁºìÂ≠ò‰∏≠Â≠òÂú®ÔºåÂ¶ÇÊûúÂ≠òÂú®ÔºåÂàôÁ´ãÂç≥ËøîÂõûÂà∞ <code>kvm_mmu_page_fault</code>ÂáΩÊï∞ÔºåËøîÂõûÂÄº‰∏∫RET_PF_EMULATEÔºõ</li>
<li>Â¶ÇÊûúÁ¨¨‰∏ÄÈò∂ÊÆµÊú™ËøîÂõûÔºåÂàôËøõÂÖ•Á¨¨‰∫åÈò∂ÊÆµÔºåËØ•Èò∂ÊÆµ‰ºöÈÄöËøá <code>walk_shadow_page_get_mmio_spte</code> ÂáΩÊï∞Ëé∑ÂèñMMIOÂú∞ÂùÄÂØπÂ∫îÁöÑspteÔºåÂπ∂ÈÄöËøá<code>check_mmio_spte</code> ÂáΩÊï∞Âà§Êñ≠ËØ•Âú∞ÂùÄÊòØÂê¶‰ª£Ë°®MMIOÂå∫ÂüüÔºåÂ¶ÇÊûúÊòØÔºåÂàôËøîÂõûRET_PF_EMULATEÔºõ</li>
<li>Á¨¨‰∏âÈò∂ÊÆµÔºåËøîÂõûÂà∞Âú® <code>kvm_mmu_page_fault</code> ÂáΩÊï∞‰πãÂêéÔºåËØ•ÂáΩÊï∞‰ºöÊ£ÄÊü• <code>handle_mmio_page_fault</code> ÂáΩÊï∞ÁöÑËøîÂõûÂÄº„ÄÇÂ¶ÇÊûúËøîÂõûÂÄº‰∏∫RET_PF_EMULATEÔºåÂàôË∑≥ËΩ¨Âà∞ <code>x86_emulate_instruction</code> ÂáΩÊï∞Âπ∂<strong>ÊúÄÁªàËøõÂÖ•QEMU‰∏≠Â§ÑÁêÜ„ÄÇ</strong></li>
</ul>
<h4 id="qemu‰∏≠piommioÂ§ÑÁêÜ">QEMU‰∏≠PIO/MMIOÂ§ÑÁêÜ
</h4><p>ÂΩìKVMÂ∞ÜÊéßÂà∂ÊµÅ‰∫§ÁªôQEMUÂêéÔºåÈáçÊñ∞ËøõÂÖ• <code>qemu_kvm_cpu_thread_fn</code> ÂáΩÊï∞ÊâßË°å <code>kvm_cpu_exec</code> ÂáΩÊï∞„ÄÇvCPU‰∏≠Áî®‰∫é‰øùÂ≠òVM-ExitÁõ∏ÂÖ≥‰ø°ÊÅØÁöÑrunÊàêÂëòÂèòÈáè‰ºöÈÄöËøámmapÊò†Â∞ÑÂà∞QEMUÊâÄÂú®ÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÔºåÊâÄ‰ª•QEMU‰∏≠ÁöÑ <code>kvm_cpu_exec</code> ÂáΩÊï∞ÂèØ‰ª•ÈÄöËøáÊ£ÄÊü• <code>kvm_run</code> ÁªìÊûÑ‰∏≠ÁöÑ <code>exit_reason</code>ÔºåÊ†πÊçÆÂÖ∂ÈÄÄÂá∫ÂéüÂõ†ËøõË°åËøõ‰∏ÄÊ≠•Â§ÑÁêÜ„ÄÇ</p>
<p>‰∏ãÈù¢ÊòØ <code>kvm_cpu_exec</code> ÂáΩÊï∞‰∏≠ÁöÑÁõ∏ÂÖ≥‰ª£Á†ÅÔºö</p>
<p><code>qemu-4.1.1/accel/kvm/kvm-all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212037698.png" alt="image-20231121203700601" style="zoom:33%;" />
<p>ÂÖ∂‰∏≠Ôºö</p>
<ul>
<li><code>KVM_EXIT_IO</code> ‰∏é <code>KVM_EXIT_MMIO</code> ÂàÜÂà´‰ª£Ë°®PIO‰∏éMMIOÁöÑexit_reasonÔºå<code>kvm_handle_io</code> ÂáΩÊï∞‰∏é<code>address_space_rw</code> ÂáΩÊï∞ÂàÜÂà´Áî®‰∫éÊ®°ÊãüPIO‰∏éMMIOËØ∑Ê±Ç„ÄÇ</li>
<li>Âú®vCPU‰∏≠ÁöÑrunÊàêÂëò‰∏≠ÂåÖÂê´<strong>io‰∏émmioËøô‰∏§‰∏™Êï∞ÊçÆÁªìÊûÑÔºåÁî®‰∫éÊèèËø∞PIO‰∏éMMIOÁõ∏ÂÖ≥‰ø°ÊÅØ„ÄÇ</strong>
<ul>
<li>io‰∏≠ÂÆö‰πâ‰∫ÜÊï∞ÊçÆ‰º†ËæìÁöÑÊñπÂêëÔºå0‰ª£Ë°®ËØªÁ´ØÂè£Ôºå1‰ª£Ë°®ÂÜôÁ´ØÂè£ÔºåÊñπÂêë‰ø°ÊÅØ‰øùÂ≠òÂú® <code>direction</code> ÊàêÂëò‰∏≠„ÄÇ<code>size/port/count</code> ÊàêÂëòÂàÜÂà´ÂÆö‰πâ‰∫ÜÊØèÊ¨°ËØªÂÜôÁöÑÊï∞ÊçÆÈïøÂ∫¶„ÄÅÁ´ØÂè£Âè∑„ÄÅÊï∞ÊçÆËØªÂÜôÊ¨°Êï∞Á≠â‰ø°ÊÅØ„ÄÇ<code>data_offset</code> ‰∏≠‰øùÂ≠ò‰∫ÜÊï∞ÊçÆÂú®kvm_run‰∏≠ÁöÑÂÅèÁßªÂú∞ÂùÄ„ÄÇËøô‰∫õ‰ø°ÊÅØÈÉΩ‰ºö‰Ωú‰∏∫ÂèÇÊï∞‰º†ÈÄíÁªô <code>kvm_handle_io</code> ÂáΩÊï∞ÔºåÁî®‰∫éËøõ‰∏ÄÊ≠•ÁöÑPIOÊ®°ÊãüÔºõ</li>
<li>mmioÁªìÊûÑÁõ∏ÂØπÁÆÄÂçïÔºå<code>phys_addr</code> Áî®‰∫é‰øùÂ≠ò64‰ΩçÁõÆÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºå<code>data</code> Áî®‰∫é‰øùÂ≠òËØªÂÜôÁöÑÊï∞ÊçÆÔºå<code>len</code> ‰ª£Ë°®Êï∞ÊçÆÈïøÂ∫¶Ôºå<code>is_write</code> ÂáΩÊï∞Á°ÆÂÆöÊòØËØªËøòÊòØÂÜô„ÄÇËøô‰∫õ‰ø°ÊÅØÂêåÊ†∑‰ºö‰Ωú‰∏∫ÂèÇÊï∞‰º†ÂÖ•mmioÂ§ÑÁêÜÂáΩÊï∞ <code>address_space_rw</code> ‰∏≠„ÄÇ</li>
</ul>
</li>
</ul>
<p><code>io/mmio</code> ÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/linux-headers/linux/kvm.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212036289.png" alt="image-20231121203606649" style="zoom:33%;" />
<hr>
<p>Âú®QEMU 4.1.1ÁâàÊú¨‰∏≠ÔºåPIOÁöÑÂ§ÑÁêÜÂáΩÊï∞ <code>kvm_handle_io</code> Êú¨Ë¥®‰∏äË∞ÉÁî®‰∫Ü‰∏éMMIO‰∏ÄÊ†∑ÁöÑ <code>address_space_rw</code> Êé•Âè£ÔºåÂå∫Âà´Âú®‰∫éPIO‰º†ÂÖ•ÁöÑÊòØI/OÂú∞ÂùÄÁ©∫Èó¥ <code>address_space_io</code> ÂáΩÊï∞ÔºåËÄåMMIO‰º†ÂÖ•ÁöÑÊòØÂÜÖÂ≠òÂú∞ÂùÄÁ©∫Èó¥ <code>address_space_memory</code> ÂáΩÊï∞„ÄÇ‰πãÂêé <code>address_space_rw</code> ‰ºöÂÆåÊàêÂØπÁõ∏Â∫îÂú∞ÂùÄÁöÑËØªÂÜôÊìç‰Ωú„ÄÇÂÖ∑‰ΩìËøáÁ®ãÂú®ÂÜÖÂ≠òËôöÊãüÂåñÊñáÊ°£‰∏≠Â∑≤Áªè‰ªãÁªçÔºåËøôÈáå‰∏çÂÜçËµòËø∞„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/accel/kvm/kvm-all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212039903.png" alt="image-20231121203903237" style="zoom:33%;" />
<h3 id="qemuÊ®°ÊãüËÆæÂ§áÂäüËÉΩ">QEMUÊ®°ÊãüËÆæÂ§áÂäüËÉΩ
</h3><p>È©±Âä®Á®ãÂ∫èÈÄöËøáËÆøÈóÆËÆæÂ§áÊèê‰æõÁöÑÂØÑÂ≠òÂô®Êé•Âè£Êù•‰ΩøÁî®ËÆæÂ§áÁöÑÁâπÂÆöÂäüËÉΩÔºåÊâÄ‰ª•**QEMU‰∏ç‰ªÖË¶ÅÂÆûÁé∞ÂØπËôöÊãüËÆæÂ§áÁöÑÁ´ØÂè£ÂíåËÆæÂ§áÂÜÖÂ≠òÁöÑËØªÂÜôÔºåÂêåÊó∂ÈúÄË¶ÅÊ®°ÊãüËôöÊãüËÆæÂ§áÁöÑÂäüËÉΩ„ÄÇ**‰∏ãÈù¢‰ªç‰ª• <code>edu</code> ËÆæÂ§á‰∏∫‰æã‰ªãÁªçËôöÊãüËÆæÂ§áÁöÑÂäüËÉΩÂÆûÁé∞„ÄÇ</p>
<p>‰∏é <code>edu</code> ËÆæÂ§áÂÖ∑Ë±°ÂåñÁõ∏ÂÖ≥ÁöÑÁ´†ËäÇÊèêÂà∞‰∫Ü <code>memory_region_init_io</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞‰ºöÂàùÂßãÂåñ‰∏Ä‰∏™Â§ßÂ∞è‰∏∫1MBÁöÑMMIOÂÜÖÂ≠òÂå∫ÂüüÔºåÂπ∂‰∏∫ËØ•MMIOÂÜÖÂ≠òÂå∫ÂüüÊ≥®ÂÜåËØªÂÜôÂáΩÊï∞ <code>edu_mmio_ops</code> „ÄÇ<code>edu_mmio_ops</code> ÊòØ‰∏Ä‰∏™MemoryRegionOpsÁ±ªÂûãÁöÑÁªìÊûÑ‰ΩìÔºå‰Ωú‰∏∫ÊàêÂëòÂèòÈáè‰øùÂ≠òÂú® <code>edu</code> ËÆæÂ§áÂØπÂ∫îÁöÑMMIO MemoryRegion‰∏≠„ÄÇ<code>edu_mmio_ops</code> ‰∏≠Ê≥®ÂÜåÁöÑ <code>edu_mmio_read</code> ÂáΩÊï∞‰∏é <code>edu_mmio_write</code> ÂáΩÊï∞‰ºöÊ†πÊçÆÊØèÊ¨°MMIOËÆøÈóÆÁöÑ‰ΩçÁΩÆÂíåÊï∞ÊçÆÈïøÂ∫¶ÊâßË°åÂØπÂ∫îÁöÑÂäüËÉΩÂáΩÊï∞ÔºåÂÖ∑‰ΩìÂäüËÉΩ‰ºöÂú®ÂêéÊñá‰ªãÁªç„ÄÇ</p>
<p>‰∏ãÂõæÂ±ïÁ§∫‰∫ÜËôöÊãüÊú∫Âêë <code>edu</code> ËÆæÂ§áMMIOÂÜÖÂ≠òÂå∫ÂüüÂèëËµ∑ËØªËÆøÈóÆÊó∂ÁöÑÂáΩÊï∞Ë∞ÉÁî®ÊµÅÁ®ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212042893.png" alt="image-20231121204033586" style="zoom: 50%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†QEMUÊâßË°åioctlÂáΩÊï∞ËøõÂÖ•KVMÔºõ‚ë°KVMÈÄÄÂá∫Âà∞QEMUÔºåÊâßË°åQEMUÁöÑMMIOÊ®°ÊãüÂáΩÊï∞„ÄÇ</p>
</blockquote>
<p><code>address_space_rw</code> ÂáΩÊï∞ÁªèËøáÂ±ÇÂ±ÇË∞ÉÁî®ÊúÄÁªà‰ºöËøõÂÖ• <code>memory_region_read_accessor</code> ÂáΩÊï∞Ôºå<code>memory_region_read_accessor</code> ÂáΩÊï∞ÈÄöËøá <code>mr-&gt;ops-&gt;read(mr-&gt;opaque,addr,size)</code> ‰ºöÂºïËµ∑eduËÆæÂ§á‰∏≠ <code>edu_mmio_read</code> ÂáΩÊï∞ÁöÑÂõûË∞É„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/memory.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311212041050.png" alt="image-20231121204140367" style="zoom:33%;" />
<blockquote>
<p><code>edu_mmio_read/edu_mmio_write</code> Â∞±ÊòØQEMUÂØπeduËÆæÂ§áÂäüËÉΩÁöÑÊ®°ÊãüÔºåËøô‰∏§‰∏™ÂáΩÊï∞‰ºöÊ†πÊçÆÊØèÊ¨°MMIOËÆøÈóÆÁöÑ‰ΩçÁΩÆÂíåÊï∞ÊçÆÈïøÂ∫¶ÊâßË°åÂØπÂ∫îÁöÑÂäüËÉΩÂáΩÊï∞ÔºåÂÖ∑‰ΩìÂú®3.4ËäÇÂÆûÈ™å‰∏≠‰ªãÁªç„ÄÇ</p>
</blockquote>
<h2 id="34-ÂÆûÈ™å-‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®">3.4 ÂÆûÈ™å: ‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®
</h2><blockquote>
<p>MasarykÂ§ßÂ≠¶ÁºñÂÜôeduËÆæÂ§áÁöÑÂàùË°∑ÊòØÁî®‰∫éÂÜÖÊ†∏ËÆæÂ§áÈ©±Âä®ÁöÑÊïôÂ≠¶ÔºåLinuxÂÜÖÊ†∏‰∏≠Âπ∂‰∏çÂ≠òÂú®eduËÆæÂ§áÁöÑÈ©±Âä®Á®ãÂ∫è„ÄÇ</p>
</blockquote>
<p>Êú¨ËäÇÂ∞Ü‰ª•ÂÆûÈ™åÁöÑÂΩ¢Âºè**‰∏∫eduËÆæÂ§áÁºñÂÜôÁõ∏Â∫îÁöÑÈ©±Âä®Á®ãÂ∫èÔºå**ÁõÆÁöÑÊòØ‰∏∫‰∫ÜÊõ¥Âä†Ê∏ÖÊô∞Áõ¥ËßÇÂú∞Â±ïÁ§∫ËôöÊãüËÆæÂ§áËÉåÂêéÁöÑËøêË°åÂéüÁêÜ„ÄÇÊú¨ËäÇÂàÜ‰∏∫‰∏âÈÉ®ÂàÜÔºö</p>
<ul>
<li>Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÂàÜÊûê‰∏éeduËÆæÂ§áÂäüËÉΩÁõ∏ÂÖ≥ÁöÑÂØÑÂ≠òÂô®Ôºõ</li>
<li>Á¨¨‰∫åÈÉ®ÂàÜÔºö‰ªãÁªçÂú®È©±Âä®‰∏≠Â¶Ç‰ΩïËÆøÈóÆeduËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥ÂíåMMIOÁ©∫Èó¥„ÄÅÂèëËµ∑DMAËØ∑Ê±Ç‰ª•ÂèäÂ§ÑÁêÜËÆæÂ§á‰∏≠Êñ≠Ôºõ</li>
<li>Á¨¨‰∏âÈÉ®ÂàÜÔºöÊºîÁ§∫ÂÆûÈ™åÁöÑÊï¥‰ΩìÊµÅÁ®ã„ÄÇ</li>
</ul>
<p>‰∏äÊñáÊèêÂà∞ÁöÑ <code>edu_mmio_read</code> ÂáΩÊï∞Âíå <code>edu_mmio_write</code> ÂáΩÊï∞ÊòØeduËÆæÂ§áÁöÑÊ†∏ÂøÉÔºåÂΩìËÆøÈóÆÁöÑÂú∞ÂùÄÂú®MMIOÂÜÖÂ≠òÂå∫ÂüüÁöÑÂÅèÁßªÂ∞è‰∫é <code>0x80</code> Êó∂ÔºåÂè™ÂÖÅËÆ∏4Â≠óËäÇÂ§ßÂ∞èÁöÑËÆøÈóÆÔºõÂΩìÂú∞ÂùÄÂÅèÁßªÂ§ß‰∫éÊàñÁ≠â‰∫é <code>0x80</code> Êó∂ÔºåÂÖÅËÆ∏4Â≠óËäÇÊàñ8Â≠óËäÇÁöÑÊï∞ÊçÆËÆøÈóÆ„ÄÇ</p>
<h3 id="eduËÆæÂ§áÂäüËÉΩÊ®°Êãü">eduËÆæÂ§áÂäüËÉΩÊ®°Êãü
</h3><p>eduËÆæÂ§áÂú®MMIOÂÜÖÂ≠òÂå∫ÂüüÂÜÖ‰ºöËÆæÁΩÆ‰∏Ä‰∫õÁâπÊÆäÁöÑÂú∞ÂùÄÂπ∂Ëµã‰∫àËøô‰∫õÂú∞ÂùÄ‰∏çÂêåÁöÑËØªÂÜôÊùÉÈôêÔºåÈ©±Âä®ËØªÂÜôËøô‰∫õÂú∞ÂùÄÊó∂‰ºöËß¶ÂèëÁõ∏Â∫îÁöÑÂäüËÉΩ„ÄÇ‰∏ãÊñá‰ºö‰ªãÁªçËøô‰∫õÁâπÊÆäÁöÑÂú∞ÂùÄ„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221329672.png" alt="image-20231122132934509" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221331501.png" alt="image-20231122133036435" style="zoom:33%;" />
<ul>
<li>
<p><code>0x00(RO)</code>Ôºö0x00ÊùÉÈôê‰∏∫Âè™ËØªÔºåËØª0x00Êó∂‰ºöËøîÂõûeduËÆæÂ§áÁöÑÊ†áËØÜÁ¨¶ <code>0x010000edu</code>Ôºõ</p>
</li>
<li>
<p><code>0x04(RW)</code>Ôºö0x04ÊùÉÈôê‰∏∫ÂèØËØªÂèØÂÜôÔºåËØª0x04Êó∂‰ºöËøîÂõûeduËÆæÂ§á‰∏≠ <code>addr4</code> ÊàêÂëòÂèòÈáèÁöÑÂÄºÔºåÂÜô0x04Êó∂‰ºöÂ∞ÜÂÜôÂÖ•ÁöÑÊï∞ÊçÆÂèñÂèç‰πãÂêéËµãÂÄºÁªô <code>addr4</code>Ôºõ</p>
</li>
<li>
<p><code>0x08(RW)</code>Ôºö0x08Áî®‰∫éÈò∂‰πòËÆ°ÁÆóÔºåÊùÉÈôê‰∏∫ÂèØËØªÂèØÂÜô„ÄÇ</p>
<ul>
<li>
<p>ËØª0x08Êó∂Ôºå‰ºöËøîÂõûeduËÆæÂ§á‰∏≠ <code>fact</code> ÊàêÂëòÂèòÈáèÁöÑÂÄºÔºå<code>fact</code> Ë°®Á§∫Èò∂‰πòÁªìÊûúÔºõ</p>
</li>
<li>
<p>ÂÜô0x08Êó∂Ôºå‰ºöÂ∞ÜÂÜôÂÖ•ÁöÑÊï∞ÊçÆËµãÂÄºÁªô <code>fact</code>ÔºåÁÑ∂ÂêéeduËÆæÂ§áÁöÑ <code>status</code> ‰ºö‰∏éÂÆèÂèòÈáè <code>EDU_STATUS_COMPUTING</code> ÂÅöÊàñËøêÁÆóÔºåÂπ∂Â∞ÜËøêÁÆóÁªìÊûúËµãÂÄºÁªô <code>status</code> „ÄÇËøô‰∏™ÂÆèÂèòÈáèÁöÑÂÄº‰∏∫0x1Ôºå‰ª£Ë°®Ê≠§Êó∂eduËÆæÂ§áÂ§Ñ‰∫éÈò∂‰πòËÆ°ÁÆóÁä∂ÊÄÅ„ÄÇ</p>
<ul>
<li>
<p>‰πãÂêé‰ºöÈÄöËøá <code>qemu_cond_signal</code> ÂáΩÊï∞Âî§ÈÜíÂú®eduËÆæÂ§áÂÖ∑Ë±°ÂåñÊó∂ÂàõÂª∫ÁöÑ <code>edu_fact_thread</code> Á∫øÁ®ãÔºåËØ•Á∫øÁ®ãÁî®‰∫éÈò∂‰πòËÆ°ÁÆó„ÄÇ<code>edu_fact_thread</code> ÂáΩÊï∞Âú®Èò∂‰πòËÆ°ÁÆóÁªìÊùüÂêé‰ºöÊâßË°å <code>atomic_and(&amp;edu-&gt;status,~EDU_STATUS_COMPUTING)</code>ÔºåÊîπÂèòeduËÆæÂ§áÁöÑ<code>status</code>„ÄÇ</p>
<ul>
<li>
<p>‰πãÂêé <code>edu_fact_thread</code> ÂáΩÊï∞‰ºöÊ£ÄÊü• <code>status</code> Âíå <code>EDU_STATUS_IRQFACT(0x80)</code> ‰∏éËøêÁÆóÁöÑÁªìÊûúÔºåÁ≠â‰ª∑‰∫éÊ£ÄÊü• <code>status</code> ÁöÑÁ¨¨7‰ΩçÊòØÂê¶‰∏∫1„ÄÇËã•‰∏∫1Ôºå‰ª£Ë°®eduËÆæÂ§áË¢´ËÆæÁΩÆ‰∏∫ÊâßË°åÂÆå‰∏ÄÊ¨°Èò∂‰πòÂêéÈúÄË¶ÅÂèëÈÄÅ‰∏≠Êñ≠ÔºåÊ≠§Êó∂ <code>edu_fact_thread</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>edu_raise_irq</code> ÂáΩÊï∞ÂêëËôöÊãüÊú∫ÂèëÈÄÅ‰∏≠Êñ≠„ÄÇ</p>
<p><code>edu_fact_thread</code> ÂáΩÊï∞‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221333437.png" alt="image-20231122133307817" style="zoom:33%;" />
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>0x20(RW)</code>Ôºö0x20ÊùÉÈôê‰∏∫ÂèØËØªÂèØÂÜô„ÄÇËØª0x20Êó∂‰ºöËøîÂõûeduËÆæÂ§áÁöÑ <code>status</code>„ÄÇÂØπ0x20ÂÜôÊó∂Ôºå‰ºöÂ∞ÜÂÜôÂÖ•Êï∞ÊçÆÁ¨¨7‰ΩçÁöÑÂÄºËµãÁªô <code>status</code> ÁöÑÁ¨¨7‰ΩçÔºåÁî®‰∫éÂÜ≥ÂÆö<strong>ÊØèÊ¨°Èò∂‰πòÂêéÊòØÂê¶ÂêëËôöÊãüÊú∫ÂèëÈÄÅ‰∏≠Êñ≠„ÄÇ</strong></p>
</li>
<li>
<p><code>0x24(RO)</code>Ôºö0x24ÊùÉÈôê‰∏∫Âè™ËØª„ÄÇÂØπ0x24ËØªÊó∂‰ºöËøîÂõûeduËÆæÂ§áÁöÑ <code>irq_status</code>Ôºå‰ª£Ë°®‰∏≠Êñ≠‰∫ßÁîüÁöÑÂéüÂõ†„ÄÇÈ©±Âä®‰∏≠ÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫èÂèØ‰ª•ÈÄöËøáËØª0x24Êù•Ëé∑Âèñ <code>irq_status</code>„ÄÇ</p>
</li>
<li>
<p><code>0x60(WO)</code>Ôºö0x60ÊùÉÈôê‰∏∫Âè™ÂÜô„ÄÇÂêë0x60ÂÜôÊï∞ÊçÆÊó∂Ôºå‰ºöË∞ÉÁî® <code>edu_raise_irq</code> ÂáΩÊï∞Ôºå<code>edu_raise_irq</code> ÂáΩÊï∞ÈÄöËøá <code>pci_set_irq</code> Êé•Âè£ÂêëËôöÊãüÊú∫ÂèëÈÄÅ‰∏≠Êñ≠ÔºåÂêåÊó∂‰ºöÊää <code>irq_status</code> ÂíåÂÜôÂÖ•Êï∞ÊçÆÁöÑÊàñËøêÁÆóÁªìÊûúËµãÂÄºÁªô <code>irq_status</code>„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221334205.png" alt="image-20231122133416887" style="zoom:33%;" />
</li>
<li>
<p><code>0x64(WO)</code>Ôºö0x64ÊùÉÈôê‰∏∫Âè™ÂÜô„ÄÇ0x64Áî®‰∫é‰∏≠Êñ≠Â∫îÁ≠îÔºåÂ∞Ü‰∏≠Êñ≠Âú® <code>irq_status</code> ‰∏≠Ê∏ÖÈô§ÔºåÂÅúÊ≠¢ÁîüÊàêËØ•‰∏≠Êñ≠„ÄÇÂêë0x64ÂÜôÊï∞ÊçÆÊó∂Ôºå‰ºöË∞ÉÁî®<code>edu_lower_irq</code> ÂáΩÊï∞„ÄÇ<code>edu_lower_irq</code> ÂáΩÊï∞‰ºöÊääÂÜôÂÖ•ÁöÑÊï∞ÊçÆÂèñÂèçÂêéÂíå <code>irq_status</code> ËøõË°å‰∏éËøêÁÆóÔºåÂπ∂Â∞ÜÊúÄÁªàÁªìÊûúËµãÂÄºÁªô <code>irq_status</code>„ÄÇÈÄöÂ∏∏È©±Âä®‰∏≠ÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫èÂêë0x64Á´ØÂè£ÂÜôÂÖ•ÁöÑÂÄº‰∏∫ <code>irq_status</code>ÔºåËøôÊ†∑‰æøÂèØ‰ª•Â∞Ü <code>irq_status</code> ÁöÑÂÄºÁΩÆÈõ∂„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/misc/edu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221336914.png" alt="image-20231122133600566" style="zoom:33%;" />
</li>
<li>
<p><code>0x80(RW)</code>Ôºö0x80ÁöÑÊùÉÈôê‰∏∫ÂèØËØªÂèØÂÜô„ÄÇËØª0x80Êó∂Ôºå‰ºöËøîÂõûeduËÆæÂ§áÁöÑ <code>dma.src</code>„ÄÇÂØπ0x80ÂÜôÊó∂Ôºå‰ºöÂ∞ÜÂÜôÂÖ•Êï∞ÊçÆËµãÂÄºÁªôeduËÆæÂ§áÁöÑ <code>dma.src</code>„ÄÇ<code>dma.src</code> ‰ª£Ë°®DMAÁöÑÊ∫êÂú∞ÂùÄ„ÄÇ</p>
</li>
<li>
<p><code>0x88(RW)</code>Ôºö0x88ÁöÑÊùÉÈôê‰∏∫ÂèØËØªÂèØÂÜô„ÄÇËØª0x88Êó∂Ôºå‰ºöËøîÂõûeduËÆæÂ§áÁöÑ <code>dma.dst</code>„ÄÇÂØπ0x88ÂÜôÊó∂Ôºå‰ºöÂ∞ÜÂÜôÂÖ•Êï∞ÊçÆËµãÂÄºÁªôeduËÆæÂ§áÁöÑ <code>dma.dst</code>„ÄÇ<code>dma.dst</code> ‰ª£Ë°®DMAÁöÑÁõÆÁöÑÂú∞ÂùÄ„ÄÇ</p>
</li>
<li>
<p><code>0x90(RW)</code>Ôºö0x90ÁöÑÊùÉÈôê‰∏∫ÂèØËØªÂÜô„ÄÇËØª0x90Êó∂Ôºå‰ºöËøîÂõûeduËÆæÂ§áÁöÑ <code>dma.cnt</code>„ÄÇÂØπ0x90ÂÜôÊó∂Ôºå‰ºöÂ∞ÜÂÜôÂÖ•Êï∞ÊçÆËµãÂÄºÁªôeduËÆæÂ§áÁöÑ <code>dma.cnt</code>„ÄÇ<code>dma.cnt</code> ‰ª£Ë°®DMA‰º†ËæìÁöÑÂ≠óËäÇÊï∞„ÄÇ</p>
</li>
<li>
<p><code>0x98(RW)</code>Ôºö0x98ÁöÑÊùÉÈôê‰∏∫ÂèØËØªÂèØÂÜôÔºåË¢´Áî®‰Ωú<strong>DMAÂëΩ‰ª§ÂØÑÂ≠òÂô®„ÄÇ</strong></p>
<ul>
<li>Á¨¨0‰Ωç‰∏∫1‰ª£Ë°®ÂºÄÂßãDMA‰º†ËæìÔºõ</li>
<li>Á¨¨1‰ΩçÂÜ≥ÂÆöDMAÊï∞ÊçÆ‰º†ËæìÁöÑÊñπÂêëÔºö
<ul>
<li>0‰ª£Ë°®‰ªéRAMÂà∞eduËÆæÂ§áÔºõ</li>
<li>1‰ª£Ë°®eduËÆæÂ§áÂà∞RAMÔºõ</li>
</ul>
</li>
<li>Á¨¨2‰ΩçÂÜ≥ÂÆöÊòØÂê¶Âú®DMAÁªìÊùü‰πãÂêéÂêëËôöÊãüÊú∫ÂèëËµ∑‰∏≠Êñ≠ÔºåÂπ∂Â∞Ü <code>irq_status</code> ËÆæÁΩÆ‰∏∫0x100„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®">‰∏∫eduËÆæÂ§áÊ∑ªÂä†ËÆæÂ§áÈ©±Âä®
</h3><blockquote>
<p>Êú¨ËäÇÂ∞Ü‰ªãÁªçÂ¶Ç‰ΩïÂú®ËôöÊãüÊú∫‰∏≠‰∏∫eduËÆæÂ§áÊ∑ªÂä†Áõ∏Â∫îÁöÑËÆæÂ§áÈ©±Âä®ÔºåÂπ∂ËÆæËÆ°ÊµãËØïÁ®ãÂ∫è‰ΩøÁî®eduËÆæÂ§á„ÄÇ</p>
</blockquote>
<p>ÂΩìÂä†ËΩΩeduËÆæÂ§áÈ©±Âä®Ê®°ÂùóÊó∂ÔºåPCIÊÄªÁ∫ø‰ºöÈÅçÂéÜÊÄªÁ∫ø‰∏äÂ∑≤ÁªèÊ≥®ÂÜåÁöÑËÆæÂ§áÔºåË∞ÉÁî®ÊÄªÁ∫øÁöÑmatchÂáΩÊï∞Âà§Êñ≠ÊòØÂê¶ÊúâÂåπÈÖçÁöÑËÆæÂ§áÔºåÂåπÈÖçÁöÑ‰æùÊçÆÊòØÈ©±Âä®Êèê‰æõÁöÑ<code>pci_device_id</code>„ÄÇeduËÆæÂ§áÊ∫êÁ†Å‰∏≠ÂÆö‰πâÁöÑ <code>vendor_id</code> ÂíåeduËÆæÂ§áid‰ºöË¢´Âä†ÂÖ•È©±Âä®‰ª£Á†Å‰∏≠ÁöÑ <code>pci_device_id</code> Êï∞ÁªÑ <code>pci_ids[]</code> ‰∏≠Ôºå‰ª•ÂÆûÁé∞**È©±Âä®ÂíåeduËÆæÂ§áÁöÑÂåπÈÖç„ÄÇ**ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>edu_driver.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221337579.png" alt="image-20231122133703795" style="zoom:33%;" />
<p>‰∏∫eduËÆæÂ§áÈ©±Âä®ÁºñÂÜô <code>file_operations</code> ‰∏≠ÁöÑ <code>write</code> ÂáΩÊï∞Âíå <code>read</code> ÂáΩÊï∞ÂèØ‰ª•ÊåâÁÖßPCIËÆæÂ§áÈ©±Âä®ÁºñÂÜôÁöÑ‰∏ÄËà¨ÊñπÊ≥ïÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">edu_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">kbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">kbuf</span> <span class="o">=</span> <span class="nf">ioread32</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">edu_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">kbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">iowrite32</span><span class="p">(</span><span class="n">kbuf</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>Áî±‰∫éeduËÆæÂ§áÁöÑÁâπÊÆäÊÄßÔºåeduËÆæÂ§áÈ©±Âä®ÈúÄË¶Å‰∏∫eduËÆæÂ§áËÆæËÆ°‰∏ìÈó®ÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÂáΩÊï∞‰∏é <code>probe</code> ÂáΩÊï∞‰ª•ÂèäÁî®‰∫éÊéßÂà∂eduËÆæÂ§áÁöÑÂ§öÁßçÂäüËÉΩÁöÑ <code>ioctl</code> ÂáΩÊï∞„ÄÇ</p>
<h4 id="pci_probe">pci_probe
</h4><p>ÂΩìÈ©±Âä®ÂíåËÆæÂ§áÂÆåÊàêÂåπÈÖç‰πãÂêé‰ºöË∞ÉÁî® <code>probe</code> ÂáΩÊï∞ÊâßË°åËÆæÂ§áÁöÑÁõ∏ÂÖ≥ÂàùÂßãÂåñÂ∑•‰Ωú„ÄÇ</p>
<ol>
<li><code>pci_probe</code> ÂáΩÊï∞‰∏≠È¶ñÂÖà‰ΩøÁî® <code>register_chrdev</code> ÂáΩÊï∞Êù•Ê≥®ÂÜåeduËÆæÂ§áÔºåÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞‰∏∫0‰ª£Ë°®‰ΩøÁî®Á≥ªÁªüÂä®ÊÄÅÂàÜÈÖçÁöÑ‰∏ªËÆæÂ§áÂè∑„ÄÇ</li>
<li><code>pci_iomap</code> ÂáΩÊï∞‰ºöËøîÂõûÁî®‰∫éË°®Á§∫eduËÆæÂ§áÁöÑPCI BARÁöÑI/OÂú∞ÂùÄÁ©∫Èó¥ÁöÑ <code>__iomem</code> Á±ªÂûãÊåáÈíà„ÄÇÂêéÁª≠ <code>iowrite*</code> Âíå <code>ioread*</code> ÂáΩÊï∞‰ºöÈÄöËøáËé∑ÂæóÁöÑ<code>__iomem</code> Âú∞ÂùÄÂØπeduËÆæÂ§áÁöÑMMIOÂå∫ÂüüËøõË°åËØªÂÜô„ÄÇ</li>
<li><code>pci_probe</code> ÂáΩÊï∞ÊúÄÂêé‰ºöÂêëÂÜÖÊ†∏Ê≥®ÂÜåeduËÆæÂ§áÁöÑ‰∏≠Êñ≠ÊúçÂä°ÂáΩÊï∞ <code>irq_handler</code>ÔºåËØ•ÂáΩÊï∞ÊòØ‰∏Ä‰∏™ÂõûË∞ÉÂáΩÊï∞„ÄÇÂΩì‰∏≠Êñ≠Ê≥®ÂÖ•ËôöÊãüÊú∫Êó∂‰ºöË∞ÉÁî® <code>irq_handler</code> ÂáΩÊï∞ÔºåÂπ∂Â∞ÜËÆæÂ§áÂè∑‰º†ÈÄíÁªôÂÆÉ„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ol>
<p><code>edu_driver.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221339374.png" alt="image-20231122133908748" style="zoom:33%;" />
<h4 id="irq_handler">irq_handler
</h4><p><code>pci_probe</code> ÂáΩÊï∞Ê≥®ÂÜå‰∫Ü <code>irq_handler</code> ÂáΩÊï∞Áî®‰∫é‰∏≠Êñ≠Â§ÑÁêÜ„ÄÇËØ•ÂáΩÊï∞È¶ñÂÖàÊ†πÊçÆ‰∏ªËÆæÂ§áÂè∑Âà§Êñ≠‰∏≠Êñ≠ÊòØÂê¶Â±û‰∫éeduËÆæÂ§áÔºå‰πãÂêé <code>irq_handler</code> ÂáΩÊï∞‰ºöËØªÂèñeduËÆæÂ§áÁöÑ <code>irq_status</code> Âπ∂Âà§Êñ≠‰∫ßÁîüËØ•‰∏≠Êñ≠ÁöÑÂéüÂõ†„ÄÇ**‰∏∫‰∫ÜÂå∫ÂàÜDMAËØª‰∏≠Êñ≠„ÄÅDMAÂÜô‰∏≠Êñ≠‰ª•ÂèäÈò∂‰πòËøêÁÆó‰∫ßÁîüÁöÑ‰∏≠Êñ≠ÔºåeduËÆæÂ§áÊ∫êÁ†ÅÈúÄË¶ÅË¢´‰øÆÊîπ„ÄÇ**ÂÖ∑‰ΩìÊîπÂä®Â¶Ç‰∏ãÔºö</p>
<ul>
<li>ÂΩì‰∫ßÁîüDMAËØª‰∏≠Êñ≠Êó∂‰ºöÂ∞ÜeduËÆæÂ§áÁöÑ <code>irq_status</code> ËÆæÁΩÆ‰∏∫0x100Ôºõ</li>
<li>ÂΩì‰∫ßÁîüDMAÂÜô‰∏≠Êñ≠Êó∂‰ºöÂ∞Ü <code>irq_status</code> ËÆæÁΩÆ‰∏∫0x101Ôºõ</li>
<li>ÂΩì <code>irq_status</code> Á≠â‰∫é0x1Êó∂‰ª£Ë°®Èò∂‰πòËøêÁÆó‰∏≠Êñ≠„ÄÇ</li>
</ul>
<p>ÊâìÂç∞Âá∫eduËÆæÂ§á‰∏≠Êñ≠ÁöÑÂéüÂõ†ÂêéÔºå<code>irq_handler</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>iowrite32</code> ÂáΩÊï∞ÔºåÂ∞Ü <code>irq_status</code> ÂÜôÂÖ•‰∏äÊñáÊèêÂà∞ÁöÑx64ÂØÑÂ≠òÂô®Ôºå‰ª•Ê≠§ÂêëeduËÆæÂ§áÂèëÈÄÅ‰∏Ä‰∏™‰∏≠Êñ≠Â∫îÁ≠î„ÄÇeduËÆæÂ§á‰ºöÊåâÁÖß‰∏äÊñá‰ªãÁªçÁöÑÊñπÂºèÂ∞Ü <code>irq_status</code> ÁΩÆÈõ∂ÔºåÂπ∂Êãâ‰Ωé‰∏≠Êñ≠Á∫øÁîµÂπ≥„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>edu_driver.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221339653.png" alt="image-20231122133947040" style="zoom:33%;" />
<h4 id="edu_ioctl">edu_ioctl
</h4><blockquote>
<p>eduËÆæÂ§áÁöÑÁâπÊÆäÂäüËÉΩËæÉÂ§öÔºå‰∏∫‰∫Ü‰Ωø‰ª£Á†ÅÁªìÊûÑÊõ¥Ê∏ÖÊô∞ÔºåÈúÄË¶ÅËÆæËÆ° <code>edu_ioctl</code> ÂáΩÊï∞ÂØπeduËÆæÂ§áÁöÑÁâπÊÄßËøõË°åÊéßÂà∂„ÄÇÁî®Êà∑Á®ãÂ∫èÁöÑ <code>ioctl</code> ÂáΩÊï∞‰∏éÈ©±Âä®Â±ÇÁöÑ<code>edu_ioctl</code> ÂáΩÊï∞ÈÖçÂêàÔºåÂÆûÁé∞ÂêëËÆæÂ§á‰º†ÈÄíÊéßÂà∂ÂëΩ‰ª§„ÄÇ</p>
</blockquote>
<p><code>ioctl</code> ÂáΩÊï∞ÁöÑcmdÂèÇÊï∞ÂÖ∑Êúâ‰ª•‰∏ã‰∫îÁßçÊéßÂà∂ÂëΩ‰ª§ÔºåÊØèÊù°ÂëΩ‰ª§ÂàÜÂà´ÊéßÂà∂eduËÆæÂ§áÁöÑ‰∏ÄÈ°πÂäüËÉΩÔºö</p>
<ul>
<li><code>DMA_WRITE_CMD</code> ‰ª£Ë°®ÂèëËµ∑‰∏ÄÊ¨°DMAÂÜôÊìç‰ΩúÔºå‰∏ªË¶ÅËÆæÁΩÆDMAÁöÑÊ∫êÂú∞ÂùÄ„ÄÅDMAÁöÑÁõÆÁöÑÂú∞ÂùÄ„ÄÅDMA‰º†ËæìÁöÑÊï∞ÊçÆÈïøÂ∫¶‰ª•ÂèäeduËÆæÂ§áÂÆö‰πâÁöÑDMAÁªÑÂêàÊåá‰ª§„ÄÇ<code>DMA_CMD|DMA_TO_MEM|DMA_IRQ</code> Ëøô‰∏ÄÁªÑÂêàÊåá‰ª§‰ª£Ë°®ËøõË°åDMAÂÜôÔºåÂπ∂‰∏îÂú®DMAÁªìÊùüÂêéÂêëËôöÊãüÊú∫ÂèëÈÄÅ‰∏≠Êñ≠„ÄÇ</li>
<li><code>DMA_READ_CMD</code> ‰ª£Ë°®ÂèëËµ∑‰∏ÄÊ¨°ËØªÊìç‰ΩúÔºåËøáÁ®ã‰∏é <code>DMA_WRITE_CMD</code> Á±ª‰ºº„ÄÇ</li>
<li><code>PRINT_EDUINFO_CMD</code> ‰ª£Ë°®ÊâìÂç∞eduËÆæÂ§áÁöÑÂü∫Êú¨‰ø°ÊÅØÔºåÂåÖÊã¨eduËÆæÂ§áMMIOÂå∫ÂüüÁöÑÂ§ßÂ∞è„ÄÅÈÖçÁΩÆÁ©∫Èó¥Ââç64Â≠óËäÇÁöÑ‰ø°ÊÅØ„ÄÅeduËÆæÂ§áÁî≥ËØ∑ÁöÑÁ°¨‰ª∂‰∏≠Êñ≠Âè∑„ÄÅMMIOÂå∫ÂüüÈÉ®ÂàÜÂàùÂßãÂåñÁöÑÂÄº„ÄÇ</li>
<li><code>SEND_INTERRUPT_CMD</code> ÂëΩ‰ª§‰ºöÂÜô0x60ÂØÑÂ≠òÂô®ÔºåÊ≠§Êó∂eduËÆæÂ§á‰ºöÂèëÈÄÅ‰∏≠Êñ≠ÔºåÂπ∂Â∞Ü <code>irq_status</code> ËÆæÁΩÆ‰∏∫0x12345678„ÄÇ</li>
<li><code>FACTORIAL_CMD</code> ÂëΩ‰ª§‰ª£Ë°®ÂèëËµ∑‰∏ÄÊ¨°Èò∂‰πòËøêÁÆóÔºåÈ¶ñÂÖàeduÈ©±Âä®‰ºöÂêë <code>0x20</code> ÂØÑÂ≠òÂô®ÂÜôÂÖ•ÂÄº0x80ÔºåËøôÊ≠•ÁöÑ‰ΩúÁî®ÊòØËÆæÁΩÆeduËÆæÂ§áÂú®Èò∂‰πòÁªìÊùüÂêéÂèëÈÄÅ‰∏≠Êñ≠„ÄÇ‰πãÂêéÁî®‰∫éÈò∂‰πòËøêÁÆóÁöÑÂÄº‰ºöË¢´ÂÜôÂÖ•0x8ÂØÑÂ≠òÂô®ÔºåÂÆûÈ™å‰∏≠Áî®‰∫éÈò∂‰πòËÆ°ÁÆóÁöÑÂÄºÊòØ10„ÄÇ</li>
</ul>
<p><code>edu_ioctl</code> ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>edu_driver.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221342332.png" alt="image-20231122134119769" style="zoom:33%;" />
<h3 id="Êï¥‰ΩìÂÆûÈ™åÊµÅÁ®ã">Êï¥‰ΩìÂÆûÈ™åÊµÅÁ®ã
</h3><blockquote>
<p>‰∏∫‰∫ÜÊõ¥Â•ΩÂú∞Â±ïÁ§∫ÂÆûÈ™åÁªìÊûúÔºåÊú¨ËäÇËÆæËÆ°‰∫Ü‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁî®Êà∑ÊÄÅÊµãËØïÁ®ãÂ∫èÔºåÂπ∂Âú®eduËÆæÂ§áÊ∫êÁ†ÅÁöÑÂÖ≥ÈîÆ‰ΩçÁΩÆÊ∑ªÂä†‰∫ÜÁõ∏Â∫îÁöÑËæìÂá∫‰ø°ÊÅØ„ÄÇ</p>
</blockquote>
<p>ÂÆûÈ™åÁ¨¨‰∏ÄÊ≠•ÊòØÂú®QEMU‰∏≠ÂêØÂä®Â∏¶ÊúâeduËÆæÂ§áÁöÑËôöÊãüÊú∫ÔºåÊú¨Ê¨°ÂÆûÈ™åÁöÑÂêØÂä®ÂèÇÊï∞Â¶Ç‰∏ãÔºö</p>
<p><code>boot.sh</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221342184.png" alt="image-20231122134231280" style="zoom:33%;" />
<p>ËøõÂÖ•ËôöÊãüÊú∫ÂêéÔºåÂú®ÁªàÁ´ØËæìÂÖ• <code>lspci</code> ÂëΩ‰ª§ÔºåÊ†πÊçÆeduÁöÑËÆæÂ§áÂè∑‰ª•Âèä <code>vendor ID</code> Âú®PCIËÆæÂ§áÂàóË°®‰∏≠ÂèØ‰ª•Êü•ËØ¢Âà∞eduËÆæÂ§áË¢´ÊåÇËΩΩÂà∞‰∫Ü0Âè∑ÊÄªÁ∫øÁöÑ04Âè∑ÊßΩÔºö</p>
<p><code>lspci</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221345306.png" style="zoom: 50%;" />
<p>Êé•ÁùÄËæìÂÖ• <code>lspci-s 00:04.0-vvv-xxxx</code> ÂëΩ‰ª§Ôºå‰ºöÊòæÁ§∫eduËÆæÂ§áÁöÑÂü∫Êú¨‰ø°ÊÅØÔºåÂåÖÊã¨eduËÆæÂ§áÁöÑ‰∏≠Êñ≠‰ø°ÊÅØ„ÄÅMMIOÂú∞ÂùÄÁ©∫Èó¥‰ø°ÊÅØ‰ª•ÂèäËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥‰ø°ÊÅØÁ≠â„ÄÇ</p>
<p><code>lspci-s 00:04.0-vvv-xxxx</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221346763.png" alt="image-20231122134620958" style="zoom:33%;" />
<hr>
<p>‰∏äÊñá‰ªãÁªç‰∫Ü <code>edu_mmio_read</code> ÂáΩÊï∞ÁöÑÂõûË∞ÉËøáÁ®ãÔºåÊâÄ‰ª•ÂÆûÈ™åÁöÑÁ¨¨‰∏ÄÊ≠•È¶ñÂÖàÂØπ <code>edu_mmio_read</code> ÂáΩÊï∞ÁöÑË∞ÉÁî®ËøáÁ®ãËøõË°åÈ™åËØÅ„ÄÇÂÖ∑‰ΩìËøáÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>Âú®QEMU‰∏≠ÂêØÂä®ËôöÊãüÊú∫ÂêéÔºåÊâìÂºÄÂè¶Â§ñ‰∏Ä‰∏™Ë∂ÖÁ∫ßÁªàÁ´ØÔºåÈÄöËøá <code>ps-aux|grep qemu</code> ÂëΩ‰ª§Êù•Êü•ËØ¢QEMUÁöÑËøõÁ®ãÂè∑Ôºõ</li>
<li>‰πãÂêéÂú®ÁªàÁ´Ø‰∏≠ÂêØÂä®GDBË∞ÉËØïÔºåÂú®GDBÂëΩ‰ª§Ë°å‰∏≠ËæìÂÖ• <code>attach</code> + QEMUËøõÁ®ãÂè∑ÔºåË∞ÉËØïÊ≠£Âú®ËøêË°åÁöÑQEMUÁ®ãÂ∫èÔºõ</li>
<li>Êé•ÁùÄÂú®GDB‰∏≠‰∏∫ <code>edu_mmio_read</code> ÂáΩÊï∞ËÆæÁΩÆÊñ≠ÁÇπÔºåËæìÂÖ• <code>c</code> ÁªßÁª≠ÊâßË°åQEMUÁ®ãÂ∫èÔºõ</li>
<li>ÁÑ∂ÂêéÂú®ËôöÊãüÊú∫‰∏≠Âä†ËΩΩeduËÆæÂ§áÁöÑÈ©±Âä®Ê®°ÂùóÔºåÊ≠§Êó∂GDB‰ºöÊòæÁ§∫QEMUÁöÑÊâßË°åÂÅúÂú®‰∫Ü <code>edu_mmio_read</code> ÂáΩÊï∞Â§Ñ„ÄÇ</li>
</ol>
<p>GDB‰∏≠Êèê‰æõ‰∫Ü <code>backtrace</code> ÂëΩ‰ª§Áî®‰∫éÊü•ÁúãÂáΩÊï∞ÁöÑË∞ÉÁî®Ê†à„ÄÇÊúÄÂêéËæìÂÖ• <code>backtrace</code> ÂëΩ‰ª§ÔºåGDB‰ºöÊòæÁ§∫‰ª•‰∏ãÁªìÊûúÔºö</p>
<p><code>GDB backtrace</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221348087.png" alt="image-20231122134735967" style="zoom:33%;" />
<p><code>backtrace</code> ÁöÑËæìÂá∫ÁªìÊûúÂ±ïÁ§∫‰∫ÜÂú∞ÂùÄËΩ¨Êç¢ÁöÑËøáÁ®ãÔºåÊàë‰ª¨ÂèØ‰ª•Â∞ÜËØ•ËøáÁ®ã‰∏éÂÜÖÂ≠òËôöÊãüÂåñÊñáÊ°£‰∏≠‰ªãÁªçÁöÑQEMU‰∏≠ÂÜÖÂ≠òÂú∞ÂùÄËΩ¨Êç¢ËøáÁ®ãÂØπÊØî„ÄÇÁªèËøáÂØπÊØîÂèØ‰ª•ÂèëÁé∞ÔºåGDB‰∏≠ÊòæÁ§∫ÁöÑ <code>edu_mmio_read</code> ÂáΩÊï∞ÁöÑÂáΩÊï∞Ë∞ÉÁî®Ê†à‰∏é‰∏äËäÇÊèèËø∞ÁöÑ‰∏ÄËá¥„ÄÇ</p>
<hr>
<p>ÁÑ∂ÂêéÂ∞ÜÂú®GDB‰∏≠ËÆæÁΩÆÁöÑÊñ≠ÁÇπÂèñÊ∂àÔºåÁªßÁª≠ËøêË°åQEMUËøõÁ®ã„ÄÇËôöÊãüÊú∫ÈöèÂêéËøêË°åÂÖàÂâçÁºñÂÜôÁöÑÁî®Êà∑ÊÄÅÊµãËØïÁ®ãÂ∫èÔºåËôöÊãüÊú∫ÁöÑ <code>dmesg</code> ËæìÂá∫ÊòæÁ§∫eduËÆæÂ§áÁöÑÈÖçÁΩÆÁ©∫Èó¥‰ø°ÊÅØ‰∏é <code>lspci-s 00:04.0-vvv-xxxx</code> ÊâìÂç∞ÁöÑÁªìÊûú‰∏ÄËá¥„ÄÇ‰ª•‰∏ãÊòØ <code>dmesg</code> ‰∏≠ÁöÑÈÉ®ÂàÜ‰ø°ÊÅØÔºö</p>
<p><code>dmesg</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221351572.png" alt="image-20231122134922503" style="zoom:33%;" />
<p><code>dmesg</code> ÁöÑÊúÄÂêéÂá†Êù°ËæìÂá∫‰ø°ÊÅØÂ±ïÁ§∫‰∫ÜeduÂäüËÉΩÁöÑÊâßË°åÁªìÊûú„ÄÇÈ©±Âä®È¶ñÂÖàÊé•Êî∂Âà∞‰∫Ü <code>irq_status</code> ‰∏∫0x12345679ÁöÑËÆæÂ§á‰∏≠Êñ≠Ôºå<code>irq_status</code> ‰∏é <code>pci_ioctl </code> ÂáΩÊï∞‰∏≠ËÆæÁΩÆÁöÑ‰∏ÄËá¥„ÄÇQEMUËæìÂá∫‰∫Ü‰ª•‰∏ãÂØπÂ∫î‰ø°ÊÅØÔºåÂåÖÊã¨ <code>irq_status</code> ÁöÑËÆæÁΩÆ‰ª•Âèä‰∏≠Êñ≠Áä∂ÊÄÅÊ∏ÖÈô§Á≠â„ÄÇ</p>
<p><code>Log in QEMU</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221351686.png" alt="image-20231122135004570" style="zoom:33%;" />
<p>ÁÑ∂ÂêéÈ©±Âä®ÂÜçÊ¨°Êé•Êî∂Âà∞‰∫Ü <code>irq_status</code> ‰∏∫0x1ÁöÑËÆæÂ§á‰∏≠Êñ≠ÔºåÂπ∂Âà§Êñ≠ËØ•‰∏≠Êñ≠‰∏∫Èò∂‰πòËÆ°ÁÆó‰∫ßÁîüÁöÑÔºåÊúÄÂêéËæìÂá∫‰∫ÜÈò∂‰πòËÆ°ÁÆóÁöÑÁªìÊûú <code>0x375f00</code>„ÄÇÂú®QEMU‰∏≠ÁöÑ‰ø°ÊÅØÂ±ïÁ§∫‰∫ÜËÆæÁΩÆËÆæÂ§áÁä∂ÊÄÅ„ÄÅÂàÜÈÖçÈò∂‰πòÂØπË±° <code>fact</code> ‰ª•ÂèäÂèëÂá∫Èò∂‰πòËøêÁÆó‰∏≠Êñ≠ÁöÑËøáÁ®ã„ÄÇ</p>
<p><code>Log in QEMU</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221350905.png" alt="image-20231122135050026" style="zoom:33%;" />
<p>Á¥ßÊé•ÁùÄÊµãËØïÁ®ãÂ∫è‰ºöÂèëËµ∑DMAÂëΩ‰ª§Ôºå‰ºöÂú®eduËÆæÂ§á‰∏≠ËÆæÁΩÆ‰∏éDMAÁõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØ„ÄÇeduËÆæÂ§áÁöÑ <code>edu_timer</code> ÂÆöÊó∂Âô®Ê£ÄÊµãÂà∞ <code>dma.cmd</code> Ë¢´ËÆæÁΩÆ‰∏∫ÂèØËøêË°åÁä∂ÊÄÅÂêéÔºå‰ºöÂÖàÊ†πÊçÆ <code>dma.cmd</code> Á¨¨1‰ΩçÁöÑÂÄºÂà§Êñ≠Âá∫DMAÊï∞ÊçÆÁöÑ‰º†ËæìÊñπÂêëÔºå‰πãÂêé‰ºöÊ£ÄÊü•DMAÊìç‰ΩúÊòØÂê¶Ë∂äÁïåÔºåÂ¶ÇÊûúÊú™Ë∂äÁïåÔºåÂàôÂ∞ÜDMA‰ø°ÊÅØ‰º†ÂÖ•<code>pci_dma_read/pci_dma_write</code> ÂáΩÊï∞ÂèëËµ∑DMAÊìç‰Ωú„ÄÇ</p>
<p><code>pci_dma_read/pci_dma_write</code> ÂáΩÊï∞ÁöÑËøîÂõûÂÄºÁî®‰∫éÂà§Êñ≠DMAÊìç‰ΩúÊòØÂê¶ÊàêÂäüÂÆåÊàê„ÄÇÂΩìDMAÊìç‰ΩúÂÆåÊàêÂêéÔºåeduËÆæÂ§á‰ºöËøîÂõûÁõ∏Â∫îÁöÑDMA‰∏≠Êñ≠„ÄÇÂ¶Ç‰∏ãQEMU‰∏≠ÁöÑËæìÂá∫‰ø°ÊÅØÂ±ïÁ§∫‰∫ÜËøô‰∏ÄÁ≥ªÂàóËøáÁ®ã„ÄÇ</p>
<p><code>Log in QEMU</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221352949.png" alt="image-20231122135155431" style="zoom:33%;" />
<p><code>Log in QEMU</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221355494.png" alt="image-20231122135510458" style="zoom:33%;" />
<h1 id="4-todo-giantvm‰∏≠ÁöÑioÂ§ÑÁêÜ">4 //TODO: GiantVM‰∏≠ÁöÑI/OÂ§ÑÁêÜ
</h1>
</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 zcxGGmu
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<div id="particles-js"></div>

<script src=https://zcxggmu.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://zcxggmu.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>


    </body>
</html>
