<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="[toc]\n1 Ê¶ÇËø∞ ÂÜÖÂ≠òÊòØËÆ°ÁÆóÊú∫Á≥ªÁªü‰∏≠ÁöÑÈáçË¶ÅÈÉ®‰ª∂„ÄÇÂú®‰ªª‰ΩïÂπøÊ≥õ‰ΩøÁî®ÁöÑËÆ°ÁÆóÊú∫‰ΩìÁ≥ªÁªìÊûÑ‰∏≠ÔºåCPUËã•Ê≤°ÊúâÂÜÖÂ≠òÊèê‰æõÊåá‰ª§„ÄÅ‰øùÂ≠òÊâßË°åÁªìÊûúÔºåÂàôÊó†Ê≥ïËøêË°åÔºåCPU‰ªéËÆæÂ§áËØªÂèñÁöÑÊï∞ÊçÆ‰πüÂ∞ÜÊó†Ê≥ï‰øùÂ≠ò„ÄÇÁî±DRAMÔºàDynamic Random Access MemoryÔºåÂä®ÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâËäØÁâáÁªÑÊàêÁöÑÂÜÖÂ≠ò‰πüÊòØÂ≠òÂÇ®Âô®Â±ÇÊ¨°ÁªìÊûÑ‰∏≠ÈáçË¶ÅÁöÑ‰∏ÄÁéØÔºåÂÖ∂ÈÄüÂ∫¶ËôΩÁÑ∂ÊÖ¢‰∫éSRAMÔºàStatic Random Access MemoryÔºåÈùôÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâÔºå‰ΩÜÂõ†‰∏∫‰ª∑Ê†ºÊõ¥‰ΩéÂªâÔºåÂèØ‰ª•Ëé∑ÂæóÊõ¥Â§ßÁöÑÂÆπÈáè„ÄÇ\n">
<title>Kvmbook Mem_3</title>

<link rel='canonical' href='https://zcxggmu.github.io/p/kvmbook-mem_3/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Kvmbook Mem_3">
<meta property='og:description' content="[toc]\n1 Ê¶ÇËø∞ ÂÜÖÂ≠òÊòØËÆ°ÁÆóÊú∫Á≥ªÁªü‰∏≠ÁöÑÈáçË¶ÅÈÉ®‰ª∂„ÄÇÂú®‰ªª‰ΩïÂπøÊ≥õ‰ΩøÁî®ÁöÑËÆ°ÁÆóÊú∫‰ΩìÁ≥ªÁªìÊûÑ‰∏≠ÔºåCPUËã•Ê≤°ÊúâÂÜÖÂ≠òÊèê‰æõÊåá‰ª§„ÄÅ‰øùÂ≠òÊâßË°åÁªìÊûúÔºåÂàôÊó†Ê≥ïËøêË°åÔºåCPU‰ªéËÆæÂ§áËØªÂèñÁöÑÊï∞ÊçÆ‰πüÂ∞ÜÊó†Ê≥ï‰øùÂ≠ò„ÄÇÁî±DRAMÔºàDynamic Random Access MemoryÔºåÂä®ÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâËäØÁâáÁªÑÊàêÁöÑÂÜÖÂ≠ò‰πüÊòØÂ≠òÂÇ®Âô®Â±ÇÊ¨°ÁªìÊûÑ‰∏≠ÈáçË¶ÅÁöÑ‰∏ÄÁéØÔºåÂÖ∂ÈÄüÂ∫¶ËôΩÁÑ∂ÊÖ¢‰∫éSRAMÔºàStatic Random Access MemoryÔºåÈùôÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâÔºå‰ΩÜÂõ†‰∏∫‰ª∑Ê†ºÊõ¥‰ΩéÂªâÔºåÂèØ‰ª•Ëé∑ÂæóÊõ¥Â§ßÁöÑÂÆπÈáè„ÄÇ\n">
<meta property='og:url' content='https://zcxggmu.github.io/p/kvmbook-mem_3/'>
<meta property='og:site_name' content='zcxGGmu'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-10-17T10:06:35&#43;08:00'/><meta property='article:modified_time' content='2024-10-17T10:06:35&#43;08:00'/>
<meta name="twitter:title" content="Kvmbook Mem_3">
<meta name="twitter:description" content="[toc]\n1 Ê¶ÇËø∞ ÂÜÖÂ≠òÊòØËÆ°ÁÆóÊú∫Á≥ªÁªü‰∏≠ÁöÑÈáçË¶ÅÈÉ®‰ª∂„ÄÇÂú®‰ªª‰ΩïÂπøÊ≥õ‰ΩøÁî®ÁöÑËÆ°ÁÆóÊú∫‰ΩìÁ≥ªÁªìÊûÑ‰∏≠ÔºåCPUËã•Ê≤°ÊúâÂÜÖÂ≠òÊèê‰æõÊåá‰ª§„ÄÅ‰øùÂ≠òÊâßË°åÁªìÊûúÔºåÂàôÊó†Ê≥ïËøêË°åÔºåCPU‰ªéËÆæÂ§áËØªÂèñÁöÑÊï∞ÊçÆ‰πüÂ∞ÜÊó†Ê≥ï‰øùÂ≠ò„ÄÇÁî±DRAMÔºàDynamic Random Access MemoryÔºåÂä®ÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâËäØÁâáÁªÑÊàêÁöÑÂÜÖÂ≠ò‰πüÊòØÂ≠òÂÇ®Âô®Â±ÇÊ¨°ÁªìÊûÑ‰∏≠ÈáçË¶ÅÁöÑ‰∏ÄÁéØÔºåÂÖ∂ÈÄüÂ∫¶ËôΩÁÑ∂ÊÖ¢‰∫éSRAMÔºàStatic Random Access MemoryÔºåÈùôÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâÔºå‰ΩÜÂõ†‰∏∫‰ª∑Ê†ºÊõ¥‰ΩéÂªâÔºåÂèØ‰ª•Ëé∑ÂæóÊõ¥Â§ßÁöÑÂÆπÈáè„ÄÇ\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu16968365064894999835.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">zcxGGmu</a></h1>
            <h2 class="site-description">riscv, linux-kernel/kvm, llm-app/infer</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/zcxGGmu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#1-Ê¶ÇËø∞">1 Ê¶ÇËø∞</a></li>
    <li><a href="#2-ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞">2 ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞</a>
      <ul>
        <li><a href="#21-Ë∞àË∞àÈ°µË°®">2.1 Ë∞àË∞àÈ°µË°®</a></li>
        <li><a href="#22-ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ∫ØËΩØ‰ª∂ÂÆûÁé∞-ÂΩ±Â≠êÈ°µË°®">2.2 ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ∫ØËΩØ‰ª∂ÂÆûÁé∞: ÂΩ±Â≠êÈ°µË°®</a></li>
        <li><a href="#23-ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ°¨‰ª∂ÊîØÊåÅ-Êâ©Â±ïÈ°µË°®">2.3 ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ°¨‰ª∂ÊîØÊåÅ: Êâ©Â±ïÈ°µË°®</a></li>
        <li><a href="#24-todo-Êâ©Â±ïÈ°µË°®‰∏éÂΩ±Â≠êÈ°µË°®ÁöÑÁªìÂêà-ÊïèÊç∑È°µË°®">2.4 //TODO Êâ©Â±ïÈ°µË°®‰∏éÂΩ±Â≠êÈ°µË°®ÁöÑÁªìÂêà: ÊïèÊç∑È°µË°®</a></li>
        <li><a href="#25-todo-ÂÜÖÂ≠òÁöÑÂçäËôöÊãüÂåñ-Áõ¥Êé•È°µË°®Êò†Â∞Ñ‰∏éÂÜÖÂ≠òÊ∞îÁêÉ">2.5 //TODO ÂÜÖÂ≠òÁöÑÂçäËôöÊãüÂåñ: Áõ¥Êé•È°µË°®Êò†Â∞Ñ‰∏éÂÜÖÂ≠òÊ∞îÁêÉ</a></li>
      </ul>
    </li>
    <li><a href="#3-qemukvmÂàÜÊûê">3 QEMU/KVMÂàÜÊûê</a>
      <ul>
        <li><a href="#31-qemuÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ">3.1 QEMUÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ</a>
          <ul>
            <li><a href="#ËôöÊãüÁâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖç">&ldquo;ËôöÊãü&quot;Áâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖç</a></li>
            <li><a href="#ÊîØÊåÅËôöÊãüÁâ©ÁêÜÂÜÖÂ≠òËÆøÈóÆÂõûË∞ÉÂáΩÊï∞">ÊîØÊåÅ&quot;ËôöÊãü&quot;Áâ©ÁêÜÂÜÖÂ≠òËÆøÈóÆÂõûË∞ÉÂáΩÊï∞</a>
              <ul>
                <li><a href="#ÂÆû‰Ωìmr">ÂÆû‰ΩìMR</a></li>
                <li><a href="#ÂÆπÂô®mrÂà´Âêçmr">ÂÆπÂô®MR/Âà´ÂêçMR</a></li>
              </ul>
            </li>
            <li><a href="#È°∂Â±ÇÊï∞ÊçÆÁªìÊûÑaddressspace">È°∂Â±ÇÊï∞ÊçÆÁªìÊûÑAddressSpace</a></li>
            <li><a href="#‰ªéÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑ">‰ªéÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑ</a></li>
            <li><a href="#ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÁöÑÂàÜÊ¥æ">ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÁöÑÂàÜÊ¥æ</a></li>
            <li><a href="#ÂÆûÈ™å-ÊâìÂç∞memoryregionÊ†ë">ÂÆûÈ™å: ÊâìÂç∞MemoryRegionÊ†ë</a></li>
          </ul>
        </li>
        <li><a href="#33-kvmÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ">3.3 KVMÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ</a>
          <ul>
            <li><a href="#Êé•Êî∂qemuÁöÑÂÜÖÂ≠òÊ≥®ÂÜå">Êé•Êî∂QEMUÁöÑÂÜÖÂ≠òÊ≥®ÂÜå</a></li>
            <li><a href="#ÂàõÂª∫vcpuÁöÑËôöÊãümmu">ÂàõÂª∫vCPUÁöÑËôöÊãüMMU</a>
              <ul>
                <li><a href="#mmuÂàõÂª∫ÊµÅÁ®ã">MMUÂàõÂª∫ÊµÅÁ®ã</a></li>
                <li><a href="#eptÂü∫Âú∞ÂùÄËÆæÁΩÆÊµÅÁ®ã">EPTÂü∫Âú∞ÂùÄËÆæÁΩÆÊµÅÁ®ã</a></li>
              </ul>
            </li>
            <li><a href="#eptÁöÑÂª∫Á´ã">EPTÁöÑÂª∫Á´ã</a></li>
            <li><a href="#ÂÆûÈ™å-Â∞ÜgvaÁøªËØë‰∏∫hpa">ÂÆûÈ™å: Â∞ÜGVAÁøªËØë‰∏∫HPA</a>
              <ul>
                <li><a href="#ÂÆûÈ™åÊ¶ÇËø∞">ÂÆûÈ™åÊ¶ÇËø∞</a></li>
                <li><a href="#ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢-gvaÂà∞gpa">ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢: GVAÂà∞GPA</a></li>
                <li><a href="#kvm‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢-gpaÂà∞hpa">KVM‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢: GPAÂà∞HPA</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4-todo-giantvmÂÜÖÂ≠òËôöÊãüÂåñ">4 //TODO: GiantVMÂÜÖÂ≠òËôöÊãüÂåñ</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/kvmbook-mem_3/">Kvmbook Mem_3</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-10-17</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 76 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>[toc]</p>
<h1 id="1-Ê¶ÇËø∞">1 Ê¶ÇËø∞
</h1><p>ÂÜÖÂ≠òÊòØËÆ°ÁÆóÊú∫Á≥ªÁªü‰∏≠ÁöÑÈáçË¶ÅÈÉ®‰ª∂„ÄÇÂú®‰ªª‰ΩïÂπøÊ≥õ‰ΩøÁî®ÁöÑËÆ°ÁÆóÊú∫‰ΩìÁ≥ªÁªìÊûÑ‰∏≠ÔºåCPUËã•Ê≤°ÊúâÂÜÖÂ≠òÊèê‰æõÊåá‰ª§„ÄÅ‰øùÂ≠òÊâßË°åÁªìÊûúÔºåÂàôÊó†Ê≥ïËøêË°åÔºåCPU‰ªéËÆæÂ§áËØªÂèñÁöÑÊï∞ÊçÆ‰πüÂ∞ÜÊó†Ê≥ï‰øùÂ≠ò„ÄÇÁî±DRAMÔºàDynamic Random Access MemoryÔºåÂä®ÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâËäØÁâáÁªÑÊàêÁöÑÂÜÖÂ≠ò‰πüÊòØÂ≠òÂÇ®Âô®Â±ÇÊ¨°ÁªìÊûÑ‰∏≠ÈáçË¶ÅÁöÑ‰∏ÄÁéØÔºåÂÖ∂ÈÄüÂ∫¶ËôΩÁÑ∂ÊÖ¢‰∫éSRAMÔºàStatic Random Access MemoryÔºåÈùôÊÄÅÈöèÊú∫ËÆøÈóÆÂ≠òÂÇ®Âô®ÔºâÔºå‰ΩÜÂõ†‰∏∫‰ª∑Ê†ºÊõ¥‰ΩéÂªâÔºåÂèØ‰ª•Ëé∑ÂæóÊõ¥Â§ßÁöÑÂÆπÈáè„ÄÇ</p>
<p>Âú®ÂΩìÂâçÁöÑÁîü‰∫ßÁéØÂ¢É‰∏≠ÔºåÂÜÖÂ≠òÂÆπÈáèÂ∑≤ÁªèËææÂà∞‰∫ÜTBÁ∫ßÂà´„ÄÇÈöèÁùÄÂ§ßÊï∞ÊçÆÊó∂‰ª£ÁöÑÂà∞Êù•ÔºåÂ§ßÈáèÊï∞ÊçÆÈúÄË¶Å‰øùÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠ËøõË°åÂ§ÑÁêÜÔºåÊâçËÉΩÂ§üËé∑ÂæóÊõ¥‰ΩéÁöÑÂª∂ËøüÔºå‰ªéËÄåÁº©Áü≠Áî®Êà∑ÁöÑÁ≠âÂæÖÊó∂Èó¥ÔºåÊèêÂçáÁî®Êà∑‰ΩìÈ™å„ÄÇ‰∫ëÊó∂‰ª£ÁöÑÂà∞Êù•‰∏∫ËÆ°ÁÆóÊú∫ÂÜÖÂ≠òÁÆ°ÁêÜÊèêÂá∫‰∫ÜÊñ∞ÁöÑÊåëÊàòÔºö**<font color='red'>ÈúÄË¶Å‰∏∫ÂÆ¢Êà∑Êú∫Êèê‰æõ‰ªé0ÂºÄÂßãÁöÑ„ÄÅËøûÁª≠ÁöÑ„ÄÅÁõ∏‰∫íÈöîÁ¶ªÁöÑËôöÊãü‚ÄúÁâ©ÁêÜÂÜÖÂ≠ò‚ÄùÔºåÂπ∂‰∏î‰ΩøÂÜÖÂ≠òËÆøÈóÆÂª∂Ëøü‰ΩéÔºåÊé•ËøëÂÆø‰∏ªÊú∫ÁéØÂ¢É‰∏ãÁöÑÂÜÖÂ≠òËÆøÈóÆÂª∂Ëøü„ÄÇ</font>**ËøôÂ∞±ÊòØÊú¨Êñá‰∏ªË¶Å‰ªãÁªçÁöÑÂÜÖÂÆπÔºåÂç≥Â¶Ç‰ΩïÈ´òÊïàÂú∞ÂÆûÁé∞ÂÜÖÂ≠òËôöÊãüÂåñ„ÄÇ</p>
<p>Âπø‰πâÁöÑÂÜÖÂ≠òËôöÊãüÂåñ‰∏ç‰ªÖÂåÖÊã¨Á°¨‰ª∂Â±ÇÈù¢ÁöÑÂÜÖÂ≠òËôöÊãüÂåñÔºåËøòÂåÖÂê´Êõ¥Â§öÊÑè‰πâ‰∏äÁöÑÂÜÖÂ≠òËôöÊãüÂåñ„ÄÇÂÜÖÂ≠òËôöÊãüÂåñÂç≥ÁªôËÆøÂ≠òÊåá‰ª§Êèê‰æõ‰∏Ä‰∏™ÂÜÖÂ≠òÁ©∫Èó¥ÔºåÊàñÁß∞‰∏∫Âú∞ÂùÄÁ©∫Èó¥„ÄÇÂú∞ÂùÄÁ©∫Èó¥ÂøÖÈ°ªÊòØ‰ªé0ÂºÄÂßã‰∏îËøûÁª≠ÁöÑÔºåÂèØ‰ª•ÂΩ¢Ë±°Âú∞Áúã‰Ωú‰∏Ä‰∏™Â§ßÊï∞ÁªÑÔºåÈÄöËøá‰ªé0ÂºÄÂßãÁöÑÁºñÂè∑ËÆøÈóÆÂÖ∂‰∏≠ÁöÑÂÖÉÁ¥†ÔºåÊØè‰∏™ÂÖÉÁ¥†ÂÇ®Â≠ò‰∫ÜÂõ∫ÂÆöÂ§ßÂ∞èÁöÑÊï∞ÊçÆ„ÄÇÁî±‰ΩéÂ±ÇÂêëÈ´òÂ±Ç„ÄÅÁî±ÁÆÄÂçïÂà∞Â§çÊùÇÔºåÂêÑÁ±ªÂú∞ÂùÄÁ©∫Èó¥ÂèØ‰ª•Ê¶ÇÊã¨‰∏∫ÔºöÂçïÊú∫‰∏äÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥„ÄÅÂçï/Â§öÊú∫‰∏äÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥„ÄÅÂçïÊú∫‰∏äÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥„ÄÅÂ§öÊú∫‰∏äÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥Ôºå‰∏ãÈù¢Â∞Ü‰æùÊ¨°‰ªãÁªç„ÄÇ</p>
<blockquote>
<p><em><strong>ÂçïÊú∫‰∏äÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥</strong></em></p>
</blockquote>
<p>ÂØπ‰∫é‰∏ÄÊù°ËÆøÂ≠òÊåá‰ª§ÔºåËã•Á≥ªÁªü‰∏≠Ê≤°ÊúâÂºÄÂêØÂàÜÈ°µÊ®°ÂºèÔºåÂú®‰∏çËÄÉËôëÂºÄÂêØÂàÜÊÆµÊ®°ÂºèÁöÑÊÉÖÂÜµ‰∏ãÔºåËøôÊù°Êåá‰ª§ÂèØ‰ª•ËÆøÈóÆÂÖ®ÈÉ®ÁöÑÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÊåá‰ª§ËÆøÈóÆÁöÑPAÔºàPhysical AddressÔºåÁâ©ÁêÜÂú∞ÂùÄÔºâÊòØ‰ªé0ÂºÄÂßã‰∏îËøûÁª≠ÁöÑ„ÄÇÂú®ËÆ°ÁÆóÊú∫ÂêØÂä®‰πãÂàùÔºåBIOSÊé¢ÊµãÂà∞‰∏ªÊùøÂÜÖÂ≠òÊèíÊßΩ‰∏äÁöÑÊâÄÊúâÂÜÖÂ≠òÊù°ÔºåÂπ∂ÁªôÊØè‰∏™ÂÜÖÂ≠òÊù°Ëµã‰∫à‰∏Ä‰∏™Áâ©ÁêÜÂú∞ÂùÄËåÉÂõ¥ÔºåÊúÄÂêéÁªôCPUÊèê‰æõ‰∏Ä‰∏™‰ªé0ÂºÄÂßãÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥„ÄÇ‰ªéËÄåÊØè‰∏™ÂÜÖÂ≠òÊù°ÈÉΩË¢´Êò†Â∞ÑÂà∞‰∏Ä‰∏™Áâ©ÁêÜÂú∞ÂùÄËåÉÂõ¥ÂÜÖÔºåËΩØ‰ª∂Êó†È°ªÁü•ÈÅìËá™Â∑±ËÆøÈóÆÁöÑÊòØÂì™‰∏™ÂÜÖÂ≠òÊù°‰∏äÁöÑÊï∞ÊçÆÔºå‰ΩøÁî®Áâ©ÁêÜÂú∞ÂùÄÂç≥ÂèØËÆøÈóÆÂÜÖÂ≠òÊù°‰∏äÂ≠òÂÇ®ÁöÑÊï∞ÊçÆ„ÄÇÁâ©ÁêÜÂú∞ÂùÄÈöêËóè‰∫ÜÂÜÖÂ≠òÊù°ÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÁªôÁ≥ªÁªüÊèê‰æõ‰∫Ü‰ªé0ÂºÄÂßã‰∏îËøûÁª≠ÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÊäΩË±°ÔºåÊòØ‰∏ÄÁßçËôöÊãüÂåñÔºåÂ¶Ç‰∏ãÂõæ(a)ÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171653870.png"
	
	
	
	loading="lazy"
	
		alt="image-20231117165319826"
	
	
></p>
<p>Èô§‰∫ÜÂÜÖÂ≠òÊù°Ë¢´Êò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÂÜÖÔºå‰πüÊúâ‰∏Ä‰∫õÂ§ñÂõ¥ËÆæÂ§á (Peripheral Devices) ÁöÑÂÜÖÂ≠òÂíåÂØÑÂ≠òÂô®Ë¢´Êò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÂÜÖ„ÄÇÂΩìCPUÂèëÂá∫ÁöÑËÆøÂ≠òÊåá‰ª§ÁöÑÁâ©ÁêÜÂú∞ÂùÄËêΩÂú®Â§ñÂõ¥ËÆæÂ§áÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄËåÉÂõ¥ÂÜÖÔºåÂàô‰ºöÂ∞ÜÊï∞ÊçÆËøîÂõûÁªôCPUÔºåËøôÁß∞‰ΩúÂÜÖÂ≠òÊò†Â∞ÑI/O <code>MMIO</code>„ÄÇÂ¶ÇÊûúÂè™Êúâ‰∏ÄÂ±ÇÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÂàôÁ≥ªÁªü‰∏≠Âè™ËÉΩËøêË°å‰∏Ä‰∏™ËøõÁ®ãÔºåÊó†Ê≥ïÂØπCPUÂàÜÊó∂Â§çÁî®„ÄÇ</p>
<blockquote>
<p><em><strong>Âçï/Â§öÊú∫‰∏äÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥</strong></em></p>
</blockquote>
<p>‰∏∫‰∫ÜÂÆûÁé∞CPUÁöÑÂàÜÊó∂Â§çÁî®ÔºåÊìç‰ΩúÁ≥ªÁªüÊèê‰æõ‰∫ÜËøõÁ®ãÁöÑÊ¶ÇÂøµ„ÄÇ‰∏Ä‰∏™ËøõÁ®ãÂç≥ÊòØ‰∏Ä‰∏≤Áõ∏‰∫íÂÖ≥ËÅî„ÄÅÂÆåÊàêÂêå‰∏Ä‰∏™‰ªªÂä°ÁöÑÊåá‰ª§Â∫èÂàó„ÄÇ‰∏∫‰∫Ü‰Ωø‰∏çÂêåËøõÁ®ãÁöÑËÆøÂ≠òÊåá‰ª§Âú®ËÆøÈóÆÁâ©ÁêÜÂÜÖÂ≠òÊó∂‰∏ç‰ºöÁõ∏‰∫íÂÜ≤Á™ÅÔºåVAÔºàVirtual AddressÔºåËôöÊãüÂú∞ÂùÄÔºâÁöÑÊ¶ÇÂøµË¢´ÂºïÂÖ•„ÄÇÊØè‰∏™ËøõÁ®ãÈÉΩÊúâ‰∏Ä‰∏™Áã¨Á´ãÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥Ôºå‰ªé0ÂºÄÂßã‰∏îËøûÁª≠ÔºåVAÂà∞PAÁöÑÊò†Â∞ÑÁî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆö„ÄÇËøôÊ†∑ÔºåÂÅáËÆæÊìç‰ΩúÁ≥ªÁªü‰∏∫ËøõÁ®ãAÂàÜÈÖç‰∫ÜÁ¨¨0ÂùóÂíåÁ¨¨2ÂùóÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºå‰∏∫ËøõÁ®ãBÂàÜÈÖç‰∫ÜÁ¨¨1ÂùóÂíåÁ¨¨3ÂùóÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåËÄå‰∏§‰∏™ËøõÁ®ãÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥Â§ßÂ∞èÂùá‰∏∫4„ÄÇ</p>
<p>Êú¨Êñá‰ΩøÁî®ÊäΩË±°ÁöÑ ‚ÄúÂùó‚Äù ‰Ωú‰∏∫ËôöÊãüÂÜÖÂ≠òÂíåÁâ©ÁêÜÂÜÖÂ≠ò‰πãÈó¥Êò†Â∞ÑÁöÑÂü∫Êú¨Âçï‰ΩçÔºåÂç≥ÊäΩË±°Â±ÇÈó¥Êò†Â∞ÑÁöÑÂü∫Êú¨Âçï‰Ωç„ÄÇ‰∏§‰∏™ËøõÁ®ãÈÉΩÂèØ‰ª•‰ΩøÁî®ËôöÊãüÂú∞ÂùÄ0ËÆøÈóÆÂÆÉ‰ª¨Êã•ÊúâÁöÑÁ¨¨0ÂùóËôöÊãüÂÜÖÂ≠òÔºåËÄå‰∏ç‰ºöÂºïËµ∑ËÆøÈóÆÂÜ≤Á™ÅÔºåÂ¶Ç‰∏äÂõæ(b)ÊâÄÁ§∫„ÄÇÁî±‰∫éVAÂà∞PAÁöÑÊò†Â∞ÑÁî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆöÔºåÂõ†Ê≠§Êìç‰ΩúÁ≥ªÁªüÂèØ‰ª•Â∑ßÂ¶ôÂú∞ËÆæÁΩÆËØ•Êò†Â∞ÑÔºå‰ΩøÂæóÁ≥ªÁªü‰∏≠ÁöÑÂ§ö‰∏™ËøõÁ®ã‰ª•‰∏ÄÁßç‰ΩéÂÜÖÂ≠òÂç†Áî®ÁöÑÊñπÂºèËøêË°å„ÄÇÂÅáËÆæËøõÁ®ãA‰ΩøÁî®ÁöÑÁ¨¨2ÂùóÁâ©ÁêÜÂÜÖÂ≠òÂíåËøõÁ®ãB‰ΩøÁî®ÁöÑÁ¨¨3ÂùóÁâ©ÁêÜÂÜÖÂ≠ò‰øùÂ≠òÁöÑÊï∞ÊçÆÁõ∏ÂêåÔºåÈÇ£‰πàÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•ÈÄâÊã©Â∞ÜËøõÁ®ãA„ÄÅBÁöÑÁ¨¨1ÂùóËôöÊãüÂÜÖÂ≠òÂêåÊó∂Êò†Â∞ÑÂà∞Á≥ªÁªü‰∏≠ÁöÑÁ¨¨2ÂùóÁâ©ÁêÜÂÜÖÂ≠òÔºåÂπ∂ÈáäÊîæÁ¨¨3ÂùóÁâ©ÁêÜÂÜÖÂ≠òÔºåÂáèÂ∞ëÁâ©ÁêÜÂÜÖÂ≠òÂç†Áî®„ÄÇÂáèÂ∞ëÁâ©ÁêÜÂÜÖÂ≠òÂç†Áî®ÁöÑÊñπÊ≥ïËøòÊúâÂ∞ÜËôöÊãüÂÜÖÂ≠òÂùóÂØπÂ∫îÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊç¢Âá∫Âà∞Á£ÅÁõò‰∏äÔºåËÄå‰∏çÊîπÂèòËôöÊãüÂÜÖÂ≠òÁöÑÊäΩË±°Â±ÇÔºåËøôÁßçÊñπÂºèÁß∞‰∏∫È°µÊç¢Âá∫„ÄÇ</p>
<p>ËøôÂ∞±ÊòØÊäΩË±°Â±ÇÊèê‰æõÁöÑ‰∏Ä‰∏™Â•ΩÂ§ÑÔºöÁªô‰∏äÂ±ÇÂ∫îÁî®Êèê‰æõ‰∏Ä‰∏™‰∏çÂèòÁöÑ ‚ÄúËôöÊãü‚Äù ÂÜÖÂ≠òÔºåËÄåÁÅµÊ¥ªÂú∞ÊîπÂèòÂÖ∂ ‚ÄúÂêéÂè∞‚Äù ÂÆûÁé∞„ÄÇËôöÊãüÂÜÖÂ≠òÁîöËá≥ÂèØ‰ª•Âª∫Á´ãÂú®Â§ö‰∏™Áâ©ÁêÜÂÜÖÂ≠òÁ°¨‰ª∂‰∏äÔºå‰ªéËÄåÂÆûÁé∞ÂÜÖÂ≠òËµÑÊ∫êÁöÑËÅöÂêà„ÄÇÂ¶Ç‰∏äÂõæ(c)ÊâÄÁ§∫ÔºåËøôÁßçÊû∂ÊûÑÁß∞‰∏∫DSMÔºàDistributed Shared MemoryÔºåÂàÜÂ∏ÉÂºèÂÖ±‰∫´ÂÜÖÂ≠òÔºâÔºåÂÆÉÂèØ‰ª•‰ΩøÂçïÊú∫ËøõÁ®ãÊó†‰øÆÊîπÂú∞ËøêË°åÂú®M0ÂíåM1‰∏äÔºàM‰ª£Ë°®MachineÔºâÔºåÂêéÊñáÂ∞Ü‰ªãÁªçÂÖ∂ÂéüÁêÜÔºå‰ª•ÂèäÂ¶Ç‰ΩïË¢´Áî®‰∫éÂÆûÁé∞ÂàÜÂ∏ÉÂºèËôöÊãüÊú∫ÁõëÊéßÂô®GiantVM„ÄÇÈô§‰∫ÜÊ®™ÂêëÊâ©Â±ïÂÜÖÂ≠òËôöÊãüÂåñÁöÑÊ¶ÇÂøµÔºåÂç≥Â¢ûÂä†Áâ©ÁêÜÂÜÖÂ≠òÁöÑÈáèÔºåËøòÂèØ‰ª•Â¢ûÂä†ÊäΩË±°Â±ÇÁöÑÂ±ÇÁ∫ßÊï∞„ÄÇ</p>
<blockquote>
<p><em><strong>ÂçïÊú∫‰∏äÁöÑ ‚ÄúËôöÊãü ‚ÄùÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥</strong></em></p>
</blockquote>
<p>Â¶ÇÊûú‰øùÊåÅÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊ¶ÇÂøµ‰∏çÂèòÔºåÁªßÁª≠Êõ¥ÊîπÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂêéÂè∞ÂÆûÁé∞Â∞Ü‰ºö‰∫ßÁîü‰ªÄ‰πàÊ¶ÇÂøµÔºü ‰∏Ä‰∏™ÂæàÂÆπÊòìÊÉ≥Âà∞ÁöÑÊÉ≥Ê≥ïÊòØÁî®ËôöÊãüÂÜÖÂ≠ò‰ª£ÊõøÁâ©ÁêÜÂÜÖÂ≠òÊù°‰Ωú‰∏∫Áâ©ÁêÜÂú∞ÂùÄÂÆûÁé∞ÁöÑÂêéÂè∞„ÄÇËÄåÁâ©ÁêÜÂÜÖÂ≠òÂèØ‰ª•Êèê‰æõÁªô‰∏ÄÊï¥Âè∞Êú∫Âô®‰ΩøÁî®Ôºå‰∫éÊòØ‰∫ßÁîü‰∫ÜÂÜÖÂ≠òËôöÊãüÂåñÁöÑÊ¶ÇÂøµ„ÄÇ</p>
<p>ÂÅáËÆæËøõÁ®ã A ËøêË°åÂú®Áâ©ÁêÜÁ°¨‰ª∂‰∏äÔºåÂÆÉÊèê‰æõ 4 ÂùóËôöÊãüÁöÑÁâ©ÁêÜÂÜÖÂ≠òÁªôÂÆ¢Êà∑Êú∫A‰ΩøÁî®ÔºåÂàÜÂà´ÂØπÂ∫îÂÖ∂ 0„ÄÅ1„ÄÅ2„ÄÅ3 ÂùóËôöÊãüÂÜÖÂ≠ò„ÄÇÂÆ¢Êà∑Êú∫AÂú®Ê≠§ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÂü∫Á°Ä‰∏äÔºåÁªßÁª≠Êèê‰æõËôöÊãüÂÜÖÂ≠òÁöÑÊäΩË±°ÔºåÂ∞ÜÁ¨¨0„ÄÅ1ÂùóÁâ©ÁêÜÂÜÖÂ≠òÂàÜÂà´ÁªôÂÆ¢Êà∑Êú∫‰∏≠ËøêË°åÁöÑËøõÁ®ãA1„ÄÅB1‰ΩøÁî®ÔºåÂàÜÂà´Êò†Â∞ÑÂà∞ËøõÁ®ãA1ÁöÑÁ¨¨0ÂùóËôöÊãüÂÜÖÂ≠ò„ÄÅËøõÁ®ãB1ÁöÑÁ¨¨1ÂùóËôöÊãüÂÜÖÂ≠ò„ÄÇÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÂÆ¢Êà∑Êú∫ËøõÁ®ãAÂíåÊôÆÈÄöËøõÁ®ãBÂπ∂Êó†Â∑ÆÂà´„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Âõæ3-2
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÈáå‰∫ßÁîü‰∫ÜGVA„ÄÅGPA„ÄÅHVAÂíåHPAÂõõÂ±ÇÂú∞ÂùÄÁ©∫Èó¥ÔºåÂÖ∂‰∏≠**HVAÂà∞HPAÁöÑÊò†Â∞Ñ‰ªçÁÑ∂Áî±ÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆöÔºåGPAÂà∞HVAÁöÑÊò†Â∞ÑÁî±HypervisorÂÜ≥ÂÆöÔºåËÄåGVAÂà∞GPAÁöÑÊò†Â∞ÑÁî±ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆö„ÄÇ**ËøôÊ†∑ÁöÑ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂú∞ÂùÄÊäΩË±°Êúâ‰ªÄ‰πàÂèØÂà©Áî®‰πãÂ§ÑÂë¢Ôºü</p>
<p>È¶ñÂÖàÔºåËøôÊîπÂèò‰∫ÜÂØπ‰∫éËÆøÂ≠òÊåá‰ª§ÁöÑÂõ∫ÊúâËÆ§Áü•ÔºåÂç≥ËÆøÂ≠òÊåá‰ª§‰∏ç‰∏ÄÂÆöËÆøÈóÆÁúüÂÆûÁöÑÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÂè™Ë¶Å‰øùËØÅËôöÊãüÁ°¨‰ª∂ÁöÑÊäΩË±°ÂíåÂéüÊúâÁöÑÁâ©ÁêÜÁ°¨‰ª∂Áõ∏ÂêåÔºåÁ≥ªÁªüËΩØ‰ª∂Â∞±ÂèØ‰ª•ÊåâÈúÄÁÅµÊ¥ªÂú∞Êõ¥ÊîπÊäΩË±°Â±ÇÁöÑÂêéÂè∞ÂÆûÁé∞„ÄÇÂ¶ÇÊûúÁúüÂÆûÁöÑÁâ©ÁêÜÁ°¨‰ª∂ÈúÄË¶ÅÊõ¥Êç¢Áª¥‰øÆÔºåÈÇ£‰πàËôöÊãüÊú∫ÁÉ≠ËøÅÁßªÂèØ‰ª•Â∞ÜÂÆ¢Êà∑Êú∫ËøÅÁßªÂà∞Âè¶‰∏Ä‰∏™Êú∫Âô®‰∏äÔºåËÄå‰∏ç‰ºöÁî±‰∫éÊõ¥Êç¢Á°¨‰ª∂ÂÅúÊ≠¢ËôöÊãüÊú∫ÁöÑËøêË°å„ÄÇËøôÊòØÁî±‰∫é ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÊäΩË±°Ê≤°ÊúâÊîπÂèòÔºåÂÆ¢Êà∑Êú∫Â∞Ü‰∏ç‰ºöÊÑüÁü•Âà∞ÂÆÉÊâÄ‰æùËµñËøêË°åÁöÑÁ°¨‰ª∂ÂèëÁîü‰∫ÜÂèòÂåñ„ÄÇÂÖ∂Ê¨°ÔºåÊ†πÊçÆÂâçÊñáÂØπÂçïÊú∫ËôöÊãüÂÜÖÂ≠òÁöÑÊèèËø∞ÔºåÂ§ö‰∏™ËøõÁ®ãÁöÑËôöÊãüÂÜÖÂ≠òÊÄªÈáèÂèØ‰ª•Ë∂ÖËøáÁ≥ªÁªü‰∏äË£ÖÂ§áÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊÄªÈáè„ÄÇÁ±ª‰ººÁöÑÔºåÂú®ÂÜÖÂ≠òËôöÊãüÂåñ‰∏≠Ôºå‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÊÄªÈáèÂèØ‰ª•Ë∂ÖËøáÁúüÂÆûÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊÄªÈáèÔºåÂç≥<strong>ÂÜÖÂ≠òË∂ÖÂîÆ„ÄÇ</strong></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171658971.png" alt="image-20231117165520748" style="zoom:50%;" />
<blockquote>
<p><em><strong>Â§öÊú∫‰∏äÁöÑ ‚ÄúËôöÊãü ‚ÄùÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥</strong></em></p>
</blockquote>
<p>Â§ßÊï∞ÊçÆÁéØÂ¢É‰∏ãÁöÑÂ∫îÁî®ÈÉΩ‰ºöÂç†Áî®Â§ßÈáèÁöÑÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÂçï‰∏™Êú∫Âô®Ê∏êÊ∏êÊó†Ê≥ïÊª°Ë∂≥Â§ßÊï∞ÊçÆÂ§ÑÁêÜ‰ªªÂä°ËøêË°åËøáÁ®ã‰∏≠ÊâÄÈúÄË¶ÅÁöÑÂÜÖÂ≠òÁ©∫Èó¥„ÄÇ‰∫éÊòØÔºå‰∫∫‰ª¨Â∞ÜÂÖ≥Ê≥®ÁÇπ‰ªéÈ´òÈÖçÁΩÆÁöÑÂçïÊú∫Á∫µÂêëÊâ©Â±ï (Scale-up) ËΩ¨Âêë‰∫ÜÊï∞ÈáèËæÉÂ§ßÁöÑÂçïÊú∫Ê®™ÂêëÊâ©Â±ï (Scale-out) „ÄÇ‰∏∫‰∫Ü‰ΩøÂ§ßÊï∞ÊçÆÂ∫îÁî®ËøêË°åÂú®Â§ö‰∏™Êú∫Âô®‰∏äÔºåËÄåÊé©ÁõñÊéâÁΩëÁªúÈÄö‰ø°„ÄÅÂÆπÈîôÁ≠âÂàÜÂ∏ÉÂºèÁéØÂ¢É‰∏ãÈúÄË¶ÅÈ¢ùÂ§ñÊ≥®ÊÑèÁöÑÂ§çÊùÇÂ∫¶ÔºåÂ§ßÊï∞ÊçÆÊ°ÜÊû∂Ë¢´ÂºÄÂèëÂá∫Êù•ÔºåÂ¶ÇSpark„ÄÅHadoopÁ≠â„ÄÇ‰ΩÜËøô‰∫õÊ°ÜÊû∂‰ªçÁÑ∂ÊúâÈô°Â≥≠ÁöÑÂ≠¶‰π†Êõ≤Á∫øÔºåÁ®ãÂ∫èÂëòÈúÄË¶ÅÂ≠¶‰π†ÂÖ∂Â§çÊùÇÁöÑÁºñÁ®ãÊ®°ÂûãÊâçËÉΩÂú®ÂàÜÂ∏ÉÂºèÊ°ÜÊû∂‰∏äÁºñÂÜô‰ª£Á†Å„ÄÇ</p>
<p>Â¶ÇÊûúÂ≠òÂú®‰∏Ä‰∏™SSIÔºàSingle System ImageÔºåÂçï‰∏ÄÁ≥ªÁªüÈïúÂÉèÔºâÔºåÂç≥Âú®Â§ö‰∏™ËäÇÁÇπÁªÑÊàêÁöÑÂàÜÂ∏ÉÂºèÈõÜÁæ§‰∏äÁªôÁ®ãÂ∫èÂëòÊèê‰æõ‰∏ÄÁßçÂçïÊú∫ÁöÑÁºñÁ®ãÊ®°ÂûãÔºåÂàô‰ºöÊûÅÂ§ßÂú∞ÊèêÈ´òÂàÜÂ∏ÉÂºèÂ∫îÁî®ÁöÑÂºÄÂèëÊïàÁéáÔºåÂΩªÂ∫ïÊé©ÁõñÂàÜÂ∏ÉÂºèÁ≥ªÁªüÁöÑÂ§çÊùÇÊÄßÔºåÊó†È°ªÂ≠¶‰π†ÂàÜÂ∏ÉÂºèÊ°ÜÊû∂ÁöÑÁºñÁ®ãÊ®°Âûã„ÄÇËã•ÊääÂâçÊñáDSMÁöÑÊÄùÊÉ≥Áî®‰∫éÂÆûÁé∞ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÔºåÂ∞ÜËé∑Âæó‰∏Ä‰∏™ÂÆπÈáèÂ∑®Â§ßÁöÑ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠ò„ÄÇDSMÂú®Â§ö‰∏™Áâ©ÁêÜËäÇÁÇπ‰πã‰∏äÂª∫Á´ã‰∫Ü‰∏Ä‰∏™ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÊäΩË±°Â±ÇÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåM0„ÄÅM1ÂàÜÂà´ÈÖçÂ§á4ÂùóÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311171657436.png" alt="image-20231117165740117" style="zoom:50%;" />
<p>‰ªøÁÖßÂçïÊú∫‰∏äÁöÑ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÔºåÊ≠§Â§Ñ‰ªçÁî±ÂÆø‰∏ªÊú∫ÁöÑVMËøõÁ®ãA„ÄÅB‰∏∫Ë∑®ÁïåÁÇπÂÆ¢Êà∑Êú∫VMÊèê‰æõ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠ò„ÄÇ‰∫éÊòØÔºåVMÊã•Êúâ‰∫Ü8ÂùóÁâ©ÁêÜÂÜÖÂ≠òÔºåÂÖ∂ÂêéÂè∞ÂÆûÁé∞ÊòØ‰∏§‰∏™Áâ©ÁêÜÊú∫ÁöÑËôöÊãüÂÜÖÂ≠ò„ÄÇËøôË¢´Áß∞‰∏∫‚ÄúÂ§öËôö‰∏Ä‚ÄùÔºåÂç≥Â§ö‰∏™ËäÇÁÇπÂÖ±ÂêåËôöÊãüÂåñÂá∫‰∏Ä‰∏™ËôöÊãüÊú∫„ÄÇDSM‰øùÊåÅ‰∫Ü ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÊäΩË±°Â±Ç‰∏çÂèòÔºå‰ªª‰Ωï‰∏Ä‰∏™Êìç‰ΩúÁ≥ªÁªüÂùáÂèØËøêË°åÂú®ËøôÊ†∑ÁöÑÊäΩË±°‰πã‰∏äÔºåÂíåËøêË°åÂú®ÁúüÂÆûÁâ©ÁêÜÁ°¨‰ª∂‰∏äÊ≤°ÊúâÂ∑ÆÂà´„ÄÇDSMÊäΩË±°Â±ÇÁöÑÂêéÂè∞ÂÆûÁé∞Â∞ÜÂú®ÂêéÊñá‰∏≠‰ªãÁªç„ÄÇ</p>
<h1 id="2-ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞">2 ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞
</h1><p>‰∏ãÈù¢È¶ñÂÖà‰ªãÁªçËôöÊãüÂú∞ÂùÄÁöÑÂÆûÁé∞ÔºåÂÜç‰ªãÁªçÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞„ÄÇÊúÄÂêéÂÜçËÅäËÅäÂª∫Á´ãÂ§öÊú∫‰∏äÂÜÖÂ≠òÊäΩË±°ÁöÑÊñπÊ≥ï„ÄÇ</p>
<h2 id="21-Ë∞àË∞àÈ°µË°®">2.1 Ë∞àË∞àÈ°µË°®
</h2><p>Á≥ªÁªü‰ΩøËÉΩMMUÂêéÔºåÊâÄÊúâËÆøÂ≠òÊåá‰ª§Êèê‰æõÁöÑÂú∞ÂùÄÂùá‰∏∫VAÔºåËøòÈúÄË¶ÅÂ∞ÜVAËΩ¨Êç¢‰∏∫PAÔºåÊâçËÉΩ‰ªéÁúüÂÆûÁöÑÂÜÖÂ≠òÁ°¨‰ª∂‰∏≠Ëé∑ÂèñÊï∞ÊçÆ„ÄÇÂ¶Ç‰ΩïÂÆûÁé∞VAÂà∞PAÁöÑËΩ¨Êç¢Ôºü ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊÉ≥Ê≥ïÊòØÔºöÂ∞ÜÊØè‰∏™VAÂíåPAÁöÑÂØπÂ∫îÂÖ≥Á≥ªËÆ∞ÂΩïÂú®‰∏Ä‰∏™Ë°®‰∏≠Ôºå‰ΩøÁî®VAÊü•ËØ¢ËØ•Ë°®Âç≥ÂèØÊâæÂà∞ÂØπÂ∫îÁöÑPA„ÄÇËøôÊ†∑ÁöÑÊò†Â∞ÑË°®‰ºöÂç†Áî®Â§ßÈáèÂÜÖÂ≠òÔºåÊïÖÂú®Áé∞‰ª£Êìç‰ΩúÁ≥ªÁªü‰∏≠ÔºåËôöÊãüÂÜÖÂ≠òÂíåÁâ©ÁêÜÂÜÖÂ≠òË¢´ÂàÜ‰∏∫4KBÈ°µÔºåÊò†Â∞ÑË°®‰∏≠Âè™ËÆ∞ÂΩï <code>VFN</code>ÔºàVirtual Frame NumberÔºåËôöÊãüÈ°µÂè∑ÔºâÂØπÂ∫îÁöÑ <code>PFN</code>ÔºàPhysical Frame NumberÔºåÁâ©ÁêÜÈ°µÂè∑ÔºâÔºåÊò†Â∞ÑË°®Ë°®È°πÊï∞ÈáèÂáèÂ∞ë‰∏∫ÂéüÊù•ÁöÑ1/4096„ÄÇÊò†Â∞ÑË°®ËÆ∞ÂΩï‰∫ÜËôöÊãüÈ°µ‰∏éÁâ©ÁêÜÈ°µ‰πãÈó¥ÁöÑÊò†Â∞ÑÔºå‰∫éÊòØÂæóÂêçPTÔºàPage TableÔºåÈ°µË°®ÔºâÔºåÂÖ∂Ë°®È°πÁß∞‰∏∫ <code>PTE</code>ÔºàPage Table EntryÔºåÈ°µË°®È°πÔºâ„ÄÇ‰∏∫‰∫ÜËøõ‰∏ÄÊ≠•ÂáèÂ∞ë PTE Êï∞ÈáèÔºå‰πüÂèØ‰ª•‰ΩøÁî®2MB/1GBÂ§ßÂ∞èÁöÑÈ°µÔºåÂç≥Â§ßÈ°µ„ÄÇ</p>
<p>ÊâÄÊúâÁ≥ªÁªüËΩØ‰ª∂ÁöÑËÆæËÆ°ÈÉΩËøΩÊ±ÇÊó∂Èó¥Â∞ΩÂèØËÉΩÁü≠„ÄÅÁ©∫Èó¥Âç†Áî®Â∞ΩÂèØËÉΩÂ∞ëÔºåÂú∞ÂùÄÁøªËØëÁ≥ªÁªüÁöÑËÆæËÆ°‰πü‰∏ÄÊ†∑„ÄÇ‰∫ãÂÆû‰∏äÔºåËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÂçÅÂàÜÂ∫ûÂ§ßÔºåÂ∫îÁî®Á®ãÂ∫è‰∏çÂèØËÉΩÂú®Áü≠Êó∂Èó¥ÂÜÖËÆøÈóÆÂ§ßÈáèÁöÑËôöÊãüÂÜÖÂ≠òÔºåËÄåÊòØÂ§öÊ¨°ËÆøÈóÆÊüê‰∫õËåÉÂõ¥ÂÜÖÁöÑËôöÊãüÂÜÖÂ≠òÔºåÂç≥Â≠òÂú®Á©∫Èó¥Â±ÄÈÉ®ÊÄß„ÄÇÂü∫‰∫éËøô‰∏ÄËßÇÂØüÔºå**Êìç‰ΩúÁ≥ªÁªüËÆæËÆ°ËÄÖÂ∞ÜÈ°µË°®ÁªÑÁªáÊàêÂü∫Êï∞Ê†ëÔºåÊàñÁß∞‰∏∫Â§öÁ∫ßÈ°µË°®Ôºå**ÂèØ‰ª•‰ΩøÊú™‰ΩøÁî®ÁöÑÊü•ËØ¢Ë°®È°π‰∏çÂá∫Áé∞Âú®ÂÜÖÂ≠ò‰∏≠ÔºåÂ§ßÂ§ßÂáèÂ∞ëÂÜÖÂ≠òÂç†Áî®„ÄÇÂú®32‰ΩçÊû∂ÊûÑÔºàÂ¶Çx86Ôºâ‰∏≠ÔºåÊìç‰ΩúÁ≥ªÁªü‰ΩøÁî® <code>10+10</code> ÂΩ¢ÂºèÁöÑ‰∫åÁ∫ßÈ°µË°®ÔºåÁî®Ââç10‰ΩçÁ¥¢Âºï‰∏ÄÁ∫ßÈ°µË°®ÔºåÂêé10‰ΩçÁ¥¢Âºï‰∫åÁ∫ßÈ°µË°®„ÄÇËÄåÂú®64‰ΩçÊû∂ÊûÑÔºàÂ¶Çx86-64„ÄÅARMv8-AÔºâ‰∏≠ÔºåÊìç‰ΩúÁ≥ªÁªü‰ΩøÁî® <code>9+9+9+9</code> ÂΩ¢ÂºèÁöÑÂõõÁ∫ßÈ°µË°®ÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200853541.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120085308461"
	
	
></p>
<p>ÂÖ∂‰∏≠È°µË°®ÁöÑÊØè‰∏ÄÁ∫ßÂàÜÂà´Áî®PML4ÔºàPage Map Level 4ÔºåÁ¨¨4Á∫ßÈ°µÊò†Â∞ÑÔºâ„ÄÅPDPTÔºàPage Directory Pointer TableÔºåÈ°µÁõÆÂΩïÊåáÈíàË°®Ôºâ„ÄÅPDÔºàPage DirectoryÔºåÈ°µÁõÆÂΩïÔºâ„ÄÅPTË°®Á§∫ÔºåÊü•ËØ¢‰∏ÄÊ¨°È°µË°®ÈúÄË¶Å4Ê¨°ÂÜÖÂ≠òËÆøÈóÆ„ÄÇÂú®32‰ΩçÁ≥ªÁªü‰∏≠ÔºåÂΩì‰∏Ä‰∏™Â∫îÁî®Á®ãÂ∫èËøûÁª≠ËÆøÈóÆ‰∫ÜËøûÁª≠ÁöÑ4MBËôöÊãüÂÜÖÂ≠òÔºå‰ΩøÁî® <code>10+10</code> ÁöÑ‰∫åÁ∫ßÈ°µË°®Âàô‰ªÖÈúÄË¶Å1‰∏™‰∏ÄÁ∫ßÈ°µË°®È°µÂíå1‰∏™‰∫åÁ∫ßÈ°µË°®È°µÔºåÈ°µË°®Âç†Áî®ÂÜÖÂ≠òÂ§ßÂ∞è‰∏∫8KB„ÄÇËÄå‰ΩøÁî®‰∏ÄÁ∫ßÈ°µË°®ÂàôÈúÄË¶Å4MBÂÜÖÂ≠òÔºå‰ªÖ‰ªÖÊòØÊü•ËØ¢È°µË°®Êó∂Â§ö‰∫Ü‰∏ÄÊ¨°ÂÜÖÂ≠òËÆøÈóÆÔºåÂÜÖÂ≠òÂç†Áî®Â∞±ÂáèÂ∞è‰∏∫ÂéüÊù•ÁöÑ <code>8KB/4MB=1/512</code>ÔºåËøôÊòØÂçÅÂàÜÂàíÁÆóÁöÑ„ÄÇ</p>
<p>Êü•ËØ¢È°µË°®‰∏çÂ∫îËØ•Áî±Â∫îÁî®Á®ãÂ∫èË¥üË¥£ÔºåÂõ†‰∏∫ËøôÂØπ‰∫éÂ∫îÁî®Á®ãÂ∫èÂÆåÊàêËá™Â∑±ÁöÑÂ∑•‰ΩúÊòØÊó†ÊÑè‰πâÁöÑÔºåÂπ∂‰∏îÁî±Â∫îÁî®Á®ãÂ∫èË¥üË¥£‰øÆÊîπÈ°µË°®‰ºö‰∫ßÁîüËôöÊãüÂÜÖÂ≠òÊ≥ÑÊºèÁöÑÈóÆÈ¢òÔºåËôöÊãüÂÜÖÂ≠òÁöÑÈöîÁ¶ªÊÄßÂ∞Ü‰∏çÂ§çÂ≠òÂú®ÔºåÈÄ†ÊàêÂÆâÂÖ®ÈóÆÈ¢ò„ÄÇ‰∫éÊòØÔºåCPUËäØÁâáËÆæËÆ°ËÄÖÂºïÂÖ•‰∫ÜMMUÔºàMemory Management UnitÔºåÂÜÖÂ≠òÁÆ°ÁêÜÂçïÂÖÉÔºâË¥üË¥£Êü•ËØ¢È°µË°®„ÄÇÊØè‰∏™CPUÊ†∏ÂøÉ‰∏äÈÉΩÈÖçÂ§á‰∫Ü‰∏Ä‰∏™Áã¨Á´ãÁöÑMMUÔºåÂè™Ë¶ÅCPUÂ∞ÜÈ°µË°®ÁöÑÂü∫Âú∞ÂùÄÊîæÂÖ•‰∏Ä‰∏™ÊåáÂÆöÁöÑÂØÑÂ≠òÂô®‰∏≠ÔºåMMU‰∏≠ÁöÑPTWÔºàPage Table WalkerÔºåÈ°µË°®Áà¨ÂèñÂô®ÔºâÂç≥ÂèØÊü•ÊâæÈ°µË°®Â∞ÜCPU‰∫ßÁîüÁöÑVAËá™Âä®ÁøªËØëÊàêPFNÔºåÂ∑¶Áßª12‰ΩçÂêé‰∏éVAÁöÑ‰Ωé12‰ΩçÁõ∏Âä†Âç≥ÂæóÂà∞PAÔºå‰∏çÈúÄË¶ÅCPUÊâßË°åÈ¢ùÂ§ñÁöÑÊåá‰ª§„ÄÇËøô‰∏ÄÊåáÂÆöÁöÑÂØÑÂ≠òÂô®Âú®Intel‰ΩìÁ≥ª‰∏≠ÊòØCR3ÔºåÂú®ARM‰ΩìÁ≥ª‰∏≠ÊòØTTBRxÔºàTranslation Table Base Register xÔºåÁøªËØëË°®Âü∫Âú∞ÂùÄÂØÑÂ≠òÂô®xÔºâ„ÄÇËøô‰∫õÊû∂ÊûÑ‰∏ãÁöÑÂú∞ÂùÄÁøªËØëÂéüÁêÜÂ§ßËá¥Áõ∏ÂêåÔºåÊïÖÊú¨ÊñáÁªü‰∏Ä‰ΩøÁî®ptrÔºàpointerÔºåÊåáÈíàÔºâ‰ª£Ë°®È°µË°®Âü∫Âú∞ÂùÄ„ÄÇ</p>
<p>ÂêåÊó∂ÔºåMMUÁ°¨‰ª∂‰πüÈÄöËøáPTE‰∏äÁöÑÊ†áÂøó‰ΩçÂÆûÁé∞‰∫ÜËÆøÂ≠òÂêàÊ≥ïÊÄßÁöÑÊ£ÄÊü•Ôºå‰ª•ÂèäÂÜÖÂ≠òËÆøÈóÆÊÉÖÂÜµÁöÑËÆ∞ÂΩï„ÄÇIntel‰ΩìÁ≥ª‰∏ãÁöÑPTEÊ†áÂøó‰ΩçËØ¶ËßÅIntel SDMÂç∑3Á¨¨4Á´†ÔºåÂÖ∂‰ªñ‰ΩìÁ≥ªÊúâÁõ∏Â∫îÁöÑÊâãÂÜå„ÄÇÊ≠§Â§ÑÂàó‰∏æÂ¶Ç‰∏ãx86Êû∂ÊûÑ‰∏≠Â∏∏Áî®ÁöÑÊ†áÂøó‰Ωç:</p>
<ul>
<li>P (Present) ‰Ωç„ÄÇPTE[0]ÔºåÁΩÆ‰∏∫1Êó∂ËØ•PTEÊúâÊïàÔºå‰∏∫0Êó∂ËØ•PTEÊó†Êïà„ÄÇ‰ªª‰ΩïËÆøÈóÆËØ•PTEÂØπÂ∫îÁöÑËôöÊãüÂú∞ÂùÄÁöÑÊåá‰ª§ÂùáÂºïËµ∑Áº∫È°µÂºÇÂ∏∏„ÄÇÂΩìÁâ©ÁêÜÈ°µÊú™ÂàÜÈÖç„ÄÅÈ°µË°®È°πÊú™Âª∫Á´ãÔºàÊ≠§Êó∂PTEÁöÑÊØè‰∏Ä‰ΩçÂùá‰∏∫0ÔºâÊàñÁâ©ÁêÜÈ°µË¢´Êç¢Âá∫Êó∂ÔºàÊ≠§Êó∂PTEÁöÑÊØè‰∏Ä‰Ωç‰∏çÂÖ®‰∏∫0ÔºâÔºåP‰Ωç‰∏∫0ÔºåÁâ©ÁêÜÈ°µ‰∏çÂ≠òÂú®Ôºõ</li>
<li>R/W‰ΩçÂíåU/S‰Ωç„ÄÇPTE[1‚à∂2]ÔºåÁΩÆ‰∏∫1Êó∂Ë°®Á§∫ËØ•È°µÊòØÂèØËØªÂèØÂÜôÁöÑÔºå‰∏∫0Êó∂Ë°®Á§∫ËØ•È°µÂè™ËØª„ÄÇU/S‰ΩçÁΩÆ‰∏∫0Êó∂Âè™ÊúâÁÆ°ÁêÜËÄÖÔºàsupervisorÔºåÂç≥ËøêË°åÂú®Ring0„ÄÅRing1„ÄÅRing2ÁöÑ‰ª£Á†ÅÔºâÂèØ‰ª•ËÆøÈóÆÔºå‰∏∫1Êó∂Áî®Êà∑ÔºàuserÔºåÂç≥ËøêË°åÂú®Ring3ÁöÑ‰ª£Á†ÅÔºâ„ÄÅÁÆ°ÁêÜËÄÖÂùáÂèØËÆøÈóÆ„ÄÇËøô‰∏§‰∏™‰ΩçÁî®‰∫éÊùÉÈôêÁÆ°ÁêÜÔºõ</li>
<li>A(Accessed)‰ΩçÂíåD(Dirty)‰Ωç„ÄÇPTE[5‚à∂6]ÔºåÂΩìCPUÂÜôÂÖ•PTEÂØπÂ∫îÁöÑÈ°µÊó∂D‰ΩçË¢´ÁΩÆ‰∏∫1ÔºåÂΩìCPUËØªÂèñÊàñÂÜôÂÖ•PTEÂØπÂ∫îÁöÑÈ°µÊó∂A‰ΩçË¢´ÁΩÆ‰∏∫1ÔºåËøô‰∏§‰ΩçÂùáÈúÄË¶ÅÊìç‰ΩúÁ≥ªÁªüÁΩÆ0„ÄÇ
<ul>
<li>D‰Ωç‰ªÖÂ≠òÂú®‰∫éPTE‰∏≠ÔºåËÄå‰∏çÂ≠òÂú®‰∫éPDEÔºàPage Directory EntryÔºåÈ°µÁõÆÂΩïÈ°πÔºâ‰∏≠„ÄÇD‰ΩçÁî®‰∫éÊ†áËØÜ‰∏Ä‰∏™Êñá‰ª∂Êò†Â∞ÑÁöÑÈ°µÂú®ÂÜÖÂ≠ò‰∏≠ÊòØÂê¶Ë¢´‰øÆÊîπÔºåÂú®Â∞ÜÈ°µÊç¢Âá∫Êó∂ÈúÄË¶ÅÊõ¥Êñ∞ÂØπÂ∫îÁöÑÁ£ÅÁõòÊñá‰ª∂Ôºõ</li>
<li>A‰ΩçÁî®‰∫éÊ†áËØÜÂÜÖÂ≠òÈ°µÊòØÂê¶ÊúÄËøëË¢´ËÆøÈóÆ„ÄÇÂΩìÊìç‰ΩúÁ≥ªÁªüÂ∞ÜA‰ΩçÁΩÆ‰∏∫0Âêé‰∏ÄÊÆµÊó∂Èó¥ÂÜÖÔºåËã•A‰Ωç‰∏çÂÜçÂèò‰∏∫1ÔºåÂàôÂØπÂ∫îÁöÑÂÜÖÂ≠òÈ°µ‰∏çÁªèÂ∏∏Ë¢´ËÆøÈóÆÔºåÂèØ‰ª•Ë¢´Êç¢Âá∫Âà∞Á£ÅÁõò„ÄÇÊìç‰ΩúÁ≥ªÁªüÊúâ‰∏ÄÂ•óÂÜÖÂ≠òÈ°µÊç¢Âá∫Êú∫Âà∂ÔºåÂ∞Ü‰∏çÁªèÂ∏∏ËÆøÈóÆÁöÑÂÜÖÂ≠òÈ°µÊç¢Âá∫Âà∞Á£ÅÁõòÔºå‰øùËØÅÂÜÖÂ≠òË¢´ÂÖÖÂàÜ‰ΩøÁî®„ÄÇ</li>
</ul>
</li>
</ul>
<p>**ÂΩìMMUÁ°¨‰ª∂Êó†Ê≥ïÂÆåÊàêÂú∞ÂùÄÁøªËØëÊó∂ÔºåÂàôÈúÄË¶ÅÊìç‰ΩúÁ≥ªÁªüËΩØ‰ª∂ÁöÑÈÖçÂêà„ÄÇ**Âú®Âú∞ÂùÄÁøªËØëÁöÑËøáÁ®ã‰∏≠ÔºåMMUÁ°¨‰ª∂‰ªÖË¥üË¥£È°µË°®ÁöÑÊü•ËØ¢ÔºåËÄåÊìç‰ΩúÁ≥ªÁªüË¥üË¥£È°µË°®ÁöÑÁª¥Êä§„ÄÇÂΩìMMUÊó†Ê≥ïÂÆåÊàêÂú∞ÂùÄÁøªËØëÊó∂ÔºåÂ∞±‰ºöÂêëCPUÂèëÈÄÅ‰∏Ä‰∏™‰ø°Âè∑Ôºå‰∫ßÁîü‰∫ÜÁº∫È°µÂºÇÂ∏∏ÔºàÂú®x86Êû∂ÊûÑ‰∏≠ÊòØ14Âè∑ÂºÇÂ∏∏ÔºâÔºå‰ªéËÄåË∞ÉÁî®Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÁöÑÁº∫È°µÂºÇÂ∏∏Â§ÑÁêÜÂáΩÊï∞„ÄÇÂÜÖÊ†∏ÊåâÁÖßÂÖ∂ÈúÄË¶Å‰∏∫‰∫ßÁîüÁº∫È°µÂºÇÂ∏∏ÁöÑVAÂàÜÈÖçÁâ©ÁêÜÂÜÖÂ≠òÔºåÂª∫Á´ãÈ°µË°®ÔºåÂπ∂ÈáçÊñ∞ÊâßË°åÂºïËµ∑Áº∫È°µÂºÇÂ∏∏ÁöÑËÆøÂ≠òÊåá‰ª§ÔºõÂ¶ÇÊûúËØ•ËÆøÂ≠òÊåá‰ª§ËÆøÈóÆÁöÑËôöÊãüÂÜÖÂ≠òË¢´Êç¢Âá∫Âà∞Á£ÅÁõò‰∏äÔºåÂàôÈúÄË¶ÅÈ¶ñÂÖàÂàÜÈÖçÁâ©ÁêÜÂÜÖÂ≠òÈ°µÔºåÂÜçÂØπÁ£ÅÁõòÂèëËµ∑I/OËØ∑Ê±ÇÔºåÂ∞ÜË¢´Êç¢Âá∫ÁöÑÈ°µËØªÂèñÂà∞Êñ∞ÂàÜÈÖçÁöÑÁâ©ÁêÜÂÜÖÂ≠òÈ°µ‰∏äÔºåÊúÄÂêéÂª∫Á´ãÂØπÂ∫îÁöÑÈ°µË°®È°π„ÄÇÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•ÁÅµÊ¥ªÂú∞Âà©Áî®Áº∫È°µÂºÇÂ∏∏ÔºåÂÆûÁé∞ÂÜÖÂ≠òÊç¢Âá∫„ÄÅCOWÔºàCopy-On-WriteÔºåÂÜôÊó∂Â§çÂà∂ÔºâÁ≠âÂäüËÉΩ„ÄÇ</p>
<p>Áº©Áü≠Êó∂Èó¥ÁöÑ‰∏ÄÁßçÈáçË¶ÅÊñπÂºèÊòØÁºìÂ≠ò„ÄÇÂú®MMU‰∏≠ÔºåTLBÔºàTranslation Lookaside BufferÔºåÁøªËØëÂêéÂ§áÁºìÂÜ≤Âô®ÔºâÁî®‰∫éÁºìÂ≠òVAÂà∞PAÁöÑÊò†Â∞ÑÔºåÈÅøÂÖçÊü•ËØ¢È°µË°®ÈÄ†ÊàêÁöÑÂÜÖÂ≠òËÆøÈóÆ„ÄÇÁÑ∂ËÄåÔºåÂÜÖÂ≠òÂÆπÈáèÈöèÁùÄÊäÄÊúØÁöÑËøõÊ≠•Âø´ÈÄüÂ¢ûÂ§ßÔºåTLBÂÆπÈáèÁöÑÂ¢ûÈÄüÂç¥ÂæàÁºìÊÖ¢ÔºåËøôÂØºËá¥TLBËÉΩÂ§üË¶ÜÁõñÁöÑËôöÊãüÂÜÖÂ≠òÁ©∫Èó¥Ë∂äÊù•Ë∂äÂ∞è„ÄÇÁ†îÁ©∂Ë°®ÊòéÔºåÂ∫îÁî®ËøêË°åÊó∂Èó¥ÁöÑ 50% ÈÉΩËÄóË¥πÂú®Êü•ËØ¢È°µË°®‰∏ä„ÄÇ**ÂâçÊñáÊèêÂà∞ÁöÑÂ§ßÈ°µÂèØ‰ª•Âú®‰∏ÄÂÆöÁ®ãÂ∫¶‰∏äËß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢òÔºå‰ΩÜ‰∏çÂ§üÁÅµÊ¥ª„ÄÇ**VasileiosÁ≠âÊèêÂá∫‰∫ÜÂå∫Èó¥ÂºèTLBÊú∫Âà∂ÔºåÊØè‰∏™Âå∫Èó¥TLBÈ°πÂèØ‰ª•Â∞Ü‰ªªÊÑèÈïøÂ∫¶ÁöÑËôöÊãüÂÜÖÂ≠òÂå∫Èó¥Êò†Â∞ÑÂà∞Áâ©ÁêÜÂÜÖÂ≠òÔºåËØ•ÈïøÂ∫¶Áî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆöÔºåËøõ‰∏ÄÊ≠•ÂáèÂ∞ë‰∫ÜPTEÁöÑÊï∞Èáè„ÄÇËøô‰∏§ÁßçÊñπÂºè‰ΩøÂæóTLBËÉΩÂ§üË¶ÜÁõñÊõ¥Â§öÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÔºåÂáèÂ∞ë‰∫ÜÊü•ËØ¢È°µË°®ÁöÑÊ¨°Êï∞„ÄÇ</p>
<p>Âú®ËøõÁ®ãÂàáÊç¢Êó∂ÔºåÁî±‰∫éËøõÁ®ãËøêË°åÂú®‰∏çÂêåÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰∏≠ÔºåÈúÄË¶ÅÂ∞ÜTLB‰∏≠ÁöÑÊâÄÊúâÈ°πÊ∏ÖÁ©∫ÔºåÂê¶ÂàôÂú∞ÂùÄÁøªËØëÂ∞ÜÂá∫Èîô„ÄÇx86/ARMÁ°¨‰ª∂Êèê‰æõ‰∫ÜPCIDÔºàProcess Context IDentifierÔºåËøõÁ®ã‰∏ä‰∏ãÊñáÊ†áËØÜÁ¨¶Ôºâ/ASIDÔºàAddress Space IDentifierÔºåÂú∞ÂùÄÁ©∫Èó¥Ê†áËØÜÁ¨¶ÔºâÔºåÂ∞ÜTLB‰∏≠ÁöÑÈ°πÊ†á‰∏äËøõÁ®ãIDÔºå‰∫éÊòØÂú®ËøõÁ®ãÂàáÊç¢Êó∂Êó†È°ªÊ∏ÖÁ©∫TLB„ÄÇËØ¶ËßÅIntel SDMÂç∑3Á¨¨4.10ËäÇ„ÄÇ</p>
<h2 id="22-ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ∫ØËΩØ‰ª∂ÂÆûÁé∞-ÂΩ±Â≠êÈ°µË°®">2.2 ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ∫ØËΩØ‰ª∂ÂÆûÁé∞: ÂΩ±Â≠êÈ°µË°®
</h2><p>Âú®Êñ∞Á≥ªÁªüËÆæËÆ°ÁöÑËøáÁ®ã‰∏≠ÔºåÂ§çÁî®Â∑≤ÊúâËÆæËÆ°ÂèØ‰ª•Âä†Âø´ËÆæËÆ°ÁöÑÊµÅÁ®ãÔºåÈôç‰ΩéËÆæËÆ°ÁöÑÈöæÂ∫¶„ÄÇÊòØÂê¶ÂèØ‰ª•ÈáçÁî®CPUËäØÁâá‰∏äÁöÑMMU‰ªéËÄåÂÆûÁé∞GVAÂà∞HPAÁöÑÁøªËØëÂë¢Ôºü ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËøêË°åÂú®ÈùûÊ†πÊ®°Âºè‰∏ãÔºåÂ∞ÜÂÆ¢Êà∑Êú∫È°µË°®Ëµ∑ÂßãÂú∞ÂùÄGPAÂÜôÂÖ•ptrÔºåËøôÊ†∑MMUÂè™ËÉΩÂÆåÊàêGVAÂà∞GPAÁöÑÁøªËØë„ÄÇÂ∞ÜÈ°µË°®‰øÆÊîπ‰∏∫GVAÂà∞HPAÁöÑÊò†Â∞ÑÔºåMMUÂ∞±ËÉΩÂ∞ÜGVAÁøªËØë‰∏∫HPAÔºåÂπ∂‰∏îÂØπÂÆ¢Êà∑Êú∫ÂÆåÂÖ®ÈÄèÊòéÔºå‰ªéËÄåÂÆåÊàêÈóÆÈ¢òÁöÑËΩ¨Âåñ„ÄÇ‰ΩøÁî®ÂΩ±Â≠êÈ°µË°®ÁøªËØëÂÆ¢Êà∑Êú∫ËôöÊãüÂú∞ÂùÄÁöÑÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200853600.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120085351509"
	
	
></p>
<p>ÂÖ∑‰ΩìÊìç‰ΩúËøáÁ®ãÊòØÔºö</p>
<ol>
<li>ÂΩìvCPUÂàõÂª∫Êó∂ÔºåHypervisor‰∏∫vCPUÂáÜÂ§á‰∏Ä‰∏™Êñ∞ÁöÑÁ©∫È°µË°®„ÄÇÂΩìvCPUÂ∞ÜGPTÁöÑGPAÂÜôÂÖ•ptrÊó∂ÔºåÂºïËµ∑‰∏ÄÊ¨°VM-ExitÔºåvCPUÁ∫øÁ®ãÈÄÄÂá∫Âà∞Hypervisor‰∏≠ÔºåË∞ÉÁî®Â§ÑÁêÜptrÂÜôÂÖ•ÁöÑÂ§ÑÁêÜÂáΩÊï∞Ôºõ</li>
<li>Hypervisor‰∏≠‰øùÂ≠ò‰∫ÜGPAÂà∞HVAÁöÑÊò†Â∞ÑÔºåÂ§ÑÁêÜÂáΩÊï∞ËØªÂèñÂÆ¢Êà∑Êú∫ËØïÂõæÂÜôÂÖ•ÁöÑptrÂÄºÔºåÁøªËØë‰∏∫HVAÔºåÂç≥ÂèØËØªÂèñGPTÁöÑÂÜÖÂÆπ„ÄÇËøõËÄåÔºåHypervisorÈÅçÂéÜGPTÔºåÂπ∂Â∞ÜÊØè‰∏™GPTË°®È°π‰∏≠‰øùÂ≠òÁöÑGPAÁøªËØë‰∏∫HVAÔºåÂÜç‰ΩøÁî®ÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÁøªËØë‰∏∫HPAÔºåÊúÄÂêéÂ∞ÜHPAÂ°´ÂÖ•Êñ∞È°µË°®SPTÁöÑGVAÂ§ÑÔºõ</li>
<li>ÂÆåÊàêGPTÁöÑÈÅçÂéÜÂêéÔºåÂ∞±Âª∫Á´ã‰∫ÜÂØπÂ∫îÁöÑÊñ∞È°µË°®SPTÔºåHypervisorÁöÑÂ§ÑÁêÜÂáΩÊï∞ÊúÄÁªàÂ∞ÜËØ•Êñ∞È°µË°®ÁöÑÂü∫Âú∞ÂùÄÂÜôÂÖ•ptr‰∏≠ÔºåÂπ∂ËøîÂõûÂà∞vCPUÈáçÊñ∞ÊâßË°åÂºïËµ∑VM-ExitÁöÑÊåá‰ª§„ÄÇËßÅ‰∏äÂõæ‰∏≠Ê†áÂè∑‚ë†Ôºõ</li>
<li>GPTÁöÑÊâÄÊúâÈ°µË°®È°µË¢´Ê†áËÆ∞‰∏∫Âè™ËØªÔºåÂÆ¢Êà∑Êú∫ÂÜôÂÖ•GPTÂºïÂèëVM-ExitÔºåÂπ∂Ë∞ÉÁî®HypervisorÁöÑÁõ∏ÂÖ≥Â§ÑÁêÜÂáΩÊï∞ÔºåÊääÂØπGPTÁöÑ‰øÆÊîπÁøªËØë‰∏∫ÂØπSPTÁöÑ‰øÆÊîπÔºåÂÆåÊàêÊñ∞È°µË°®‰∏éGPT‰πãÈó¥ÁöÑÂêåÊ≠•ÔºåËßÅÂõæ3-5‰∏≠Ê†áÂè∑‚ë°„ÄÇ</li>
</ol>
<p>‰∏äËø∞ËøáÁ®ã‰∏≠Âá∫Áé∞ÁöÑÊñ∞È°µË°®Áß∞‰∏∫ÂΩ±Â≠êÈ°µË°®ÔºåÂõ†‰∏∫ÂØπ‰∫éÊØè‰∏™GPTÔºåÈÉΩÈúÄË¶ÅÂØπÂ∫îÁöÑSPT‰Ωú‰∏∫‰ª£ÊõøÔºå‰∏îSPT‰∏éGPTÁöÑÁªìÊûÑÂÆåÂÖ®Áõ∏ÂêåÔºåÂÖ∂‰∏çÂêå‰ªÖ‰ªÖÊòØÊØè‰∏™Ë°®È°π‰∏≠ÁöÑGPAË¢´‰øÆÊîπ‰∏∫‰∫ÜÂØπÂ∫îÁöÑHPAÔºåÂ¶ÇÂêåÂΩ±Â≠ê‰∏ÄÊ†∑„ÄÇÂΩ±Â≠êÈ°µË°®Êü•ËØ¢ÁöÑÁªìÊûúÊòØHFNÔºàHost Frame NumberÔºåÂÆø‰∏ªÊú∫È°µÂè∑ÔºâÔºåÂ∑¶Áßª12‰ΩçÂêé‰∏éGVAÁöÑ‰Ωé12‰ΩçÁõ∏Âä†Âç≥ÂæóÂà∞ÂØπÂ∫îÁöÑHPA„ÄÇ</p>
<p>ÂíåÈùûËôöÊãüÂåñÂú∫ÊôØ‰∏ãÁöÑÈ°µË°®Áõ∏ÂêåÔºåMMUÁ°¨‰ª∂ÂèØ‰ª•Ëá™Âä®Êü•ËØ¢SPTÔºåÂ∞ÜCPU‰∫ßÁîüÁöÑGVAÁõ¥Êé•ÁøªËØë‰∏∫HPAÔºå‰πüÊúâTLB‰øùÂ≠òGVAÂà∞HPAÁöÑÊò†Â∞Ñ‰ª•Âä†Âø´Âú∞ÂùÄÁøªËØë„ÄÇËôöÊãüÂÜÖÂ≠òÁöÑ‰ºòÂäø‰πüÂèØÂ∫îÁî®Âú®VMËøõÁ®ãÁöÑÂÜÖÂ≠òÁÆ°ÁêÜ‰∏äÔºåÂ¶ÇÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÂèØ‰ª•Â∞ÜVMËøõÁ®ã‰∏çÂ∏∏Áî®ÁöÑÂÜÖÂ≠òÈ°µÊç¢Âá∫Âà∞Á£ÅÁõòÔºå‰∏§‰∏™ÂÆ¢Êà∑Êú∫‰πãÈó¥‰πüÂèØ‰ª•ÈÄöËøáÈ°µË°®ÁöÑÊùÉÈôêÂÆûÁé∞ÁÆÄÂçïÁöÑÈöîÁ¶ªÔºåËøòÂèØ‰ª•ÈÄöËøáÂ∞Ü‰∏§‰∏™ÂÜÖÂ≠òÊèíÊßΩÂØπÂ∫îÁöÑHVAÊò†Â∞ÑÂà∞Áõ∏ÂêåÁöÑHPAÔºåÂ∫îÁî®COWÊäÄÊúØÂÆûÁé∞ÂÆ¢Êà∑Êú∫‰πãÈó¥ÁöÑÂÜÖÂ≠òÂÖ±Áî®Ôºå‰ªéËÄåËäÇÁ∫¶Á≥ªÁªüÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåÂÆûÁé∞ÂÜÖÂ≠òË∂ÖÂîÆ„ÄÇ</p>
<p>‰∏∫‰∫ÜÂ∞ÜGPTÁøªËØë‰∏∫SPTÔºåÈúÄË¶ÅÂà©Áî®ÂÆø‰∏ªÊú∫‰∏≠‰øùÂ≠òÁöÑGPAÂà∞HPAÁöÑÊò†Â∞Ñ„ÄÇÁî±‰∫éHVAÂà∞HPAÁöÑÊò†Â∞ÑÁî±ÂÆø‰∏ªÊú∫È°µË°®‰øùÂ≠òÔºåHypervisor‰ªÖÈúÄÂÖ≥Ê≥®GPAÂà∞HVAÁöÑÊò†Â∞Ñ„ÄÇ‰∫ãÂÆû‰∏äÔºåÂú®Hypervisor (Â¶ÇKVM) ‰∏≠ÔºåÂÜÖÂ≠òÊèíÊßΩ (kvm_memory_slot) Êï∞ÊçÆÁªìÊûÑÂ∞Ü‰∏ÄÊÆµGPA‰∏ÄÂØπ‰∏ÄÊò†Â∞ÑÂà∞HVAÔºåÁî®ÂÆø‰∏ªÊú∫ÁöÑËôöÊãüÂÜÖÂ≠ò‰Ωú‰∏∫ËôöÊãüÁöÑ ‚ÄúÂÜÖÂ≠òÊèíÊßΩ‚Äù ÁªôÂÆ¢Êà∑Êú∫‰ΩøÁî®„ÄÇÂÜÖÂ≠òÊèíÊßΩÂú®HVA‰∏≠ÁöÑ‰ΩçÁΩÆÂèØ‰ª•‰∏ç‰ªé0ÂºÄÂßã‰∏î‰∏çËøûÁª≠Ôºå‰ΩÜHypervisor‰ΩøÁî®Â§ö‰∏™ÂÜÖÂ≠òÊèíÊßΩÂèØ‰ª•ÁªôÂÆ¢Êà∑Êú∫Êèê‰æõ‰∏Ä‰∏™‰ªé0ÂºÄÂßã‰∏îËøûÁª≠ÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥„ÄÇÂÆ¢Êà∑Êú∫ÂÜÖÂ≠òÊèíÊßΩÁöÑËÆæËÆ°Âú®ÂêéÊñá‰∏≠ÊúâËØ¶ÁªÜ‰ªãÁªç„ÄÇ</p>
<p>ÂΩ±Â≠êÈ°µË°®ÁöÑÁº∫Èô∑Ôºö</p>
<ul>
<li>Áî±‰∫éHypervisorÈúÄË¶Å‰∏∫ÊØè‰∏™ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÊØè‰∏™ËøõÁ®ãÁª¥Êä§‰∏Ä‰∏™Áã¨Á´ãÁöÑSPTÔºåÁ≥ªÁªü‰∏≠GPTÁöÑÊï∞ÁõÆÁ≠â‰∫éSPTÁöÑÊï∞ÁõÆÔºåËøôÂ∞ÜÂç†Áî®Â§ßÈáèÂÜÖÂ≠òÔºõ</li>
<li>ÂΩìGPTË¢´‰øÆÊîπÊó∂ÔºåÁî±‰∫éÈúÄË¶Å‰øùÊåÅSPT‰∏éGPTÁöÑÂêåÊ≠•ÔºåvCPUÁ∫øÁ®ãÈúÄË¶ÅVM-ExitÂ∞ÜÊéßÂà∂ÊùÉËΩ¨ËÆ©ÁªôHypervisorÔºåÁî±HypervisorÊ†πÊçÆGPTÁöÑ‰øÆÊîπÊù•‰øÆÊîπSPTÔºåÂêåÊó∂Â∞ÜTLB‰∏≠ÁºìÂ≠òÁöÑÁõ∏ÂÖ≥È°πÊ∏ÖÈô§„ÄÇ‰∫éÊòØÔºåÊØèÊ¨°ÂÆ¢Êà∑Êú∫ÂØπGPTÁöÑ‰øÆÊîπÈÉΩÂ∞ÜÂºïËµ∑Â∑®Â§ßÁöÑÊÄßËÉΩÂºÄÈîÄÔºåÂè™ÊúâÂΩìÂÆ¢Êà∑Êú∫ÂæàÂ∞ë‰øÆÊîπGPTÊó∂ÔºåSPTÊâç‰ºöË°®Áé∞Âá∫ËæÉÂ•ΩÁöÑÊÄßËÉΩ„ÄÇ</li>
</ul>
<h2 id="23-ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ°¨‰ª∂ÊîØÊåÅ-Êâ©Â±ïÈ°µË°®">2.3 ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÁ°¨‰ª∂ÊîØÊåÅ: Êâ©Â±ïÈ°µË°®
</h2><p>‰ªîÁªÜÂõûÈ°æËôöÊãüÂåñÁéØÂ¢É‰∏ãÁöÑÂú∞ÂùÄÁøªËØëÔºåÂèØ‰ª•ÂèëÁé∞GPAÂà∞HPAÁöÑËΩ¨Êç¢‰∏ÄÊ≠•ÂèØ‰ª•‰ªéÂΩ±Â≠êÈ°µË°®‰∏≠Ââ•Á¶ªÂá∫Êù•:</p>
<ul>
<li>ÂΩìÂÆ¢Êà∑Êú∫ÂàõÂª∫Êó∂ÔºåÂÆø‰∏ªÊú∫ÁªôÂÆ¢Êà∑Êú∫‰ΩøÁî®ÁöÑÂÜÖÂ≠òÂ∑≤ÁªèÂàÜÈÖçÂÆåÊØïÔºåÂú®ÂÆ¢Êà∑Êú∫ÁöÑËøêË°åËøáÁ®ã‰∏≠ÔºåÂæàÂ∞ëÊîπÂèòGPAÂà∞HPAÁöÑÊò†Â∞ÑÔºõ</li>
<li>ÂÖ∂Ê¨°ÔºåSPTÂíåGPT‰πüÂåÖÂê´ÈáçÂ§çÁöÑ‰ø°ÊÅØÔºåÂç≥Á≠â‰ª∑‰∫éÂåÖÂê´‰∫Ü‰∏§Ê¨°GVAÂà∞GPAÁöÑÊò†Â∞ÑÔºõ</li>
<li>‰∏§‰∏™ËøõÁ®ãÁöÑSPT‰πãÈó¥‰πüÂåÖÂê´ÈáçÂ§çÁöÑ‰ø°ÊÅØÔºåÂç≥ÈáçÂ§çÂ§öÊ¨°ÂåÖÂê´‰∫ÜGPAÂà∞HPAÁöÑÊò†Â∞ÑÔºåÊïÖÂ¢ûÂä†‰∫ÜÈ°µË°®Áª¥Êä§ÁöÑÂ§çÊùÇÂ∫¶Âπ∂Â¢ûÂ§ß‰∫ÜÂÜÖÂ≠òÂºÄÈîÄ„ÄÇ</li>
</ul>
<p>‰∫éÊòØÔºåÁ≥ªÁªüËÆæËÆ°ËÄÖÂ∞ÜGPAÂà∞HPAÁöÑÊò†Â∞Ñ‰ªéÂΩ±Â≠êÈ°µË°®‰∏≠Ââ•Á¶ªÂá∫Êù•ÔºåÂΩ¢Êàê‰∏Ä‰∏™Êñ∞ÁöÑÈ°µË°®ÔºåÈÖçÂêàGVAÂà∞GPAÊò†Â∞ÑÁöÑÈ°µË°®(GPT)ÂÖ±ÂêåÂÆåÊàêÂú∞ÂùÄÁøªËØë„ÄÇ</p>
<p>ËôöÊãüÁéØÂ¢É‰∏ãÁöÑÂú∞ÂùÄÁøªËØë‰æùËµñ‰∫éÂèåÂ±ÇÈ°µË°® (Two Level Paging) „ÄÇGPAÂà∞HPAÊò†Â∞ÑÁöÑÈ°µË°®Âú® x86 ‰∏≠Áß∞‰∏∫EPTÔºàÊâ©Â±ïÈ°µË°®ÔºâÔºåÂú®ARM‰∏≠Áß∞‰∏∫Á¨¨‰∫åÈò∂ÊÆµÈ°µË°® (Stage-2 Page Table)ÔºåËÄåGPTÁß∞‰∏∫Á¨¨‰∏ÄÈò∂ÊÆµÈ°µË°® (Stage-1 Page Table)Ôºå‰∏Ä„ÄÅ‰∫åÈò∂ÊÆµÈ°µË°®Âü∫Âú∞ÂùÄÂàÜÂà´‰øùÂ≠òÂú® <code>TTBR0_EL1</code> Âíå <code>VTTBR_EL2</code> ‰∏≠„ÄÇ</p>
<blockquote>
<p><strong>Êú¨Êñá‰ΩøÁî®gptrÔºàguest pointerÔºåÂÆ¢Êà∑Êú∫ÊåáÈíàÔºâË°®Á§∫GPTÂü∫Âú∞ÂùÄÂØÑÂ≠òÂô®ÔºåHPTÔºàHost Page TableÔºåÂÆø‰∏ªÊú∫È°µË°®ÔºâË°®Á§∫Ë¢´Ââ•Á¶ªÂá∫ÁöÑÈ°µË°®ÔºõhptrÔºàhost pointerÔºåÂÆø‰∏ªÊú∫ÊåáÈíàÔºâË°®Á§∫HPTÂü∫Âú∞ÂùÄÂØÑÂ≠òÂô®„ÄÇ</strong></p>
<p><strong>ÊØè‰∏™ÂÆ¢Êà∑Êú∫Êúâ‰∏Ä‰∏™ÁßÅÊúâÁöÑHPTÔºåÂåÖÂê´‰∏éGPTÂÆåÂÖ®‰∏çÈáçÂ§çÁöÑ‰ø°ÊÅØ„ÄÇÁî±‰∫éHPT‰∏éGPT‰πãÈó¥Ê≤°Êúâ‰æùËµñÂÖ≥Á≥ªÔºå‰øÆÊîπGPTÊó∂Êó†È°ª‰øÆÊîπHPTÔºåÂç≥Êó†È°ªHypervisorÂπ≤È¢ÑÔºå‰ªéËÄåÂáèÂ∞ë‰∫ÜÂÆ¢Êà∑Êú∫ÈÄÄÂá∫Âà∞HypervisorÁöÑÊ¨°Êï∞„ÄÇ</strong></p>
</blockquote>
<hr>
<p>ARM‰∏éIntel VTÈÉΩÊèê‰æõ‰∫ÜÁ±ª‰ººÁöÑÂèåÂ±ÇÈ°µË°®ÊîØÊåÅÔºåËøôÈáåÂè™‰ªãÁªçIntel VT‰∏≠Êèê‰æõÁöÑÊîØÊåÅÔºåÂêéÊñáÁªü‰∏Ä‰ΩøÁî®EPTË°®Á§∫‰øùÂ≠ò‰∫ÜGPAÂà∞HPAÊò†Â∞ÑÁöÑÈ°µË°®„ÄÇIntel VTÊèê‰æõ‰∫ÜÂÖ∑Êúâ‰∫§ÂèâÊü•ËØ¢GPTÂíåEPTÂäüËÉΩÁöÑÊâ©Â±ïMMU„ÄÇÂΩìVM-EntryÊó∂ÔºåEPTPÔºàEPT PointerÔºåÊâ©Â±ïÈ°µË°®ÊåáÈíàÔºåÂç≥EPTÁöÑÂü∫Âú∞ÂùÄÔºâÂ∞ÜÁî±HypervisorËøõË°åËÆæÁΩÆÔºå‰øùÂ≠òÂú®VM-ExecutionÊéßÂà∂Âüü‰∏≠ÁöÑEPTPÂ≠óÊÆµ‰∏≠„ÄÇÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºå<strong>ÊØè‰∏™ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÊâÄÊúâvCPUÂú®ËøêË°åÂâçÔºåÂÖ∂ÂØπÂ∫îÁöÑVMCS‰∏≠ÁöÑEPTPÈÉΩ‰ºöË¢´ÂÜôÂÖ•Áõ∏ÂêåÁöÑÂÄº„ÄÇËøôÊòØÂõ†‰∏∫ÊâÄÊúâÁöÑvCPUÂ∫îËØ•ÁúãÂà∞Áõ∏ÂêåÁöÑÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÂç≥ÊâÄÊúâvCPUÂÖ±‰∫´EPT„ÄÇ‰∏Ä‰∏™ÂÆ¢Êà∑Êú∫‰ªÖÈúÄ‰∏Ä‰∏™EPTÔºåÊïÖÂáèÂ∞è‰∫ÜÂÜÖÂ≠òÂºÄÈîÄ„ÄÇ</strong></p>
<p>EPTË°®È°πÁöÑÊûÑÊàêËæÉ‰∏∫ÁÆÄÂçïÔºåÂÖ∂Á¨¨0„ÄÅ1„ÄÅ2‰ΩçÂàÜÂà´Ë°®Á§∫‰∫ÜÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µÁöÑÂèØËØª„ÄÅÂèØÂÜô„ÄÅÂèØÊâßË°åÊùÉÈôêÔºåÂπ∂ÂåÖÂê´ÊåáÂêë‰∏ã‰∏ÄÁ∫ßÈ°µË°®È°µÁöÑÊåáÈíà(HPA)„ÄÇÂΩìEPTPÔºàÂ≠òÂú®‰∫éVMCS‰∏≠ÔºâÁöÑÁ¨¨6‰Ωç‰∏∫1Êó∂Ôºå‰ºö‰ΩøËÉΩEPTÁöÑA/DÔºàAccessed/DirtyÔºåËÆøÈóÆ/ËÑèÔºâ‰Ωç„ÄÇEPT‰∏≠ÁöÑA/D‰ΩçÂíåÂâçÊñáÊâÄËø∞ÁöÑËøõÁ®ãÈ°µË°®ÁöÑA/D‰ΩçÁ±ª‰ººÔºåD‰Ωç‰ªÖÂ≠òÂú®‰∫éÁ¨¨ÂõõÁ∫ßÈ°µË°®È°πÔºåÂç≥PTE‰∏≠„ÄÇ<strong>A/D‰ΩçÁî±Â§ÑÁêÜÂô®Á°¨‰ª∂ÁΩÆ1ÔºåÁî±HypervisorËΩØ‰ª∂ÁΩÆ0„ÄÇ</strong></p>
<ul>
<li>ÊØèÂΩìEPTË¢´‰ΩøÁî®Êó∂ÔºåÂØπÂ∫îÁöÑEPTË°®È°πÁöÑA‰ΩçË¢´Â§ÑÁêÜÂô®ÁΩÆ1Ôºõ</li>
<li>ÂΩìÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òË¢´ÂÜôÂÖ•Êó∂ÔºåÂØπÂ∫îÁöÑEPTË°®È°πÁöÑD‰ΩçË¢´ÁΩÆ1„ÄÇ</li>
</ul>
<p>ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºå**ÂØπÂÆ¢Êà∑Êú∫È°µË°®GPTÁöÑ‰ªª‰ΩïËÆøÈóÆÂùáË¢´ËßÜ‰∏∫ÂÜôÔºåGPTÁöÑÈ°µË°®È°µÂØπÂ∫îEPTË°®È°πÁöÑD‰ΩçÂùáË¢´Â§ÑÁêÜÂô®Á°¨‰ª∂ÁΩÆ1„ÄÇ**ËØ•Á°¨‰ª∂ÁâπÊÄßÂ∞ÜÂú®Êú¨Êñá‰∏≠Â§öÂ§ÑÊèêÂèäÔºåÂèØÁî®‰∫éÂÆûÁé∞‰∏Ä‰∫õËΩØ‰ª∂ÂäüËÉΩÔºå‰πüÂèØÈÄâÊã©ÂÖ≥Èó≠ËØ•ÁâπÊÄßÔºå‰æãÂ¶ÇÂèØ‰ª•Áî®Ê≠§Á°¨‰ª∂ÁâπÊÄßÂÆûÁé∞ËôöÊãüÊú∫ÁÉ≠ËøÅÁßª„ÄÇËØ¶ËßÅIntel SDMÂç∑3Á¨¨28.2.4ËäÇ„ÄÇ</p>
<hr>
<p>ÂíåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑGPTÁ±ª‰ººÔºåEPT‰πüÊòØÂú®Áº∫È°µÂºÇÂ∏∏‰∏≠Áî±HypervisorËΩØ‰ª∂Âª∫Á´ãÁöÑÔºåÂÖ∑‰ΩìËøáÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>ÂΩìÂàöÂêØÂä®ÁöÑÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÊüêËøõÁ®ãËÆøÈóÆ‰∫Ü‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄÔºåÁî±‰∫éÊ≠§Êó∂ËØ•ËøõÁ®ãÁöÑ‰∏ÄÁ∫ßÈ°µË°®ÔºàGPT‰∏≠ÁöÑPML4Ôºâ‰∏∫Á©∫ÔºåÊïÖËß¶ÂèëÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑÁº∫È°µÂºÇÂ∏∏Ôºõ</li>
<li>ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªü‰∏∫‰∫ÜÂàÜÈÖçGPTÂØπÂ∫îÁöÑÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µÔºåÈúÄË¶ÅÊü•ËØ¢EPT„ÄÇÊ≠§Êó∂ÔºåÁî±‰∫éEPTÂ∞öÊú™Âª∫Á´ãÔºåÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂ∞±ÈÄÄÂá∫Âà∞‰∫ÜHypervisor„ÄÇÂΩìÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüËÆøÈóÆ‰∫Ü‰∏Ä‰∏™Áº∫Â§±ÁöÑEPTÈ°µË°®È°πÔºåÂ§ÑÁêÜÂô®‰∫ßÁîüEPTËøù‰æã(EPT Violation)ÁöÑVM-ExitÔºå‰ªéËÄåHypervisorÂàÜÈÖçÂÆø‰∏ªÊú∫ÂÜÖÂ≠ò„ÄÅÂª∫Á´ãEPTË°®È°πÔºõ</li>
<li>Ëß¶ÂèëEPTËøù‰æãÁöÑËØ¶ÁªÜÂéüÂõ†‰ºöË¢´Á°¨‰ª∂ËÆ∞ÂΩïÂú®VMCSÁöÑVM-ExitÊù°‰ª∂ (VM-Exit Qualification) Â≠óÊÆµÔºå‰æõHypervisor‰ΩøÁî®„ÄÇÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÂÆåÊàêÂÆø‰∏ªÊú∫Áâ©ÁêÜÈ°µÂàÜÈÖçÔºåÂª∫Á´ãÂØπÂ∫îÁöÑEPTË°®È°πÔºåÂ∞ÜËøîÂõûÂà∞ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÔºõ</li>
<li>ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÁªßÁª≠ËÆøÈóÆGPTÁöÑ‰∏ã‰∏ÄÁ∫ßÈ°µË°®(PDPT)ÔºåÈáçÂ§çÊ≠•È™§1„ÄÅ2ÔºåGPTÂíåEPTÁöÑÂª∫Á´ãÊñπÂèØÂÆåÊàê„ÄÇ</li>
</ol>
<p>ËøôÈáåÂèàÂá∫Áé∞‰∫ÜËΩØÁ°¨‰ª∂ÁöÑÊòéÁ°ÆÂàÜÂ∑•: **ËΩØ‰ª∂Áª¥Êä§È°µË°®ÔºåÁ°¨‰ª∂Êü•ËØ¢È°µË°®„ÄÇ**Â¶ÇÊûúËÆøÈóÆ‰∫ÜEPT‰∏≠ÁöÑ‰∏Ä‰∏™ÈÖçÁΩÆÈîôËØØÔºå‰∏çÁ¨¶ÂêàIntelËßÑËåÉÁöÑË°®È°πÔºåÂ§ÑÁêÜÂô®‰ºöËß¶ÂèëEPTÈÖçÁΩÆÈîôËØØ (EPT Misconfiguration) ÁöÑVM-Exit„ÄÇ‰æãÂ¶ÇËÆøÈóÆ‰∫Ü‰∏Ä‰∏™‰∏çÂèØËØª‰ΩÜÂèØÂÜôÁöÑË°®È°πÔºåÊ≠§Êó∂Á°¨‰ª∂Â∞Ü‰∏ç‰ºöËÆ∞ÂΩïÂèëÁîüEPTÈÖçÁΩÆÈîôËØØÁöÑÂéüÂõ†ÔºåËøôÁ±ªVM-ExitË¢´HypervisorÁî®‰∫éÊ®°ÊãüMMIO„ÄÇÊúâÂÖ≥EPTÁ°¨‰ª∂ÁöÑËØ¶ÁªÜÂÜÖÂÆπËØ∑ÂèÇÈòÖIntel SDMÂç∑3Á¨¨28Á´†ÔºåHypervisorËΩØ‰ª∂ÈÉ®ÂàÜÁöÑ‰ªãÁªçËßÅÊú¨ÊñáÁöÑÁ¨¨‰∏âÁ´†„ÄÇ</p>
<hr>
<p>ÂΩìÂ§ÑÂú®ÈùûÊ†πÊ®°Âºè‰∏ãÁöÑCPUËÆøÈóÆ‰∫Ü‰∏Ä‰∏™GVAÔºåMMUÂ∞ÜÈ¶ñÂÖàÊü•ËØ¢GPT„ÄÇgptrÂåÖÂê´ÂÆ¢Êà∑Êú∫È°µË°®ÁöÑËµ∑ÂßãÂú∞ÂùÄGPAÔºåËøô‰ºöËß¶ÂèëMMU‰∫§ÂèâÂú∞Êü•ËØ¢EPTÔºåÂ∞Ügptr‰∏≠ÂåÖÂê´ÁöÑGPAÁøªËØëÊàêHPAÔºå‰ªéËÄåËé∑ÂèñGPTÁöÑÁ¨¨‰∏ÄÁ∫ßË°®È°π„ÄÇÂêåÁêÜÔºå‰∏∫‰∫ÜËé∑ÂèñGPT‰∏≠ÊØè‰∏™Â±ÇÁ∫ßÁöÑÈ°µË°®È°πÔºåMMUÈÉΩ‰ºöÊü•ËØ¢EPT„ÄÇ</p>
<p>Âú®64‰ΩçÁöÑÁ≥ªÁªü‰∏≠ÔºåHypervisor‰ΩøÁî®GPAÁöÑ‰Ωé48‰ΩçÊü•ËØ¢EPTÈ°µË°®ÔºåËÄåEPTÈ°µË°®‰πü‰ΩøÁî®‰∫Ü <code>9+9+9+9</code> ÁöÑÂõõÁ∫ßÈ°µË°®ÁöÑÂΩ¢Âºè„ÄÇÂÅáËÆæGPT‰πüÊòØÂõõÁ∫ßÈ°µË°®ÔºåÈÇ£‰πàÈùûÊ†πÊ®°Âºè‰∏ãÁöÑCPU‰∏∫‰∫ÜËØªÂèñ‰∏Ä‰∏™GVAÂ§ÑÁöÑÊï∞ÊçÆÔºåÈúÄË¶ÅÈ¢ùÂ§ñËØªÂèñ24‰∏™È°µË°®È°πÔºàÂõæ‰∏≠Âä†Á≤óÈªëÊ°ÜÁöÑÁÅ∞Ëâ≤ÈïøÊñπÂΩ¢ÔºâÔºåÂõ†Ê≠§ÈúÄË¶ÅÈ¢ùÂ§ñÁöÑ24Ê¨°ÂÜÖÂ≠òËÆøÈóÆÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200854382.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120085448306"
	
	
></p>
<blockquote>
<p><strong>Âç≥‰ΩøMMU‰∏≠ÊúâTLBÁºìÂ≠òGVAÂà∞HPAÁöÑÊò†Â∞ÑÔºåTLB‰πüÊó†Ê≥ïË¶ÜÁõñË∂äÊù•Ë∂äÂ§ßÁöÑÂÆ¢Êà∑Êú∫ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÔºåÂèåÂ±ÇÈ°µË°®ÁöÑÊü•ËØ¢Â∞Ü‰ºöÈÄ†ÊàêÂ∑®Â§ßÁöÑÂºÄÈîÄ„ÄÇËÄåÂú®TLBÊú™ÂëΩ‰∏≠Êó∂Ôºå‰∏Ä‰∏™ÂõõÁ∫ßÂΩ±Â≠êÈ°µË°®‰ªÖÈúÄËÆøÈóÆ 4 Ê¨°ÂÜÖÂ≠òÂç≥ÂèØÂæóÂà∞HPAÔºåÁõ∏ÊØî‰∫éÂèåÂ±ÇÈ°µË°®ÊúâÂ∑®Â§ßÁöÑ‰ºòÂäø„ÄÇÊòØÂê¶ÂèØ‰ª•Â∞ÜÂΩ±Â≠êÈ°µË°®‰∏éÊâ©Â±ïÈ°µË°®Áõ∏ÁªìÂêàÂë¢Ôºü</strong></p>
</blockquote>
<h2 id="24-todo-Êâ©Â±ïÈ°µË°®‰∏éÂΩ±Â≠êÈ°µË°®ÁöÑÁªìÂêà-ÊïèÊç∑È°µË°®">2.4 //TODO Êâ©Â±ïÈ°µË°®‰∏éÂΩ±Â≠êÈ°µË°®ÁöÑÁªìÂêà: ÊïèÊç∑È°µË°®
</h2><p>Âú®Á≥ªÁªüËÆæËÆ°‰∏≠ÔºåÁªèÂ∏∏Â≠òÂú®ÁùÄÂêÑÁßçÂêÑÊ†∑ÁöÑÊäò‰∏≠‰∏éÊùÉË°°„ÄÇËôΩÁÑ∂ÂΩ±Â≠êÈ°µË°®ÂíåÂèåÂ±ÇÈ°µË°®ÔºàÂç≥x86‰∏≠ÁöÑÊâ©Â±ïÈ°µË°®ÔºâÂú®TLBÂëΩ‰∏≠Êó∂ÔºåÂùáÂèØ‰ª•‰ª•ÊúÄÂø´ÁöÑÊó∂Èó¥Ëé∑ÂæóGVAÂà∞HPAÁöÑÊò†Â∞ÑÔºå‰ΩÜÈÅ≠ÈÅá1Ê¨°TLBÊú™ÂëΩ‰∏≠Êó∂ÔºåÊü•ËØ¢ÂèåÂ±ÇÈ°µË°®ÈúÄË¶ÅËÆøÈóÆÂÜÖÂ≠òÁöÑÊ¨°Êï∞Â¢ûÈïøÂà∞‰∫Ü24/4=6ÂÄç„ÄÇÁÑ∂ËÄåÂΩ±Â≠êÈ°µË°®‰ºöÂºïËµ∑Â§ßÈáèÁöÑVM-ExitÔºåÂ∞§ÂÖ∂ÊòØÂú®È¢ëÁπÅÂàÜÈÖç„ÄÅÈáäÊîæËôöÊãüÂÜÖÂ≠òÁöÑÂÜÖÂ≠òÂØÜÈõÜÂûãÂú∫ÊôØ‰∏ãÔºåËøô‰ΩøÂæóÂΩ±Â≠êÈ°µË°®Âú®Áé∞Âú®ÁöÑËôöÊãüÂåñÁéØÂ¢É‰∏ãÂæàÂ∞ë‰ΩøÁî®„ÄÇÁî±‰∫éÂÜÖÂ≠òÂÆπÈáèÂø´ÈÄüÂ¢ûÂ§ß„ÄÅTLBÂÆπÈáèÂ¢ûÈïøÁºìÊÖ¢ÔºåTLB‰∏çÂëΩ‰∏≠ÁöÑÊ¨°Êï∞Ë∂äÊù•Ë∂äÂ§öÔºåÊü•ËØ¢ÂèåÂ±ÇÈ°µË°®ÈÄ†ÊàêÁöÑ6ÂÄçÂÜÖÂ≠òËÆøÈóÆ‰πüÈÄ†Êàê‰∫Ü‰∏çÂèØÂøΩËßÜÁöÑÂºÄÈîÄÔºåÂΩ±Â≠êÈ°µË°®Êúâ‰∏Ä‰∫õ‰ºòÂäø„ÄÇË°®3-1Â∞ÜÂΩ±Â≠êÈ°µË°®‰∏éÊâ©Â±ïÈ°µË°®ËøõË°å‰∫ÜÂØπÊØî„ÄÇ</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200855123.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120085528081"
	
	
></p>
<p>JayneelÁ≠â‰∫∫ËßÇÂØüÂà∞[ÊèíÂõæ]ÔºåÂú®2ÁßíÁöÑÈááÊ†∑Êó∂Èó¥ÂÜÖÔºå‰ªÖÊúâ1~5%ÁöÑÂú∞ÂùÄÁ©∫Èó¥Ë¢´È¢ëÁπÅ‰øÆÊîπÔºå‰∏îË¢´‰øÆÊîπÁöÑÂú∞ÂùÄÁ©∫Èó¥‰ºöÊØîÊú™‰øÆÊîπÁöÑÂú∞ÂùÄÁ©∫Èó¥‰øÆÊîπÂæóÊõ¥Âä†È¢ëÁπÅ„ÄÇ‰æãÂ¶ÇÔºå‰øùÂ≠ò‰ª£Á†ÅÁöÑÂú∞ÂùÄÁ©∫Èó¥ÊûÅÂ∞ëË¢´‰øÆÊîπ„ÄÅÂÜôÂÖ•ÔºåÁß∞‰∏∫ÈùôÊÄÅÂå∫ÔºõËÄåÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂ†ÜÊ†à‰ª•ÂèäÊò†Â∞ÑÊñá‰ª∂ÁöÑÈÉ®ÂàÜÂàôË¢´È¢ëÁπÅ‰øÆÊîπÔºåÁß∞‰∏∫Âä®ÊÄÅÂå∫„ÄÇËã•Áî®SPTÂÆåÊàêÈùôÊÄÅÂå∫ÁöÑÂú∞ÂùÄÁøªËØëÔºåÂàôËÉΩÂáèÂ∞èTLB‰∏çÂëΩ‰∏≠Êó∂ÁöÑÈ°µË°®Êü•ËØ¢ÂºÄÈîÄÔºõËÄåÁî®ÂèåÂ±ÇÈ°µË°®ÂÆåÊàêÂä®ÊÄÅÂå∫ÁöÑÂú∞ÂùÄÁøªËØëÔºåÂàôËÉΩÈÅøÂÖçGPTÈ¢ëÁπÅ‰øÆÊîπÈÄ†ÊàêÁöÑVM-Exit„ÄÇ‰∫éÊòØÔºåÁ†îÁ©∂‰∫∫Âëò‰∫é2016Âπ¥ÊèêÂá∫‰∫ÜÊïèÊç∑È°µË°®[ÊèíÂõæ]„ÄÇ‰ªñ‰ª¨ËÆæËÆ°‰∫Ü‰∏ÄÁßçÂΩ±Â≠êÈ°µË°®ÂíåÂèåÂ±ÇÈ°µË°®Ê∑∑Áî®ÁöÑÊú∫Âà∂ÔºåËøòÊúâ‰∏ÄÁßçÁ≠ñÁï•ÂÜ≥ÂÆö‰ΩïÊó∂Áî±ÂΩ±Â≠êÈ°µË°®ËΩ¨Êç¢Âà∞ÂèåÂ±ÇÈ°µË°®ÊàñÁî±ÂèåÂ±ÇÈ°µË°®ËΩ¨Êç¢Âà∞ÂΩ±Â≠êÈ°µË°®„ÄÇËøôÊòØ‰∏ÄÁßçÊú∫Âà∂‰∏éÁ≠ñÁï•ÁöÑÂàÜÁ¶ªÔºöÊú∫Âà∂ÊòØÂõ∫ÂÆöÁöÑÔºåËÄåÁ®ãÂ∫èÂëòÂèØ‰ª•ÁÅµÊ¥ª‰øÆÊîπÁ≠ñÁï•ÔºåÂÖ∑ÊúâÊõ¥Â•ΩÁöÑÁÅµÊ¥ªÊÄß„ÄÇÂõæ3-7Â±ïÁ§∫‰∫ÜÂΩ±Â≠êÈ°µË°®‰∏éÂèåÂ±ÇÈ°µË°®ÁöÑÊ∑∑Áî®Êú∫Âà∂„ÄÇ**‰∏∫‰∫ÜÂÆûÁé∞ÊïèÊç∑È°µË°®ÔºåÈúÄË¶ÅÁ°¨‰ª∂ÊîØÊåÅ‰ª•ÂèäËΩØ‰ª∂ÊîØÊåÅÔºå**‰∏ãÈù¢ÂàÜÂºÄ‰ªãÁªç„ÄÇ</p>
<blockquote>
<p><em><strong>Á°¨‰ª∂ÊîØÊåÅ</strong></em></p>
</blockquote>
<p>ÂÖà‰ªãÁªçÂΩ±Â≠êÈ°µË°®‰∏éÂèåÂ±ÇÈ°µË°®ÁöÑÊ∑∑Áî®Êú∫Âà∂ÔºåËøôÈÉ®ÂàÜÂäüËÉΩ‰∏ªË¶Å‰ΩøÁî®Á°¨‰ª∂ÂÆûÁé∞„ÄÇÈ¶ñÂÖàÔºåÂΩ±Â≠êÈ°µË°®ÈúÄË¶ÅÊèê‰æõËΩ¨Êç¢‰Ωç(Switching Bit)ÁöÑÊîØÊåÅ„ÄÇÂú®ÂΩ±Â≠êÈ°µË°®ÁöÑÈ°µË°®È°π‰∏≠Ôºå‰ªçÊúâ‰∏Ä‰∫õÊ†áÂøó‰ΩçË¢´Á°¨‰ª∂ÂøΩÁï•ÔºåÂèØ‰ª•ÊîæÁΩÆËΩ¨Êç¢‰Ωç„ÄÇÁ°¨‰ª∂Â¢ûÂä†‰∫ÜsptrÔºàShadow PointerÔºåÂΩ±Â≠êÊåáÈíàÔºâÂØÑÂ≠òÂô®ÔºåÁî®‰∫éÊîæÁΩÆÂΩ±Â≠êÈ°µË°®Âü∫Âú∞ÂùÄÔºõÂêåÊó∂‰øùÁïôÂéüÊúâÁöÑptrÂØÑÂ≠òÂô®ÔºàÊõ¥Âêç‰∏∫gptrÂØÑÂ≠òÂô®ÔºâÔºåÁî®‰∫éÊîæÁΩÆÂÆ¢Êà∑Êú∫È°µË°®Âü∫Âú∞ÂùÄÔºõhptrÊîæÁΩÆEPTÁöÑÂü∫Âú∞ÂùÄÔºåÁî®‰∫éÊü•ËØ¢EPT„ÄÇÂΩìÊü•ËØ¢SPTÊó∂ËØªÂà∞‰∏Ä‰∏™ËΩ¨Êç¢‰ΩçË¢´ÁΩÆ‰∏∫1ÁöÑÂΩ±Â≠êÈ°µË°®È°πÔºåÂàôMMUÂàáÊç¢Âà∞ÂèåÂ±ÇÈ°µË°®ÁöÑÂú∞ÂùÄÁøªËØëÊ®°ÂºèÁªßÁª≠‰∫§ÂèâÂú∞Êü•ËØ¢GPTÂíåEPT„ÄÇÂú®ÂàáÊç¢ÂâçÂêéÔºåMMU‰∏≠ÁöÑTLB‰ªçÁÑ∂‰øùÂ≠ò‰∫ÜGVAÂà∞HPAÁöÑÊò†Â∞ÑÔºåÊó†È°ªÂà∑Êñ∞TLB„ÄÇÂú®ËΩ¨Êç¢‰ΩçË¢´ÁΩÆ‰∏∫1ÁöÑÂΩ±Â≠êÈ°µË°®È°π‰∏≠ÔºåËÆ∞ÂΩï‰∫Ü‰∏ã‰∏ÄÁ∫ßGPTÈ°µË°®È°µÁöÑËµ∑ÂßãÂú∞ÂùÄ„ÄÇËØ•Âú∞ÂùÄ‰∏∫HPAÔºåËΩ¨Êç¢‰ΩçË¢´ÁΩÆ‰∏∫1Êó∂Áî±Á°¨‰ª∂ÂÜôÂÖ•„ÄÇÈÄöËøáËØ•HPAÂç≥ÂèØÊü•ËØ¢Âà∞‰∏ã‰∏ÄÁ∫ßGPTÁöÑÈ°µË°®È°πÔºå‰ΩøÂæóÈ°µË°®Êü•ËØ¢ËøáÁ®ãÁªßÁª≠ËøõË°å‰∏ãÂéª„ÄÇ</p>
<p>Âú®ÂΩ±Â≠êÈ°µË°®‰∏≠ÔºåÂèØ‰ª•Â∞Ü‰ªª‰Ωï‰∏ÄÁ∫ßÈ°µË°®È°πÁöÑËΩ¨Êç¢‰ΩçÁΩÆ‰∏∫1ÔºåÂ¶ÇÂõæ3-7(a)‰∏≠SPTÁöÑÁ¨¨‰∏âÁ∫ßÈ°µË°®È°πÁöÑËΩ¨Êç¢‰ΩçÁΩÆ‰∏∫1ÔºåÂõæ3-7(b)‰∏≠SPTÁöÑÁ¨¨‰∏âÁ∫ßÈ°µË°®È°πÁöÑËΩ¨Êç¢‰ΩçÁΩÆ‰∏∫1„ÄÇÂú®‰∏ãÂõæ(a)‰∏≠Êü•ËØ¢3Á∫ßÂΩ±Â≠êÈ°µË°®Ôºå‰ªÖÈ¢ùÂ§ñËØªÂèñ3+1+4=8Ê¨°È°µË°®È°πÔºàÂõæ‰∏≠ÁöÑÂä†Á≤óÈªëÊ°ÜÁÅ∞Ëâ≤ÈïøÊñπÂΩ¢ÔºâÔºõÂõæ(b)‰∏≠‰ªÖÈÅçÂéÜ2Á∫ßÂΩ±Â≠êÈ°µË°®Ôºå‰ΩÜË¶ÅÈ¢ùÂ§ñËØªÂèñ2+2+8=12Ê¨°È°µË°®È°π„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200856489.png" alt="image-20231120085603909" style="zoom: 50%;" />
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200857857.png" alt="image-20231120085722620" style="zoom: 50%;" />
<blockquote>
<p><em><strong>ËΩØ‰ª∂ÊîØÊåÅ</strong></em></p>
</blockquote>
<p>ËΩ¨Êç¢‰ΩçÊòØÂê¶ÁΩÆ1Áî±HypervisorÂÜ≥ÂÆöÔºåËøôÂ±û‰∫éÁ≠ñÁï•ËÆæËÆ°ÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑ„ÄÇÂΩìMMUËøõÂÖ•ÂèåÂ±ÇÈ°µË°®Êü•ËØ¢Ê®°ÂºèÂêéÔºåÂÖ∂ËØªÂèñÁöÑGPTË°®È°π‰∏çÂÜçË¢´Ê†áËÆ∞‰∏∫Âè™ËØªÔºåÂèØ‰ª•Ë¢´ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂÜôÂÖ•ËÄå‰∏çÂºïËµ∑VM-Exit„ÄÇ‰∏∫‰∫ÜÂà©Áî®Ëøô‰∏Ä‰ºòÂäøÔºåHypervisorÂÆûÁé∞‰∫Ü‰∏ÄÂ•óÁ≠ñÁï•Áª¥Êä§ËΩ¨Êç¢‰Ωç„ÄÇÂΩìÂÆ¢Êà∑Êú∫ËøõÁ®ãË¢´ÂàõÂª∫‰∏îË∞ÉÂ∫¶ËøêË°åÊó∂ÔºåMMUÂ§ÑÂú®ÂΩ±Â≠êÈ°µË°®Âú∞ÂùÄÁøªËØëÁöÑÁä∂ÊÄÅÔºåGPTË¢´Ê†áËÆ∞‰∏∫Âè™ËØª„ÄÇËã•‰∏Ä‰∏™SPTÈ°µË°®È°πË¢´‰øÆÊîπÔºåÂ∞ÜÂèëÁîüVM-ExitÔºåHypervisorËÆ∞ÂΩï1Ê¨°ÂØπËØ•SPTÈ°µË°®È°πÁöÑ‰øÆÊîπÂπ∂Êõ¥Êñ∞SPTÔºåËøîÂõûÂÆ¢Êà∑Êú∫„ÄÇÂΩìHypervisorËÆ∞ÂΩïÂà∞2Ê¨°ÂØπËØ•SPTÈ°µË°®È°πÁöÑ‰øÆÊîπÊó∂ÔºåÂàôÂ∞ÜËØ•SPTÈ°µË°®È°πÁöÑËΩ¨Êç¢‰ΩçÁΩÆ‰∏∫1ÔºåË°®ÊòéËØ•SPTÈ°µË°®È°πÁªèÂ∏∏Ë¢´‰øÆÊîπÔºåÈúÄË¶ÅÂàáÊç¢Âà∞ÂèåÂ±ÇÈ°µË°®Ê®°Âºè„ÄÇÂ¶ÇÂõæ3-7(a)ÊâÄÁ§∫ÔºåÂΩìÂÆ¢Êà∑Êú∫‰øÆÊîπ‰∫Ü‰∏§Ê¨°sPDEÔºàshadow Page Directory EntryÔºåÂΩ±Â≠êÈ°µÁõÆÂΩïÈ°πÔºâÊó∂ÔºåÂ∞ÜsPDEÁöÑËΩ¨Êç¢‰ΩçÁΩÆ‰∏∫1ÔºåÈÇ£‰πàÂØπ‰∫égPTEÔºàguest Page Table EntryÔºåÂÆ¢Êà∑Êú∫È°µË°®È°πÔºâÁöÑ‰øÆÊîπÂ∞Ü‰∏ç‰ºöÂºïËµ∑VM-ExitÔºå‰ª£‰ª∑Âè™ÊòØÁî±ËØªÂèñ4Ê¨°ÂÜÖÂ≠òÂ¢ûÂä†Âà∞ËØªÂèñ8Ê¨°„ÄÇ</p>
<p>ËøòÈúÄË¶Å‰∏ÄÂ•óÁ≠ñÁï•ÂÜ≥ÂÆöËΩ¨Êç¢‰ΩçÁΩÆ0„ÄÇÂΩìÂÆ¢Êà∑Êú∫È°µË°®ÂæàÂ∞ëË¢´‰øÆÊîπÊó∂ÔºåÂ¶ÇÊûúÂ∞ÜMMUÂú∞ÂùÄÁøªËØëÊ®°ÂºèÈÉ®ÂàÜÂàáÊç¢ÂõûSPTÁöÑÁøªËØëÊ®°ÂºèÔºåÂú®TLB‰∏çÂëΩ‰∏≠Êó∂ÂèØ‰ª•ÂáèÂ∞ëËØªÂèñÈ°µË°®È°πÁöÑÊ¨°Êï∞„ÄÇÁÑ∂ËÄåÔºåÂÅáËÆæÊ≠§Êó∂ÊúâÂØπGPTÂíåEPTÈ¢ëÁπÅÁöÑÂè™ËØªËÆøÈóÆÔºåÂÆ¢Êà∑Êú∫Â∞Ü‰∏çÈÄÄÂá∫HypervisorÔºåHypervisor‰πüÊó†Ê≥ïÂæóÁü•‰ΩïÊó∂Â∫îËØ•ÂàáÊç¢ÂõûÂΩ±Â≠êÈ°µË°®Ê®°Âºè„ÄÇ‰∏∫Ê≠§ÔºåÂâçÊñáÊâÄËø∞ÁöÑEPT A/D‰ΩçÁâπÊÄßÔºàËßÅIntel SDMÂç∑3Á¨¨28.2.4ËäÇÔºâÂ∫îËØ•Ë¢´ÂÖ≥Èó≠ÔºåÂõ†‰∏∫ÂΩìEPT A/D‰Ωç‰ΩøËÉΩÊó∂ÔºåÊâÄÊúâÂØπGPTÁöÑËÆøÈóÆÊó†ËÆ∫ËØª/ÂÜôÂùáËßÜ‰∏∫ÂÜôÔºàÊ≥®ÊÑèÔºåÈô§GPTÈ°µË°®È°µÁöÑÂè™ËØªËÆøÈóÆÂπ∂‰∏çË¢´ËßÜ‰∏∫ÂÜôÔºâÔºå‰∫éÊòØGPTÊâÄÂú®ÁöÑÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µÂØπÂ∫îÁöÑEPTË°®È°π‰∏≠ËÑè‰ΩçÔºàÂç≥D‰ΩçÔºâÂ∞ÜË¢´ÁΩÆ1„ÄÇÊ≠§Êó∂HypervisorÂèØ‰ª•ÈÄöËøáEPT‰∏≠ÁöÑËÑè‰ΩçËßÇÂØüÊòØÂê¶Â∫îËØ•ÂõûÂà∞SPTÊ®°Âºè„ÄÇÂú®‰∏Ä‰∏™Ê£ÄÊü•Âë®ÊúüÂºÄÂßãÊó∂ÔºåÂ∞ÜÊâÄÊúâGPTÂØπÂ∫îÁöÑEPTË°®È°πËÑè‰ΩçÁΩÆ0ÔºõÂú®Âë®ÊúüÁªìÊùüÊó∂ÔºåËã•ËÑè‰Ωç‰ªçÁÑ∂Ê≤°ÊúâÁΩÆ1ÔºåÂàôËßÜ‰∏∫GPT‰øÆÊîπ‰∏çÈ¢ëÁπÅÔºåÂØπÂ∫îÁöÑËΩ¨Êç¢‰ΩçÁΩÆ‰∏∫0ÔºåÂàáÊç¢ÂõûÂèåÂ±ÇÈ°µË°®ÁöÑÁøªËØëÊ®°Âºè„ÄÇ</p>
<hr>
<p>ÊïèÊç∑È°µË°®‰ªÖÊòØ‰∏Ä‰∏™ËÆæÊÉ≥ÔºåÊâÄÈúÄÁöÑÁ°¨‰ª∂ÊîØÊåÅÂ∞öÊú™ÂÆûÁé∞„ÄÇÁ†îÁ©∂ËÄÖÁî®‰ªøÁúüÂ∑•ÂÖ∑Ê®°Êãü‰∫ÜÊïèÊç∑È°µË°®ÁöÑËøêË°åÔºåÂπ∂ÊµãÂæóÁõ∏ÊØî‰∫éÂèåÂ±ÇÈ°µË°®Êõ¥‰ΩéÁöÑTLB‰∏çÂëΩ‰∏≠ÂºÄÈîÄÔºå‰ª•ÂèäÁõ∏ÊØî‰∫éÂΩ±Â≠êÈ°µË°®Êõ¥Â∞ëÁöÑVM-ExitÊ¨°Êï∞„ÄÇÁÑ∂ËÄåÔºåÊïèÊç∑È°µË°®ÂØπËøõÁ®ãÂàáÊç¢‰∏çÂèãÂ•ΩÔºåÁî±‰∫éÊïèÊç∑È°µË°®ÁöÑ‰∏ÄÁ∫ßÈ°µË°®‰ΩøÁî®‰∫ÜÂΩ±Â≠êÈ°µË°®ÁöÑÈ°µË°®È°µÔºåÂú®ÂàáÊç¢sptrÊó∂‰ºöÂºïËµ∑VM-ExitÔºå‰ΩÜÊúâÁõ∏Â∫îÁöÑÁ°¨‰ª∂‰ºòÂåñÔºåËØ¶ËßÅÂèÇËÄÉÊñáÁåÆ[ÊèíÂõæ]„ÄÇ</p>
<h2 id="25-todo-ÂÜÖÂ≠òÁöÑÂçäËôöÊãüÂåñ-Áõ¥Êé•È°µË°®Êò†Â∞Ñ‰∏éÂÜÖÂ≠òÊ∞îÁêÉ">2.5 //TODO ÂÜÖÂ≠òÁöÑÂçäËôöÊãüÂåñ: Áõ¥Êé•È°µË°®Êò†Â∞Ñ‰∏éÂÜÖÂ≠òÊ∞îÁêÉ
</h2><p>‰∏äÊñáÊâÄËø∞ÁöÑÂÜÖÂ≠òËôöÊãüÂåñÂÆûÁé∞ÂùáÂü∫‰∫é‰∏Ä‰∏™ÂâçÊèêÔºöÂÆ¢Êà∑Êú∫Êó†‰ªéÂæóÁü•Ëá™Â∑±‰ΩøÁî®ÁöÑÊòØ‚ÄúËôöÊãü‚ÄùÁöÑÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÂ¶ÇÊûúÂÆ¢Êà∑Êú∫Áü•ÈÅìËá™Â∑±ËøêË°åÂú®‚ÄúËôöÊãü‚ÄùÁöÑÂÜÖÂ≠òÁ°¨‰ª∂‰∏äÔºåÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞ÊòØÂê¶‰ºöÊõ¥ÁÆÄÂçïÔºüÂÜÖÂ≠òËôöÊãüÂåñÂÆûÁé∞ÁöÑÊÄßËÉΩÊòØÂê¶Êõ¥È´òÔºüÊú¨ËäÇ‰ªãÁªç‰∏§‰∏™‰∏éÂÜÖÂ≠òÂçäËôöÊãüÂåñÁöÑÁõ∏ÂÖ≥ÊäÄÊúØ„ÄÇ</p>
<blockquote>
<p><em><strong>Áõ¥Êé•È°µË°®Êò†Â∞Ñ</strong></em></p>
</blockquote>
<p>ÂçäËôöÊãüÂåñÂèØ‰ª•ÈÄöËøáÂëäÁü•ÂÆ¢Êà∑Êú∫ËøêË°åÂú®ËôöÊãüÁéØÂ¢É‰∏ãÔºåËÆ©ÂÆ¢Êà∑Êú∫ÂçèÂêåHypervisorÂÆåÊàêËôöÊãüÂåñ‰ªªÂä°Ôºå‰ªéËÄåÂèØ‰ª•‰ΩøHypervisorÈúÄË¶ÅÂÆåÊàêÁöÑÂ∑•‰ΩúÊõ¥Â∞ëÔºåHypervisorÁöÑÂÆûÁé∞Êõ¥‰∏∫ÁÆÄÂçï„ÄÇÂ∞ÜÂçäËôöÊãüÂåñÁöÑÊÄùÊÉ≥Â∫îÁî®Âú®ÂÜÖÂ≠òËôöÊãüÂåñ‰∏äÔºåÂàôHypervisorÊúâËÉΩÂäõÂëäÁü•ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÔºöÂ∞ÜÈ°µË°®Áª¥Êä§ÊàêËÉΩÂ§üÁõ¥Êé•ÂÆâË£ÖÂà∞ÁúüÂÆûÁ°¨‰ª∂MMUÁöÑÁâàÊú¨ÔºåHypervisorÂ∞Ü‰∏çÂØπÂÆ¢Êà∑Êú∫È°µË°®ËøõË°å‰ªª‰Ωï‰øÆÊîπ„ÄÇGPT‰∏≠Â∞Ü‰øùÂ≠òGVAÂà∞HPAÁöÑÊò†Â∞ÑÔºåËÄåHypervisorÈúÄË¶ÅÂÅöÁöÑ‰ªÖ‰ªÖÊòØÂëäÁü•ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÂèØ‰ª•‰ΩøÁî®ÁöÑÁúüÂÆûÁâ©ÁêÜÂÜÖÂ≠òËåÉÂõ¥„ÄÇËøôÊ†∑ÔºåÂè™ÈúÄË¶ÅÂ¢ûÂä†ÂÆ¢Êà∑Êú∫Êìç‰ΩúÁ≥ªÁªüÁöÑ‰∏Ä‰∫õÂ§çÊùÇÊÄßÔºåÂ∞±‰∏çÈúÄË¶ÅÈôç‰ΩéÂÆ¢Êà∑Êú∫ËøêË°åÊÄßËÉΩÁöÑÂΩ±Â≠êÈ°µË°®Ôºå‰πü‰∏çÈúÄË¶ÅÂ§çÊùÇÁöÑEPTÁ°¨‰ª∂Êâ©Â±ïÔºåÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂõ∞ÈöæÂáèÂ∞èÔºåÊÄßËÉΩ‰πüÂæóÂà∞ÊèêÈ´ò„ÄÇËøôÁßçÂÜÖÂ≠òËôöÊãüÂåñÁöÑÂÆûÁé∞ÊñπÂºèÁß∞‰ΩúÁõ¥Êé•È°µË°®Êò†Â∞Ñ„ÄÇ</p>
<p>ÁÑ∂ËÄåÔºåÁî±‰∫éÈ°µË°®‰∏≠ÁöÑÊò†Â∞ÑÂØπ‰∫éÂÆ¢Êà∑Êú∫‰πãÈó¥ÁöÑÈöîÁ¶ªÊÄß„ÄÅÁ≥ªÁªüÂÆâÂÖ®Á≠âËá≥ÂÖ≥ÈáçË¶ÅÔºåÂÆ¢Êà∑Êú∫ÂØπÈ°µË°®‰∏çÂèØÈöè‰æøÊõ¥Êîπ„ÄÇÂú®ÂÆ¢Êà∑Êú∫Êõ¥ÊîπÈ°µË°®Êó∂ÔºåÂè™ËÉΩË∞ÉÁî®HypervisorÊèê‰æõÁöÑË∂ÖÁ∫ßË∞ÉÁî®ÔºåÁî±HypervisorÊ£ÄÊü•ÂÆ¢Êà∑Êú∫Êò†Â∞ÑÁöÑÂÜÖÂ≠òËåÉÂõ¥ÊòØÂê¶ÂêàÊ≥ïÔºåÊâçËÉΩËøîÂõûÂÆ¢Êà∑Êú∫ÁªßÁª≠ÊâßË°å„ÄÇÁõ∏ÊØî‰∫éÂΩ±Â≠êÈ°µË°®ÔºåHypervisorÈúÄË¶ÅÂÆåÊàêÂ§çÊùÇÁöÑGPTÂà∞SPTÁöÑÁøªËØëÔºåÁõ¥Êé•Êò†Â∞ÑÂ§ßÂ§ßÂáèËΩª‰∫ÜHypervisorÁöÑË¥üÊãÖ„ÄÇ‰∏∫‰∫ÜÂáèÂ∞èÂ§öÊ¨°ÈùûÊ†πÊ®°Âºè‰∏éÊ†πÊ®°ÂºèÂàáÊç¢Â∏¶Êù•ÁöÑÂºÄÈîÄÔºåÂÆ¢Êà∑Êú∫ÂèØ‰ª•ÈÄâÊã©Â∞ÜÂ§öÊ¨°ÂØπGPTÁöÑÊõ¥ÊîπÁªÑÂêàËµ∑Êù•ÔºåÂêàÂπ∂Êàê‰∏ÄÊ¨°Ë∂ÖÁ∫ßË∞ÉÁî®ËøõÂÖ•HypervisorÔºå‰ªéËÄåÂ∞ÜÂ§öÊ¨°CPUÊ®°ÂºèÂàáÊç¢ÊõøÊç¢‰∏∫1Ê¨°Ê®°ÂºèÂàáÊç¢„ÄÇËôΩÁÑ∂HypervisorËøõË°å‰∫ÜGPT‰øÆÊîπÁöÑÂêàÊ≥ïÊÄßÊ£ÄÊü•Ôºå‰ΩÜÁî±‰∫éÂÆ¢Êà∑Êú∫ÊòéÁ°ÆÂú∞Áü•ÈÅìÁúüÂÆûÁâ©ÁêÜÁ°¨‰ª∂ÁöÑÁâ©ÁêÜÂú∞ÂùÄ(HPA)Ôºå‰ªçÁÑ∂ÂèØ‰ª•Âà©Áî®HPAÂèëËµ∑Ë°åÈî§(Rowhammer)ÊîªÂáª„ÄÇËØ•ÊîªÂáªÂÖ∑‰ΩìÂéüÁêÜÂ¶Ç‰∏ãÔºöÁî±‰∫éDRAM‰∏çÊñ≠ÂèëÂ±ïÔºåÂéÇÂïÜÂ∞ÜDRAMÁöÑÂçïÂÖÉÂÅöÂæóË∂äÊù•Ë∂äËøëÔºåËÄåÁõ∏ÈÇªÂçïÂÖÉÁöÑÁõ∏‰∫íÂΩ±Âìç‰πüË∂äÊù•Ë∂äÂ§ßÔºå‰∏çÊñ≠ËÆøÈóÆÊüê‰∏™Âú∞ÂùÄÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåÂç≥ÂèØÈÄ†ÊàêÁõ∏ÈÇª‰ΩçÁΩÆÂÜÖÂ≠ò‰ΩçÁöÑÁøªËΩ¨„ÄÇËã•ÂÆ¢Êà∑Êú∫ÂæóÁü•‰∫ÜÁúüÂÆûÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÔºåÂàôÂèØ‰ª•ÂØπ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑÁõ∏ÈÇªÁâ©ÁêÜÂÜÖÂ≠òÂèëËµ∑Ë°åÈî§ÊîªÂáª„ÄÇ</p>
<blockquote>
<p><em><strong>ÂÜÖÂ≠òÊ∞îÁêÉ</strong></em></p>
</blockquote>
<p>Ê†πÊçÆÂØπSPTÂéüÁêÜÁöÑ‰ªãÁªçÔºåÂÆ¢Êà∑Êú∫ÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÁöÑÂêéÂè∞ÂÆûÁé∞ÂÖ∂ÂÆûÊòØÂÆø‰∏ªÊú∫ËøõÁ®ãÁöÑËôöÊãüÂÜÖÂ≠òÔºåÂèØ‰ª•‰ΩøÁî®ÂÆø‰∏ªÊú∫ËôöÊãüÂÜÖÂ≠òÁöÑÂäüËÉΩÁÆ°ÁêÜÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠ò„ÄÇ‰æãÂ¶ÇÔºå‰∏∫‰∫ÜÂÆûÁé∞ÂÜÖÂ≠òË∂ÖÂîÆÔºåÁªôÊâÄÊúâÂÆ¢Êà∑Êú∫ÂàÜÈÖçÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊÄªÈáèÂèØ‰ª•Â§ß‰∫éÁâ©ÁêÜÁ°¨‰ª∂ÁöÑÂÜÖÂ≠òÂÆπÈáè„ÄÇÁî±‰∫éÊäΩË±°Â±ÇËøô‰∏ÄÊ¶ÇÂøµÁöÑÂ≠òÂú®ÔºåÁ≥ªÁªüËΩØ‰ª∂ÁöÑËÆæËÆ°ËÄÖÂèØ‰ª•ÁÅµÊ¥ªÊõ¥Êîπ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÁöÑÂêéÂè∞ÂÆûÁé∞ÔºåÂ∞Ü‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÂØπÂ∫îÁöÑÂÆø‰∏ªÊú∫ËôöÊãüÂÜÖÂ≠òÊç¢Âá∫Âà∞Á£ÅÁõòÔºåÊàñÊò†Â∞ÑÂà∞Âêå‰∏ÄÂùóÂÆø‰∏ªÊú∫Áâ©ÁêÜÂÜÖÂ≠òÔºå‰ªéËÄåÂáèÂ∞èÂÆø‰∏ªÊú∫Áâ©ÁêÜÂÜÖÂ≠òÁöÑÂéãÂäõ„ÄÇÁÑ∂ËÄåÔºåHypervisorÂú®ÂÜ≥ÂÆöÊç¢Âá∫Âì™Âùó‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÊó∂ÔºåÊó†Ê≥ïÁ≤æÁ°ÆÂú∞ÂæóÁü•Âì™‰∫õÈÉ®ÂàÜÂú®Êú™Êù•‰∏ÄÊÆµÊó∂Èó¥ÂÜÖ‰∏ç‰ºöË¢´ÂÆ¢Êà∑Êú∫‰ΩøÁî®„ÄÇÂç≥‰ΩøÂºÄÂêØ‰∫ÜEPTÁöÑA/D‰ΩçÔºåHypervisor‰πü‰ªÖ‰ªÖËÉΩÂ§üÂæóÁü•Âú®ËøáÂéª‰∏ÄÊÆµÊó∂Èó¥ÂÜÖÔºåÂÆ¢Êà∑Êú∫ËÆøÈóÆ‰∫ÜÂì™‰∫õÈ°µ„ÄÅÈïøÊó∂Èó¥Êú™ËÆøÈóÆÂì™‰∫õÈ°µÔºåËÄåÊó†Ê≥ïÂæóÁü•Ëøô‰∫õÈ°µ‰πãÈó¥ÁöÑÂÖ≥ËÅî‰∏éÊÑè‰πâÔºåÂç≥ÊâÄË∞ìÁöÑËØ≠‰πâÈ∏øÊ≤ü„ÄÇËøô‰ºöÂØºËá¥‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÊç¢Âá∫ÁöÑÂ§™Â§öÊàñÂ§™Â∞ëÔºö‚ÄúÂ§™Â§ö‚Äù‰ºö‰ΩøÂÆ¢Êà∑Êú∫‰∏çÊñ≠Á≠âÂæÖ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠ò‰ªéÁ£ÅÁõòÊç¢ÂÖ•ÂÜÖÂ≠òÔºåÈôç‰ΩéÂÆ¢Êà∑Êú∫ÊÄßËÉΩÔºõËÄå‚ÄúÂ§™Â∞ë‚ÄùÂàô‰ΩøHypervisorÊ≤°ÊúâÈáäÊîæÈÇ£‰∫õÂÆåÂÖ®ÂèØ‰ª•Ë¢´Á´ãÂç≥ÈáäÊîæÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÔºåÈÄ†ÊàêÁ≥ªÁªüÂÜÖÂ≠òËµÑÊ∫êÁöÑÊµ™Ë¥π„ÄÇ</p>
<p>HypervisorÊó†Ê≥ïÂÆûÁé∞È´òÊïàÁöÑÂÆ¢Êà∑Êú∫ÂÜÖÂ≠òÊç¢Âá∫Á≠ñÁï•ÁöÑÂéüÂõ†ÊòØÔºöHypervisorÊó†Ê≥ïÂæóÁü•ÂÆ¢Êà∑Êú∫ÂÜÖÈÉ®ÂèëÁîü‰∫Ü‰ªÄ‰πà„ÄÇËÄåÂçäËôöÊãüÂåñÂèØ‰ª•ÂæàÂ•ΩÂú∞Ëß£ÂÜ≥ËØ•ÈóÆÈ¢òÔºåÂèØ‰ª•‰ΩøÂÆ¢Êà∑Êú∫ÂíåHypervisorÊõ¥Â•ΩÂú∞Ê≤üÈÄö„ÄÇÂÜÖÂ≠òÊ∞îÁêÉÂà©Áî®‰∫ÜÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Êèê‰æõÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖçÂáΩÊï∞ÔºåÊù•ÂÆûÁé∞ÂÆ¢Êà∑Êú∫ÂÜÖÂ≠òÁöÑÈ´òÊïàÈáäÊîæ„ÄÇÂÖ∂‰∏ªË¶ÅÂ∑•‰ΩúÊµÅÁ®ãÊòØÔºåHypervisorË∞ÉÁî®ÂÆ¢Êà∑Êú∫Êèê‰æõÁöÑÂÜÖÂ≠òÈáäÊîæÊé•Âè£ÔºåËØ∑Ê±ÇÂÆ¢Êà∑Êú∫ÈáäÊîæÂÖ∂Âç†Áî®ÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÂÆ¢Êà∑Êú∫Êî∂Âà∞ËØ•ËØ∑Ê±ÇÂêéÔºåË∞ÉÁî®ÂÖ∂ÂÜÖÊ†∏Êèê‰æõÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖçÂáΩÊï∞ÔºàÂ¶ÇLinuxÂÜÖÊ†∏‰∏≠ÁöÑalloc_pagesÂáΩÊï∞ÔºâÔºåÂπ∂ÊääÂàÜÈÖçÂ•ΩÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òËåÉÂõ¥ËøîÂõûÁªôHypervisor„ÄÇHypervisorÂèØ‰ª•Â∞ÜËØ•‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÂØπÂ∫îÁöÑËôöÊãüÂÜÖÂ≠òÈáäÊîæÔºåÂáèËΩªÁ≥ªÁªüÂÜÖÂ≠òÂéãÂäõ„ÄÇÁî±‰∫éÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖçÂáΩÊï∞‰ºö‚ÄúËá™Âä®‚ÄùÊâæÂá∫Êú™Ë¢´‰ΩøÁî®ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåÂõ†Ê≠§ËøôÁßçÊñπÂºèÂæàÁÆÄÊòìÂú∞ÊâæÂá∫‰∫ÜÂÆ¢Êà∑Êú∫‰∏≠‰∏çË¢´‰ΩøÁî®ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºåÂ§ßÂ§ßÁÆÄÂåñ‰∫ÜÂÜÖÂ≠òÊ∞îÁêÉÁöÑÂÆûÁé∞„ÄÇ</p>
<h1 id="3-qemukvmÂàÜÊûê">3 QEMU/KVMÂàÜÊûê
</h1><p>Êú¨ËäÇÂ∞ÜÊ∑±ÂÖ•ÂàÜÊûêQEMU/KVMÂÜÖÂ≠òËôöÊãüÂåñÁõ∏ÂÖ≥‰ª£Á†ÅÔºåÂÖ∂‰∏≠Ôºö</p>
<blockquote>
<p><strong>KVM‰ª£Á†ÅÊù•Ëá™LinuxÂÜÖÊ†∏v4.19ÔºåQEMU‰ª£Á†ÅÁâàÊú¨‰∏∫4.1.1„ÄÇ</strong></p>
</blockquote>
<p>ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÊ†∏ÂøÉÊòØ‰ΩøÁî®ËôöÊãüÂÜÖÂ≠ò‰ª£ÊõøÁâ©ÁêÜÂÜÖÂ≠òÊù°Ôºå‰Ωú‰∏∫ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÂÆûÁé∞ ‚ÄúÂêéÂè∞‚ÄùÔºå‰ªéËÄåÁªôÂÆ¢Êà∑Êú∫Êèê‰æõ‰ªé0ÂºÄÂßã‰∏îËøûÁª≠ÁöÑ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠ò„ÄÇÂÆ¢Êà∑Êú∫ËÆøÂ≠òÊåá‰ª§Êèê‰æõÁöÑÂú∞ÂùÄÊòØGVAÔºåË¢´ÂÆø‰∏ªÊú∫MMUÁøªËØëÊàêHPAÔºåÂÜçÂèëÈÄÅÂà∞Áâ©ÁêÜÂÜÖÂ≠ò‰∏äËØªÂèñ/ÂÜôÂÖ•Êï∞ÊçÆ„ÄÇHypervisorÂíåÊìç‰ΩúÁ≥ªÁªüÁª¥Êä§È°µË°®ÔºåÂ∞ÜÈ°µË°®Ë£ÖËΩΩÂà∞MMU‰∏≠Ôºå‰∏éMMUÁ°¨‰ª∂ÂçèÂêåÂÆåÊàêÂÜÖÂ≠òËôöÊãüÂåñ„ÄÇ</p>
<p>ÂØπÂ∫îÂà∞ÂπøÊ≥õ‰ΩøÁî®ÁöÑType II Hypervisor QEMU/KVM‰∏≠Ôºå‰∏§ËÄÖÁöÑËÅåËÉΩÂàÜÂà´ÊòØ:</p>
<ul>
<li>QEMUË¥üË¥£Âú®ÂÆø‰∏ªÊú∫Áî®Êà∑ÊÄÅÂàÜÈÖçËôöÊãüÂÜÖÂ≠òÔºå‰Ωú‰∏∫ÂÆ¢Êà∑Êú∫ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÁöÑÂêéÂè∞ÂÆûÁé∞ÔºåÂç≥ÂÆåÊàêÊâÄÊúâÁâ©ÁêÜÂÜÖÂ≠òÁ°¨‰ª∂ÁöÑÂäüËÉΩÔºõ</li>
<li>ËÄåKVMË¥üË¥£Âú®ÂÜÖÊ†∏ÊÄÅÁª¥Êä§GVAÂà∞HPAÁöÑÊò†Â∞ÑÔºåÂç≥Áª¥Êä§È°µË°®ÔºåÂπ∂Â∞ÜÈ°µË°®Ë£ÖËΩΩÂà∞MMU‰∏≠ÂÆåÊàêËΩØÁ°¨‰ª∂ÁöÑÈÖçÂêà„ÄÇ</li>
</ul>
<p>ËøôÂ±û‰∫é‰∏ÄÁßçÁ≠ñÁï•ÂíåÊú∫Âà∂ÁöÑÂàÜÁ¶ªÔºåÂÖ∂‰∏≠KVMÊèê‰æõ‰∫ÜÂú∞ÂùÄÁøªËØëÊú∫Âà∂ÔºåËÄåQEMUÂÜ≥ÂÆöÂ¶Ç‰ΩïÂà©Áî®KVMÁöÑÂú∞ÂùÄÁøªËØëÊú∫Âà∂ÂÆåÊàêÂÜÖÂ≠òËôöÊãüÂåñÔºåÂÆûÁé∞‰∏ÄÂ•óÂäüËÉΩÂÆåÊï¥ÁöÑÂÜÖÂ≠òËôöÊãüÂåñÁ≠ñÁï•„ÄÇËøôÁßçÂàÜÁ¶ªÁöÑÂ•ΩÂ§ÑÂú®‰∫éÔºåHypervisorÁöÑÁºñÂÜôËÄÖÂèØ‰ª•ÁÅµÊ¥ªÂú∞ÂèòÊõ¥Á≠ñÁï•ÁöÑÂÆûÁé∞ÔºåËÄåÊú∫Âà∂Êó†È°ª‰øÆÊîπ„ÄÇ‰∏ãÈù¢ÂàÜÂà´ÂØπQEMUÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊ®°ÊãüÂíåKVMÁöÑÈ°µË°®Áª¥Êä§ËøõË°åÂàÜÊûê„ÄÇ</p>
<h2 id="31-qemuÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ">3.1 QEMUÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ
</h2><p>‰∏∫‰∫ÜÊ≠£Á°ÆÂú∞ËøêË°åÂÆ¢Êà∑Êú∫Ôºå**QEMUÈúÄË¶ÅÊ®°ÊãüÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊâÄÊúâÂäüËÉΩÔºå**ÂåÖÊã¨Ôºö</p>
<ol>
<li>QEMU‰Ωú‰∏∫ÂÆø‰∏ªÊú∫‰∏äÁöÑÁî®Êà∑ÊÄÅËøõÁ®ãÔºåÂú®ÂÆø‰∏ªÊú∫‰∏ä<strong>ÂàÜÈÖç‰∏ÄÊÆµËôöÊãüÂÜÖÂ≠òÊèê‰æõÁªôÂÆ¢Êà∑Êú∫</strong>‰Ωú‰∏∫ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠ò‰ΩøÁî®Ôºõ</li>
<li>QEMUÈúÄË¶Å**Ê®°ÊãüÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥‰∏≠Â§ñÂõ¥ËÆæÂ§áÂØπÂ∫îÁöÑMMIOÈÉ®ÂàÜÔºå**ÈÄöËøáÊà™Ëé∑ÂØπËØ•ÂÜÖÂ≠òÂå∫ÂüüÁöÑËÆøÈóÆÔºåÂÆåÊàêÂØπËÆæÂ§áÂäüËÉΩÁöÑÊ®°ÊãüÔºå‰ΩøÂæóÂÆ¢Êà∑Êú∫ÂÉèÂú®ÁúüÂÆûÁéØÂ¢É‰∏≠‰∏ÄÊ†∑ÂÆåÊàêMMIO„ÄÇ</li>
</ol>
<h3 id="ËôöÊãüÁâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖç">&ldquo;ËôöÊãü&quot;Áâ©ÁêÜÂÜÖÂ≠òÂàÜÈÖç
</h3><blockquote>
<p>Êú¨ËäÇ‰ªéËß£ÂÜ≥Á¨¨‰∏Ä‰∏™ÈóÆÈ¢òÂºÄÂßãÔºåÂç≥Ôºö<em><strong>QEMUËøõÁ®ãÂ¶Ç‰ΩïÂàÜÈÖçËôöÊãüÂÜÖÂ≠ò‰Ωú‰∏∫ÂÆ¢Êà∑Êú∫ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºü</strong></em></p>
</blockquote>
<p>ÁÜüÊÇâCËØ≠Ë®ÄÊ†áÂáÜÂ∫ìÁöÑËØªËÄÖÁü•ÈÅìÔºåË¶ÅÂàÜÈÖç‰∏ÄÊÆµÂ§ßÂ∞è‰∏çÂõ∫ÂÆöÁöÑËôöÊãüÂÜÖÂ≠òÔºåÂ∫îËØ•Ë∞ÉÁî® <code>malloc</code> ÂáΩÊï∞„ÄÇÁ≥ªÁªüÈ¶ñÂÖàÂàÜÈÖçË∂≥Â§üÁöÑÂ†ÜÂÜÖÂ≠òÁªô <code>malloc</code> ÂáΩÊï∞‰ΩøÁî®ÔºåÂΩìÂàÜÈÖçÁöÑÂ†ÜÂÜÖÂ≠òÁî®ÂÆåÊó∂Ôºå<code>malloc</code> ÂáΩÊï∞Ë∞ÉÁî® <code>brk</code> ÂáΩÊï∞‰øÆÊîπÂÜÖÊ†∏‰∏≠ÁöÑbrkÊåáÈíàÔºåÂ¢ûÂ§ßÂàÜÈÖçÁöÑÂ†ÜÂÜÖÂ≠ò„ÄÇÂ¶ÇÊûú <code>malloc</code> ÂáΩÊï∞ËØ∑Ê±ÇÁöÑÂÜÖÂ≠òÂ§ßÂ∞èË∂ÖËøá128KBÔºåÂàô‰ºöË∞ÉÁî® <code>mmap</code> Á≥ªÁªüË∞ÉÁî®Âú®ËôöÊãüÂÜÖÂ≠òÁöÑÂÜÖÂ≠òÊò†Â∞ÑÂå∫ËÄåÈùûÂ†Ü‰∏äÂàÜÈÖçÂÜÖÂ≠ò„ÄÇ</p>
<p>Áî±‰∫éQEMUÈúÄË¶ÅÁªôÂÆ¢Êà∑Êú∫ÂàÜÈÖçËæÉÂ§ßÂùóÁöÑËôöÊãüÂÜÖÂ≠ò‰Ωú‰∏∫ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÔºåÊïÖQEMUÈÄâÊã©‰ΩøÁî® <code>mmap</code> ÂáΩÊï∞„ÄÇ<code>mmap</code> ÂáΩÊï∞Âª∫Á´ãÁöÑËôöÊãüÂÜÖÂ≠òÊò†Â∞ÑÊ†πÊçÆÂàÜÈÖçÁöÑËôöÊãüÂÜÖÂ≠òÊòØÂê¶ÂÖ≥ËÅîÂà∞Á£ÅÁõòÊñá‰ª∂ÂàÜ‰∏∫Êñá‰ª∂Êò†Â∞ÑÂíåÂåøÂêçÊò†Â∞ÑÔºåÊ≠§Â§ÑÂè™ÂÖ≥Ê≥®ÂåøÂêçÊò†Â∞Ñ„ÄÇ**RAMBlockÊñπ‰æø‰∫ÜÂÆø‰∏ªÊú∫ËôöÊãüÂÜÖÂ≠òÁöÑÁÆ°ÁêÜÔºå**ÁÆÄÁß∞RBÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ã:</p>
<p>qemu-4.1.1/include/exec/ram_addr.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200900262.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120085951191"
	
	
></p>
<ul>
<li>hostÊåáÈíà‰øùÂ≠ò‰∫Ü <code>mmap</code> ÂáΩÊï∞ËøîÂõûÁöÑÂÆø‰∏ªÊú∫ËôöÊãüÂú∞ÂùÄ</li>
<li>max_length‰øùÂ≠ò‰∫Ü <code>mmap</code> ÂáΩÊï∞Áî≥ËØ∑ÁöÑËôöÊãüÂÜÖÂ≠òÂ§ßÂ∞è</li>
<li>idstr‰øùÂ≠ò‰∫ÜËØ•RBÁöÑÂêçÁß∞</li>
<li>mr‰øùÂ≠ò‰∫ÜÂÖ∂ÊâÄÂ±ûÁöÑMemoryRegion</li>
<li>nextÊåáÂêëËØ•RBÂú®ÂÖ®Â±ÄÂèòÈáèram_list‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™RB</li>
<li>ram_addr_tÁ±ªÂûã‰ª£Ë°®‰∫ÜÊâÄÊúâÂÜÖÂ≠òÊù°ÁªÑÊàêÁöÑGPAÁ©∫Èó¥</li>
</ul>
<p><code>ram_list.blocks</code> Â∞ÜÊâÄÊúâ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÂùóRBÁªÑÁªáÂú®‰∏ÄËµ∑ÔºåÊ†πÊçÆmax_length‰ªéÂ§ßÂà∞Â∞èÊéíÂàóÔºåRAMBlockÁªÑÁªáÁªìÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200901672.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090106626"
	
	
></p>
<p>ÂÖ∂‰∏≠ÔºåoffsetÊòØÂú®ram_addr_tÂú∞ÂùÄÁ©∫Èó¥‰∏≠ÁöÑÂÅèÁßªÔºåused_lengthÊòØÂΩìÂâç‰ΩøÁî®ÁöÑÈïøÂ∫¶ÔºåÂç≥ÂåÖÂê´ÊúâÊïàÊï∞ÊçÆÁöÑÈïøÂ∫¶Ôºåmax_lengthÊòØ <code>mmap</code> ÂáΩÊï∞ÂàÜÈÖçÁöÑÈïøÂ∫¶ÔºåÂç≥ÊúÄÂ§ßÂèØ‰ª•‰ΩøÁî®ÁöÑÈïøÂ∫¶„ÄÇÂíå <code>mmap</code> ÂáΩÊï∞ÁöÑÊò†Â∞ÑÁ±ªÂûãÁõ∏ÂêåÔºåRB‰πüÂàÜ‰∏∫ÂåøÂêçÊñá‰ª∂ÂØπÂ∫îÁöÑÁ±ªÂûãÔºàÂÖ∂fd‰∏∫-1Ôºâ‰ª•ÂèäÁ£ÅÁõòÊñá‰ª∂ÂØπÂ∫îÁöÑÁ±ªÂûãÔºàÂ¶ÇÊûú‰ΩøÁî®QEMUÁöÑ-mem-pathÈÄâÈ°π)„ÄÇ<code>qemu_ram_alloc_*</code> ÂáΩÊï∞ÊóèË¥üË¥£ÂàÜÈÖçÊñ∞ÁöÑRBÔºåÂÆÉ‰ª¨ÊúÄÁªàÈÉΩË∞ÉÁî® <code>ram_block_add</code> ÂáΩÊï∞Â°´ÂÖÖRBÊï∞ÊçÆÁªìÊûÑÔºå‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p>qemu-4.1.1/exec.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200901847.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090136799"
	
	
></p>
<p>ÂèÇÊï∞ <code>new_block</code> Ë°®Á§∫ÂæÖÂ°´ÂÖÖÁöÑRBÔºåÊµÅÁ®ãÂ¶Ç‰∏ã:</p>
<ol>
<li>È¶ñÂÖàË∞ÉÁî® <code>find_ram_offset</code> Âú®ÂÖ®Â±Äram_list.blocks‰∏≠Êü•ÊâæËÉΩÂ§üÂÆπÁ∫≥‰∏ãmax_lengthÂ§ßÂ∞èRBÁöÑ‰ΩçÁΩÆÔºåÂπ∂Â∞ÜËØ•‰ΩçÁΩÆÂ°´ÂÖ•RBÁöÑoffset‰∏≠;</li>
<li>ÁÑ∂ÂêéË∞ÉÁî® <code>phys_mem_alloc</code> ÂáΩÊï∞ÔºåÂÆÉÊúÄÁªàË∞ÉÁî® <code>mmap</code> ÂáΩÊï∞‰ªéËÄåÁ≥ªÁªüË∞ÉÁî®ÂÆåÊàêËôöÊãüÂÜÖÂ≠òÁöÑÂàÜÈÖçÔºåÂπ∂Â∞ÜÂàÜÈÖçÁöÑËôöÊãüÂÜÖÂ≠òËµ∑ÂßãÂú∞ÂùÄÂ°´ÂÖ•hostÊàêÂëò‰∏≠„ÄÇ</li>
<li>ÂΩìnew_blockÂÆåÊàêÂàÜÈÖçÂêéÔºåËøòÈúÄË¶ÅÂ∞Ünew_blockÂä†ÂÖ•ram_list.blocks‰∏≠ÔºåÈÄöËøá <code>QLIST_INSERT_*</code> ÂáΩÊï∞ÂÆåÊàê</li>
<li><code>ram_list.blocks</code> Â∞ÜÊï¥‰∏™ËôöÊãüÊú∫ÁöÑÊâÄÊúâ ‚ÄúÂÜÖÂ≠òÊù°‚Äù RBÁÆ°ÁêÜËµ∑Êù•ÔºåÂΩ¢Êàê‰∫Üram_addr_tÁ±ªÂûãÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåË°®Á§∫ÊâÄÊúâ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÊù°Âú®ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥‰∏≠ÊâÄÂç†ÁöÑÁ©∫Èó¥„ÄÇÁÆ°ÁêÜRBÁöÑÊé•Âè£‰∏ÄËà¨ÂëΩÂêç‰∏∫ <code>qemu_ram_*</code>ÔºåËßÅexec.cÊñá‰ª∂„ÄÇÊúÄÁªàÔºåQEMUË∞ÉÁî® <code>qemu_madvise</code> ÂáΩÊï∞Âª∫ËÆÆÂØπËØ•RBÂØπÂ∫îÁöÑËôöÊãüÂÜÖÂ≠ò‰ΩøÁî®Â§ßÈ°µÔºåÊ†πÊçÆÂâçÊñáÂàÜÊûêÔºå‰ΩøÁî®Â§ßÈ°µÊúâÂä©‰∫éÊèêÈ´òTLBÂëΩ‰∏≠Áéá„ÄÇ</li>
</ol>
<p><code>ramlist</code> ÁöÑÁ±ªÂûãstruct RAMListÂ¶Ç‰∏ã:</p>
<p>qemu-4.1.1/include/exec/ramlist.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200902770.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090223723"
	
	
></p>
<p>ram_listÂ∞Üram_list.blocksÂ∞ÅË£ÖÊàêstruct RAMListÊï∞ÊçÆÁªìÊûÑ‰ªéËÄåÊñπ‰æøÁÆ°ÁêÜÔºåÊòØexec.cÊñá‰ª∂‰∏≠ÁöÑÂÖ®Â±ÄÂèòÈáèÔºå‰øùÂ≠òÂÆ¢Êà∑Êú∫ÊâÄÊúâÁâ©ÁêÜÂÜÖÂ≠òÊù°ÁöÑ‰ø°ÊÅØ„ÄÇÂÖ∂ÊàêÂëòÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>mru_block‰øùÂ≠ò‰∫ÜÊúÄËøë‰ΩøÁî®ÁöÑRBÔºå‰Ωú‰∏∫Êü•Êâæram_list.blocksÁöÑÁºìÂ≠òÔºåÊó†È°ªÈÅçÂéÜÈìæË°®;</li>
<li>dirty_memoryÊòØÊï¥‰∏™ram_list.blocks‰∏≠ÊâÄÊúâRBÁöÑËÑèÈ°µ‰ΩçÂõæÔºåÊØè‰∏Ä‰Ωç‰ª£Ë°®‰∫Ü‰∏Ä‰∏™ËÑèÁöÑÁâ©ÁêÜÂÜÖÂ≠òÈ°µÔºåËÄåRBÁöÑbmap‰ΩçÂõæÊòØÂÖ∂‰∏ÄÈÉ®ÂàÜ;</li>
</ul>
<p>‰∏∫‰∫ÜÊ®°ÊãüVGAÔºàVideo Graphics ArrayÔºåÊòæÁ§∫ÁªòÂõæÈòµÂàóÔºåÂèØÁúã‰Ωú‰∏ÄÁßçËÆæÂ§áÔºâÔºåQEMUÈúÄË¶ÅÈáçÁªòËÑèÈ°µÂØπÂ∫îÁöÑÁïåÈù¢Ôºõ‰∏∫‰∫ÜÊ®°ÊãüTCGÔºàTiny Code GeneratorÔºåÂæÆÁ†ÅÁîüÊàêÂô®ÔºåÊîØÊåÅQEMUÁöÑ‰∫åËøõÂà∂‰ª£Á†ÅÁøªËØëÔºå‰∏ÄÁßçÂü∫‰∫éÁ∫ØËΩØ‰ª∂ÁöÑËôöÊãüÂåñÊñπÊ≥ïÔºâÔºåQEMUÈúÄË¶ÅÈáçÊñ∞ÁºñËØëËá™Ë∞ÉÊï¥ÁöÑ‰ª£Á†ÅÔºõÂØπ‰∫éÁÉ≠ËøÅÁßªÔºåQEMUÈúÄË¶ÅÈáç‰º†ËÑèÈ°µ„ÄÇQEMUË∞ÉÁî®<code>ioctl(KVM_GET_DIRTY_LOG)</code> ÂáΩÊï∞‰ªéKVM‰∏≠ËØªÂèñËÑèÈ°µ‰ΩçÂõæ„ÄÇ</p>
<h3 id="ÊîØÊåÅËôöÊãüÁâ©ÁêÜÂÜÖÂ≠òËÆøÈóÆÂõûË∞ÉÂáΩÊï∞">ÊîØÊåÅ&quot;ËôöÊãü&quot;Áâ©ÁêÜÂÜÖÂ≠òËÆøÈóÆÂõûË∞ÉÂáΩÊï∞
</h3><h4 id="ÂÆû‰Ωìmr">ÂÆû‰ΩìMR
</h4><p>Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥‰∏ç‰ªÖË¢´ÂÜÖÂ≠òÊù°ÊâÄÂç†ÊçÆÔºå‰πüË¢´Â§ñÂõ¥ËÆæÂ§áÁöÑMMIOÂå∫ÂüüÊâÄÂç†ÊçÆÔºåQEMUÈúÄË¶ÅÂØπÂÆ¢Êà∑Êú∫ËÆøÈóÆMMIOËøõË°åÊ®°Êãü„ÄÇCPU‰ΩøÁî®PIOËÆøÈóÆÁ´ØÂè£Âú∞ÂùÄÁ©∫Èó¥ÔºåQEMU‰πüÈúÄË¶ÅÂØπËøôÁ±ªËÆøÈóÆËøõË°åÊ®°Êãü„ÄÇ**ÂØπ‰∫éËøô‰∫õÂú∞ÂùÄÁ©∫Èó¥ÊÆµÔºåQEMUÊó†È°ª‰∏∫ÂÖ∂ÂàÜÈÖçÂÆø‰∏ªÊú∫ËôöÊãüÂÜÖÂ≠òÔºåÂè™ÈúÄËÆæÁΩÆÂØπÂ∫îÁöÑÂõûË∞ÉÂáΩÊï∞„ÄÇ**‰∏∫Ê≠§ÔºåQEMUÂú®RAMBlockÁöÑÂü∫Á°Ä‰∏äÂä†‰∫Ü‰∏ÄÂ±ÇÂåÖË£ÖÔºåÂΩ¢Êàê‰∫ÜMemoryRegionÔºåÁÆÄÁß∞MRÔºåÂåÖÂê´MRÂíåÂõûË∞ÉÂáΩÊï∞„ÄÇ**MR‰ª£Ë°®ÂÆ¢Êà∑Êú∫ÁöÑ‰∏ÄÂùóÂÖ∑ÊúâÁâπÂÆöÂäüËÉΩÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂå∫ÂüüÔºå**ÂÆö‰πâÂ¶Ç‰∏ã:</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200903280.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090302156"
	
	
></p>
<p>QEMUÂÆûÁé∞‰∫ÜMMIOÁöÑÊ®°Êãü„ÄÇ‰∏∫Ê≠§ÔºåÂ∞Ü‰∏Ä‰∏™RBÂíåÂåÖÂê´‰∫ÜMMIOÊ®°ÊãüÂáΩÊï∞ÁöÑMemoryRegionOpsÁªëÂÆöËµ∑Êù•ÔºåÂ∞±ÂΩ¢Êàê‰∫ÜMRËøôÁßçË°®Á§∫Â§ö‰∏™ÁßçÁ±ªÁâ©ÁêÜÂÜÖÂ≠òÂùóÁöÑÊï∞ÊçÆÁªìÊûÑ„ÄÇÂΩìKVM‰∏≠Ë°®Á§∫ÂÜÖÂ≠òÊù°ÁöÑMRÂÖ∂opsÂüü‰∏∫NULLÊó∂Ôºåram_block‰∏ç‰∏∫NULLÔºõËÄåÂØπ‰∫éË°®Á§∫MMIOÂÜÖÂ≠òÂå∫ÁöÑMRÔºåÂÖ∂opsÊ≥®ÂÜå‰∏∫‰∏ÄÁªÑMMIOÊ®°ÊãüÂáΩÊï∞Êó∂Ôºåram_block‰∏∫NULL„ÄÇ</p>
<p>ÂΩìÂÆ¢Êà∑Êú∫ËÆøÈóÆ‰∫Ü‰∏Ä‰∏™MMIOÂØπÂ∫îÁöÑÂå∫ÂüüÔºåKVMÂ∞ÜÈÄÄÂá∫Âà∞QEMUÔºåË∞ÉÁî®opsÂØπÂ∫îÁöÑÂáΩÊï∞„ÄÇops‰∏≠ÂåÖÂê´‰∫Üread„ÄÅwriteÁ≠âÂáΩÊï∞ÔºåÂÖ∂ÂèÇÊï∞ÂåÖÊã¨Áõ∏ÂØπ‰∫éMRÁöÑhwaddrÂú∞ÂùÄaddr„ÄÅÂÜôÂÖ•ÁöÑÊï∞ÊçÆ‰ª•ÂèäÊï∞ÊçÆÁöÑÂ§ßÂ∞èÔºåÊ®°ÊãüÁ°¨‰ª∂MMIOËØªÂÜôÔºà‰æãÂ¶ÇPCI Device IDÔºàPeripheral Component Interconnect Device IDentifierÔºåÂ§ñËÆæÈÉ®‰ª∂‰∫íËÅîËÆæÂ§áÊ†áËØÜÁ¨¶ÔºâÔºâÁöÑreadÂáΩÊï∞Â∫îËØ•ËøîÂõûËÆæÂ§áID„ÄÇ</p>
<blockquote>
<p><strong>Ëá≥Ê≠§ÔºåQEMUÂ∞ÜÊï¥‰∏™Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥Áî®MRÂç†Êª°ÔºåËøôÁßçÊó¢ÂåÖÂê´ÂÜÖÂ≠òÊù°Âå∫ÂüüÂèàÂåÖÂê´MMIOÂå∫ÂüüÁöÑÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑÁ±ªÂûãÊòØhwaddr„ÄÇMRÁöÑaddrÂüüÂç≥‰∏∫hwaddrÁ±ªÂûãÔºåË°®Á§∫ËØ•MRÁöÑGPA„ÄÇ</strong></p>
</blockquote>
<p>QEMUÂØπË±°Ê®°Âûã‰∏∫MRÊèê‰æõ‰∫ÜÊûÑÈÄ†ÂáΩÊï∞ÂíåÊûêÊûÑÂáΩÊï∞ÔºåÂàÜÂà´Âú®‰∏Ä‰∏™MRÂÆû‰æãÂàõÂª∫ÂíåÈîÄÊØÅÊó∂Ë∞ÉÁî®„ÄÇÂú®MRÁöÑparent_objectÈîÄÊØÅÊó∂ÔºåÂ∞±‰ºöË∞ÉÁî®MRÁöÑÊûêÊûÑÂáΩÊï∞„ÄÇÂÖ∑‰Ωì‰∏∫Ôºö</p>
<ul>
<li>MRÂàõÂª∫Êó∂Ë∞ÉÁî® <code>memory_region_initfn</code> ÂáΩÊï∞ÂàùÂßãÂåñMRÔºåÂåÖÊã¨Â∞ÜenableÁΩÆ‰∏∫trueÂíåÂàùÂßãÂåñops„ÄÅsubregionsÈìæË°®Á≠âÔºõ</li>
<li>Ë∞ÉÁî® <code>memory_region_ref</code> ÂáΩÊï∞‰ΩøMRÁöÑparent_objÁöÑÂºïÁî®Êï∞Âä†1Ôºõ</li>
<li><code>memory_region_unref</code> ÂáΩÊï∞Âàô‰ΩøMRÁöÑparent_objÁöÑÂºïÁî®Êï∞Âáè1ÔºåËã•ÂºïÁî®ËÆ°Êï∞‰∏∫0ÔºåÂàô‰ºöË∞ÉÁî®<code>memory_region_finalize</code> ÂáΩÊï∞ÂÆåÊàêMRÁöÑÊûêÊûÑÔºåÂ¶ÇÊûúÊòØRAMÁ±ªÂûãÁöÑMRÔºåËøò‰ºöÈáäÊîæÂØπÂ∫îÁöÑRB„ÄÇ</li>
</ul>
<p>QEMUÁªôÊâÄÊúâÁßçÁ±ªÁöÑMRÈÉΩÊèê‰æõ‰∫ÜËøõ‰∏ÄÊ≠•Â∞ÅË£ÖÁöÑÊûÑÈÄ†ÂáΩÊï∞ÔºåÊ†πÊçÆMRÁöÑÁ±ªÂûãÂ°´ÂÖÖÊï∞ÊçÆÁªìÊûÑ„ÄÇËøô‰∫õÂáΩÊï∞ÊòØ<code>memory_region_init_*</code>ÔºåÂÖ∂‰∏≠ <code>*</code> ‰ª£Ë°®Á±ªÂûãÔºå‰∏ãÈù¢‰∏æ‰æã‰ªãÁªç„ÄÇ</p>
<ol>
<li>RAMÁ±ªÂûãMRÈúÄË¶ÅË∞ÉÁî®ÂâçÊñáÁöÑqemu_ram_allocÂáΩÊï∞ÂàÜÈÖç‰∏Ä‰∏™RBÂ°´ÂÖ•ram_blockÂüüÔºåramÂüü‰∏∫trueÔºõROMÁ±ªÂûãMRÂàôÈúÄË¶ÅÈ¢ùÂ§ñÂ∞Üread_onlyÂüüÁΩÆ‰∏∫trueÔºåË°®Á§∫Âè™ËØªÁöÑÂÜÖÂ≠òÂå∫Ôºõ</li>
<li>MMIOÁ±ªÂûãMRË¥üË¥£ÂÆûÁé∞MMIOÊ®°ÊãüÔºåÈúÄË¶Å‰º†ÂÖ•opsËøõË°åÂàùÂßãÂåñÔºåÂÖ∂‰∏≠opsÊòØ‰∏ÄÁªÑÂõûË∞ÉÂáΩÊï∞ÔºåÂΩìQEMUÈúÄË¶ÅÊ®°ÊãüMMIOÊó∂Ôºå‰ºöË∞ÉÁî®ops‰∏≠ÁöÑÂáΩÊï∞ËøõË°åMMIOÊ®°ÊãüÔºõ</li>
<li>ÂØπ‰∫éROM DeviceÔºàRead Only Memory DeviceÔºåÂè™ËØªÂÜÖÂ≠òËÆæÂ§áÔºâÁ±ªÂûãMRÔºåÂØπÂÆÉËøõË°åËØªÂèñÂàôÁ≠âÂêå‰∫éRAMÁ±ªÂûãÁöÑMRÔºåËÄåÂÜôÂÖ•ÂàôÁ≠âÂêå‰∫éMMIOÁ±ªÂûãÁöÑMRÔºåË∞ÉÁî®ÂõûË∞ÉÂáΩÊï∞opsÔºõ</li>
<li>IOMMUÔºàInput/Output Memory Management UnitÔºåËæìÂÖ•ËæìÂá∫ÂÜÖÂ≠òÁÆ°ÁêÜÂçïÂÖÉÔºâÁ±ªÂûãMRÂ∞ÜÂØπËØ•MRÁöÑËØªÂÜôËΩ¨ÂèëÂà∞Âè¶‰∏ÄMR‰∏äÊ®°ÊãüIOMMU„ÄÇ</li>
</ol>
<p>ÊâÄÊúâÁöÑMRÊûÑÈÄ†ÂáΩÊï∞ <code>memory_region_init_*</code> ÈÉΩË¶ÅË∞ÉÁî® <code>memory_region_init</code> ÂáΩÊï∞Â°´ÂÖÖsize„ÄÅnameÁ≠âÊàêÂëò„ÄÇËøô‰∫õMRÂùáÁß∞‰∏∫ÂÆû‰ΩìMRÔºåterminates‰∏∫true„ÄÇÂâç‰∏âÁ±ªÂÆû‰ΩìMRÁöÑÂàõÂª∫ËøáÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200904329.png" style="zoom:50%;" />
<h4 id="ÂÆπÂô®mrÂà´Âêçmr">ÂÆπÂô®MR/Âà´ÂêçMR
</h4><p>ÊâÄÊúâÁöÑMRÁªÑÊàê‰∫Ü‰∏ÄÊ£µÊ†ëÔºåÂÖ∂Âè∂Â≠êËäÇÁÇπÊòØRAMÂíåMMIOÔºåËÄå‰∏≠Èó¥ËäÇÁÇπ‰ª£Ë°®ÊÄªÁ∫øÔºàÂÆπÂô®MRÔºâ„ÄÅÂÜÖÂ≠òÊéßÂà∂Âô®ÔºàÂà´ÂêçMRÔºâÊàñË¢´ÈáçÂÆöÂêëÂà∞ÂÖ∂‰ªñÂÜÖÂ≠òÂå∫ÂüüÁöÑÂÜÖÂ≠òÂå∫ÔºåÊ†ëÊ†πÊòØ‰∏Ä‰∏™ÂÆπÂô®MRÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200906181.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090644041"
	
	
></p>
<p>ËøôÊ£µÊ†ëË°®Á§∫‰∏Ä‰∏™Âú∞ÂùÄÁ©∫Èó¥ÔºåË¢´AddressSpaceÊï∞ÊçÆÁªìÊûÑÊåáÂêë„ÄÇ‰∏ãÈù¢‰ªãÁªçÂÆπÂô®MRÂíåÂà´ÂêçMRÔºö</p>
<blockquote>
<p><em><strong>ÂÆπÂô® (Container) MR</strong></em></p>
</blockquote>
<p>ÂÆπÂô® (Container) MRÂ∞ÜÂÖ∂‰ªñÁöÑMRÁî®subregionsÈìæË°®ÁÆ°ÁêÜËµ∑Êù•ÔºåÁî® <code>memory_region_init</code> ÂáΩÊï∞ÂàùÂßãÂåñ„ÄÇ‰æãÂ¶ÇPCI BARÔºàPCI Base Address RegisterÔºåPCIÂü∫Âú∞ÂùÄÂØÑÂ≠òÂô®ÔºâÁöÑÊ®°ÊãüÁî±RAMÂíåMMIOÈÉ®ÂàÜÁªÑÊàêÔºåÈúÄË¶ÅÂÆπÂô®Á±ªÂûãÁöÑMRË°®Á§∫PCI BARÔºåÈÄöËøá<code>memory_region_add_subregion</code> ÂáΩÊï∞Âä†ÂÖ•ÂÆπÂô®MRÔºåÂ≠êMRÁöÑcontainerÊàêÂëòÊåáÂêëÂÖ∂ÂÆπÂô®MR„ÄÇ</p>
<p>ÈÄöÂ∏∏ÊÉÖÂÜµ‰∏ãÔºå‰∏Ä‰∏™ÂÆπÂô®MRÁöÑÂ≠êMR‰∏ç‰ºöÈáçÂè†ÔºåÂΩìÂú®ËØ•ÂÆπÂô®MRÂÜÖËß£Êûê‰∏Ä‰∏™hwaddrÊó∂ÔºåÂè™‰ºöËêΩÂÖ•‰∏Ä‰∏™Â≠êMR„ÄÇ‰ΩÜ‰∏Ä‰∫õÊÉÖÂÜµ‰∏ãÂ≠êMR‰ºöÈáçÂêàÔºåËøôÊó∂‰ΩøÁî® <code>memory_region_add_subregion_overlap</code> ÂáΩÊï∞Â∞ÜÂ≠êMRÂä†ÂÖ•ÂÆπÂô®MRÔºåËÄåËß£ÊûêÂú∞ÂùÄÊó∂Áî±‰ºòÂÖàÁ∫ßÂÜ≥ÂÆöÂì™‰∏™Â≠êMRÂèØËßÅ„ÄÇ</p>
<p>Ê≤°ÊúâËá™Â∑±ÁöÑops/ram_blockÁöÑÂÆπÂô®MRÁß∞‰∏∫Á∫ØÂÆπÂô®MRÔºåÂÆπÂô®MR‰πüÂèØ‰ª•Êã•ÊúâËá™Â∑±ÁöÑMemoryRegionOps‰ª•ÂèäRAMBlock„ÄÇÂú®‰∏Ä‰∏™ÂÆπÂô®MR‰∏≠ÔºåsubregionsÈìæË°®‰∏äÁöÑÊâÄÊúâÂ≠êMRÊåâÁÖßÂêÑËá™ÁöÑ‰ºòÂÖàÁ∫ß‰ªéÂ∞èÂà∞Â§ßÊéíÂàó„ÄÇ</p>
<p><code>memory_region_add_subregion_overlap</code>ÂáΩÊï∞ÂèØ‰ª•ÊåáÂÆöÂ≠êMRÁöÑ‰ºòÂÖàÁ∫ßÔºåÂ¶ÇÊûú‰ºòÂÖàÁ∫ß‰∏∫Ë¥üÔºåÂàôÈöêËóèÂú®ÈªòËÆ§Â≠êMR‰πã‰∏ãÔºåÂèç‰πãÂú®‰∏ä„ÄÇ</p>
<blockquote>
<p><em><strong>Âà´Âêç (Alias) MR</strong></em></p>
</blockquote>
<p>Âà´Âêç (Alias) MRÊåáÂêëÂè¶‰∏Ä‰∏™ÈùûÂà´ÂêçÁ±ªÂûãÁöÑMRÔºåQEMUÈÄöËøáÂ∞ÜÂ§ö‰∏™Âà´ÂêçMRÊåáÂêëÂêå‰∏Ä‰∏™MRÁöÑ‰∏çÂêåÂÅèÁßªÂ§ÑÔºå‰ªéËÄåÂ∞ÜÊ≠§MRÂàÜ‰∏∫Âá†ÈÉ®ÂàÜ„ÄÇaliasÂüüÊåáÂêëÂéüMRÔºàÂú®‰ª£Á†Å‰∏≠Â§öÁî®origË°®Á§∫ÔºâÔºåalias_offsetÊòØÂà´ÂêçMRÂú®ÂÆûÈôÖMR‰∏≠ÁöÑ‰ΩçÁΩÆ„ÄÇ</p>
<p>Âà´ÂêçMRÁî® <code>memory_region_init_alias</code> ÂáΩÊï∞ÂàùÂßãÂåñ„ÄÇÂà´ÂêçMRÊ≤°ÊúâËá™Â∑±ÁöÑÂÜÖÂ≠òÔºåÊ≤°ÊúâÂ≠êMR„ÄÇÂà´ÂêçMRÊú¨Ë¥®‰∏äÊòØ‰∏Ä‰∏™ÂÆû‰ΩìMRÔºàÊàñÂè¶‰∏Ä‰∏™Âà´ÂêçMRÔºâÁöÑ‰∏ÄÈÉ®ÂàÜÔºåËÄåÂÆπÂô®MRÁöÑÂ≠êMRÂπ∂ÈùûÂÆπÂô®MRÁöÑ‰∏ÄÈÉ®ÂàÜÔºå‰ªÖË¢´ÂÆπÂô®MRÁÆ°ÁêÜ„ÄÇÂà´ÂêçMRÂπ∂ÈùûÂÆπÂô®MRÁöÑÂ≠êMR„ÄÇ</p>
<p>Âú®QEMU‰∏≠ÔºåÂÖ®Â±ÄÂèòÈáèsystem_memoryÊòØÊï¥‰∏™MRÊ†ëÁöÑÊ†π„ÄÇÁªôÂÆöMRÊ†ëÁöÑÊ†πMR‰ª•ÂèäË¶ÅÊü•ËØ¢ÁöÑÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄÔºåQEMUÂ∞±ÂèØ‰ª•Êü•ÊâæËØ•Âú∞ÂùÄËêΩÂú®Âì™‰∏™ÂÆû‰ΩìMR‰∏≠„ÄÇÈ¶ñÂÖàÂà§Êñ≠ËØ•Âú∞ÂùÄÊòØÂê¶Âú®Ê†πÁÆ°ÁêÜÁöÑËåÉÂõ¥ÂÜÖÔºåÂ¶ÇÊûú‰∏çÂú®ÂàôËøîÂõûÔºåÂê¶ÂàôËøõË°åÂ¶Ç‰∏ãÊ≠•È™§ÁöÑÊêúÁ¥¢Ôºö</p>
<ol>
<li>ÊåâÁÖß‰ºòÂÖàÁ∫ß‰ªéÈ´òÂà∞‰ΩéÁöÑÈ°∫Â∫èÈÅçÂéÜËØ•ÂÆπÂô®MRÁöÑsubregionsÈìæË°®Ôºõ</li>
<li>Â¶ÇÊûúÂ≠êMRÊòØÂÆû‰ΩìMRÔºå‰∏îËØ•Âú∞ÂùÄËêΩÂú®Â≠êMRÁöÑ[mr-&gt;addrÔºåmr-&gt;addr+mr-&gt;sizeÔºâ‰∏≠ÔºåÂàôÁªìÊùüÊü•ÊâæÔºåËøîÂõûËØ•ÂÆû‰ΩìMRÔºõ</li>
<li>Â¶ÇÊûúÂ≠êMRÊòØÂÆπÂô®MRÔºåÂàôÈÄíÂΩíË∞ÉÁî®Ê≠•È™§1Ôºõ</li>
<li>Â¶ÇÊûúÂ≠êMRÊòØÂà´ÂêçMRÔºåÂàôÁªßÁª≠Êü•ÊâæÂØπÂ∫îÁöÑÂÆûÈôÖMRÔºõ</li>
<li>Â¶ÇÊûúÂú®ÊâÄÊúâÁöÑÂ≠êMR‰∏≠ÈÉΩÊ≤°ÊúâÊü•ÊâæÂà∞ÔºåÂàôÊü•ËØ¢ËØ•Âú∞ÂùÄÊòØÂê¶Âú®ÂÆπÂô®MRËá™Â∑±ÁöÑÂÜÖÂ≠òËåÉÂõ¥ÂÜÖ„ÄÇ</li>
</ol>
<p>ÊÉ≥‰∫ÜËß£Êõ¥ÂÆåÊï¥ÁöÑËØ¥ÊòéÔºåÂèØ‰ª•Êü•ÁúãQEMUÊ∫êÁ†ÅÊ†ë‰∏≠ÁöÑ <code>docs/devel/memory.rst</code> ÊñáÊ°£ÔºåÊàñÊü•ÈòÖÊ≥®ÈáäÔºåÂÖ∂‰∏≠ÂåÖÂê´MemoryRegionÁöÑÊâÄÊúâÊ¶ÇÂøµÔºå‰ª•ÂèäMRÁõ∏ÂÖ≥Êé•Âè£ÁöÑËØ¶ÁªÜËß£Èáä„ÄÇ</p>
<h3 id="È°∂Â±ÇÊï∞ÊçÆÁªìÊûÑaddressspace">È°∂Â±ÇÊï∞ÊçÆÁªìÊûÑAddressSpace
</h3><p>Âú®ÂâçÂá†ËäÇ‰∏≠ÔºåQEMU‰ΩøÁî® <code>mmap</code> ÂáΩÊï∞ÂàÜÈÖç‰∫ÜÂÆø‰∏ªÊú∫ËôöÊãüÂÜÖÂ≠òÔºå‰Ωú‰∏∫ÂÆ¢Êà∑Êú∫‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÁöÑÂÆûÁé∞ÂêéÂè∞ÔºåÂèàÊûÑÂª∫‰∫ÜMemoryRegionÊ†ëÔºåÂØπ‰∏Ä‰∏™Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÂÜÖÂêÑ‰∏™‰∏çÂêåÂå∫ÂüüÁöÑÂäüËÉΩËøõË°å‰∫ÜÊ®°ÊãüÔºåÂåÖÊã¨ÂÜÖÂ≠òÊù°RAM‰ª•ÂèäMMIOÔºå‰ΩøÁî®ÂÆπÂô®MRÂØπÂ≠êMRËøõË°åÁÆ°ÁêÜÔºåÂÆåÊàê‰∫ÜQEMUÂØπÂêÑÊÆµÂÜÖÂ≠òÂäüËÉΩÁöÑÊ®°Êãü„ÄÇ</p>
<p>ÂâçÊñáÁî±Â∫ïÂ±ÇÂêë‰∏äÂ±ÇÔºå‰ªãÁªç‰∫ÜQEMU‰∏≠ÊäΩË±°Á®ãÂ∫¶ËæÉÈ´òÁöÑÊï∞ÊçÆÁªìÊûÑMR„ÄÇËøõ‰∏ÄÊ≠•Âú∞ÔºåÈô§‰∫ÜÂØπÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊ®°ÊãüÔºåMRÊ†ëÂèØ‰ª•Áî®Âú®ÂØπ‰ªª‰ΩïÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊ®°Êãü‰∏ä„ÄÇËÆ°ÁÆóÊú∫Á°¨‰ª∂‰∏≠ËøòÂ≠òÂú®‰ª•‰∏ãÂú∞ÂùÄÁ©∫Èó¥Ôºå‰∏éÂÜÖÂ≠òÂú∞ÂùÄÁ©∫Èó¥Á±ª‰ºº„ÄÇ</p>
<ol>
<li>CPUÂú∞ÂùÄÊÄªÁ∫ø‰º†Êù•ÁöÑÂú∞ÂùÄÂèØ‰ª•Áî®‰∫éËÆøÈóÆRAMÊàñMMIOÔºåÂç≥ÂΩ¢Êàê‰∫ÜÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥Ôºåsystem_memoryÂç≥Ë°®Á§∫Ê≠§Á©∫Èó¥Ôºõ</li>
<li>Èô§‰∫ÜMMIOÔºåCPU‰∏éÂ§ñÂõ¥ËÆæÂ§áÊâì‰∫§ÈÅìÁöÑÂè¶‰∏ÄÁßçÊñπÂºèÊòØPIOÔºåCPU‰ΩøÁî® <code>in/out</code> Êåá‰ª§ËÆøÈóÆËÆæÂ§áÁ´ØÂè£ÔºåÁ´ØÂè£Âè∑ÁªÑÊàê‰∫ÜÂè¶‰∏ÄÁßçÂú∞ÂùÄÁ©∫Èó¥ÔºåÂú®x86‰∏äÊúâ65536‰∏™Á´ØÂè£ÔºåÁ´ØÂè£Âú∞ÂùÄÁ©∫Èó¥ËåÉÂõ¥ÊòØ[0Ôºå0xffffÔºâÔºõ</li>
<li>Èô§‰∫ÜCPUÂèØ‰ª•ËÆøÈóÆÂÜÖÂ≠òÔºåÂ§ñÂõ¥ËÆæÂ§á‰πüÂèØ‰ª•Ëá™ÂèëÂú∞ËÆøÈóÆÂÜÖÂ≠òÔºåËøôÁßçËÆøÈóÆÊñπÂºèÁß∞‰ΩúDMAÔºàDirect Memory AccessÔºåÁõ¥Êé•ÂÜÖÂ≠òËÆøÈóÆÔºâÔºåÂèØ‰ª•ÁªïËøáCPUÔºå‰∏ç‰ΩøÁî®CPUËÆøÂ≠òÊåá‰ª§ËÆøÈóÆÂÜÖÂ≠ò„ÄÇÂ§ñÂõ¥ËÆæÂ§áÂèØ‰ª•ÁúãÂà∞ÁöÑÂÜÖÂ≠òÂú∞ÂùÄ‰πüÁªÑÊàê‰∫Ü‰∏Ä‰∏™Âú∞ÂùÄÁ©∫Èó¥„ÄÇ</li>
</ol>
<p>‰ª•‰∏ä‰∏â‰∏™Âú∫ÊôØÂùáÈúÄË¶ÅÂØπ‰∏Ä‰∏™MRÊ†ëËøõË°åÁÆ°ÁêÜ„ÄÇQEMUÂºïÂÖ•‰∫ÜAddressSpaceÊï∞ÊçÆÁªìÊûÑÔºàÁÆÄÁß∞‰∏∫ASÔºâÔºåË°®Á§∫CPU„ÄÅÂ§ñËÆæÊàñPIOÂèØ‰ª•ËÆøÈóÆÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200908345.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090811272"
	
	
></p>
<p>ASÊï∞ÊçÆÁªìÊûÑ‰∏ªË¶ÅÊâøÊãÖ‰∏§‰∏™‰ªªÂä°Ôºö‰∏ÄÊòØÂ∞ÜMRÊ†ëÔºàÁî±rootÊàêÂëòÊåáÂêëÔºâËΩ¨Êç¢ÊàêÁ∫øÊÄßËßÜÂõæcurrent_mapÔºå‰∫åÊòØÂú®ÁªôÂÆö‰∏Ä‰∏™hwaddr(GPA)Êó∂Âø´ÈÄüÊü•ÊâæÂà∞‰∏Ä‰∏™MemoryRegionÔºå‰ªéËÄåÂø´ÈÄüË∞ÉÁî®MRÂØπÂ∫îÁöÑÂõûË∞ÉÂáΩÊï∞opsÊàñMRÂØπÂ∫îÁöÑRBÔºå‰ªéËÄåÊâæÂà∞HVAÔºåÂÆåÊàêGPAÂà∞HVAÁöÑÁøªËØë„ÄÇÁÆÄËÄåË®Ä‰πãÔºåÂ∞±ÊòØÂÆåÊàêÊ†ëÂíåÁ∫øÊÄßË°®‰πãÈó¥ÁöÑÁõ∏‰∫íËΩ¨Êç¢ÔºåËÄå<strong>Á∫øÊÄßË°®ÂíåÊ†ëÂêÑÊúâÁî®ÈÄîÔºö</strong></p>
<ul>
<li>Á∫øÊÄßË°®Âú®ÂêëKVMÊ≥®ÂÜåÂÜÖÂ≠òÊó∂ÔºåÈúÄË¶ÅÁªôKVMÊèê‰æõ‰∏Ä‰∏™Á∫øÊÄßÁöÑÂÜÖÂ≠òÂå∫ÂüüÔºåÊâçÂèØ‰ª•ËØ∑Ê±ÇKVMÂÆåÊàêËøôÊÆµÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÁöÑÂú∞ÂùÄÁøªËØë‰ª•ÂèäEPTÂª∫Á´ãÔºõ</li>
<li>ËÄåÊ†ëÁä∂ÁªìÊûÑÊñπ‰æøQEMUË∞ÉÁî®MRÂØπÂ∫îÁöÑÂõûË∞ÉÂáΩÊï∞opsÔºåÂΩìKVMÊà™Ëé∑‰∫Ü‰∏Ä‰∏™MMIO/PIOÁöÑËØªÂÜôÊìç‰ΩúÔºå‰∏îÈúÄË¶ÅËøîÂõûÂà∞QEMUÊó∂ÔºåÂ∫îËØ•Âú®ÂØπÂ∫îÁöÑAS‰∏≠Êü•ËØ¢MRÊ†ëÔºåÂæóÂà∞ÂØπÂ∫îÁöÑopsËøõË°åÊ®°ÊãüÔºõ‰πüÊñπ‰æøQEMUÊ†πÊçÆGPAÊâæÂà∞RAMÁ±ªÂûãMRÂØπÂ∫îÁöÑHVAÔºåÂç≥ÂÆåÊàêGPAÂà∞HVAÁöÑËΩ¨Êç¢ÔºåÊñπ‰æøÂÜÖÂ≠òËØªÂÜô„ÄÇ</li>
</ul>
<p>Èô§‰∫ÜÁ∫øÊÄßÁªìÊûÑÂíåÊ†ëÁªìÊûÑ‰πãÈó¥ÁöÑËΩ¨Êç¢ÔºåQEMUËøòÈúÄË¶ÅÂêåÊ≠•Á∫øÊÄßÁªìÊûÑÂíåÊ†ëÁªìÊûÑ„ÄÇÂú®AS‰∏≠Ôºåstruct FlatViewÁ±ªÂûãÁöÑcurrent_mapÊòØÁ∫øÊÄßÁªìÊûÑÔºåËÄåMemoryRegionÁ±ªÂûãÁöÑrootÊòØÊ†ëÁä∂ÁªìÊûÑ„ÄÇÁî±‰∫éÊ†ëÁä∂ÁªìÊûÑÂíåÁ∫øÊÄßÁªìÊûÑÂ∫îËØ•‰øùÂ≠òÁõ∏ÂêåÁöÑÂÜÖÂ≠òÊãìÊâëÁªìÊûÑ‰ø°ÊÅØÔºåÂÖ∂‰∏≠‰∏Ä‰∏™Êõ¥ÊîπÊó∂ÔºåÂ∫îËØ•ÂêåÊ≠•Âà∞Âè¶‰∏Ä‰∏™Êï∞ÊçÆÁªìÊûÑ„ÄÇ<strong>ÁÑ∂ËÄåÔºå‰∏ç‰ºöÂ≠òÂú®ÂØπÁ∫øÊÄßÁªìÊûÑËøõË°å‰øÆÊîπÁöÑÊÉÖÂÜµÔºåÂè™‰ºöÂØπÊ†ëÁä∂ÁªìÊûÑÈÄöËøáÂáΩÊï∞Êóè <code>memory_region_*</code> ÂØπMRÊ†ëËøõË°å‰øÆÊîπ„ÄÇ</strong></p>
<p>ÂΩìMRÊ†ëË¢´‰øÆÊîπÊó∂ÔºåQEMUÈúÄË¶ÅÈáçÊñ∞ÁîüÊàêÁ∫øÊÄßÁªìÊûÑÔºåÂÜçÈÅçÂéÜASÁöÑlistenersÈìæË°®ÔºåË∞ÉÁî®ÊØè‰∏™listener‰∏≠ÁöÑÂáΩÊï∞„ÄÇÊØèÂΩìÁîüÊàê‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÁ∫øÊÄßÁªìÊûÑFlatViewÂêéÔºåÈÉΩÈúÄË¶ÅÈáçÊñ∞ÂëäÁü•KVMÈúÄË¶ÅÁøªËØëÁöÑÂÜÖÂ≠òÂå∫Âüü„ÄÇÊòæËÄåÊòìËßÅÔºåÊØèÊ¨°ÈáçÊñ∞ÂëäÁü•KVMÊñ∞ÁöÑÂÜÖÂ≠òÊãìÊâëÈúÄË¶ÅËøõË°å <code>ioctl</code> Ë∞ÉÁî®ÔºåËøôÊòØ‰∏Ä‰∏™Á≥ªÁªüË∞ÉÁî®ÔºåÂºÄÈîÄÂæàÂ§ßÔºåÊïÖQEMUÂ∞ÜÊóßÁöÑFlatView‰øùÂ≠òÂú®current_map‰∏≠ÔºåÊØîËæÉÊñ∞ÊóßFlatViewÂæóÂá∫Êõ¥ÊîπÈÉ®ÂàÜÔºå‰ªÖÂëäÁü•KVMË¶ÅÊõ¥ÊîπÁöÑÈÉ®ÂàÜÂç≥ÂèØ„ÄÇ</p>
<p>QEMU‰ª£Á†Å‰∏≠ÂàõÂª∫‰∫Ü**ÂõõÁ±ªASÔºå**ÂåÖÊã¨Ôºö</p>
<ol>
<li>ÂÖ®Â±ÄÂèòÈáèaddress_space_memoryÔºåË°®Á§∫Áâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÂÖ∂MRÊ†ëÊ†πÊòØÂ§ßÂ∞è‰∏∫UINT64_MAXÁöÑsystem_memoryÔºõ</li>
<li>address_space_ioÔºåË°®Á§∫PIOÁ©∫Èó¥ÔºåÂÖ∂MRÊ†ëÊ†πÊòØÂ§ßÂ∞è‰∏∫65536ÔºàÂç≥0xffffÔºâÁöÑsystem_ioÔºõ</li>
<li>ÊØè‰∏™CPUÈÉΩÊúâ‰∏Ä‰∏™Âêç‰∏∫cpu-memory-nÁöÑASÔºåÂÖ∂‰∏≠n‰∏∫‰ªé0ÂºÄÂßãÁöÑCPUÁºñÂè∑ÔºåÂíåaddress_space_memory‰∏ÄÊ†∑Ôºå‰ΩøÁî®‰∫Üsystem_memory‰Ωú‰∏∫MRÊ†ëÊ†πÔºõ</li>
<li>Â§ñÂõ¥ËÆæÂ§áËßíÂ∫¶ÁöÑASÔºå‰æãÂ¶ÇVGA„ÄÅe1000Á≠âÊ®°ÊãüËÆæÂ§áÔºåÂÆÉ‰ª¨ÁöÑAS‰ΩøÁî®‰∏Ä‰∏™Â§ßÂ∞è‰∏∫UINT64_MAXÁöÑÊÄªÁ∫øMR‰Ωú‰∏∫MRÊ†ëÊ†πÔºåÂπ∂‰ΩøÁî®system_memoryÁöÑÂà´ÂêçMR‰Ωú‰∏∫MRÊ†ëÊ†πÁöÑÂ≠êMRÔºåÂç≥ÂèØ‰ª•Â∞ÜÂÜÖÂ≠òËØªÂÜôËΩ¨ÂèëÂà∞system_memoryÂØπÂ∫îÁöÑÂå∫Âüü‰∏ä„ÄÇ</li>
</ol>
<p>ASÊï∞ÊçÆÁªìÊûÑÊèê‰æõ‰∫Ü‰ª•‰∏ãÊé•Âè£Ôºå‰æõASÁöÑ‰ΩøÁî®ËÄÖÂØπASËøõË°åÂàõÂª∫„ÄÅÈîÄÊØÅ‰∏éËØªÂÜôÔºåÂÖ∂Âê´‰πâËßÅÊ≥®ÈáäÔºö</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200908719.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090850629"
	
	
></p>
<blockquote>
<p>Ê≠§Â§ÑÁúÅÁï•‰∫Ü‰∏éÁºìÂ≠òÂäüËÉΩÁõ∏ÂÖ≥ÁöÑÊé•Âè£ÔºåÊÑüÂÖ¥Ë∂£ÁöÑËØªËÄÖÂèØËá™Ë°åÊü•ÈòÖÊ∫êÁ†Å„ÄÇÂÖ∂‰∏≠ÊúâÂÖ≥ËØªÂÜôÁöÑÊé•Âè£ËØ¥ÊòéËØ¶ËßÅQEMUÊ∫êÁ†ÅÊ†ëÁöÑdocs/devel/loads-stores.rstÊñáÊ°£„ÄÇÂêéÁª≠Â∞ÜÂõ¥ÁªïËøô‰∫õASÁÆ°ÁêÜÂáΩÊï∞ÔºåÂØπASÁöÑÊ†ëÁªìÊûÑ‰∏éÁ∫øÊÄßÁªìÊûÑÁöÑÂêåÊ≠•Ôºå‰ª•ÂèäASÁöÑËØªÂÜô„ÄÅÂõûË∞ÉËøõË°åËÆ≤Ëß£„ÄÇÁî±‰∫é‰∏Ä‰∫õÂáΩÊï∞Â§çÊùÇÂ∫¶ËæÉÈ´òÔºåËøôÈáåÂè™ËÆ≤Ëß£ÈáçË¶ÅÁöÑÂáΩÊï∞„ÄÇASÁõ∏ÂÖ≥Êìç‰ΩúÂùáÂõ¥ÁªïÁùÄhwaddr(GPA)„ÄÅvoid<em>Êàñuint8_t</em>(HVA)‰πãÈó¥ÁöÑËΩ¨Êç¢ËøõË°å„ÄÇ</p>
</blockquote>
<p>Âú®memory.cÊñá‰ª∂‰∏≠ÔºåËøòÊúâÂá†‰∏™ÂÖ®Â±ÄÂèòÈáèÂú®‰∏ãÊñáÂá∫Áé∞ÔºåÊÄªÁªìÂ¶Ç‰∏ã„ÄÇ</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200909052.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120090910993"
	
	
></p>
<p>Áªº‰∏äÔºåAddressSpaceÁõ∏ÂÖ≥Êï∞ÊçÆÁªìÊûÑ‰πãÈó¥ÁöÑÂÖ≥Á≥ªÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºå‰∏ãÈù¢Â∞ÜÂõ¥ÁªïÊ≠§ÂõæÁöÑÂêÑ‰∏™ÈÉ®ÂàÜÂ±ïÂºÄ‰ªãÁªç„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200909459.png" alt="image-20231120090934905" style="zoom:50%;" />
<blockquote>
<p>Âõæ‰∏≠ÊµÅÁ®ãÁÆÄËø∞Ôºö‚ë†‰øÆÊîπMRÊ†ëÔºõ‚ë°ÁîüÊàêÊâÅÂπ≥ËßÜÂõæÔºõ‚ë¢ÈÄöÁü•ÊâÄÊúâlistenersÔºõ‚ë£ioctlÁ≥ªÁªüË∞ÉÁî®ËøõÂÖ•KVMÔºõ‚ë§AddressSpaceËØªÂÜôÔºõ‚ë•ÂÆö‰ΩçÂà∞MRÂπ∂ÂÆåÊàêËØªÂÜô„ÄÇ</p>
</blockquote>
<h3 id="‰ªéÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑ">‰ªéÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑ
</h3><p>ËøôÈáå‰ªãÁªçÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑÁöÑÂêåÊ≠•ËøáÁ®ã„ÄÇ‰∏∫‰∫ÜÂ∞ÜGPAÁøªËØëÂà∞HPAÔºåQEMUÈÄöËøá <code>ioctl</code> Á≥ªÁªüË∞ÉÁî®ÔºåÂ∞ÜASÂØπÂ∫îÁöÑÁ∫øÊÄßÁªìÊûÑcurrent_mapÊ≥®ÂÜåÂà∞KVM‰∏≠ÔºõÂΩìÊ†ëÁä∂ÁªìÊûÑË¢´‰øÆÊîπÊó∂ÔºåQEMUÈúÄË¶ÅÈáçÊñ∞ÁîüÊàêÊñ∞ÁöÑcurrent_mapÔºåÂπ∂‰∏éÊóßÁöÑcurrent_mapËøõË°åÊØîËæÉÔºåÂ∞ÜÊõ¥ÊîπÁöÑÈÉ®ÂàÜÈáçÊñ∞Ê≥®ÂÜåÂà∞KVM‰∏≠„ÄÇFlatViewÁî®‰∫éÁÆ°ÁêÜÁ∫øÊÄßÁªìÊûÑÔºåÂÆö‰πâÂ¶Ç‰∏ã„ÄÇ</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200910382.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091023323"
	
	
></p>
<p>ÊØè‰∏™ASÈÉΩÊúâ‰∏Ä‰∏™ÂØπÂ∫îÁöÑFlatViewÔºåÂÆÉ‰øùÂ≠ò‰∫ÜASÂÜÖÂ≠òÊãìÊâëÁöÑÁ∫øÊÄßÁªìÊûÑÔºåÂπ∂‰∏îÊâøÊãÖ‰∫ÜhwaddrÁöÑÂàÜÊ¥æÂäüËÉΩÔºåÂç≥ÈÄöËøádispatchÊàêÂëòÂ∞ÜhwaddrÊò†Â∞ÑÂà∞ÂØπÂ∫îÁöÑMRÔºåÂêéÊñá‰ªãÁªç„ÄÇFlatView‰∏≠‰øùÂ≠ò‰∫ÜFlatRangeÊï∞ÁªÑÔºåÊòØASÂØπÂ∫îÁöÑÁ∫øÊÄßÁªìÊûÑÔºåFlatRangeÂÆö‰πâÂ¶Ç‰∏ã:</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200910019.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091041947"
	
	
></p>
<p>Â¶ÇÊûúÂ∞ÜFlatViewÁöÑFlatRangeÊï∞ÁªÑÊåâÈ°∫Â∫èÈì∫ÂºÄÔºåÂ∞±ÂæóÂà∞‰∫Ü‰∏Ä‰∏™ÂàÜÂ∏ÉÂú®hwaddrÂú∞ÂùÄÁ©∫Èó¥‰∏äÁöÑÁ∫øÊÄßÁªìÊûÑÔºåÁî±‰∏ÄÊÆµÊÆµÂèØËÉΩ‰∫í‰∏çÁõ∏ÈÇªÁöÑFlatRangeÁªÑÊàê„ÄÇ<strong>‰ΩïÊó∂Áî±MemoryRegionÊ†ëÁä∂ËßÜÂõæÁîüÊàêËØ•Á∫øÊÄßËßÜÂõæÔºü</strong> ÁªèËøáÂàÜÊûêÔºåÊúâ‰∏§‰∏™Êó∂Èó¥ËäÇÁÇπÔºö</p>
<ol>
<li>ASË¢´ÂàùÂßãÂåñÊó∂ÔºåÊ†πÊçÆ‰º†ÂÖ•ÁöÑMRÊ†ëÊ†πÁîüÊàêÁ∫øÊÄßËßÜÂõæcurrent_mapÔºõ</li>
<li>ASÂØπÂ∫îÁöÑMRÊ†ëË¢´Êõ¥ÊîπÊó∂ÔºåÈúÄË¶ÅÈáçÊñ∞ÁîüÊàêÁ∫øÊÄßËßÜÂõæcurrent_map„ÄÇ</li>
</ol>
<p>È¶ñÂÖàÂàÜÊûêASÂàùÂßãÂåñÊó∂Â¶Ç‰ΩïÁîüÊàêFlatViewÔºåASÂàùÂßãÂåñÂáΩÊï∞ÂÆö‰πâÂ¶Ç‰∏ã„ÄÇ</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200911708.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091110657"
	
	
></p>
<p>ËØ•ÂáΩÊï∞È¶ñÂÖàÂàùÂßãÂåñÂêÑ‰∏™ÊàêÂëòÔºåÂåÖÊã¨current_map„ÄÅrootÊåáÈíàÔºåÂπ∂ÂàùÂßãÂåñlistenersÁõëÂê¨ËÄÖÈìæË°®„ÄÇÂÖ®Â±ÄÈìæË°®address_spacesË¥üË¥£Â∞ÜÊ®°ÊãüÂÆ¢Êà∑Êú∫Á°¨‰ª∂ÊâÄ‰ΩøÁî®ÁöÑÊâÄÊúâASÈìæÊé•Ëµ∑Êù•ÔºåÊñπ‰æøÈÅçÂéÜÊâÄÊúâÁöÑAS</p>
<p><code>address_update_topology</code> ÂáΩÊï∞ËæÉ‰∏∫ÈáçË¶ÅÔºåËØ•ÂáΩÊï∞Ë¥üË¥£‰∏∫Êñ∞ÁöÑASÁîüÊàêFlatViewÔºåÂÆö‰πâÂ¶Ç‰∏ã„ÄÇ</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200911884.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091133789"
	
	
></p>
<ol>
<li>Ë∞ÉÁî® <code>memory_region_get_flatview_root</code> ÂáΩÊï∞ÊâæÂà∞ASÁöÑÁâ©ÁêÜMRÊ†πÔºàÁÆÄÁß∞physmrÔºåÁâ©ÁêÜMRÔºåÂêéÊñáÂ∞ÜÂ§öÊ¨°Áî®Âà∞ÔºâÔºåÂÖ∂ÁõÆÁöÑÊòØÊâæÂà∞ÂÆû‰ΩìMRÔºàËÄåÈùûÂà´ÂêçMRÔºâÁöÑÊ†ëÊ†π„ÄÇËøôÊ†∑ÂèØ‰ª•ÂáèÂ∞ëFlatViewÁöÑ‰∏™Êï∞Ôºå‰ΩøÂæóÊã•ÊúâÁõ∏ÂêåÁöÑÂÆû‰ΩìMRÁöÑASÂÖ±Áî®‰∏Ä‰∏™FlatViewÔºåÂáèÂ∞ëÂÜÖÂ≠òÂºÄÈîÄ„ÄÇÁî±Ê≠§ÂèØÁü•ÔºåASÁöÑFlatView‰∏éphysmrÁªëÂÆöÔºåËÄåÈùû‰∏éÊ†πMRÁªëÂÆöÔºõ</li>
<li>Ë∞ÉÁî® <code>flatviews_init</code> ÂáΩÊï∞ÂàùÂßãÂåñÂÖ®Â±ÄÂèòÈáèflat_viewsÔºåÂÆÉÊòØ‰∏Ä‰∏™ÂÖ®Â±ÄÁöÑÂìàÂ∏åË°®ÔºåË¥üË¥£Â∞ÜMRÊò†Â∞ÑÂà∞FlatView„ÄÇÂú®È¶ñÊ¨°Ë∞ÉÁî® <code>flatviews_init</code> ÂáΩÊï∞Êó∂Ë¢´ËÆæÁΩÆ‰∏∫Êñ∞ÁöÑÁ©∫ÂìàÂ∏åË°®Ôºõ</li>
<li>Ë∞ÉÁî® <code>generate_memory_topology</code> ÂáΩÊï∞ÔºåÁîüÊàêphysmrÂØπÂ∫îÁöÑFlatView„ÄÇËøôÊòØÂ∞ÜÊ†ëÁä∂ÁªìÊûÑËΩ¨Êç¢‰∏∫Á∫øÊÄßÁªìÊûÑÁöÑÊ†∏ÂøÉÂáΩÊï∞Ôºå‰ΩÜÁî±‰∫éÂÖ∂Â§çÊùÇÁ®ãÂ∫¶ËæÉÈ´òÔºåÊ≠§Â§Ñ‰∏çËøõË°åËØ¶ÁªÜÂàÜÊûê„ÄÇÂÆÉÈ¶ñÂÖàÂàùÂßãÂåñviewÔºåÁÑ∂ÂêéË∞ÉÁî®<code>render_memory_region</code> ÂáΩÊï∞ÁîüÊàêphysmrÂØπÂ∫îÁöÑviewÔºåÂÜçË∞ÉÁî® <code>flatview_simplify </code>ÂáΩÊï∞ÁÆÄÂåñview„ÄÇÊé•‰∏ãÊù•ÁöÑ‰ª£Á†ÅÂ∞ÜÊ†πÊçÆÁîüÊàêÁöÑviewÂ°´ÂÖÖÂú∞ÂùÄÂàÜÊ¥æÂô®dispatch„ÄÇÊúÄÁªàÔºåphysmrÂà∞viewÁöÑÊò†Â∞ÑË¢´Â≠òÂÇ®Âú®ÂÖ®Â±ÄÂìàÂ∏åË°®flat_views‰∏≠„ÄÇ</li>
</ol>
<hr>
<p>Ëá≥Ê≠§ÔºåQEMUÂ∑≤ÁªèÂ∞ÜÊ†ëÁä∂ÁªìÊûÑËΩ¨Êç¢‰∏∫Á∫øÊÄßÁªìÊûÑÔºåÊé•‰∏ãÊù•ÊòØÂëäÁü•ÊâÄÊúâÁõëÂê¨ËÄÖÊñ∞ÁöÑÁ∫øÊÄßÁªìÊûÑ„ÄÇÂú®ËøôÈáåÔºåÂè™Êúâ‰∏Ä‰∏™KVMÁõëÂê¨Âô®Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/include/sysemu/kvm_int.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200912658.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091215598"
	
	
></p>
<p>KVMMemoryListener‰∏≠ÁöÑKVMSlotÊòØQEMU‰∏≠KVMÁöÑkvm_memory_slotÂØπÂ∫îÁöÑÊï∞ÊçÆÁªìÊûÑÔºåË¥üË¥£ÂêëKVMÊ≥®ÂÜåÂÜÖÂ≠òÔºõlistenerÊòØÈÄöÁî®ÁõëÂê¨Âô®ÔºåÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200912498.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091232445"
	
	
></p>
<p>ÈÄöÁî®ÁõëÂê¨Âô®MemoryListenerÊòØ‰∏Ä‰∏™ÂáΩÊï∞ÊåáÈíàÁöÑÈõÜÂêàÔºåÂπ∂Êúâ‰∏Ä‰∏™priorityÊàêÂëòË°®Á§∫ÂÖ∂‰ºòÂÖàÁ∫ßÔºåÊâÄÊúâÁöÑlistenerÂú®Ê≥®ÂÜåÊó∂ÊåâÁÖß‰ºòÂÖàÁ∫ßÈ°∫Â∫èËøûÊé•Âà∞ASÁöÑÁõëÂê¨ËÄÖÈìæË°®‰∏ä„ÄÇÂÖ∂‰∏≠KVMÁõëÂê¨Âô®Ê≥®ÂÜåÁöÑ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/accel/kvm/kvm-all.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200912586.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091251529"
	
	
></p>
<p>Âú®KVMÁõëÂê¨ËÄÖ‰∏≠Ôºå<code>region_add</code> ÂáΩÊï∞ÊåáÈíàÊåáÂêë <code>kvm_region_add</code> ÂáΩÊï∞ÔºåÊúÄÁªàË∞ÉÁî® <code>ioctl</code> ÂáΩÊï∞ÂÆåÊàêÂÜÖÂ≠òÁöÑÊ≥®ÂÜå„ÄÇ</p>
<p>‰∏ãÈù¢ËÆ©Êàë‰ª¨ÂõûÂà∞ASÁöÑÂàùÂßãÂåñÂáΩÊï∞<code>address_space_init</code> ‰∏≠ÔºåÁîüÊàêÁ∫øÊÄßËßÜÂõæviewÂêéÁªßÁª≠Ë∞ÉÁî® <code>address_space_set_flatview</code> ÂáΩÊï∞ÔºåÂ∞ÜÊñ∞ÁîüÊàêÁöÑphysmrÂØπÂ∫îÁöÑviewÂëäÁü•ÊâÄÊúâÁõëÂê¨ËÄÖÔºåÂπ∂‰∏îÂ∞ÜASÁöÑcurrent_mapÊõ¥Êñ∞Âà∞Êñ∞ÁîüÊàêÁöÑview„ÄÇÊ≠§Â§ÑË∞ÉÁî®ÁöÑÊòØKVMÁõëÂê¨Âô®ÁöÑÂõûË∞ÉÂáΩÊï∞Ôºå‰ªé <code>address_space_set_flatview</code> ÂáΩÊï∞ËÆ≤Ëµ∑Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200913045.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091314981"
	
	
></p>
<ol>
<li><code>address_space_to_flatview</code> ÂáΩÊï∞È¶ñÂÖàÊâæÂà∞ÊóßÁöÑcurrent_mapÔºå‰Ωú‰∏∫old_viewÔºåËØ•ÊÉÖÂÜµ‰∏ã‰∏∫NULLÔºõ</li>
<li>ÂÜçÈÄöËøáphysmrÂú®ÂÖ®Â±ÄÂìàÂ∏åË°®flat_views‰∏≠Êü•ÊâæÊñ∞ÁîüÊàêÁöÑphysmrÂØπÂ∫îÁöÑviewÔºå‰Ωú‰∏∫new_viewÔºåÂ∞ÜÊñ∞ÊóßviewÊØîËæÉ„ÄÇÂú®ASÂàùÂßãÂåñÊó∂ÔºåÂ¶ÇÊûúÊñ∞Êóßview‰∏çÁõ∏ÂêåÔºåÂàô‰ºöÂ∞ÜÊñ∞Êóßview‰º†Áªô <code>address_space_update_topology_pass</code>ÂáΩÊï∞Ôºå‰ªéËÄåÂëäÁü•ÊâÄÊúâÁöÑÁõëÂê¨ËÄÖÁ∫øÊÄßÁªìÊûÑÁöÑÂèòÂåñÔºåÊúÄÂêéÂ∞Ücurrent_mapÊõ¥Êñ∞‰∏∫new_view„ÄÇ</li>
</ol>
<p>ÂÖ∂‰∏≠ÔºåÁ∫øÊÄßÁªìÊûÑÂèòÂåñÁöÑÂçï‰ΩçÊòØMemoryRegionSectionÔºåÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200913086.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091342034"
	
	
></p>
<p><code>address_space_update_topology_pass</code> ÂáΩÊï∞È¶ñÂÖàÂØπÊØîÊñ∞ÊóßFlatViewÔºåÂæóÂá∫Êñ∞ÊóßFlatView‰πãÈó¥ÁöÑÂ∑ÆÂà´ÔºåÁî®FlatRangeÁöÑÂΩ¢Âºè‰øùÂ≠ò„ÄÇÂØπÊ≠§FlatRangeË∞ÉÁî®MEMORY_LISTENER_UPDATE_REGIONÂáΩÊï∞Â∞ÜFlatViewËΩ¨Âåñ‰∏∫MemoryRegionSectionÔºåÂáÜÂ§áÂ•ΩË∞ÉÁî®ÊâÄÊúâlistenerÁöÑregion_addÂáΩÊï∞„ÄÇÊúÄÁªàÈÅçÂéÜASÁöÑlistenersÈìæË°®Ôºå‰ΩøÁî®MemoryRegionSectionË∞ÉÁî®ÊâÄÊúâlistenerÁöÑregion_addÂáΩÊï∞„ÄÇÊ≠§Â§ÑÂè™ÂÖ≥Ê≥®KVMÁöÑkvm_region_addÂáΩÊï∞ÔºåËøôÂú®ÂâçÊñá‰ªãÁªçÁõëÂê¨Âô®Êï∞ÊçÆÁªìÊûÑÊó∂Â∑≤Áªè‰ªãÁªçËøá„ÄÇÂÖ∑‰ΩìË∞ÉÁî®ÈìæÂ¶Ç‰∏ã:</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200915193.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091533110"
	
	
></p>
<p>Ëá≥Ê≠§ÔºåQEMUÂ∑≤ÁªèÂÆåÊàê‰∫ÜASÂàùÂßãÂåñÂ∑•‰Ωú„ÄÇASÂàùÂßãÂåñÊó∂Ê∂âÂèäÁöÑË∞ÉÁî®ÈìæÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200915581.png" alt="image-20231120091430673" style="zoom:50%;" />
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÂàùÂßãÂåñ‰∏Ä‰∏™ASÊó∂ÔºåÈ¶ñÂÖàË∞ÉÁî® <code>generate_memory_topology</code> ÂáΩÊï∞ÁîüÊàêÂÖ∂physmrÊ†πÂØπÂ∫îÁöÑFlatViewÔºåÂÜçË∞ÉÁî®ÂáΩÊï∞ <code>address_space_set_flatview-&gt;address_space_update_topology_pass-&gt;kvm_region_add</code> ÈÄöÁü•KVMÊ®°Âùó: Á∫øÊÄßËßÜÂõæÂ∑≤ÁªèÊõ¥ÊîπÔºåÈúÄË¶ÅÈáçÊñ∞ÂêëKVM‰ΩøÁî®ioctlÂáΩÊï∞Ê≥®ÂÜåÂÜÖÂ≠òÔºåÊúÄÁªàË∞ÉÁî®ioctlÂáΩÊï∞ËøõÂÖ•ÂÜÖÊ†∏ÊÄÅÁöÑKVMÊ®°Âùó‰∏≠„ÄÇ</p>
<hr>
<p>ÁÆÄËÄåË®Ä‰πãÔºåÈáçË¶ÅÁöÑÊòØ‰∏§‰∏™ÂáΩÊï∞Ôºö</p>
<ul>
<li><code>generate_memory_topology</code> ÂáΩÊï∞ÔºåË¥üË¥£ÁîüÊàêMRÊ†ëÂØπÂ∫îÁöÑFlatViewÔºõ</li>
<li><code>address_space_set_flatview</code> ÂáΩÊï∞ÔºåË¥üË¥£Â∞ÜFlatViewÁöÑÊõ¥ÊîπÈÄöËøá <code>address_space_update_topology_pass</code>ÂáΩÊï∞ÂëäÁü•ÊâÄÊúâlistenerÔºåÂÖ∂‰∏≠ÂåÖÊã¨KVMMemoryListener„ÄÇ</li>
</ul>
<p>ASÁöÑÂàùÂßãÂåñÂè™ÊòØ‰∏Ä‰∏™ÈúÄË¶ÅÂêåÊ≠•Ê†ëÁä∂ÁªìÊûÑ‰∏éÁ∫øÊÄßÁªìÊûÑÁöÑÊÉÖÂÜµ„ÄÇÂú®ASÂàùÂßãÂåñ‰πãÂêéÔºåMRÊ†ëË¢´Êõ¥Êñ∞Êó∂‰πüÈúÄË¶ÅÂêåÊ≠•Âà∞FlatViewÔºåÂπ∂ÈÄöÁü•KVM„ÄÇ</p>
<p>QEMUÊèê‰æõÁöÑÂ§ö‰∏™Êìç‰ΩúMRÁöÑÊé•Âè£‰ºöÊõ¥Êñ∞MRÊ†ëÔºåÂ¶Ç <code>memory_region_add_subregion</code> ÂáΩÊï∞ÔºåQEMUÈÉΩ‰ºö‰ΩøÁî®MR‰∫ãÂä°Êú∫Âà∂ÂÆåÊàêFlatViewÁöÑÂêåÊ≠•‰ª•ÂèäKVMÁõëÂê¨Âô®ÁöÑÈÄöÁü•ÔºåÂÖ∂Â§ßËá¥Ë∞ÉÁî®Èìæ‰ª£Á†ÅÂ¶Ç‰∏ã:</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200915969.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091558886"
	
	
></p>
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÊØèÊ¨°‰øÆÊîπMRÊ†ëÈÉΩÂú® <code>flatviews_reset</code> ÂáΩÊï∞‰∏≠ÈáçÊñ∞ÁîüÊàê‰∫ÜÂØπÂ∫îÁöÑFlatViewÔºåÂπ∂‰∏îË∞ÉÁî®<code>address_space_set_flatview</code> ÂáΩÊï∞Â∞ÜÊñ∞ÁöÑFlatViewÊ≥®ÂÜåÂà∞KVM‰∏≠„ÄÇÁÆÄÂåñÁöÑË∞ÉÁî®ÈìæÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÁ±ª‰ºº‰∫éASÂàõÂª∫‰πãÂêéÁöÑË∞ÉÁî®Èìæ„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200916554.png" alt="image-20231120091617603" style="zoom:50%;" />
<hr>
<p>Ëá≥Ê≠§ÔºåQEMUÂÆåÊàê‰∫ÜÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑÁöÑÂêåÊ≠•ÔºåÂπ∂Â∞ÜÁ∫øÊÄßÁªìÊûÑÊ≥®ÂÜåÂà∞KVM‰∏≠„ÄÇQEMUËøõË°å‰∫ÜÊ†ëÁä∂ÁªìÊûÑÂà∞Á∫øÊÄßÁªìÊûÑÁöÑËΩ¨ÂåñÔºåÂ∞ÜËæÉ‰∏∫Â§çÊùÇÁöÑ‚ÄúÁ≠ñÁï•‚ÄùËΩ¨Êç¢Êàê‰∏ÄÁßçÁÆÄÂçïÁöÑÂΩ¢ÂºèÔºåÂèØ‰ª•Ë∞ÉÁî®KVMÊèê‰æõÁöÑ‚ÄúÊú∫Âà∂‚ÄùÂÆåÊàêQEMU/KVMÁöÑÂçèÂêåÂ∑•‰Ωú„ÄÇ</p>
<p>Ê≠§Êó∂ÔºåÂΩìÂÆ¢Êà∑Êú∫ËÆøÈóÆ‰∏Ä‰∏™‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂú∞ÂùÄGPAÊó∂ÔºåÂ¶ÇÊûúËØ•GPA‰∏çÊòØÁî®‰∫éMMIOÔºåÈÇ£‰πàMMUÈÉΩ‰ºöÊü•ËØ¢KVMÊâÄÁª¥Êä§ÁöÑEPTÂæóÂà∞ÂÖ∂ÂØπÂ∫îÁöÑ‚ÄúÁúüÂÆû‚ÄùÁâ©ÁêÜÂú∞ÂùÄÔºåÂÆ¢Êà∑Êú∫ËÆøÈóÆËøôÈÉ®ÂàÜ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÂ∞Ü‰∏ç‰ºöÂºïËµ∑VM-ExitÔºå‰ªéËÄåÂÆåÊàêÈ´òÊïàÁöÑÂÜÖÂ≠òËôöÊãüÂåñ„ÄÇÂØπ‰∫éMMIOÂå∫ÂüüÁöÑGPAÔºåQEMUÊòØÂ¶Ç‰Ωï‰∏éKVMÂçè‰ΩúÁöÑÂë¢Ôºü</p>
<h3 id="ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÁöÑÂàÜÊ¥æ">ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÁöÑÂàÜÊ¥æ
</h3><p>ÂØπ‰∫éÂÆûÁé∞MMIOÁöÑMRÔºåÂú®KVMMemoryListenerÂØπÂÆÉËøõË°åKVMÂÜÖÂ≠òÊ≥®ÂÜåÊó∂ÔºåÊ≥®ÂÜåÂáΩÊï∞ <code>kvm_region_add</code> Â∞ÜÂÖ∂ËØÜÂà´‰∏∫MMIOÂØπÂ∫îÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÂå∫ÔºåÊ≤°ÊúâÂØπÂ∫îÁöÑÂÆø‰∏ªÊú∫ËôöÊãüÂú∞ÂùÄÔºåÂ∞±‰∏ç‰ºöÂ∞ÜÂÖ∂Êèê‰∫§Âà∞KVM‰∏≠„ÄÇÂ¶ÇÊûúÂÆ¢Êà∑Êú∫ËÆøÈóÆ‰∫ÜËøôÊÆµÂÜÖÂ≠òÔºåKVM‰ºöËØÜÂà´ËøôÊòØMMIOÂØπÂ∫îÁöÑÂÜÖÂ≠òÂå∫ÔºåÊúÄÁªàËøîÂõûÂà∞QEMUÁöÑ <code>ioctl(KVM_RUN)</code> Á≥ªÁªüË∞ÉÁî®‰πãÂêé„ÄÇÂØπ‰∫éPIOÁöÑÂ§ÑÁêÜÊòØÁ±ª‰ººÁöÑÔºå‰πü‰ºöÈÄÄÂá∫Âà∞QEMUÁöÑ <code>ioctl(KVM_RUN)</code> Á≥ªÁªüË∞ÉÁî®‰πãÂêé„ÄÇË∞ÉÁî®‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/accel/kvm/kvm-all.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200917194.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120091753140"
	
	
></p>
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÂú®ÈÄÄÂá∫Âà∞QEMU‰πãÂêéÔºåÈúÄË¶ÅÂØπQEMUÊ®°ÊãüMMIO/PIOÊâÄ‰ΩøÁî®ÁöÑASÊï∞ÊçÆÁªìÊûÑËøõË°åËØªÂÜôÔºå‰ΩøÁî®ÁöÑÊòØÂâçÊñá‰ªãÁªçÁöÑASËØªÂÜôÂáΩÊï∞<code>address_space_rw</code>„ÄÇ</p>
<p>ÊâÄË∞ìÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÁöÑÂàÜÊ¥æÊòØÊåáÔºåÂ∞ÜÂØπASËØªÂÜôÁöÑÂú∞ÂùÄÂàÜÊ¥æÂà∞ÂØπÂ∫îÁöÑMemoryRegion‰∏äÔºåË∞ÉÁî®MRÊâÄÂåÖÂê´ÁöÑÂ§ÑÁêÜÂáΩÊï∞ËøõË°åMMIO/PIOÊ®°Êãü„ÄÇ‰∫ãÂÆû‰∏äÔºåÂ¶ÇÊûúÁªôÂÆö‰∏Ä‰∏™hwaddrÔºåÂèØ‰ª•Âú®MRÊ†ë‰∏≠ÊêúÁ¥¢ÂÖ∂ÂØπÂ∫îÁöÑMRÔºå‰ΩÜËøôÊ†∑ÂÅöÊó†ÁñëÊòØÂæà‰ΩéÊïàÁöÑ„ÄÇ‰∏∫Ê≠§ÔºåQEMUÂºïÂÖ•‰∫Ü‰∏Ä‰∏™Á±ª‰ºº‰∫éÈ°µË°®ÁöÑÁªìÊûÑÂÆåÊàêÂú∞ÂùÄËΩ¨Êç¢ÔºåÂç≥ <code>struct AddressSpaceDispatch</code>ÔºåÂÖ∂Â§çÊùÇÁ®ãÂ∫¶ËæÉÈ´òÔºå‰∏çËøõË°åÊ∑±ÂÖ•ÂàÜÊûê„ÄÇÊï∞ÊçÆÁªìÊûÑÂÖ≥Á≥ªÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/include/exec/memory.h</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200920520.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120092039486"
	
	
></p>
<p>ASÁöÑÁ∫øÊÄßËßÜÂõæÔºàÊâÅÂπ≥ËßÜÂõæÔºâ‰∏≠‰øùÂ≠ò‰∫Üstruct AddressSpaceDispatchÁöÑÊåáÈíàÔºåÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/exec.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200921536.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120092115463"
	
	
></p>
<p>ÊØè‰∏™ASÊúâ‰∏Ä‰∏™Áã¨Á´ãÁöÑAddressSpaceDispatchÔºå‰Ωú‰∏∫ASÂÜÖÂ≠òÂú∞ÂùÄÂàÜÊ¥æÁöÑÈ°µË°®ÔºåÂÖ∂Âè∂Â≠êÁªìÁÇπÁöÑÈ°µË°®È°πÊåáÂêëMemoryRegionSectionÔºåÊü•ËØ¢ËØ•È°µË°®ÁöÑÁªìÊûúÊòØMemoryRegionSection„ÄÇÂú®AddressSpaceDispatch‰∏≠Ôºåmru_section‰øùÂ≠ò‰∫ÜÊúÄËøë‰∏ÄÊ¨°ÁöÑÊü•ËØ¢ÁªìÊûúÔºå‰ΩúÁî®Á±ª‰ºº‰∫éTLBÔºõmapÊòØ‰∏Ä‰∏™Â§öÁ∫ßÈ°µË°®ÔºåÂç≥ËÉΩÂ§üÂø´ÈÄüÊü•ÊâæÔºåÂèà‰∏ç‰ºöÂç†Áî®ËøáÂ§öÂÜÖÂ≠ò„ÄÇphys_mapËµ∑Âà∞‰∫ÜCR3ÁöÑ‰ΩúÁî®ÔºåPhyPageMap‰∏≠ÁöÑnodesË°®Á§∫È°µË°®ÁöÑ‰∏≠Èó¥ËäÇÁÇπÔºåsectionsÁ≠âÂêå‰∫éÁâ©ÁêÜÈ°µÁöÑ‰ΩúÁî®„ÄÇ</p>
<p>Áî±‰∫éAddressSpaceDispatchÂÆûÁé∞ËæÉ‰∏∫Â§çÊùÇÔºåËøôÈáåÂè™ÂÖ≥Ê≥®ËØ•Êï∞ÊçÆÁªìÊûÑÊèê‰æõÁöÑÊé•Âè£„ÄÇÊ≠£Â¶ÇÂâçÊñáÊèêÂà∞ÁöÑÔºåASÂØπÂ∫îÁöÑdispatchÂú®ÁîüÊàêÁ∫øÊÄßËßÜÂõæÊó∂ÂàùÂßãÂåñÔºåÂπ∂Â°´ÂÖ•FlatViewÁöÑdispatchÂ≠óÊÆµÔºåÂç≥Âú®ÂâçÊñáÊèêÂà∞ÁöÑÊ†∏ÂøÉÂáΩÊï∞ <code>generate_memory_topology</code> ‰∏≠ÂàùÂßãÂåñÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/memory.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200923731.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120092315655"
	
	
></p>
<p>Âú®ÁîüÊàêASÁöÑFlatRangeÊï∞ÁªÑ‰πãÂêéÔºåQEMUÂ∞ÜFlatRangeÊï∞ÁªÑ‰∏≠ÊØè‰∏™ÂÖÉÁ¥†ËΩ¨Êç¢ÊàêÂÖ∂ÂØπÂ∫îÁöÑMemoryRegionSectionÔºåÂπ∂Ë∞ÉÁî® <code>flatview_add_to_dispatch</code> ÂáΩÊï∞Â°´ÂÖ•È°µË°®AddressSpaceDispatch‰∏≠„ÄÇËøôÊÑèÂë≥ÁùÄÔºåÂè™Ë¶ÅÁîüÊàê‰∫ÜFlatRangeÔºåQEMUÂ∞±ÂèØ‰ª•‰ΩøÁî®AddressSpaceDispatchÊü•Êâæ‰∏Ä‰∏™AS‰∏≠hwaddr(GPA)ÊâÄÂú®ÁöÑMRÔºå‰ªéËÄåÂæóÂá∫GPAÂØπÂ∫îÁöÑHVA„ÄÇ</p>
<p><code>address_space_rw</code> ÂáΩÊï∞‰ΩøÁî®È°µË°®AddressSpaceDispatchÂÆåÊàêÂú∞ÂùÄËΩ¨Êç¢ÔºåÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/exec.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200924944.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120092413899"
	
	
></p>
<p>ËøôÈáåÂá∫Áé∞‰∫Ü‰∏Ä‰∏™MemTxResultÁ±ªÂûãÔºåQEMUÂ∞ÜÂØπASÁöÑËØªÂÜôËßÜ‰∏∫‰∏ÄÊ¨°MR‰∫ãÂä°ÔºåÂÖ∂ËøîÂõûÁªìÊûúMemTxResultÊòØ‰∏Ä‰∏™uint32_tÁ±ªÂûãÁöÑÂèòÈáèÔºåÂÆö‰πâÂú®include/exec/memattrs.h‰∏≠ÔºåÂèØ‰ª•ÂèñMEMTX_OK„ÄÅMEMTX_ERRORÁ≠âÂÄº„ÄÇÂØπASËøõË°åËØªÂÜôÊó∂ÔºåÈ¶ñÂÖàÂéüÂ≠êÂú∞ËØªÂèñASÁöÑcurrent_mapÔºåÂç≥ÂΩìÂâçÁöÑÁ∫øÊÄßÁªìÊûÑÔºõÂÜçË∞ÉÁî® <code>flatview_read/write</code> ÂáΩÊï∞ÂØπÁ∫øÊÄßÁªìÊûÑfvËøõË°åËØªÂÜô„ÄÇÊ≠§Â§ÑÁî® <code>flatview_read</code> ÂáΩÊï∞‰Ωú‰∏∫‰æãÂ≠êËøõË°åËØ¥ÊòéÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/exec.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200925277.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120092506221"
	
	
></p>
<p>ÂèØ‰ª•ÁúãÂà∞Ôºå<code>flatview_read</code> ÂáΩÊï∞‰∏çÊñ≠Ë∞ÉÁî® <code>flatview_translate</code> ÂáΩÊï∞ÔºåÈÄöËøáFlatViewÂÜÖÈÉ®ÁöÑÈ°µË°®AddressSpaceDispatchÂæóÂà∞‰∏Ä‰∏™hwaddrÂú∞ÂùÄÂØπÂ∫îÁöÑMemoryRegionÔºåÂÜçËøõË°åMemoryRegionÂØπÂ∫îÁöÑÊ®°Êãü„ÄÇÂØπ‰∫éI/OÁ±ªÂûãÁöÑMRÔºåÊúÄÁªàË∞ÉÁî® <code>ops-&gt;read</code> ÂáΩÊï∞ÂÆåÊàêËØªÂèñÁöÑÊ®°ÊãüÔºõÂØπ‰∫éRAMÁ±ªÂûãÁöÑMRÔºåÂàôÊâæÂà∞hwaddr addrÂØπÂ∫îÁöÑHVAÔºåËÆ∞ÂΩïÂú®ptrÊåáÈíà‰∏≠ÔºåË∞ÉÁî®memcpyÂÆåÊàêËØªÂèñ„ÄÇÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÂàÜÊ¥æÁöÑË∞ÉÁî®ÈìæÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200926648.png" alt="image-20231120092613701" style="zoom:50%;" />
<p>Ëá≥Ê≠§ÔºåÂ∑≤Áªè‰ªãÁªç‰∫ÜQEMU‰∏≠ÂÜÖÂ≠òËôöÊãüÂåñÁõ∏ÂÖ≥ÁöÑÂ§ßÈÉ®ÂàÜÊï∞ÊçÆÁªìÊûÑÂèäÂÖ∂Êìç‰ΩúÊé•Âè£‰πãÈó¥ÁöÑÂÖ≥Á≥ª„ÄÇÊÄªÁªìÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>AddressSpaceÊòØÈ°∂Â±ÇÊï∞ÊçÆÁªìÊûÑÔºåÂ∞ÜMemoryRegionÊ†ëÂíåFlatViewÁ∫øÊÄßÁªìÊûÑÁªÑÁªáËµ∑Êù•ÔºåÂΩ¢Êàê‰∏Ä‰∏™ÂèØ‰æõËØªÂÜôÁöÑÂú∞ÂùÄÁ©∫Èó¥Ôºõ</li>
<li>MemoryRegion‰∏≠ÁöÑÂÆπÂô®Á±ªÂûãÂíåÂà´ÂêçÁ±ªÂûãÂàÜÂà´Ê®°Êãü‰∫ÜÁúüÂÆûÁ≥ªÁªü‰∏≠ÁöÑÊÄªÁ∫øÂíåÂÜÖÂ≠òÊéßÂà∂Âô®ÔºåÂ∞ÜI/OÁ±ªÂûãÁöÑMRÂíåRAMÁ±ªÂûãÁöÑMRÈÄöËøáÊ†ëÁöÑÂΩ¢ÂºèÁªÑÁªáËµ∑Êù•„ÄÇ
<ul>
<li>I/OÁ±ªÂûãÁöÑMRÊèê‰æõ‰∫Ü‰∏ÄÁªÑopsÂõûË∞ÉÂáΩÊï∞Ôºå‰æõQEMUÂÆûÁé∞Áâ©ÁêÜÁ°¨‰ª∂ÁöÑÊ®°ÊãüÔºõ</li>
<li>ËÄåRAMÁ±ªÂûãÁöÑMRÂØπÂ∫îÂÆø‰∏ªÊú∫‰∏äÁöÑ‰∏ÄÊÆµËôöÊãüÂú∞ÂùÄHVAÔºå‰Ωú‰∏∫ÂÆ¢Êà∑Êú∫ÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂú∞ÂùÄÔºåQEMUÊúÄÁªàÂ∞ÜËøôÊÆµÂú∞ÂùÄÊ≥®ÂÜåÂà∞KVM‰∏≠ÂÆåÊàêGPAÂà∞HPAÁöÑÁøªËØëÔºõ</li>
</ul>
</li>
<li>FlatView‰øùÂ≠ò‰∫ÜMemoryRegionÊ†ëÂØπÂ∫îÁöÑÁ∫øÊÄßÁªìÊûÑFlatRangeÔºå‰æõQEMUÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫MemoryRegionSectionÊ≥®ÂÜåÂà∞KVM‰∏≠ÔºõËøò‰øùÂ≠ò‰∫ÜÂú∞ÂùÄÂàÜÊ¥æÂô®AddressSpaceDispatchÔºåË¥üË¥£Â∞ÜGPAÁøªËØë‰∏∫HVA„ÄÇ</li>
</ul>
<p>‰∏ã‰∏ÄËäÇÂ∞ÜÂ±ïÁ§∫ËøêË°åËøáÁ®ã‰∏≠Ëøô‰∫õÊï∞ÊçÆÁªìÊûÑÁöÑÁªÑÁªáÂΩ¢ÂºèÔºåÂèØ‰ª•ÊúâÊõ¥Âä†Áõ¥ËßÇÁöÑËÆ§ËØÜ„ÄÇ</p>
<h3 id="ÂÆûÈ™å-ÊâìÂç∞memoryregionÊ†ë">ÂÆûÈ™å: ÊâìÂç∞MemoryRegionÊ†ë
</h3><p>QEMU‰∏∫‰∫ÜÊ®°ÊãüMMIO‰ª•ÂèäÁâ©ÁêÜËÆæÂ§áÁöÑË°å‰∏∫ÔºåÂΩ¢Êàê‰∫Ü‰∏ÄÂ•óÂ§çÊùÇÁöÑÊï∞ÊçÆÁªìÊûÑÔºå‰ΩÜËøô‰∫õÂè™ÊòØÈùôÊÄÅÁöÑ‰ª£Á†Å„ÄÇÊú¨ËäÇÂ∞ÜQEMU‰ª£Á†ÅËøêË°åËµ∑Êù•ÔºåÂú®Âä®ÊÄÅËøáÁ®ã‰∏≠ÊâìÂç∞Âá∫MemoryRegionÊ†ëÔºåÊõ¥ÂΩ¢Ë±°Âú∞Â±ïÁ§∫Êï∞ÊçÆÁªìÊûÑ‰πãÈó¥ÁöÑÂÖ≥Á≥ª„ÄÇ</p>
<p>ÂÆûÈ™å‰ΩøÁî®‰ªéÊ∫ê‰ª£Á†ÅÁºñËØëÁöÑQEMU v4.1.1Ôºå‰ª•Âèä‰∫ãÂÖàÂáÜÂ§áÂ•ΩÁöÑÂÆ¢Êà∑Êú∫Á£ÅÁõòÈïúÂÉè‰Ωú‰∏∫QEMUÁöÑ-hdaÂèÇÊï∞‰º†ÈÄíÁªôQEMU„ÄÇÈ¶ñÂÖàÔºå‰ΩøÁî®Â¶Ç‰∏ãÂëΩ‰ª§ËøõÂÖ•QEMUÁõëËßÜÂô®Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200945365.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120094505324"
	
	
></p>
<blockquote>
<p>ÂêØÂä®ÂëΩ‰ª§ÁöÑÂê´‰πâ‰∏∫ÔºöÂ∞ÜQEMUÁÆ°ÁêÜÂô®ÁöÑËæìÂÖ•ËæìÂá∫ÈáçÂÆöÂêëÂà∞Â≠óÁ¨¶ËÆæÂ§ástdio(-monitor stdio)ÔºåÂç≥Ê≠§Â§ÑÁöÑÂëΩ‰ª§Ë°å„ÄÇ</p>
</blockquote>
<p>Ê≠§ÂëΩ‰ª§ÂêØÂä®‰∫Ü2‰∏™vCPU <code>-smp 2</code>Ôºå‰ΩøÁî®NUMAÔºàNon-Uniform Memory AccessÔºåÈùûÁªü‰∏ÄÂÜÖÂ≠òËÆøÈóÆÔºâÊû∂ÊûÑÔºåÂàÜ‰∏∫‰∏§‰∏™NUMAËäÇÁÇπ <code>-numa node</code>ÔºåÂàÜÈÖç 4 GBÁöÑ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠ò <code>-m 4096</code> ÔºõÂºÄÂêØKVMÊîØÊåÅÔºåÂπ∂‰ΩøÁî®‰∏éÂÆø‰∏ªÊú∫‰∏ÄÊ†∑ÁöÑCPUÂûãÂè∑ <code>-cpu host--enable-kvm</code>„ÄÇ</p>
<p>Êé•‰∏ãÊù•Ôºå‰ΩøÁî®ÂëΩ‰ª§ <code>info mtree</code> ÊâìÂç∞Ê≠§ÂÆ¢Êà∑Êú∫ÁöÑMemoryRegionÊ†ëÔºåÂú®ËæìÂá∫‰∏≠ÔºåQEMUÁî®‰∏çÂêåÂÆΩÂ∫¶ÁöÑÁº©ËøõË°®Á§∫‰∏çÂêåÊ†ëÁöÑÊ∑±Â∫¶ÔºåÊâìÂç∞Â¶Ç‰∏ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200950437.png" alt="image-20231120094846932" style="zoom: 50%;" />
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311200951306.png" alt="image-20231120094910362" style="zoom: 50%;" />
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201012555.png" alt="image-20231120095304414" style="zoom:50%;" />
<p>Ê≠§Â§ÑÁúÅÁï•‰∫ÜË¢´Ê†á‰∏∫ <code>[disabled]</code> ÁöÑMRÔºå‰ª•Âèä‰∏Ä‰∫õÈôåÁîüÁöÑMR„ÄÇÂèØ‰ª•ÁúãÂà∞ÔºåÊï¥‰∏™ËôöÊãüÊú∫Êúâaddress_space_memory‰Ωú‰∏∫Áâ©ÁêÜÂÜÖÂ≠òÁ©∫Èó¥ÁöÑASÔºåÊúâaddress_space_io‰Ωú‰∏∫PIOÁ´ØÂè£Êò†Â∞ÑÁ©∫Èó¥ÁöÑAS„ÄÇÁî±‰∫éÊú¨ÂÆûÈ™åÂêØÂä®‰∫Ü 2 ‰∏™vCPUÔºåÊâÄ‰ª•ËøôÈáåÊâìÂç∞Âá∫‰∫Ü‰∏§‰∏™CPUÁöÑASÔºåÂç≥ <code>cpu-memory-0/1</code>„ÄÇÂÖ∂‰ªñÁöÑASÂåÖÊã¨‰ªéËÆæÂ§áËßíÂ∫¶ÂèØ‰ª•ËßÇÂØüÂà∞ÁöÑASÔºåÂ¶Çe1000„ÄÅVGAÁ≠âËÆæÂ§áÁöÑAS„ÄÇ</p>
<p>ÊØè‰∏™AS‰∏ãÊòæÁ§∫‰∫ÜASÁöÑMRÊ†ëÔºåÂÖ∂‰∏≠ÈùûÂà´ÂêçÁ±ªÂûãÁöÑMRÂè™ËÉΩÊâìÂç∞Âá∫‰∏ÄÊù°ËæÉÁü≠ÁöÑËÆ∞ÂΩïÔºåÂåÖÂê´ÂÖ∂Âú∞ÂùÄËåÉÂõ¥„ÄÇÂ¶Çaddress_space_memoryÁöÑMRÊ†ëÊ†πsystem_memoryÔºåÂÖ∂Âú∞ÂùÄËåÉÂõ¥ÊòØ0x0000000000000000<del>0xffffffffffffffffÔºåÂç≥0</del>UINT64_MAXÔºõËÄåÂà´ÂêçMR‰ºöË¢´ÊòéÁ°ÆÊ†áËØÜ‰∏∫aliasÔºåÂπ∂ËøΩÂä†‰∏äÂÖ∂aliasÊåáÈíàÊåáÂêëÁöÑÂéüMR„ÄÇÊúâÂÖ≥ <code>info mtree</code> ÂëΩ‰ª§ÁöÑÂÆûÁé∞ÂáΩÊï∞ÔºåËØ∑Êü•ÈòÖQEMUÊ∫êÁ†ÅÊ†ëmemory.cÊñá‰ª∂ÁöÑ <code>mtree_info -&gt; mtree_print_mr</code> ÂáΩÊï∞„ÄÇ</p>
<p>‰∏∫‰∫Ü‰∏éÊ∫êÁ†ÅÁõ∏ÂØπÂ∫îÔºåÁªßÁª≠Âú®QEMUÊ∫êÁ†Å‰∏≠ÂØªÊâæËøô‰∫õASÂíåMRË¢´ÂàõÂª∫ÁöÑ‰ΩçÁΩÆÔºåÂÖ∑‰ΩìÊñπÊ≥ïÂ§öÁßçÂ§öÊ†∑„ÄÇ‰∏ÄÁßçÁõ¥Êé•ÁöÑÊñπÊ≥ïÊòØÂú®Ê∫êÁ†Å‰∏≠ÊêúÁ¥¢Áõ∏ÂÖ≥ÁöÑÂàõÂª∫ÂáΩÊï∞ÔºåÂ¶Ç <code>address_space_init</code>„ÄÅ<code>memory_region_init</code>ÔºåÊõ¥‰∏•Ë∞®ÁöÑÊñπÊ≥ïÊòØÈÄöËøáGDBÊâìÊñ≠ÁÇπÁöÑÊñπÂºèÂØªÊâæ„ÄÇ</p>
<p>È¶ñÂÖàÔºåÂú®QEMUÁöÑmainÂáΩÊï∞‰∏≠Ôºå<code>cpu_exec_init_all</code> ÂáΩÊï∞ÂàùÂßãÂåñ‰∫Ü‰∏ªË¶ÅÁöÑAS‰ª•ÂèäMRÊ†ëÊ†πÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/exec.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201012938.png" alt="image-20231120095411196" style="zoom:50%;" />
<p>Âú®ËøôÈáåÔºåQEMUÂàùÂßãÂåñ‰∫Ü <code>system_memory/system_io</code> Á≠âÈùôÊÄÅÂèòÈáèÔºå‰Ωú‰∏∫‰∏§‰∏™ÂÖ®Â±ÄASÂèòÈáè <code>address_space_memory/address_space_io</code> ÁöÑMRÊ†ëÊ†π„ÄÇËøôÈáåÂàùÂßãÂåñ‰∫Ü‰∏é‰ΩìÁ≥ªÁªìÊûÑÊó†ÂÖ≥ÁöÑASÔºå‰∏ãÈù¢ËøõÂÖ•i386ÁöÑÊ®°ÊãüÈÉ®ÂàÜ‰∏≠‰∏éÂàùÂßãÂåñÊû∂ÊûÑÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜ„ÄÇÂú®‰∏çÂêåÁ±ªÂûãÁöÑPC_MACHINEÁöÑÂÆö‰πâÂáΩÊï∞‰∏≠Ôºå‰πü‰ºöÂàùÂßãÂåñAS/MRÁ≠âÊï∞ÊçÆÁªìÊûÑÔºå‰ª• <code>pc_init1</code> ÂáΩÊï∞‰∏∫‰æãÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>qemu-4.1.1/hw/i386/pc_piix.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201006383.png" alt="image-20231120100602799" style="zoom: 33%;" />
<p>ÂèØ‰ª•ÁúãÂà∞Ôºå<code>pc_init1</code> ÂáΩÊï∞È¶ñÂÖàÂàùÂßãÂåñ‰∫ÜPCI MRÔºåÁªßÁª≠Ë∞ÉÁî® <code>pc_memory_init</code> ÂáΩÊï∞ÔºåÂàùÂßãÂåñ‰∫ÜÁúüÂÆûÁöÑÂÖ®Â±ÄÁâ©ÁêÜÂÜÖÂ≠òpc.ram MRÔºåÂπ∂Â∞ÜÂÖ∂ÂàÜ‰∏∫‰∏§‰∏™Âà´ÂêçMRÔºåÂç≥ <code>ram_below_4g/ram_above_4g</code>ÔºåÂπ∂‰Ωú‰∏∫Â≠êMRÂä†ÂÖ•‰∫Üsystem_memory„ÄÇ</p>
<p>Âú®Ëß£ÊûêQEMUÂèÇÊï∞Êó∂ÔºåQEMUËØªÂèñÂà∞ <code>-m</code> ÂèÇÊï∞ÂêéÁöÑÊï∞Â≠óÔºåÂπ∂Â∞ÜÂÖ∂‰øùÂ≠òÂú®machine-&gt;ram_size‰∏≠Ôºå‰Ωú‰∏∫ÂàùÂßãÂåñpc.ram MRÁöÑÂ§ßÂ∞èÔºåÂç≥Áâ©ÁêÜÂÜÖÂ≠òÁöÑÂ§ßÂ∞è„ÄÇÂú®ÂàÜÈÖçÂÖ®Â±Äpc.ram MRÊó∂ÔºåQEMUÂ∞ÜNUMAÂíåÈùûNUMAÁöÑÊÉÖÂÜµÂàÜÁ±ª„ÄÇÈùûNUMAÁöÑÊÉÖÂÜµ‰∏ãÔºåÁõ¥Êé•ÂàÜÈÖç‰∏Ä‰∏™RAMÁ±ªÂûãÁöÑÂÆû‰ΩìMRÂç≥ÂèØÔºõËÄåNUMAÊÉÖÂÜµ‰∏ãÔºåÈúÄË¶ÅË∞ÉÁî® <code>host_memory_backend_get_memory</code> ÂáΩÊï∞ÂæóÂà∞ÊØè‰∏™NUMAËäÇÁÇπÂØπÂ∫îÁöÑMRÔºåÂπ∂‰Ωú‰∏∫Â≠êMRÂä†ÂÖ•pc.ram MR‰∏≠„ÄÇËøô‰∏é‰πãÂâçinfo mtreeÊâìÂç∞Âá∫Êù•ÁöÑMRÊ†ëÁõ∏Á¨¶Âêà„ÄÇ</p>
<h2 id="33-kvmÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ">3.3 KVMÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ
</h2><p>Áõ∏ÊØî‰∫é ‚ÄúÁ≠ñÁï•‚Äù ÁöÑÂÆûÁé∞Ôºå‚ÄúÊú∫Âà∂‚Äù ÁöÑÂÆûÁé∞ÂæÄÂæÄÊõ¥Âä†ÁÆÄÂçï„ÄÇQEMUÂÜÖÂ≠òËôöÊãüÂåñÈúÄË¶ÅÂÆåÊàêÁöÑÂäüËÉΩËæÉÂ§öÔºåÂåÖÊã¨ÂÆø‰∏ªÊú∫ËôöÊãüÂÜÖÂ≠òÁöÑÂàÜÈÖç„ÄÅMMIOÁöÑÊ®°Êãü„ÄÅHVAÂà∞GPAÁöÑÁøªËØëÁ≠âÔºåËÄå**KVMÂÜÖÂ≠òËôöÊãüÂåñÂè™ÈúÄË¶ÅÁª¥Êä§Â•ΩEPTÈ°µË°®ÔºåÂπ∂‰∏éÁ°¨‰ª∂ÈÖçÂêàÂç≥ÂèØ„ÄÇ**ÂêåÊó∂ÔºåÁî±‰∫éKVMÊòØLinuxÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™ÂÜÖÊ†∏Ê®°ÂùóÔºåÂÆÉÂèØ‰ª•ÈáçÁî®LinuxÂÜÖÊ†∏ÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÊé•Âè£ÔºåÈôç‰Ωé‰∫ÜÂÆûÁé∞ÁöÑÈöæÂ∫¶„ÄÇ</p>
<p>Êú¨ËäÇ‰∏çËÆ®ËÆ∫Áî±‰∫éÊÄßËÉΩ‰∏ç‰Ω≥ËÄå‰∏çÂ∏∏ÈááÁî®ÁöÑÂΩ±Â≠êÈ°µË°®ÁöÑÂÆûÁé∞ÔºåÂè™ËÆ®ËÆ∫Intel x86Êû∂ÊûÑ‰∏ãÁöÑÊâ©Â±ïÈ°µË°®EPTÁöÑÁª¥Êä§„ÄÇÂú®LinuxÊ∫êÁ†ÅÊ†ëÁöÑDocumentationÁõÆÂΩï‰∏ãÔºåÊèèËø∞ÂÜÖÊ†∏‰ª£Á†ÅÁöÑ <code>Documentation/virtual/kvm/mmu.txt</code> ÊñáÊ°£ÊúâÂØπKVMÂÜÖÂ≠òÁÆ°ÁêÜÊ®°ÂùóËæÉ‰∏∫ÂÖ®Èù¢ËßÑËåÉÁöÑÊèèËø∞Ôºå‰ΩÜËæÉÈöæÁêÜËß£„ÄÇ‰∏ãÊñáÂ∞ÜÊäΩÂèñ‰∏ªÁ∫øÔºå‰ΩøÂèôËø∞Êõ¥ÊòìÊáÇ„ÄÇKVM‰∏≠Áõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÁªìÊûÑÁõ∏ÊØî‰∫éQEMUÊõ¥ÁÆÄÊ¥ÅÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201020455.png" alt="image-20231120101956361" style="zoom:50%;" />
<p>KVMÂú®ÂÜÖÂ≠òËôöÊãüÂåñÊñπÈù¢ÁöÑÂ∑•‰ΩúÊµÅÁ®ãÂ§ßËá¥‰∏∫Ôºö</p>
<blockquote>
<ol>
<li><strong>Êé•Êî∂QEMUÁöÑÂÜÖÂ≠òÊ≥®ÂÜåÔºõ</strong></li>
<li><strong>ÂàõÂª∫vCPUÁöÑËôöÊãüMMUÔºõ</strong></li>
<li><strong>EPTÁöÑÂª∫Á´ãÔºõ</strong></li>
</ol>
</blockquote>
<p>‰∏ãÈù¢ÂØπÊØè‰∏™Ê≠•È™§Â±ïÂºÄÂàÜÊûê„ÄÇ</p>
<h3 id="Êé•Êî∂qemuÁöÑÂÜÖÂ≠òÊ≥®ÂÜå">Êé•Êî∂QEMUÁöÑÂÜÖÂ≠òÊ≥®ÂÜå
</h3><p>È¶ñÂÖàÔºåQEMUÂ∫îËØ•ÁªôKVMÊ≥®ÂÜåÈúÄË¶ÅÂÖ∂ÂÅöÂú∞ÂùÄÁøªËØëÁöÑ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÔºåÂê¶ÂàôKVMÊâÄÁª¥Êä§ÁöÑEPTÈ°µË°®Â∞ÜÊó†Áî®Ê≠¶‰πãÂú∞ÔºåÂõ†Ê≠§‰ªéKVMÊé•Êî∂QEMUÁöÑÂÜÖÂ≠òÊ≥®ÂÜåÂºÄÂßãËÆ≤Ëµ∑„ÄÇ</p>
<p>ÂâçÊñáÊèêÂà∞ÔºåÂΩìMemoryRegionÊ†ëË¢´Êõ¥ÊîπÂêéÔºåÈÉΩ‰ºöÈÄöÁü•ÊâÄÊúâÁöÑlistenerÔºåÂÖ∂‰∏≠ÂåÖÊã¨KVMÁöÑÁõëÂê¨Âô®KVMMemoryListenerÔºåË∞ÉÁî®ioctlÂÆåÊàêKVMÂÜÖÂ≠òÊ≥®ÂÜå„ÄÇÊ≥®ÂÜåÁöÑÂü∫Êú¨Âçï‰ΩçÊòØÂ¶Ç‰∏ãÊï∞ÊçÆÁªìÊûÑÔºåÂåÖÂê´GPA„ÄÅHVA„ÄÅËØ•ÊÆµÂÜÖÂ≠òÁöÑÂ§ßÂ∞èÁ≠âÂ≠óÊÆµÔºå‰∏éQEMU‰∏≠ÁöÑÁ∫øÊÄßËßÜÂõæÁõ∏Á±ª‰ºº„ÄÇ</p>
<p>linux-4.19.0/include/uapi/linux/kvm.h</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201028306.png" alt="image-20231120102751204" style="zoom:50%;" />
<p>QEMUËøõË°åioctlÁ≥ªÁªüË∞ÉÁî®ÂêéËøõÂÖ•ÂÜÖÊ†∏ÁöÑ <code>kvm_vm_ioctl</code> ÂáΩÊï∞ÔºåÂπ∂Ê†πÊçÆioctlÁöÑÂèÇÊï∞Ë∞ÉÁî®Áõ∏Â∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞„ÄÇÊ≠§Êó∂ioctlÂèÇÊï∞ÊòØ<code>KVM_SET_USER_MEMORY_REGION</code>Ôºå‰ª£Á†ÅÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p>linux-4.19.0/virt/kvm/kvm_main.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201032062.png" alt="image-20231120103241360" style="zoom:50%;" />
<p>Áî±‰∫éQEMU‰∏≠ÁöÑkvm_userspace_memory_regionÂ§ÑÂú®Áî®Êà∑ÊÄÅÔºåÂõ†Ê≠§ÂÜÖÊ†∏ÊÄÅÁöÑKVMÈúÄË¶Å‰ΩøÁî® <code>copy_from_user</code> ÂáΩÊï∞Â∞ÜÂÖ∂‰∏≠ÁöÑÊï∞ÊçÆÂ§çÂà∂Âà∞ÂÜÖÊ†∏ÊÄÅ„ÄÇÊúÄÁªàËøõÂÖ• <code>__kvm_set_memory_region</code> ÂáΩÊï∞ÔºåÂ∞Ü <code>kvm_userspace_memory_region</code> Ê≥®ÂÜåÂà∞KVM‰∏≠ÔºåËÄåKVM‰∏≠‰øùÂ≠òÂÆ¢Êà∑Êú∫ÂÜÖÂ≠òÁ∫øÊÄßËßÜÂõæÁöÑÁªìÊûÑÊòØkvm_memory_regionÔºåÁî®Êà∑ÊÄÅQEMU‰º†Êù•ÁöÑÊï∞ÊçÆÈúÄË¶ÅËΩ¨Âåñ‰∏∫ËØ•Êï∞ÊçÆÁªìÊûÑËøõË°å‰øùÂ≠òÔºåÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>linux-4.19.0/include/linux/kvm_host.h</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201036546.png" alt="image-20231120103633794" style="zoom:50%;" />
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÊØè‰∏™KVMËôöÊãüÊú∫ÂØπÂ∫îÁöÑstruct kvmÁªìÊûÑ‰ΩìÈÉΩ‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™memslotsÔºåÂÖ∂‰∏≠‰øùÂ≠ò‰∫Ükvm_memory_slotÁöÑÊï∞ÁªÑ„ÄÇËøôÊòØKVM‰∏≠ÂîØ‰∏Ä‰øùÂ≠òÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µ‰ø°ÊÅØÁöÑ‰ΩçÁΩÆÔºå‰∏éQEMU‰∏çÂêåÔºåKVM‰ªÖÊúâ‰∏Ä‰∏™ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÁöÑÁ∫øÊÄßËßÜÂõæÔºå‰øùÂ≠ò‰∫ÜÊâÄÊúâÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØ„ÄÇ</p>
<p>Âú®ËøõÂÖ•KVMÁöÑÂÜÖÂ≠òÊ≥®ÂÜåioctlÂêéÔºå<code>_kvm_set_memory_region</code> ÂáΩÊï∞Â∞Ü‰ΩøÁî®Áî®Êà∑ÊÄÅ‰º†Êù•ÁöÑÁªìÊûÑ‰Ωìkvm_userspace_memory_regionÊõ¥Êñ∞kvmÁöÑmemslotsÔºåÊõ¥Êñ∞Á±ªÂûã‰∏∫enum kvm_mr_change„ÄÇ<code>__kvm_set_memory_region</code> ÂáΩÊï∞ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>linux-4.19.0/virt/kvm/kvm_main.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201039908.png" alt="image-20231120103944164" style="zoom:50%;" />
<p>ËØ•ÂáΩÊï∞È¶ñÂÖàÂæóÂà∞Ë¶ÅÊèíÂÖ•‰ΩçÁΩÆÁöÑÊóßmemslotÔºå‰∏éÁî®Êà∑ÊÄÅ‰º†Êù•ÁöÑÊñ∞memslotÂØπÊØîÔºåÂæóÂá∫changeÁöÑÁ±ªÂûã„ÄÇÂ¶ÇÊûúQEMUÊ∑ªÂä†Êñ∞ÁöÑmemslotÔºåÈÇ£‰πàÂ∞±‰ºöËøõÂÖ•KVM_MR_CREATEÁöÑÂàÜÊîØÔºåÊâßË°åÊû∂ÊûÑÁõ∏ÂÖ≥ÂáΩÊï∞ <code>kvm_arch_create_memslot</code> Â°´ÂÖÖÊñ∞ÁöÑmemslot„ÄÇÂáÜÂ§áÂ•ΩÊñ∞ÁöÑmemslotÂêéÔºåÂ∞±Ë∞ÉÁî®<code>update_memslots</code> ÂáΩÊï∞Â∞ÜÊñ∞memslotÂ°´ÂÖ•slotsÊï∞ÁªÑÔºåÂπ∂‰øùÊåÅÊï∞ÁªÑÁöÑÊéíÂ∫èÔºàbase_gfn‰ªéÂ§ßÂà∞Â∞èÔºâÔºåÊúÄÁªàÂéüÂ≠êÂú∞Â∞ÜslotsÂ°´ÂÖ•kvm‰∏≠„ÄÇ</p>
<p>KVMÁª¥Êä§x86Êû∂ÊûÑÁõ∏ÂÖ≥ÁöÑÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µ‰ø°ÊÅØÔºåÂåÖÂê´ <code>kvm_rmap_head</code> ‰ª•Âèä <code>kvm_lpage_info</code>Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201044844.png" alt="image-20231120104356841" style="zoom:50%;" />
<p>ÈíàÂØπx86Êû∂ÊûÑÔºåÊØè‰∏™ÂÆ¢Êà∑Êú∫ÁöÑ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÈ°µÈÉΩÊúâÁõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØÔºå‰øùÂ≠òÂú®memslotÁöÑarchÊàêÂëò‰∏≠„ÄÇEPT‰∏≠ÊúÄÂêé‰∏ÄÁ∫ßÈ°µË°®ÂèØ‰ª•ÊòØÁ¨¨3Á∫ßÈ°µË°®ÔºåÊò†Â∞Ñ‰∏Ä‰∏™1GBÁöÑÂ§ßÈ°µÔºõÂèØ‰ª•ÊòØÁ¨¨2Á∫ßÈ°µË°®ÔºåÊò†Â∞Ñ‰∏Ä‰∏™2MBÁöÑÂ§ßÈ°µÔºõ‰πüÂèØ‰ª•ÊòØÈÄöÂ∏∏ÊÉÖÂÜµÁöÑÁ¨¨1Á∫ßÈ°µË°®ÔºåÊò†Â∞Ñ‰∏Ä‰∏™4KBÁöÑÈ°µ„ÄÇÂõ†Ê≠§Âú®archÁªìÊûÑ‰Ωì‰∏≠ÔºåKVMÂ∞ÜmemslotÁÆ°ÁêÜÁöÑËøôÊÆµ‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÂÜÖÂ≠òÊåâÁÖß‰∏çÂêåÂ§ßÂ∞èÁöÑÈ°µÈù¢ÂàÜÂâ≤ÔºåÂÖ±‰∏äËø∞3ÁßçÊÉÖÂÜµ(1GB„ÄÅ2MB„ÄÅ4KB)ÔºåÂΩ¢Êàê‰∏çÂêå‰∏™Êï∞ÁöÑÈ°µÈù¢ÔºàÂ¶Ç1GBÁöÑÂÜÖÂ≠òÂå∫ÂüüÊåâÁÖß1GBÂàÜÂâ≤ÔºåÂàôÂè™Êúâ1È°µÔºõÊåâÁÖß2MBÂàÜÂâ≤ÔºåÂàôÊúâ512È°µÔºâ„ÄÇ‰∏ãÈù¢‰ª£Á†ÅÂ°´ÂÖÖÊØè‰∏™È°µÈù¢ÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂàÜ‰∏∫KVM_NR_PAGE_SIZESÁßçÈ°µÈù¢Â§ßÂ∞èÁöÑÊÉÖÂÜµ„ÄÇ</p>
<p>linux-4.19.0/arch/x86/kvm/x86.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201048662.png" alt="image-20231120104808573" style="zoom:50%;" />
<p>ËøôÈáåÔºåÊØè‰∏™‚ÄúËôöÊãü‚ÄùÁâ©ÁêÜÈ°µÈÉΩÊúâ‰∏§‰∏™‰ø°ÊÅØÔºö</p>
<ol>
<li>Êò†Â∞ÑËØ•gfnÁöÑÊâÄÊúâspteÔºàEPTÈ°µË°®È°πÔºâÔºå‰øùÂ≠òÂú®arch.rmapÊï∞ÁªÑ‰∏≠ÔºåÂèØ‰ª•‰ª•spteÈìæË°®ÁöÑÂΩ¢ÂºèÂ≠òÂú®ÔºåÊØè‰∏™È°µÈù¢ÈÉΩÊúâÂØπÂ∫îÁöÑÈìæË°®„ÄÇËØ•ÈìæË°®Ë¥üË¥£Âú®ÊüêHVAÂ§ÑÁöÑÈ°µÈù¢Ë¢´Êç¢Âá∫Êó∂ÔºåÂ∞ÜÊâÄÊúâ‰∏éËØ•HVAÂØπÂ∫îÁöÑspteÁΩÆ‰∏∫Êó†Êïà„ÄÇËøôÁßçÂèçÂêëÊò†Â∞ÑÊú∫Âà∂Âú®LinuxÂÜÖÊ†∏‰∏≠‰πüÂ≠òÂú®Ôºõ</li>
<li>‰øùÂ≠òËØ•gfnÂ§ÑÊòØÂê¶ÂèØ‰ª•‰ΩøÁî®Â§ßÈ°µÔºå‰∏çÂÅöÊ∑±ÂÖ•ÂàÜÊûê„ÄÇ</li>
</ol>
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåKVMÂ∑≤Áªè‰øùÂ≠ò‰∫ÜÊâÄÊúâÂÆ¢Êà∑Êú∫ ‚ÄúËôöÊãü‚Äù Áâ©ÁêÜÂÜÖÂ≠òÈ°µÈù¢ÁöÑ‰ø°ÊÅØÔºåÂ≠òÂú®‰∫émemslotsÊàêÂëò‰∏≠ÔºåKVMÁª¥Êä§EPTÈ°µË°®Êó∂Â∞ÜÂÆåÂÖ®Âü∫‰∫émemslotsÊï∞ÊçÆÁªìÊûÑ„ÄÇ‰∏ãÈù¢ÂàÜÊûê<strong>KVMÂ¶Ç‰ΩïÁª¥Êä§EPTÈ°µË°®Ôºå‰∏éMMUÁ°¨‰ª∂ÂçèÂêåÂÆåÊàêÂú∞ÂùÄÁøªËØë„ÄÇ</strong></p>
<h3 id="ÂàõÂª∫vcpuÁöÑËôöÊãümmu">ÂàõÂª∫vCPUÁöÑËôöÊãüMMU
</h3><p>ÁªßÁª≠‰ªãÁªçEPTÈ°µË°®È°µÁöÑÂàõÂª∫‰∏éÁÆ°ÁêÜÔºåËôöÊãüMMUÁõ∏ÂÖ≥Êï∞ÊçÆÁªìÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201106754.png" alt="image-20231120110134211" style="zoom: 33%;" />
<p>ÂÖ∂‰∏≠ÈúÄË¶ÅÁùÄÈáçÂÖ≥Ê≥®ÁöÑÊòØ <code>struct kvm_mmu_page</code>ÔºåÂÆÉÁÆ°ÁêÜ‰∫Ü‰∏Ä‰∏™EPTÈ°µË°®È°µÁöÑÊâÄÊúâ‰ø°ÊÅØÔºåvCPUËôöÊãüMMUÁöÑ‰∏ªË¶ÅÂ∑•‰ΩúÊòØÁª¥Êä§EPTÈ°µË°®‰∏≠ÊØè‰∏™È°µË°®È°µÁöÑ <code>struct kvm_mmu_page</code>„ÄÇ</p>
<p>**‰∏∫‰∫ÜÁÆ°ÁêÜEPTÈ°µË°®È°µÔºåKVM‰ΩøÁî®‰∫Ü <code>struct kvm_mmu_page</code> Êï∞ÊçÆÁªìÊûÑ‰øùÂ≠ò‰∏Ä‰∏™EPTÈ°µË°®È°µÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂèà‰ΩøÁî® <code>struct kvm_mmu</code> Êï∞ÊçÆÁªìÊûÑ‰øùÂ≠ò‰∏éÂÜÖÂ≠òÁÆ°ÁêÜÁõ∏ÂÖ≥ÁöÑÂáΩÊï∞Ê®°ÊãüÁ°¨‰ª∂MMU„ÄÇ**ÊØè‰∏™vCPUÈÉΩÊúâ‰∏Ä‰∏™ËôöÊãüÁöÑMMUÔºå‰∏îMMUÁöÑÊ®°Êãü‰æùËµñÊû∂ÊûÑÔºåÂõ†Ê≠§‰øùÂ≠òÂú® <code>struct kvm_vcpu_arch</code> Êï∞ÊçÆÁªìÊûÑ‰∏≠„ÄÇ</p>
<blockquote>
<p>Ê≥®ÊÑèÂå∫ÂàÜÔºå<code>struct kvm_arch</code> ‰øùÂ≠ò‰∫ÜÊï¥‰∏™ÂÆ¢Êà∑Êú∫ÁöÑÊû∂ÊûÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåËÄå <code>struct kvm_vcpu_arch</code> ‰øùÂ≠ò‰∫ÜÊØè‰∏™vCPUÁöÑÊû∂ÊûÑÁõ∏ÂÖ≥‰ø°ÊÅØ„ÄÇÁÆÄËÄåË®Ä‰πãÔºåËôöÊãüMMU‰øùÂ≠òÂú®vCPUÁöÑÊû∂ÊûÑÁõ∏ÂÖ≥ÈÉ®ÂàÜ‰∏≠ÔºåËôöÊãüMMUÁöÑroot_hpaÊåáÂêëkvm_mmu_pageÔºàÂêéÊñá‰ªãÁªçÔºâÁªÑÊàêÁöÑÈ°µË°®„ÄÇ</p>
</blockquote>
<p>‰ª•‰∏ã‰∏∫Ëøô‰∫õÊï∞ÊçÆÁªìÊûÑÁöÑ‰ª£Á†ÅÔºö</p>
<p>linux-4.19.0/arch/x86/include/asm/kvm_host.h</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201056873.png" alt="image-20231120105633719" style="zoom:50%;" />
<p>Âú®KVM‰∏≠Êúâ‰∏Ä‰∏™ÂÖ®Â±ÄÂèòÈáè <code>enable_ept</code> ÂÜ≥ÂÆöÊòØÂê¶ÂºÄÂêØEPTÊ®°Âºè„ÄÇÂ¶ÇÊûú <code>enable_ept</code> ‰∏∫1ÔºåÂàôÂêØÁî®EPTÊ®°ÂºèÔºåÊúÄÁªàÂ∞ÜÂÖ®Â±ÄÂèòÈáè <code>tdp_enabled</code>ÔºàÂú®arch/x86/kvm/mmu.c‰∏≠ÔºâÁΩÆ‰∏∫true„ÄÇ‰∫ãÂÆû‰∏äËøòÈúÄË¶ÅËØªÂèñVMCSÁöÑÁõ∏ÂÖ≥ÈÖçÁΩÆÂüüÊâçËÉΩÂÜ≥ÂÆöÊòØÂê¶Â∞Ü <code>enable_ept</code> ÁΩÆ‰∏∫1ÔºåÁÆÄÊ¥ÅËµ∑ËßÅÊú¨ËäÇÁúÅÁï•ËøôÈÉ®ÂàÜÁöÑ‰ªãÁªç„ÄÇ‰∏ãÈù¢ÊòØÂ∞Ü <code>tdp_enable</code> ÁΩÆ‰∏∫trueÁöÑ‰ª£Á†Å„ÄÇ</p>
<p>linux-4.19.0/arch/x86/kvm/vmx.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201058055.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120105851025"
	
	
></p>
<p>Âú®Ê≠§‰πãÂêéÂàõÂª∫vCPUÊó∂ÔºåÂ∞ÜÂÆåÊàêÂü∫‰∫éEPTÔºàÂç≥tdpÔºâÁöÑËôöÊãüMMUÂàùÂßãÂåñ„ÄÇËôöÊãüMMUÁöÑÂàùÂßãÂåñÂàÜ‰∏∫ <code>kvm_mmu_create/kvm_mmu_setup</code> ‰∏§Ê≠•Ôºö</p>
<blockquote>
<ul>
<li><strong>ËôöÊãüMMUÂàõÂª∫</strong></li>
<li><strong>EPTÂü∫Âú∞ÂùÄËÆæÁΩÆ</strong></li>
</ul>
</blockquote>
<h4 id="mmuÂàõÂª∫ÊµÅÁ®ã">MMUÂàõÂª∫ÊµÅÁ®ã
</h4><p>Êï¥‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201125425.png" alt="image-20231120112458962" style="zoom: 33%;" />
<p>ËôöÊãüMMUÁöÑÂàùÂßãÂåñ‰∏évCPUÁöÑÂàùÂßãÂåñÁªëÂÆöÔºåÂç≥‰∏Ä‰∏™vCPUÊúâ‰∏Ä‰∏™ËôöÊãüMMU„ÄÇÂèØ‰ª•ÁúãÂà∞ÔºåËôöÊãüMMU‰∫ãÂÆû‰∏äÂåÖÂê´‰∫Ü‰∏ÄÁªÑ‰∏étdpÁõ∏ÂÖ≥ÁöÑÈ°µË°®ÁÆ°ÁêÜÂáΩÊï∞ÔºåÂåÖÊã¨Áº∫È°µÂºÇÂ∏∏Â§ÑÁêÜÂáΩÊï∞ <code>tdp_page_fault</code>„ÄÅÈ°µË°®Âü∫Âú∞ÂùÄËÆæÁΩÆÂáΩÊï∞ <code>set_tdp_cr3</code>ÔºàÂç≥ <code>vmx_set_cr3</code>ÔºâÔºå‰ª•ÂèäËôöÊãüMMUÁöÑÁõ∏ÂÖ≥Â±ûÊÄßÁöÑËÆæÁΩÆ„ÄÇ</p>
<p>ÂÆåÊàêËôöÊãüMMUÁöÑÂàõÂª∫ÂêéÔºå‰∏ãÊñá‰ªãÁªçKVMÂ¶Ç‰ΩïÁª¥Êä§ <code>EPTP</code> ÂíåÂÆ¢Êà∑Êú∫ <code>CR3</code>„ÄÇ</p>
<h4 id="eptÂü∫Âú∞ÂùÄËÆæÁΩÆÊµÅÁ®ã">EPTÂü∫Âú∞ÂùÄËÆæÁΩÆÊµÅÁ®ã
</h4><p>EPTÈ°µË°®È°µ <code>kvm_mmu_page</code> ‰∏éÊôÆÈÄöËøõÁ®ãÁöÑÈ°µË°®È°µ‰∏ÄÊ†∑ÔºåÂú®Áº∫È°µÂºÇÂ∏∏‰∏≠ÂàõÂª∫„ÄÇ‰ΩÜËøô‰∏çÊòØ‰∏ÄËà¨ÁöÑÁº∫È°µÂºÇÂ∏∏ÔºåËÄåÊòØÂÆ¢Êà∑Êú∫ÂºïÂèëÁöÑVM-ExitÔºåÊòØ‰∏Ä‰∏™Áî±IntelÁ°¨‰ª∂Êèê‰æõÁöÑÁâπÊÄßÔºåÂç≥ <code>EPT PAGE FAULT</code>„ÄÇËØ•VM-ExitÂ∞Ü‰ΩøÂÆ¢Êà∑Êú∫ÊöÇÂÅúÊâßË°åÂπ∂ËøõÂÖ•KVMÔºå‰ΩøÂæóKVMÊúâÊú∫‰ºöÂÆåÂñÑEPT„ÄÇ‰∏∫‰∫ÜÈÖçÂêàÁ°¨‰ª∂ÔºåKVMÈúÄË¶ÅÂ∞ÜEPTÁöÑÂü∫Âú∞ÂùÄÂÜôÂÖ•VMCSÔºåËÆ©Á°¨‰ª∂MMUËá™Âä®ËÆøÈóÆËØ•EPTÈ°µË°®Ôºå<strong>ÂΩìÁ°¨‰ª∂MMUÂèëÁé∞ËØ•È°µË°®Â≠òÂú®‰∏çÂÆåÊï¥ÁöÑÊÉÖÂÜµÊó∂ÔºåÂ∞Ü‰∫ßÁîüVM-ExitÔºåÂπ∂Ë∞ÉÁî®ËôöÊãüMMUÁöÑÁõ∏ÂÖ≥ÂáΩÊï∞„ÄÇ</strong></p>
<p>Êé•‰∏äÊñáÂØπVMÊñá‰ª∂ÊèèËø∞Á¨¶ÁöÑ <code>KVM_CREATE_VCPU</code> Ë∞ÉÁî®ÔºåQEMUÂ∞ÜÂØπvCPUÂØπÂ∫îÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶ËøõË°å <code>KVM_RUN</code> Ë∞ÉÁî®ÔºåËøêË°åÂàöÂàöÂàùÂßãÂåñÂπ∂Â°´ÂÖÖÂ•ΩÁöÑvCPUÔºåÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201317672.png" alt="image-20231120131634430" style="zoom: 50%;" />
<p>ÂèØ‰ª•ÁúãÂà∞Ôºå<code>vcpu_run</code> ÂáΩÊï∞‰∏≠Âá∫Áé∞‰∫ÜÊó†ÈôêforÂæ™ÁéØÔºå‰øùËØÅÂú®ËøêË°åvCPUÈÄÄÂá∫ÂêéÔºåÂÆåÊàêKVMÁöÑÂ§ÑÁêÜÁªßÁª≠ËøêË°åvCPU„ÄÇÂú®ËØ•Âæ™ÁéØ‰∏≠ÔºåËøêË°åvCPUÂâçË∞ÉÁî®<code>kvm_mmu_reload</code> ÂáΩÊï∞ÔºåÂ¶ÇÊûúroot_hpaÂ∞öÊú™ÂàùÂßãÂåñÔºàÊåáÂêëINVALID_PAGEÔºâÔºåÂàôË∞ÉÁî® <code>kvm_mmu_load</code> ÂáΩÊï∞ÂàùÂßãÂåñroot_hpaÔºåÂÖ∂ÂàùÂßãÂåñÂ∑•‰Ωú‰∏ªË¶ÅÂåÖÊã¨Ôºö</p>
<ol>
<li>Ë∞ÉÁî® <code>mmu_topup_memory_caches</code> ÂáΩÊï∞‰øùËØÅarch‰∏≠ÁöÑ 3 ‰∏™cacheÂÖÖË∂≥Ôºõ</li>
<li>‰∏∫root_hpaÂàÜÈÖç‰∏Ä‰∏™kvm_mmu_pageÔºå‰Ωú‰∏∫EPTÁöÑÁ¨¨4Á∫ßÈ°µË°®È°µÔºåÈ°µË°®È°µÁöÑÂàÜÈÖçÂ∞ÜÂú®‰∏ãÊñá‰ªãÁªçÔºõ</li>
<li>Ê†πÊçÆ‰∏ä‰∏ÄÊ≠•ÂàÜÈÖçÁöÑEPTÁ¨¨4Á∫ßÈ°µË°®È°µÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÂàõÂª∫EPTPÔºåÂÜôÂÖ•VMCSÁöÑEPTPÂüü‰∏≠ÔºåEPTPÂüüÁöÑËØ¶ÁªÜÊñáÊ°£ËßÅIntel SDMÁöÑÂç∑3Á¨¨24.6.11ËäÇÔºõËøòË¶Å‰ªéarchÁªìÊûÑ‰∏≠ËØªÂèñÂÆ¢Êà∑Êú∫CR3ÔºåÂÜôÂÖ•VMCSÁöÑGUEST_CR3Âüü‰∏≠„ÄÇËøôÊ†∑Âú®Áâ©ÁêÜCPUËøõÂÖ•ÈùûÊ†πÊ®°ÂºèÂêéÔºåÂ∞±ÂèØ‰ª•‰ΩøÁî®ËØ•EPTPËøõË°åGPAÂà∞HPAÁöÑÁøªËØëÔºõ</li>
<li>Âà∑Êñ∞TLBÔºåÊúâ‰∏âÁßçÊñπÂºèÔºå‰∏çËØ¶ÁªÜ‰ªãÁªç„ÄÇ</li>
</ol>
<p>Áªº‰∏äÔºåKVMÂ∑≤ÁªèÂáÜÂ§áÂ•ΩËøõÂÖ•ÈùûÊ†πÊ®°ÂºèÔºåÊâßË°å <code>kvm_x86_ops-&gt;run</code> ÂáΩÊï∞„ÄÇ‰∏ãÈù¢‰ªãÁªçEPTÈ°µË°®È°µÂèäÂÖ∂ÂàõÂª∫ËøáÁ®ãÔºåEPTÈ°µË°®ÁöÑÂàõÂª∫ÂíåÁª¥Êä§ËøáÁ®ãÂùáÂú®<code>kvm_x86_ops-&gt;handle_exit</code> ÂáΩÊï∞‰∏≠ËøõË°å„ÄÇ</p>
<h3 id="eptÁöÑÂª∫Á´ã">EPTÁöÑÂª∫Á´ã
</h3><p>KVM‰ªéQEMUÂæóÂà∞‰∫ÜÈúÄË¶ÅGPAÂà∞HPAÁøªËØëÁöÑÊâÄÊúâ <code>kvm_memory_slots</code>ÔºåËÆæÁΩÆÂ•ΩEPTPÂêéÔºåMMUÁ°¨‰ª∂Â∞±ÂèØ‰ª•Êà™Ëé∑GPAÂú∞ÂùÄÁöÑËÆøÈóÆÔºå‰ΩøÂÆ¢Êà∑Êú∫ÈÄÄÂá∫Âà∞KVM‰∏≠ÔºåÂª∫Á´ãGPAÁõ∏ÂÖ≥ÁöÑEPTÈ°µË°®„ÄÇËøôÈáå‰ªãÁªçEPTÁöÑÂª∫Á´ã‰∏éÁÆ°ÁêÜÔºåÈ¶ñÂÖà‰ªãÁªçÁÆ°ÁêÜEPTÈ°µË°®È°µÁöÑÊï∞ÊçÆÁªìÊûÑ <code>kvm_mmu_page</code>ÔºåÂÆÉÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>linux-4.19.0/arch/x86/include/asm/kvm_host.h</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201328919.png" alt="image-20231120132759035" style="zoom:50%;" />
<p>ËØ•ÁªìÊûÑÁª¥Êä§‰∫Ü‰∏Ä‰∏™ <code>spt</code> ÊåáÈíàÂÖ≥ËÅîÁöÑ‰ø°ÊÅØÔºå<code>spt</code> ÊòØÊåáÂêëÈ°µË°®È°µÁöÑÊåáÈíàÔºåÊòØ‰∏Ä‰∏™HVA„ÄÇ<code>spt</code> ÊåáÂêëÁöÑ4KBÂ§ßÂ∞èÁöÑÈ°µÈù¢Âç≥ÊòØEPTÈ°µË°®È°µÔºå‰øùÂ≠ò‰∫Ü512‰∏™È°µË°®È°π„ÄÇKVMÂú® <code>struct kvm_arch</code> ‰∏≠‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™active_mmu_pagesÈìæË°®ÔºåÂ∞ÜÊâÄÊúâÁöÑkvm_mmu_pageÈìæÊé•Ëµ∑Êù•ÔºåÂèØ‰ª•ÂΩìÈ°µË°®È°µÁâàÊú¨Âè∑mmu_valid_gen‰∏éarch‰∏≠ÁöÑmmu_valid_gen‰∏çÂêåÊó∂ÔºåÈáäÊîæÈ°µË°®È°µÔºàÈÄöËøáÂÖ∂Êìç‰ΩúÊé•Âè£ <code>kvm_mmu_free_page</code> ÂáΩÊï∞Ôºâ„ÄÇËøôÊ†∑KVMÂ∞±ÂÅöÂà∞‰∫ÜÂÜÖÂ≠òÂç†Áî®Â∞ΩÂèØËÉΩÂ∞èÔºåËøôÂíåmmu.txtÊñáÊ°£‰∏≠KVMÂÜÖÂ≠òËôöÊãüÂåñËÆæËÆ°ÂéüÂàôÁõ∏Á¨¶Âêà„ÄÇ</p>
<p>ÂàõÂª∫È°µË°®È°µÁöÑÊó∂Êú∫Âú®‰∫éÂèëÁîüEPT ViolationÊó∂ÔºåCPUËøõÂÖ•Ê†πÊ®°ÂºèËøêË°åKVM„ÄÇÂú®ËøôÈáåÔºåKVMÊâßË°åÂ¶Ç‰∏ãËôöÊãüMMUÁöÑÁº∫È°µÂºÇÂ∏∏Â§ÑÁêÜÂáΩÊï∞Ôºö</p>
<p>linux-4.19.0/arch/x86/kvm/mmu.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201330527.png" alt="image-20231120132909811" style="zoom: 33%;" />
<p>ÈÄÄÂá∫ÂéüÂõ†ÊòØEXIT_REASON_EPT_VIOLATIONÔºå‰∫éÊòØË∞ÉÁî® <code>handle_ept_violation</code> ÂáΩÊï∞„ÄÇVMCS‰øùÂ≠ò‰∫ÜËØ•Áº∫È°µÂºÇÂ∏∏ÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂåÖÊã¨ÈÄ†ÊàêÁº∫È°µÂºÇÂ∏∏ÁöÑgpa„ÄÅÁº∫È°µÂºÇÂ∏∏ÁöÑÁ±ªÂûãerror_codeÁ≠â„ÄÇÂ¶ÇÊûúerror_codeË°®Á§∫ÈúÄË¶ÅÂ§ÑÁêÜMMIOÁ±ªÂûãÁöÑEPT ViolationÔºåÂàôË∞ÉÁî® <code>handle_mmio_page_fault</code> ÂáΩÊï∞„ÄÇÂú®EPTÈ°µË°®Áº∫È°µÁöÑÊÉÖÂÜµ‰∏ãÔºåË∞ÉÁî® <code>tdp_page_fault</code> ÂáΩÊï∞ÂÆåÂñÑEPT„ÄÇ</p>
<blockquote>
<p>ËøôÈáåÂøΩÁï•ÊâÄÊúâ‰∏éÂ§ßÈ°µÁõ∏ÂÖ≥ÁöÑ‰ª£Á†ÅÔºåÊÑüÂÖ¥Ë∂£ÁöÑËØªËÄÖÂèØ‰ª•Âú®‰ªãÁªçÁöÑÂü∫Á°Ä‰∏äÁ†îÁ©∂Â§ßÈ°µÁõ∏ÂÖ≥‰ª£Á†ÅÔºåËøõË°å‚ÄúÂ¢ûÈáèÂºè‚ÄùÂ≠¶‰π†„ÄÇ</p>
</blockquote>
<p><code>tdp_page_fault</code> ÂáΩÊï∞‰∏ªË¶Å‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>linux-4.19.0/arch/x86/kvm/mmu.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201331653.png" alt="image-20231120133039954" style="zoom:33%;" />
<p><code>tdp_page_fault</code> ÂáΩÊï∞ËæÉ‰∏∫Â§çÊùÇÔºåÊ∂âÂèäÂ§ö‰∏™LinuxÂÜÖÊ†∏Â≠êÁ≥ªÁªüÔºå‰∏ãÈù¢ÂàÜÊ≠•‰ªãÁªç„ÄÇ</p>
<ol>
<li>
<p>ËØ•ÂáΩÊï∞È¶ñÂÖàÂ°´ÂÖÖ‰∏â‰∏™ÁºìÂ≠òÊ±†ÔºåÊØèÊ¨°È¢ÑÂàÜÈÖçÈÉΩÂàÜÂà´Â¢ûÂä†16„ÄÅ8„ÄÅ4‰∏™È¢ÑÂ§áÁöÑÂØπË±°„ÄÇËøô‰∏â‰∏™ÁºìÂ≠òÊ±†ÂàÜÂà´Áî®‰∫épteÈìæË°®ÔºàÂèçÂêëÊò†Â∞Ñ‰∏≠‰∏Ä‰∏™gfnÂØπÂ∫îÁöÑÊâÄÊúâpteÁöÑÈìæË°®Ôºå‰ª•Âèä‰∏Ä‰∏™pteÁöÑparent_ptesÈìæË°®Ôºâ„ÄÅEPTÈ°µË°®È°µ„ÄÅEPTÈ°µË°®È°µÂ§¥ÔºàÂç≥ÊèèËø∞EPTÈ°µË°®È°µÁöÑstruct kvm_mmu_pageÔºâÁöÑÂàÜÈÖçÔºåËøô‰∏âÁ±ªÂØπË±°ÁöÑÂàÜÈÖçÂú®KVM‰∏≠ÂæàÈ¢ëÁπÅÔºåÂõ†Ê≠§ÁºìÂ≠òÊ±†ËÉΩÂ§üÈÄöËøáÂêàÂπ∂ÂàÜÈÖçÊèêÈ´òÂàÜÈÖçÊïàÁéá„ÄÇ</p>
</li>
<li>
<p>ËøôÈáåÂøΩÁï•Â§ßÈ°µÁÆ°ÁêÜÁ≥ªÁªüÔºåÂÅáÂÆöEPT‰∏≠‰∏çÊò†Â∞ÑÂ§ßÈ°µÔºåmapping_levelÂáΩÊï∞Â∞ÜËøîÂõû1„ÄÇÊé•‰∏ãÊù•ÔºåÂ∞ùËØïÁº∫È°µÂºÇÂ∏∏Â§ÑÁêÜÁöÑÂø´ÈÄüË∑ØÂæÑÔºåË∞ÉÁî®fast_page_faultÂáΩÊï∞„ÄÇÊ≠§ÂáΩÊï∞ÂíåKVMËÑèÈ°µÁÆ°ÁêÜÁ≥ªÁªüÊúâÂÖ≥ÔºåÂõûÂøÜÂΩìQEMUÊ≥®ÂÜåmemslotÊó∂ÔºåÂèØ‰ª•‰ΩøÁî®KVM_MEM_LOG_DIRTY_PAGESÊ†áÂøóÔºåÂÆÉË°®Á§∫ÈúÄË¶ÅÂØπËøôÊÆµÂÜÖÂ≠òËøõË°åËÑèÈ°µË∑üË∏™ÔºåÂ§öÁî®‰∫éQEMUËôöÊãüÊú∫ÁÉ≠ËøÅÁßªÁöÑÂÆûÁé∞„ÄÇÂΩìQEMU‰ΩøÁî®ËØ•Ê†áÂøóËøõË°åÂÜÖÂ≠òÊ≥®ÂÜåÊó∂ÔºåKVMÂ∞Ü‰ºöÊääËøôÊÆµÂÜÖÂ≠òÂØπÂ∫îÁöÑÊâÄÊúâEPTË°®È°πÁΩÆ‰∏∫Âè™ËØªÔºåËøôÊ∂âÂèäÂÜÖÂ≠òÈ°µÁöÑÂèçÂêëÊò†Â∞ÑÁ≥ªÁªü„ÄÇ‰∫éÊòØÔºåËØ•È°µË°®È°πÊåáÂêëÁöÑÁâ©ÁêÜÈ°µÂ∑≤ÁªèÂàÜÈÖçÔºåÂè™ÈúÄË¶ÅÂ∞ÜËØ•È°µË°®È°π‰øÆÊîπ‰∏∫ÂèØÂÜôÂ∞±ÂèØÁªßÁª≠Ê≠£Â∏∏ÊâßË°åÂÆ¢Êà∑Êú∫‰ª£Á†ÅÔºåËÄå‰∏çÂÜç‰∫ßÁîüEPT ViolationÔºå‰∏çÈúÄË¶ÅÊâßË°åÂêéÈù¢ÁöÑÁúüÂÆûÁº∫È°µÂºÇÂ∏∏Â§ÑÁêÜ„ÄÇ</p>
</li>
<li>
<p><code>try_async_pf</code> ÂáΩÊï∞Ë¥üË¥£Ê£ÄÊü•ÂÆ¢Êà∑Êú∫ËÆøÈóÆÁöÑGPAÊòØÂê¶Âú®KVMÁöÑmemslots‰∏≠ÔºåÂ¶ÇÊûúÂú®ÔºåÂàôÂàÜÈÖçÂÆø‰∏ªÊú∫Áâ©ÁêÜÈ°µÈù¢ÔºåÂæóÂà∞pfn„ÄÇEPTÂ∞ÜGPAÁøªËØë‰∏∫HPAÔºåÈÇ£‰πà‰∏∫‰∫ÜÂ°´ÂÖÖEPTË°®È°πÔºå‰∏Ä‰∏™ÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µ(GPA)ÂøÖÂ∞ÜÂØπÂ∫î‰∏Ä‰∏™ÂÆø‰∏ªÊú∫Áâ©ÁêÜÈ°µ(HPA)„ÄÇ‰ΩÜÊòØÔºåÂ¶ÇÊûúËØ•ÂÆø‰∏ªÊú∫ÂÜÖÂ≠òÈ°µÂ∑≤ÁªèÊç¢Âá∫Âà∞Á£ÅÁõò‰∏äÔºåÂàô‰ºö‰ΩøÂÆ¢Êà∑Êú∫vCPUÂÅúÊªûËæÉÈïøÁöÑ‰∏ÄÊÆµÊó∂Èó¥„ÄÇ‰∏∫Ê≠§ÔºåKVMÂÆûÁé∞‰∫ÜÂºÇÊ≠•Áº∫È°µÂºÇÂ∏∏ÔºåÂΩì‰∏Ä‰∏™vCPUËÆøÈóÆ‰∫ÜË¢´Êç¢Âá∫ÁöÑÂÆø‰∏ªÊú∫Áâ©ÁêÜÈ°µÔºàËøôÈáåÂÄüÂä©‰∫ÜÂÆø‰∏ªÊú∫LinuxÂÜÖÊ†∏ÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÁõ∏ÂÖ≥Êé•Âè£Ôºå‰∏çÂÅöÊ∑±ÂÖ•‰ªãÁªçÔºâÊó∂ÔºåÂàô‰ºöÂ∞ÜvCPUÊåÇËµ∑ÔºåÂπ∂ÊâßË°åÂè¶‰∏Ä‰∏™vCPUÔºåÁ≠âÂæÖË¢´Êç¢Âá∫ÁöÑÈ°µÂä†ËΩΩÂà∞ÂÜÖÂ≠ò‰∏≠„ÄÇÂä†ËΩΩÂÆåÊØïÂêéÔºåË¢´ÊåÇËµ∑ÁöÑvCPUÂàô‰ºö‰ªé <code>try_async_pf</code> ÂáΩÊï∞‰∏≠ËøîÂõûÔºåÈáçÊñ∞ÊâßË°åÂºïËµ∑Áº∫È°µÂºÇÂ∏∏ÁöÑÂÆ¢Êà∑Êú∫Êåá‰ª§„ÄÇ</p>
<p>ËØ•ÂáΩÊï∞ÁöÑÂè¶‰∏Ä‰∏™‰ªªÂä°ÊòØÂÆûÁé∞MMIOÔºåÊ£ÄÊü•ÂèÇÊï∞gfnÊòØÂê¶Âú®KVMÁöÑmemslots‰∏≠ÔºåÂ¶ÇÊûú‰∏çÂú®ÔºåÂàôÂêëpfn‰∏≠ÂÜôÂÖ•KVM_PFN_NOSLOTÔºåÊúÄÂêéËøõÂÖ•__direct_mapÂáΩÊï∞ÁöÑset_mmio_spteÂáΩÊï∞‰∏≠ÔºåÂ∞ÜEPT‰∏≠ËøôÊÆµÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠òÂØπÂ∫îÁöÑÈÉ®ÂàÜÊ†á‰∏∫ÁâπÊÆäÂÄºÔºå‰ª•ÂêéÁöÑËØªÂÜôÈÉΩ‰ºöÂºïËµ∑EPT MisconfigurationÁöÑVM-Exit„ÄÇËá≥Ê≠§ÔºåKVMËé∑Âæó‰∫ÜpfnÔºàÁ±ªÂûã‰∏∫kvm_pfn_tÔºåË°®Á§∫HPAÔºâÔºå‰∫§Áî±‰∏ã‰∏ÄÊ≠•ÊûÑÂª∫EPTË°®È°π„ÄÅÂ°´ÂÖÖEPT‰ΩøÁî®„ÄÇ</p>
</li>
<li>
<p>ËøõÂÖ•‰øÆÊîπEPTÁöÑ‰ª£Á†ÅÂå∫ÔºåÁî±‰∫éÂ§ö‰∏™vCPUÁ∫øÁ®ã‰ª•ÂèäMMUÈÄöÁü•Âô®ÔºàMMU NotifierÔºåÂΩìLinuxÂÜÖÊ†∏Â∞ÜËôöÊãüÂÜÖÂ≠òÈ°µÊç¢Âá∫Âà∞Á£ÅÁõò‰∏äÊó∂Â∞ÜÊî∂Âà∞ÈÄöÁü•ÔºåKVM‰πüÊ≥®ÂÜå‰∫Ü‰∏Ä‰∏™ËøôÊ†∑ÁöÑÈÄöÁü•Âô®ÔºåÂÖ∂ÂÖ∑‰Ωì‰ΩúÁî®ÊòØÂú®LinuxÂÜÖÊ†∏Êç¢Âá∫ÂÆ¢Êà∑Êú∫ÂÜÖÂ≠òÈ°µÊó∂‰øÆÊîπEPTÔºâÂèØËÉΩ‰ºöÂêåÊó∂‰øÆÊîπEPTÔºåÈúÄË¶ÅÂä†kvmÁöÑmmu_lockÈîÅ„ÄÇ<code>mmu_notifier_retry</code> ÂáΩÊï∞ËÆ©MMUÈÄöÁü•Âô®Á∫øÁ®ã‰ºòÂÖàÊâßË°åÔºåÊîæÂºÉvCPUÁöÑEPTÂ°´ÂÖÖ„ÄÇÊé•‰∏ãÊù•Ôºå<code>make_mmu_pages_available</code> ÂáΩÊï∞Â∞ÜÊó†Áî®ÁöÑEPTÈ°µË°®È°µÈáäÊîæÔºå‰∏é‰πãÂâçÂ°´ÂÖÖEPTÈ°µÁöÑÂàÜÈÖçÁºìÂ≠òÊ±†Áõ∏‰∫íÁÖßÂ∫î„ÄÇËøôÈáå‰πüÁî®Âà∞‰∫ÜÂèçÂêëÊò†Â∞ÑÁ≥ªÁªü„ÄÇ</p>
<p><code>__direct_map</code>ÂáΩÊï∞ÂÆûÈôÖÂ°´ÂÖÖ‰∫ÜEPTÂõõÁ∫ßÈ°µË°®ÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>inux-4.19.0/arch/x86/kvm/mmu.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201335822.png" alt="image-20231120133534203" style="zoom:33%;" />
<p>ËØ•ÂáΩÊï∞Ê†πÊçÆÂâçÈù¢Ê≠•È™§ÂæóÂà∞ÁöÑgfnÔºàÂÆ¢Êà∑Êú∫Áâ©ÁêÜÈ°µÂè∑Ôºâ‰ª•ÂèäpfnÔºàÂÆø‰∏ªÊú∫Áâ©ÁêÜÈ°µÂè∑ÔºâÂÆåÊàêEPT‰∏≠gfnÂØπÂ∫îÈÉ®ÂàÜÁöÑÂª∫Á´ã„ÄÇfor_each_shadow_entryÂÆèË¥üË¥£ÈÅçÂéÜÂõõÁ∫ßÈ°µË°®ÔºåÂÖ∂ÂèÇÊï∞ÊòØÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂú∞ÂùÄ <code>gfn&lt;&lt;PAGE_SHIFT</code> ÂíåÈÅçÂéÜÂÖâÊ†áiterator„ÄÇÂú®C++11ËØ≠Ê≥ï‰∏≠ÔºåiteratorÊâøËΩΩ‰∫ÜÊåáÈíàÁöÑ‰ΩúÁî®Ôºå‰∏îÊñπ‰æø‰∫ÜÂØπ‰∏Ä‰∏™Êï∞ÊçÆÁªìÊûÑÁöÑÈÅçÂéÜ„ÄÇËÄåÊ≠§Â§ÑÁöÑiteratorÔºàÂç≥ËØªÂèñEPTÈ°µË°®Êó∂ÊåáÂêëEPTÁöÑÊåáÈíàÔºâ‰∏≠Â≠òÂÇ®‰∫ÜËØªÂèñÈ°µË°®Êó∂ÁöÑÁõ∏ÂÖ≥ÂèÇÊï∞ÔºåÊñπ‰æø‰∫ÜEPTÁöÑÊìç‰Ωú„ÄÇËØ¶ÁªÜÂÜÖÂÆπËßÅÊ≥®ÈáäÔºåÊ≠§Â§Ñ‰ªÖÂÖ≥Ê≥®ÂÖ∂‰∏≠ÁöÑlevel„ÄÅaddrÂíåsptep„ÄÇ</p>
<p>linux-4.19.0/arch/x86/kvm/mmu.c</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311201335922.png"
	
	
	
	loading="lazy"
	
		alt="image-20231120133513880"
	
	
></p>
<p>Âú®Ê≠§Â§ÑÁöÑËÆ®ËÆ∫‰∏≠Ôºåfor_each_shadow_entryÂÆè‰ºöÊâßË°å4Ê¨°ÔºåÁî±‰∫éÂøΩÁï•‰∫ÜÂ§ßÈ°µÔºåEPTÂÖ±ÊúâÂõõÁ∫ßÈ°µË°®„ÄÇÂàÜ‰∏§ÁßçÊÉÖÂÜµÔºö</p>
<ul>
<li>ÈÅçÂéÜÂà∞ÁöÑÈ°µË°®È°µÊòØÈ°µË°®ÁöÑ‰∏≠Èó¥ËäÇÁÇπÔºåÂ¶ÇÊûúÂΩìÂâçÈ°µË°®È°π <code>*iterator.sptep</code> ‰∏çÂ≠òÂú®ÔºåÂàôË∞ÉÁî® <code>kvm_mmu_get_page</code> ÂáΩÊï∞Ëé∑Âèñ‰∏Ä‰∏™kvm_mmu_pageÔºåÂπ∂Ë∞ÉÁî® <code>link_shadow_page</code> ÂáΩÊï∞Â∞ÜÂΩìÂâçsptepÊåáÂêëÊñ∞ÁöÑÈ°µË°®È°µÔºõ</li>
<li>Â¶ÇÊûúÈÅçÂéÜÂà∞ÁöÑÊòØÊúÄÂêé‰∏ÄÁ∫ßÈ°µË°®ÔºåÂàôË∞ÉÁî® <code>mmu_set_spte</code> ÂáΩÊï∞Â∞ÜÊúÄÂêé‰∏ÄÁ∫ßÈ°µË°®È°πÊåáÂêëÊñ∞ÁöÑpfn„ÄÇËøôÊ†∑Â∞±Âª∫Á´ã‰∫ÜÊò†Â∞ÑgfnÂà∞pfnÁöÑEPT„ÄÇ</li>
</ul>
</li>
<li>
<p>ÊúÄÁªàÈáäÊîæmmu_lockÔºåÂ¶ÇÊûúÊõ¥ÊîπEPTÈ°µË°®ËøáÁ®ã‰∏≠ÁöÑÊüê‰∏ÄÊ≠•Â§±Ë¥•ÔºåËøòÈúÄË¶ÅÈáäÊîæÁî± <code>try_async_pf</code> ÂáΩÊï∞ÂàÜÈÖçÁöÑpfnÂ§ÑÁöÑÂÆø‰∏ªÊú∫Áâ©ÁêÜÈ°µ„ÄÇ</p>
</li>
</ol>
<p>Ëá≥Ê≠§ÔºåKVMÂÆåÊàê‰∫ÜgpaÂØπÂ∫îÁöÑEPTÂõõÁ∫ßÈ°µË°®ÁöÑÂ°´ÂÖÖ„ÄÇ</p>
<hr>
<h3 id="ÂÆûÈ™å-Â∞ÜgvaÁøªËØë‰∏∫hpa">ÂÆûÈ™å: Â∞ÜGVAÁøªËØë‰∏∫HPA
</h3><h4 id="ÂÆûÈ™åÊ¶ÇËø∞">ÂÆûÈ™åÊ¶ÇËø∞
</h4><p>‰Ωú‰∏∫ÂÜÖÂ≠òËôöÊãüÂåñÁöÑÊÄªÁªì‰ª•ÂèäKVMÂÜÖÂ≠òËôöÊãüÂåñÊ∫êÁ†ÅÂàÜÊûêÁöÑÊãìÂ±ïÔºåÊú¨ËäÇËøõË°åGVAÂà∞HPAÁöÑÁøªËØëÂÆûÈ™å„ÄÇÂÜÖÂ≠òËôöÊãüÂåñÁöÑÊ†∏ÂøÉÊòØÂú∞ÂùÄÁøªËØëÔºåÂç≥Â∞ÜÊüê‰∏Ä‰∏™Âú∞ÂùÄÁ©∫Èó¥ÁöÑÂú∞ÂùÄËΩ¨Êç¢‰∏∫‰∏ãÂ±ÇÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂú∞ÂùÄ„ÄÇÂ¶ÇÂâçÊñáÊâÄËø∞ÔºåÂú∞ÂùÄÁøªËØëÁî±MMUÁ°¨‰ª∂ÂÆåÊàêÔºåÈ¶ñÂÖà‰ΩøÁî®ÂÆ¢Êà∑Êú∫ËøõÁ®ãÈ°µË°®GPTÂ∞ÜGVAÁøªËØë‰∏∫GPAÔºåÂÜçÁî±Êâ©Â±ïÈ°µË°®EPTÂ∞ÜGPAÁøªËØë‰∏∫HPA„ÄÇ<strong>Áî±‰∫éÊó†Ê≥ïËßÇÂØüÁ°¨‰ª∂ÁöÑÂú∞ÂùÄÁøªËØëËøáÁ®ãÔºå‰∫éÊòØÊú¨ËäÇÂÄüÂä©ÂÜÖÊ†∏Êèê‰æõÁöÑÈ°µË°®ËÆøÈóÆÊé•Âè£ÔºåÈÄöËøáÁºñÂÜôËΩØ‰ª∂Ê®°ÊãüMMUÁöÑÂäüËÉΩ„ÄÇ</strong></p>
<p>‰∏∫‰∫ÜËØÅÊòéÂÜÖÂ≠òÁøªËØë‰ª£Á†ÅËøêË°åÁöÑÊ≠£Á°ÆÊÄßÔºåÈ¶ñÂÖàÂú®GVAÂ§ÑÂÜôÂÖ•‰∏Ä‰∏™intÁ±ªÂûãÁöÑÂèòÈáèÔºåÂπ∂Âú®ÊúÄÂêéÂæóÂà∞ÁöÑHPAÂ§ÑÂØπËØ•intÁ±ªÂûãÂèòÈáèËøõË°åËØªÂèñÔºåÂ¶ÇÊûúÂÜôÂÖ•ÁöÑÂèòÈáèÂíåËØªÂà∞ÁöÑÂèòÈáèÂÄºÁõ∏ÂêåÔºåÈÇ£‰πàËØÅÊòéÂú∞ÂùÄÁøªËØëÊ≠£Á°Æ„ÄÇÊú¨ÂÆûÈ™åÂÆûÁé∞ÁöÑËΩØ‰ª∂MMUÂàÜ‰∏∫‰∏§ÈÉ®ÂàÜÔºö</p>
<ol>
<li><strong>ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂú∞ÂùÄÁøªËØëÊ®°Âùó</strong>‰Ωú‰∏∫ÂÆ¢Êà∑Êú∫‰∏≠ËøêË°åÁöÑÂÜÖÊ†∏Ê®°ÂùóÔºåÈ¶ñÂÖàÂú®GVAÂ§ÑÂÜôÂÖ•‰∏Ä‰∏™intÂèòÈáè <code>0xdeadbeef</code>ÔºåÂÜçÈÄöËøáËØªÂèñGPTÁöÑÊñπÂºèÂ∞ÜGVAÁøªËØëÊàêGPAÔºåÊúÄÂêéÈÄöËøáË∂ÖÁ∫ßË∞ÉÁî®Â∞ÜGPA‰º†ÈÄíÁªôÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªüÔºõ</li>
<li><strong>ÂÆø‰∏ªÊú∫‰∏≠ÁöÑKVMÂÜÖÊ†∏Ê®°Âùó</strong>Â∞ÜÊà™Ëé∑Âà∞ËØ•Ë∂ÖÁ∫ßË∞ÉÁî®ÔºåÂæóÂà∞ÂÆ¢Êà∑Êú∫‰º†Êù•ÁöÑGPAÔºåÈÄöËøáËØªÂèñEPTÁöÑÊñπÂºèËøõ‰∏ÄÊ≠•ÁøªËØëÊàêHPA„ÄÇ‰∏∫‰∫ÜËØªÂèñHPAÂ§ÑÁöÑÂèòÈáèÔºåËøòÈúÄË¶Å‰ΩøÁî®ÂÜÖÊ†∏Êèê‰æõÁöÑÊé•Âè£ÂÅö‰∏ÄÊ¨°HPAÂà∞HVAÁöÑËΩ¨ÂåñÔºåËøôÊòØÂõ†‰∏∫ÂàÜÈ°µÊ®°ÂºèÂºÄÂêØÔºåËÆøÂ≠òÊåá‰ª§‰∏≠ÁöÑÂú∞ÂùÄÂùáÊòØHVAÔºåÊó†Ê≥ï‰ΩøÁî®HPAÁõ¥Êé•ËÆøÈóÆÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÊúÄÁªàËØªÂèñHVAÂ§ÑÁöÑÂèòÈáèÔºåÂ∞ÜËØªÂèñÂà∞ÁöÑÂÄº‰∏éÂÆ¢Êà∑Êú∫ÂÜôÂÖ•ÁöÑÂÄºËøõË°åÊØîËæÉÔºåÂ¶ÇÊûú‰πüÊòØ <code>0xdeadbeef</code>ÔºåÂàôËÉΩÂ§üËØÅÊòéÂú∞ÂùÄÁøªËØëÁöÑÊ≠£Á°ÆÊÄß„ÄÇ</li>
</ol>
<p>‰∏ãÊñáÂàÜÂà´‰ªãÁªç**ÂÆ¢Êà∑Êú∫ÁöÑÂú∞ÂùÄÁøªËØë‰∏éÂÆø‰∏ªÊú∫ÁöÑÂú∞ÂùÄÁøªËØëÔºå**ÂΩ¢Êàê‰∏Ä‰∏™Êï¥‰ΩìÔºå‰ΩøËØªËÄÖ‰∫ÜËß£Âú∞ÂùÄÁøªËØëÁöÑÊµÅÁ®ãÔºåÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311210946037.png" alt="image-20231121094609424" style="zoom: 50%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†Ë∞ÉÁî®kmallocÂáΩÊï∞ÂæóÂà∞GVAÔºõ‚ë°Êü•ËØ¢GPTÔºõ‚ë¢ÊâìÂç∞GPTÁõ∏ÂÖ≥Ë°®È°πÔºõ‚ë£Êü•ËØ¢GPTÔºåÂæóÂà∞GPAÔºõ‚ë§ÈÄöËøáË∂ÖÁ∫ßË∞ÉÁî®Â∞ÜGPA‰º†ÂÖ•KVMÔºåÊü•ËØ¢EPTÔºõ‚ë•ÊâìÂç∞EPTÁõ∏ÂÖ≥Ë°®È°πÔºõ‚ë¶Êü•ËØ¢EPTÔºåÂæóÂà∞HPA„ÄÇ</p>
</blockquote>
<p>È¶ñÂÖàËØ¥ÊòéÂÆûÈ™åÁöÑËøêË°åÁéØÂ¢ÉÔºöÂÆø‰∏ªÊú∫CPUÂûãÂè∑ÊòØIntelCore i7-6500UÔºåÈ¢ëÁéá2.50GHzÔºåQEMU‰∏∫ÂÆ¢Êà∑Êú∫Êèê‰æõ‰∫Ü‰∏éÂÆø‰∏ªÊú∫Áõ∏ÂêåÂûãÂè∑ÁöÑCPU„ÄÇÂÆø‰∏ªÊú∫Áâ©ÁêÜÂÜÖÂ≠òÂ§ßÂ∞è‰∏∫7.5GBÔºåÂÆ¢Êà∑Êú∫Áâ©ÁêÜÂÜÖÂ≠ò‰∏∫4GB„ÄÇÊú¨ËäÇÂÆø‰∏ªÊú∫ÂíåÂÆ¢Êà∑Êú∫Âùá‰ΩøÁî®Linux v4.19.0ÂÜÖÊ†∏ÔºåÂπ∂‰ΩøÁî®‰ªéÊ∫êÁ†ÅÁºñËØëÁöÑQEMU v4.1.1„ÄÇÂÜçËØ¥ÊòéÂÆûÈ™åÂáÜÂ§áÔºåËØªËÄÖÂ∫îËØ•‰∫ãÂÖàÂà∂‰ΩúÂ•Ω‰∏Ä‰∏™ÂÆ¢Êà∑Êú∫Á£ÅÁõòÈïúÂÉèÔºå‰Ωú‰∏∫QEMUÁöÑ-hdaÂèÇÊï∞ËøõË°åËØªÂèñÔºå‰ΩøÁî®QEMUÂêØÂä®‰∏Ä‰∏™ÂÆ¢Êà∑Êú∫„ÄÇ</p>
<p>ÂÆûÈ™åÁõ∏ÂÖ≥ËøáÁ®ã‰∏éËÑöÊú¨ËßÅ‰ª£Á†Å‰ªìÂ∫ìÔºöhttps://github.com/GiantVM/book „ÄÇ</p>
<h4 id="ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢-gvaÂà∞gpa">ÂÆ¢Êà∑Êú∫‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢: GVAÂà∞GPA
</h4><p>‰∏∫‰∫ÜËØªÂèñLinuxÊìç‰ΩúÁ≥ªÁªüÁöÑÈ°µË°®ÔºåÈúÄË¶ÅÂú®ÂÜÖÊ†∏ÊÄÅÁºñÂÜô‰ª£Á†Å„ÄÇ‰ΩøÁî®LinuxÂÜÖÊ†∏Ê®°ÂùóÊòØÁºñÂÜôÂÜÖÊ†∏‰ª£Á†ÅÁöÑ‰∏ÄÁßçÁÆÄÂçïÁöÑÊñπÂºè„ÄÇÊï¥‰ΩìÊìç‰ΩúÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>ÂÜÖÊ†∏Ê®°ÂùóÁöÑÊ∫êÁ†ÅÂèØ‰ª•‰ªÖÁî±‰∏Ä‰∏™.cÊñá‰ª∂ÁªÑÊàêÔºåÂú®ÂÆûÈ™åÈáåÊòØgpt-dump.cÔºåÂè™ÈúÄË¶ÅÁºñÂÜô‰∏Ä‰∏™MakefileÔºàÁºñËØëÂëΩ‰ª§Êñá‰ª∂ÔºâÂØπgpt-dump.cËøõË°åÁºñËØëÔºåÂæóÂà∞gpt-dump.koÊñá‰ª∂Ôºõ</li>
<li>ÂÜç‰ΩøÁî®ÂëΩ‰ª§<code>sudo insmod gpt-dump.ko</code> Âç≥ÂèØÂ∞ÜÂÜÖÊ†∏Ê®°ÂùóÊèíÂÖ•ÂÜÖÊ†∏Ôºõ</li>
<li>ÂÜÖÊ†∏Ê®°ÂùóÊèíÂÖ•ÂÜÖÊ†∏ÂêéÔºåÂ∞±‰ºöË∞ÉÁî®gpt-dump.c‰∏≠ÂÆö‰πâÁöÑ <code>init_module</code> ÂáΩÊï∞ÔºõËÄå‰ΩøÁî®ÂëΩ‰ª§<code>sudo insmod gpt-dump.ko</code> Â∞ÜÂÜÖÊ†∏Ê®°ÂùóÁßªÂá∫ÂÜÖÊ†∏Êó∂ÔºåÂàô‰ºöË∞ÉÁî® <code>cleanup_module</code> ÂáΩÊï∞„ÄÇÂú® <code>init_module</code> ÂáΩÊï∞‰∏≠Âç≥ÂèØÁºñÂÜôÂÜÖÊ†∏‰ª£Á†ÅÂú®ÂÜÖÊ†∏ÊÄÅËøêË°åÔºåÂèØ‰ª•ËÆøÈóÆÈ°µË°®„ÄÇ</li>
</ol>
<p>ËôöÊãüÂú∞ÂùÄÂíåÁâ©ÁêÜÂú∞ÂùÄÂú®LinuxÂÜÖÊ†∏‰∏≠Âùá‰ΩøÁî®64‰ΩçÁöÑÂèòÈáèË°®Á§∫ÔºåËÄåÂú®Intel Core i7Á≥ªÁªü‰∏≠ÔºåËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰∏∫48‰ΩçÔºåÂÖ±256TBÂ§ßÂ∞èÔºåÁâ©ÁêÜÂú∞ÂùÄÁ©∫Èó¥‰∏∫52‰ΩçÔºåÂÖ±4PB(4096TB)Â§ßÂ∞è„ÄÇ<strong>‰∏Ä‰∏™È°µË°®È°πÁöÑÂ§ßÂ∞è‰∏∫64‰ΩçÔºåÂç≥8Â≠óËäÇÔºå‰∏Ä‰∏™È°µË°®È°µÊúâ512‰∏™È°µË°®È°πÔºåÈ°µË°®È°µÂ§ßÂ∞è‰∏∫4KBÔºåÊïÖÈúÄË¶ÅËôöÊãüÂú∞ÂùÄ‰∏≠ÁöÑlog2(512)=9 ‰ΩçÁ¥¢ÂºïÊØèÁ∫ßÁöÑÈ°µË°®È°µ„ÄÇ</strong></p>
<blockquote>
<p>LinuxÂÜÖÊ†∏‰ΩøÁî®4Á∫ßÈ°µË°®ÔºåÁî®ËôöÊãüÂú∞ÂùÄÁöÑÁ¨¨47Ôºö39‰ΩçÁ¥¢ÂºïÁ¨¨4Á∫ßÈ°µË°®ÔºåÁ¨¨38Ôºö30‰ΩçÁ¥¢ÂºïÁ¨¨3Á∫ßÈ°µË°®ÔºåÁ¨¨29Ôºö21‰ΩçÁ¥¢ÂºïÁ¨¨2Á∫ßÈ°µË°®ÔºåÁ¨¨20Ôºö12‰ΩçÁ¥¢ÂºïÁ¨¨1Á∫ßÈ°µË°®„ÄÇËøôÊ†∑Â∞±ÂΩ¢Êàê‰∫ÜÂâçÊñáÊâÄËø∞ÁöÑ <code>9+9+9+9</code> ÂΩ¢ÂºèÁöÑÂõõÁ∫ßÈ°µË°®„ÄÇ</p>
</blockquote>
<hr>
<p>ËôöÊãüÂú∞ÂùÄ‰ΩøÁî®Á¨¨47Ôºö12‰ΩçÂ≠òÂÇ®È°µË°®ÁöÑÁ¥¢ÂºïÔºåÁ¨¨11Ôºö0‰ΩçÂ≠òÂÇ®ËôöÊãüÂú∞ÂùÄÂú®È°µ‰∏≠ÁöÑÂÅèÁßªÔºåÂõ†Ê≠§Êü•ËØ¢È°µË°®Âè™‰ΩøÁî®‰∫ÜËôöÊãüÂú∞ÂùÄÁöÑÂâç48‰ΩçÔºåÂç≥ËÆøÈóÆËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰ªÖ‰ΩøÁî®‰∫Ü48‰ΩçÁöÑËôöÊãüÂú∞ÂùÄ„ÄÇÊ≠§Â§ÑÂÆö‰πâÂÆè <code>UL_TO_VADDR‰ª•/VADDR_PATTERN</code> ÊâìÂç∞ËôöÊãüÂú∞ÂùÄÔºåÂåÖÂê´È°µË°®ÁöÑÁ¥¢Âºï‰ΩçÔºàÂÖ±36‰ΩçÔºâÔºå‰ª•ÂèäÂÅèÁßªÔºàÂÖ±12‰ΩçÔºâ„ÄÇÈÉ®ÂàÜÁõ∏ÂÖ≥ÂÆèÂÆö‰πâÂ¶Ç‰∏ã„ÄÇ</p>
<p>gpt-dump/gpt-dump.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211000229.png" alt="image-20231121100026341" style="zoom: 33%;" />
<p>Áî±‰∫éÂÜÖÊ†∏‰∏≠Â∞öÊ≤°ÊúâÂ∞ÜÂèòÈáèËΩ¨Âåñ‰∏∫‰∫åËøõÂà∂Ë°®Á§∫ÁöÑÂáΩÊï∞ÔºåÊ≠§Â§ÑÁºñÂÜô <code>pr_info</code> ÂáΩÊï∞ÔºåÊé•Êî∂‰∏çÂêåÁöÑ <code>%c</code> Ê†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤Âíå <code>0/1</code> Â≠óÁ¨¶ÁöÑÁªÑÂêàÊù•ÊâìÂç∞ËôöÊãüÂú∞ÂùÄ„ÄÅÁâ©ÁêÜÂú∞ÂùÄ‰ª•ÂèäÈ°µË°®È°π„ÄÇ‰ª•ËôöÊãüÂú∞ÂùÄÁöÑÊâìÂç∞‰∏∫‰æãÔºåÈ¶ñÂÖàÂÆö‰πâËæìÂá∫3‰∏™‰ΩçÁöÑÂ≠óÁ¨¶ÁªÑÂêàÔºåÂç≥ <code>TBYTE_TO_BINARY</code>ÔºåËøòÊúâÂØπÂ∫îÁöÑÊâìÂç∞‰∏â‰∏™charÁ±ªÂûãÁöÑÊ†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ <code>TBYTE_TO_BINARY_PATTERN</code>„ÄÇÊé•‰∏ãÊù•ÔºåÈúÄË¶ÅÂ∞ÜËôöÊãüÂú∞ÂùÄÁöÑ‰Ωé12‰ΩçÔºàÂç≥ÂÅèÁßªÁöÑ12‰∏™‰ΩçÔºâÂÖ®ÈÉ®ÊâìÂç∞Âá∫Êù•„ÄÇÁªßÁª≠ÂØπ‰ª£Ë°®ËôöÊãüÂú∞ÂùÄÁöÑulongÔºà64‰ΩçÁöÑÂèòÈáèÔºâ‰ΩøÁî® <code>TBYTE_TO_BINARY</code>ÔºåÂæóÂà∞ÂÖ∂‰Ωé3‰ΩçÔºõÂÜçÂ∞ÜulongÂè≥Áßª3‰ΩçÔºåÂπ∂‰ΩøÁî®ÂÆè <code>TBYTE_TO_BINARY</code>ÔºåÂæóÂà∞ÂÖ∂5Ôºö3‰ΩçÔºå‰ª•Ê≠§Á±ªÊé®ÔºåÂèØ‰ª•ÂæóÂà∞ÊâÄÊúâÂΩ¢ÂºèÁöÑ <code>0/1</code> Â≠óÁ¨¶ÁªÑÂêàÔºåÂåÖÊã¨ÂÆè <code>UL_TO_PTE_OFFSET</code> Ë¥üË¥£ËæìÂá∫12‰ΩçÔºå<code>UL_TO_PTE_INDEX</code> Ë¥üË¥£ËæìÂá∫9‰Ωç„ÄÇÂØπ‰∫é <code>pr_info</code> ÁöÑÊ†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ÔºåÂÆûÁé∞ÊñπÂºèÁ±ª‰ººÔºåÂè™ÈúÄÂú®ÂêàÈÄÇÁöÑ‰ΩçÁΩÆÂä†‰∏äÁ©∫Ê†ºÔºå‰æø‰∫éËßÇÂØü„ÄÇÂú®ÂÜÖÊ†∏Ê®°ÂùóÂàùÂßãÂåñÂáΩÊï∞‰∏≠ÔºåÈ¶ñÂÖàË∞ÉÁî® <code>print_ptr_vaddr</code> ÊâìÂç∞ËôöÊãüÂú∞ÂùÄÔºåËæìÂá∫Â¶Ç‰∏ãÔºö</p>
<p>gpt-dump/gpt-dump.txt</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211001803.png" alt="image-20231121100122051" style="zoom:33%;" />
<p>ÂèØ‰ª•ÁúãÂà∞ÂõõÁ∫ßÈ°µË°®ÁöÑÂõõ‰∏™Á¥¢ÂºïÂÄºÔºå‰ª•ÂèäÈ°µÂÜÖÂÅèÁßªÁöÑ‰∫åËøõÂà∂Ë°®Á§∫„ÄÇ</p>
<hr>
<p>‰∏∫‰∫ÜËé∑Âæó‰∏Ä‰∏™GVAÔºåÂú®Ê®°ÂùóÂàùÂßãÂåñÂáΩÊï∞‰∏≠ÔºåÈ¶ñÂÖàË∞ÉÁî® <code>kmalloc</code> ÂáΩÊï∞ÁîüÊàê‰∏Ä‰∏™intÁ±ªÂûãÂèòÈáèÁöÑÊåáÈíàÔºåÁî±‰∫éÂÜÖÊ†∏Ê®°ÂùóËøêË°åÂú®ÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏‰∏≠ÔºåÊâÄ‰ª•ËØ•ÊåáÈíàÂåÖÂê´‰∏Ä‰∏™GVA„ÄÇÂú®‰∏äÈù¢ÁöÑ‰ª£Á†ÅÁâáÊÆµ‰∏≠ÔºåÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÂú®ËØ•ÊåáÈíàÂ§ÑÂÜôÂÖ•Êï∞Â≠óÔºö<code>0xdeadbeef</code>ÔºåÊúüÊúõÂú®GVAÂØπÂ∫îÁöÑHVAÂ§ÑËØªÂà∞ËØ•Êï∞Â≠ó„ÄÇÂú®ËæìÂá∫‰∏≠ÂèØ‰ª•ÁúãÂà∞ÂõõÁ∫ßÈ°µË°®ÁöÑÁ¥¢ÂºïÔºåÂæóÁü•Âú®È°µË°®È°µ‰∏≠Â∫îËØ•ËØªÂèñÁ¨¨Âá†‰∏™È°µË°®È°π„ÄÇÊé•‰∏ãÊù•ÔºåÂÜÖÊ†∏Ê®°ÂùóÊâæÂà∞ÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Á∫øÁ®ãÁöÑ <code>CR3</code>ÔºåÂπ∂Â∞ÜÂÖ∂‰º†ÂÖ•È°µË°®ÊâìÂç∞ÂáΩÊï∞„ÄÇ‰∏ãÈù¢ÊòØÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÁöÑÁõ∏ÂÖ≥‰ª£Á†ÅÔºö</p>
<p>gpt-dump/gpt-dump.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211002733.png" alt="image-20231121100204419" style="zoom:33%;" />
<p><code>current-&gt;mm-&gt;pgd</code> ÊòØÂΩìÂâçËøõÁ®ãcurrentÁöÑCR3ÔºåÊåáÂêëPGDÔºàPage Global DirectoryÔºåÈ°µÂÖ®Â±ÄÁõÆÂΩïÔºâÈ°µË°®È°µÁöÑËµ∑ÂßãÂú∞ÂùÄ„ÄÇ<code>dump_pgd</code> ÂáΩÊï∞Ë¥üË¥£ÈÅçÂéÜpgdÈ°µË°®È°µÁöÑPTRS_PER_PGD‰∏™È°µË°®È°πÔºåËøôÈáåÊòØ512‰∏™È°µË°®È°π„ÄÇ</p>
<blockquote>
<p>pgdÊòØ‰∏Ä‰∏™pgd_tÁ±ªÂûãÁöÑÂèòÈáèÔºåÂÜÖÊ†∏ËøòÊèê‰æõ‰∫ÜÁ±ª‰ººÁöÑpud_t„ÄÅpmd_t„ÄÅpte_tÊï∞ÊçÆÁªìÊûÑË°®Á§∫ÊØèÁ∫ßÈ°µË°®ÁöÑÈ°µË°®È°πÔºå‰ª•ÂèäÊìç‰ΩúËøô‰∫õÊï∞ÊçÆÁªìÊûÑÁöÑÊé•Âè£„ÄÇ</p>
</blockquote>
<p>Ê≠§Â§Ñ‰ΩøÁî®Ëøô‰∫õÊé•Âè£Ëé∑ÂèñÈ°µË°®È°πÁöÑÂê´‰πâÔºåÂ¶Ç <code>pgd_val</code> ÂáΩÊï∞ËøîÂõûËØ•È°µË°®È°πÁöÑÂÄºÔºåÂç≥ËØ•È°µË°®È°πÂØπÂ∫îÁöÑunsigned longÂèòÈáèÔºõ<code>pgd_present</code> ÂáΩÊï∞Ê£ÄÊü•ËØ•È°µË°®È°πÁöÑÁ¨¨0‰ΩçÔºåËøîÂõûËØ•È°µË°®È°πÊòØÂê¶ÊúâÊïàÔºõ<code>pgd_large</code> ÂáΩÊï∞ËøîÂõûËØ•È°µË°®È°πÊòØÂê¶ÊåáÂêë1GBÁöÑÂ§ßÈ°µ„ÄÇ</p>
<p>Êú¨ËäÇÂøΩÁï•Â§ßÈ°µÁöÑÊÉÖÂÜµÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®ÂÜÖÊ†∏ÂèÇÊï∞ÂÖ≥Èó≠Â§ßÈ°µ„ÄÇËøôÈáåÂÆö‰πâ‰∫ÜÂÖ®Â±ÄÂèòÈáè‰øùÂ≠òÁöÑËôöÊãüÂú∞ÂùÄÂíåÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºå‰ª•ÂèäÂêÑÁ∫ßÈ°µË°®Á¥¢Âºï„ÄÇ<code>pgd_idx</code>Ë°®Á§∫‰ªé64‰ΩçËôöÊãüÂú∞ÂùÄ‰∏≠Ëé∑ÂæóÁöÑPGDÈ°µË°®Á¥¢Âºï„ÄÇÊé•‰∏ãÊù•ÔºåÂ¶ÇÊûúPGDÈ°µË°®È°µÁöÑÁ¨¨ <code>pgd_idx</code> ‰∏™È°µË°®È°πÂ≠òÂú®ÔºåÈÇ£‰πàË∞ÉÁî® <code>pr_pte</code> ÂáΩÊï∞ÊâìÂç∞ËØ•È°µË°®È°πÔºåÊ≠§ÂáΩÊï∞ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p>gpt-dump/gpt-dump.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211002339.png" alt="image-20231121100249251" style="zoom:33%;" />
<p>ÂèÇÊï∞ <code>address</code> Ë°®Á§∫Êú¨Á∫ßÈ°µË°®È°µÁöÑËµ∑ÂßãÂú∞ÂùÄÔºå‰ªé‰∏ä‰∏ÄÁ∫ßÈ°µË°®È°πËé∑ÂæóÔºå<code>pte</code> Ë°®Á§∫Êú¨Á∫ßÈ°µË°®È°π„ÄÇÂÆèPTE_PATTRENÁî®‰∫éÊâìÂç∞‰∏Ä‰∏™È°µË°®È°π„ÄÇÁªßÁª≠Êü•ËØ¢‰∏ã‰∏ÄÁ∫ßÈ°µË°®ÁöÑÂáΩÊï∞Ë∞ÉÁî®Èìæ‰∏∫ <code>dump_pgd -&gt; dump_pud -&gt; dump_pmd -&gt; dump_pte</code>ÔºåÂÖ∂‰∏≠ÊØè‰∏ÄÊ≠•ÁöÑÈÄªËæëÂ§ßËá¥Áõ∏Âêå„ÄÇaddressÂíåpteÁöÑÊâìÂç∞ÁªìÊûúÂ¶Ç‰∏ã„ÄÇ</p>
<p>gpt-dump/gpt-dump.txt</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211005105.png" alt="image-20231121100329761" style="zoom:33%;" />
<p>‰ªéÂä†Á≤óÁöÑÈÉ®ÂàÜÂèØ‰ª•ÁúãÂà∞ÔºåÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÂØπÈ°µË°®È°µÁöÑÂú∞ÂùÄË∞ÉÁî® <code>_pa</code> ÂáΩÊï∞Ëé∑ÂæóÂÖ∂Áâ©ÁêÜÂú∞ÂùÄÔºåÂíå‰∏ä‰∏ÄÁ∫ßÈ°µË°®È°π‰∏≠‰øùÂ≠òÁöÑ‰∏ã‰∏ÄÁ∫ßÈ°µË°®È°µÁöÑÁâ©ÁêÜÂú∞ÂùÄÂÆåÂÖ®Áõ∏ÂêåÔºåËøôÁ¨¶ÂêàÈ¢ÑÊúü„ÄÇÊúÄÁªàÔºåÂ∞±ÂèØ‰ª•‰ªéPTE‰∏≠Ëé∑ÂæóÁâ©ÁêÜÂú∞ÂùÄÔºå‰∏∫‰∫ÜÈ™åËØÅÊ≠£Á°ÆÊÄßÔºåÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÂØπvaddrË∞ÉÁî® <code>__pa</code> ÂáΩÊï∞ÔºåÊâìÂç∞Âá∫GPAÂºÄÂ§¥ÁöÑË°åÔºåÂÖ∑‰ΩìÂú® <code>print_pa_check</code> ÂáΩÊï∞‰∏≠ÂÆûÁé∞Ôºå‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p>gpt-dump/gpt-dump.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211004899.png" alt="image-20231121100450101" style="zoom:33%;" />
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÂíå‰πãÂâçËé∑ÂæóÁöÑPTE‰∏≠ÁöÑÁâ©ÁêÜÂú∞ÂùÄÁõ∏ÂêåÔºåËØ¥ÊòéËØªÂèñÈ°µË°®ÁöÑÁªìÊûúÊ≠£Á°Æ„ÄÇÂÖ∂‰∏≠‰Ωé12‰ΩçÊòØÈ°µÂÜÖÂÅèÁßªÔºåÁâ©ÁêÜÂú∞ÂùÄÂíåËôöÊãüÂú∞ÂùÄ‰∏≠ÁöÑÈ°µÂÜÖÂÅèÁßªÂÆåÂÖ®Áõ∏Âêå„ÄÇ<strong>ÊúÄÂêéÔºåÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÂ∞ÜË∞ÉÁî® <code>kvm_hypercall1(22,paddr)</code> ÂáΩÊï∞ÔºåÂ∞Üpaddr‰º†ÁªôKVM„ÄÇ</strong></p>
<h4 id="kvm‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢-gpaÂà∞hpa">KVM‰∏≠ÁöÑÂú∞ÂùÄËΩ¨Êç¢: GPAÂà∞HPA
</h4><blockquote>
<p>KVMË¥üË¥£Áª¥Êä§EPTÔºåÂÖ∑ÊúâËØªÂèñEPTÁöÑÊùÉÈôê„ÄÇÊú¨ÂÆûÈ™å‰øÆÊîπÂÆø‰∏ªÊú∫ÂÜÖÊ†∏ÁöÑKVMÊ®°ÂùóÔºå**Â¢ûÂä†‰∏Ä‰∏™Ë∂ÖÁ∫ßË∞ÉÁî®Â§ÑÁêÜÂáΩÊï∞Ôºå**Êé•Êî∂‰ªéÂÆ¢Êà∑Êú∫‰º†Êù•ÁöÑGPAÔºåÊ®°ÊãüGPAÂà∞HPAÁöÑÁøªËØë„ÄÇ</p>
</blockquote>
<p>ÂΩìÂÆ¢Êà∑Êú∫ÊâßË°å‰∫Ü‰∏Ä‰∏™ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§Êó∂Ôºå‰ºöÂºïËµ∑CPUÁöÑVM-ExitÔºåCPUÁöÑÊâßË°åÊ®°Âºè‰ªéÈùûÊ†πÊ®°ÂºèËΩ¨Êç¢‰∏∫Ê†πÊ®°ÂºèÔºåÂπ∂ËøõÂÖ•KVMÁöÑVM-ExitÂ§ÑÁêÜÂáΩÊï∞„ÄÇ<code>kvm_hypercall1</code> ÂáΩÊï∞ÊúÄÁªàÊâßË°åvmcallÊåá‰ª§ÔºåÈô∑ÂÖ•KVMÔºåKVMÂæóÁü•VM-ExitÁöÑÂéüÂõ†ÊòØÂÆ¢Êà∑Êú∫ÊâßË°å‰∫ÜvmcallÊåá‰ª§ÔºåÁºñÂè∑‰∏∫EXIT_REASON_VMCALLÔºå‰∫éÊòØË∞ÉÁî®Â¶Ç‰∏ã <code>handle_vmcall</code> Â§ÑÁêÜÂáΩÊï∞„ÄÇ</p>
<p>linux-4.19.0/arch/x86/kvm/vmx.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211110467.png" alt="image-20231121111004958" style="zoom:33%;" />
<p>ÂáΩÊï∞ <code>handle_vmcall</code> Ë∞ÉÁî®Ë∂ÖÁ∫ßË∞ÉÁî®Ê®°ÊãüÂáΩÊï∞ <code>kvm_emulate_hypercall</code>Ôºå‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211110116.png" alt="image-20231121111035833" style="zoom:33%;" />
<p>ÂÖ∂‰∏≠ÔºånrÊòØ <code>kvm_hypercall1</code> ÂáΩÊï∞ÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞Ôºåa0ÊòØÁ¨¨‰∫å‰∏™ÂèÇÊï∞„ÄÇnrË°®Á§∫Â∫îËØ•Ë∞ÉÁî®Âì™‰∏™Ë∂ÖÁ∫ßË∞ÉÁî®Ê®°ÊãüÂáΩÊï∞ÔºåÂÆö‰πâKVM_HC_DUMP_SPT‰∏∫22ÔºåË°®Á§∫ÊâìÂç∞ÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Á∫øÁ®ãÈ°µË°®ÂØπÂ∫îÁöÑEPT„ÄÇÈ¶ñÂÖàË∞ÉÁî® <code>print_gpa_from_guest</code> ÂáΩÊï∞ÊâìÂç∞ÂÆ¢Êà∑Êú∫‰º†Êù•ÁöÑGPAÔºåÂπ∂‰ªéGPA‰∏≠Ëé∑ÂèñÊØèÁ∫ßEPTÈ°µË°®ÁöÑÁ¥¢ÂºïÔºå‰øùÂ≠òÂú®ÂÖ®Â±ÄÂèòÈáè <code>pxx_idx[4]</code> ‰∏≠Ôºå<code>print_gpa_from_guest</code> ÂáΩÊï∞ÁöÑÊâìÂç∞ÁªìÊûúÂ¶Ç‰∏ã„ÄÇ</p>
<p>gpt-dump/ept-dump.txt</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211111667.png" alt="image-20231121111115038" style="zoom:33%;" />
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÊ≠§Â§ÑÁöÑGPA‰∏éÂú®ÂÆ¢Êà∑Êú∫‰∏≠ËØªÂèñGPTÂæóÂà∞ÁöÑGPAÁõ∏ÂêåÔºåËØ¥ÊòéÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÁöÑË∂ÖÁ∫ßË∞ÉÁî®ÊàêÂäü„ÄÇÊé•‰∏ãÊù•Ë∞ÉÁî® <code>mmu_spte_walk</code> ÂáΩÊï∞ÈÅçÂéÜÊ≠§vCPUÁöÑEPTÔºåÂú®‰ª£Á†Å‰∏≠Áß∞‰ΩúsptÔºåËøôÊòØ‰∏∫‰∫ÜÂíåÂΩ±Â≠êÈ°µË°®ÂÖ±Áî®‰∏ÄÂ•ó‰ª£Á†Å„ÄÇ‰º†ÂÖ• <code>mmu_spte_walk</code> ÂáΩÊï∞ÁöÑÂèÇÊï∞ÊúâvcpuÔºå‰ª•ÂèäÈÅçÂéÜÂà∞‰∏Ä‰∏™È°µË°®È°πÊó∂ÊâÄË∞ÉÁî®ÂáΩÊï∞ÁöÑÊåáÈíàpr_spteÔºåË¥üË¥£ÊâìÂç∞È°µË°®È°π„ÄÇÈÅçÂéÜ‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p>linux-4.19.0/arch/x86/kvm/mmu.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211112468.png" alt="image-20231121111156730" style="zoom:33%;" />
<p><code>vcpu-&gt;arch.mmu.root_hpa</code> ‰øùÂ≠ò‰∫ÜEPTÁöÑÂü∫Âú∞ÂùÄÔºåÂàùÂßãÂåñÊó∂Ë¢´ËÆæ‰∏∫INVALID_PAGE„ÄÇ<code>mmu_spte_walk</code> ÂáΩÊï∞È¶ñÂÖàÂà§Êñ≠vcpu-&gt;arch.mmu.root_hpaÊòØÂê¶ÊòØÊó†ÊïàÈ°µINVALID_PAGEÔºåÂ¶ÇÊûúÊòØÔºåÂàôËØ¥ÊòévCPUÂØπÂ∫îÁöÑEPTÂ∞öÊú™Âª∫Á´ãÔºåÊó†Ê≥ïÈÅçÂéÜ„ÄÇÂ¶ÇÊûúEPTÁöÑÁ∫ßÊï∞Â§ß‰∫éPT64_ROOT_4LEVELÔºåÂàôË∞ÉÁî®ÈÄíÂΩíÂáΩÊï∞<code>__mmu_spte_walk</code> ÈÅçÂéÜÈ°µË°®„ÄÇ</p>
<p><code>page_header</code> ÂáΩÊï∞ËøîÂõû‰∏Ä‰∏™hpa_tÂèòÈáèÊâÄÊåáÂêëÈ°µË°®È°µÁöÑ <code>kvm_mmu_page</code> ÁªìÊûÑÁöÑÊåáÈíà„ÄÇ‰∫éÊòØÔºåKVMÂ∞ÜEPTÁ¨¨4Á∫ßÈ°µË°®È°µÁöÑ<code>kvm_mmu_page</code>ÁªìÊûÑ‰º†ÂÖ•<code>_mmu_spte_walk</code> ÂáΩÊï∞ÔºåÂπ∂‰∏î‰ªélevel=1ÂºÄÂßãÈÅçÂéÜEPT„ÄÇ</p>
<p>ÂíåÊü•ËØ¢GPT‰∏ÄÊ†∑ÔºåKVMÈÅçÂéÜÈ°µË°®È°µ‰∏≠ÁöÑÊØè‰∏Ä‰∏™È°µË°®È°πÔºåÂ¶ÇÊûúÈ°µË°®È°πÁöÑÁ¥¢ÂºïÁ≠â‰∫é‰πãÂâç <code>print_gpa_from_guest</code> ÂáΩÊï∞‰∏≠Ëé∑ÂæóÁöÑpxx_idx‰∏≠ÂØπÂ∫îÁöÑÁ¥¢ÂºïÔºåÈÇ£‰πàÊ≠§È°µË°®È°πÂ∞±ÊòØÁõÆÊ†áÈ°µË°®È°πÔºåÂπ∂Â∞ÜÂÆÉ‰º†ÂÖ•fnÂáΩÊï∞ËøõË°åÊâìÂç∞„ÄÇÂ¶ÇÊûúÊü•ËØ¢Âà∞ÁöÑÈ°µË°®È°π‰∏çÊòØÊúÄÂêé‰∏ÄÁ∫ßÔºåÂàôÁªßÁª≠ÈÄíÂΩíË∞ÉÁî® <code>__mmu_spte_walk</code> ÂáΩÊï∞Êü•ËØ¢‰∏ã‰∏ÄÁ∫ßÈ°µË°®„ÄÇÂú®ËøôÈáåÔºåÂ∞ÜfnÁΩÆ‰∏∫ÊâìÂç∞EPTÈ°µË°®È°πÁöÑÂáΩÊï∞ÔºåÂ¶Ç‰∏ãÊâìÂç∞Ê†ºÂºè‰∏éGPTÁõ∏Âêå„ÄÇ</p>
<p>gpt-dump/ept-dump.txt</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211113999.png" alt="image-20231121111259191" style="zoom:33%;" />
<blockquote>
<p>Áî±‰∫éÊú¨ÂÆûÈ™åÊ≤°ÊúâÂÖ≥Èó≠ÂÆø‰∏ªÊú∫‰∏äÁöÑÂ§ßÈ°µÔºåKVMÂú®Êü•ËØ¢Âà∞ÊúÄÂêé‰∏ÄÁ∫ßÈ°µË°®Êó∂ÂÅö‰∫Ü‰∏§ÁßçÂ§ÑÁêÜÔºöÂ¶ÇÊûúÈÅçÂéÜÂà∞Â§ßÈ°µÔºåÂàôË∞ÉÁî® <code>print_huge_pte</code> ÂáΩÊï∞ÊâìÂç∞ÊúÄÂêéËé∑ÂèñHPAÁöÑËøáÁ®ãÔºõÂê¶ÂàôË∞ÉÁî® <code>print_pte</code> ÂáΩÊï∞„ÄÇ</p>
</blockquote>
<p>ÂÖ∑‰ΩìÁöÑÊâìÂç∞‰ª£Á†Å‰∏çÂÜçËµòËø∞Ôºå‰∏ãÈù¢Âè™Â±ïÁ§∫ÊúÄÂêéÂ¶Ç‰Ωï‰ΩøÁî®‰ª£Á†ÅÂæóÂà∞HPA„ÄÇ</p>
<p>linux-4.19.0/arch/x86/kvm/mmu.c</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311211114649.png" alt="image-20231121111413371" style="zoom:33%;" />
<ul>
<li>
<p>**ÂØπ‰∫é2MBÂ§ßÈ°µÁöÑÊÉÖÂÜµÔºå**ÊúÄÂêé‰∏ÄÁ∫ßÈ°µË°®È°πÊòØPDEÔºåËøôÁ±ªÈ°µË°®È°πÁöÑÁ¨¨51Ôºö21‰ΩçË°®Á§∫Â§ßÈ°µÁöÑËµ∑ÂßãÁâ©ÁêÜÂú∞ÂùÄÔºåÊìç‰ΩúÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ËøôÈáå‰ΩøÁî®PT64_DIR_BASE_ADDR_MASKÂÆè‰ªéentÈ°µË°®È°π‰∏≠Ëé∑ÂèñÂ§ßÈ°µÁöÑËµ∑ÂßãÁâ©ÁêÜÂú∞ÂùÄÔºõ</li>
<li>Êé•‰∏ãÊù•Ôºå‰ΩøÁî® <code>PT64_LVL_OFFSET_MASK(2)|(PAGE_SIZE-1)</code> Ëé∑ÂèñGPA‰∏≠ÁöÑÂ§ßÈ°µÂÅèÁßªÁöÑÈÉ®ÂàÜÔºåÂç≥20Ôºö0‰ΩçÔºõ</li>
<li>ÊúÄÁªàÔºåÁªìÂêàÂ§ßÈ°µËµ∑ÂßãÂú∞ÂùÄÂíåÂ§ßÈ°µÂÅèÁßªÂæóÂà∞HPAÔºåÊúÄÂêéË∞ÉÁî® <code>__va</code> ÂáΩÊï∞Ëé∑ÂèñÂØπÂ∫îÁöÑHVAÔºåÂπ∂Ëß£ÂºïÁî®ËØ•HVAÔºåËØªÂèñÂà∞Êï∞ÊçÆ0xdeadbeefÔºåÁ¨¶ÂêàÈ¢ÑÊúü„ÄÇ</li>
</ul>
</li>
<li>
<p>**ÂØπ‰∫éÊôÆÈÄö4KBÈ°µÁöÑÊÉÖÂÜµÔºå**PTE‰∏≠ÁöÑÁ¨¨51Ôºö12‰ΩçË°®Á§∫ÂÖ∂ÊåáÂêëÁöÑÁâ©ÁêÜÈ°µÁöÑËµ∑ÂßãÂú∞ÂùÄÔºåÊìç‰ΩúÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>‰ΩøÁî®PT64_BASE_ADDR_MASKÂÆè‰ªéPTE‰∏≠Ëé∑ÂèñÈ°µÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºõ</li>
<li>ÂÜç‰ΩøÁî®PAGE_SIZE-1‰ªéGPA‰∏≠Ëé∑ÂèñÈ°µÂÅèÁßªÔºåÂç≥11Ôºö0‰ΩçÔºõ</li>
<li>ÊúÄÂêéÁªìÂêàÈ°µÁöÑÁâ©ÁêÜÂú∞ÂùÄÂíåÈ°µÂÅèÁßªÂæóÂà∞GPAÔºåÊúÄÂêéË∞ÉÁî® <code>__va</code> ÂáΩÊï∞ÂæóÂà∞HVAÔºåÂπ∂Ëß£ÂºïÁî®ËØ•HVAÔºåËØªÂèñÂà∞Êï∞ÊçÆ0xdeadbeefÔºåÁ¨¶ÂêàÈ¢ÑÊúü„ÄÇ</li>
</ul>
</li>
</ul>
<p>Áªº‰∏äÊâÄËø∞ÔºåÂÆ¢Êà∑Êú∫ÂÜÖÊ†∏Ê®°ÂùóÂú®‰∏Ä‰∏™GVAÂ§ÑÂÜôÂÖ•‰∫Ü0xdeadbeefÔºåËØªÂèñÂÆ¢Êà∑Êú∫È°µË°®ÂæóÂà∞GVAÂØπÂ∫îÁöÑGPAÔºåÈÄöËøáË∂ÖÁ∫ßË∞ÉÁî®‰º†ÈÄíGPAÂà∞KVMÊ®°ÂùóÔºåKVMËØªÂèñEPTÂ∞ÜGPAÁøªËØëÊàêHPAÔºåÊúÄÂêéÈÄöËøá_vaÂáΩÊï∞ÊâæÂà∞HPAÂØπÂ∫îÁöÑHVAÔºåÂπ∂ËØªÂèñÂà∞0xdeadbeefÔºåË°®ÊòéHPAÂ§ÑÁ°ÆÂÆûÂ≠òÂÇ®‰∫ÜGVAÂ§ÑÁöÑÊï∞ÊçÆÔºåÂú∞ÂùÄÁøªËØëÊàêÂäü„ÄÇÂú®ÁøªËØëËøáÁ®ã‰∏≠ÔºåÂÆûÈ™å‰ª£Á†ÅÊâìÂç∞‰∫ÜÂú∞ÂùÄÁøªËØëÊâÄÊ∂âÂèäÁöÑÈ°µË°®È°π„ÄÅGPA„ÄÅHPAÁ≠âÔºåÁéØÁéØÁõ∏Êâ£„ÄÇÂÖ∂‰∏≠Ôºåept-dump.txtÊñá‰ª∂Â≠òÂÇ®‰∫ÜÂÆåÊï¥ÁöÑËæìÂá∫‰ø°ÊÅØ„ÄÇ</p>
<h1 id="4-todo-giantvmÂÜÖÂ≠òËôöÊãüÂåñ">4 //TODO: GiantVMÂÜÖÂ≠òËôöÊãüÂåñ
</h1>
</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 zcxGGmu
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<div id="particles-js"></div>

<script src=https://zcxggmu.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://zcxggmu.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>


    </body>
</html>
