<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="[TOC]\n1 Ê¶ÇËø∞ Êú¨Á´†Â∞ÜÊ∑±ÂÖ•‰ªãÁªçCPUËôöÊãüÂåñÈÉ®ÂàÜ„ÄÇÊó©ÊúüÁî±‰∫éÁº∫‰πèÁõ∏Â∫îÁ°¨‰ª∂ÁöÑÊîØÊåÅÔºåÂè™ËÉΩÈááÁî®Èô∑ÂÖ•-Ê®°Êãü„ÄÅÊâ´Êèè‰∏é‰øÆË°•„ÄÅ‰∫åËøõÂà∂ÁøªËØëÁ≠âËΩØ‰ª∂Ê®°ÊãüÁöÑÊñπÂºèËß£ÂÜ≥‚ÄúËôöÊãüÂåñÊºèÊ¥û‚ÄùÈóÆÈ¢òÔºåÊïàÁéáËæÉ‰Ωé„ÄÇËÄåÈöèÁùÄIntel VT-xÁ≠âËôöÊãüÂåñÁ°¨‰ª∂ÊäÄÊúØÁöÑÂá∫Áé∞ÔºåÁ°¨‰ª∂ËæÖÂä©CPUËôöÊãüÂåñÊäÄÊúØÈÄêÊ∏êÊàê‰∏∫‰∏ªÊµÅ„ÄÇÊú¨ÊñáÂ∞ÜÊåâÁÖßÂ¶Ç‰∏ãÈ°∫Â∫èËøõË°å‰ªãÁªçÔºö\n">
<title>Kvmbook Cpu_2</title>

<link rel='canonical' href='https://zcxggmu.github.io/p/kvmbook-cpu_2/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Kvmbook Cpu_2">
<meta property='og:description' content="[TOC]\n1 Ê¶ÇËø∞ Êú¨Á´†Â∞ÜÊ∑±ÂÖ•‰ªãÁªçCPUËôöÊãüÂåñÈÉ®ÂàÜ„ÄÇÊó©ÊúüÁî±‰∫éÁº∫‰πèÁõ∏Â∫îÁ°¨‰ª∂ÁöÑÊîØÊåÅÔºåÂè™ËÉΩÈááÁî®Èô∑ÂÖ•-Ê®°Êãü„ÄÅÊâ´Êèè‰∏é‰øÆË°•„ÄÅ‰∫åËøõÂà∂ÁøªËØëÁ≠âËΩØ‰ª∂Ê®°ÊãüÁöÑÊñπÂºèËß£ÂÜ≥‚ÄúËôöÊãüÂåñÊºèÊ¥û‚ÄùÈóÆÈ¢òÔºåÊïàÁéáËæÉ‰Ωé„ÄÇËÄåÈöèÁùÄIntel VT-xÁ≠âËôöÊãüÂåñÁ°¨‰ª∂ÊäÄÊúØÁöÑÂá∫Áé∞ÔºåÁ°¨‰ª∂ËæÖÂä©CPUËôöÊãüÂåñÊäÄÊúØÈÄêÊ∏êÊàê‰∏∫‰∏ªÊµÅ„ÄÇÊú¨ÊñáÂ∞ÜÊåâÁÖßÂ¶Ç‰∏ãÈ°∫Â∫èËøõË°å‰ªãÁªçÔºö\n">
<meta property='og:url' content='https://zcxggmu.github.io/p/kvmbook-cpu_2/'>
<meta property='og:site_name' content='zcxGGmu'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-10-17T10:06:27&#43;08:00'/><meta property='article:modified_time' content='2024-10-17T10:06:27&#43;08:00'/>
<meta name="twitter:title" content="Kvmbook Cpu_2">
<meta name="twitter:description" content="[TOC]\n1 Ê¶ÇËø∞ Êú¨Á´†Â∞ÜÊ∑±ÂÖ•‰ªãÁªçCPUËôöÊãüÂåñÈÉ®ÂàÜ„ÄÇÊó©ÊúüÁî±‰∫éÁº∫‰πèÁõ∏Â∫îÁ°¨‰ª∂ÁöÑÊîØÊåÅÔºåÂè™ËÉΩÈááÁî®Èô∑ÂÖ•-Ê®°Êãü„ÄÅÊâ´Êèè‰∏é‰øÆË°•„ÄÅ‰∫åËøõÂà∂ÁøªËØëÁ≠âËΩØ‰ª∂Ê®°ÊãüÁöÑÊñπÂºèËß£ÂÜ≥‚ÄúËôöÊãüÂåñÊºèÊ¥û‚ÄùÈóÆÈ¢òÔºåÊïàÁéáËæÉ‰Ωé„ÄÇËÄåÈöèÁùÄIntel VT-xÁ≠âËôöÊãüÂåñÁ°¨‰ª∂ÊäÄÊúØÁöÑÂá∫Áé∞ÔºåÁ°¨‰ª∂ËæÖÂä©CPUËôöÊãüÂåñÊäÄÊúØÈÄêÊ∏êÊàê‰∏∫‰∏ªÊµÅ„ÄÇÊú¨ÊñáÂ∞ÜÊåâÁÖßÂ¶Ç‰∏ãÈ°∫Â∫èËøõË°å‰ªãÁªçÔºö\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu16968365064894999835.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">zcxGGmu</a></h1>
            <h2 class="site-description">riscv, linux-kernel/kvm, llm-app/infer</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/zcxGGmu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#1-Ê¶ÇËø∞">1 Ê¶ÇËø∞</a>
      <ul>
        <li><a href="#11-ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÂ§ÑÁêÜ">1.1 ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÂ§ÑÁêÜ</a>
          <ul>
            <li><a href="#ÊïèÊÑüÊåá‰ª§ÁâπÊùÉÊåá‰ª§‰∏éÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§">ÊïèÊÑüÊåá‰ª§„ÄÅÁâπÊùÉÊåá‰ª§‰∏éÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§</a></li>
            <li><a href="#ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑËΩØ‰ª∂Ëß£ÂÜ≥ÊñπÊ°à">ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑËΩØ‰ª∂Ëß£ÂÜ≥ÊñπÊ°à</a></li>
            <li><a href="#ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à">ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à</a></li>
          </ul>
        </li>
        <li><a href="#12-ËôöÊãüÊú∫‰∏ä‰∏ãÊñáÂàáÊç¢">1.2 ËôöÊãüÊú∫‰∏ä‰∏ãÊñáÂàáÊç¢</a></li>
        <li><a href="#13-‰∏≠Êñ≠ËôöÊãüÂåñ">1.3 ‰∏≠Êñ≠ËôöÊãüÂåñ</a></li>
      </ul>
    </li>
    <li><a href="#2-intel-vt-xÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñ">2 Intel VT-xÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñ</a>
      <ul>
        <li><a href="#21-vmxÊìç‰ΩúÊ®°Âºè">2.1 VMXÊìç‰ΩúÊ®°Âºè</a></li>
        <li><a href="#22-vmcs">2.2 VMCS</a>
          <ul>
            <li><a href="#vmcsÊìç‰ΩúÊåá‰ª§">VMCSÊìç‰ΩúÊåá‰ª§</a></li>
            <li><a href="#vmcsÁªìÊûÑ">VMCSÁªìÊûÑ</a></li>
          </ul>
        </li>
        <li><a href="#23-picapic">2.3 PIC/APIC</a>
          <ul>
            <li><a href="#pic">PIC</a></li>
            <li><a href="#apic">APIC</a></li>
            <li><a href="#msi">MSI</a></li>
            <li><a href="#irq--gsi--vector--pin">IRQ &amp; GSI &amp; Vector &amp; Pin</a></li>
          </ul>
        </li>
        <li><a href="#24-intel-vt-x‰∏≠Êñ≠ËôöÊãüÂåñ">2.4 Intel VT-x‰∏≠Êñ≠ËôöÊãüÂåñ</a>
          <ul>
            <li><a href="#‰º†Áªü‰∏≠Êñ≠ËôöÊãüÂåñ">‰º†Áªü‰∏≠Êñ≠ËôöÊãüÂåñ</a></li>
            <li><a href="#apicvÊîØÊåÅÁöÑ‰∏≠Êñ≠ËôöÊãüÂåñ">APICvÊîØÊåÅÁöÑ‰∏≠Êñ≠ËôöÊãüÂåñ</a>
              <ul>
                <li><a href="#ËôöÊãüapicËÆøÈóÆ">ËôöÊãüAPICËÆøÈóÆ</a></li>
                <li><a href="#ËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§">ËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-qemukvm-cpuËôöÊãüÂåñÂÆûÁé∞">3 QEMU/KVM CPUËôöÊãüÂåñÂÆûÁé∞</a>
      <ul>
        <li><a href="#31-kvmÊ®°ÂùóÂàùÂßãÂåñ">3.1 KVMÊ®°ÂùóÂàùÂßãÂåñ</a></li>
        <li><a href="#32-ËôöÊãüÊú∫ÂàõÂª∫">3.2 ËôöÊãüÊú∫ÂàõÂª∫</a></li>
        <li><a href="#33-vcpuÂàõÂª∫">3.3 vCPUÂàõÂª∫</a></li>
        <li><a href="#34-vcpuËøêË°å">3.4 vCPUËøêË°å</a></li>
        <li><a href="#35-ÂÆûÈ™å-cpuËôöÊãüÂåñÂÆû‰æã">3.5 ÂÆûÈ™å: CPUËôöÊãüÂåñÂÆû‰æã</a></li>
      </ul>
    </li>
    <li><a href="#4-qemukvm-‰∏≠Êñ≠ËôöÊãüÂåñÂÆûÁé∞">4 QEMU/KVM ‰∏≠Êñ≠ËôöÊãüÂåñÂÆûÁé∞</a>
      <ul>
        <li><a href="#41-picioapicÊ®°Êãü">4.1 PIC/IOAPICÊ®°Êãü</a>
          <ul>
            <li><a href="#picÊ®°Êãü">PICÊ®°Êãü</a></li>
            <li><a href="#ioapicÊ®°Êãü">IOAPICÊ®°Êãü</a></li>
            <li><a href="#lapicÊ®°Êãü">LAPICÊ®°Êãü</a></li>
          </ul>
        </li>
        <li><a href="#42-pciËÆæÂ§á‰∏≠Êñ≠">4.2 PCIËÆæÂ§á‰∏≠Êñ≠</a>
          <ul>
            <li><a href="#pciËÆæÂ§á‰∏≠Êñ≠ÂéüÁêÜ">PCIËÆæÂ§á‰∏≠Êñ≠ÂéüÁêÜ</a></li>
            <li><a href="#pciËÆæÂ§á‰∏≠Êñ≠Ê®°Êãü"><strong>PCIËÆæÂ§á‰∏≠Êñ≠Ê®°Êãü</strong></a></li>
          </ul>
        </li>
        <li><a href="#43--qemukvm‰∏≠Êñ≠Ë∑ØÁî±">4.3  QEMU/KVM‰∏≠Êñ≠Ë∑ØÁî±</a>
          <ul>
            <li><a href="#qemu‰∏≠Êñ≠Ë∑ØÁî±">QEMU‰∏≠Êñ≠Ë∑ØÁî±</a></li>
            <li><a href="#kvm‰∏≠Êñ≠Ë∑ØÁî±">KVM‰∏≠Êñ≠Ë∑ØÁî±</a></li>
          </ul>
        </li>
        <li><a href="#44-ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•">4.4 ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•</a></li>
        <li><a href="#45-ÂÆûÈ™å-e1000ÁΩëÂç°‰∏≠Êñ≠ËôöÊãüÂåñ">4.5 ÂÆûÈ™å: e1000ÁΩëÂç°‰∏≠Êñ≠ËôöÊãüÂåñ</a>
          <ul>
            <li><a href="#ÂÆûÈ™åÊ¶ÇËø∞">ÂÆûÈ™åÊ¶ÇËø∞</a></li>
            <li><a href="#e1000ÁΩëÂç°‰∏≠Êñ≠‰º†ÈÄÅÊµÅÁ®ã">e1000ÁΩëÂç°‰∏≠Êñ≠‰º†ÈÄÅÊµÅÁ®ã</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#5-todo-giantvm-cpuËôöÊãüÂåñ">5 //TODO: GiantVM CPUËôöÊãüÂåñ</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/kvmbook-cpu_2/">Kvmbook Cpu_2</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-10-17</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 68 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>[TOC]</p>
<h1 id="1-Ê¶ÇËø∞">1 Ê¶ÇËø∞
</h1><p>Êú¨Á´†Â∞ÜÊ∑±ÂÖ•‰ªãÁªçCPUËôöÊãüÂåñÈÉ®ÂàÜ„ÄÇÊó©ÊúüÁî±‰∫éÁº∫‰πèÁõ∏Â∫îÁ°¨‰ª∂ÁöÑÊîØÊåÅÔºåÂè™ËÉΩÈááÁî®Èô∑ÂÖ•-Ê®°Êãü„ÄÅÊâ´Êèè‰∏é‰øÆË°•„ÄÅ‰∫åËøõÂà∂ÁøªËØëÁ≠âËΩØ‰ª∂Ê®°ÊãüÁöÑÊñπÂºèËß£ÂÜ≥‚ÄúËôöÊãüÂåñÊºèÊ¥û‚ÄùÈóÆÈ¢òÔºåÊïàÁéáËæÉ‰Ωé„ÄÇËÄåÈöèÁùÄIntel VT-xÁ≠âËôöÊãüÂåñÁ°¨‰ª∂ÊäÄÊúØÁöÑÂá∫Áé∞ÔºåÁ°¨‰ª∂ËæÖÂä©CPUËôöÊãüÂåñÊäÄÊúØÈÄêÊ∏êÊàê‰∏∫‰∏ªÊµÅ„ÄÇÊú¨ÊñáÂ∞ÜÊåâÁÖßÂ¶Ç‰∏ãÈ°∫Â∫èËøõË°å‰ªãÁªçÔºö</p>
<blockquote>
<ol>
<li>ÁÆÄË¶ÅÊ¶ÇËø∞CPUËôöÊãüÂåñ</li>
<li>‰ªãÁªçIntel VT-xÊèê‰æõÁöÑCPUËôöÊãüÂåñÁ°¨‰ª∂ÊîØÊåÅ</li>
<li>QEMU/KVM CPUËôöÊãüÂåñÂÆûÁé∞</li>
<li>QEMU/KVM ‰∏≠Êñ≠ËôöÊãüÂåñÂÆûÁé∞</li>
<li>‰ªãÁªçÊñ∞Âûã‚ÄúÂ§öËôö‰∏Ä‚ÄùÂºÄÊ∫êÈ°πÁõÆGiantVM‰∏≠CPUËôöÊãüÂåñÂíå‰∏≠Êñ≠ËôöÊãüÂåñÁöÑÂÆûÁé∞„ÄÇ</li>
</ol>
</blockquote>
<p>È¶ñÂÖàÂõûÈ°æÁâ©ÁêÜÁéØÂ¢É‰∏≠CPUÁöÑ‰∏ªË¶ÅÂäüËÉΩ„ÄÇ‰Ωú‰∏∫ËøêÁÆóÂçïÂÖÉÔºåCPU‰ªé‰∏ªÂ≠ò‰∏≠ÂèñÂá∫Êåá‰ª§Âπ∂ÊâßË°åÔºåÂú®Ê≠§ËøáÁ®ã‰∏≠CPUÈúÄË¶Å‰ªéÂØÑÂ≠òÂô®Êàñ‰∏ªÂ≠ò‰∏≠Ëé∑ÂèñÊìç‰ΩúÊï∞ÔºåÂπ∂Â∞ÜÁªìÊûúÂÜôÂõûÂØÑÂ≠òÂô®Êàñ‰∏ªÂ≠ò„ÄÇÊ≠§Â§ñÔºåCPUËøòÈúÄË¶ÅÂìçÂ∫î‰∏Ä‰∫õÂèëÁîüÁöÑÁ≥ªÁªü‰∫ã‰ª∂ÔºåËøô‰∫õÁ≥ªÁªü‰∫ã‰ª∂ÂèØËÉΩÊòØÁî±Êåá‰ª§ÊâßË°åËß¶ÂèëÔºåÂ¶ÇÈô§Èõ∂ÈîôËØØ„ÄÅÊÆµÈîôËØØÁ≠âÔºõ‰πüÊúâÂèØËÉΩÊòØÁî±Â§ñÈÉ®‰∫ã‰ª∂Ëß¶ÂèëÔºåÂ¶ÇÁΩëÂç°Êî∂Âà∞‰∫Ü‰∏Ä‰∏™ÁΩëÁªúÂåÖ„ÄÅÁ£ÅÁõòÊï∞ÊçÆ‰º†ËæìÂÆåÊàêÁ≠â„ÄÇÂú®Ëøô‰∫õ‰∫ã‰ª∂‰∏≠ÔºåÊúÄÂèóÂÖ≥Ê≥®ÁöÑÂ∞±ÊòØ‰∏≠Êñ≠ÂíåÂºÇÂ∏∏‰∫ã‰ª∂„ÄÇÁÆÄËÄåË®Ä‰πãÔºå**CPUÂ∫îÂΩìËÉΩÈ´òÊïàÊ≠£Á°ÆÂú∞ÊâßË°åÊâÄÊúâÊåá‰ª§Âπ∂ÂìçÂ∫î‰∏Ä‰∫õÂèëÁîüÁöÑÁ≥ªÁªü‰∫ã‰ª∂ÔºåËøô‰πüÊòØËôöÊãüÁéØÂ¢É‰∏≠vCPUÂ∫îÂΩìÂÆåÊàêÁöÑÂ∑•‰Ωú„ÄÇ**‰ΩÜÂú®ËôöÊãüÁéØÂ¢É‰∏≠ÔºåË¶ÅÂÆûÁé∞‰∏äËø∞ÂäüËÉΩÂç¥Èù¢‰∏¥‰∏Ä‰∫õÊåëÊàò„ÄÇ</p>
<h2 id="11-ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÂ§ÑÁêÜ">1.1 ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÂ§ÑÁêÜ
</h2><h3 id="ÊïèÊÑüÊåá‰ª§ÁâπÊùÉÊåá‰ª§‰∏éÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§">ÊïèÊÑüÊåá‰ª§„ÄÅÁâπÊùÉÊåá‰ª§‰∏éÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§
</h3><p>Âú®Áé∞‰ª£ËÆ°ÁÆóÊú∫Êû∂ÊûÑ‰∏≠ÔºåCPUÈÄöÂ∏∏Êã•Êúâ‰∏§‰∏™Êàñ‰∏§‰∏™‰ª•‰∏äÁöÑÁâπÊùÉÁ∫ßÔºåÂÖ∂‰∏≠Êìç‰ΩúÁ≥ªÁªüËøêË°åÂú®ÊúÄÈ´òÁâπÊùÉÁ∫ßÔºåÂÖ∂‰ΩôÁ®ãÂ∫èÂàôËøêË°åÂú®ËæÉ‰ΩéÁöÑÁâπÊùÉÁ∫ß„ÄÇËÄå‰∏Ä‰∫õÊåá‰ª§ÂøÖÈ°ªËøêË°åÂú®ÊúÄÈ´òÁâπÊùÉÁ∫ß‰∏≠ÔºåËã•Âú®ÈùûÊúÄÈ´òÁâπÊùÉÁ∫ß‰∏≠ÊâßË°åËøô‰∫õÊåá‰ª§Â∞Ü‰ºöËß¶ÂèëÁâπÊùÉÁ∫ßÂàáÊç¢ÔºåÈô∑ÂÖ•ÊúÄÈ´òÁâπÊùÉÁ∫ß‰∏≠ÔºåËøôÁ±ªÊåá‰ª§Áß∞‰∏∫**ÁâπÊùÉÊåá‰ª§„ÄÇ<strong>Âú®ËôöÊãüÂåñÁéØÂ¢É‰∏≠ÔºåËøòÊúâÂè¶‰∏ÄÁ±ªÊåá‰ª§Áß∞‰∏∫</strong>ÊïèÊÑüÊåá‰ª§Ôºå**Âç≥Êìç‰ΩúÊïèÊÑüÁâ©ÁêÜËµÑÊ∫êÁöÑÊåá‰ª§ÔºåÂ¶ÇI/OÊåá‰ª§„ÄÅÈ°µË°®Âü∫Âú∞ÂùÄÂàáÊç¢Êåá‰ª§Á≠â„ÄÇ</p>
<p>ËôöÊãüÂåñÁ≥ªÁªüÁöÑ‰∏â‰∏™Âü∫Êú¨Ë¶ÅÊ±ÇÔºöËµÑÊ∫êÊéßÂà∂„ÄÅÁ≠â‰ª∑‰∏éÈ´òÊïà„ÄÇËµÑÊ∫êÊéßÂà∂Ë¶ÅÊ±ÇHypervisorËÉΩÂ§üÊéßÂà∂ÊâÄÊúâÁöÑÁâ©ÁêÜËµÑÊ∫êÔºåËôöÊãüÊú∫ÂØπÊïèÊÑüÁâ©ÁêÜËµÑÊ∫êÔºàÈÉ®ÂàÜÂØÑÂ≠òÂô®„ÄÅI/OËÆæÂ§áÁ≠âÔºâÁöÑËÆøÈóÆÈÉΩÂ∫îÂú®HypervisorÁöÑÁõëÊéß‰∏ãËøõË°å„ÄÇËøôÊÑèÂë≥ÁùÄÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏≠ÔºåHypervisorÂ∫îÂΩìÊõø‰ª£Êìç‰ΩúÁ≥ªÁªüËøêË°åÂú®ÊúÄÈ´òÁâπÊùÉÁ∫ßÔºåÁÆ°ÁêÜÁâ©ÁêÜËµÑÊ∫êÂπ∂Âêë‰∏äÊèê‰æõÊúçÂä°ÔºåÂΩìËôöÊãüÊú∫ÊâßË°åÊïèÊÑüÊåá‰ª§Êó∂ÂøÖÈ°ªÈô∑ÂÖ•HypervisorÔºàÈÄöÂ∏∏Áß∞‰∏∫ËôöÊãüÊú∫‰∏ãÈô∑Ôºâ‰∏≠ËøõË°åÊ®°ÊãüÔºåËøôÁßçÊïèÊÑüÊåá‰ª§ÁöÑÂ§ÑÁêÜÊñπÂºèÁß∞‰∏∫‚ÄúÈô∑ÂÖ•-Ê®°Êãü‚ÄùÊñπÂºè„ÄÇ</p>
<p>‚ÄúÈô∑ÂÖ•-Ê®°Êãü‚Äù ÊñπÂºèË¶ÅÊ±ÇÊâÄÊúâÁöÑÊïèÊÑüÊåá‰ª§ÈÉΩËÉΩËß¶ÂèëÁâπÊùÉÁ∫ßÂàáÊç¢Ôºå‰ªéËÄåËÉΩÂ§üÈô∑ÂÖ•Hypervisor‰∏≠Â§ÑÁêÜÔºåÈÄöÂ∏∏Â∞ÜÊâÄÊúâÊïèÊÑüÊåá‰ª§ÈÉΩÊòØÁâπÊùÉÊåá‰ª§ÁöÑÊû∂ÊûÑÁß∞‰∏∫ÂèØËôöÊãüÂåñÊû∂ÊûÑÔºåÂèç‰πãÂ≠òÂú®ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÊû∂ÊûÑÁß∞‰∏∫‰∏çÂèØËôöÊãüÂåñÊû∂ÊûÑ„ÄÇÈÅóÊÜæÁöÑÊòØÔºåÂ§ßÂ§öÊï∞ËÆ°ÁÆóÊú∫Êû∂ÊûÑÂú®ËÆæËÆ°‰πãÂàùÂπ∂Êú™Â∞ÜËôöÊãüÂåñÊäÄÊúØËÄÉËôëÂú®ÂÜÖ„ÄÇ</p>
<blockquote>
<p>‰ª•Êó©ÊúüÁöÑx86Êû∂ÊûÑ‰∏∫‰æãÔºåÂÖ∂SGDTÔºàStore Global Descriptor TableÔºåÂ≠òÂÇ®ÂÖ®Â±ÄÊèèËø∞Á¨¶Ë°®ÔºâÊåá‰ª§Â∞ÜGDTRÔºàGlobal Descriptor Table RegisterÔºåÂÖ®Â±ÄÊèèËø∞Á¨¶Ë°®ÂØÑÂ≠òÂô®ÔºâÁöÑÂÄºÂ≠òÂÇ®Âà∞Êüê‰∏™ÂÜÖÂ≠òÂå∫Âüü‰∏≠ÔºåÂÖ∂‰∏≠ÂÖ®Â±ÄÊèèËø∞Á¨¶Ë°®Áî®‰∫éÂØªÂùÄÔºåÂ±û‰∫éÊïèÊÑüÁâ©ÁêÜËµÑÊ∫êÔºå‰ΩÜÊòØÂú®x86Êû∂ÊûÑ‰∏≠ÔºåSGDTÊåá‰ª§Âπ∂ÈùûÁâπÊùÉÊåá‰ª§ÔºåÊó†Ê≥ïËß¶ÂèëÁâπÊùÉÁ∫ßÂàáÊç¢„ÄÇ</p>
</blockquote>
<p>Âú®x86Êû∂ÊûÑ‰∏≠Á±ª‰ººSGDTÁöÑÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§Â§öËææ17Êù°ÔºåIntelÂ∞ÜËøô‰∫õÊåá‰ª§Áß∞‰∏∫‚ÄúËôöÊãüÂåñÊºèÊ¥û‚Äù„ÄÇ**Âú®‰∏çÂèØËôöÊãüÂåñÊû∂ÊûÑ‰∏ãÔºå‰∏∫‰∫Ü‰ΩøHypervisorÊà™Ëé∑Âπ∂Ê®°Êãü‰∏äËø∞ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§Ôºå‰∏ÄÁ≥ªÂàóËΩØ‰ª∂ÊñπÊ°àÂ∫îËøêËÄåÁîüÔºå**‰∏ãÈù¢‰ªãÁªçËøô‰∫õËΩØ‰ª∂Ëß£ÂÜ≥ÊñπÊ°à„ÄÇ</p>
<h3 id="ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑËΩØ‰ª∂Ëß£ÂÜ≥ÊñπÊ°à">ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑËΩØ‰ª∂Ëß£ÂÜ≥ÊñπÊ°à
</h3><p>ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑËΩØ‰ª∂Ëß£ÂÜ≥ÊñπÊ°à‰∏ªË¶ÅÂåÖÊã¨<strong>Ëß£ÈáäÊâßË°å„ÄÅ‰∫åËøõÂà∂ÁøªËØë„ÄÅÊâ´Êèè‰∏é‰øÆË°•‰ª•ÂèäÂçäËôöÊãüÂåñÊäÄÊúØ„ÄÇ</strong></p>
<ul>
<li>**Ëß£ÈáäÊâßË°åÊäÄÊúØ„ÄÇ**Ëß£ÈáäÊâßË°åÊäÄÊúØÈááÁî®ËΩØ‰ª∂Ê®°ÊãüÁöÑÊñπÂºèÈÄêÊù°Ê®°ÊãüËôöÊãüÊú∫Êåá‰ª§ÁöÑÊâßË°å„ÄÇËß£ÈáäÂô®Â∞ÜÁ®ãÂ∫è‰∫åËøõÂà∂Ëß£Á†ÅÂêéË∞ÉÁî®Êåá‰ª§Áõ∏Â∫îÁöÑÊ®°ÊãüÂáΩÊï∞ÔºåÂØπÂØÑÂ≠òÂô®ÁöÑÊõ¥ÊîπÂàôÂèò‰∏∫‰øÆÊîπ‰øùÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑËôöÊãüÂØÑÂ≠òÂô®ÁöÑÂÄº„ÄÇ</li>
<li>**‰∫åËøõÂà∂ÁøªËØëÊäÄÊúØ„ÄÇ**Âå∫Âà´‰∫éËß£ÈáäÊâßË°åÊäÄÊúØ‰∏çÂä†Âå∫ÂàÜÂú∞ÁøªËØëÊâÄÊúâÊåá‰ª§Ôºå‰∫åËøõÂà∂ÁøªËØëÊäÄÊúØÂàô‰ª•Âü∫Êú¨Âùó‰∏∫Âçï‰ΩçÔºåÂ∞ÜËôöÊãüÊú∫Êåá‰ª§ÊâπÈáèÁøªËØëÂêé‰øùÂ≠òÂú®‰ª£Á†ÅÁºìÂ≠ò‰∏≠ÔºåÂü∫Êú¨Âùó‰∏≠ÁöÑÊïèÊÑüÊåá‰ª§‰ºöË¢´ÊõøÊç¢‰∏∫‰∏ÄÁ≥ªÂàóÂÖ∂‰ªñÊåá‰ª§„ÄÇ</li>
<li>**Êâ´Êèè‰∏é‰øÆË°•ÊäÄÊúØ„ÄÇ**Êâ´Êèè‰∏é‰øÆË°•ÊäÄÊúØÊòØÂú®ÊâßË°åÊØèÊÆµ‰ª£Á†ÅÂâçÂØπÂÖ∂ËøõË°åÊâ´ÊèèÔºåÊâæÂà∞ÂÖ∂‰∏≠ÁöÑÊïèÊÑüÊåá‰ª§ÔºåÂ∞ÜÂÖ∂ÊõøÊç¢‰∏∫ÁâπÊùÉÊåá‰ª§ÔºåÂΩìCPUÊâßË°åÁøªËØëÂêéÁöÑ‰ª£Á†ÅÊó∂ÔºåÈÅáÂà∞ÊõøÊç¢ÂêéÁöÑÁâπÊùÉÊåá‰ª§‰æø‰ºöÈô∑ÂÖ•Hypervisor‰∏≠ËøõË°åÊ®°ÊãüÔºåÊâßË°åÂØπÂ∫îÁöÑË°•‰∏Å‰ª£Á†Å„ÄÇ</li>
<li>**ÂçäËôöÊãüÂåñÊäÄÊúØ„ÄÇ**‰∏äËø∞‰∏âÁßçÊñπÂºèÈÉΩÊòØÈÄöËøáÊâ´Êèè‰∫åËøõÂà∂‰ª£Á†ÅÊâæÂà∞ÂÖ∂‰∏≠ÊïèÊÑüÊåá‰ª§ÔºåÂçäËôöÊãüÂåñÂàôÂÖÅËÆ∏ËôöÊãüÊú∫Âú®ÊâßË°åÊïèÊÑüÊåá‰ª§Êó∂ÈÄöËøáË∂ÖË∞ÉÁî®‰∏ªÂä®Èô∑ÂÖ•Hypervisor‰∏≠ÔºåÈÅøÂÖç‰∫ÜÊâ´ÊèèÁ®ãÂ∫è‰∫åËøõÂà∂‰ª£Á†ÅÂºïÂÖ•ÁöÑÂºÄÈîÄ„ÄÇ</li>
</ul>
<p>‰∏äËø∞Ëß£ÂÜ≥ÊñπÊ°àÁöÑ‰ºòÁº∫ÁÇπÂ¶Ç‰∏ãË°®ÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221415290.png" alt="image-20231122141503318" style="zoom:33%;" />
<p>ËøôÂá†ÁßçÊñπÊ°àÈÄöËøáËΩØ‰ª∂Ê®°ÊãüËß£ÂÜ≥‰∫ÜÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÈóÆÈ¢òÔºå‰ΩÜÂç¥‰∫ßÁîü‰∫ÜÂ∑®Â§ßÁöÑËΩØ‰ª∂ÂºÄÈîÄ„ÄÇ**ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§Á©∂ÂÖ∂Êú¨Ë¥®ÊòØÁ°¨‰ª∂Êû∂ÊûÑÁº∫‰πèÂØπ‰∫éÊïèÊÑüÊåá‰ª§‰∏ãÈô∑ÁöÑÊîØÊåÅÔºå**ËøëÂπ¥Êù•ÂêÑ‰∏ªÊµÅÊû∂ÊûÑÈÉΩ‰ªéÊû∂ÊûÑÂ±ÇÈù¢Âº•Ë°•‰∫Ü‚ÄúËôöÊãüÂåñÊºèÊ¥û‚ÄùÔºåËß£ÂÜ≥‰∫ÜÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÈô∑ÂÖ•-Ê®°ÊãüÈóÆÈ¢òÔºå‰∏ãÈù¢ÁÆÄË¶Å‰ªãÁªçËøô‰∫õÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à„ÄÇ</p>
<h3 id="ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à">ÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à
</h3><p>ÂâçÈù¢ÊèêÂà∞ÔºåÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§Â≠òÂú®ÁöÑÊ†πÊú¨ÂéüÂõ†ÊòØÁ°¨‰ª∂Êû∂ÊûÑÁº∫‰πèÂØπÊïèÊÑüÊåá‰ª§‰∏ãÈô∑ÁöÑÊîØÊåÅ„ÄÇÂõ†Ê≠§ÊúÄÁÆÄÂçïÁöÑ‰∏ÄÁßçÂäûÊ≥ïÊòØÊõ¥ÊîπÁé∞ÊúâÁöÑÁ°¨‰ª∂Êû∂ÊûÑÔºåÂ∞ÜÊâÄÊúâÁöÑÊïèÊÑüÊåá‰ª§ÈÉΩÂèò‰∏∫ÁâπÊùÉÊåá‰ª§Ôºå‰Ωø‰πãËÉΩËß¶ÂèëÁâπÊùÉÁ∫ßÂàáÊç¢Ôºå‰ΩÜÊòØËøôÂ∞ÜÊîπÂèòÁé∞ÊúâÊåá‰ª§ÁöÑËØ≠‰πâÔºåÁé∞ÊúâÁ≥ªÁªü‰πüÂøÖÈ°ªÊõ¥ÊîπÊù•ÈÄÇÈÖç‰∏äËø∞ÊîπÂä®„ÄÇ</p>
<p>Âè¶‰∏ÄÁßçÂäûÊ≥ïÊòØ**ÂºïÂÖ•ËôöÊãüÂåñÊ®°Âºè„ÄÇ**Êú™ÂºÄÂêØËôöÊãüÂåñÊ®°ÂºèÊó∂ÔºåÊìç‰ΩúÁ≥ªÁªü‰∏éÂ∫îÁî®Á®ãÂ∫èËøêË°åÂú®ÂéüÊúâÁöÑÁâπÊùÉÁ∫ßÔºå‰∏ÄÂàáË°å‰∏∫Â¶ÇÂ∏∏ÔºåÂÖºÂÆπÂéüÊúâÁ≥ªÁªüÔºõÂºÄÂêØËôöÊãüÂåñÊ®°ÂºèÂêéÔºåHypervisorËøêË°åÂú®ÊúÄÈ´òÁâπÊùÉÁ∫ßÔºåËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªü‰∏éÂ∫îÁî®Á®ãÂ∫èËøêË°åÂú®ËæÉ‰ΩéÁâπÊùÉÁ∫ßÔºåËôöÊãüÊú∫ÊâßË°åÊïèÊÑüÊåá‰ª§Â∞Ü‰ºöËß¶ÂèëÁâπÊùÉÁ∫ßÂàáÊç¢Èô∑ÂÖ•Hypervisor‰∏≠ËøõË°åÊ®°Êãü„ÄÇËôöÊãüÂåñÊ®°Âºè‰∏éÈùûËôöÊãüÂåñÊ®°ÂºèÊû∂ÊûÑÂ¶ÇÂõæ2-1ÊâÄÁ§∫„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221417410.png" alt="image-20231122141655482" style="zoom: 50%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†Èô∑ÂÖ•Ôºõ‚ë°ÊÅ¢Â§çÔºõ‚ë¢ÂºÄÂêØËôöÊãüÂåñÊ®°ÂºèÔºõ‚ë£ÂÖ≥Èó≠ËôöÊãüÂåñÊ®°Âºè„ÄÇ</p>
</blockquote>
<p>ÈùûËôöÊãüÂåñÊ®°ÂºèÈÄöÂ∏∏Âè™ÈúÄË¶Å‰∏§‰∏™ÁâπÊùÉÁ∫ßÔºåËÄåËôöÊãüÂåñÊ®°ÂºèÈúÄË¶ÅËá≥Â∞ë‰∏â‰∏™ÁâπÊùÉÁ∫ßÁî®‰∫éÂå∫ÂàÜËôöÊãüÊú∫Â∫îÁî®Á®ãÂ∫è„ÄÅËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªü‰∏éHypervisorÁöÑÊéßÂà∂ÊùÉÈôêÔºåÊ≠§Â§ñËøòÈúÄË¶ÅÂºïÂÖ•Áõ∏Â∫îÁöÑÊåá‰ª§ÂºÄÂêØÂíåÂÖ≥Èó≠ËôöÊãüÂåñÊ®°Âºè„ÄÇËôöÊãüÂåñÊ®°ÂºèÂØπÁé∞ÊúâËΩØ‰ª∂ÂΩ±ÂìçËæÉÂ∞èÔºåHypervisorËÉΩÂ§ü‰Ωú‰∏∫Áã¨Á´ãÁöÑÊäΩË±°Â±ÇËøêË°å‰∫éÁ≥ªÁªü‰∏≠ÔºåÂõ†Ê≠§ÂΩì‰∏ãÂ§ßÂ§öÊï∞ËôöÊãüÂåñÁ°¨‰ª∂ÈÉΩÈááÁî®ËØ•ÊñπÂºèÔºö</p>
<ul>
<li>Intel VT-x‰∏∫CPUÂºïÂÖ•‰∫ÜÊ†πÊ®°Âºè‰∏éÈùûÊ†πÊ®°ÂºèÔºåÂàÜÂà´‰æõHypervisorÂíåËôöÊãüÊú∫ËøêË°åÔºõ</li>
<li>ARM v8Âú®ÂéüÊúâEL0‰∏éEL1ÁöÑÂü∫Á°Ä‰∏äÂºïÂÖ•‰∫ÜÊñ∞ÁöÑÂºÇÂ∏∏Á∫ßEL2‰æõHypervisorËøêË°åÔºõ</li>
<li>RISC-V Hypervisor ExtensionÂàôÊ∑ªÂä†‰∫Ü‰∏§‰∏™È¢ùÂ§ñÁöÑÁâπÊùÉÁ∫ßÔºåÂç≥VS/VU‰æõËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªüÂíåËôöÊãüÊú∫Â∫îÁî®Á®ãÂ∫èËøêË°åÔºåÂéüÊú¨ÁöÑSÁâπÊùÉÁ∫ßÂèò‰∏∫HSÔºåHypervisorËøêË°åÂú®ËØ•ÁâπÊùÉÁ∫ß‰∏ã„ÄÇ</li>
</ul>
<p>ËôöÊãüÂåñÊ®°ÂºèÁöÑÂºïÂÖ•Ëß£ÂÜ≥‰∫ÜÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑÈô∑ÂÖ•‰ª•ÂèäÁ≥ªÁªüÂÖºÂÆπÊÄßÈóÆÈ¢òÔºå‰ΩÜÊòØ**ÁâπÊùÉÁ∫ßÁöÑÂ¢ûÂä†‰πüÂ∏¶Êù•‰∫Ü‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò„ÄÇ**‰∏ãÈù¢‰ªãÁªçËôöÊãüÂåñÁéØÂ¢É‰∏≠ÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢„ÄÇ</p>
<h2 id="12-ËôöÊãüÊú∫‰∏ä‰∏ãÊñáÂàáÊç¢">1.2 ËôöÊãüÊú∫‰∏ä‰∏ãÊñáÂàáÊç¢
</h2><p>Âú®Êìç‰ΩúÁ≥ªÁªüÁöÑËøõÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢‰∏≠ÔºåÊìç‰ΩúÁ≥ªÁªü‰∏éÁî®Êà∑ÊÄÅÁ®ãÂ∫èËøêË°åÂú®‰∏çÂêåÁöÑÁâπÊùÉÁ∫ß‰∏≠ÔºåÂΩìÁî®Êà∑ÊÄÅÁ®ãÂ∫èÂèëËµ∑Á≥ªÁªüË∞ÉÁî®Êó∂ÔºåÈúÄË¶ÅÂ∞ÜÈÉ®ÂàÜÁ®ãÂ∫èÁä∂ÊÄÅ‰øùÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠ÔºåÂæÖÁ≥ªÁªüË∞ÉÁî®ÂÆåÊàêÂêéÂÜç‰ªéÂÜÖÂ≠ò‰∏≠ÊÅ¢Â§çÁ®ãÂ∫èÁä∂ÊÄÅ„ÄÇ</p>
<p>ËÄåÂú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåÂΩìËôöÊãüÊú∫ÊâßË°åÊïèÊÑüÊåá‰ª§Êó∂ÔºåÈúÄË¶ÅÈô∑ÂÖ•HypervisorËøõË°åÂ§ÑÁêÜÔºåHypervisor‰∏éËôöÊãüÊú∫ÂêåÊ†∑ËøêË°åÂú®‰∏çÂêåÁöÑÁâπÊùÉÁ∫ß‰∏≠ÔºåÂõ†Ê≠§Á°¨‰ª∂Â∫îÂΩìÊèê‰æõ‰∏ÄÁßçÊú∫Âà∂Âú®ÂèëÁîüËôöÊãüÊú∫‰∏ãÈô∑Êó∂‰øùÂ≠òËôöÊãüÊú∫ÁöÑ‰∏ä‰∏ãÊñá„ÄÇÁ≠âÂà∞ÊïèÊÑüÊåá‰ª§Ê®°ÊãüÂÆåÊàêÂêéÔºåÂΩìËôöÊãüÊú∫ÊÅ¢Â§çËøêË°åÊó∂ÈáçÊñ∞Âä†ËΩΩËôöÊãüÊú∫‰∏ä‰∏ãÊñá„ÄÇ</p>
<blockquote>
<p>Ê≠§Â§ÑÔºå‚ÄúËôöÊãüÊú∫‰∏ä‰∏ãÊñá‚ÄùË°®Ëø∞ÂèØËÉΩÊúâ‰∫õ‰∏çÂáÜÁ°ÆÔºåÊõ¥ÂáÜÁ°ÆÁöÑËØ¥Ê≥ïÂ∫îÂΩìÊòØ‚ÄúvCPU‰∏ä‰∏ãÊñá‚Äù„ÄÇ</p>
</blockquote>
<p>‰∏Ä‰∏™ËôöÊãüÊú∫‰∏≠ÂèØËÉΩÂåÖÂê´Â§ö‰∏™vCPUÔºåËôöÊãüÊú∫‰∏≠Êåá‰ª§ÊâßË°åÂçïÂÖÉÊòØvCPUÔºåHypervisorË∞ÉÂ∫¶ËôöÊãüÊú∫ËøêË°åÁöÑÂü∫Êú¨Âçï‰Ωç‰πüÊòØvCPU„ÄÇÂΩìvCPU AÊâßË°åÊïèÊÑüÊåá‰ª§Èô∑ÂÖ•HypervisorÊó∂ÔºåvCPU BÂ∞Ü‰ºöÁªßÁª≠ËøêË°å„ÄÇÂú®Â§ßÈÉ®ÂàÜHypervisor‰∏≠ÔºåvCPUÂØπÂ∫î‰∏Ä‰∏™Á∫øÁ®ãÔºåÈÄöËøáÂàÜÊó∂Â§çÁî®ÁöÑÊñπÂºèÂÖ±‰∫´Áâ©ÁêÜCPU„ÄÇ</p>
<p>‰ª•vCPUÂàáÊç¢‰∏∫‰æãËØ¥Êòé‰∏ä‰∏ãÊñáÂàáÊç¢ÁöÑÊµÅÁ®ãÔºåvCPUÂàáÊç¢ÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÂÖ∂‰∏≠<strong>ÂÆûÁ∫øË°®Á§∫ÊéßÂà∂ÊµÅÔºåËôöÁ∫øË°®Á§∫Êï∞ÊçÆÊµÅ„ÄÇ</strong></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221419129.png" alt="image-20231122141910313" style="zoom:50%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†‰øùÂ≠òvCPUÂØÑÂ≠òÂô®Ôºõ‚ë°Âä†ËΩΩHypervisorÂØÑÂ≠òÂô®Ôºõ‚ë¢‰øùÂ≠òHypervisorÂØÑÂ≠òÂô®Ôºõ‚ë£Âä†ËΩΩvCPUÂØÑÂ≠òÂô®Ôºõ‚ë§Êåá‰ª§ÊâßË°åÈ°∫Â∫è„ÄÇ</p>
</blockquote>
<p>ÂèØ‰ª•ÁúãÂà∞ÔºöÂΩìvCPU 1Êó∂Èó¥ÁâáÁî®Â∞ΩÊó∂ÔºåHypervisorÂ∞Ü‰ºö‰∏≠Êñ≠vCPU 1ÊâßË°åÔºåvCPU 1Èô∑ÂÖ•Hypervisor‰∏≠ÔºàËßÅÂõæ‰∏≠Ê†áÂè∑IÔºâ„ÄÇÂú®Ê≠§ËøáÁ®ã‰∏≠ÔºåÁ°¨‰ª∂Â∞ÜvCPU 1ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òËá≥Âõ∫ÂÆöÂå∫ÂüüÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë†ÔºâÔºåÂπ∂‰ªé‰∏≠Âä†ËΩΩHypervisorÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë°Ôºâ„ÄÇHypervisorËøõË°åvCPUË∞ÉÂ∫¶ÔºåÈÄâÊã©‰∏ã‰∏Ä‰∏™ËøêË°åÁöÑvCPUÔºå‰øùÂ≠òHypervisorÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë¢ÔºâÔºåÂπ∂Âä†ËΩΩÈÄâÂÆöÁöÑvCPU 2ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë£ÔºâÔºåËÄåÂêéÊÅ¢Â§çvCPU 2ËøêË°åÔºàËßÅÂõæ‰∏≠Ê†áÂè∑IIÔºâ„ÄÇ</p>
<p>‰∏äËø∞Âõ∫ÂÆöÂå∫Âüü‰∏éÁ≥ªÁªüÊû∂ÊûÑÂÆûÁé∞ÂØÜÂàáÁõ∏ÂÖ≥Ôºå‰ª•Intel VT-x/ARMv8‰∏∫‰æãÔºö</p>
<ul>
<li>Âú®Intel VT-x‰∏≠ÔºåËôöÊãüÊú∫‰∏éHypervisorÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òÂú®VMCSÔºàVirtual Machine Control StructureÔºåËôöÊãüÊú∫ÊéßÂà∂ÁªìÊûÑÔºâ‰∏≠ÔºåVMCSÊòØÂÜÖÂ≠ò‰∏≠ÁöÑ‰∏ÄÂùóÂõ∫ÂÆöÂå∫ÂüüÔºåÈÄöËøá <code>VMREAD/VMWRITE</code> Êåá‰ª§ËøõË°åËØªÂÜôÔºõ</li>
<li>ËÄåARM v8Âàô‰∏∫EL1ÂíåEL2Êèê‰æõ‰∫Ü‰∏§Â•óÁ≥ªÁªüÂØÑÂ≠òÂô®ÔºåÂõ†Ê≠§ÂçïÁ∫ØÂèëÁîüËôöÊãüÊú∫‰∏ãÈô∑Êó∂ÔºåÊó†È°ª‰øùÂ≠òÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºõ‰ΩÜÊòØËôöÊãüÊú∫‰∏ãÈô∑ÂêéÔºåËã•Ë¶ÅËøêË°åÂÖ∂‰ªñvCPUÔºåÂàôÈúÄË¶ÅÂ∞Ü‰∏ä‰∏Ä‰∏™vCPUÁä∂ÊÄÅ‰øùÂ≠òËá≥ÂÜÖÂ≠ò‰∏≠„ÄÇ</li>
</ul>
<p>ÂêéÁª≠Á´†ËäÇÂ∞Ü‰ª•Intel VT-x‰∏∫‰æã‰ªãÁªç‰∏ä‰∏ãÊñáÂàáÊç¢ËøáÁ®ã‰∏≠VMCSÁöÑÂÖ∑‰ΩìÁî®Ê≥ï„ÄÇ</p>
<h2 id="13-‰∏≠Êñ≠ËôöÊãüÂåñ">1.3 ‰∏≠Êñ≠ËôöÊãüÂåñ
</h2><p>ÂâçÈù¢ÊèêÂà∞ÔºåvCPU‰∏ç‰ªÖË¶ÅËÉΩÈ´òÊïàÂú∞ÊâßË°åÊâÄÊúâÊåá‰ª§ÔºåËøòË¶ÅËÉΩÊ≠£Á°ÆÂ§ÑÁêÜÁ≥ªÁªü‰∏≠Âá∫Áé∞ÁöÑ‰∏≠Êñ≠ÂíåÂºÇÂ∏∏‰∫ã‰ª∂„ÄÇÂ§ßÈÉ®ÂàÜÂºÇÂ∏∏ÔºàÂ¶ÇÈô§Èõ∂ÈîôËØØ„ÄÅÈùûÊ≥ïÊåá‰ª§Á≠âÔºâÊó†È°ªËôöÊãüÂåñÔºåÁõ¥Êé•‰∫§ÁªôËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªüÂ§ÑÁêÜÂç≥ÂèØ„ÄÇËÄåÂØπ‰∫éÈÉ®ÂàÜÈúÄË¶ÅËôöÊãüÂåñÁöÑÂºÇÂ∏∏ÔºåÂàôÈúÄË¶ÅÈô∑ÂÖ•Hypervisor‰∏≠ËøõË°åÁõ∏Â∫îÁöÑÂ§ÑÁêÜÔºåÊ≤°ÊúâÂõ∫ÂÆöÁöÑËß£ÂÜ≥ÊñπÊ°à„ÄÇ</p>
<blockquote>
<p>ÂÜÖÂ≠òËôöÊãüÂåñÊñáÊ°£‰∏≠Â∞Ü‰ºö‰ªãÁªçHypervisorÂ¶Ç‰ΩïÂ§ÑÁêÜËôöÊãüÊú∫Áº∫È°µÂºÇÂ∏∏„ÄÇÊú¨ËäÇ‰∏ªË¶ÅÂÖ≥Ê≥®‰∏≠Êñ≠ËôöÊãüÂåñÁöÑÁõ∏ÂÖ≥ÂÜÖÂÆπ„ÄÇ</p>
</blockquote>
<p>‰∏≠Êñ≠ÊòØÂ§ñÈÉ®ËÆæÂ§áËØ∑Ê±ÇÊìç‰ΩúÁ≥ªÁªüÊúçÂä°ÁöÑ‰∏ÄÁßçÊñπÂºèÔºåÈÄöÂ∏∏Áî±Â§ñÈÉ®ËÆæÂ§áÂèëËµ∑ÔºåÁªèÁî±‰∏≠Êñ≠ÊéßÂà∂Âô®ÂèëÈÄÅÁªôCPU„ÄÇ‰ª•Á£ÅÁõò‰∏∫‰æãÔºåÂú®Áâ©ÁêÜÁéØÂ¢É‰∏ãÔºåÊìç‰ΩúÁ≥ªÁªüÂèëËµ∑‰∏Ä‰∏™ËØªÁ£ÅÁõòËØ∑Ê±ÇÔºåÁ£ÅÁõòÂ∞ÜÊìç‰ΩúÁ≥ªÁªüËØ∑Ê±ÇÁöÑÊï∞ÊçÆÊîæÁΩÆÂú®ÊåáÂÆö‰ΩçÁΩÆÂêéÁªô‰∏≠Êñ≠ÊéßÂà∂Âô®ÂèëÈÄÅ‰∏Ä‰∏™‰∏≠Êñ≠ËØ∑Ê±ÇÔºå‰∏≠Êñ≠ÊéßÂà∂Âô®Êé•Êî∂ÂêéËÆæÁΩÆÂ•ΩÂÜÖÈÉ®Áõ∏Â∫îÂØÑÂ≠òÂô®ÔºåCPUÊØèÊ¨°ÊâßË°åÊåá‰ª§ÂâçÈÉΩ‰ºöÊ£ÄÊü•‰∏≠Êñ≠ÊéßÂà∂Âô®‰∏≠ÊòØÂê¶Â≠òÂú®Êú™Â§ÑÁêÜÁöÑ‰∏≠Êñ≠ÔºåËã•ÊúâÂàôË∞ÉÁî®Áõ∏Â∫îÁöÑISRÔºàInterrupt Service RoutineÔºå‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ãÔºâËøõË°åÂ§ÑÁêÜ„ÄÇ</p>
<p>**ËÄåÂú®ËôöÊãüÁéØÂ¢É‰∏ãÔºåÂèØËÉΩÂ≠òÂú®Â§ö‰∏™ËôöÊãüÊú∫ÂêåÊó∂ËøêË°åÁöÑÊÉÖÂÜµÔºåÂÆÉ‰ª¨ÈÄöËøáËôöÊãüËÆæÂ§áÂÖ±Áî®Áâ©ÁêÜÁ£ÅÁõòÔºåÊ≠§Êó∂Ëã•Á£ÅÁõò‰∫ßÁîü‰∏Ä‰∏™Áâ©ÁêÜ‰∏≠Êñ≠ÔºåËØ•‰∏≠Êñ≠Â∫îËØ•‰∫§ÁªôÂì™‰∏Ä‰∏™ËôöÊãüÊú∫ÁöÑÊìç‰ΩúÁ≥ªÁªüÂ§ÑÁêÜÂë¢Ôºü**Âç≥Â¶Ç‰ΩïÂ∞ÜËØ•‰∏≠Êñ≠Ê≥®ÂÖ•ÂèëËµ∑ËØªÁ£ÅÁõòÊìç‰ΩúÁöÑËôöÊãüÊú∫‰∏≠Ôºå‰ΩøËØ•ËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªüÊâßË°åÁõ∏Â∫îÁöÑISR„ÄÇ</p>
<p>Âú®ËôöÊãüÂåñÁéØÂ¢É‰∏ãÔºåËÆæÂ§á‰∏é‰∏≠Êñ≠ÊéßÂà∂Âô®ÂùáÁî±HypervisorÊ®°ÊãüÔºåÁõ∏Â∫îÂØÑÂ≠òÂô®ÁöÑÁä∂ÊÄÅÂØπÂ∫î‰∫éÂÜÖÂ≠ò‰∏≠Êüê‰∫õÊï∞ÊçÆÁªìÊûÑÁöÑÂÄº„ÄÇÂΩìËôöÊãüÊú∫ÊâßË°åI/OÊåá‰ª§Êó∂Ôºå‰ºöÈô∑ÂÖ•Hypervisor‰∏≠ËøõË°åÂ§ÑÁêÜÔºåHypervisorË∞ÉÁî®Áõ∏Â∫îÁöÑËÆæÂ§áÈ©±Âä®ÂÆåÊàêI/OÊìç‰Ωú„ÄÇÂú®‰∏äËø∞ËøáÁ®ã‰∏≠ÔºåHypervisor‰∏ç‰ªÖÁü•ÈÅìÂèëËµ∑I/OÊìç‰ΩúÁöÑËôöÊãüÊú∫ÁöÑËØ¶ÁªÜ‰ø°ÊÅØÔºåËøòËÉΩÈÄöËøáËÆæÁΩÆËôöÊãüËÆæÂ§áÂíåËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰ªéËÄåÂÆåÊàê‰∏≠Êñ≠Ê≥®ÂÖ•„ÄÇÂõ†Ê≠§‰∏Ä‰∏™ÁêÜÊÉ≥ÁöÑÊñπÊ°àÊòØÂ∞ÜËØ•Áâ©ÁêÜ‰∏≠Êñ≠‰∫§ÁªôHypervisorÂ§ÑÁêÜÔºåÂÜçÁî±HypervisorËÆæÁΩÆËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºåÊ≥®ÂÖ•‰∏Ä‰∏™ËôöÊãü‰∏≠Êñ≠Âà∞ËôöÊãüÊú∫‰∏≠„ÄÇ</p>
<p>‰ªç‰ª•ËØªÁ£ÅÁõò‰∏∫‰æãÔºå‰∏≠Êñ≠ËôöÊãüÂåñÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221422001.png" alt="image-20231122142204573" style="zoom:50%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†ÂêëËôöÊãüÁ£ÅÁõòÂèëËµ∑ËØªËØ∑Ê±ÇÔºõ‚ë°ËôöÊãüÊú∫‰∏ãÈô∑Ôºõ‚ë¢HypervisorÂêëÁâ©ÁêÜÁ£ÅÁõòÂèëËµ∑ËØªËØ∑Ê±ÇÔºõ‚ë£Âêë‰∏≠Êñ≠ÊéßÂà∂Âô®Êèê‰∫§‰∏≠Êñ≠Ôºõ‚ë§ÊâßË°å‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ãÔºõ‚ë•HypervisorËÆæÁΩÆËôöÊãüÁ£ÅÁõò‰∏éËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®Ôºõ‚ë¶ÊÅ¢Â§çËôöÊãüÊú∫ÊâßË°åÔºõ‚ëßËôöÊãüÊú∫ÊâßË°å‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ã„ÄÇ</p>
</blockquote>
<p>ËôöÊãüÊú∫ÂèëËµ∑‰∏Ä‰∏™ËØªÁ£ÅÁõòËØ∑Ê±ÇÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë†ÔºâËß¶ÂèëËôöÊãüÊú∫‰∏ãÈô∑ËøõÂÖ•HypervisorËøõË°åÂ§ÑÁêÜÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë°ÔºâÔºåHypervisorÂêëÁâ©ÁêÜÁ£ÅÁõòÂèëËµ∑ËØªÁ£ÅÁõòËØ∑Ê±ÇÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë¢ÔºâÔºåÁâ©ÁêÜÁ£ÅÁõòÂÆåÊàêÊï∞ÊçÆËØªËØ∑Ê±ÇÂêé‰∫ßÁîü‰∏Ä‰∏™‰∏≠Êñ≠Âπ∂ÈÄí‰∫§ÁªôÁâ©ÁêÜ‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë£ÔºâÔºåHypervisorÊâßË°åÁõ∏Â∫îÁöÑ‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ãÂÆåÊàêÊï∞ÊçÆËØªÂèñÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë§ÔºâÔºåÂπ∂ËÆæÁΩÆËôöÊãüÁ£ÅÁõòÂíåËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®Áõ∏Â∫îÂØÑÂ≠òÂô®ÁöÑÁä∂ÊÄÅÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë•ÔºâÔºåËÄåÂêéHypervisorÊÅ¢Â§çËôöÊãüÊú∫ËøêË°åÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ë¶ÔºâÔºåËôöÊãüÊú∫ÂèëÁé∞ÊúâÂæÖÂ§ÑÁêÜÁöÑ‰∏≠Êñ≠ÔºåË∞ÉÁî®Áõ∏Â∫îÁöÑ‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ãÔºàËßÅÂõæ‰∏≠Ê†áÂè∑‚ëßÔºâ„ÄÇ</p>
<p>‰∏äËø∞ÊµÅÁ®ãÂØπÁ°¨‰ª∂ÊúâÂ¶Ç‰∏ãË¶ÅÊ±ÇÔºö</p>
<ul>
<li><strong>Áâ©ÁêÜ‰∏≠Êñ≠Â∞Ü‰ºöËß¶ÂèëËôöÊãüÊú∫‰∏ãÈô∑ËøõÂÖ•Hypervisor‰∏≠Â§ÑÁêÜÔºõ</strong></li>
<li><strong>ËôöÊãüÊú∫ÊÅ¢Â§çËøêË°åÊó∂Ë¶ÅÂÖàÊ£ÄÊü•ËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜ‰∏≠Êñ≠„ÄÇ</strong></li>
</ul>
<p>ÂêéÁª≠Á´†ËäÇÂ∞Ü‰ª•Intel VT-x‰∏∫‰æãËØ¥ÊòéËôöÊãüÂåñÁ°¨‰ª∂Â¶Ç‰ΩïÂÆåÊàêËøô‰∏§ÁÇπË¶ÅÊ±Ç„ÄÇ</p>
<hr>
<p>**ÈÄöËøáËôöÊãüÊú∫‰∏ãÈô∑Â∞ÜÁâ©ÁêÜ‰∏≠Êñ≠ËΩ¨Êç¢‰∏∫ËôöÊãü‰∏≠Êñ≠Ëß£ÂÜ≥‰∫ÜÂ§öËôöÊãüÊú∫Á≥ªÁªü‰∏≠Áâ©ÁêÜ‰∏≠Êñ≠ÁöÑË∑ØÁî±ÈóÆÈ¢òÔºå**‰ΩÜÊòØÂØπ‰∫éÁõ¥ÈÄöËÆæÂ§áÂç¥Âæà‰∏çÂèãÂ•Ω„ÄÇÁõ¥ÈÄöËÆæÂ§áÊòØÊåáÈÄöËøáÁ°¨‰ª∂ÊîØÊåÅÂ∞Ü‰∏Ä‰∏™Áâ©ÁêÜËÆæÂ§áÁõ¥ÈÄöÁªôÊüê‰∏™ËôöÊãüÊú∫‰ΩøÁî®ÔºåËØ•ËÆæÂ§áÁî±Ëøô‰∏™ËôöÊãüÊú∫Áã¨Âç†ÔºåÊïÖËØ•ËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠‰πüÂ∫îÂΩìÁî±Ëøô‰∏™ËôöÊãüÊú∫Â§ÑÁêÜÔºåÊó†È°ªÁªèËøáHypervisorË∑ØÁî±„ÄÇ</p>
<ul>
<li>‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåELIÔºàExitless InterruptÔºå‰∏çÈÄÄÂá∫‰∏≠Êñ≠ÔºâÂºïÂÖ•‰∫ÜShadow IDTÔºàShadow Interrupt Descriptor TableÔºåÂΩ±Â≠ê‰∏≠Êñ≠ÊèèËø∞Á¨¶Ë°®ÔºâÔºåÂå∫ÂàÜÁõ¥ÈÄöËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠‰∏éÂÖ∂‰ªñÁâ©ÁêÜ‰∏≠Êñ≠ÔºåÁõ¥ÈÄöËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠Áõ¥Êé•ÈÄí‰∫§ÁªôËôöÊãüÊú∫Â§ÑÁêÜÔºåÊó†È°ªHypervisor‰ªãÂÖ•„ÄÇ</li>
<li>DIDÔºàDirect Interrupt DeliveryÔºåÁõ¥Êé•‰∏≠Êñ≠‰∫§‰ªòÔºâÂàôËøõ‰∏ÄÊ≠•ÈÄöËøáÂ∞ÜËôöÊãüËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠ËΩ¨Êç¢‰∏∫Áâ©ÁêÜIPIÔºàInter-Processor InterruptÔºåÂ§ÑÁêÜÂô®Èó¥‰∏≠Êñ≠ÔºâÁõ¥Êé•ÈÄí‰∫§ÁªôËôöÊãüÊú∫ËøõË°åÂ§ÑÁêÜ„ÄÇ</li>
</ul>
<p>Áõ∏ËæÉ‰∫é‰∏äËø∞ËΩØ‰ª∂ÊñπÊ°àÔºåÁ°¨‰ª∂ÂéÇÂïÜÊèê‰æõ‰∫ÜÊñ∞ÁöÑÁ°¨‰ª∂Êú∫Âà∂Ôºå**Áõ¥Êé•Â∞Ü‰∏≠Êñ≠Ê≥®ÂÖ•Ê≠£Âú®ËøêË°åÁöÑËôöÊãüÊú∫‰∏î‰∏ç‰ºöÂºïÂèëËôöÊãüÊú∫‰∏ãÈô∑Ôºå**Â¶ÇIntelÂÖ¨Âè∏ÁöÑÂèëÂ∏É-‰∏≠Êñ≠(Posted-Interrupt)Êú∫Âà∂ÂíåARMÂÖ¨Âè∏ÁöÑITSÔºàInterrupt Translation ServiceÔºå‰∏≠Êñ≠ÁøªËØëÊúçÂä°ÔºâÊú∫Âà∂„ÄÇDirectvisor‰æø‰ΩøÁî®Posted-InterruptÊú∫Âà∂Â∞ÜÁõ¥ÈÄöËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠Ê≥®ÂÖ•ËôöÊãüÊú∫‰∏≠„ÄÇ</p>
<p>‚ÄúÂ§öËôö‰∏Ä‚ÄùÁéØÂ¢É‰∏ãÁöÑ‰∏≠Êñ≠ËôöÊãüÂåñÂàôÊõ¥‰∏∫Â§çÊùÇÔºåËäÇÁÇπA‰∏äI/OËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠ÂèØËÉΩÈúÄË¶ÅÊ≥®ÂÖ•ËäÇÁÇπB‰∏äËøêË°åÁöÑvCPU‰∏≠„ÄÇ‰∏∫‰∫ÜËß£ÂÜ≥‰∏äËø∞ÈóÆÈ¢òÔºåGiantVMÂú®ÊØè‰∏Ä‰∏™Áâ©ÁêÜËäÇÁÇπ‰∏äÈÉΩÂàõÂª∫‰∏Ä‰∏™ËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºåÂπ∂ÈÄâÂÆö‰∏Ä‰∏™ËäÇÁÇπ‰Ωú‰∏∫‰∏ªËäÇÁÇπÔºåÂÖ∂‰ªñËäÇÁÇπ‰∏äÁöÑËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®Êé•Êî∂Âà∞‰∏≠Êñ≠‰ø°Âè∑Êó∂Ôºå‰ºöÂ∞ÜËØ•‰ø°Âè∑ËΩ¨ÂèëÁªô‰∏ªËäÇÁÇπ‰∏äÁöÑËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºåËÆæÁΩÆÁõ∏Â∫îÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåËÄåÂêéÁî±‰∏ªËäÇÁÇπËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®ÂÜ≥ÂÆöÂ∞ÜËØ•‰∏≠Êñ≠Ê≥®ÂÖ•Âì™‰∏™vCPU‰∏≠„ÄÇ</p>
<h1 id="2-intel-vt-xÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñ">2 Intel VT-xÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñ
</h1><p>ÂâçÊñá‰ªãÁªç‰∫ÜCPUËôöÊãüÂåñÈù¢‰∏¥ÁöÑ‰∏Ä‰∫õÊåëÊàòÂíåÂèØËÉΩÁöÑËΩØÁ°¨‰ª∂Ëß£ÂÜ≥ÊñπÊ°à„ÄÇÊú¨ËäÇÂ∞Ü‰ª•Intel VT-x‰∏∫‰æã‰ªãÁªç‰∏äËø∞ÈóÆÈ¢òÂú®x86Êû∂ÊûÑ‰∏ãÊòØÂ¶Ç‰ΩïËß£ÂÜ≥ÁöÑ„ÄÇËá™2005Âπ¥È¶ñÊ¨°ÂÖ¨Â∏ÉÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñÊäÄÊúØ‰ª•Êù•ÔºåIntelÂÖ¨Âè∏ÈôÜÁª≠Êé®Âá∫‰∫ÜÈíàÂØπÂ§ÑÁêÜÂô®ËôöÊãüÂåñÁöÑIntel VT-xÊäÄÊúØ„ÄÅÈíàÂØπI/OËôöÊãüÂåñÁöÑIntel VT-dÊäÄÊúØÂíåÈíàÂØπÁΩëÁªúËôöÊãüÂåñÁöÑIntel VT-cÊäÄÊúØÔºåÂÆÉ‰ª¨ÁªüÁß∞‰∏∫Intel VTÔºàIntel Virtualization TechnologyÔºåËã±ÁâπÂ∞îËôöÊãüÂåñÊäÄÊúØÔºâ„ÄÇ</p>
<p>Êú¨ËäÇÂ∞ÜÁùÄÁúº‰∫éIntel VT-x‰∏≠‰∏éCPUËôöÊãüÂåñÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜÔºåIntel EPTÔºàExtended Page TableÔºåÊâ©Â±ïÈ°µË°®ÔºâÂÜÖÂ≠òËôöÊãüÂåñÊäÄÊúØÂíåIntel VT-d I/OËôöÊãüÂåñÊäÄÊúØÂ∞ÜÂú®ÂÖ∂‰ªñÊñáÊ°£‰∏≠‰ªãÁªç„ÄÇ</p>
<h2 id="21-vmxÊìç‰ΩúÊ®°Âºè">2.1 VMXÊìç‰ΩúÊ®°Âºè
</h2><p>‰∏∫‰∫ÜÂº•Ë°• ‚ÄúËôöÊãüÂåñÊºèÊ¥û‚ÄùÔºåIntel VT-xÂºïÂÖ•‰∫ÜVMXÔºàVirtual Machine eXtensionÔºåËôöÊãüÊú∫Êâ©Â±ïÔºâÊìç‰ΩúÊ®°ÂºèÔºåCPUÂèØ‰ª•ÈÄöËøá <code>VMXON/VMXOFF</code> Êåá‰ª§ÊâìÂºÄÊàñÂÖ≥Èó≠VMXÊìç‰ΩúÊ®°Âºè„ÄÇVMXÊìç‰ΩúÊ®°ÂºèÁ±ª‰ºº‰∫éÂâçËø∞ËôöÊãüÂåñÊ®°ÂºèÔºåÂåÖÂê´Ê†πÊ®°Âºè‰∏éÈùûÊ†πÊ®°ÂºèÔºå**ÂÖ∂‰∏≠HypervisorËøêË°åÂú®Ê†πÊ®°ÂºèÔºåËôöÊãüÊú∫ÂàôËøêË°åÂú®ÈùûÊ†πÊ®°ÂºèÔºå**VMXÊ®°Âºè‰∏ãÊïèÊÑüÊåá‰ª§Â§ÑÁêÜÁ§∫ÊÑèÂõæÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221539035.png" alt="image-20231122153856154" style="zoom: 50%;" />
<p>CPU‰ªéÊ†πÊ®°ÂºèÂàáÊç¢‰∏∫ÈùûÊ†πÊ®°ÂºèÁß∞‰∏∫VM-EntryÔºå‰ªéÈùûÊ†πÊ®°ÂºèÂàáÊç¢‰∏∫Ê†πÊ®°ÂºèÂàôÁß∞‰∏∫VM-Exit„ÄÇÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºåÊ†πÊ®°Âºè‰∏éÈùûÊ†πÊ®°ÂºèÈÉΩÊúâÂêÑËá™ÁöÑÁâπÊùÉÁ∫ß(Ring0~Ring3)ÔºåËôöÊãüÊú∫Êìç‰ΩúÁ≥ªÁªüÂíåÂ∫îÁî®Á®ãÂ∫èÂàÜÂà´ËøêË°åÂú®ÈùûÊ†πÊ®°ÂºèÁöÑRing0ÂíåRing3ÁâπÊùÉÁ∫ß‰∏≠ÔºåËÄåHypervisorÈÄöÂ∏∏ËøêË°åÂú®Ê†πÊ®°ÂºèÁöÑRing0ÁâπÊùÉÁ∫ßÔºåËß£ÂÜ≥‰∫Ü‰∏âËÄÖÁöÑÁâπÊùÉÁ∫ßÁöÑÂàíÂàÜÈóÆÈ¢ò„ÄÇ</p>
<p>Intel VT-xÊîπÂèò‰∫ÜÈùûÊ†πÊ®°Âºè‰∏ãÊïèÊÑüÈùûÁâπÊùÉÊåá‰ª§ÁöÑËØ≠‰πâÔºå‰ΩøÂÆÉ‰ª¨ËÉΩÂ§üËß¶ÂèëVM-ExitÔºåËÄåÊ†πÊ®°ÂºèÊåá‰ª§ÁöÑËØ≠‰πâ‰øùÊåÅ‰∏çÂèò„ÄÇÂ§Ñ‰∫éÈùûÊ†πÊ®°ÂºèÁöÑËôöÊãüÊú∫ÊâßË°åÊïèÊÑüÊåá‰ª§Â∞Ü‰ºöËß¶ÂèëVM-ExitÔºåÈô∑ÂÖ•HypervisorËøõË°åÂ§ÑÁêÜ„ÄÇHypervisorËØªÂèñVM-ExitÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÈÄ†ÊàêVM-ExitÁöÑÂéüÂõ†ÔºàÂ¶ÇI/OÊåá‰ª§Ëß¶Âèë„ÄÅÂ§ñÈÉ®‰∏≠Êñ≠Ëß¶ÂèëÁ≠âÔºâÂπ∂ËøõË°åÁõ∏Â∫îÂ§ÑÁêÜ„ÄÇÂ§ÑÁêÜÂÆåÊàêÂêéÔºåHypervisorË∞ÉÁî® <code>VMLAUNCH/VMRESUME</code> Êåá‰ª§‰ªéÊ†πÊ®°ÂºèÂàáÊç¢Âà∞ÈùûÊ†πÊ®°ÂºèÔºåÊÅ¢Â§çËôöÊãüÊú∫ËøêË°å„ÄÇ</p>
<h2 id="22-vmcs">2.2 VMCS
</h2><p>‰∏∫‰∫ÜËß£ÂÜ≥1.2ËäÇÊèêÂà∞ÁöÑËôöÊãüÊú∫‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢òÔºåIntel VT-xÂºïÂÖ•‰∫ÜVMCS„ÄÇ</p>
<ul>
<li>VMCSÊòØÂÜÖÂ≠ò‰∏≠ÁöÑ‰∏ÄÂùóÂå∫ÂüüÔºåÁî®‰∫éÂú® <code>VM-Entry</code> Âíå <code>VM-Exit</code> ËøáÁ®ã‰∏≠‰øùÂ≠òÂíåÂä†ËΩΩHypervisorÂíåËôöÊãüÊú∫ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºõ</li>
<li>Ê≠§Â§ñÔºåVMCSËøòÂåÖÂê´‰∏Ä‰∫õÊéßÂà∂ÂüüÔºåÁî®‰∫éÊéßÂà∂CPUÁöÑË°å‰∏∫„ÄÇ</li>
</ul>
<p>Êú¨ËäÇÂ∞ÜÁÆÄË¶Å‰ªãÁªçVMCSÁöÑÁªÑÊàê‰∏é‰ΩøÁî®ÊñπÂºè„ÄÇ</p>
<h3 id="vmcsÊìç‰ΩúÊåá‰ª§">VMCSÊìç‰ΩúÊåá‰ª§
</h3><p>Âú®Â§öÂ§ÑÁêÜÂô®ËôöÊãüÊú∫‰∏≠ÔºåVMCS‰∏évCPU‰∏Ä‰∏ÄÂØπÂ∫îÔºåÊØè‰∏™vCPUÈÉΩÊã•Êúâ‰∏Ä‰∏™VMCS„ÄÇ<strong>ÂΩìvCPUË¢´Ë∞ÉÂ∫¶Âà∞Áâ©ÁêÜCPU‰∏äËøêË°åÊó∂ÔºåÈ¶ñÂÖàË¶ÅÂ∞ÜÂÖ∂VMCS‰∏éÁâ©ÁêÜCPUÁªëÂÆöÔºåÁâ©ÁêÜCPUÊâçËÉΩÂú® <code>VM-Entry/VM-Exit</code> ËøáÁ®ã‰∏≠Â∞ÜvCPUÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òÂà∞VMCS‰∏≠„ÄÇ<strong>Intel VT-xÊèê‰æõ‰∫Ü‰∏§Êù°Êåá‰ª§ÔºåÂàÜÂà´Áî®‰∫é</strong>ÁªëÂÆöVMCSÂíåËß£Èô§VMCSÁªëÂÆöÔºö</strong></p>
<ul>
<li><code>VMPTRLD &lt;VMCSÂú∞ÂùÄ&gt;</code>ÔºöÂ∞ÜÊåáÂÆöVMCS‰∏éÂΩìÂâçCPUÁªëÂÆö„ÄÇ</li>
<li><code>VMCLEAR &lt;VMCSÂú∞ÂùÄ&gt;</code>ÔºöÂêåÊ†∑‰ª•VMCSÂú∞ÂùÄ‰∏∫Êìç‰ΩúÊï∞ÔºåÂ∞ÜVMCS‰∏éÂΩìÂâçCPUËß£Èô§ÁªëÂÆöÔºåËØ•Êåá‰ª§Á°Æ‰øùCPUÁºìÂ≠ò‰∏≠ÁöÑVMCSÊï∞ÊçÆË¢´ÂÜôÂÖ•ÂÜÖÂ≠ò‰∏≠„ÄÇ</li>
</ul>
<p>Âú®ÂèëÁîüvCPUËøÅÁßªÊó∂ÔºåÈúÄË¶ÅÂÖàÂú®ÂéüÁâ©ÁêÜCPU‰∏äÊâßË°å <code>VMCLEAR</code> Êåá‰ª§ÔºåËÄåÂêéÂú®ÁõÆÁöÑÁâ©ÁêÜCPU‰∏äÊâßË°å <code>VMPTRLD</code> Êåá‰ª§„ÄÇ</p>
<hr>
<p>Ê≠§Â§ñÔºåVMCSËôΩÁÑ∂ÊòØÂÜÖÂ≠òÂå∫ÂüüÔºå‰ΩÜÊòØ**IntelËΩØ‰ª∂ÂºÄÂèëÊâãÂÜåÊåáÂá∫ÈÄöËøáËØªÂÜôÂÜÖÂ≠òÁöÑÊñπÂºèËØªÂÜôVMCSÊï∞ÊçÆÊòØ‰∏çÂèØÈù†ÁöÑÔºå<strong>Âõ†‰∏∫VMCSÊï∞ÊçÆÂüüÊ†ºÂºè‰∏éÊû∂ÊûÑÂÆûÁé∞ÊòØÁõ∏ÂÖ≥ÁöÑÔºåËÄå‰∏îÈÉ®ÂàÜVMCSÊï∞ÊçÆÂèØËÉΩ‰Ωç‰∫éCPUÁºìÂ≠ò‰∏≠ÔºåÂ∞öÊú™ÂêåÊ≠•Âà∞ÂÜÖÂ≠ò‰∏≠„ÄÇIntel VT-xÊèê‰æõ <code>VMREAD</code> ‰∏é <code>VMWRITE</code> Êåá‰ª§Áî®‰∫é</strong>ËØªÂÜôVMCSÊï∞ÊçÆÂüüÔºå**Êåá‰ª§Ê†ºÂºèÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><code>VMREAD &lt;Á¥¢Âºï&gt;</code> ÔºöËØªÂèñÁ¥¢ÂºïÊåáÂÆöÁöÑVMCSÊï∞ÊçÆÂüü„ÄÇ</li>
<li><code>VMWRITE &lt;Á¥¢Âºï&gt; &lt;Êï∞ÊçÆ&gt;</code>ÔºöÂ∞ÜÊï∞ÊçÆÂÜôÂÖ•Á¥¢ÂºïÊåáÂÆöÁöÑVMCSÊï∞ÊçÆÂüü„ÄÇ</li>
</ul>
<h3 id="vmcsÁªìÊûÑ">VMCSÁªìÊûÑ
</h3><p>VMCSÂå∫ÂüüÂ§ßÂ∞è‰∏çÂõ∫ÂÆöÔºåÊúÄÂ§öÂç†Áî®4KBÔºåVMCSÁöÑÂÖ∑‰ΩìÂ§ßÂ∞èÂèØ‰ª•ÈÄöËøáÊü•ËØ¢MSRÔºàModel Specific RegisterÔºåÁâπÊÆäÊ®°ÂùóÂØÑÂ≠òÂô®Ôºâ<code>IA32_VMX_BASIC[32‚à∂44]</code> ÂæóÁü•„ÄÇVMCSÁªìÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221542780.png" alt="image-20231122154206874" style="zoom:50%;" />
<p><strong>VMCSÁâàÊú¨Ê†áËØÜÁ¨¶</strong> (VMCS revision identifier) ÊåáÊòé‰∫ÜVMCSÊï∞ÊçÆÂüü (VMCS data) ÁöÑÊ†ºÂºèÔºå<strong>VMX‰∏≠Ê≠¢ÊåáÁ§∫Á¨¶</strong> (VMX-abort indicator) ÂàôËÆ∞ÂΩï‰∫ÜVMXÁöÑ‰∏≠Ê≠¢ÂéüÂõ†„ÄÇ<strong>VMCSÊï∞ÊçÆÂüü</strong>ÂàôÂåÖÊã¨‰ª•‰∏ãÂÖ≠ÈÉ®ÂàÜÔºö</p>
<ol>
<li>
<p>**ÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüü(Guest-state area)„ÄÇ**‰øùÂ≠òËôöÊãüÊú∫ÂØÑÂ≠òÂô®Áä∂ÊÄÅÁöÑÂå∫ÂüüÔºå‰∏ªË¶ÅÂåÖÊã¨CR0ÂíåCR3Á≠âÊéßÂà∂ÂØÑÂ≠òÂô®„ÄÅÊ†àÊåáÈíàÂØÑÂ≠òÂô®RSP„ÄÅPCÂØÑÂ≠òÂô®RIPÁ≠âÈáçË¶ÅÂØÑÂ≠òÂô®ÁöÑÁä∂ÊÄÅ„ÄÇ</p>
</li>
<li>
<p>**ÂÆø‰∏ªÊú∫Áä∂ÊÄÅÂüü(Host-state area)„ÄÇ**‰∏éÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüüÁ±ª‰ººÔºåÊòØ‰øùÂ≠òHypervisorÂØÑÂ≠òÂô®Áä∂ÊÄÅÁöÑÂå∫ÂüüÔºåÂÆÉÂåÖÂê´ÁöÑÂØÑÂ≠òÂô®‰∏éÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüüÂ§ßËá¥Áõ∏Âêå„ÄÇ</p>
</li>
<li>
<p>**VM-ExecutionÊéßÂà∂Âüü(VM-Execution control fields)„ÄÇ**ÊéßÂà∂ÂÆ¢Êà∑Êú∫Âú®ÈùûÊ†πÊ®°Âºè‰∏ãËøêË°åÊó∂ÁöÑË°å‰∏∫ÔºåÂ¶ÇÂì™‰∫õÊåá‰ª§‰ºöËß¶ÂèëVM-Exit„ÄÅÂ§ñÈÉ®‰∏≠Êñ≠ÊòØÂê¶ÂºïÂèëVM-ExitÁ≠â„ÄÇ</p>
<blockquote>
<p>Âú®1.3ËäÇÊèêÂà∞ÔºåÂ∞ÜÁâ©ÁêÜ‰∏≠Êñ≠ËΩ¨Âåñ‰∏∫ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•ËôöÊãüÊú∫Ë¶ÅÊ±ÇÁâ©ÁêÜ‰∏≠Êñ≠ËÉΩÂ§üËß¶ÂèëËôöÊãüÊú∫‰∏ãÈô∑ÔºåËøô‰∏ÄÁâπÊÄßÁî±VM-ExecutionÊéßÂà∂Âüü‰∏≠ÁöÑÂ§ñÈÉ®‰∏≠Êñ≠ÈÄÄÂá∫ (External-Interrupt Exiting) Â≠óÊÆµÊéßÂà∂ÔºåÂΩìËØ•‰ΩçÁΩÆ‰∏∫1Êó∂ÔºåÂ§ñÈÉ®‰∏≠Êñ≠Â∞Ü‰ºöËß¶ÂèëVM-ExitÔºåËã•‰∏∫0Âàô‰∏ç‰ºöËß¶ÂèëVM-ExitÔºåÁõ¥Êé•Áî±GuestÂ§ÑÁêÜ„ÄÇ<code>ELI</code> Âíå <code>DID</code> ÈÉΩÂà©Áî®‰∫ÜËØ•ÁâπÊÄßÁõ¥Êé•ÈÄí‰∫§‰∏≠Êñ≠„ÄÇ</p>
</blockquote>
</li>
<li>
<p>**VM-ExitÊéßÂà∂Âüü(VM-Exit control fields)„ÄÇ**ÊéßÂà∂VM-ExitËøáÁ®ã‰∏≠ÁöÑÊüê‰∫õË°å‰∏∫ÔºåÂ¶ÇVM-ExitËøáÁ®ã‰∏≠ÈúÄË¶ÅÂä†ËΩΩÂì™‰∫õMSR„ÄÇ</p>
</li>
<li>
<p>**VM-EntryÊéßÂà∂Âüü(VM-Entry control fields)„ÄÇ**ÊéßÂà∂VM-EntryËøáÁ®ã‰∏≠ÁöÑÊüê‰∫õË°å‰∏∫ÔºåÂ¶ÇVM-EntryÂêéCPUÁöÑËøêË°åÊ®°Âºè„ÄÇ</p>
</li>
<li>
<p>**VM-Exit‰ø°ÊÅØÂüü(VM-Exit information fields)„ÄÇ**Áî®‰ª•‰øùÂ≠òVM-ExitÁöÑÂü∫Êú¨ÂéüÂõ†ÂèäÂÖ∂‰ªñËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ</p>
</li>
</ol>
<p>‰ªé‰ª•‰∏äÊèèËø∞‰∏çÈöæÂèëÁé∞ÔºåVMCSÂØπÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñÂÖ∑ÊúâÊûÅÂÖ∂ÈáçË¶ÅÁöÑÊÑè‰πâÔºåÂá†‰πéÂΩ±Âìç‰∫ÜËôöÊãüÂåñÁöÑÊñπÊñπÈù¢Èù¢„ÄÇ‰∏ãÂõæ‰∏ªË¶ÅÂ±ïÁ§∫‰∫ÜVMCSÂú®VM-EntryÂíåVM-ExitËøáÁ®ã‰∏≠ÁöÑ‰ΩúÁî®ÔºåÂêéÁª≠Á´†ËäÇËøò‰ºöÊ∂âÂèäÈÉ®ÂàÜVMCSÂüüÁöÑÂÖ∑‰ΩìÂäüËÉΩ„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221544962.png" alt="image-20231122154353415" style="zoom:33%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†‰øùÂ≠òÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÔºõ‚ë°Âä†ËΩΩÂÆø‰∏ªÊú∫Áä∂ÊÄÅÔºõ‚ë¢HypervisorËé∑ÂèñÈÄÄÂá∫ÂéüÂõ†Ôºõ‚ë£‰øùÂ≠òÂÆø‰∏ªÊú∫Áä∂ÊÄÅÔºõ‚ë§Âä†ËΩΩÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÔºõ‚ë•Êåá‰ª§ÊâßË°åÈ°∫Â∫è„ÄÇ</p>
</blockquote>
<h2 id="23-picapic">2.3 PIC/APIC
</h2><p>Âú®Â§öËôöÊãüÊú∫ÁéØÂ¢É‰∏ãÔºåÂèØ‰ª•ÈÄöËøáËôöÊãüÊú∫‰∏ãÈô∑Â∞ÜÁâ©ÁêÜ‰∏≠Êñ≠ËΩ¨Êç¢‰∏∫ËôöÊãü‰∏≠Êñ≠ÔºåËß£ÂÜ≥Áâ©ÁêÜ‰∏≠Êñ≠ÁöÑË∑ØÁî±ÈóÆÈ¢ò„ÄÇÂú®Ê≠§ËøáÁ®ã‰∏≠ÔºåHypervisorÈÄöËøáËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®Ê®°ÊãüÁúüÂÆûÁéØÂ¢É‰∏ã‰∏≠Êñ≠ÁöÑÂàÜÂèëÂíå‰º†ÈÄÅÔºåÂÆåÊàêËôöÊãü‰∏≠Êñ≠ÁöÑÊ≥®ÂÖ•ÔºåÂõ†Ê≠§Âú®‰ªãÁªç‰∏≠Êñ≠ËôöÊãüÂåñ‰πãÂâçÊúâÂøÖË¶ÅÂÖà‰∫ÜËß£Áâ©ÁêÜ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂèäÂÖ∂Â∑•‰ΩúÊñπÂºè„ÄÇ</p>
<p>Êú¨ËäÇÂ∞ÜÁÆÄË¶Å‰ªãÁªçIntel x86Êû∂ÊûÑ‰∏ãÁöÑ‰∏§Áßç‰∏≠Êñ≠ÊéßÂà∂Âô®‚Äî‚ÄîPICÔºàProgrammable Interrupt ControllerÔºåÂèØÁºñÁ®ã‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºâÂíåAPICÔºàAdvanced Programmable Interrupt ControllerÔºåÈ´òÁ∫ßÂèØÁºñÁ®ã‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºâÂèäÂÆÉ‰ª¨ÂêÑËá™ÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ã„ÄÇ</p>
<h3 id="pic">PIC
</h3><p>PICÔºåÂç≥Intel 8259AËäØÁâáÔºåÊòØÂçïÂ§ÑÁêÜÂô® (Uni-processor) Êó∂‰ª£ÂπøÊ≥õ‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®„ÄÇÂÆÉ‰∏ªË¶ÅÂåÖÂê´8‰∏™‰∏≠Êñ≠ÂºïËÑö <code>IR0~IR7</code>ÔºåÁî®‰∫éËøûÊé•Â§ñÈÉ®ËÆæÂ§á‰ª•Âèä‰∏â‰∏™ÂÜÖÈÉ®ÂØÑÂ≠òÂô®Ôºö<code>IMR</code>ÔºàInterrupt Mask RegisterÔºå‰∏≠Êñ≠Â±èËîΩÂØÑÂ≠òÂô®Ôºâ„ÄÅ<code>IRR</code>ÔºàInterrupt Request RegisterÔºå‰∏≠Êñ≠ËØ∑Ê±ÇÂØÑÂ≠òÂô®ÔºâÂíå <code>ISR</code>ÔºàInterrupt Service RegisterÔºå‰∏≠Êñ≠ÊúçÂä°ÂØÑÂ≠òÂô®Ôºâ„ÄÇ</p>
<ul>
<li><code>IMR</code>ÔºöÂÖ±8‰ΩçÔºåÂØπÂ∫î‰∫éIR0~IR7ÔºåÁΩÆ1Ë°®Á§∫Áõ∏Â∫îÂºïËÑö‰∏≠Êñ≠Ë¢´Â±èËîΩÔºõ</li>
<li><code>IRR</code>ÔºöÂÖ±8‰ΩçÔºåÂØπÂ∫î‰∫éIR0~IR7ÔºåÁΩÆ1Ë°®Á§∫Êî∂Âà∞Áõ∏Â∫îÂºïËÑöÁöÑ‰∏≠Êñ≠‰ø°Âè∑Ôºõ</li>
<li><code>ISR</code>ÔºöÂÖ±8‰ΩçÔºåÂØπÂ∫î‰∫éIR0~IR7ÔºåÁΩÆ1Ë°®Á§∫Êî∂Âà∞Áõ∏Â∫îÂºïËÑöÁöÑ‰∏≠Êñ≠‰ø°Âè∑Ê≠£Âú®Ë¢´CPUÂ§ÑÁêÜ„ÄÇ</li>
</ul>
<p>ÂÖ∂‰∏≠ <code>IR0~IR7</code> Áî®‰∫éËøûÊé•Â§ñÈÉ®ËÆæÂ§áÔºåËøûÊé•Âà∞‰∏çÂêåÁöÑ‰∏≠Êñ≠ÂºïËÑöÂØπÂ∫îÁöÑ‰∏≠Êñ≠‰ºòÂÖàÁ∫ß‰∏çÂêåÔºåÂÖ∂‰∏≠ <code>IR0</code> ‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºå<code>IR7</code> ‰ºòÂÖàÁ∫ßÊúÄ‰Ωé„ÄÇPICÈÄªËæëÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>ÊØèÂΩìÂ§ñËÆæÈúÄË¶ÅÂèëÈÄÅ‰∏≠Êñ≠Êó∂Ôºå‰æø‰ºöÊãâÈ´òÁõ∏Ëøû‰∏≠Êñ≠ÂºïËÑöÁöÑÁîµÂπ≥Ôºõ</li>
<li>Ëã•Áõ∏ÂÖ≥‰∏≠Êñ≠Êú™Ë¢´Â±èËîΩÔºåÂ∞±ËÆæÁΩÆ <code>IRR</code> ‰∏≠Áõ∏Â∫î‰ΩçÂπ∂ÊãâÈ´ò <code>INT</code> ÂºïËÑöÁîµÂπ≥ÈÄöÁü•CPUÊúâ‰∏≠Êñ≠Âà∞ËææÔºõ</li>
<li>CPUÁªô <code>INTA</code> ÂºïËÑöÂèëÈÄÅ‰∏Ä‰∏™ËÑâÂÜ≤Á°ÆËÆ§Êî∂Âà∞‰∏≠Êñ≠Ôºå8259AËäØÁâáÊî∂Âà∞‰∏äËø∞ <code>INTA</code> ËÑâÂÜ≤‰ø°Âè∑ÂêéÔºåÂ∞Ü <code>IRR</code> ÊúÄÈ´ò‰ºòÂÖàÁ∫ß‰ΩçÊ∏ÖÈõ∂Âπ∂Â∞Ü <code>ISR</code> ÂØπÂ∫î‰ΩçÁΩÆ1Ôºõ</li>
<li>ËÄåÂêéCPUÂèëÈÄÅÁ¨¨‰∫åÊ¨°ËÑâÂÜ≤Ôºå8259AËäØÁâáÊî∂Âà∞ÂêéÂ∞ÜÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑ÂèëÈÄÅÁªôÂà∞Êï∞ÊçÆÁ∫ø‰∏äÔºåCPUÊé•Êî∂‰∏≠Êñ≠ÂêëÈáèÂè∑Âπ∂ÊâßË°åÁõ∏Â∫îÁöÑ‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ãÔºõ</li>
<li>‰∏≠Êñ≠Â§ÑÁêÜÂÆåÊàêÂêéÔºåCPUÂêë8259AÁöÑÂëΩ‰ª§ÂØÑÂ≠òÂô®ÂÜôÂÖ•ÊåáÂÆöÂÄºÂπ∂ÂèëÈÄÅ‰∏Ä‰∏™ <code>EOI</code>ÔºàEnd of InterruptÔºå‰∏≠Êñ≠ÁªìÊùüÔºâ‰ø°Âè∑Ôºõ</li>
<li>8259AËäØÁâáÊî∂Âà∞ <code>EOI</code> ÂêéÔºåÂ∞Ü <code>ISR</code> ‰∏≠ÁöÑÊúÄÈ´ò‰ºòÂÖàÁ∫ß‰ΩçÊ∏ÖÈõ∂„ÄÇ</li>
</ol>
<p>Ê†πÊçÆ‰∏äËø∞ÊèèËø∞Ôºå8259AËäØÁâáÊúÄÂ§öÊîØÊåÅ8‰∏™‰∏≠Êñ≠Ê∫êÔºåËÄå‰∏∫‰∫ÜÊîØÊåÅÊõ¥Â§öÁöÑÂ§ñËÆæÔºåÈÄöÂ∏∏Â∞ÜËã•Âπ≤‰∏™8259AËäØÁâáÁ∫ßËÅîÔºåÊúÄÂ§öÂèØ‰ª•ÊîØÊåÅ64‰∏™‰∏≠Êñ≠„ÄÇ</p>
<h3 id="apic">APIC
</h3><p>APICÊòØ20‰∏ñÁ∫™90Âπ¥‰ª£IntelÂÖ¨Âè∏‰∏∫‰∫ÜÂ∫îÂØπÂ§öÂ§ÑÁêÜÂô® (Multi-Processor) Êû∂ÊûÑÊèêÂá∫ÁöÑ‰∏ÄÊï¥Â•ó‰∏≠Êñ≠Â§ÑÁêÜÊñπÊ°àÔºåÁî®‰∫éÂèñ‰ª£ËÄÅÊóßÁöÑ8259A PIC„ÄÇAPICÈÄÇÁî®‰∫éÂ§öÂ§ÑÁêÜÂô®Êú∫Âô®ÔºåÊØè‰∏™CPUÊã•Êúâ‰∏Ä‰∏™LAPICÔºàLocal APICÔºåÊú¨Âú∞APICÔºâÔºåÊï¥‰∏™Êú∫Âô®Êã•Êúâ‰∏Ä‰∏™ÊàñÂ§ö‰∏™IOAPICÔºàI/O APICÔºåËæìÂÖ•/ËæìÂá∫APICÔºâÔºå<strong>ËÆæÂ§áÁöÑ‰∏≠Êñ≠‰ø°Âè∑ÂÖàÁªèÁî±IOAPICÊ±áÊÄªÔºåÂÜçÂàÜÂèëÁªô‰∏Ä‰∏™ÊàñÂ§ö‰∏™CPUÁöÑLAPIC„ÄÇ</strong></p>
<p>LAPIC‰∏≠‰πüÂ≠òÂú® <code>IRR</code> Âíå <code>ISR</code> ‰ª•Âèä <code>EOI</code> ÂØÑÂ≠òÂô®Ôºå<code>IRR</code> Âíå <code>ISR</code> ÁöÑÂäüËÉΩ‰∏éPIC‰∏≠Áõ∏Â∫îÂØÑÂ≠òÂô®Á±ª‰ººÔºåÂ§ßÂ∞è‰∏∫256‰ΩçÔºåÂØπÂ∫îx86Âπ≥Âè∞‰∏ãÁöÑ256‰∏™‰∏≠Êñ≠ÂêëÈáèÂè∑„ÄÇÂú®APIC‰∏≠Êñ≠Êû∂ÊûÑ‰∏ãÔºåLAPICÁöÑ‰∏≠Êñ≠Êù•Ê∫êÂèØÂàÜ‰∏∫‰ª•‰∏ã3Á±ªÔºö</p>
<ul>
<li>
<p>**Êú¨Âú∞‰∏≠Êñ≠„ÄÇ**Êú¨Âú∞‰∏≠Êñ≠ÂåÖÊã¨ <code>LINT0</code> Âíå <code>LINT1</code> ÂºïËÑöÊé•Êî∂ÁöÑ‰∏≠Êñ≠„ÄÅAPIC Timer‰∫ßÁîüÁöÑ‰∏≠Êñ≠„ÄÅÊÄßËÉΩËÆ°Êï∞Âô®‰∫ßÁîüÁöÑ‰∏≠Êñ≠„ÄÅÊ∏©Â∫¶‰º†ÊÑüÂô®‰∫ßÁîüÁöÑ‰∏≠Êñ≠‰ª•ÂèäAPICÂÜÖÈÉ®ÈîôËØØÂºïÂèëÁöÑ‰∏≠Êñ≠„ÄÇ</p>
</li>
<li>
<p>**ÈÄöËøáIOAPICÊé•Êî∂ÁöÑÂ§ñÈÉ®‰∏≠Êñ≠„ÄÇ**ÂΩìI/OËÆæÂ§áÈÄöËøáIOAPIC‰∏≠Êñ≠ÂºïËÑö‰∫ßÁîü‰∏≠Êñ≠‰ø°Âè∑Êó∂ÔºåIOAPIC‰ªéÂÜÖÈÉ®ÁöÑPRTÔºàProgrammable Redirection TableÔºåÂèØÁºñÁ®ãÈáçÂÆöÂêëË°®Ôºâ‰∏≠ÊâæÂà∞Áõ∏Â∫îÁöÑRTEÔºàRedirection Table EntryÔºåÈáçÂÆöÂêëË°®È°πÔºâ„ÄÇPRTÂÖ±Êúâ24Êù°PTEÔºå‰∏éIOAPICÁöÑ24‰∏™‰∏≠Êñ≠ÂºïËÑöÂØπÂ∫îÔºåÊØèÊù°PTEÈïøÂ∫¶‰∏∫64‰Ωç„ÄÇIOAPICÊ†πÊçÆPTE‰∏≠Â≠òÂÇ®ÁöÑ‰ø°ÊÅØÔºàÂ¶ÇËß¶ÂèëÊñπÂºè„ÄÅ‰∏≠Êñ≠ÂêëÈáèÂè∑„ÄÅÁõÆÁöÑÂ§ÑÁêÜÂô®Á≠âÔºâÊ†ºÂºèÂåñÂá∫‰∏ÄÊù°‰∏≠Êñ≠Ê∂àÊÅØÂèëÈÄÅÂà∞Á≥ªÁªüÊÄªÁ∫ø‰∏ä„ÄÇ</p>
<p>Âú®PIC‰∏≠Ôºå‰∏≠Êñ≠‰ºòÂÖàÁ∫ßÁî±ÊâÄËøûÊé•ÁöÑ8259AËäØÁâáÂºïËÑöÂÜ≥ÂÆöÔºåËÄåÂú®APIC‰∏≠Ôºå‰∏≠Êñ≠‰ºòÂÖàÁ∫ßÁî±‰∏≠Êñ≠ÂêëÈáèÂè∑Ôºà‰πüÁß∞‰∏∫vectorÔºâÂÜ≥ÂÆöÔºåËåÉÂõ¥‰∏∫0~255Ôºå<code>ISR</code> Âíå <code>IRR</code> ÊØè‰ΩçÂØπÂ∫î‰∏Ä‰∏™‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºåÁΩÆ1Ë°®Á§∫Êî∂Âà∞ËØ•‰∏≠Êñ≠ÂêëÈáèÂè∑ÁöÑ‰∏≠Êñ≠„ÄÇ‰∏≠Êñ≠ÂêëÈáèÂè∑Ë∂äÂ§ßÔºå‰∏≠Êñ≠‰ºòÂÖàÁ∫ßË∂äÈ´ò„ÄÇ<code>IRR</code> Âíå <code>ISR</code> ÁöÑÊúÄÂ§ß‰∏≠Êñ≠ÂêëÈáèÂè∑ËÆ∞‰∏∫ <code>IRRV</code> Âíå <code>ISRV</code>„ÄÇ</p>
</li>
<li>
<p>**Â§ÑÁêÜÂô®Èó¥‰∏≠Êñ≠(IPI)„ÄÇ**CPUÂèØ‰ª•ÈÄöËøáÂÜôÂÖ•APICÁöÑ <code>ICR</code>ÔºàInterrupt Control RegisterÔºå‰∏≠Êñ≠ÊéßÂà∂ÂØÑÂ≠òÂô®ÔºâÂèëÈÄÅ‰∏ÄÊù°IPIÊ∂àÊÅØÂà∞Á≥ªÁªüÊÄªÁ∫ø‰∏äÔºå‰ªéËÄåÂèëÈÄÅÁªôCPU„ÄÇ</p>
</li>
</ul>
<hr>
<p>LAPICÊî∂Âà∞‰∏≠Êñ≠Ê∂àÊÅØÂêéÔºåÁ°ÆËÆ§Ëá™Â∑±ÊòØÂê¶ÊòØ‰∏≠Êñ≠Ê∂àÊÅØÁöÑÁõÆÊ†áÔºåÂ¶ÇÊûúÊòØÔºåÂàôÂØπËØ•‰∏≠Êñ≠Ê∂àÊÅØËøõ‰∏ÄÊ≠•Â§ÑÁêÜÔºåËøô‰∏ÄÊ≠•Áß∞‰∏∫‰∏≠Êñ≠Ë∑ØÁî±(Interrupt Routing)„ÄÇ<strong>LAPICÊé•Êî∂‰∏≠Êñ≠Ê∂àÊÅØÂêéÔºåÂ§ÑÁêÜËøáÁ®ãÂ¶Ç‰∏ãÔºö</strong></p>
<ol>
<li>Â¶ÇÊûúÊî∂Âà∞ÁöÑ‰∏≠Êñ≠ÊòØNMI„ÄÅSMI„ÄÅINIT„ÄÅExtINTÊàñSIPIÔºåÂàôÁõ¥Êé•‰∫§ÁªôCPUÂ§ÑÁêÜÔºåÂê¶ÂàôËÆæÁΩÆ <code>IRR</code> ÂØÑÂ≠òÂô®‰∏≠ÈÄÇÂΩìÁöÑ‰ΩçÔºåÂ∞Ü‰∏≠Êñ≠Âä†ÂÖ•Á≠âÂæÖÈòüÂàóÔºåËøô‰∏ÄÊ≠•Áß∞‰∏∫<strong>‰∏≠Êñ≠Êé•Âèó(Interrupt Acceptance)„ÄÇ</strong></li>
<li>ÂØπ‰∫éÂú® <code>IRR</code> ‰∏≠ÈòªÂ°ûÁöÑ‰∏≠Êñ≠ÔºåAPICÂèñÂá∫ÂÖ∂‰∏≠‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑ‰∏≠Êñ≠ÔºàË¶ÅÊ±ÇIRRV[7‚à∂4]&gt;PPR[7‚à∂4]Ôºâ‰∫§ÁªôCPUÂ§ÑÁêÜÔºåÂπ∂Ê†πÊçÆ‰∏≠Êñ≠ÂêëÈáèÂè∑ËÆæÁΩÆ <code>ISR</code> ÂØÑÂ≠òÂô®‰∏≠Áõ∏Â∫îÁöÑ‰Ωç„ÄÇËøô‰∏ÄÊ≠•Áß∞‰∏∫<strong>‰∏≠Êñ≠Á°ÆËÆ§(Interrupt Acknowledgement)„ÄÇ</strong></li>
<li>CPUÈÄöËøá‰∏≠Êñ≠ÂêëÈáèÂè∑Á¥¢Âºï <code>IDT</code>ÔºàInterrupt Descriptor TableÔºå‰∏≠Êñ≠ÊèèËø∞Á¨¶Ë°®ÔºâÊâßË°åÁõ∏Â∫îÁöÑ‰∏≠Êñ≠Â§ÑÁêÜ‰æãÁ®ãÔºåËøô‰∏ÄÊ≠•Áß∞‰∏∫<strong>‰∏≠Êñ≠‰∫§‰ªò(Interrupt Delivery)„ÄÇ</strong></li>
<li>‰∏≠Êñ≠Â§ÑÁêÜ‰æãÁ®ãÊâßË°åÂÆåÊØïÊó∂ÔºåÂ∫îÂÜôÂÖ• <code>EOI</code> ÂØÑÂ≠òÂô®Ôºå‰ΩøÂæóAPIC‰ªé <code>ISR</code> ÈòüÂàó‰∏≠Âà†Èô§‰∏≠Êñ≠ÂØπÂ∫îÁöÑÈ°πÔºåÁªìÊùüËØ•‰∏≠Êñ≠ÁöÑÂ§ÑÁêÜÔºàNMI„ÄÅSMI„ÄÅINIT„ÄÅExtINTÂèäSIPI‰∏çÈúÄË¶ÅÂÜôÂÖ•EOIÔºâ„ÄÇ</li>
</ol>
<h3 id="msi">MSI
</h3><p>MSIÔºàMessage Signaled InterruptÔºåÊ∂àÊÅØÂëäÁü•‰∏≠Êñ≠ÔºâÊòØPCIÊÄªÁ∫øÂèëÂ±ïÂá∫ÁöÑÊñ∞Âûã‰∏≠Êñ≠‰º†ÈÄÅÊñπÂºèÔºåÂÆÉÂÖÅËÆ∏ËÆæÂ§áÁõ¥Êé•ÂèëÈÄÅ‰∏≠Êñ≠Âà∞LAPICËÄåÊó†È°ªÁªèËøáIOAPIC„ÄÇ<strong>MSIÊú¨Ë¥®‰∏äÂ∞±ÊòØÂú®‰∏≠Êñ≠ÂèëÁîüÊó∂Ôºå‰∏çÈÄöËøáÂ∏¶Â§ñ(out-band)ÁöÑ‰∏≠Êñ≠‰ø°Âè∑Á∫øÔºåËÄåÊòØÈÄöËøáÂ∏¶ÂÜÖ(in-band)ÁöÑPCIÂÜôÂÖ•‰∫ãÂä°Êù•ÈÄöÁü•LAPIC‰∏≠Êñ≠ÁöÑÂèëÁîü„ÄÇ</strong></p>
<p>‰ªéÂéüÁêÜ‰∏äÊù•ËØ¥ÔºåMSI‰∫ßÁîüÁöÑ‰∫ãÂä°‰∏é‰∏ÄËà¨ÁöÑDMA‰∫ãÂä°Âπ∂Êó†Êú¨Ë¥®Âå∫Âà´ÔºåÈúÄË¶Å‰æùËµñÁâπÂÆöÂπ≥Âè∞ÁöÑÁâπÊÆäÊú∫Âà∂‰ªéÊÄªÁ∫ø‰∫ãÂä°‰∏≠Âå∫ÂàÜÂá∫MSIÂπ∂Ëµã‰∫àÂÖ∂‰∏≠Êñ≠ÁöÑËØ≠‰πâ„ÄÇ</p>
<blockquote>
<p>Âú®x86Âπ≥Âè∞‰∏äÔºåÊòØÁî±Host Bridge/Root ComplexË¥üË¥£Ëøô‰∏ÄËÅåË¥£ÔºåÂ∞ÜMSI‰∫ãÂä°ÁøªËØëÊàêÁ≥ªÁªü‰∏äÁöÑ‰∏≠Êñ≠Ê∂àÊÅØÔºå‰ΩÜÂá°ÁõÆÊ†áÂú∞ÂùÄËêΩÂú® <code>[0xfee00000Ôºå0xfeefffff]</code> ÁöÑÂÜôÂÖ•‰∫ãÂä°ÈÉΩ‰ºöË¢´ËßÜ‰∏∫MSI‰∏≠Êñ≠ËØ∑Ê±ÇÂπ∂ÁøªËØëÊàê‰∏≠Êñ≠Ê∂àÊÅØ„ÄÇ</p>
</blockquote>
<p>‰∏Ä‰∏™MSI‰∫ãÂä°Áî±Âú∞ÂùÄÂíåÊï∞ÊçÆÊûÑÊàêÔºåÊØè‰∏™ËÆæÂ§áÂèØ‰ª•ÈÖçÁΩÆÂÖ∂ÂèëÁîü‰∏≠Êñ≠Êó∂‰∫ßÁîüMSI‰∫ãÂä°ÁöÑÂú∞ÂùÄÂíåÊï∞ÊçÆÔºåÂπ∂‰∏îÂèØ‰ª•Âú®‰∏çÂêå‰∫ã‰ª∂ÂèëÁîüÊó∂‰∫ßÁîü‰∏çÂêåÁöÑMSI‰∫ãÂä°ÔºàÂç≥‰∏çÂêåÁöÑÂú∞ÂùÄ-Êï∞ÊçÆÂØπÔºâ„ÄÇMSI‰∏≠Êñ≠Ê∂àÊÅØÂà∞ËææLAPICÂêéÁöÑÂ§ÑÁêÜÊµÅÁ®ã‰∏é‰∏äËø∞ËøáÁ®ã‰∏ÄËá¥„ÄÇ</p>
<h3 id="irq--gsi--vector--pin">IRQ &amp; GSI &amp; Vector &amp; Pin
</h3><p>Âú®Ê≠£Âºè‰ªãÁªç‰∏≠Êñ≠ËôöÊãüÂåñ‰πãÂâçÔºåËøòÈúÄË¶Å‰ªãÁªçÂá†‰∏™ÈáçË¶ÅÁöÑÊ¶ÇÂøµÔºö<code>IRQ</code>ÔºàInterrupt RequestÔºå‰∏≠Êñ≠ËØ∑Ê±ÇÔºâ„ÄÅ<code>GSI</code>ÔºàGlobal System InterruptÔºåÂÖ®Â±ÄÁ≥ªÁªü‰∏≠Êñ≠Âè∑Ôºâ„ÄÅ<code>Vector</code>Ôºà‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºâÂíå <code>Pin</code>Ôºà‰∏≠Êñ≠ÂºïËÑöÂè∑Ôºâ„ÄÇËøôÂá†‰∏™Ê¶ÇÂøµÂú®ÂêéÁª≠Á´†ËäÇÂ∞Ü‰ºöÂèçÂ§çÊèêÂèäÔºåÊïÖÂú®Ê≠§ËøõË°åÂå∫ÂàÜ„ÄÇ</p>
<ul>
<li>
<p>**IRQÔºö**IRQÊòØPICÊó∂‰ª£ÁöÑ‰∫ßÁâ©Ôºå‰ΩÜÊòØÂ¶Ç‰ªäÂèØËÉΩËøò‰ºöËßÅÂà∞IRQÁ∫øÊàñËÄÖIRQÂè∑Á≠âÂêÑÁßçËØ¥Ê≥ï„ÄÇÂú®PIC‰∏≠Êñ≠Êû∂ÊûÑ‰∏ãÔºåÈÄöÂ∏∏Â∞Ü‰∏§Âùó8259AËäØÁâáÁ∫ßËÅîÔºåÊîØÊåÅ16‰∏™‰∏≠Êñ≠ÔºåÁî±‰∫éISAËÆæÂ§áÈÄöÂ∏∏ËøûÊé•Âà∞Âõ∫ÂÆöÁöÑ8259A‰∏≠Êñ≠ÂºïËÑöÔºåÂõ†Ê≠§ËÆæÂ§áÁöÑIRQÂè∑ÈÄöÂ∏∏ÊòØÊåáÂÆÉÊâÄËøûÊé•ÁöÑ8259AÂºïËÑöÂè∑„ÄÇ</p>
<p>Â¶ÇÂâçÊâÄËø∞Ôºå8259AÊúâ8‰∏™‰∏≠Êñ≠ÂºïËÑö( <code>IR0~IR7</code> )ÔºåÈÇ£‰πàËøûÊé•Âà∞Ëøô‰∫õ<strong>‰∏ª8259A</strong>ËäØÁâá <code>IR0~IR7</code> ÂºïËÑöÁöÑËÆæÂ§á‰∏≠Êñ≠Âè∑ÂàÜÂà´ÂØπÂ∫î <code>IRQ0~IRQ7</code>ÔºåËøûÊé•Âà∞<strong>‰ªé8259A</strong>ËäØÁâá <code>IR0~IR7</code> ÂºïËÑöÁöÑËÆæÂ§áÂØπÂ∫îÁöÑ‰∏≠Êñ≠Âè∑‰∏∫ <code>IRQ8~IRQ15</code>„ÄÇËÄåIRQÁ∫øÂèØ‰ª•ÁêÜËß£‰∏∫ËÆæÂ§á‰∏éËøô‰∫õÂºïËÑöÁöÑËøûÁ∫øÔºåÂëΩÂêçÊñπÂºèÈÄöÂ∏∏‰πü‰∏∫ <code>IRQx</code>ÔºåÂÆÉ‰ª¨ÈÄöÂ∏∏‰∏é‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑö‰∏Ä‰∏ÄÂØπÂ∫îÔºåÊïÖ‰ΩøÁî®IRQÊó∂Â∫îÂΩìÊ≥®ÊÑèÁõ∏Â∫îÁöÑÊÉÖÂ¢É„ÄÇ</p>
</li>
<li>
<p>**GSIÔºö<strong>GSIÊòØACPIÔºàAdvanced Configuration and Power InterfaceÔºåÈ´òÁ∫ßÈÖçÁΩÆÂíåÁîµÊ∫êÁÆ°ÁêÜÊé•Âè£ÔºâÂºïÂÖ•ÁöÑÊ¶ÇÂøµÔºåÂÆÉ</strong>‰∏∫Á≥ªÁªü‰∏≠ÊØè‰∏™‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑËæìÂÖ•ÂºïËÑöÊåáÂÆö‰∫Ü‰∏Ä‰∏™ÂÖ®Â±ÄÁªü‰∏ÄÁöÑÁºñÂè∑„ÄÇ**‰æãÂ¶ÇÁ≥ªÁªü‰∏≠ÊúâÂ§ö‰∏™IOAPICÔºåÊØè‰∏™IOAPICÈÉΩ‰ºöË¢´BIOSÂàÜÈÖç‰∏Ä‰∏™Âü∫Á°ÄGSI (GSI Base)ÔºåÊØè‰∏™IOAPIC‰∏≠Êñ≠ÂºïËÑöÂØπÂ∫îÁöÑGSI‰∏∫Âü∫Á°ÄGSI+Pin„ÄÇ</p>
<p>ÊØîÂ¶ÇIOAPIC 0ÁöÑÂü∫Á°ÄGSI‰∏∫0ÔºåÊúâ24‰∏™ÂºïËÑöÔºåÂàôÂÆÉ‰ª¨ÂàÜÂà´ÂØπÂ∫î <code>GSI0~GSI23</code>„ÄÇÂú®APICÁ≥ªÁªü‰∏≠ÔºåIRQÂíåGSIÈÄöÂ∏∏‰ºöË¢´Ê∑∑Áî®Ôºå15Âè∑‰ª•‰∏äÁöÑIRQÂè∑‰∏éGSIÁõ∏Á≠âÔºõËÄå15Âè∑‰ª•‰∏ãÁöÑIRQÂè∑‰∏éISAËÆæÂ§áÈ´òÂ∫¶ËÄ¶ÂêàÔºåÂè™ÊúâÂΩìÁõ∏Â∫îÁöÑISAËÆæÂ§áÊåâÁÖßÂØπÂ∫îÁöÑIRQÂè∑ËøûÊé•Âà∞IOAPIC 0ÁöÑ1~15ÂºïËÑöÊó∂ÔºåIRQÊâçÂíåGSIÁõ∏Á≠âÔºåËøôÁßçÊÉÖÂÜµÁß∞‰∏∫‰∏ÄËá¥ÊÄßÊò†Â∞Ñ„ÄÇËÄåËã•IRQ‰∏éGSIÂºïËÑö‰∏ç‰∏Ä‰∏ÄÂØπÂ∫îÔºåACPIÂ∞Ü‰ºöÁª¥Êä§‰∏Ä‰∏™ISOÔºàInterrupt Source OverrideÔºå‰∏≠Êñ≠Ê∫êË¶ÜÁõñÔºâÁªìÊûÑÊèèËø∞IRQ‰∏éGSIÁöÑÊò†Â∞Ñ„ÄÇÂ¶ÇPITÔºàProgrammable Interrupt TimerÔºåÂèØÁºñÁ®ã‰∏≠Êñ≠Êó∂ÈíüÔºâÊé•PICÁöÑIR0ÂºïËÑöÔºåÂõ†Ê≠§ÂÖ∂IRQ‰∏∫0Ôºõ‰ΩÜÂΩìÊé•IOAPICÊó∂ÔºåÂÆÉÈÄöÂ∏∏Êé•Âú®2Âè∑‰∏≠Êñ≠ÂºïËÑöÔºåÊâÄ‰ª•ÂÖ∂GSI‰∏∫2„ÄÇËÄåÂú®QEMU/KVM‰∏≠ÔºåGSIÂíåIRQÂÆåÂÖ®Á≠â‰ª∑Ôºå‰ΩÜÊòØ‰∏çÁ¨¶ÂêàÂâçËø∞Âü∫Á°ÄGSI+PinÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ</p>
</li>
<li>
<p>**VectorÔºö**‰∏≠Êñ≠ÂêëÈáèÂè∑ÊòØÊìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑÊ¶ÇÂøµÔºåÊòØ‰∏≠Êñ≠Âú® <code>IDT</code> ‰∏≠ÁöÑÁ¥¢Âºï„ÄÇÊØè‰∏™GSIÈÉΩÂØπÂ∫î‰∏Ä‰∏™VectorÔºåÂÆÉ‰ª¨ÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÁî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆö„ÄÇx86‰∏≠ÈÄöÂ∏∏ÂåÖÂê´256‰∏™‰∏≠Êñ≠ÂêëÈáèÂè∑Ôºå0<del>31Âè∑‰∏≠Êñ≠ÂêëÈáèÂè∑ÊòØx86È¢ÑÂÆö‰πâÁöÑÔºå32</del>255Âè∑ÂàôÁî±ËΩØ‰ª∂ÂÆö‰πâ„ÄÇ</p>
</li>
<li>
<p>**PinÔºö**‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑ÔºåÂØπ‰∫é8259AËÄåË®ÄÔºåÂÖ∂PinÂèñÂÄº‰∏∫ <code>0~7</code>ÔºõÂØπ‰∫éIOAPICÔºåÂÖ∂PinÂèñÂÄº‰∏∫ <code>0~23</code>„ÄÇ</p>
</li>
</ul>
<p>Ê†πÊçÆ‰ª•‰∏äÊèèËø∞ÔºåIRQ„ÄÅGSIÂíåVectorÈÉΩÂèØ‰ª•ÂîØ‰∏ÄÊ†áËØÜÁ≥ªÁªü‰∏≠ÁöÑ‰∏≠Êñ≠Êù•Ê∫êÔºå<strong>IRQÂíåGSIÁöÑÊò†Â∞ÑÂÖ≥Á≥ª‰ª•ÂèäGSIÂíåPinÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÁî±ACPIËÆæÁΩÆÔºåIRQÂíåVectorÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÁî±Êìç‰ΩúÁ≥ªÁªüËÆæÁΩÆ„ÄÇ</strong></p>
<h2 id="24-intel-vt-x‰∏≠Êñ≠ËôöÊãüÂåñ">2.4 Intel VT-x‰∏≠Êñ≠ËôöÊãüÂåñ
</h2><p>‰∏≠Êñ≠ËôöÊãüÂåñÁöÑ‰∏ÄËà¨ÊÄùË∑Ø‰∏≠ÔºåÊúÄ‰∏∫ÂÖ≥ÈîÆÁöÑ‰∏§ÁÇπ‰æøÊòØÔºö</p>
<ul>
<li><strong>‰∏≠Êñ≠ËÆæÂ§áÁöÑÊ®°ÊãüÔºàÂ§ñÈÉ®ËÆæÂ§áÂíå‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑÊ®°ÊãüÔºâ</strong></li>
<li><strong>‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ãÁöÑÊ®°Êãü</strong></li>
</ul>
<p>Ëøô‰πüÊòØÊó©ÊúüIntel VT-x‰∏≠Êñ≠ËôöÊãüÂåñÈááÁî®ÁöÑÊñπÊ≥ïÔºåÂêéÊù•IntelÂÖ¨Âè∏Êé®Âá∫‰∫Ü <code>APICv</code>ÔºàAPIC VirtualizationÔºåAPICËôöÊãüÂåñÔºâÊäÄÊúØÂØπ‰∏äËø∞‰∏§‰∏™ÂäüËÉΩËøõË°å‰∫Ü‰ºòÂåñ„ÄÇÊú¨ËäÇÂ∞ÜÂàÜÂà´‰ªãÁªç<strong>‰º†Áªü‰∏≠Êñ≠ËôöÊãüÂåñÂíåAPICvÊîØÊåÅÁöÑ‰∏≠Êñ≠ËôöÊãüÂåñ„ÄÇ</strong></p>
<h3 id="‰º†Áªü‰∏≠Êñ≠ËôöÊãüÂåñ">‰º†Áªü‰∏≠Êñ≠ËôöÊãüÂåñ
</h3><p>Âú®‰º†Áªü‰∏≠Êñ≠ËôöÊãüÂåñ‰∏≠ÔºåHypervisor‰ºöÂàõÂª∫ËôöÊãü <code>IOAPIC</code> ÂíåËôöÊãü <code>LAPIC</code>Ôºå‰ª•‰∏ãÁªüÁß∞‰∏∫ËôöÊãüAPIC„ÄÇÂÆÉ‰ª¨ÈÄöÂ∏∏Ë°®Áé∞‰∏∫Â≠òÂÇ®Âú®ÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆÁªìÊûÑÔºåËÄåÂÖ∂‰∏≠ÁöÑÂØÑÂ≠òÂô®Âàô‰Ωú‰∏∫ÁªìÊûÑ‰Ωì‰∏≠ÁöÑËã•Âπ≤Âüü <code>fields</code>„ÄÇ</p>
<p>ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºåËôöÊãüÊú∫ÈÄöËøáMMIOÔºàMemory-Mapped I/OÔºåÂÜÖÂ≠òÊò†Â∞ÑI/OÔºâÁöÑÊñπÂºèËÆøÈóÆËôöÊãüAPICÔºå‰ΩÜÊòØÁî±‰∫éÂ∫ïÂ±ÇÂπ∂Ê≤°ÊúâÁõ∏Â∫îÁöÑÁâ©ÁêÜÁ°¨‰ª∂‰æõÂÖ∂ËÆøÈóÆÔºåÊïÖHypervisorÈúÄË¶ÅÊà™Ëé∑Ëøô‰∫õMMIOËØ∑Ê±ÇËøõËÄåËÆøÈóÆÂ≠òÂÇ®Âú®ÂÜÖÂ≠ò‰∏≠ÁöÑËôöÊãüÂØÑÂ≠òÂô®ÁöÑÂÄº„ÄÇ</p>
<blockquote>
<p>HypervisorÈÄöÂ∏∏‰ºöÂ∞ÜËôöÊãüÊú∫‰∏≠APICÂÜÖÂ≠òÊò†Â∞ÑÂå∫ÂüüÁõ∏Â∫îÁöÑEPTÈ°πÁä∂ÊÄÅËÆæ‰∏∫‰∏çÂ≠òÂú®ÔºåËøôÊ†∑ËôöÊãüÊú∫ËÆøÈóÆËøô‰∏ÄÊÆµÂú∞ÂùÄÁ©∫Èó¥Êó∂Ôºå‰æø‰ºöËß¶ÂèëÁº∫È°µÈîôËØØ‰ªéËÄåËß¶ÂèëVM-ExitÈô∑ÂÖ•Hypervisor‰∏≠ËøõË°åÊ®°Êãü„ÄÇ</p>
</blockquote>
<p>Ê≠§Â§ñÔºå**ËôöÊãüAPIC‰ªçÈúÄË¶ÅÊé•Êî∂Âíå‰º†ÈÄí‰∏≠Êñ≠„ÄÇ**Âú®Áâ©ÁêÜÁéØÂ¢É‰∏ãÔºåÂ§ñÈÉ®ËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠‰ºöÈÄöËøáËøûÊé•Á∫ø‰º†ËæìËá≥APICËøõËÄåÂèëÈÄÅÂà∞CPUÔºåÂú®Ê≠§ËøáÁ®ã‰∏≠ÔºåÁ°¨‰ª∂‰ºöËÆæÁΩÆÁõ∏Â∫îÂØÑÂ≠òÂô®ÁöÑÂÄº„ÄÇËÄåÂú®ËôöÊãüÁéØÂ¢É‰∏≠ÔºåËøô‰∫õËøûÊé•Á∫øÂàô‰ºöË¢´ÊõøÊç¢‰∏∫‰∏ÄÁ≥ªÂàóÁöÑÂáΩÊï∞Ë∞ÉÁî®ÔºåÂπ∂Âú®Ë∞ÉÁî®ËøáÁ®ã‰∏≠ËÆæÁΩÆÂÜÖÂ≠ò‰∏≠Áõ∏Â∫îËôöÊãüÂØÑÂ≠òÂô®ÁöÑÂÄº„ÄÇ</p>
<p>APIC‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ãÂåÖÊã¨**‰∏≠Êñ≠‰∫ßÁîü„ÄÅ‰∏≠Êñ≠Ë∑ØÁî±„ÄÅ‰∏≠Êñ≠Êé•Âèó„ÄÅ‰∏≠Êñ≠Á°ÆËÆ§Âíå‰∏≠Êñ≠‰∫§‰ªò„ÄÇ**ÂÖ∂‰∏≠Ôºå‰∏≠Êñ≠‰∫ßÁîüÂà∞‰∏≠Êñ≠Á°ÆËÆ§ÈÉ®ÂàÜÈÉΩÊòØÈÄöËøáËÆæÁΩÆÁâπÂÆöAPICÂØÑÂ≠òÂô®ÂÆåÊàêÔºåÂØπ‰∫éËôöÊãüAPICËÄåË®ÄÔºåÂèØ‰ª•ÈÄöËøáËÆæÁΩÆÂÜÖÂ≠ò‰∏≠Áõ∏Â∫îÁöÑËôöÊãüÂØÑÂ≠òÂô®ÂÆûÁé∞ÂêåÊ†∑ÁöÑÂäüËÉΩ„ÄÇËÄåÂØπ‰∫é‰∏≠Êñ≠‰∫§‰ªòËÄåË®ÄÔºå**ÈúÄË¶ÅÁ°¨‰ª∂Êèê‰æõÊüêÁßçÊú∫Âà∂Ôºå‰ΩøÂæóËôöÊãüÊú∫ÊÅ¢Â§çËøêË°åÊó∂ÂèëÁé∞ÂæÖÂ§ÑÁêÜÁöÑËôöÊãü‰∏≠Êñ≠‰ªéËÄåÊâßË°åÁõ∏Â∫îÁöÑISR„ÄÇ**Âú®Intel VT-x‰∏≠ÔºåËøôÊòØÈÄöËøáVMCS VM-EntryÊéßÂà∂Âüü‰∏≠ÁöÑVM-Entry‰∏≠Êñ≠‰ø°ÊÅØÂ≠óÊÆµÔºà32‰ΩçÔºâÂÆûÁé∞ÁöÑÔºåËØ•Â≠óÊÆµ‰øùÂ≠ò‰∫ÜÂæÖÊ≥®ÂÖ•‰∫ã‰ª∂ÁöÑÁ±ªÂûãÔºà‰∏≠Êñ≠ÊàñÂºÇÂ∏∏Á≠âÔºâÂíåÂêëÈáèÂè∑Á≠â‰ø°ÊÅØÔºåÂÖ∂Ê†ºÂºèÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221551030.png" alt="image-20231122155113238" style="zoom:50%;" />
<p>ÊØèÊ¨°Ëß¶ÂèëVM-EntryÊó∂ÔºåCPU‰ºöÊ£ÄÊü•ËØ•ÂüüÔºåÂèëÁé∞ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜÁöÑ‰∫ã‰ª∂Âπ∂Áî®ÂêëÈáèÂè∑Á¥¢ÂºïÊâßË°åÁõ∏Â∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞„ÄÇ</p>
<p>ÂΩìHypervisorÈúÄË¶ÅÂêëÊ≠£Âú®ËøêË°åÁöÑvCPUÊ≥®ÂÖ•‰∏≠Êñ≠Êó∂ÔºåÈúÄË¶ÅÁªôvCPUÂèëÈÄÅ‰∏Ä‰∏™‰ø°Âè∑Ôºå‰ΩøÂÖ∂Ëß¶ÂèëVM-ExitÔºå‰ªéËÄåÂú®VM-EntryÊó∂Ê≥®ÂÖ•‰∏≠Êñ≠„ÄÇÂ¶ÇÊûúvCPUÊ≠£Â§Ñ‰∫éÂ±èËîΩÂ§ñÈÉ®‰∏≠Êñ≠ÁöÑÁä∂ÊÄÅÔºåÂ¶ÇvCPUÁöÑ <code>RFLAGS.IF=0</code>ÔºåÂ∞Ü‰∏çÂÖÅËÆ∏Âú®VM-EntryÊó∂ËøõË°å‰∏≠Êñ≠Ê≥®ÂÖ•„ÄÇÊ≠§Êó∂ÂèØ‰ª•Â∞ÜVM-ExecutionÊéßÂà∂Âüü‰∏≠ÁöÑ‰∏≠Êñ≠Á™óÂè£ÈÄÄÂá∫(Interrupt-Window Exiting)Â≠óÊÆµÁΩÆ‰∏∫1ÔºåËøôÊ†∑‰∏ÄÊó¶vCPUËøõÂÖ•ËÉΩÂ§üÊé•Êî∂‰∏≠Êñ≠ÁöÑÁä∂ÊÄÅÔºå‰æø‰ºö‰∫ßÁîü‰∏Ä‰∏™VM-ExitÔºåHypervisorÂ∞±ÂèØ‰ª•Ê≥®ÂÖ•ÂàöÊâçÊó†Ê≥ïÊ≥®ÂÖ•ÁöÑ‰∏≠Êñ≠ÔºåÂπ∂Â∞Ü‰∏≠Êñ≠Á™óÂè£ÈÄÄÂá∫Â≠óÊÆµÁΩÆ‰∏∫0„ÄÇ</p>
<h3 id="apicvÊîØÊåÅÁöÑ‰∏≠Êñ≠ËôöÊãüÂåñ">APICvÊîØÊåÅÁöÑ‰∏≠Êñ≠ËôöÊãüÂåñ
</h3><p>APICvÊòØIntelÂÖ¨Âè∏ÈíàÂØπAPICËôöÊãüÂåñÊèêÂá∫ÁöÑ‰ºòÂåñÊäÄÊúØÔºåÂÆÉ‰∏ªË¶ÅÂåÖÊã¨‰∏§ÊñπÈù¢ÂÜÖÂÆπÔºö<strong>ËôöÊãüAPICËÆøÈóÆ‰ºòÂåñÂíåËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§„ÄÇ</strong></p>
<h4 id="ËôöÊãüapicËÆøÈóÆ">ËôöÊãüAPICËÆøÈóÆ
</h4><p>ÂâçÈù¢ÊèêÂà∞ÔºåÂΩìËôöÊãüÊú∫ÈÄöËøáMMIOÁöÑÊñπÂºèËÆøÈóÆAPICÂØÑÂ≠òÂô®Êó∂ÔºåÈúÄË¶ÅVM-ExitÈô∑ÂÖ•Hypervisor‰∏≠ËÆæÁΩÆÂÜÖÂ≠ò‰∏≠Áõ∏Â∫îËôöÊãüÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåËøôÂ∞Ü‰ºöËß¶ÂèëÂ§ßÈáèÁöÑVM-ExitÔºå‰∏•ÈáçÂΩ±ÂìçËôöÊãüÊú∫ÁöÑÊÄßËÉΩ„ÄÇ‰∫éÊòØAPICvÂºïÂÖ•ËôöÊãüAPICÈ°µ (Virtual APIC Page) ÁöÑÊ¶ÇÂøµÔºåÂÆÉÁõ∏ÂΩì‰∫é‰∏Ä‰∏™ÂΩ±Â≠êAPICÔºåËôöÊãüÊú∫ÂØπAPICÁöÑÈÉ®ÂàÜÁîöËá≥ÂÖ®ÈÉ®ËÆøÈóÆÈÉΩÂèØ‰ª•Ë¢´Á°¨‰ª∂ÈáçÂÆöÂêë‰∏∫ÂØπËôöÊãüAPICÈ°µÁöÑËÆøÈóÆÔºåËøôÊ†∑Â∞±‰∏çÂøÖÈ¢ëÁπÅËß¶ÂèëVM-Exit‰∫Ü„ÄÇË¶ÅÂêØÁî®ËôöÊãüAPICÈ°µÔºåÈúÄË¶Å‰ΩøËÉΩÂ¶Ç‰∏ã<strong>‰∏â‰∏™VM-ExecutionÊéßÂà∂ÂüüÂ≠óÊÆµÔºö</strong></p>
<ul>
<li>**ÂΩ±Â≠êTPR(Use TPR Shadow)Â≠óÊÆµ„ÄÇ**ËØ•Â≠óÊÆµÁΩÆ1ÂêéÔºåËôöÊãüÊú∫ËÆøÈóÆCR8Êó∂Â∞Ü‰ºöËá™Âä®ËÆøÈóÆËôöÊãüAPICÈ°µ‰∏≠ÁöÑTPRÂØÑÂ≠òÂô®„ÄÇÂê¶ÂàôÔºåËôöÊãüÊú∫ËÆøÈóÆCR8Êó∂Â∞Ü‰ºöËß¶ÂèëVM-Exit„ÄÇ</li>
<li>**ËôöÊãüAPICËÆøÈóÆ(Virtualize APIC Accesses)Â≠óÊÆµ„ÄÇ**ËØ•Â≠óÊÆµÁΩÆ1ÂêéÔºåËôöÊãüÊú∫ÂØπ‰∫éAPICËÆøÈóÆÈ°µ(APIC Access Page)ÁöÑËÆøÈóÆÂ∞Ü‰ºöËß¶ÂèëAPICËÆøÈóÆ(APIC Access)ÂºÇÂ∏∏Á±ªÂûãÁöÑVM-Exit„ÄÇÂçïÁã¨ËÆæÁΩÆËØ•ÂüüÊó∂Ôºå‰∏é‰ª•ÂâçÈÄöËøáËÆæÁΩÆEPTÈ°µË°®È°πËß¶ÂèëVM-ExitÁõ∏ÊØîÔºå‰ªÖ‰ªÖÂè™ÊòØÂ∞ÜVM-ExitÁ±ªÂûã‰ªéEPTËøù‰æã(EPT Violation)Âèò‰∏∫‰∫ÜAPICËÆøÈóÆ„ÄÇÈúÄË¶ÅËøõ‰∏ÄÊ≠•ËÆæÁΩÆAPICÂØÑÂ≠òÂô®ËôöÊãüÂåñ(APIC-Register Virtualization)Â≠óÊÆµÊ∂àÈô§VM-Exit„ÄÇ</li>
<li>**APICÂØÑÂ≠òÂô®ËôöÊãüÂåñÂ≠óÊÆµ„ÄÇ**ËØ•Â≠óÊÆµÁΩÆ1ÂêéÔºåÈÄöÂ∏∏ËôöÊãüÊú∫ÂØπ‰∫éAPICËÆøÈóÆÈ°µÁöÑËÆøÈóÆÂ∞ÜË¢´ÈáçÂÆöÂêëÂà∞ËôöÊãüAPICÈ°µËÄå‰∏ç‰ºöËß¶ÂèëVM-ExitÔºå‰ΩÜÈÉ®ÂàÜÊÉÖÂÜµ‰∏ã‰ªçÈúÄË¶ÅVM-ExitÂà∞Hypervisor‰∏≠Â§ÑÁêÜ„ÄÇ</li>
</ul>
<p>‰ΩøÁî®APICvÂâçÂêéÔºåËôöÊãüAPICËÆøÈóÆÊñπÂºèÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221554783.png" alt="image-20231122155250442" style="zoom:50%;" />
<hr>
<h4 id="ËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§">ËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§
</h4><p>ËÄåËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§ (Virtual-Interrupt Delivery) ÈÄöËøáVM-ExecutionÊéßÂà∂Âüü‰∏≠ÁöÑËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§Â≠óÊÆµÂºÄÂêØ„ÄÇÂú®ÂºïÂÖ•ËØ•Êú∫Âà∂ÂâçÔºåHypervisorÈúÄË¶ÅËÆæÁΩÆ <code>VIRR</code>Âíå <code>VISR</code> Áõ∏Â∫î‰ΩçÔºàËôöÊãüAPIC‰∏≠ÁöÑ <code>IRR</code> Âíå <code>ISR</code>ÔºâÔºåÁÑ∂ÂêéÈÄöËøá‰∏äÊñáÊèêÂà∞ÁöÑ‰∫ã‰ª∂Ê≥®ÂÖ•Êú∫Âà∂Âú®‰∏ã‰∏ÄÊ¨°VM-EntryÊó∂Ê≥®ÂÖ•‰∏Ä‰∏™ËôöÊãü‰∏≠Êñ≠ÔºåË∞ÉÁî®ÂÆ¢Êà∑Êú∫‰∏≠Áõ∏Â∫îÁöÑ‰∏≠Êñ≠Â§ÑÁêÜ‰æãÁ®ã„ÄÇ</p>
<p>ÂºÄÂêØËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§ÂêéÔºåËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•ÈÄöËøáVMCSÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüü‰∏≠ÁöÑÂÆ¢Êà∑Êú∫‰∏≠Êñ≠Áä∂ÊÄÅ (Guest Interrupt Status) Â≠óÊÆµÂÆåÊàêÔºö</p>
<ul>
<li>ÂÖ∂‰Ωé8‰Ωç‰∏∫ <code>RVI</code>ÔºàRequesting Virtual InterruptÔºåÂæÖÂ§ÑÁêÜËôöÊãü‰∏≠Êñ≠ÔºâÔºåË°®Á§∫ËôöÊãüÊú∫ÂæÖÂ§ÑÁêÜ‰∏≠Êñ≠‰∏≠‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºåÁõ∏ÂΩì‰∫é <code>IRRV</code> Ôºõ</li>
<li>ËÄåÈ´ò8‰Ωç‰∏∫ <code>SVI</code>ÔºàServicing Virtual InterruptÔºåÂ§ÑÁêÜ‰∏≠ËôöÊãü‰∏≠Êñ≠ÔºâÔºåË°®Á§∫ËôöÊãüÊú∫Ê≠£Âú®Â§ÑÁêÜ‰∏≠Êñ≠‰∏≠‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºåÁõ∏ÂΩì‰∫é <code>ISRV</code>„ÄÇ</li>
</ul>
<p>ÂºÄÂêØËôöÊãü‰∏≠Êñ≠‰º†ÈÄÅÂêéÔºåHypervisorÂè™ÈúÄË¶ÅËÆæÁΩÆ <code>RVI</code> ÁöÑÂÄºÔºåÂú®VM-EntryÊó∂ÔºåCPUÂ∞Ü‰ºöÊ†πÊçÆRVIÁöÑÂÄºËøõË°åËôöÊãü‰∏≠Êñ≠Êèê‰∫§ÔºåËøáÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>Ëã•VM-ExecutionÊéßÂà∂Âüü‰∏≠Êñ≠Á™óÂè£ÈÄÄÂá∫ (Interrupt-Window Exiting) Â≠óÊÆµ‰∏∫0‰∏î <code>RVI[7‚à∂4] &gt; VPPR[7‚à∂4]</code>ÔºåÂàôÁ°ÆËÆ§Â≠òÂú®ÂæÖÂ§ÑÁêÜÁöÑËôöÊãü‰∏≠Êñ≠ÔºåÂÖ∂‰∏≠VPPRÊåáÁöÑÊòØvCPUÁöÑPPRÂØÑÂ≠òÂô®Ôºõ</li>
<li>Ê†πÊçÆ <code>RVI</code>ÔºåÊ∏ÖÈô§ <code>VIRR</code> ‰∏≠ÂØπÂ∫î‰ΩçÔºåËÆæÁΩÆ <code>VISR</code> ‰∏≠ÂØπÂ∫î‰ΩçÔºåÂπ∂ËÆæÁΩÆ <code>SVI=RVI</code>Ôºõ</li>
<li>ËÆæÁΩÆ <code>VPPR = RVI &amp; 0xf0</code>Ôºõ</li>
<li>Ëã• <code>VIRR</code> ‰∏≠ËøòÊúâÈùûÈõ∂‰ΩçÔºåÂàôËÆæÁΩÆ <code>RVI=VIRRV</code>ÔºåÂç≥ <code>VIRR</code> ‰∏≠‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºåÂê¶ÂàôËÆæÁΩÆ <code>RVI=0</code>Ôºõ</li>
<li>Ê†πÊçÆ <code>RVI</code> Êèê‰æõÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºåË∞ÉÁî®ËôöÊãüÊú∫‰∏≠Ê≥®ÂÜåÁöÑ‰∏≠Êñ≠Â§ÑÁêÜ‰æãÁ®ã„ÄÇ</li>
</ol>
<p>Âú®‰∏äËø∞ÊµÅÁ®ã‰∏≠Ôºå‰∏≠Êñ≠Á°ÆËÆ§Âíå‰∏≠Êñ≠‰∫§‰ªòÂ∑•‰ΩúÂ∞ÜÁî±Á°¨‰ª∂Ëá™Âä®ÂÆåÊàêÔºåHypervisorÊó†È°ªÊâãÂä®ËÆæÁΩÆËôöÊãüAPIC‰∏≠ <code>VIRR</code> Âíå <code>VISR</code> ÂØÑÂ≠òÂô®ÁöÑÂÄº„ÄÇÊ≠§Â§ñÔºåËÆæÁΩÆ <code>RVI</code>ÂêéÔºåÂç≥‰ΩøÂΩìÂâçvCPUÂ§Ñ‰∫éÂ±èËîΩ‰∏≠Êñ≠ÁöÑÁä∂ÊÄÅ‰πüÊó†Â¶®ÔºåÁ°¨‰ª∂‰ºöÊåÅÁª≠Ê£ÄÊü•vCPUÊòØÂê¶ËÉΩÂ§üÊé•Êî∂‰∏≠Êñ≠„ÄÇ‰∏ÄÊó¶vCPUËÉΩÊé•Êî∂‰∏≠Êñ≠ÔºåÂàôÁ´ãÂç≥ËøõË°åËôöÊãü‰∏≠Êñ≠‰∫§‰ªòÔºåÊó†È°ªÂÜçÈÄöËøáÂâçËø∞‰∏≠Êñ≠Á™óÂè£‰∫ßÁîüVM-ExitÊ≥®ÂÖ•‰∏≠Êñ≠„ÄÇ</p>
<hr>
<p>ËôöÊãü‰∏≠Êñ≠ËôΩÁÑ∂ÁúÅÁï•‰∫Ü‰∏≠Êñ≠Á°ÆËÆ§Âíå‰∏≠Êñ≠ÈÄí‰∫§ÁöÑËøáÁ®ãÔºå‰ΩÜÊòØ‰∏≠Êñ≠Êé•Âèó‰ªçÈúÄË¶ÅHypervisorÂÆåÊàê„ÄÇÂΩìHypervisorÈúÄË¶ÅÂ∞ÜËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•vCPUÊó∂ÔºåÂøÖÈ°ª‰ΩøÂÖ∂ÂèëÁîüVM-ExitÂπ∂ËÆæÁΩÆÂ•Ω <code>RVI</code> ÁöÑÂÄºÔºåÊâçËÉΩÈ°∫Âà©ËøõË°åÂêéÁª≠Êìç‰Ωú„ÄÇËÄå<strong>ÂèëÂ∏É-‰∏≠Êñ≠ (Posted-Interrupt) Êú∫Âà∂</strong>ÂèØ‰ª•ÁúÅÁï•‰∏≠Êñ≠Êé•ÂèóÁöÑËøáÁ®ãÔºåÁõ¥Êé•ËÆ©Ê≠£Âú®ËøêË°åÁöÑvCPUÊî∂Âà∞‰∏Ä‰∏™ËôöÊãü‰∏≠Êñ≠ÔºåËÄå‰∏ç‰∫ßÁîüVM-Exit„ÄÇ</p>
<blockquote>
<p>ÂèëÂ∏É-‰∏≠Êñ≠Êú∫Âà∂ËøòÂèØ‰ª•ÈÖçÂêàVT-dÁöÑÂèëÂ∏É-‰∏≠Êñ≠ÂäüËÉΩ‰ΩøÁî®ÔºåÂÆûÁé∞Áõ¥ÈÄöËÆæÂ§áÁöÑ‰∏≠Êñ≠Áõ¥Êé•ÂèëÁªôvCPUËÄå‰∏çÂºïËµ∑VM-Exit„ÄÇ</p>
</blockquote>
<p>ÂèëÂ∏É-‰∏≠Êñ≠Êú∫Âà∂ÈÄöËøáVM-ExecutionÊéßÂà∂Âüü‰∏≠ÁöÑÂèëÂ∏É-‰∏≠Êñ≠Â§ÑÁêÜ (Process Posted-Interrupt) Â≠óÊÆµÂºÄÂêØÔºåÂÆÉÂºïÂÖ•‰∫ÜÂèëÂ∏É-‰∏≠Êñ≠ÈÄöÁü•ÂêëÈáè(Posted-Interrupt Notification Vector)ÂíåÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶(Posted-Interrupt Descriptor)„ÄÇÂÖ∂‰∏≠ÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶‰øùÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠ÔºåËÄåÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶ÁöÑÂú∞ÂùÄ‰øùÂ≠òÂú®VMCSÁöÑÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶Âú∞ÂùÄ(Posted-Interrupt Descriptor Address)Â≠óÊÆµ‰∏≠„ÄÇÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶ÁöÑÊ†ºÂºèÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221554449.png" alt="image-20231122155421654" style="zoom:50%;" />
<p>ÂÖ∂‰∏≠ÔºåÂêÑÂ≠óÊÆµ‰ΩúÁî®Ôºö</p>
<ul>
<li><code>PIR</code>ÔºàPosted-Interrupt RequestsÔºåÂèëÂ∏É-‰∏≠Êñ≠ËØ∑Ê±ÇÔºâÊòØ‰∏Ä‰∏™256‰ΩçÁöÑ‰ΩçÂõæÔºå‰∏é <code>IRR</code> Á±ª‰ººÔºåÁõ∏Â∫î‰ΩçÁΩÆ1Ë°®Á§∫ÊúâÂæÖÂ§ÑÁêÜ‰∏≠Êñ≠Ôºõ</li>
<li><code>ON</code>ÔºàOutstanding NotificationÔºåÈÄöÁü•Â∑≤ÂÆåÊàêÔºâË°®Á§∫ÊòØÂê¶Â∑≤ÁªèÂêëCPUÂèëÈÄÅÈÄöÁü•‰∫ã‰ª∂ÔºàONÊú¨Ë¥®‰∏äÊòØ‰∏Ä‰∏™Áâ©ÁêÜ‰∏≠Êñ≠ÔºâÔºåÂêëCPUÈÄöÁü• <code>PIR</code> ‰∏≠ÊúâÂæÖÂ§ÑÁêÜ‰∏≠Êñ≠„ÄÇ</li>
</ul>
<p>ÂèëÂ∏É-‰∏≠Êñ≠Â§ÑÁêÜÂ≠óÊÆµÁΩÆ1ÂêéÔºåÂΩìÂ§Ñ‰∫éÈùûÊ†πÊ®°ÂºèÁöÑCPUÊî∂Âà∞‰∏Ä‰∏™Â§ñÈÉ®‰∏≠Êñ≠Êó∂ÔºåÂÆÉÈ¶ñÂÖàÂÆåÊàê‰∏≠Êñ≠Êé•ÂèóÂíå‰∏≠Êñ≠Á°ÆËÆ§ÔºåÂπ∂ÂèñÂæó‰∏≠Êñ≠ÂêëÈáèÂè∑„ÄÇÁÑ∂ÂêéÔºåËã•‰∏≠Êñ≠ÂêëÈáèÂè∑‰∏éÂèëÂ∏É-‰∏≠Êñ≠ÈÄöÁü•ÂêëÈáèÁõ∏Á≠âÔºåÂàôËøõÂÖ•ÂèëÂ∏É-‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ãÔºåÂê¶ÂàôÁÖßÂ∏∏‰∫ßÁîüVM-Exit„ÄÇÂèëÂ∏É-‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>Ê∏ÖÈô§ÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶ÁöÑ <code>ON</code> ‰ΩçÔºõ</li>
<li>ÂêëCPUÁöÑ <code>EOI</code> ÂØÑÂ≠òÂô®ÂÜôÂÖ•0Âπ∂ÊâßË°åÔºåËá≥Ê≠§Âú®Á°¨‰ª∂APIC‰∏äËØ•‰∏≠Êñ≠Â∑≤ÁªèÂ§ÑÁêÜÂÆåÊØïÔºõ</li>
<li>‰ª§ <code>VIRR |= PIR</code> ÔºåÂπ∂Ê∏ÖÁ©∫ <code>PIR</code>Ôºõ</li>
<li>ËÆæÁΩÆ <code>RVI = max(RVI,PIRV)</code>ÔºåÂÖ∂‰∏≠ <code>PIRV</code> ‰∏∫ <code>PIR</code> ‰∏≠‰ºòÂÖàÁ∫ßÊúÄÈ´òÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑Ôºõ</li>
<li>CPUÊ†πÊçÆ <code>RVI</code> ÊåâÁÖßÂâçËø∞ÊµÅÁ®ãÈÄí‰∫§ËôöÊãü‰∏≠Êñ≠„ÄÇ</li>
</ol>
<p>‰ªé‰∏äËø∞ÊµÅÁ®ã‰∏çÈöæÂèëÁé∞Ôºå<strong><font color='red'>Âè™ÈúÄË¶ÅÂ∞ÜÂæÖÊ≥®ÂÖ•ÁöÑ‰∏≠Êñ≠ÊîæÁΩÆÂú®ÂèëÂ∏É-‰∏≠Êñ≠ÊèèËø∞Á¨¶ÁöÑ <code>PIR</code> ‰∏≠ÔºåÂπ∂ÂêëCPUÂèëÈÄÅ‰∏Ä‰∏™ÂèëÂ∏É-‰∏≠Êñ≠ÈÄöÁü•ÔºåCPUÂ∞±‰ºöËá™Âä®Â∞Ü <code>PIR</code> ‰∏≠Â≠òÂÇ®ÁöÑËôöÊãü‰∏≠Êñ≠ÂêåÊ≠•Âà∞ <code>RVI</code> ‰∏≠ÔºåÊó†È°ªHypervisorÊâãÂä®ËÆæÁΩÆRVIÁöÑÂÄº„ÄÇ</font></strong></p>
<p><strong>ÈÄöËøáÂèëÂ∏É-‰∏≠Êñ≠Êú∫Âà∂‰æøÂèØ‰ª•Âú®‰∏çÂèëÁîüVM-ExitÁöÑÊÉÖÂÜµ‰∏ãÂêëvCPU‰∏≠Ê≥®ÂÖ•‰∏Ä‰∏™ÊàñËÄÖÂ§ö‰∏™ËôöÊãü‰∏≠Êñ≠„ÄÇ</strong></p>
<h1 id="3-qemukvm-cpuËôöÊãüÂåñÂÆûÁé∞">3 QEMU/KVM CPUËôöÊãüÂåñÂÆûÁé∞
</h1><blockquote>
<p>Êú¨ËäÇ‰ª•x86Êû∂ÊûÑ‰∏ãÁöÑQEMU/KVMÂÆûÁé∞‰∏∫‰æãÔºå‰ªãÁªçÂâçËø∞Á°¨‰ª∂ËôöÊãüÂåñÊäÄÊúØÂ¶Ç‰ΩïË¢´Â∫îÁî®Âà∞ÂÆûË∑µ‰∏≠„ÄÇ</p>
</blockquote>
<p>QEMUÂéüÊú¨ÊòØÁ∫ØËΩØ‰ª∂ÂÆûÁé∞ÁöÑ‰∏ÄÂ•óÂÆåÊï¥ÁöÑËôöÊãüÂåñÊñπÊ°àÔºåÊîØÊåÅCPUËôöÊãüÂåñ„ÄÅÂÜÖÂ≠òËôöÊãüÂåñ‰ª•ÂèäËÆæÂ§áÊ®°ÊãüÁ≠âÔºå‰ΩÜÊòØÊÄßËÉΩ‰∏çÂ§™ÁêÜÊÉ≥„ÄÇÈöèÁùÄÁ°¨‰ª∂ËæÖÂä©ËôöÊãüÂåñÊäÄÊúØÈÄêÊ∏êÂÖ¥Ëµ∑ÔºåQumranetÂÖ¨Âè∏Âü∫‰∫éÊñ∞ÂÖ¥ÁöÑËôöÊãüÂåñÁ°¨‰ª∂ÂÆûÁé∞‰∫ÜKVM„ÄÇKVMÈÅµÂæ™LinuxÁöÑËÆæËÆ°ÂéüÂàôÔºå‰ª•ÂÜÖÊ†∏Ê®°ÂùóÁöÑÂΩ¢ÂºèÂä®ÊÄÅÂä†ËΩΩÂà∞LinuxÂÜÖÊ†∏‰∏≠ÔºåÂà©Áî®ËôöÊãüÂåñÁ°¨‰ª∂Âä†ÈÄüCPUËôöÊãüÂåñÂíåÂÜÖÂ≠òËôöÊãüÂåñÊµÅÁ®ãÔºåI/OËôöÊãüÂåñÂàô‰∫§ÁªôÁî®Êà∑ÊÄÅÁöÑQEMUÂÆåÊàêÔºåQEMU/KVMÊû∂ÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221902898.png" alt="image-20231122164858226" style="zoom: 33%;" />
<p>CPUËôöÊãüÂåñ‰∏ªË¶ÅÂÖ≥ÂøÉ‰∏äÂõæÁöÑÂ∑¶‰æßÈÉ®ÂàÜÔºåÂç≥vCPUÊòØÂ¶Ç‰ΩïÂàõÂª∫Âπ∂ËøêË°åÁöÑÔºå‰ª•ÂèäÂΩìvCPUÊâßË°åÊïèÊÑüÊåá‰ª§Ëß¶ÂèëVM-ExitÊó∂ÔºåQEMU/KVMÂèàÊòØÂ¶Ç‰ΩïÂ§ÑÁêÜËøô‰∫õVM-ExitÁöÑ„ÄÇÊï¥‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>ÂΩìQEMUÂêØÂä®Êó∂ÔºåÈ¶ñÂÖà‰ºöËß£ÊûêÁî®Êà∑‰º†ÂÖ•ÁöÑÂëΩ‰ª§Ë°åÂèÇÊï∞ÔºåÁ°ÆÂÆöÂàõÂª∫ÁöÑËôöÊãüÊú∫Á±ªÂûãÔºàÈÄöËøáQEMU-machineÂèÇÊï∞ÊåáÂÆöÔºâ‰∏éCPUÁ±ªÂûãÔºàÈÄöËøáQEMU-cpuÂèÇÊï∞ÊåáÂÆöÔºâÔºåÂπ∂<strong>ÂàõÂª∫Áõ∏Â∫îÁöÑÊú∫Âô®Ê®°ÂûãÂíåCPUÊ®°ÂûãÔºõ</strong></li>
<li>ËÄåÂêéQEMUÊâìÂºÄKVMÊ®°ÂùóËÆæÂ§áÊñá‰ª∂Âπ∂ÂèëËµ∑ <code>ioctl(KVM_CREATE_VM)</code>Ôºå**ËØ∑Ê±ÇKVMÂàõÂª∫‰∏Ä‰∏™ËôöÊãüÊú∫„ÄÇ**KVMÂàõÂª∫ËôöÊãüÊú∫Áõ∏Â∫îÁöÑÁªìÊûÑ‰ΩìÂπ∂‰∏∫QEMUËøîÂõû‰∏Ä‰∏™ËôöÊãüÊú∫Êñá‰ª∂ÊèèËø∞Á¨¶Ôºõ</li>
<li>QEMUÈÄöËøáËôöÊãüÊú∫Êñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑ <code>ioctl(KVM_CREATE_VCPU)</code> Ôºå**ËØ∑Ê±ÇKVMÂàõÂª∫vCPU„ÄÇ**‰∏éÂàõÂª∫ËôöÊãüÊú∫ÊµÅÁ®ãÁ±ª‰ººÔºåKVMÂàõÂª∫vCPUÁõ∏Â∫îÁöÑÁªìÊûÑ‰ΩìÂπ∂ÂàùÂßãÂåñÔºåËøîÂõû‰∏Ä‰∏™vCPUÊñá‰ª∂ÊèèËø∞Á¨¶Ôºõ</li>
<li>QEMUÈÄöËøávCPUÊñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑ <code>ioctl(KVM_RUN)</code>ÔºåvCPUÁ∫øÁ®ãÊâßË°å <code>VMLAUNCH</code> Êåá‰ª§**ËøõÂÖ•ÈùûÊ†πÊ®°ÂºèÔºå**ÊâßË°åËôöÊãüÊú∫‰ª£Á†ÅÁõ¥Ëá≥ÂèëÁîüVM-ExitÔºõ</li>
<li>KVMÊ†πÊçÆVM-ExitÁöÑÂéüÂõ†ËøõË°åÁõ∏Â∫îÂ§ÑÁêÜÔºåÂ¶ÇÊûú‰∏éI/OÊúâÂÖ≥ÔºåÂàôÈúÄË¶ÅËøõ‰∏ÄÊ≠•<strong>ËøîÂõûÂà∞QEMU‰∏≠</strong>ËøõË°åÂ§ÑÁêÜ„ÄÇ</li>
</ol>
<p>‰ª•‰∏äÂ∞±ÊòØQEMU/KVM CPUËôöÊãüÂåñÁöÑ‰∏ªË¶ÅÊµÅÁ®ã„ÄÇ</p>
<hr>
<p>Êú¨ËäÇÂ∞Ü‰ªé<strong>KVMÊ®°ÂùóÂàùÂßãÂåñ„ÄÅËôöÊãüÊú∫ÂàõÂª∫„ÄÅvCPUÂàõÂª∫ÂíåvCPUËøêË°å</strong>Âõõ‰∏™ÊñπÈù¢ËøõË°å‰ªãÁªçÔºåÊúÄÂêéÁªôÂá∫CPUËôöÊãüÂåñÂÆû‰æã„ÄÇ</p>
<blockquote>
<p>Âú®Ê≤°ÊúâÁâπÊÆäËØ¥ÊòéÁöÑÊÉÖÂÜµ‰∏ãÔºåÂêéÁª≠Á´†ËäÇÊâÄÂàóÂá∫ÁöÑÁ§∫‰æã‰ª£Á†ÅÂØπÂ∫îÁöÑ**LinuxÂÜÖÊ†∏ÁâàÊú¨‰∏∫4.19.0ÔºåQEMUÁâàÊú¨‰∏∫4.1.1Ôºå**Áî±‰∫éÁØáÂπÖÊúâÈôêÔºåÁ§∫‰æã‰ª£Á†ÅÂè™ÊëòÂèñ‰∫ÜÊ∫êÁ†Å‰∏≠ÁöÑ‰∏ÄÈÉ®ÂàÜ„ÄÇ</p>
</blockquote>
<h2 id="31-kvmÊ®°ÂùóÂàùÂßãÂåñ">3.1 KVMÊ®°ÂùóÂàùÂßãÂåñ
</h2><p>ÂâçÈù¢ÊèêÂà∞QEMUÈÄöËøáËÆæÂ§áÊñá‰ª∂ <code>/dev/kvm</code> ÂèëËµ∑ioctlÁ≥ªÁªüË∞ÉÁî®ËØ∑Ê±ÇKVMÂàõÂª∫ËôöÊãüÊú∫ÔºåËØ•ËÆæÂ§áÊñá‰ª∂‰æøÊòØÂú®KVMÊ®°ÂùóÂàùÂßãÂåñÊó∂ÂàõÂª∫ÁöÑ„ÄÇ</p>
<p><code>kvm-intel.ko</code> Ê®°ÂùóÂàùÂßãÂåñÂáΩÊï∞‰∏∫ <code>vmx_init</code>ÔºåËØ•ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>kvm_init</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>misc_register</code> ÂáΩÊï∞**Ê≥®ÂÜåkvm_devËøô‰∏ÄmiscËÆæÂ§áÔºå**‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221650472.png" alt="image-20231122165049068" style="zoom:33%;" />
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221651404.png" alt="image-20231122165114833" style="zoom:33%;" />
<p>Ê≥®ÂÜåÊàêÂäüÂêé‰ºöÂú® <code>/dev/</code> ÁõÆÂΩï‰∏ã‰∫ßÁîüÂêç‰∏∫kvmÁöÑËÆæÂ§áËäÇÁÇπÔºåÂç≥ <code>/dev/kvm</code>„ÄÇËØ•ËÆæÂ§áÊñá‰ª∂ÂØπÂ∫îÁöÑfdÔºàÊñá‰ª∂ÊèèËø∞Á¨¶ÔºâÁöÑfile_operations‰∏∫<code>kvm_chardev_ops</code>„ÄÇËØ•ËÆæÂ§á‰ªÖÊîØÊåÅioctlÁ≥ªÁªüË∞ÉÁî®ÔºåÂÖ∂‰∏≠ÊúÄÈáçË¶ÅÁöÑ‰æøÊòØ <code>ioctl(KVM_CREATE_VM)</code> „ÄÇKVMÊ®°ÂùóÊé•Êî∂ËØ•Á≥ªÁªüË∞ÉÁî®Êó∂Â∞Ü‰ºöÂàõÂª∫ËôöÊãüÊú∫„ÄÇ<code>kvm_chardev_ops</code> ÂÆö‰πâÂèäÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221652808.png" alt="image-20231122165153904" style="zoom:33%;" />
<p>ÂÆûÈôÖ‰∏äÔºåKVMÊ®°ÂùóÂàùÂßãÂåñÊó∂ÔºåÈô§‰∫ÜÂàõÂª∫ËÆæÂ§áÊñá‰ª∂ÔºåËøòÂÅö‰∫ÜËÆ∏Â§ö‰∏éÊû∂ÊûÑÁõ∏ÂÖ≥ÁöÑÂàùÂßãÂåñÂ∑•‰ΩúÔºå‰æãÂ¶ÇÔºö</p>
<ul>
<li><code>kvm_init</code> Êé•Êî∂ÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞vmx_x86_opsÊòØ‰∏Ä‰∏™ÂáΩÊï∞ÊåáÈíàÈõÜÂêàÔºåÂ∞ÅË£Ö‰∫ÜIntel VT-xÁõ∏ÂÖ≥ËôöÊãüÂåñÊìç‰Ωú„ÄÇÂØπ‰∫éAMD-VËÄåË®ÄÔºåKVMÂàôÊèê‰æõ‰∫ÜÂè¶‰∏Ä‰∏™ÂáΩÊï∞ÊåáÈíàÈõÜÂêàsvm_x86_ops„ÄÇKVM‰ºöÊ†πÊçÆÂΩìÂâçÊâÄÂ§ÑÂπ≥Âè∞ÈÄâÊã©Â∞Üvmx_x86_opsÊàñsvm_x86_opsËµãÁªô <code>arch/x86/kvm/x86.c</code> ‰∏≠ÁöÑÂÖ®Â±ÄÂèòÈáèkvm_x86_opsÔºåËøôÊ†∑ÂêéÁª≠ÈÄöÁî®x86ËôöÊãüÂåñÊìç‰ΩúÂèØ‰ª•ÈÄöËøáËøô‰∏ÄÂèòÈáèÁöÑÁõ∏Â∫îÊàêÂëòË∞ÉÁî® <code>arch/x86/kvm/vmx.c</code> ‰∏≠ÁöÑÁõ∏Â∫îÂáΩÊï∞„ÄÇkvm_x86_opsÁöÑËÆæÁΩÆÂ∑•‰ΩúÁî± <code>kvm_arch_init</code> ÂáΩÊï∞ÂÆåÊàê„ÄÇ</li>
<li>Ê≠§Â§ñÔºå<code>kvm_init</code> ÂáΩÊï∞ËøòË∞ÉÁî®‰∫Ü <code>kvm_hardware_setup</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî® <code>arch/86/kvm/vmx.c</code> ‰∏≠ÁöÑ <code>hardware_setup</code> ÂáΩÊï∞ÂÆåÊàêËôöÊãüÂåñÁ°¨‰ª∂ÁöÑÂàùÂßãÂåñÂ∑•‰ΩúÔºåËøô‰∏éIntel VT-xËôöÊãüÂåñÁ°¨‰ª∂ÊîØÊåÅÂØÜÂàáÁõ∏ÂÖ≥„ÄÇÈÉ®ÂàÜ <code>hardware_setup</code> ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ul>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221652601.png" alt="image-20231122165229572" style="zoom:33%;" />
<ol>
<li><code>setup_vmcs_config</code> ÂáΩÊï∞ËØªÂèñÁâ©ÁêÜCPU‰∏≠‰∏éVMXÁõ∏ÂÖ≥ÁöÑMSRÔºàÁâπÊÆäÊ®°ÂùóÂØÑÂ≠òÂô®ÔºâÔºåÊ£ÄÊµãÁâ©ÁêÜCPUÂØπVMXÁöÑÊîØÊåÅËÉΩÂäõÔºåÁîüÊàê‰∏Ä‰∏™ <code>vmcs_config</code> ÁªìÊûÑÔºåÂêéÁª≠Â∞ÜÊ†πÊçÆ <code>vmcs_config</code> ËÆæÁΩÆVMCSÊéßÂà∂ÂüüÔºõ</li>
<li>ËÄåÂêé <code>hardware_setup</code> ÂáΩÊï∞Ë∞ÉÁî® <code>cpu_has_vmx_ept</code> Á≠âÂáΩÊï∞Âà§Êñ≠CPUÊòØÂê¶ÊîØÊåÅEPTÔºåËã•‰∏çÊîØÊåÅÔºåÂàôÂ∞ÜÂÖ®Â±ÄÂèòÈáè <code>enable_ept</code> ÁΩÆ0„ÄÇ</li>
<li><code>alloc_kvm_area</code> ÂáΩÊï∞Âàô‰ºöË∞ÉÁî® <code>alloc_vmcs_cpu</code> ÂáΩÊï∞**‰∏∫ÊØè‰∏Ä‰∏™Áâ©ÁêÜCPUÂàÜÈÖç‰∏Ä‰∏™4KBÂ§ßÂ∞èÁöÑÂå∫Âüü‰Ωú‰∏∫VMXONÂå∫Âüü„ÄÇ**Intel SDMÊåáÂá∫ÊâßË°åVMXONÊåá‰ª§ÈúÄË¶ÅÊèê‰æõ‰∏Ä‰∏™4KBÂØπÈΩêÁöÑÂÜÖÂ≠òÂå∫Èó¥ÔºåÂç≥VMXONÂå∫Âüü„ÄÇVMXONÂå∫ÂüüÁöÑÁâ©ÁêÜÂú∞ÂùÄÂêéÁª≠Â∞Ü‰Ωú‰∏∫VMXONÊåá‰ª§ÁöÑÊìç‰ΩúÊï∞„ÄÇ</li>
</ol>
<h2 id="32-ËôöÊãüÊú∫ÂàõÂª∫">3.2 ËôöÊãüÊú∫ÂàõÂª∫
</h2><p>ËôöÊãüÊú∫ÁöÑÂàõÂª∫Âßã‰∫é <code>kvm_init</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Áî±QEMUË∞ÉÁî® <code>TYPE_KVM_ACCEL</code> Á±ªÂûãQOMÔºàQEMU Object ModelÔºåQEMUÂØπË±°Ê®°ÂûãÔºâÂØπË±°ÁöÑ<code>init_machine</code> ÊàêÂëòÊù•Ë∞ÉÁî®„ÄÇÁî±‰∫éÁØáÂπÖÊúâÈôêÔºåËøôÈáå‰∏çÂÜçËØ¶Ëø∞Ôºå‰ªÖÁîªÂá∫Áõ∏ÂÖ≥ÂáΩÊï∞Ë∞ÉÁî®ÊµÅÁ®ãÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221654322.png" alt="image-20231122165335748" style="zoom: 33%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†QEMUËøõË°åioctlÁ≥ªÁªüË∞ÉÁî®„ÄÇ</p>
</blockquote>
<p>KVMÊ®°ÂùóÂàùÂßãÂåñÂêéÔºå<code>kvm_init</code> ÂáΩÊï∞‰æøÂèØ‰ª•ÈÄöËøáÂâçËø∞ <code>/dev/kvm</code> ËÆæÂ§áÊñá‰ª∂ÂèëËµ∑ <code>ioctl(KVM_CREATE_VM)</code> ÔºåËØ∑Ê±ÇÂàõÂª∫ËôöÊãüÊú∫ÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/accel/kvm/kvm-all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221657954.png" alt="image-20231122165649008" style="zoom:33%;" />
<p><code>kvm_init</code> ÂáΩÊï∞È¶ñÂÖàÊâìÂºÄ <code>/dev/kvm</code> ËÆæÂ§áÊñá‰ª∂ÔºåÁÑ∂ÂêéÈÄöËøáÁõ∏Â∫îÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑ <code>ioctl(KVM_GET_API_VERSION)</code> Ëé∑ÂèñKVMÊ®°ÂùóÁöÑÊé•Âè£ÁâàÊú¨ÔºåÊ£ÄÈ™å‰∏éQEMUÊîØÊåÅÁöÑKVMÁâàÊú¨ÊòØÂê¶Áõ∏Á≠â„ÄÇÈöèÂêé <code>kvm_init</code> ÂáΩÊï∞ÂèëËµ∑ <code>ioctl(KVM_CRETAE_VM)</code> ‰æø‰ºöÈô∑ÂÖ•ÂâçËø∞KVMÊ®°Âùó‰∏≠ÁöÑ <code>kvm_dev_ioctl</code> ÂáΩÊï∞ËøõË°åÂ§ÑÁêÜ„ÄÇËØ•ÂáΩÊï∞Ê†πÊçÆioctlÁ±ªÂûãË∞ÉÁî® <code>kvm_dev_ioctl_create_vm</code> ÂáΩÊï∞ÂàõÂª∫ËôöÊãüÊú∫ÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/virt/kvm/kvm-main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221657561.png" alt="image-20231122165730289" style="zoom:33%;" />
<p><code>kvm_dev_ioctl_create_vm</code> È¶ñÂÖàË∞ÉÁî® <code>kvm_create_vm</code> ÂáΩÊï∞ÂàõÂª∫ËôöÊãüÊú∫ÂØπÂ∫îÁöÑÁªìÊûÑ‰ΩìÔºåÁÑ∂ÂêéË∞ÉÁî® <code>anon_inode_getfd</code> ÂáΩÊï∞‰∏∫ËôöÊãüÊú∫ÂàõÂª∫‰∏Ä‰∏™ÂåøÂêçÊñá‰ª∂ÔºåÂØπÂ∫îÁöÑfile_operations‰∏∫ <code>kvm_vm_fops</code>ÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221658885.png" alt="image-20231122165809892" style="zoom:33%;" />
<p>Ëøô‰∏™Êñá‰ª∂‰∏∫QEMUÊèê‰æõ‰∫ÜËôöÊãüÊú∫Â±ÇÁ∫ßÁöÑAPIÔºåÂ¶ÇÂàõÂª∫vCPU„ÄÅÂàõÂª∫ËÆæÂ§áÁ≠â„ÄÇKVMÊúÄÁªà‰ºöÂ∞ÜËØ•Êñá‰ª∂ÁöÑÊñá‰ª∂Âè•ÊüÑ‰Ωú‰∏∫ËøîÂõûÂÄºËøîÂõûÁªôQEMU‰æõÂÖ∂‰ΩøÁî®„ÄÇ</p>
<hr>
<p><code>kvm_create_vm</code> ÂáΩÊï∞Èô§‰∫ÜÂàõÂª∫ËôöÊãüÊú∫ÂØπÂ∫îÁöÑÁªìÊûÑ‰Ωì‰ª•Â§ñÔºåËøò‰ºöË∞ÉÁî® <code>hardware_enable_all</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÊúÄÁªà‰ºöÂú®ÊâÄÊúâÁöÑÁâ©ÁêÜCPU‰∏äË∞ÉÁî®<code>hardware_enable_nolock</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÊúÄÁªà‰ºöÈÄöËøáÂâçËø∞kvm_x86_opsÁöÑ <code>hardware_enable</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>hardware_enable</code> ÂáΩÊï∞<strong>‰ΩøËÉΩVMXÊìç‰ΩúÊ®°Âºè„ÄÇ</strong></p>
<p><code>hardware_enable</code> ÂáΩÊï∞Â∞ÜËé∑Âèñ‰∏∫ÊØè‰∏™CPUÂàÜÈÖçÁöÑVMXONÂå∫ÂüüÁöÑÁâ©ÁêÜÂú∞ÂùÄ‰Ωú‰∏∫ÂèÇÊï∞‰º†ÂÖ• <code>kvm_vcpu_vmxon</code> ÂáΩÊï∞„ÄÇ<code>kvm_vcpu_vmxon</code> ÂáΩÊï∞‰ºö**ËÆæÁΩÆCR4ÂØÑÂ≠òÂô®‰∏≠ÁöÑ <code>VMXE(VMX Enabled)</code> ‰Ωç‰ΩøËÉΩVMXÊìç‰ΩúÊ®°ÂºèÔºåÂπ∂ÊâßË°åVMXONÊåá‰ª§ËøõÂÖ•VMXÊìç‰ΩúÊ®°Âºè„ÄÇ**‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221659758.png" alt="image-20231122165859541" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221659507.png" alt="image-20231122165925104" style="zoom:33%;" />
<h2 id="33-vcpuÂàõÂª∫">3.3 vCPUÂàõÂª∫
</h2><p>ËôöÊãüÊú∫ÂàõÂª∫ÂÆåÊàêÂêéÔºåQEMU‰æøÂèØ‰ª•ÈÄöËøáÂâçËø∞ËôöÊãüÊú∫Êñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑Á≥ªÁªüË∞ÉÁî®ÔºåËØ∑Ê±ÇKVMÂàõÂª∫vCPUÔºåÂÆåÊï¥ÁöÑÂàõÂª∫ÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221700826.png" alt="image-20231122170030586" style="zoom:33%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†QEMUËøõË°åioctlÁ≥ªÁªüË∞ÉÁî®„ÄÇ</p>
</blockquote>
<p>Âú®QEMU/KVM‰∏≠ÔºåÊØè‰∏™vCPUÂØπÂ∫îÂÆø‰∏ªÊú∫Êìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑ‰∏Ä‰∏™Á∫øÁ®ãÔºåÁî±QEMUÂàõÂª∫ÔºåÂÖ∂ÊâßË°åÂáΩÊï∞‰∏∫ <code>qemu_kvm_cpu_thread_fn</code>ÔºåËØ•ÂáΩÊï∞Â∞ÜË∞ÉÁî®<code>kvm_init_vcpu</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>kvm_get_vcpu</code> ÂáΩÊï∞ÂèëËµ∑ <code>ioctl(KVM_CREATE_VCPU)</code>ÔºåÂÖ∂‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/accel/kvm/kvm_all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221701940.png" alt="image-20231122170141404" style="zoom:33%;" />
<p>ÂêåËôöÊãüÊú∫ÂàõÂª∫‰∏ÄÊ†∑ÔºåKVM‰ºö‰∏∫ÊØè‰∏™vCPUÂàõÂª∫‰∏Ä‰∏™vCPUÊñá‰ª∂ÊèèËø∞Á¨¶ËøîÂõûÁªôQEMUÔºåÁÑ∂ÂêéQEMUÂèëËµ∑ <code>ioctl(KVM_GET_VCPU_MMAP_SIZE)</code> Êü•ÁúãQEMU‰∏éKVMÂÖ±‰∫´ÂÜÖÂ≠òÁ©∫Èó¥ÁöÑÂ§ßÂ∞è„ÄÇ</p>
<p>ÂÖ∂‰∏≠ÂÖ±‰∫´ÂÜÖÂ≠òÁ©∫Èó¥ÁöÑÁ¨¨‰∏Ä‰∏™È°µÂ∞ÜË¢´Êò†Â∞ÑÂà∞KVM vCPUÁªìÊûÑ‰Ωì <code>struct kvm_vcpu</code> ÁöÑrunÊàêÂëòÔºåËØ•ÊàêÂëòÂ∞Ü‰øùÂ≠ò‰∏Ä‰∫õVM-ExitÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂ¶ÇVM-ExitÁöÑÂéüÂõ†‰ª•ÂèäÈÉ®ÂàÜËôöÊãüÊú∫ÂØÑÂ≠òÂô®Áä∂ÊÄÅÁ≠âÔºå‰æø‰∫éQEMUÂ§ÑÁêÜVM-Exit„ÄÇ<code>kvm_init_vcpu</code> ÂáΩÊï∞ÁÑ∂ÂêéË∞ÉÁî® <code>mmap</code> ÂáΩÊï∞Â∞ÜÂÖ∂Êò†Â∞ÑÂà∞QEMUÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰∏≠„ÄÇ</p>
<hr>
<p>Êé•‰∏ãÊù•ÔºåÊàë‰ª¨ÈáçÁÇπÁúãKVM‰∏≠ÁöÑvCPUÂàõÂª∫ÊµÅÁ®ã„ÄÇ</p>
<p>QEMUÂèëËµ∑ <code>ioctl(KVM_CREATE_VCPU)</code> ÂêéÂ∞ÜÈô∑ÂÖ•KVMÊ®°ÂùóËøõË°åÂ§ÑÁêÜÔºåÂ§ÑÁêÜÂáΩÊï∞‰∏∫ <code>kvm_vm_ioctl_create_vcpu</code>„ÄÇ<code>kvm_vm_ioctl_create_vcpu</code>ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kvm_arch_vcpu_create</code> ÂáΩÊï∞ÂàõÂª∫vCPUÂØπÂ∫îÁöÑÁªìÊûÑ‰ΩìÔºåÁÑ∂ÂêéË∞ÉÁî® <code>create_vcpu_fd</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>anon_inode_getfd</code> ‰∏∫vCPUÂàõÂª∫ÂØπÂ∫îÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶ÔºåÂØπÂ∫îÁöÑfile_operations‰∏∫ <code>kvm_vcpu_fops</code>„ÄÇ</p>
<p><code>kvm_vcpu_fops</code> ÂÆö‰πâ‰∫ÜvCPUÊñá‰ª∂ÊèèËø∞Á¨¶ÂØπÂ∫îÁöÑioctlÁ≥ªÁªüË∞ÉÁî®ÁöÑÂ§ÑÁêÜÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞‰∏∫ <code>kvm_vcpu_ioctl</code>„ÄÇ‰∏ªË¶Å‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221702131.png" alt="image-20231122170233676" style="zoom:33%;" />
<p>ÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºå<code>kvm_arch_vcpu_create</code> ÂáΩÊï∞Èô§‰∫ÜÂàõÂª∫vCPUÂØπÂ∫îÁöÑÁªìÊûÑ‰Ωì‰ª•Â§ñÔºåËøòÂÆåÊàê‰∫ÜvCPUÁõ∏Â∫îÁöÑVMCSÂàùÂßãÂåñÂ∑•‰Ωú„ÄÇÂâçÈù¢ÊèêÂà∞<strong>ÊØè‰∏™vCPUÈÉΩÊúâ‰∏Ä‰∏™VMCS‰∏éÂÖ∂ÂØπÂ∫îÔºå‰ΩøÁî®Êó∂ÈúÄË¶ÅÊâßË°å <code>VMPTRLD</code> Êåá‰ª§Â∞ÜÂÖ∂‰∏éÁâ©ÁêÜCPUÁªëÂÆö„ÄÇ</strong></p>
<p><code>kvm_arch_vcpu_create</code> ÂáΩÊï∞ÈÄöËøáÂâçËø∞kvm_x86_opsÁöÑ <code>vcpu_create</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>vmx_create_vcpu</code> ÂáΩÊï∞„ÄÇ<code>vmx_create_vcpu</code> ÂáΩÊï∞Ë∞ÉÁî® <code>alloc_loaded_vmcs</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>alloc_vmcs_cpu</code> ÂáΩÊï∞‰∏∫vCPUÂàÜÈÖçVMCSÁªìÊûÑÔºåÁÑ∂ÂêéË∞ÉÁî® <code>vmx_vcpu_load</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>vmcs_load</code> ÂáΩÊï∞ÊâßË°å <code>VMPTRLD</code> Êåá‰ª§Â∞ÜVMCS‰∏éÂΩìÂâçCPUÁªëÂÆöÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221703658.png" alt="image-20231122170326180" style="zoom:33%;" />
<hr>
<p>ÁªëÂÆö‰πãÂêéÔºå<code>vmx_create_vcpu</code> ÂáΩÊï∞Ë∞ÉÁî® <code>vmx_vcpu_setup</code> ÂáΩÊï∞ÈÄöËøáËã•Âπ≤ <code>vmcs_write16/vmcs_write32/vmcs_write64</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî®<code>__vmcs_writel</code> ÂáΩÊï∞ËÆæÁΩÆVMCS‰∏≠Áõ∏ÂÖ≥ÂüüÁöÑÂÄºÔºåÂ¶ÇÂâçÊâÄËø∞Ôºå<code>vmcs_writexx</code> ÂáΩÊï∞ÊúÄÁªà‰ºöÊâßË°å <code>VMWRITE</code> Êåá‰ª§ÂÜôVMCSÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221704961.png" alt="image-20231122170417429" style="zoom:33%;" />
<p><code>vmcs_setup_config</code> ÂáΩÊï∞‰∏ªË¶ÅËÆæÁΩÆVMCS‰∏≠ÊéßÂà∂ÂüüÁöÑÂÄºÔºåÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüüÂíåÂÆø‰∏ªÊú∫Áä∂ÊÄÅÂüüÁöÑÂàùÂßãÂåñÂ∑•‰ΩúÂàôÁî± <code>kvm_vm_ioctl_create_vcpu</code> ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_arch_vcpu_setup</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>kvm_vcpu_reset</code> ÂáΩÊï∞ÂÆåÊàê„ÄÇ<code>kvm_vcpu_reset</code> ÂáΩÊï∞ÈÄöËøákvm_x86_opsÁöÑ <code>vcpu_reset</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>vmx_vcpu_reset</code> ÂáΩÊï∞ÂÆåÊàêÔºåÈÉ®ÂàÜ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221705749.png" alt="image-20231122170513125" style="zoom:33%;" />
<p>Ê†πÊçÆ‰∏äËø∞‰ª£Á†ÅÔºåKVM‰ºöË∞ÉÁî® <code>vmcs_writel</code> ÂáΩÊï∞Â∞ÜVMCS‰∏≠ÂÆ¢Êà∑Êú∫ÁöÑ‰ª£Á†ÅÊÆµÂØÑÂ≠òÂô® <code>GUEST_CS_SELECTOR</code> ËÆæÁΩÆ‰∏∫0xf000ÔºåÂ∞Ü‰ª£Á†ÅÊÆµÂü∫Âú∞ÂùÄ<code>GUEST_CS_BASE</code> ËÆæÁΩÆ‰∏∫0xffff0000„ÄÇËÄå <code>kvm_rip_write</code> ÂáΩÊï∞Âàô‰ºöÂ∞ÜKVMÊ®°ÊãüÁöÑËôöÊãü <code>RIP</code>ÔºàReturn Instruction PointerÔºåËøîÂõûÊåá‰ª§ÊåáÈíàÔºâÂØÑÂ≠òÂô®ËÆæ‰∏∫0xfff0ÔºåÂΩìÂêéÁª≠Ë∞ÉÁî® <code>vmx_vcpu_run</code> ÂáΩÊï∞ËøêË°åvCPUÊó∂ÔºåËØ•ÂáΩÊï∞‰ºöÂ∞ÜÊ®°ÊãüÁöÑ <code>RIP</code> ÂØÑÂ≠òÂô®ÂÄºÂÜôÂÖ•VMCS‰∏≠ÔºåÈÉ®ÂàÜ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221706680.png" alt="image-20231122170637463" style="zoom:33%;" />
<p>Ëøô‰∏éIntel x86Êû∂ÊûÑÁ°¨‰ª∂Ë¶ÅÊ±ÇÁõ∏Á¨¶„ÄÇÂú®Intel x86Êû∂ÊûÑ‰∏ãÔºåËÆ°ÁÆóÊú∫Âä†ÁîµÂêé‰ºöÂ∞Ü <code>CS</code>ÔºàCode SegmentÔºå‰ª£Á†ÅÊÆµÔºâÂØÑÂ≠òÂô®ËÆæÁΩÆ‰∏∫0xf000Ôºå<code>RIP</code> ÂØÑÂ≠òÂô®ËÆæÁΩÆ‰∏∫0xfff0ÔºåËÄåCSÂØÑÂ≠òÂô®‰∏≠ÈöêÂê´ÁöÑ‰ª£Á†ÅÊÆµÂü∫Âú∞ÂùÄÂàôËÆæÁΩÆ‰∏∫ <code>0xffff0000</code>ÔºåËøôÊ†∑ÂΩìÁ®ãÂ∫èÂêØÂä®Êó∂ÔºåÊâßË°åÁöÑÁ¨¨‰∏ÄÊù°Êåá‰ª§‰Ωç‰∫é0xfffffff0Â§Ñ <code>CS_BASE+RIP</code>„ÄÇ</p>
<p>ÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºåËøôÈáåKVM‰ªÖ‰ªÖÊòØÂØπVMCS‰∏≠ÁöÑÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüüËøõË°åÂàùÂßãÂåñÔºåQEMU‰ªçÂèØ‰ª•ÈÄöËøá <code>KVM API</code> ËÆæÁΩÆVMCSÂÆ¢Êà∑Êú∫Áä∂ÊÄÅÂüü„ÄÇQEMUÂú®Ë∞ÉÁî®<code>kvm_cpu_exec</code> ÂáΩÊï∞ËøêË°åËôöÊãüÊú∫‰ª£Á†ÅÂâçÔºåÈ¶ñÂÖàË∞ÉÁî® <code>kvm_arch_put_registers</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>kvm_getput_regs</code> ÂáΩÊï∞Âíå <code>kvm_put_sregs</code> ÂáΩÊï∞ÔºåÈÄöËøáÂâçËø∞vCPUËÆæÂ§áÊñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑ <code>ioctl(KVM_SET_REGS)</code> Âíå <code>ioctl(KVM_SET_SREGS)</code> ÔºåÂàÜÂà´ËÆæÁΩÆvCPUÈÄöÁî®ÂØÑÂ≠òÂô®ÂíåÊÆµÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåKVM‰ºöËøõËÄåÂ∞ÜQEMU‰º†ÂÖ•ÁöÑÂØÑÂ≠òÂô®ÂÄºÂÜôÂÖ•VMCS‰∏≠„ÄÇÂÖ∑‰ΩìÂØÑÂ≠òÂô®ÁöÑÂÄºÂàôÁî± <code>x86_cpu_reset</code> ÂáΩÊï∞ÊåáÂÆöÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/target/i386/cpu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221707341.png" alt="image-20231122170749577" style="zoom:33%;" />
<p><code>qemu-4.1.1/target/i386/kvm.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221710028.png" alt="image-20231122171005785" style="zoom:33%;" />
<p>Ê†πÊçÆ‰∏äËø∞‰ª£Á†ÅÔºåQEMU‰º†ÂÖ•ÁöÑ <code>CS</code> Âíå <code>RIP</code> ÂØÑÂ≠òÂô®ÁöÑÂÄº‰∏éÈªòËÆ§VMCSÁõ∏Â∫îÂüüÁöÑËÆæÁΩÆÁõ∏ÂêåÔºö<code>CS=0xf000</code>Ôºå<code>RIP=0xfff0</code>Ôºå<code>CS_BASE=0xffff0000</code>„ÄÇ</p>
<hr>
<p>ËøôÈáåÈÄöËøá‰∏Ä‰∏™Â∞èÂÆûÈ™åÈ™åËØÅ‰∏äËø∞‰ª£Á†ÅÁöÑÊúâÊïàÊÄß„ÄÇQEMUÊèê‰æõ‰∫Ü- <code>s</code> Âíå <code>-S</code> ÈÄâÈ°πÂÖÅËÆ∏GDBËøúÁ®ãËøûÊé•Ë∞ÉËØïÂÜÖÊ†∏ÔºåÂÖ∂‰∏≠ <code>-s</code> ÈÄâÈ°π‰ΩøÂæóQEMUÁ≠âÂæÖÊù•Ëá™1234Á´ØÂè£ÁöÑTCPËøûÊé•Ôºå<code>-S</code> ÈÄâÈ°πÂàô‰ΩøÂæóQEMUÈòªÂ°ûÂÆ¢Êà∑Êú∫ÊâßË°åÔºåÁõ¥Âà∞ËøúÁ®ãËøûÊé•ÁöÑGDBÔºàLinux‰∏ãÂ∏∏Áî®ÁöÑÁ®ãÂ∫èË∞ÉËØïÂô®ÔºâÂÖÅËÆ∏ÂÆÉÁªßÁª≠ÊâßË°åÔºåËøôÂÖÅËÆ∏Áî®Êà∑Êñπ‰æøÂú∞Âú®GDB‰∏≠Êü•ÁúãËôöÊãüÊú∫ËøêË°åËøáÁ®ã‰∏≠Áâ©ÁêÜÂØÑÂ≠òÂô®ÁöÑÁä∂ÊÄÅ„ÄÇ</p>
<p>ÂèØ‰ª•ÊâìÂºÄ‰∏§‰∏™ÁªàÁ´ØÔºåÁªàÁ´Ø1 <code>Terminal 1</code> ÂêØÂä®QEMUÁ≠âÂæÖGDBËøûÊé•ÔºåÁªàÁ´Ø2 <code>Terminal 2</code> ÂàôËøêË°åGDBÈÄöËøá1234Á´ØÂè£ËøúÁ®ãËøûÊé•Ëá≥QEMUÔºåÂëΩ‰ª§Â¶Ç‰∏ãÔºö</p>
<p><code>Terminal 1</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221717185.png" alt="image-20231122171239861" style="zoom:33%;" />
<p><code>Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221829082.png" alt="image-20231122172033861" style="zoom:33%;" />
<p>Ê†πÊçÆ‰∏äËø∞ÂÆûÈ™åÔºåvCPUÂêØÂä®ÂêéÔºå<code>CS</code> ÂØÑÂ≠òÂô®Âíå <code>RIP</code> ÂØÑÂ≠òÂô®ÁöÑÂÄº‰∏éQEMUËÆæÁΩÆÁöÑ‰∏ÄËá¥ÔºåËØ¥ÊòéËôöÊãüÊú∫ÂêØÂä®Êó∂Á°¨‰ª∂‰ºöÂ∞ÜVMCS‰∏≠Áõ∏Â∫îÂüüÂä†ËΩΩÂà∞ÂØÑÂ≠òÂô®‰∏≠„ÄÇ</p>
<p>ËÄå‰∏∫‰∫ÜÂÖºÂÆπÊó©Êúü8086Êû∂ÊûÑÔºåÁ®ãÂ∫èÂêØÂä®ÂêéÔºå<code>0xffff0</code> Âíå <code>0xfffffff0</code> ÂÜÖÂ≠òÂ§ÑÊåá‰ª§‰∏ÄËá¥ÔºåÈÉΩÊòØË∑≥ËΩ¨Ëá≥BIOSËøõË°åÂàùÂßãÂåñÔºåÂä†ËΩΩbootloader„ÄÇÂú®<code>0xfffffff0</code> Â§ÑËÆæÁΩÆÊñ≠ÁÇπÔºåËøêË°åËôöÊãüÊú∫ÂêéÂèëÁé∞Êñ≠ÁÇπË¢´Ëß¶ÂèëÔºõËÄåÂà†ÂéªÊñ≠ÁÇπÂêéÔºåËôöÊãüÊú∫Ê≠£Â∏∏ÂêØÂä®ÔºåËØ¥ÊòéÁ®ãÂ∫èÁöÑÂÖ•Âè£‰Ωç‰∫é <code>0xfffffff0</code> Â§Ñ„ÄÇÊîπÂÜôÂêéÁöÑ<code>x86_cpu_reset</code> ÂáΩÊï∞‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/target/i386/cpu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221720693.png" alt="image-20231122172005657" style="zoom:33%;" />
<p>Â¶Ç‰∏äÊâÄËø∞ÔºåÂ∞ÜCSÂØÑÂ≠òÂô®ËÆæÁΩÆ‰∏∫ <code>0x1234</code>ÔºåÂ∞Ü <code>RIP</code> ÂØÑÂ≠òÂô®ËÆæÁΩÆ‰∏∫ <code>0x5678</code>ÔºåÈáçÊñ∞ÁºñËØëQEMUÂπ∂ËøêË°å‰∏äËø∞‰ª£Á†ÅÔºåÂÆûÈ™åÁªìÊûúÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>Terminal 3</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221830763.png" alt="image-20231122183007439" style="zoom:33%;" />
<p>‰ªéGDBËæìÂá∫ÂèØ‰ª•ÂèëÁé∞‰∏äËø∞ÂØÑÂ≠òÂô®ËÆæÁΩÆÁîüÊïàÔºåÊÑüÂÖ¥Ë∂£ÁöÑËØªËÄÖÂèØ‰ª•Ëá™Ë°å‰øÆÊîπQEMU <code>target/i386/cpu.c</code> ‰∏≠ÁöÑ <code>x86_cpu_reset</code> ÂáΩÊï∞ÔºåÈáçÂ§ç‰∏äËø∞ÂÆûÈ™å„ÄÇ</p>
<hr>
<p>‰ª•‰∏ä‰æøÊòØQEMU/KVM vCPUÂàõÂª∫‰∏éÂàùÂßãÂåñÊµÅÁ®ãÔºå‰∏éËôöÊãüÊú∫ÂàõÂª∫Á±ª‰ººÔºåvCPUÂàõÂª∫ÁöÑËµ∑ÁÇπÂÆûÈôÖ‰∏ä‰Ωç‰∫é <code>TYPE_X86_CPU</code> Á±ªÂûãÁöÑQOMÂØπË±°ÁöÑrealize_fnÊàêÂëò‰∏≠„ÄÇËØ•ÊàêÂëòÂú®CPUÂØπÂ∫îÁöÑQOMÂØπË±°ÂàùÂßãÂåñÊó∂Ë¢´ËÆæÁΩÆ‰∏∫ <code>x86_cpu_realizefn</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Ë∞ÉÁî® <code>qemu_init_vcpu</code> ÂáΩÊï∞ÂàõÂª∫‰∫ÜvCPUÁ∫øÁ®ãÔºåÁ∫øÁ®ãÊâßË°åÂáΩÊï∞‰∏∫ÂâçËø∞ÁöÑ <code>qemu_kvm_cpu_thread_fn</code>„ÄÇ</p>
<h2 id="34-vcpuËøêË°å">3.4 vCPUËøêË°å
</h2><p>Âú®QEMU‰∏≠ÔºåvCPUÁ∫øÁ®ãÂàõÂª∫ÂÆåÊàêÂêéÔºå‰æø‰ºöËøõÂÖ•Âæ™ÁéØÁä∂ÊÄÅÔºåÁ≠âÂà∞Êù°‰ª∂Êª°Ë∂≥Êó∂ÂºÄÂßãËøêË°åËôöÊãüÊú∫‰ª£Á†Å„ÄÇËôöÊãüÊú∫ÊâßË°åÊïèÊÑüÊåá‰ª§ÊàñÊî∂Âà∞Â§ñÈÉ®‰∏≠Êñ≠Êó∂Ôºå‰æø‰ºöËß¶ÂèëVM-ExitÔºåËøõÂÖ•KVMÊ®°ÂùóËøõË°åÂ§ÑÁêÜÔºõÈÉ®ÂàÜËôöÊãüÊú∫ÈÄÄÂá∫Êó∂ÔºåÂàôÈúÄË¶ÅËøõ‰∏ÄÊ≠•ÈÄÄÂá∫Âà∞QEMU‰∏≠ËøõË°åÂ§ÑÁêÜÔºåÂ¶ÇI/OÊ®°Êãü„ÄÇÂ§ÑÁêÜÂÆåÊàêÂêéÔºåÊÅ¢Â§çËôöÊãüÊú∫ËøêË°å„ÄÇvCPUÊï¥‰ΩìËøêË°åÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221826877.png" alt="image-20231122182612556" style="zoom:50%;" />
<p><strong>QEMU/KVM vCPUËøêË°åÂáΩÊï∞Ë∞ÉÁî®ÊµÅÁ®ã</strong>Â¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221828294.png" alt="image-20231122182801479" style="zoom: 50%;" />
<blockquote>
<p>Ê≥®Ôºö‚ë†QEMUËøõË°åioctlÁ≥ªÁªüË∞ÉÁî®ÔºåËøõÂÖ•KVMÔºõ‚ë°‰ªéioctlÁ≥ªÁªüË∞ÉÁî®ËøîÂõû„ÄÇ</p>
</blockquote>
<p>Êé•‰∏ãÊù•ÈÅµÂæ™‰∏äËø∞ÊµÅÁ®ãÊü•ÁúãQEMU/KVM‰∏≠vCPUËøêË°åÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÔºåÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>È¶ñÂÖà <code>qemu_kvm_cpu_thread_fn</code> ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_init_vcpu</code> ÂáΩÊï∞Âú®KVM‰∏≠ÂàõÂª∫vCPUÂØπÂ∫îÁöÑÁªìÊûÑ‰ΩìÔºåÂæóÂà∞Áõ∏Â∫îÁöÑvCPUÊñá‰ª∂ÊèèËø∞Á¨¶Âêé‰æø‰ºöËøõÂÖ•Âæ™ÁéØÔºõ</li>
<li>Âú®Âæ™ÁéØ‰∏≠ÔºåÂÖàÂà§Êñ≠CPUËÉΩÂê¶ËøêË°åÔºåËã•‰∏çËÉΩËøêË°å‰æøË∞ÉÁî® <code>qemu_kvm_wait_io_event</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>qemu_cond_wait</code> ÂáΩÊï∞Á≠âÂæÖ <code>cpu-&gt;halt_cond</code>Ôºõ</li>
<li>ËÄåQEMUÂêéÁª≠Âú® <code>main</code> ÂáΩÊï∞‰∏≠Â∞Ü‰ºöË∞ÉÁî® <code>vm_start</code> ÂáΩÊï∞Áõ¥Ëá≥ÊúÄÁªàË∞ÉÁî® <code>qemu_cond_broadcast</code> ÂáΩÊï∞Âî§ÈÜíÊâÄÊúâÁöÑvCPUÁ∫øÁ®ãÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ol>
<p><code>qemu-4.1.1/cpus.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221842899.png" alt="image-20231122184211163" style="zoom:33%;" />
<p>vCPUÁ∫øÁ®ãË¢´Âî§ÈÜíÂêéÂ∞ÜÊâßË°å <code>kvm_cpu_exec</code> ÂáΩÊï∞ËøêË°åvCPU„ÄÇ<code>kvm_cpu_exec</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî®ÂâçËø∞ <code>kvm_arch_put_registers</code> ÂáΩÊï∞ËÆæÁΩÆvCPUÈÄöÁî®ÂØÑÂ≠òÂô®ÂíåÊÆµÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåÁÑ∂ÂêéË∞ÉÁî® <code>kvm_vcpu_ioctl</code> ÈÄöËøávCPUÊñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑ <code>ioctl(KVM_RUN)</code> Ë∞ÉÁî®Èô∑ÂÖ•KVM‰∏≠„ÄÇ</p>
<p>KVM‰∏≠Áõ∏Â∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞‰∏∫ÂâçËø∞ <code>kvm_arch_vcpu_ioctl_run</code>ÔºåËØ•ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>vcpu_load</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÊúÄÁªàÈÄöËøákvm_x86_opsÁöÑ <code>vcpu_load</code> ÊàêÂëòË∞ÉÁî®ÂâçËø∞ <code>vmx_vcpu_load</code> ÂáΩÊï∞ÊâßË°åVMPTRLDÊåá‰ª§ÁªëÂÆöËØ•vCPUÂØπÂ∫îÁöÑVMCSÔºåÁÑ∂ÂêéË∞ÉÁî® <code>vcpu_run</code> ÂáΩÊï∞ËøêË°åvCPU„ÄÇ</p>
<p><code>vcpu_run</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kvm_vcpu_running</code>  ÂáΩÊï∞Âà§Êñ≠ËØ•vCPUËÉΩÂê¶ËøêË°åÔºåËã•ËÉΩËøêË°åÂàôË∞ÉÁî® <code>vcpu_enter_guest</code> ÂáΩÊï∞ÂáÜÂ§áËøõÂÖ•ÈùûÊ†πÊ®°Âºè„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221841875.png" alt="image-20231122183647622" style="zoom:33%;" />
<hr>
<p><code>vcpu_enter_guest</code> ÂáΩÊï∞È¶ñÂÖàÂà§Êñ≠vCPUÊòØÂê¶Â≠òÂú®ÂæÖÂ§ÑÁêÜÁöÑËØ∑Ê±ÇÔºåÂπ∂Ë∞ÉÁî®‰∏ÄÁ≥ªÂàó <code>kvm_check_request</code> ÂáΩÊï∞ÂØπËøô‰∫õËØ∑Ê±ÇËøõË°åÂ§ÑÁêÜ„ÄÇËøô‰∫õËØ∑Ê±ÇÂèØËÉΩÂú®ÂêÑ‰∏™Âú∞ÊñπÂèëÁîüÔºå‰ª•‰∏≠Êñ≠‰∫ã‰ª∂Ê≥®ÂÖ•‰∏∫‰æãÔºåÂΩìËôöÊãüIOAPICÈúÄË¶ÅÊ≥®ÂÖ•‰∏Ä‰∏™ËôöÊãü‰∏≠Êñ≠Êó∂Ôºå‰ºöË∞ÉÁî® <code>kvm_make_request</code> ÂáΩÊï∞ÂèëËµ∑‰∏Ä‰∏™KVM_REQ_EVENTÁ±ªÂûãÁöÑËØ∑Ê±ÇÔºåËÆæÁΩÆ <code>kvm_vcpu</code> ÁªìÊûÑ‰∏≠ÁöÑrequestsÊàêÂëòÂØπÂ∫îÁöÑ‰ΩçÔºåÂπ∂Âú® <code>vcpu_enter_guest</code> ÂáΩÊï∞‰∏≠ËøõË°åÂ§ÑÁêÜ„ÄÇ<code>vcpu_enter_guest</code> ÂáΩÊï∞Ê£ÄÊü•requestsÂèëÁé∞ÊúâKVM_REQ_EVENTÁ±ªÂûãÁöÑËØ∑Ê±ÇÔºåÂàôË∞ÉÁî® <code>inject_pending_event</code> ÂáΩÊï∞Ê≥®ÂÖ•Áõ∏Â∫î‰∫ã‰ª∂ÔºåÂêéÁª≠‰∏≠Êñ≠ËôöÊãüÂåñÈÉ®ÂàÜÂ∞ÜËØ¶Ëø∞ËØ•ÊµÅÁ®ã„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221841672.png" alt="image-20231122183735630" style="zoom:33%;" />
<p>ÈòªÂ°ûËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÊàêÂêéÔºå<code>vcpu_enter_guest</code> ÂáΩÊï∞ÈÄöËøákvm_x86_opsÁöÑ <code>prepare_guest_switch</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ<code>vmx_prepare_switch_to_guest</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Â∞ÜÈÉ®ÂàÜÂÆø‰∏ªÊú∫ÁöÑÁä∂ÊÄÅ‰øùÂ≠òÂà∞VMCS‰∏é <code>host_state</code> ‰∏≠ÔºåÂ¶Ç <code>FS/GS</code> Áõ∏Â∫îÁöÑÊÆµÈÄâÊã©Â≠êÂíåÊÆµÂú∞ÂùÄÁ≠â„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221841427.png" alt="image-20231122183902417" style="zoom:33%;" />
<p>ÁÑ∂Âêé <code>vcpu_enter_guest</code> ÂáΩÊï∞ÈÄöËøákvm_x86_opsÁöÑrunÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>vmx_vcpu_run</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ÈÄöËøá‰∏ÄÁ≥ªÂàóÂÜÖËÅîÊ±áÁºñÊåá‰ª§‰øùÂ≠òÂÆø‰∏ªÊú∫ÈÄöÁî®ÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåÂπ∂Âä†ËΩΩÂÆ¢Êà∑Êú∫ÈÄöÁî®ÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåÁÑ∂Âêé**Ë∞ÉÁî® <code>VMLAUNCH/VMRESUME</code> Êåá‰ª§ËøõÂÖ•ÈùûÊ†πÊ®°ÂºèÊâßË°åËôöÊãüÊú∫‰ª£Á†Å„ÄÇ**ÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221844541.png" alt="image-20231122184318049" style="zoom:33%;" />
<hr>
<p>ÂΩìvCPUÂèëÁîüVM-ExitÊó∂Ôºå<code>vmx_vcpu_run</code> ÂáΩÊï∞‰øùÂ≠òËôöÊãüÊú∫ÈÄöÁî®ÂØÑÂ≠òÂô®ÁöÑÂÄºÂπ∂‰ªéVMCS‰∏≠ËØªÂèñËôöÊãüÊú∫ÈÄÄÂá∫ÂéüÂõ†‰øùÂ≠òËá≥ <code>vmx-&gt;exit_reason</code> ‰∏≠ÔºåÁÑ∂ÂêéËøîÂõûËá≥ <code>vcpu_enter_guest</code> ÂáΩÊï∞„ÄÇ</p>
<p><code>vcpu_enter_guest</code> ÂáΩÊï∞ÈÄöËøákvm_x86_opsÁöÑ <code>handle_exit</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>vmx_handle_exit</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Ê†πÊçÆÂâçÈù¢ÁöÑ <code>vmx-&gt;exit_reason</code> Ë∞ÉÁî®ÂÖ®Â±ÄÊï∞ÁªÑ <code>kvm_vmx_exit_handlers</code> ‰∏≠ÂØπÂ∫îÁöÑËôöÊãüÊú∫ÈÄÄÂá∫Â§ÑÁêÜÂáΩÊï∞„ÄÇ</p>
<blockquote>
<p>ÂØπ‰∫éÁî±I/OÊåá‰ª§Ëß¶ÂèëÁöÑEXIT_REASON_IO_INSTRUCTIONÁ±ªÂûãÁöÑVM-ExitÔºåÂÆÉÂØπÂ∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞ <code>handle_io</code> ÊúÄÁªàË∞ÉÁî® <code>emulator_pio_in_out</code> ÂáΩÊï∞ËøõË°åÂ§ÑÁêÜ„ÄÇ</p>
</blockquote>
<p><code>emulator_pio_in_out</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kernel_pio</code> ÂáΩÊï∞Â∞ùËØïÂú®KVM‰∏≠Â§ÑÁêÜËØ•PIOËØ∑Ê±ÇÔºåËã•KVMÊó†Ê≥ïÂ§ÑÁêÜÔºåÂÆÉÂ∞Ü <code>vcpu-&gt;run-&gt;exit_reason</code> ËÆæÁΩÆ‰∏∫KVM_EXIT_IOÂπ∂ÊúÄÁªàËøîÂõû0ÔºåËøôÂØºËá¥ <code>vcpu_run</code> ÈÄÄÂá∫Âæ™ÁéØÂπ∂ËøîÂõûËá≥QEMU‰∏≠ËøõË°åÂ§ÑÁêÜ„ÄÇÂâçÈù¢ÊèêÂà∞vCPU‰∏≠ÁöÑrunÊàêÂëò‰∏ªË¶Å‰øùÂ≠òVM-ExitÁõ∏ÂÖ≥‰ø°ÊÅØÂπ∂ÈÄöËøá <code>mmap</code> ‰∏éQEMUÂÖ±‰∫´ÔºåÊïÖÈÄÄÂá∫Ëá≥QEMUÂêéÔºåQEMUÂ∞ÜËØªÂèñ <code>kvm_run</code> ÁªìÊûÑ‰∏≠ÁöÑexit_reasonÊàêÂëòÔºåÊ†πÊçÆÂÖ∂ÈÄÄÂá∫ÂéüÂõ†ËøõË°åËøõ‰∏ÄÊ≠•Â§ÑÁêÜ„ÄÇÂÖ∑‰Ωì‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221844097.png" alt="image-20231122184400824" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221845970.png" alt="image-20231122184457895" style="zoom:33%;" />
<h2 id="35-ÂÆûÈ™å-cpuËôöÊãüÂåñÂÆû‰æã">3.5 ÂÆûÈ™å: CPUËôöÊãüÂåñÂÆû‰æã
</h2><p>ÂâçÂá†ËäÇ‰ªéÊ∫êÁ†ÅÂ±ÇÁ∫ßÂàÜÊûê‰∫ÜQEMU/KVM CPUËôöÊãüÂåñÁöÑÂÆåÊï¥ÊµÅÁ®ãÔºå‰∏çÈöæÂèëÁé∞Â§ßÈÉ®ÂàÜÂ∑•‰ΩúÈÉΩÁî±KVMÂÆåÊàêÔºåQEMU‰∏ªË¶ÅË¥üË¥£Áª¥Êä§ËôöÊãüÊú∫ÂíåvCPUÊ®°ÂûãÔºåÂπ∂ÈÄöËøáKVMÊ®°ÂùóÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÅËôöÊãüÊú∫Êñá‰ª∂ÊèèËø∞Á¨¶ÂíåvCPUÊñá‰ª∂ÊèèËø∞Á¨¶Ë∞ÉÁî®KVM APIÊé•Âè£ÔºåÊú¨ËäÇÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Á±ª‰ºº‰∫éQEMUÁöÑÂ∞èÁ®ãÂ∫èÔºåÊâßË°åÊåáÂÆö‰∫åËøõÂà∂‰ª£Á†ÅËæìÂá∫ <code>HelloÔºåWorld!</code>„ÄÇ‰∏ªË¶Å‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>sample-qemu.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221901266.png" alt="image-20231122190102707" style="zoom:33%;" />
<p>‰ª£Á†ÅÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>ÈÄöËøáÂâçÈù¢ÊâÄËø∞ÁöÑËã•Âπ≤ioctlË∞ÉÁî®ÂàõÂª∫Âπ∂ËøêË°åvCPUÔºåÂ∞ÜvCPUËµ∑ÂßãÊåá‰ª§Âú∞ÂùÄËÆæÁΩÆ‰∏∫ <code>0x1000(GPA)</code>ÔºåÂπ∂Â∞ÜÊåáÂÆöÁöÑ‰∫åËøõÂà∂‰ª£Á†ÅÂ§çÂà∂Âà∞Áõ∏Â∫îÁöÑÂÜÖÂ≠ò‰ΩçÁΩÆ(HVA)Ôºõ</li>
<li>‰∫åËøõÂà∂‰ª£Á†ÅÂ∞Ü‰æùÊ¨°Ë∞ÉÁî®OUTÊåá‰ª§Âêë <code>0x3f8</code> Á´ØÂè£ÂÜôÂÖ• <code>HelloÔºåWorld!</code> ÂåÖÂê´ÁöÑÂêÑ‰∏™Â≠óÁ¨¶ÔºåËß¶Âèë <code>EXIT_REASON_IO_INSTRUCTION</code> Á±ªÂûãÁöÑVM-ExitÔºåËøô‰ΩøÂæóÁ®ãÂ∫èÈÄÄÂõûÂà∞Áî®Êà∑ÊÄÅËøõË°åÂ§ÑÁêÜÔºåÁî®Êà∑ÊÄÅÁ®ãÂ∫èË∞ÉÁî® <code>putchar</code> ÂáΩÊï∞ËæìÂá∫ÂØπÂ∫îÂ≠óÁ¨¶Ôºõ</li>
<li>‰∫åËøõÂà∂‰ª£Á†ÅÊúÄÁªàÊâßË°å <code>hlt</code> Êåá‰ª§Ëß¶ÂèëVM-ExitÔºåÁ≥ªÁªüÂõûÂà∞Áî®Êà∑ÊÄÅÂπ∂ÈÄÄÂá∫Â∫îÁî®Á®ãÂ∫è„ÄÇ</li>
</ol>
<h1 id="4-qemukvm-‰∏≠Êñ≠ËôöÊãüÂåñÂÆûÁé∞">4 QEMU/KVM ‰∏≠Êñ≠ËôöÊãüÂåñÂÆûÁé∞
</h1><p>Êú¨ËäÇÂ∞ÜÁªìÂêàQEMU/KVMÊ∫êÁ†Å‰ªãÁªç‰∏≠Êñ≠ËôöÊãüÂåñÁöÑÂÖ∑‰ΩìÂÆûÁé∞ÔºåÂåÖÊã¨Ôºö</p>
<ul>
<li><strong>PIC‰∏éAPICÁ≠â‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑÊ®°Êãü</strong></li>
<li><strong>ËôöÊãü‰∏≠Êñ≠ÈÄí‰∫§ÊµÅÁ®ãÁöÑÊ®°Êãü</strong></li>
</ul>
<p>Êú¨ËäÇÂú®ÊúÄÂêéÂ∞ÜÈÄöËøáGDBÊü•Áúã‰∏≠Êñ≠‰ªé‰∫ßÁîüÂà∞Ê≥®ÂÖ•ÁöÑÂÆåÊï¥ÊµÅÁ®ã„ÄÇ</p>
<h2 id="41-picioapicÊ®°Êãü">4.1 PIC/IOAPICÊ®°Êãü
</h2><p>QEMUÂíåKVMÈÉΩÂÆûÁé∞‰∫ÜÂØπ‰∏≠Êñ≠ËäØÁâáÁöÑÊ®°ÊãüÔºåËøôÊòØÁî±‰∫éÂéÜÂè≤ÂéüÂõ†ÈÄ†ÊàêÁöÑ„ÄÇÊó©Âú®KVMËØûÁîü‰πãÂâçÔºåQEMUÂ∞±Êèê‰æõÂØπ‰∏ÄÊï¥Â•óËÆæÂ§áÁöÑÊ®°ÊãüÔºåÂåÖÊã¨‰∏≠Êñ≠ËäØÁâá„ÄÇËÄåKVMËØûÁîü‰πãÂêéÔºå‰∏∫‰∫ÜËøõ‰∏ÄÊ≠•ÊèêÈ´ò‰∏≠Êñ≠ÊÄßËÉΩÔºåÂèàÂú®KVM‰∏≠Ê®°Êãü‰∫Ü‰∏ÄÂ•ó‰∏≠Êñ≠ËäØÁâá„ÄÇ</p>
<p>QEMUÊèê‰æõ <code>kernel-irqchip</code> ÂèÇÊï∞ÂÜ≥ÂÆö‰∏≠Êñ≠ËäØÁâáÁî±Ë∞ÅÊ®°ÊãüÔºå<code>kernel-irqchip</code> ÂèÇÊï∞ÂèØÂèñÂÄº‰∏∫Ôºö</p>
<ul>
<li><code>on</code>ÔºöPICÂíåAPIC‰∏≠Êñ≠ËäØÁâáÂùáÁî±KVMÊ®°ÊãüÔºõ</li>
<li><code>off</code>ÔºöPICÂíåAPIC‰∏≠Êñ≠ËäØÁâáÂùáÁî±QEMUÊ®°ÊãüÔºõ</li>
<li><code>split</code>ÔºöPICÂíåIOAPICÁî±QEMUÊ®°ÊãüÔºåLAPICÁî±KVMÊ®°Êãü„ÄÇ</li>
</ul>
<p>Áî±‰∫éKVMÊ®°Êãü‰∏≠Êñ≠ËäØÁâáÊÄßËÉΩÊõ¥È´òÔºåÊïÖÊú¨ËäÇ<strong>‰ª•KVMÊ®°Êãü‰∏≠Êñ≠ËäØÁâá‰∏∫‰æã„ÄÇ</strong></p>
<h3 id="picÊ®°Êãü">PICÊ®°Êãü
</h3><p>ÂΩìQEMUËÆæÁΩÆ <code>kernel-irqchip</code> ÂèÇÊï∞‰∏∫onÊó∂Ôºå‰ºöÂú®ÂâçËø∞ <code>kvm_init</code> ÂáΩÊï∞‰∏≠Ë∞ÉÁî® <code>kvm_irqchip_create</code> ÂáΩÊï∞ÔºåÈÄöËøáËôöÊãüÊú∫Êñá‰ª∂ÊèèËø∞Á¨¶ÂèëËµ∑<code>ioctl(KVM_CREATE_IRQCHIP)</code> Èô∑ÂÖ•KVM‰∏≠„ÄÇKVM‰∏≠Áõ∏Â∫îÂ§ÑÁêÜÂáΩÊï∞ <code>kvm_arch_vm_ioctl</code> Ë∞ÉÁî® <code>kvm_pic_init</code> ÂáΩÊï∞ÂàõÂª∫Âπ∂ÂàùÂßãÂåñPICÁõ∏Â∫îÁöÑÁªìÊûÑ‰Ωì <code>struct kvm_pic</code>ÔºåÂπ∂Â∞ÜÊåáÈíà‰øùÂ≠òÂú® <code>kvm-&gt;arch.vpic</code> ‰∏≠ÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/irq.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221906319.png" alt="image-20231122190606179" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221907374.png" alt="image-20231122190711985" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/i8259.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221907617.png" alt="image-20231122190739192" style="zoom:33%;" />
<p>Ê†πÊçÆ‰∏äËø∞‰ª£Á†ÅÔºåPICÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òÂú®ÁªìÊûÑ‰Ωì <code>struct kvm_kpic_state</code> ‰∏≠ÔºåËØ•ÁªìÊûÑ‰ΩìÂåÖÂê´‰∫ÜÂâçËø∞ <code>IRR</code>„ÄÅ<code>ISR</code> ‰ª•Âèä <code>IMR</code> Á≠âÁöÑÁä∂ÊÄÅ„ÄÇ</p>
<p>Ê≠§Â§ñÔºåÂ¶ÇÂâçÊâÄËø∞ÔºåÈÄöÂ∏∏Â∞Ü‰∏§Âùó8259AËäØÁâáÁ∫ßËÅî‰ª•ÊîØÊåÅÊõ¥Â§öÁöÑ‰∏≠Êñ≠Êù•Ê∫êÔºå<code>kvm_pic</code> Â∞Ü‰∏ªPICÂíå‰ªéPICÁöÑÁä∂ÊÄÅ‰øùÂ≠òÂú® <code>pics</code> ÊàêÂëò‰∏≠Ôºå<code>kvm_pic</code> ÂØπÂ∫îÁöÑÂÜÖÂ≠òÁ©∫Èó¥Áî± <code>kvm_pic_init</code> ÂáΩÊï∞ÂàÜÈÖç„ÄÇ</p>
<p>Èô§‰∫ÜÊ®°ÊãüPICÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºå<code>kvm_pic_init</code> ÂáΩÊï∞ËøòÊèê‰æõCPUÂØπPICËÆøÈóÆÁöÑÊîØÊåÅ„ÄÇCPUÈÄöÂ∏∏ÈÄöËøáPIOÁöÑÊñπÂºèËÆøÈóÆPICÔºå‰∫éÊòØ <code>kvm_pic_init</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kvm_io_device_init</code> ÂáΩÊï∞ÂàùÂßãÂåñ‰∏ªPIC„ÄÅ‰ªéPICÂíåeclr‰∏â‰∏™ËÆæÂ§áÂØπÂ∫îÁöÑËØªÂÜôÊìç‰ΩúÂáΩÊï∞ÔºåÂπ∂Ë∞ÉÁî® <code>kvm_io_bus_register_dev</code> ÂáΩÊï∞Âú®KVM_IO_BUS‰∏äÊ≥®ÂÜå‰∏â‰∏™ËÆæÂ§áÁõ∏Â∫îÁöÑI/OÁ´ØÂè£„ÄÇ</p>
<hr>
<p>ÂΩìCPUÈÄöËøáPIOÁõ∏ÂÖ≥Êåá‰ª§ÔºàIN„ÄÅOUTÁ≠âÔºâÈÄöËøáÊ≥®ÂÜåÁ´ØÂè£ÂØπËÆæÂ§áËøõË°åËØªÂÜôÊó∂ÔºåÂ∞Ü‰ºöËß¶Âèë <code>EXIT_REASON_IO_INSTRUCTION</code> Á±ªÂûãÁöÑVM-ExitÔºåÂÖ∂ÂØπÂ∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞‰∏∫ <code>handle_io</code>„ÄÇ<code>handle_io</code> ÂáΩÊï∞È¶ñÂÖà‰ºöÂà§Êñ≠I/OÊåá‰ª§Á±ªÂûãÊòØÂê¶‰∏∫string I/OÊåá‰ª§ÔºåËã•ÊòØÂàôË∞ÉÁî® <code>kvm_emulate_instruction</code> ÂáΩÊï∞Ê®°ÊãüI/OÊåá‰ª§ÔºåÂê¶ÂàôË∞ÉÁî® <code>kvm_fast_pio</code> ÂáΩÊï∞Â§ÑÁêÜÔºå‰∫åËÄÖÊúÄÂêéÈÉΩ‰ºöË∞ÉÁî® <code>kernel_pio</code> ÂáΩÊï∞„ÄÇ</p>
<p>ÂØπ‰∫éËØª/ÂÜôÁ´ØÂè£Êåá‰ª§Ôºå<code>kernel_pio</code> ÂáΩÊï∞ÂàÜÂà´Ë∞ÉÁî® <code>kvm_io_bus_read/kvm_io_bus_write</code> ÂáΩÊï∞„ÄÇ‰ª•ÂÜôÁ´ØÂè£‰∏∫‰æãÔºå<code>kvm_io_bus_write</code> ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>_kvm_io_bus_write</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞Ê†πÊçÆI/OÁ´ØÂè£‰ªéKVM_IO_BUSÊÄªÁ∫ø‰∏äÊâæÂà∞Áõ∏Â∫îÁöÑËÆæÂ§áÂπ∂Ë∞ÉÁî® <code>kvm_iodevice_write</code> ÂáΩÊï∞ÂÜôÂÖ•ËÆæÂ§áÁ´ØÂè£ÔºåËøô‰ºöËß¶ÂèëÂâçËø∞ËÆæÂ§áÂØπÂ∫îÁöÑËØªÂÜôÊìç‰ΩúÂáΩÊï∞„ÄÇ‰ª•‰∏ªPIC‰∏∫‰æãÔºåÂÖ∂ÂØπÂ∫îÁöÑËØª/ÂÜôÊìç‰ΩúÂáΩÊï∞‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/i8259.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221910505.png" alt="image-20231122191029212" style="zoom:33%;" />
<p><code>linux-4.19.0/include/kvm/iodev.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221910260.png" alt="image-20231122190904382" style="zoom:33%;" />
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221911015.png" alt="image-20231122191049578" style="zoom:33%;" />
<h3 id="ioapicÊ®°Êãü">IOAPICÊ®°Êãü
</h3><p>ÂêåPICÂàõÂª∫Á±ª‰ººÔºåIOAPICÁõ∏Â∫îÁöÑÁªìÊûÑ‰Ωì <code>struct kvm_ioapic</code> Áî± <code>kvm_arch_vm_ioctl</code> ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_ioapic_init</code> ÂáΩÊï∞ÂàõÂª∫Âπ∂ÂàùÂßãÂåñÔºåÂêåÊó∂Â∞Ü<code>kvm_ioapic</code> ÊåáÈíàËµãÁªô <code>kvm-&gt;arch.vioapic</code> „ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/ioapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221912890.png" alt="image-20231122191153907" style="zoom:33%;" />
<blockquote>
<p>ÂØπ‰∫é <code>kvm_ioapic</code> ÁªìÊûÑ‰ΩìËÄåË®ÄÔºåÂÖ∂‰∏≠ÊúÄÈáçË¶ÅÁöÑÊàêÂëò‰∏∫ <code>redirtbl</code>ÔºåËØ•ÊàêÂëòÂØπÂ∫î‰∫éIOAPIC‰∏≠ÁöÑ <code>PRT</code>ÔºàProgrammable Redirection TableÔºåÂèØÁºñÁ®ãÈáçÂÆöÂêëË°®Ôºâ„ÄÇÂ¶ÇÂâçÊâÄËø∞ÔºåÂΩìIOAPICÊüê‰∏™ÂºïËÑöÊî∂Âà∞‰∏≠Êñ≠Êó∂ÔºåÂ∞ÜÊ†πÊçÆËØ•ÂºïËÑöÂØπÂ∫îÁöÑRTEÊ†ºÂºèÂåñÂá∫‰∏ÄÊù°‰∏≠Êñ≠Ê∂àÊÅØÂèëÈÄÅÁªôÊåáÂÆöLAPICÔºåÂêéÁª≠ÁöÑ‰∏≠Êñ≠Ë∑ØÁî±Á´†ËäÇÂ∞ÜËØ¶Ëø∞Ëøô‰∏ÄÊàêÂëòÁöÑ‰ΩúÁî®„ÄÇ</p>
</blockquote>
<p><code>kvm_ioapic</code> ÁªìÊûÑ‰ΩìÂÆö‰πâÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>linux-4.19.0/arch/x86/kvm/ioapic.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221912527.png" alt="image-20231122191234503" style="zoom:33%;" />
<p>‰∏éPIC‰∏çÂêåÁöÑÊòØÔºåCPUÈÄöÂ∏∏ÈÄöËøáMMIOÁöÑÊñπÂºèËÆøÈóÆIOAPICÔºåÊïÖ <code>kvm_ioapic_init</code> ÂáΩÊï∞ÂÖàË∞ÉÁî® <code>kvm_iodevice_init</code> ÂáΩÊï∞ÔºåÂ∞ÜIOAPIC MMIOÂå∫ÂüüËÆøÈóÆÂõûË∞ÉÂáΩÊï∞ËÆæÁΩÆ‰∏∫ <code>ioapic_mmio_ops</code>ÔºåÁÑ∂ÂêéË∞ÉÁî® <code>kvm_io_bus_register_dev</code> ÂáΩÊï∞Âú®KVM_MMIO_BUS‰∏äÊ≥®ÂÜåIOAPIC MMIOÂå∫Âüü„ÄÇIOAPIC MMIOÂå∫ÂüüÁöÑËµ∑ÂßãÂú∞ÂùÄ‰∏∫ <code>0xfec00000</code>ÔºàÁî± <code>kvm_ioapic_reset</code> ÂáΩÊï∞ÊåáÂÆöÔºâÔºåÈïøÂ∫¶‰∏∫ <code>0x100</code>„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/ioapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221913537.png" alt="image-20231122191314308" style="zoom:33%;" />
<p>ÂΩìKVMÈ¶ñÊ¨°ËÆøÈóÆMMIOÂå∫ÂüüÊó∂ÔºåÁî±‰∫éEPT‰∏≠Áº∫‰πèÁõ∏Â∫îÁöÑÊò†Â∞ÑÔºå‰ºöËß¶ÂèëEPT ViolationÁ±ªÂûãÁöÑVM-ExitÔºåKVMÂèëÁé∞ËØ•Âå∫Âüü‰∏∫MMIOÂå∫ÂüüÔºåÂú®‰∏∫ÂÖ∂Âª∫Á´ãÁõ∏Â∫îÁöÑÈ°µË°®È°πÊó∂‰ºöÂ∞ÜËØ•È°µË°®È°πËÆæÁΩÆ‰∏∫ÂèØÂÜôÂèØÊâßË°å‰ΩÜ‰∏çÂèØËØªÔºåËøôÊ†∑Âú®ÂêéÁª≠ËÆøÈóÆËØ•MMIOÂå∫ÂüüÊó∂‰ºöËß¶ÂèëEPTÈÖçÁΩÆÈîôËØØ (EPT Misconfig) Á±ªÂûãÁöÑVM-ExitÔºåÂú®<code>kvm_vmx_exit_handlers</code> ÂáΩÊï∞‰∏≠Áõ∏Â∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞‰∏∫ <code>handle_ept_misconfig</code>„ÄÇ‰∏éPICËÆøÈóÆÁ±ª‰ººÔºå<code>handle_ept_misconfig</code> ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî®<code>x86_emulate_instruction</code> ÂáΩÊï∞ÂØπËØ•Êåá‰ª§ËøõË°åÊ®°Êãü„ÄÇ</p>
<p>Âú®Â§ßÈÉ®ÂàÜÊÉÖÂÜµ‰∏ãÔºåÁî±‰∫éÂ§ñÈÉ®ËÆæÂ§áÁî±QEMUÊ®°ÊãüÔºåÊïÖ <code>x86_emulate_instruction</code> ÂáΩÊï∞Â∞Ü‰ºöËøîÂõûEMULATE_USER_EXITÔºåÂØºËá¥ <code>vcpu_enter_guest</code> ÂáΩÊï∞ËøîÂõûËá≥QEMU‰∏≠Â§ÑÁêÜ„ÄÇ‰ΩÜÂõ†‰∏∫IOAPICÁî±KVMÊ®°ÊãüÔºåÊïÖ <code>x86_emulate_instruction</code> ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî® <code>vcpu_mmio_read/vcpu_mmio_write</code> ÂáΩÊï∞Â§ÑÁêÜÂØπ‰∫éIOAPIC MMIOÂå∫ÂüüÁöÑËØªÂÜô„ÄÇ‰ª• <code>vcpu_mmio_write</code> ÂáΩÊï∞‰∏∫‰æãÔºåÂÆÉÂêåÊ†∑Ë∞ÉÁî®ÂâçËø∞ <code>kvm_io_bus_write</code> ÂáΩÊï∞ÔºåÊ†πÊçÆËÆøÈóÆÁöÑÂÜÖÂ≠òÂú∞ÂùÄÂú®KVM_MMIO_BUSÊâæÂà∞IOAPICÂØπÂ∫îÁöÑËÆæÂ§áÔºåÂπ∂Ë∞ÉÁî®ÂâçÈù¢Ê≥®ÂÜåÁöÑÂÜôÂõûË∞ÉÂáΩÊï∞ <code>ioapic_mmio_write</code>„ÄÇ<code>vcpu_mmio_write</code> ÂáΩÊï∞‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221915231.png" alt="image-20231122191435082" style="zoom:33%;" />
<h3 id="lapicÊ®°Êãü">LAPICÊ®°Êãü
</h3><p>LAPICÂàõÂª∫Ë∑ØÂæÑ‰∏éPICÂíåIOAPIC‰∏çÂêåÔºåÁî±‰∫éLAPIC‰∏évCPU‰∏Ä‰∏ÄÂØπÂ∫îÔºåÊïÖLAPICÂ∞ÜÂú®ÂàõÂª∫vCPUÊó∂ÊûÑÈÄ†ÔºåËøô‰∏ÄÂ∑•‰ΩúÁî±ÂâçËø∞ <code>vmx_create_vcpu</code> ÂáΩÊï∞ÊúÄÁªàË∞ÉÁî® <code>kvm_create_lapic</code> ÂáΩÊï∞ÂÆåÊàê„ÄÇ<code>kvm_create_lapic</code> ÂáΩÊï∞È¶ñÂÖàÂàÜÈÖçLAPICÂú®KVM‰∏≠ÂØπÂ∫îÁöÑÁªìÊûÑ‰Ωì <code>struct kvm_lapic</code>ÔºåÂπ∂Â∞ÜÂÖ∂‰øùÂ≠òÂú® <code>vcpu-&gt;arch.apic</code> ‰∏≠ÔºåÁÑ∂ÂêéÂàÜÈÖçLAPICÂØÑÂ≠òÂô®È°µ‰øùÂ≠òLAPICÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºåÂØÑÂ≠òÂô®È°µÁöÑËµ∑ÂßãÂú∞ÂùÄ‰øùÂ≠òÂú® <code>kvm_lapic</code> ÁöÑregsÊàêÂëò‰∏≠„ÄÇ<code>kvm_lapic</code> ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/lapic.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221915632.png" alt="image-20231122191530103" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/lapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221923286.png" alt="image-20231122191925850" style="zoom:33%;" />
<p>‰∏éIOAPICÁ±ª‰ººÔºåCPU‰πüÈÄöËøáMMIOÁöÑÊñπÂºèËÆøÈóÆLAPIC„ÄÇ‰ΩÜÊòØ**Ê†πÊçÆ‰∏çÂêåÁöÑVM-ExecutionÊéßÂà∂ÂüüËÆæÁΩÆÔºåKVMÂØπ‰∫éLAPIC MMIOÊúâ‰∏âÁßçÂ§ÑÁêÜÊñπÂºèÔºå**ËøôÈáå‰ªç‰ª•ÂÜôMMIOÂå∫Âüü‰∏∫‰æãÔºö</p>
<blockquote>
<p><strong>ËôöÊãüAPICËÆøÈóÆÂ≠óÊÆµ‰∏∫0</strong></p>
</blockquote>
<p>Ê≠§Êó∂LAPIC MMIOÂ§ÑÁêÜÊµÅÁ®ã‰∏éIOAPICÁõ∏ÂêåÔºå‰ΩÜÊòØLAPIC MMIOÂå∫ÂüüÂπ∂Êú™Âú®KVM_MMIO_BUS‰∏äÊ≥®ÂÜå„ÄÇ<code>vcpu_mmio_write</code> ÂáΩÊï∞Ë∞ÉÁî® <code>lapic_in_kernel</code> ÂáΩÊï∞Âà§Êñ≠LAPICÊòØÂê¶Áî±KVMÊ®°ÊãüÔºö</p>
<ul>
<li>Ëã•ÊòØÔºåÂàôÁõ¥Êé•Ë∞ÉÁî® <code>kvm_io_device_write</code> ÂáΩÊï∞Â∞ùËØïÂÜôÂÖ•LAPICÔºåËøôÂ∞Ü‰ºöËß¶Âèë <code>apic_mmio_ops</code> ÂáΩÊï∞‰∏≠ÁöÑ <code>apic_mmio_write</code> ÂõûË∞ÉÂáΩÊï∞Ôºå<code>apic_mmio_write</code> ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>apic_mmio_in_range</code> ÂáΩÊï∞Âà§Êñ≠ËÆøÈóÆÁöÑÂÜÖÂ≠òÂú∞ÂùÄÊòØÂê¶ËêΩÂú®LAPIC MMIOÂå∫Âüü‰∏≠Ôºõ</li>
<li>Ëã•‰∏çÊòØÔºåÂ∞ÜËÆøÈóÆÂú∞ÂùÄÂáèÂéª <code>base_address</code> ÂæóÂà∞ <code>offset</code>ÔºàÂÅèÁßªÂú∞ÂùÄÔºâÔºåÁÑ∂ÂêéÈÄöËøá <code>kvm_lapic_reg_write</code> ÂáΩÊï∞ÂÜôÂÖ•LAPICÁõ∏Â∫îÁöÑÂØÑÂ≠òÂô®‰∏≠„ÄÇ</li>
</ul>
<p><code>apic_mmio_write</code> ÂáΩÊï∞‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/lapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221923374.png" alt="image-20231122191737714" style="zoom:33%;" />
<hr>
<blockquote>
<p><strong>ËôöÊãüAPICËÆøÈóÆÂ≠óÊÆµ‰∏∫1‰∏îËôöÊãüAPICÂØÑÂ≠òÂô®ËôöÊãüÂåñÂ≠óÊÆµ‰∏∫0</strong></p>
</blockquote>
<p>Ê≠§Êó∂ÈÄöËøáMMIOÊñπÂºèËÆøÈóÆLAPICÊó∂Ôºå‰ºöËß¶ÂèëAPICËÆøÈóÆÁ±ªÂûãÁöÑVM-Exit„ÄÇLAPIC MMIOÂå∫ÂüüÁöÑÂú∞ÂùÄÈÄöËøáAPICËÆøÈóÆÂú∞ÂùÄ(APIC Access Address)Â≠óÊÆµÊåáÂÆö„ÄÇ</p>
<p>Âú®ÂâçËø∞vCPUÂàõÂª∫ÊµÅÁ®ã‰∏≠ÔºåÂ∞ÜË∞ÉÁî® <code>vcpu_vmx_reset</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞‰ºöË∞ÉÁî® <code>kvm_make_request</code> ÂáΩÊï∞ÂèëËµ∑‰∏Ä‰∏™ <code>KVM_REQ_APIC_PAGE_RELOAD</code> Á±ªÂûãÁöÑËØ∑Ê±Ç„ÄÇÂêéÁª≠vCPUË∞ÉÁî® <code>vcpu_enter_guest</code> ÂáΩÊï∞ËøêË°åÂâçÔºå‰ºöÊ£ÄÊü•ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜÁöÑËØ∑Ê±Ç„ÄÇ</p>
<p>Ëã•ÊúâÊú™Â§ÑÁêÜÁöÑ <code>KVM_REQ_APIC_PAGE_RELOAD</code> ËØ∑Ê±ÇÔºå<code>vcpu_enter_guest</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>kvm_vcpu_reload_apic_access_page</code> ÂáΩÊï∞Â§ÑÁêÜÔºåËØ•ÂáΩÊï∞ÈÄöËøá <code>kvm_x86_ops</code> ÂáΩÊï∞ÁöÑ <code>set_apic_access_page_addr</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>vmx_set_apic_access_page_addr</code> ÂáΩÊï∞ÔºåÂ∞ÜVMCS APICËÆøÈóÆÂú∞ÂùÄÂ≠óÊÆµËÆæÁΩÆ‰∏∫APIC MMIOÂå∫ÂüüËµ∑ÂßãÂú∞ÂùÄÂØπÂ∫îÁöÑHPA„ÄÇ</p>
<p>ËÄåAPIC AccessÁ±ªÂûãVM-ExitÁöÑÂ§ÑÁêÜÂáΩÊï∞‰∏∫ <code>handle_apic_access</code>ÔºåËØ•ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî® <code>kvm_emulate_instruction</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî®<code>x86_emulate_instruction</code> ÂáΩÊï∞ÔºåÂÆûÈôÖÂ§ÑÁêÜÂáΩÊï∞‰∏é‰∏ä‰∏ÄÁßçÊñπÂºèÁõ∏ÂêåÔºåÂè™ÊòØVM-ExitÁ±ªÂûãÂèò‰∏∫APICËÆøÈóÆ„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221922637.png" alt="image-20231122192044197" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221922157.png" alt="image-20231122192123884" style="zoom:33%;" />
<blockquote>
<p><strong>ËôöÊãüAPICËÆøÈóÆÂ≠óÊÆµ‰∏∫1‰∏îAPICÂØÑÂ≠òÂô®ËôöÊãüÂåñÂ≠óÊÆµ‰∏∫1</strong></p>
</blockquote>
<p>Ê≠§Êó∂CPUÈÄöËøáMMIOËÆøÈóÆLAPICÊó∂‰ºöË¢´ÈáçÂÆöÂêëÂà∞ËôöÊãüAPICÈ°µÔºåËÄå‰∏ç‰ºöËß¶ÂèëVM-Exit„ÄÇÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂè™ÊúâÁâπÂÆöÂØÑÂ≠òÂô®ËÆøÈóÆÂèØËÉΩ‰ºöËß¶ÂèëAPICËÆøÈóÆÊàñAPICÂÜô(APIC Write)ÂºÇÂ∏∏Á±ªÂûãÁöÑVM-ExitÔºåÊ≠§Â§Ñ‰∏çÂÜçËØ¶Ëø∞ÔºåËØªËÄÖÂèØ‰ª•ÂèÇËÄÉIntel SDMÁõ∏ÂÖ≥ËµÑÊñô‰∫ÜËß£Âì™‰∫õAPICÂØÑÂ≠òÂô®ËÆøÈóÆ‰ºöËß¶ÂèëVM-Exit„ÄÇ</p>
<p>ËÄåËôöÊãüAPICÈ°µÂú∞ÂùÄÁî±VMCS‰∏≠ÁöÑËôöÊãüAPICÈ°µÂú∞ÂùÄ (Virtual-APIC Address) Â≠óÊÆµÊåáÂÆöÔºåËøô‰∏ÄÂ∑•‰ΩúÁî±ÂâçËø∞vCPUÂàõÂª∫ÊµÅÁ®ã‰∏≠ÁöÑ <code>vmx_vcpu_reset</code> ÂáΩÊï∞ÂÆåÊàêÔºåËôöÊãüAPICÂú∞ÂùÄÂ≠óÊÆµË¢´ËÆæÁΩÆ‰∏∫ <code>kvm_lapic</code> ‰∏≠ÁöÑregsÊàêÂëòÔºåÂç≥ÂØÑÂ≠òÂô®È°µÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ<code>vmx_vcpu_reset</code> ÂáΩÊï∞‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221922800.png" alt="image-20231122192218756" style="zoom:33%;" />
<h2 id="42-pciËÆæÂ§á‰∏≠Êñ≠">4.2 PCIËÆæÂ§á‰∏≠Êñ≠
</h2><p>Âú®APIC‰∏≠Êñ≠Êû∂ÊûÑ‰∏ãÔºåCPU‰∏≠Êñ≠Êù•Ê∫ê‰∏ªË¶ÅÊúâ‰∏âÁßçÔºö<strong>Êú¨Âú∞‰∏≠Êñ≠„ÄÅÈÄöËøáIOAPICÊé•Êî∂ÁöÑÂ§ñÈÉ®‰∏≠Êñ≠‰ª•ÂèäÂ§ÑÁêÜÂô®Èó¥‰∏≠Êñ≠„ÄÇ</strong></p>
<p>Êú¨ËäÇ‰æßÈáç‰∫é‰ªãÁªçÈÄöËøáIOAPICÊé•Êî∂ÁöÑÂ§ñÈÉ®‰∏≠Êñ≠„ÄÇ‰ΩÜÊòØÁî±‰∫éËäØÁâáÁªÑÁöÑÂ∑ÆÂºÇ‰ª•ÂèäÂ§ñÈÉ®ËÆæÂ§áÁöÑÂ∑ÆÂºÇÔºåËÆæÂ§á‰∫ßÁîüÂíå‰º†ÈÄí‰∏≠Êñ≠ÁöÑÊµÅÁ®ã‰πü‰∏çÂ∞ΩÁõ∏Âêå„ÄÇ‰∏∫‰∫Ü‰∏éÂêéÁª≠ÁöÑÂÆûÈ™åÈÉ®ÂàÜÁõ∏ÁÖßÂ∫îÔºåÊú¨ËäÇ‰∏ªË¶Å‰ªãÁªçÂú® <code>i440FX + PIIX</code> ËäØÁâáÁªÑ‰∏≠PCIËÆæÂ§á‰∏≠Êñ≠Ê®°Êãü„ÄÇ</p>
<blockquote>
<p>4.3ËäÇÂ∞Ü‰ºö‰ªãÁªçQEMUÊ®°ÊãüËÆæÂ§á‰∫ßÁîü‰∏≠Êñ≠ÊòØÂ¶Ç‰Ωï‰º†ÈÄíÁªôKVMÊ®°ÊãüÁöÑAPICÁöÑ„ÄÇ</p>
</blockquote>
<h3 id="pciËÆæÂ§á‰∏≠Êñ≠ÂéüÁêÜ">PCIËÆæÂ§á‰∏≠Êñ≠ÂéüÁêÜ
</h3><p>ËÆ°ÁÆóÊú∫‰∏ªÊùø‰∏äÈÄöÂ∏∏ÊúâÂ§ö‰∏™PCIÊèíÊßΩ‰æõPCIËÆæÂ§á‰ΩøÁî®ÔºåÊèíÂÖ•PCIÊßΩÁöÑPCIÂç°ÈÄöÂ∏∏Áß∞‰∏∫Áâ©ÁêÜPCIËÆæÂ§áÔºåÊØè‰∏™<strong>Áâ©ÁêÜPCIËÆæÂ§á</strong>‰∏äÂèØËÉΩÂ≠òÂú®<strong>Â§ö‰∏™Áã¨Á´ãÁöÑÂäüËÉΩÂçïÂÖÉÔºå<strong>Ëøô‰∫õÂäüËÉΩÂçïÂÖÉ‰πüÁß∞‰∏∫</strong>ÈÄªËæëPCIËÆæÂ§á„ÄÇ<strong>Âõ†Ê≠§</strong>ÈÄªËæëPCIËÆæÂ§áÁöÑÊ†áËØÜÁ¨¶</strong>ÈÄöÂ∏∏ÂåÖÊã¨‰∏âÈÉ®ÂàÜÔºö<strong>ËÆæÂ§áÊâÄÂú®ÁöÑÊÄªÁ∫ø(Bus)Âè∑„ÄÅËÆæÂ§áÊâÄÂú®ÁöÑÁâ©ÁêÜPCIËÆæÂ§á(Device)Âè∑„ÄÅËÆæÂ§áÁöÑÂäüËÉΩ(Function)Âè∑ÔºåÁÆÄÁß∞‰∏∫BDF„ÄÇ</strong></p>
<p>ÊØè‰∏™Áâ©ÁêÜPCIËÆæÂ§áÊúâ4‰∏™‰∏≠Êñ≠ÂºïËÑöÔºö<code>INTA#</code>„ÄÅ<code>INTB#</code>„ÄÅ<code>INTC#</code> Âíå <code>INTD#</code>ÔºåÂçïÂäüËÉΩÁâ©ÁêÜPCIËÆæÂ§áÂè™‰ºö‰ΩøÁî® <code>INTA#</code> ÂºïËÑöÔºåÂ§öÂäüËÉΩÁâ©ÁêÜPCIËÆæÂ§áÂèØËÉΩ‰ºöÁî®Âà∞ÂÖ∂‰Ωô‰∏≠Êñ≠ÂºïËÑö„ÄÇÁî±‰∫é‰∏Ä‰∏™Áâ©ÁêÜPCIËÆæÂ§áÊúÄÂ§öÂåÖÂê´8‰∏™ÈÄªËæëPCIËÆæÂ§áÔºåÊïÖÂ≠òÂú®<strong>Â§ö‰∏™ÈÄªËæëPCIËÆæÂ§áÂÖ±‰∫´Âêå‰∏Ä‰∏™‰∏≠Êñ≠ÂºïËÑö</strong>ÁöÑÊÉÖÂÜµ„ÄÇ</p>
<p>ÈÄªËæëPCIËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑ‰∏≠Êñ≠ÂºïËÑö (Interrupt <code>Pin:0x3D</code>) ÂØÑÂ≠òÂô®ËÆ∞ÂΩï‰∫ÜËØ•ËÆæÂ§á‰ΩøÁî®Âì™‰∏™‰∏≠Êñ≠ÂºïËÑöÔºå<code>1~4</code> ÂàÜÂà´ÂØπÂ∫î <code>INTA#~INTD#</code> ÂºïËÑö„ÄÇPCIÊÄªÁ∫øÈÄöÂ∏∏Êèê‰æõ4Êù°Êàñ8Êù°‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø‰æõPCIËÆæÂ§á‰ΩøÁî®ÔºåÁâ©ÁêÜPCIËÆæÂ§á‰∏≠Êñ≠ÂºïËÑöÂ∞ÜËøûÊé•Âà∞Ëøô‰∫õ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø‰∏ä„ÄÇÂÅáËÆæPCIÊÄªÁ∫øÊèê‰æõ‰∫Ü4Êù°‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÔºö<code>LNKA</code>„ÄÅ<code>LNKB</code>„ÄÅ<code>LNKC</code> Âíå <code>LNKD</code> ÔºåÂπ∂ÈùûÊâÄÊúâÁöÑPCIËÆæÂ§á <code>INTA#</code> ÂºïËÑöÈÉΩËøûÊé•Ëá≥Âõ∫ÂÆö <code>LNKA</code> ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÔºåÂõ†‰∏∫ÈÄöÂ∏∏Â§ßÈÉ®ÂàÜPCIËÆæÂ§áÈÉΩ‰ΩøÁî® <code>INTA#</code> ÂºïËÑöÔºåËøôÊ†∑‰ºöÈÄ†ÊàêÂêÑ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øË¥üËΩΩ‰∏çÂùáË°°ÁöÑÊÉÖÂÜµ„ÄÇPCIËÆæÂ§á‰∏≠Êñ≠Ë∑ØÁî±ËøûÊé•Â¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221929327.png" alt="image-20231122192505047" style="zoom:50%;" />
<blockquote>
<p>Ê≠§Êó∂PCIÊÄªÁ∫ø‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø‰∏éPCIËÆæÂ§áÂºïËÑöÊò†Â∞ÑÂÖ≥Á≥ª‰∏∫ <code>LNK = (D+I) mod 4</code>ÔºåÂÖ∂‰∏≠ <code>LNK</code> Ë°®Á§∫PCIÊÄªÁ∫ø‰∏≠ÁöÑ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÂè∑Ôºå<code>D</code> Ë°®Á§∫Áâ©ÁêÜPCIËÆæÂ§áÂè∑Ôºå<code>I</code> Ë°®Á§∫Áâ©ÁêÜPCIËÆæÂ§áÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑„ÄÇ</p>
</blockquote>
<p>‰∏äËø∞ËøûÊé•ÊñπÂºè‰ΩøÂæóÂêÑÁâ©ÁêÜPCIËÆæÂ§á‰∏≠Êñ≠ÂºïËÑö‰∫§ÈîôËøûÊé•Ëá≥PCIÊÄªÁ∫ø‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø„ÄÇËÄåPCIÊÄªÁ∫ø‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øËøòÈúÄË¶ÅËøûÊé•Ëá≥‰∏≠Êñ≠ÊéßÂà∂Âô®ÔºåÂÆÉ‰ª¨‰∏é‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑö‰πãÈó¥ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª‰øùÂ≠òÂú®BIOS‰∏≠ÁöÑ‰∏≠Êñ≠Ë∑ØÁî±Ë°®‰∏≠„ÄÇËøôÊ†∑ÊØè‰∏™PCIÈÄªËæëËÆæÂ§áÈÉΩËøûÊé•Ëá≥‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑ‰∏Ä‰∏™‰∏≠Êñ≠ÂºïËÑöÔºå‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂè∑ËÆ∞ÂΩïÂú®PCIÈÖçÁΩÆÁ©∫Èó¥ÁöÑ‰∏≠Êñ≠Á∫ø (Interrupt Line, 0x3C) ÂØÑÂ≠òÂô®‰∏≠„ÄÇ<strong>ÂΩìPCIËÆæÂ§áÂèëËµ∑‰∏≠Êñ≠ËØ∑Ê±ÇÊó∂Ôºå‰æø‰ºöÈÄöËøáÊò†Â∞ÑÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂ∞Ü‰∏≠Êñ≠ÈÄí‰∫§ÁªôCPU„ÄÇ</strong></p>
<h3 id="pciËÆæÂ§á‰∏≠Êñ≠Ê®°Êãü"><strong>PCIËÆæÂ§á‰∏≠Êñ≠Ê®°Êãü</strong>
</h3><p>Âú®QEMU‰∏≠ÔºåËôöÊãüPCIËÆæÂ§áË∞ÉÁî® <code>pci_set_irq</code> ÂáΩÊï∞Êù•**Ëß¶Âèë‰∏≠Êñ≠Ôºå**ÂÖ∑‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li><code>pci_set_irq</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>pci_intx</code> ÂáΩÊï∞Ëé∑ÂèñËØ•PCIËÆæÂ§á‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÂºïËÑöÔºå<code>pci_intx</code> ÂáΩÊï∞Â∞Ü‰ºö‰ªéËØ•ËÆæÂ§áÁöÑPCIÈÖçÁΩÆÁ©∫Èó¥‰∏≠ËØªÂèñ‰∏≠Êñ≠ÂºïËÑöÂØÑÂ≠òÂô®ÁöÑÂÄºÂπ∂Âáè1Ôºõ</li>
<li>ÁÑ∂Âêé <code>pci_set_irq</code> ÂáΩÊï∞Â∞ÜË∞ÉÁî® <code>pci_irq_handler</code> Â§ÑÁêÜPCIËÆæÂ§á‰∏≠Êñ≠„ÄÇ<code>pci_irq_handler</code> ÂáΩÊï∞È¶ñÂÖàÂà§Êñ≠ÂΩìÂâç‰∏≠Êñ≠ÂºïËÑöÁöÑÁä∂ÊÄÅÊòØÂê¶ÂèëÁîüÊîπÂèòÔºåËã•ÊîπÂèòÔºåÂàôË∞ÉÁî® <code>pci_set_irq_state</code> ÂáΩÊï∞ËÆæÁΩÆËÆæÂ§á‰∏≠Êñ≠ÂºïËÑöÁöÑÁä∂ÊÄÅÔºåÂπ∂Ë∞ÉÁî® <code>pci_update_irq_status</code> ÂáΩÊï∞Êõ¥Êñ∞PCIËÆæÂ§áÁöÑÁä∂ÊÄÅ„ÄÇËã•ÂΩìÂâçPCIËÆæÂ§á‰∏≠Êñ≠Êú™Ë¢´Á¶ÅÁî®ÔºåÂàô <code>pci_irq_handler</code> ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî® <code>pci_change_irq_level</code> ÂáΩÊï∞Ëß¶Âèë‰∏≠Êñ≠„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ol>
<p><code>qemu-4.1.1/hw/pci/pci.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221929219.png" alt="image-20231122192558988" style="zoom:33%;" />
<hr>
<p><code>pci_change_irq_level</code> ÂáΩÊï∞È¶ñÂÖàËé∑ÂèñËÆæÂ§áÊâÄÂú®ÁöÑPCIÊÄªÁ∫øÔºåÁÑ∂ÂêéË∞ÉÁî®ÂÖ∂ <code>map_irq</code> ÂõûË∞ÉÂáΩÊï∞Ëé∑ÂèñËØ•ËÆæÂ§á‰∏≠Êñ≠ÂºïËÑöÊâÄËøûÊé•ÁöÑ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÔºåÊúÄÂêéË∞ÉÁî®ÊâÄÂú®PCIÊÄªÁ∫øÁöÑ <code>set_irq</code> ÂõûË∞ÉÂáΩÊï∞Ëß¶Âèë‰∏≠Êñ≠„ÄÇ</p>
<p>‰ª•QEMU <code>i440FX+PIIX</code> Êû∂ÊûÑ‰∏∫‰æãÔºåÂÖ∂PCIÊÄªÁ∫ø <code>map_irq</code> Áõ∏Â∫îÁöÑÂõûË∞ÉÂáΩÊï∞‰∏∫ <code>pci_slot_get_pirq</code>Ôºå<code>set_irq</code> Áõ∏Â∫îÁöÑÂõûË∞ÉÂáΩÊï∞‰∏∫ <code>piix3_set_irq</code>ÔºåËøô‰∏§‰∏™ÂõûË∞ÉÂáΩÊï∞Âú®i440FXËäØÁâáÁªÑÂàùÂßãÂåñÂáΩÊï∞ <code>i440fx_init</code> ‰∏≠Ê≥®ÂÜå„ÄÇ<code>i440fx_init</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>pci_root_bus_new</code> ÂáΩÊï∞ÂàõÂª∫PCIÊ†πÊÄªÁ∫øÔºåÁÑ∂ÂêéË∞ÉÁî® <code>pci_bus_irqs</code> ÂáΩÊï∞ËÆæÁΩÆPCIÊ†πÊÄªÁ∫øÂØπÂ∫îQOMÂØπË±°ÁöÑ <code>map_irq</code> ÊàêÂëòÂíå <code>set_irq</code> ÊàêÂëò„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221929125.png" alt="image-20231122192703238" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/pci/pci.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221930622.png" alt="image-20231122193011131" style="zoom:33%;" />
<p><code>pci_slot_get_pirq</code> ÂáΩÊï∞È¶ñÂÖàËé∑ÂèñPCIËÆæÂ§áÁöÑËÆæÂ§áÂè∑ÔºåÁÑ∂ÂêéÈÄöËøáËÆæÂ§áÂè∑ÂíåÂÆÉ‰ΩøÁî®ÁöÑPCIËÆæÂ§á‰∏≠Êñ≠ÂºïËÑöËé∑ÂèñËØ•PCIËÆæÂ§áËøûÊé•Ëá≥PCIÊÄªÁ∫ø‰∏≠ÁöÑÂì™‰∏ÄÊù°‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø„ÄÇQEMUËßÑÂÆöi440FXËäØÁâáÁªÑ‰∏≠PCIËÆæÂ§á‰∏éPCIÊÄªÁ∫ø‰∏≠Êñ≠Á∫øÁöÑÊò†Â∞ÑÂÖ≥Á≥ª‰∏∫ <code>(slot+pin)&amp;3-&gt;&quot;LNK[D|A|B|C]&quot;</code>ÔºåËÄåÈùû <code>(slot+pin)&amp;3-&gt;&quot;LNK[A|B|C|D]&quot;</code>„ÄÇ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221928712.png" alt="image-20231122192844118" style="zoom:33%;" />
<p><code>piix3_set_irq</code> ÂõûË∞ÉÂáΩÊï∞Âàô‰∏ªË¶ÅË∞ÉÁî® <code>piix3_set_irq_level</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞È¶ñÂÖàËÆøÈóÆPIIX3ËÆæÂ§áÈÖçÁΩÆÁ©∫Èó¥ÔºåËé∑ÂèñPCIÊÄªÁ∫ø‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂè∑„ÄÇÂØπ‰∫é <code>PIIX3/PIIX4</code> Êù•ËØ¥ÔºåÂÖ∂ÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øË∑ØÁî±ÊéßÂà∂ÂØÑÂ≠òÂô® ( <code>PIRQRC[A:D],0x60~0x63</code> ) ÂàÜÂà´ËÆ∞ÂΩï‰∫Ü <code>LNKA~LNKD</code> ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂè∑ÔºåËøôÂá†‰∏™ÂØÑÂ≠òÂô®ÁöÑÂÄºÁî±BIOSËÆæÁΩÆ„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221931569.png" alt="image-20231122193059886" style="zoom:33%;" />
<p><code>piix3_set_irq_level</code> ÂáΩÊï∞Ëé∑ÂæóPCIËÆæÂ§áÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂè∑ÂêéË∞ÉÁî® <code>piix3_set_irq_pic</code> ÂáΩÊï∞„ÄÇ<code>piix3_set_irq_pic</code> ÂáΩÊï∞Ê†πÊçÆ‰º†ÂÖ•ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂè∑Á¥¢ÂºïPIIX3StateÁªìÊûÑ‰∏≠ÁöÑ <code>pic</code> ÊàêÂëòÔºåËØ•ÊàêÂëòÂú® <code>i440fx_init</code> ÂáΩÊï∞‰∏≠Ë¢´ËÆæÁΩÆ‰∏∫ <code>pcms-&gt;gsi</code>ÔºåÊïÖ <code>piix_set_irq_pic</code> ÂáΩÊï∞Êú¨Ë¥®‰∏äÁ¥¢ÂºïÁöÑÊòØ <code>pcms-&gt;gsi</code>„ÄÇ</p>
<blockquote>
<p><code>pcms-&gt;gsi</code> ÊòØ**QEMU‰∏≠Êñ≠Ë∑ØÁî±ÁöÑËµ∑ÁÇπÔºå**ÂÖ∂Áî®Ê≥ïÂ∞ÜÂú®4.3ËäÇ‰ªãÁªç„ÄÇ</p>
</blockquote>
<p><code>piix3_set_irq_pic</code> ÂáΩÊï∞‰ªé <code>pcms-&gt;gsi</code> ‰∏≠Ëé∑Âæó‰∏Ä‰∏™ <code>qemu_irq</code> ÂêéÂ∞ÜÂÖ∂‰º†ÈÄíÁªô <code>qemu_set_irq</code> ÂáΩÊï∞„ÄÇ</p>
<ul>
<li><code>qemu_irq</code> ÊòØ‰∏Ä‰∏™ÊåáÂêëIRQStateÁªìÊûÑ‰ΩìÁöÑÊåáÈíàÔºåÂú®QEMU‰∏≠ÔºåIRQStateÈÄöÂ∏∏Áî®‰∫éË°®Á§∫ËÆæÂ§áÊàñ‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑ‰∏≠Êñ≠ÂºïËÑöÔºå<code>n</code> Ë°®Á§∫‰∏≠Êñ≠ÂºïËÑöÂè∑Ôºå<code>opaque</code> Áî±ÂàõÂª∫ËÄÖÊåáÂÆöÔºå<code>handler</code> Ë°®Á§∫ËØ•‰∏≠Êñ≠ÂºïËÑöÊî∂Âà∞‰ø°Âè∑Êó∂ÁöÑÂ§ÑÁêÜÂáΩÊï∞„ÄÇ</li>
<li><code>qemu_set_irq</code> ÂáΩÊï∞ÊâÄÂÅöÁöÑÂ∑•‰ΩúÂÖ∂ÂÆûÂ∞±ÊòØË∞ÉÁî®‰º†ÂÖ• <code>qemu_irq</code> ÁöÑhandlerÂáΩÊï∞ÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ul>
<p><code>qemu-4.1.1/hw/core/irq.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221931493.png" alt="image-20231122193145582" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221932450.png" alt="image-20231122193212078" style="zoom:33%;" />
<h2 id="43--qemukvm‰∏≠Êñ≠Ë∑ØÁî±">4.3  QEMU/KVM‰∏≠Êñ≠Ë∑ØÁî±
</h2><p>4.2ËäÇ‰ªãÁªç‰∫ÜPCIËÆæÂ§á‰∏≠Êñ≠ÁöÑÊ®°ÊãüÔºåËÄåÂ§ñÈÉ®ËÆæÂ§á‰∫ßÁîüÁöÑ‰∏≠Êñ≠ÈúÄË¶ÅÁªèÁî±‰∏≠Êñ≠ÊéßÂà∂Âô®ÊâçËÉΩ‰º†ÈÄíÁªôCPUÔºåÊïÖÊú¨ËäÇÂ∞Ü‰ªãÁªç**Â§ñÈÉ®ËÆæÂ§á‰∏≠Êñ≠Ë∑ØÁî±Ëá≥‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑÂÆåÊï¥ÊµÅÁ®ã„ÄÇ**Êú¨ËäÇ‰ªç‰ª•KVMÊ®°Êãü‰∏≠Êñ≠ÊéßÂà∂Âô®‰∏∫‰æã„ÄÇ</p>
<h3 id="qemu‰∏≠Êñ≠Ë∑ØÁî±">QEMU‰∏≠Êñ≠Ë∑ØÁî±
</h3><p><strong>QEMU‰∏≠Êñ≠Ë∑ØÁî±ÁöÑËµ∑ÁÇπ</strong>‰Ωç‰∫é <code>pcms-&gt;gsi</code>ÔºåÂÆÉÊú¨Ë¥®‰∏äÊòØ‰∏Ä‰∏™ <code>qemu_irq</code> Êï∞ÁªÑÔºå‰∏∫ÊâÄÊúâÁöÑËôöÊãüËÆæÂ§áÂÆö‰πâ‰∫ÜÁªü‰∏ÄÁöÑ‰∏≠Êñ≠‰º†ÈÄíÂÖ•Âè£„ÄÇQEMUÊ†πÊçÆ‰º†ÂÖ•ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®ÂºïËÑöÂè∑‰ª•ÂèäÁ≥ªÁªüÂΩìÂâç‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®Á±ªÂûãÔºåÂÜ≥ÂÆöËØ•‰∏≠Êñ≠Â¶Ç‰ΩïËøõË°å‰º†ÈÄí„ÄÇÂÆåÊï¥ÁöÑQEMU‰∏≠Êñ≠Ë∑ØÁî±ÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫„ÄÇ</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221933165.png" alt="image-20231122193334156" style="zoom: 33%;" />
<p><code>pcms</code> ÊòØPCMachineStateÁ±ªÂûãÁöÑÁªìÊûÑ‰ΩìÔºåÂèØ‰ª•ÁêÜËß£‰∏∫Êï¥‰∏™ËôöÊãüÊú∫ÁöÑËÆæÂ§áÊ®°ÂûãÔºåÂÖ∂ <code>gsi</code> ÊàêÂëòÂú®ËôöÊãüÊú∫ËÆæÂ§áÊ®°ÂûãÂàùÂßãÂåñÂáΩÊï∞ <code>pc_init1</code> ‰∏≠ÂàõÂª∫Ôºö</p>
<ul>
<li><code>pc_init1</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kvm_ioapic_in_kernel</code> ÂáΩÊï∞Âà§Êñ≠IOAPICËäØÁâáÊòØÂê¶Áî±KVMÊ®°ÊãüÔºõ
<ul>
<li>Ëã•ÊòØÔºåÂàôË∞ÉÁî® <code>qemu_allocate_irqs</code> ÂáΩÊï∞Ôºõ
<ul>
<li>ËøõËÄåË∞ÉÁî® <code>qemu_extend_irqs</code> ÂáΩÊï∞ÂàõÂª∫Ëã•Âπ≤‰∏™IRQStateÁªìÊûÑ‰ΩìÔºåÂÖ∂handler‰∏∫<code>kvm_pc_gsi_handler</code>ÔºåopaqueÂàôÊåáÂêëÈ¢ÑÂÖàÂàÜÈÖçÁöÑGSIStateÁªìÊûÑ‰Ωì„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Áõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/i386/pc_piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221935295.png" alt="image-20231122193507216" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/core/irq.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221935137.png" alt="image-20231122193543132" style="zoom:33%;" />
<hr>
<p><code>pcms-&gt;gsi</code> ÂàõÂª∫ÂÆåÊàêÂêéÔºå<code>pc_init1</code> ÂáΩÊï∞Ë∞ÉÁî® <code>i440fx_init</code> ÂáΩÊï∞Â∞Ü <code>pcms-&gt;gsi</code> ËµãÁªôPIIX3State‰∏≠ÁöÑ <code>pic</code> ÊàêÂëòÔºåÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/pci-host/piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221936244.png" alt="image-20231122193643293" style="zoom:33%;" />
<p>ÂâçÈù¢ÊèêÂà∞PCIËÆæÂ§á‰∏≠Êñ≠Ê®°ÊãüÊúÄÁªàÈÄöËøá <code>qemu_set_irq</code> Ë∞ÉÁî® <code>PIIX3State pic</code> ÊàêÂëò‰∏≠ÁöÑÊüê‰∏™ <code>qemu_irq</code> Êï∞ÁªÑÁöÑhandlerÔºåËÄåÂÖ∂ <code>pic</code> ÊàêÂëòË¢´ËÆæÁΩÆ‰∏∫ <code>pcms-&gt;gsi</code>„ÄÇ</p>
<p>ÂÆûÈôÖ‰∏äÂØπ‰∫éISAÊÄªÁ∫øÔºå<code>pc_init1</code> ÂáΩÊï∞‰πü‰ºöË∞ÉÁî® <code>isa_bus_irqs</code> ÂáΩÊï∞Â∞Ü <code>pcms-&gt;irq</code> ËµãÂÄºÁªôisabusÁöÑ <code>irqs</code> ÊàêÂëò„ÄÇÂõ†Ê≠§ÊúÄÁªàISAËÆæÂ§áÂíåPCIËÆæÂ§á‰∏≠Êñ≠ÈÉΩ‰ºöË∞ÉÁî® <code>pcms-&gt;gsi</code> ‰∏≠Êüê‰∏™ <code>qemu_irq</code> Êï∞ÁªÑÁöÑhandlerÔºåÂç≥ÂâçÈù¢Ê≥®ÂÜåÁöÑ<code>kvm_pc_gsi_handler</code> ÂáΩÊï∞„ÄÇ<code>kvm_pc_gsi_handler</code> ÂáΩÊï∞Êé•Êî∂‰∏â‰∏™ÂèÇÊï∞ÔºöÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ <code>opaque</code> ÊåáÂêëÂâçËø∞ÂàÜÈÖçÁöÑGSIStateÔºåÁ¨¨‰∫å‰∏™ÂèÇÊï∞‰∏∫ <code>IRQ</code> Âè∑ÔºåÁ¨¨‰∏â‰∏™ÂèÇÊï∞‰∏∫ÁîµÂπ≥‰ø°Âè∑„ÄÇ</p>
<p>GSIStateÂåÖÂê´‰∏§‰∏™ÊàêÂëòÔºö<code>i8259_irq</code> Âíå <code>ioapic_irq</code>Ôºö</p>
<ul>
<li>**<code>i8259_irq</code> ÂØπÂ∫îPICÔºå**ÂåÖÂê´16‰∏™‰∏≠Êñ≠ÂºïËÑöÔºàqemu_irqÁªìÊûÑ‰ΩìÔºâÔºåhandler‰∏∫ <code>kvm_pic_set_irq</code>Ôºõ</li>
<li>**<code>ioapic_irq</code> ÊàêÂëòÂØπÂ∫îIOAPICÔºå**ÂåÖÂê´24‰∏™‰∏≠Êñ≠ÂºïËÑöÔºåhandler‰∏∫ <code>kvm_ioapic_set_irq</code>„ÄÇ</li>
</ul>
<blockquote>
<p>‰∫åËÄÖÂàÜÂà´Áî± <code>pc_init1</code> ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_i8259_init</code> Âíå <code>ioapic_init_gsi</code> ÂáΩÊï∞ËøõË°åÂàùÂßãÂåñ„ÄÇÂΩìÊüêÊù°IRQÁ∫øÊúâ‰∏≠Êñ≠‰ø°Âè∑Êó∂ÔºåQEMUÂ∞ÜÊ†πÊçÆÂΩìÂâçÁ≥ªÁªü‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®Ë∞ÉÁî®‰∏çÂêåÁöÑhandler„ÄÇ</p>
</blockquote>
<p>ÂÄºÂæóÊÄùËÄÉÁöÑÊòØÔºåÂΩìÁõ∏Â∫îÁöÑIRQÂè∑Â∞è‰∫é16Êó∂Ôºå<code>kvm_pc_gsi_handler</code> ‰æø‰ºöË∞ÉÁî® <code>GSIState i8259_irq</code> ‰∏≠ <code>qemu_irq</code> Áõ∏Â∫îÁöÑÂõûË∞ÉÂáΩÊï∞ÔºåËøôÂπ∂ÈùûÊÑèÂë≥ÁùÄÂΩìÂâçÁ≥ªÁªü‰ΩøÁî®ÁöÑÂ∞±ÊòØPIC‰∏≠Êñ≠ÊéßÂà∂Âô®„ÄÇÂÆûÈôÖ‰∏äÂΩìIRQÂè∑Â∞è‰∫é16Êó∂ÔºåKVM‰ºöÂ∞Ü‰∏≠Êñ≠‰ø°Âè∑ÂêåÊó∂ÂèëÈÄÅÁªôËôöÊãüPICÂíåËôöÊãüIOAPICÔºåËôöÊãüÊú∫ÈÄöËøáÂΩìÂâçÁúüÊ≠£‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®Êé•Êî∂ËØ•‰∏≠Êñ≠‰ø°Âè∑„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/include/hw/i386/pc.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221939521.png" alt="image-20231122193745586" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/i386/pc_piix.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221939120.png" alt="image-20231122193835808" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/i386/kvm/ioapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221940782.png" alt="image-20231122194011204" style="zoom:33%;" />
<hr>
<p>Âõ†Ê≠§ÂΩìËôöÊãüËÆæÂ§áË∞ÉÁî® <code>qemu_set_irq</code> ÂáΩÊï∞Ëß¶Âèë‰∏≠Êñ≠Êó∂ÔºåÊúÄÁªà‰ºöË∞ÉÁî® <code>kvm_pic_set_irq</code> ÂáΩÊï∞Êàñ<code>kvm_ioapic_set_irq</code> ÂáΩÊï∞ÔºåËÄåËøô‰∏§‰∏™ÂáΩÊï∞ÊúÄÁªàÈÉΩ‰ºöË∞ÉÁî® <code>kvm_set_irq</code> ÂáΩÊï∞ÈÄöËøáioctlÂ∞Ü‰∏≠Êñ≠‰ø°Âè∑‰º†ÂÖ•KVMËøõË°åÂ§ÑÁêÜ„ÄÇ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>qemu-4.1.1/hw/i386/kvm/i8259.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221945488.png" alt="image-20231122194539574" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/i386/kvm/ioapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221946513.png" alt="image-20231122194643008" style="zoom:33%;" />
<p><code>qemu-4.1.1/accel/kvm/kvm-all.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221948139.png" alt="image-20231122194819460" style="zoom:33%;" />
<h3 id="kvm‰∏≠Êñ≠Ë∑ØÁî±">KVM‰∏≠Êñ≠Ë∑ØÁî±
</h3><p>KVM‰∏≠Êñ≠Ë∑ØÁî±Áî± <code>struct kvm_irq_routing_table</code> ÂÆåÊàêÔºåËøô‰∏ÄÁªìÊûÑ‰ΩìÂäüËÉΩÁ±ª‰ºº‰∫éQEMU‰∏≠ÁöÑGSIStateÔºåÊ†πÊçÆ‰º†ÂÖ•ÁöÑ <code>IRQ</code> Âè∑Ë∞ÉÁî®‰∏çÂêåÁöÑÂõûË∞ÉÂáΩÊï∞Ôºö</p>
<ul>
<li>ÂΩì <code>IRQ &lt; 16</code> Êó∂ÔºåKVM‰ºöÂêåÊó∂Â∞Ü‰∏≠Êñ≠‰ø°Âè∑ÂèëÈÄÅÁªôËôöÊãüPICÂíåËôöÊãüIOAPICÔºåËôöÊãüÊú∫‰ºöÈÄöËøáÂΩìÂâç‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®Êé•Êî∂ËØ•‰∏≠Êñ≠‰ø°Âè∑ÔºåÂÖ∂‰Ωô‰∏≠Êñ≠‰ø°Âè∑Â∞ÜË¢´ÂøΩÁï•Ôºõ</li>
<li>ÂΩì <code>IRQ &gt; 16</code> Êó∂Ôºå‰∏≠Êñ≠‰ø°Âè∑Âè™‰ºöÂèëÈÄÅÁªôËôöÊãüIOAPIC„ÄÇ</li>
</ul>
<p>ÂÆåÊï¥ÁöÑKVM‰∏≠Êñ≠Ë∑ØÁî±ÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311221949814.png" alt="image-20231122194917539" style="zoom: 50%;" />
<p>ÂΩì‰∏≠Êñ≠ËäØÁâáÂÖ®ÈÉ®Áî±ÂÜÖÊ†∏Ê®°ÊãüÊó∂Ôºå**KVMÂØπÂ∫îÁöÑ‰∏≠Êñ≠Ë∑ØÁî±‰ø°ÊÅØÁî±QEMUËÆæÁΩÆÂπ∂‰º†ÂÖ•KVM‰∏≠Ôºå**Ëøô‰∏ÄÂ∑•‰ΩúÁî± <code>pc_init1</code> ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_pc_setup_irq_routing</code> ÂáΩÊï∞ÂÆåÊàêÔºö</p>
<ul>
<li>ËØ•ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_irqchip_add_irq_route</code> ÂáΩÊï∞‰∏∫ÊØè‰∏™‰∏≠Êñ≠ÊéßÂà∂Âô®ÁöÑÊØè‰∏™‰∏≠Êñ≠ÂºïËÑöÈÉΩÊ∑ªÂä†‰∏ÄÊù° <code>kvm_irq_routing_entry</code>ÔºåËÆ∞ÂΩïÊâÄÂ±û‰∏≠Êñ≠ËäØÁâáÁºñÂè∑„ÄÅ‰∏≠Êñ≠ÂºïËÑöÂè∑ÂíåÂØπÂ∫îÁöÑGSIÂè∑Ôºõ
<ul>
<li>ÊúÄÂêéË∞ÉÁî® <code>kvm_irqchip_commit_routes</code> ÂáΩÊï∞Â∞Ü‰∏≠Êñ≠Ë∑ØÁî±‰ø°ÊÅØÊèê‰∫§ÁªôKVM„ÄÇ</li>
</ul>
</li>
</ul>
<p>ÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºåËøôÈáåIOAPICÁöÑ2Âè∑‰∏≠Êñ≠ÂºïËÑöÂπ∂‰∏çÊª°Ë∂≥ÂâçËø∞Âü∫Á°Ä <code>GSI + Pin</code> Êò†Â∞ÑÂÖ≥Á≥ªÔºåÂú®QEMU/KVM‰∏≠ÔºåGSIÁ≠âÂêå‰∫éIRQ„ÄÇÁõ∏Â∫îÁöÑÔºåÂâçËø∞ <code>kvm_set_irq</code> ‰º†ÂÖ•KVMÁöÑÂÖ∂ÂÆû‰πüÊòØIRQÂè∑„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/include/uapi/linux/kvm.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222012439.png" alt="image-20231122201145743" style="zoom:33%;" />
<p><code>qemu-4.1.1/hw/i386/kvm/ioapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222012809.png" alt="image-20231122201238762" style="zoom:33%;" />
<hr>
<p>KVMÊé•Êî∂Âà∞QEMU‰º†ÂÖ•ÁöÑ‰∏≠Êñ≠Ë∑ØÁî±‰ø°ÊÅØÂêéÔºåË∞ÉÁî® <code>kvm_set_irq_routing</code> ÂáΩÊï∞ÊûÑÂª∫ <code>kvm_irq_routing_table</code>„ÄÇ<code>kvm_irq_routing_table</code> ÁöÑÁªÑÁªáÊñπÂºè‰∏éQEMU‰∏≠ÁöÑGSIState‰∏çÂêåÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/include/linux/kvm_host.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222013988.png" alt="image-20231122201340726" style="zoom:33%;" />
<ul>
<li><code>chip</code> ÊàêÂëòÊòØ‰∏Ä‰∏™‰∫åÁª¥Êï∞ÁªÑÔºåËÆ∞ÂΩï‰∫ÜÊØè‰∏™‰∏≠Êñ≠ËäØÁâá‰∏≠Êñ≠ÂºïËÑöÂØπÂ∫îÁöÑGSIÂè∑„ÄÇ<code>map</code> ÊàêÂëòÊòØ‰∏Ä‰∏™ÈìæË°®Êï∞ÁªÑÔºå<code>nr_rt_entries</code> ËÆ∞ÂΩï‰∫ÜÂÆÉÁöÑÈïøÂ∫¶„ÄÇ</li>
<li>ÂØπ‰∫éÊØè‰∏™GSIÔºå<code>map</code> ÊàêÂëòÈÉΩ‰ºö‰∏∫ÂÖ∂‰øùÂ≠ò‰∏Ä‰∏™ÈìæË°®ÔºåÈìæË°®ÁöÑÊØè‰∏ÄÈ°πÊòØ <code>kvm_kernel_irq_routing_entry</code>ÔºåËØ•ÁªìÊûÑ‰ΩìÁ±ª‰ºº‰∫é‰∏äËø∞QEMU‰∏≠ÁöÑ <code>kvm_irq_routing_entry</code>ÔºåËÆ∞ÂΩï‰∫ÜGSIÂú®Êüê‰∏™‰∏≠Êñ≠ËäØÁâá‰∏≠ÂØπÂ∫îÁöÑÂºïËÑöÂè∑Âíå‰∏≠Êñ≠ÂõûË∞ÉÂáΩÊï∞„ÄÇ</li>
<li>ÂØπ‰∫éPICÂíåIOAPICÔºåÂÆÉ‰ª¨ÁöÑÊüê‰∏™ÂºïËÑöÂèØËÉΩ‰ºöÊò†Â∞ÑÂà∞Âêå‰∏Ä‰∏™GSIÔºå<code>map</code> ÊàêÂëò‰∏∫ÂÆÉ‰ª¨ÂêÑËá™Áª¥Êä§‰∏ÄÊù°<code>kvm_kernel_irq_routing_entry</code> ‰øùÂ≠òÂú®ÈìæË°®‰∏≠„ÄÇ</li>
<li>ÂΩìÊî∂Âà∞Êüê‰∏™GSI‰ø°Âè∑ÂêéÔºåKVMÂ∞ÜÈÅçÂéÜGSIÁõ∏Â∫îÁöÑÈìæË°®ÔºåË∞ÉÁî®ÊØèÊù° <code>kvm_kernel_irq_routing_entry</code> ‰∏≠ÁöÑsetÂõûË∞ÉÂáΩÊï∞ÔºåÂ∞Ü‰∏≠Êñ≠‰ø°Âè∑‰º†ÈÄíÁªôÂêÑ‰∏™‰∏≠Êñ≠ËäØÁâá„ÄÇ</li>
</ul>
<hr>
<p>ÂØπ‰∫é‰º†ÂÖ•KVM‰∏≠ÁöÑÊØèÊù° <code>kvm_irq_routing_entry</code>Ôºå<code>kvm_set_irq_routing</code> ÂáΩÊï∞ÈÉΩ‰ºöË∞ÉÁî® <code>setup_routing_entry</code> ÂáΩÊï∞Â∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫ <code>kvm_kernel_irq_routing_entry</code>ÔºåËÆæÁΩÆÂÖ∂setÂõûË∞ÉÂáΩÊï∞ÔºåÂπ∂Â°´ÂÖÖ<code>kvm_irq_routing_table</code> ‰∏≠ÁöÑmapÊàêÂëò„ÄÇ</p>
<p>PICË∑ØÁî±Ë°®È°πÂØπÂ∫îÁöÑsetÂáΩÊï∞‰∏∫ <code>kvm_set_pic_irq</code>ÔºåIOAPICË∑ØÁî±Ë°®È°πÂØπÂ∫îÁöÑsetÂáΩÊï∞‰∏∫ <code>kvm_ioapic_set_irq</code>„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/virt/kvm/irqchip.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222014196.png" alt="image-20231122201427085" style="zoom: 33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/irq_comm.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222015494.png" alt="image-20231122201516866" style="zoom:33%;" />
<hr>
<p>ÂΩìQEMUË∞ÉÁî®ÂâçËø∞ <code>kvm_set_irq</code> ÂáΩÊï∞Èô∑ÂÖ•KVMÊó∂ÔºåË∞ÉÁî®ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>KVMÂ∞ÜË∞ÉÁî® <code>kvm_vm_ioctl_irq_line</code> ÂáΩÊï∞ËøõËÄåË∞ÉÁî®<code>kvm_set_irq</code> ÂáΩÊï∞ËøõË°åÂ§ÑÁêÜÔºõ
<ul>
<li><code>kvm_set_irq</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî® <code>kvm_irq_map_gsi</code> ÂáΩÊï∞ÔºåÊ†πÊçÆ‰º†ÂÖ•ÁöÑGSI‰ªé <code>kvm_irq_routing_table</code> ÁöÑmapÊàêÂëò‰∏≠ÂèñÂá∫ËØ•GSIÂØπÂ∫îÁöÑÊâÄÊúâ <code>kvm_kernel_irq_routing_entry</code> Âπ∂Ë∞ÉÁî®ÂÖ∂setÂáΩÊï∞„ÄÇ</li>
</ul>
</li>
</ul>
<p>Ëá≥Ê≠§Ôºå‰∏≠Êñ≠‰ø°Âè∑Ë¢´‰º†ÈÄíÂà∞KVMÊ®°ÊãüÁöÑ‰∏≠Êñ≠ËäØÁâá‰∏≠„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/virt/kvm/irqchip.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222017905.png" alt="image-20231122201606127" style="zoom:33%;" />
<hr>
<p>ËÄÉËôëÂà∞ÂêéÁª≠ÂÆûÈ™åÈÉ®ÂàÜ‰∏ªË¶ÅÊ∂âÂèäIOAPICÔºåËøôÈáå**‰ª•IOAPIC‰∏∫‰æã‰ªãÁªç‰∏≠Êñ≠ËäØÁâáÊé•Êî∂Âà∞‰∏≠Êñ≠‰ø°Âè∑ÂêéÁöÑÂ§ÑÁêÜÊµÅÁ®ã„ÄÇ**ÂâçÈù¢ÊèêÂà∞IOAPICÂØπÂ∫îÁöÑsetÂáΩÊï∞‰∏∫ <code>kvm_set_ioapic_irq</code>ÔºåËØ•ÂáΩÊï∞È¶ñÂÖàËé∑ÂèñÂâçËø∞ËôöÊãüIOAPICÂØπÂ∫îÁöÑ <code>kvm_ioapic</code> ÁªìÊûÑ‰ΩìÔºåÁÑ∂ÂêéË∞ÉÁî® <code>kvm_ioapic_set_irq</code> ÂáΩÊï∞ÔºåÂÖ∂‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/irq_comm.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222016661.png" alt="image-20231122201647137" style="zoom:33%;" />
<p><code>kvm_ioapic_set_irq</code> ÂáΩÊï∞ÊúÄÁªàË∞ÉÁî® <code>ioapic_service</code> ÂáΩÊï∞Â§ÑÁêÜËØ•‰∏≠Êñ≠ËØ∑Ê±ÇÔºåÂÆÉÈ¶ñÂÖà‰ª•‰º†ÂÖ•ÁöÑIOAPIC‰∏≠Êñ≠ÂºïËÑöÂè∑‰∏∫Á¥¢ÂºïÔºåÊü•ËØ¢ IOAPIC PRT‰ª•Ëé∑ÂæóÂØπÂ∫îÁöÑRTEÔºåPRTËÆ∞ÂΩïÂú®ÂâçËø∞ <code>kvm_ioapic</code> ÁöÑ <code>redirtbl</code> ÊàêÂëò‰∏≠ÔºåÂÆÉÊú¨Ë¥®‰∏äÊòØ‰∏Ä‰∏™ <code>kvm_ioapic_redirect_entry</code> Êï∞ÁªÑÔºåÊØè‰∏ÄÈ°πËÆ∞ÂΩï‰∫Ü<strong>Áõ∏Â∫îÁöÑ‰∏≠Êñ≠ÂºïËÑöRTE</strong>Ôºå<code>kvm_ioapic_redirect_entry</code> ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/ioapic.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222018148.png" alt="image-20231122201740118" style="zoom:33%;" />
<p>Ëé∑ÂèñÁõ∏Â∫îÁöÑRTEÂêéÔºåÂç≥ <code>kvm_ioapic_redirect_entry</code> ÁªìÊûÑ‰ΩìÔºå<code>ioapic_service</code> ÂáΩÊï∞Ê†πÊçÆRTEÂàõÂª∫‰∏Ä‰∏™‰∏≠Êñ≠ËØ∑Ê±Ç‰øùÂ≠òÂú® <code>kvm_lapic_irq</code> ÁªìÊûÑ‰Ωì‰∏≠ÔºåÂπ∂Ë∞ÉÁî® <code>kvm_irq_delivery_to_apic</code> ÂáΩÊï∞Â∞ÜÂÖ∂‰º†ÈÄíÁªôLAPIC„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>linux-4.19.0/arch/x86/kvm/ioapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222018937.png" alt="image-20231122201840731" style="zoom:33%;" />
<hr>
<p><code>kvm_irq_delivery_to_apic</code> ÂáΩÊï∞ÊúÄ‰∏ªË¶ÅÁöÑÂ∑•‰ΩúÊòØÊâæÂà∞‰∏≠Êñ≠ËØ∑Ê±ÇÁöÑÁõÆÊ†áLAPICÈõÜÂêàÔºåÂèØËÉΩÂåÖÂê´‰∏Ä‰∏™ÊàñÂ§ö‰∏™LAPICÔºåËøô‰∏éÂâçËø∞RTE‰∏≠ÁöÑ <code>dest_mode</code> Âíå <code>dest_id</code> ÊàêÂëòÂØÜÂàáÁõ∏ÂÖ≥ÔºåËøôÈáå‰∏çÂÜçËØ¶Ëø∞ËØ•ÊµÅÁ®ã„ÄÇ</p>
<p>ÂØπ‰∫éÊâæÂà∞ÁöÑÊØè‰∏Ä‰∏™ÁõÆÊ†áLAPICÔºå<code>kvm_irq_delivery_to_apic</code> ÂáΩÊï∞ÈÉΩ‰ºöË∞ÉÁî® <code>kvm_apic_set_irq</code> ÂáΩÊï∞Â∞Ü‰∏≠Êñ≠ËØ∑Ê±ÇÂèëÈÄÅÁªôÂÆÉÔºö</p>
<ul>
<li><code>kvm_apic_set_irq</code> ÂáΩÊï∞È¶ñÂÖà‰ªé <code>vcpu-&gt;arch.apic</code> ‰∏≠Ëé∑ÂæóËôöÊãüLAPICÂØπÂ∫îÁöÑ <code>kvm_lapic</code> ÁªìÊûÑ‰ΩìÔºõ
<ul>
<li>ÁÑ∂ÂêéË∞ÉÁî®<code>__apic_accept_irq</code> ÂáΩÊï∞Êé•Êî∂ËØ•‰∏≠Êñ≠ËØ∑Ê±Ç„ÄÇ</li>
</ul>
</li>
</ul>
<p>Ëá≥Ê≠§Ôºå‰∏≠Êñ≠‰ø°Âè∑‰º†ÈÄíÁªôLAPICÔºå‰∏éÊ≠§ÂêåÊó∂ **<code>GSI/IRQ</code> Âè∑‰πüË¢´ËΩ¨Êç¢‰∏∫Áõ∏Â∫îÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑„ÄÇ**Áõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/lapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222019934.png" alt="image-20231122201932698" style="zoom:33%;" />
<p>‰∏≠Êñ≠‰º†ÈÄÅÊñπÂºè‰∏çÂêåÔºåÂç≥RTE‰∏≠ÁöÑ <code>delivery_mode</code> ‰∏çÂêåÔºå<code>__apic_accept_irq</code> ÁöÑÂ§ÑÁêÜ‰πü‰∏çÂêå„ÄÇ‰ª•FixedÊ®°Âºè‰∏∫‰æãÔºåÂÖ∂ÂØπÂ∫îÁöÑÂÆè‰∏∫ <code>APIC_DM_FIXED</code>„ÄÇ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/lapic.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222020085.png" alt="image-20231122202014299" style="zoom:33%;" />
<ul>
<li>LAPICÂú®ËÆæÁΩÆ <code>IRR</code> ÂâçÔºåÈ¶ñÂÖàË¶ÅËÆæÁΩÆ <code>TMR</code>ÔºàTrigger Mode RegisterÔºåËß¶ÂèëÊ®°ÂºèÂØÑÂ≠òÂô®Ôºâ„ÄÇ<code>TMR</code> ‰∏é <code>IRR</code>„ÄÅ<code>ISR</code> Á±ª‰ººÔºåÈÉΩ‰∏∫256‰ΩçÔºåÊØè‰∏Ä‰Ωç‰∏é‰∏Ä‰∏™‰∏≠Êñ≠ÂêëÈáèÂè∑Áõ∏ÂØπÂ∫î„ÄÇÂØπ‰∫éËæπÊ≤øËß¶ÂèëÁöÑ‰∏≠Êñ≠Ôºå<code>TMR</code> ‰∏≠ÂØπÂ∫î‰ΩçÁΩÆ0ÔºåÂØπ‰∫éÊ∞¥Âπ≥Ëß¶ÂèëÁöÑ‰∏≠Êñ≠Ôºå<code>TMR</code> ‰∏≠ÂØπÂ∫î‰ΩçÁΩÆ1„ÄÇ</li>
<li>ÁÑ∂Âêé <code>_apic_accept_irq</code> ÂáΩÊï∞Ê£ÄÊü•ÊòØÂê¶ÈÄöËøáÂèëÂ∏É-‰∏≠Êñ≠Êú∫Âà∂ÈÄí‰∫§ËôöÊãü‰∏≠Êñ≠Ôºü
<ul>
<li>Ëã•ÊòØÔºåÂàôÈÄöËøá <code>kvm_x86_ops</code> ÁöÑ<code>deliver_posted_interrupt</code> ÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ÁöÑ <code>vmx_deliver_posted_interrupt</code> ÂáΩÊï∞Ôºõ</li>
<li>Âê¶ÂàôÂÖàË∞ÉÁî® <code>kvm_lapic_set_irr</code> ÂáΩÊï∞ËÆæÁΩÆËôöÊãü <code>LAPIC IRR</code> ÁöÑÂÄº„ÄÇ<code>kvm_lapic_set_irr</code> ÂáΩÊï∞Â∞ÜÈÄöËøáÂâçËø∞ <code>kvm_lapic</code> ÁöÑregsÊàêÂëòËÆæÁΩÆËôöÊãü <code>IRR</code> Âπ∂Â∞ÜÂÖ∂ <code>kvm_lapic irr_pending</code> ÊàêÂëòËÆæ‰∏∫trueÔºõ</li>
</ul>
</li>
<li>Êé•‰∏ãÊù•Ôºå<code>__apic_set_irq</code> ÂáΩÊï∞Ë∞ÉÁî® <code>kvm_make_request</code> ÂáΩÊï∞ÂèëËµ∑‰∏Ä‰∏™KVM_REQ_EVENTÁ±ªÂûãÁöÑËØ∑Ê±ÇÔºåÂπ∂Ë∞ÉÁî® <code>kvm_vcpu_kick</code> ÂáΩÊï∞ÈÄöÁü•vCPU„ÄÇ
<ul>
<li>Â¶ÇÊûúÂΩìÂâçvCPUÁ∫øÁ®ãÊ≠£Â§Ñ‰∫éÁù°Áú†Áä∂ÊÄÅÔºå<code>kvm_vcpu_kick</code> ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>kvm_vcpu_wake_up</code> ÂáΩÊï∞Âî§ÈÜívCPUÁ∫øÁ®ãÔºõ</li>
<li>Â¶ÇÊûúvCPUÁ∫øÁ®ãÂΩìÂâçÊ≠£Âú®ËøêË°åÔºå<code>kvm_vcpu_kick</code> ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>smp_send_reschedule</code> ÂáΩÊï∞ÁªôÂÖ∂ÊâÄÂú®Áâ©ÁêÜCPUÂèëÈÄÅ‰∏Ä‰∏™IPI‰ΩøvCPUÂèëÁîüVM-Exit„ÄÇ</li>
<li>Êó†ËÆ∫ÊòØÂì™ÁßçÊÉÖÂÜµÔºåvCPUÊúÄÁªàÈÉΩ‰ºöË∞ÉÁî®ÂâçËø∞ <code>vcpu_enter_guest</code> ÂáΩÊï∞ÈáçÊñ∞ËøõÂÖ•ÈùûÊ†πÊ®°ÂºèÔºåËÄåÂú®Ê≠§‰πãÂâçÔºå<code>vcpu_enter_guest</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>kvm_check_request</code> ÂáΩÊï∞ÂèëÁé∞ÂΩìÂâçvCPUÊúâÂæÖÊ≥®ÂÖ•ÁöÑ‰∏≠Êñ≠ËØ∑Ê±Ç‰ªéËÄåË∞ÉÁî®<code>inject_pending_event</code> ÂáΩÊï∞Ê≥®ÂÖ•ËØ•ËôöÊãü‰∏≠Êñ≠„ÄÇ</li>
</ul>
</li>
</ul>
<p>Áõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/lapic.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222021111.png" alt="image-20231122202140086" style="zoom:33%;" />
<p><code>linux-4.19.0/virt/kvm/kvm_main.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222022068.png" alt="image-20231122202208218" style="zoom:33%;" />
<p>Ëá≥Ê≠§ÔºåKVM‰∏≠Êñ≠Ë∑ØÁî±ÁªìÊùüÔºå4.4ËäÇÂ∞Ü‰ºö‰ªãÁªç<strong>ËôöÊãü‰∏≠Êñ≠ÁöÑÊ≥®ÂÖ•ÊµÅÁ®ã„ÄÇ</strong></p>
<h2 id="44-ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•">4.4 ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•
</h2><p>ÂâçÊñáÊèêÂà∞ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•Áî± <code>vcpu_enter_guest</code> ÂáΩÊï∞Ë∞ÉÁî® <code>inject_pending_event</code> ÂáΩÊï∞ÂÆåÊàê„ÄÇÂÆûÈôÖ‰∏äÔºå<code>inject_pending_event</code> ÂáΩÊï∞‰∏ç‰ªÖÂèØ‰ª•Ê≥®ÂÖ•‰∏≠Êñ≠‰∫ã‰ª∂ÔºåËøòËÉΩÊ≥®ÂÖ•ÂºÇÂ∏∏‰∫ã‰ª∂Ôºå‰ΩÜÊú¨ËäÇÂè™ÂÖ≥ÂøÉ‰∏≠Êñ≠Ê≥®ÂÖ•ÁöÑÈÉ®ÂàÜ„ÄÇ</p>
<p><code>inject_pending_event</code> ÂáΩÊï∞È¶ñÂÖà‰ºöÊ£ÄÊü• <code>vcpu-&gt;arch.interrupt.injected</code> Âà§Êñ≠Á≥ªÁªü‰∏≠ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®ÂæÖÊ≥®ÂÖ•ÁöÑËôöÊãü‰∏≠Êñ≠„ÄÇÂ¶ÇÂú®Ê≥®ÂÖ•‰∏ä‰∏Ä‰∏™ËôöÊãü‰∏≠Êñ≠ËøáÁ®ã‰∏≠ÂèëÁîü‰∫ÜVM-ExitÔºåÁ°¨‰ª∂Â∞Ü‰ºöÊääÂΩìÂâçÊ≠£Âú®Ê≥®ÂÖ•ÁöÑ‰∏≠Êñ≠‰ø°ÊÅØ‰øùÂ≠òÂú®VMCS‰∏≠Êñ≠ÂêëÈáèÂè∑‰ø°ÊÅØ (IDT-Vectoring Information) Â≠óÊÆµ‰∏≠ÔºåÁÑ∂ÂêéKVMÂ∞Ü‰ºöËØªÂèñËØ•‰ø°ÊÅØÂπ∂Ë∞ÉÁî® <code>kvm_queue_interrupt</code> ÂáΩÊï∞Â∞Ü‰∏≠Êñ≠‰ø°ÊÅØ‰øùÂ≠òÂà∞ <code>vcpu-&gt;arch.interrupt</code> ÊàêÂëò‰∏≠ÔºåÂπ∂Â∞Ü <code>vcpu-&gt;arch.interrupt.injected</code> ËÆæ‰∏∫true‰æø‰∫éÂú®‰∏ã‰∏ÄÊ¨°Ë∞ÉÁî® <code>vcpu_enter_guest</code> ÂáΩÊï∞Êó∂ÈáçÊñ∞Ê≥®ÂÖ•ËØ•‰∫ã‰ª∂ÔºåËøô‰∏ÄÂ∑•‰ΩúÁî±ÂâçËø∞ <code>vmx_vcpu_run</code> ÂáΩÊï∞Ë∞ÉÁî®<code>vmx_complete_interrupts</code> ÂáΩÊï∞ÂÆåÊàê„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222024091.png" alt="image-20231122202404486" style="zoom:33%;" />
<p>Ëã•ÂΩìÂâçÁ≥ªÁªü‰∏≠‰∏çÂ≠òÂú®ÂæÖÊ≥®ÂÖ•‰∏≠Êñ≠Ôºå<code>inject_pending_event</code> ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî® <code>kvm_cpu_has_injectable_intr</code> ÂáΩÊï∞Ê£ÄÊü•ËôöÊãüLAPIC‰∏≠ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜÁöÑ‰∏≠Êñ≠„ÄÇËã•ÊúâÔºåÂàôÂêåÊ†∑Ë∞ÉÁî® <code>kvm_queue_interrupt</code> ÂáΩÊï∞‰øùÂ≠òËØ•‰∏≠Êñ≠‰ø°ÊÅØÔºåÂπ∂ÈÄöËøá<code>kvm_x86_ops</code> ÁöÑset_irqÊàêÂëòË∞ÉÁî®vmx.c‰∏≠ <code>vmx_inject_irq</code> ÂáΩÊï∞Ê≥®ÂÖ•‰∏≠Êñ≠„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222025985.png" alt="image-20231122202536391" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/x86.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222026642.png" alt="image-20231122202624438" style="zoom:33%;" />
<hr>
<p><code>vmx_inject_irq</code> ÂáΩÊï∞ÁöÑ‰∏ªË¶ÅÂ∑•‰ΩúÊòØÊ†πÊçÆ <code>vcpu.arch</code> ‰∏≠‰øùÂ≠òÁöÑ‰∏≠Êñ≠‰ø°ÊÅØËÆæÁΩÆÂâçËø∞VM-EntryÊéßÂà∂Âüü‰∏≠Êñ≠‰ø°ÊÅØÂ≠óÊÆµ„ÄÇÂú®VM-EntryÊó∂ÔºåCPU‰ºöÊ£ÄÊü•ËØ•Â≠óÊÆµÂèëÁé∞ÊúâÂæÖÂ§ÑÁêÜÁöÑ‰∏≠Êñ≠ÔºåÂπ∂Áî®‰∏≠Êñ≠ÂêëÈáèÂè∑Á¥¢ÂºïIDT‰ª•ÊâßË°åÁõ∏Â∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞„ÄÇÁõ∏ÂÖ≥‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p><code>linux-4.19.0/arch/x86/kvm/x86.h</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222027648.png" alt="image-20231122202726079" style="zoom:33%;" />
<p><code>linux-4.19.0/arch/x86/kvm/vmx.c</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311222030535.png" alt="image-20231122203008579" style="zoom:33%;" />
<p>Ëá≥Ê≠§Ôºå**ËôöÊãü‰∏≠Êñ≠Ê≥®ÂÖ•ÂÆåÊàê„ÄÇ**4.5ËäÇÂ∞Ü‰ª•e1000ÁΩëÂç°‰∏≠Êñ≠‰∏∫‰æãÔºå‰ªãÁªç‰∏≠Êñ≠ËôöÊãüÂåñÁöÑÂÆåÊï¥ÊµÅÁ®ã„ÄÇ</p>
<h2 id="45-ÂÆûÈ™å-e1000ÁΩëÂç°‰∏≠Êñ≠ËôöÊãüÂåñ">4.5 ÂÆûÈ™å: e1000ÁΩëÂç°‰∏≠Êñ≠ËôöÊãüÂåñ
</h2><p>ÂâçÂá†ËäÇ‰ªãÁªç‰∫ÜÂΩì‰∏≠Êñ≠ËäØÁâáÂÖ®ÈÉ®Áî±KVMÊ®°ÊãüÊó∂ÔºåÂ§ñÈÉ®ËÆæÂ§á‰∏≠Êñ≠‰º†ÈÄÅÁöÑÂÆåÊï¥ÊµÅÁ®ã„ÄÇÊú¨ËäÇÂ∞Ü‰ª•e1000ÁΩëÂç°‰∏∫‰æãÔºåÈÄöËøáGDBË∞ÉËØïÂ∑•ÂÖ∑ÂõûÈ°æÂâçËø∞ÊµÅÁ®ã„ÄÇ</p>
<h3 id="ÂÆûÈ™åÊ¶ÇËø∞">ÂÆûÈ™åÊ¶ÇËø∞
</h3><p>‰∏∫‰∫Ü‰ΩøÁî®GDBË∞ÉËØïËôöÊãü‰∏≠Êñ≠Âú®KVMÊ®°Âùó‰∏≠ÁöÑ‰º†ÈÄÅÊµÅÁ®ãÔºåÊú¨Ê¨°ÂÆûÈ™åÈúÄË¶ÅÂú®ÂµåÂ•óËôöÊãüÂåñÁöÑÁéØÂ¢É‰∏ãËøõË°åÔºåÁâ©ÁêÜÊú∫ÂíåËôöÊãüÊú∫‰ΩøÁî®ÁöÑÂÜÖÊ†∏ÁâàÊú¨Âùá‰∏∫4.19.0„ÄÇÊú¨ËäÇ‰ΩøÁî®ÂâçËø∞QEMUÊèê‰æõÁöÑ <code>-s</code> Âíå <code>-S</code> ÈÄâÈ°πÂêØÂä®‰∏Ä‰∏™ËôöÊãüÊú∫„ÄÇÂêØÂä®ÂëΩ‰ª§Â¶Ç‰∏ãÔºö</p>
<p><code>Physical Machine Terminal 1</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231719972.png" alt="image-20231123171810813" style="zoom:33%;" />
<p>Âú®ÁªàÁ´Ø2ÂêØÂä®GDBÂä†ËΩΩLinuxÂÜÖÊ†∏Ë∞ÉËØï‰ø°ÊÅØÂπ∂ËøûÊé•Ëá≥1234Á´ØÂè£ÔºåÁÑ∂ÂêéÂºÄÂßãËøêË°åËôöÊãüÊú∫„ÄÇËøêË°åÂëΩ‰ª§Â¶Ç‰∏ãÔºö</p>
<p><code>Physical Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231719309.png" alt="image-20231123171859047" style="zoom:33%;" />
<p>‰∏∫‰∫ÜÂä†ËΩΩKVMÊ®°ÂùóÁöÑË∞ÉËØï‰ø°ÊÅØÔºåËØªËÄÖÈúÄË¶ÅÂú®ËôöÊãüÊú∫‰∏≠ÈÄöËøá <code>/sys/module/module_name/sections</code> Êü•Áúã <code>kvm.ko</code> Âíå <code>kvm-intel.ko</code> Ê®°ÂùóÊâÄÂú®ÁöÑGPAÔºåÂπ∂Âú®GDB‰∏≠ÊâãÂä®ÂºïÂÖ•KVMÊ®°ÂùóÁöÑË∞ÉËØï‰ø°ÊÅØ„ÄÇËøêË°åÂëΩ‰ª§Â¶Ç‰∏ã„ÄÇ</p>
<p><code>Virtual Machine Terminal 1</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231719366.png" alt="image-20231123171941476" style="zoom:33%;" />
<p><code>Physical Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231720645.png" alt="image-20231123172009276" style="zoom:33%;" />
<p>Êé•ÁùÄ<strong>Âú®ËôöÊãüÊú∫‰∏≠ÂêØÂä®ÂµåÂ•óËôöÊãüÊú∫Âπ∂ËøêË°åÔºå</strong><code>-monitor</code> ÈÄâÈ°πÊåáÂÆö‰∫ÜQEMUÁõëËßÜÂô® (QEMU monitor) ÁöÑËøêË°åÁ´ØÂè£‰∏∫ <code>4444</code>„ÄÇËØªËÄÖÂèØ‰ª•Âè¶Â§ñÂêØÂä®‰∏Ä‰∏™ÁªàÁ´ØËøûÊé•Ëá≥QEMUÁõëËßÜÂô®„ÄÇQEMUÁõëËßÜÂô®Êèê‰æõ‰∫ÜÂêÑÁßçÂëΩ‰ª§Áî®‰∫éÊü•ÁúãËôöÊãüÊú∫ÁöÑÂΩìÂâçÁä∂ÊÄÅ„ÄÇËøôÈáåÂèØ‰ª•ÈÄöËøá <code>info qtree</code> Êü•ÁúãÂΩìÂâçËôöÊãüÊú∫ÁöÑÊû∂ÊûÑ„ÄÇÂèØ‰ª•ÂèëÁé∞ËôöÊãüÊú∫‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®‰∏∫APIC„ÄÇËôöÊãüIOAPICÁõ¥Êé•ÊåÇËΩΩÂú® <code>main-system-bus</code> ‰∏äÔºåËÄåe1000ÁΩëÂç°ÊåÇËΩΩÂêç‰∏∫ <code>pic.0</code> ÁöÑPCIÊÄªÁ∫ø‰∏ä„ÄÇÂêØÂä®ÂëΩ‰ª§Â¶Ç‰∏ãÔºö</p>
<p><code>Virtual Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231721921.png" alt="image-20231123172038266" style="zoom:33%;" />
<p><code>Virtual Machine Terminal 3</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231721711.png" alt="image-20231123172104898" style="zoom:33%;" />
<hr>
<p>Âú®ÂµåÂ•óËôöÊãüÊú∫‰∏≠ÂêØÂä®‰∏Ä‰∏™ÁªàÁ´ØÂπ∂ÊâßË°å <code>lspci-v</code> Êåá‰ª§ÔºåÂèØ‰ª•Êü•ÁúãÂΩìÂâçËôöÊãüÊú∫‰∏≠ÁöÑPCIËÆæÂ§áÔºåe1000ÁΩëÂç°ÂÖ∑‰Ωì‰ø°ÊÅØÂ¶Ç‰∏ã„ÄÇ</p>
<p><code>Nested Virtual Machine Terminal 1</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231722716.png" alt="image-20231123172147932" style="zoom:33%;" />
<p>‰∏äËø∞‰ø°ÊÅØË°®Êòée1000ÁΩëÂç°ÁöÑBDF‰∏∫ <code>00:03.0</code>ÔºåÂç≥24ÔºåËÄåe1000ÁΩëÂç°‰ΩøÁî®ÁöÑ‰∏≠Êñ≠IRQÂè∑‰∏∫11Ôºå‰ªãÁªç‰∏≠Êñ≠‰º†ÈÄíÊó∂ÊèêÂà∞Âú®QEMU/KVM‰∏≠GSI‰∏éIRQÁ≠â‰ª∑ÔºåÈô§‰∫Ü0Âè∑‰∏≠Êñ≠ÂºïËÑöÂ§ñÔºåÂÖ∂‰ΩôIOAPICÂºïËÑö‰∏éGSIÊª°Ë∂≥ <code>GSI = GSI_base + Pin</code> Êò†Â∞ÑÂÖ≥Á≥ªÔºåÊïÖe1000ÁΩëÂç°ÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑‰∏∫11„ÄÇÁÑ∂Âêé‰ΩøÁî®QEMUÁõëËßÜÂô®ËæìÂÖ• <code>info pic</code> Êü•ÁúãËôöÊãüÊú∫IOAPIC‰ø°ÊÅØ„ÄÇ</p>
<p><code>Virtual Machine Terminal 3</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231722226.png" alt="image-20231123172231931" style="zoom:33%;" />
<p>‰ª•‰∏äËæìÂá∫Ë°®ÊòéËôöÊãüIOAPICÁöÑ11Âè∑‰∏≠Êñ≠ÂºïËÑöÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑‰∏∫38ÔºåÂç≥e1000ÁΩëÂç°‰ΩøÁî® <code>38</code> Âè∑‰∏≠Êñ≠ÂêëÈáè„ÄÇ‰∏ãÈù¢Â∞ÜÈÄöËøáGDBÊü•Áúãe1000ÁΩëÂç°‰∏≠Êñ≠‰º†ÈÄÅËøáÁ®ã‰∏≠ÁöÑÂÖ≥ÈîÆÂáΩÊï∞Ë∞ÉÁî®‰ª•Âèä‰∏≠Êñ≠‰ø°ÊÅØ„ÄÇ</p>
<h3 id="e1000ÁΩëÂç°‰∏≠Êñ≠‰º†ÈÄÅÊµÅÁ®ã">e1000ÁΩëÂç°‰∏≠Êñ≠‰º†ÈÄÅÊµÅÁ®ã
</h3><p>ÁΩëÂç°Âú®Êî∂ÂèëÂåÖÊó∂ÈÉΩ‰ºö‰∫ßÁîü‰∏≠Êñ≠ÔºåËÄåÂØπ‰∫ée1000ÁΩëÂç°ÔºåÊó†ËÆ∫ÊòØÊî∂ÂåÖ‰∏≠Êñ≠ËøòÊòØÂèëÂåÖ‰∏≠Êñ≠ÔºåÊúÄÂêéÈÉΩ‰ºöË∞ÉÁî® <code>set_interrupt_cause</code> ÂáΩÊï∞„ÄÇËØªËÄÖÂèØ‰ª•ÈÄöËøáÂâçËø∞ <code>Virtual Machine Terminal 2</code> ‰∏≠ËøêË°åÁöÑGDBÂú® <code>set_interrupt_cause</code> ÂáΩÊï∞Â§ÑËÆæÁΩÆÊñ≠ÁÇπÂπ∂ÁªßÁª≠ËøêË°åËØ•Á®ãÂ∫è„ÄÇÂΩìËß¶ÂèëËØ•Êñ≠ÁÇπÂêéÔºåÊâìÂç∞Âá∫e1000ÁΩëÂç°ÁöÑËÆæÂ§áÂè∑‰∏∫24Ôºå‰∏é <code>lspci-v</code> Êåá‰ª§ÁªìÊûúÁõ∏Á¨¶„ÄÇ</p>
<p><code>Virtual Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231725989.png" alt="image-20231123172415478" style="zoom:33%;" />
<p><code>set_interrupt_cause</code> ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî®PCIËÆæÂ§áÂÖ±Áî®ÁöÑ‰∏≠Êñ≠Êé•Âè£ <code>pci_set_irq</code> ÂáΩÊï∞Ëß¶Âèë‰∏≠Êñ≠Ôºå‰∏∫‰∫ÜÂå∫Âà´e1000ÁΩëÂç°‰∏éÂÖ∂‰ªñPCIËÆæÂ§áÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®GDBÊù°‰ª∂Êñ≠ÁÇπÔºå‰ΩøÂæóÂè™ÊúâËÆæÂ§áÂè∑‰∏∫24Êó∂ÊâçÂëΩ‰∏≠ <code>pci_set_irq</code> ‰∏≠ÁöÑÊñ≠ÁÇπ„ÄÇÁªàÁ´ØËæìÂá∫Ë°®Êòée1000ÁΩëÂç°‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑Ôºà<code>intx</code> ÂèòÈáèÔºâ‰∏∫0ÔºåÂç≥e1000ÁΩëÂç°‰ΩøÁî® <code>INTA#</code> ‰∏≠Êñ≠ÂºïËÑö„ÄÇ</p>
<p><code>Virtual Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231725685.png" alt="image-20231123172450445" style="zoom:33%;" />
<p>Â¶ÇÂâçÊâÄËø∞Ôºå<code>pci_irq_handler</code> ÂáΩÊï∞ÊúÄÁªà‰ºöË∞ÉÁî® <code>pci_change_irq_level</code> ÂáΩÊï∞Ëé∑ÂæóPCIËÆæÂ§á‰∏≠Êñ≠ÂºïËÑöÊâÄËøûÊé•ÁöÑPCIÊÄªÁ∫ø‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø„ÄÇ<code>pci_change_irq_level</code> ÂáΩÊï∞ÈÄöËøáË∞ÉÁî®ÊâÄÂ±ûÊÄªÁ∫øÁöÑ <code>map_irq</code> ÂõûË∞ÉÂáΩÊï∞ <code>pci_slot_get_irq</code> ÂÆåÊàê‰∏äËø∞ËΩ¨Êç¢„ÄÇÂú®ËØ•Ë°åËÆæÁΩÆÊñ≠ÁÇπÂπ∂ÊâìÂç∞Âá∫ÂØπÂ∫îÁöÑPCIÈìæÊé•ËÆæÂ§áÂè∑ÔºàÂØπÂ∫î <code>irq_num</code>Ôºâ‰∏∫2ÔºåÊïÖe1000ÁΩëÂç°ÁöÑ <code>INTA#</code> ‰∏≠Êñ≠ÂºïËÑöËøûÊé•Ëá≥ <code>LNKC</code> ‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫ø„ÄÇ</p>
<p><code>Virtual Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231726018.png" alt="image-20231123172606710" style="zoom:33%;" />
<p>ËÄå <code>pci_change_irq_level</code> ÂáΩÊï∞Â∞Ü‰ºöË∞ÉÁî®ÊÄªÁ∫øÊàêÂëòÁöÑset_irqÂõûË∞ÉÂáΩÊï∞ <code>piix3_set_irq</code>ÔºåËøõËÄåË∞ÉÁî® <code>piix3_set_irq_level</code> ÂáΩÊï∞„ÄÇËØ•ÂáΩÊï∞ÈÄöËøáPIIX3ËÆæÂ§áPCIÈÖçÁΩÆÁ©∫Èó¥‰∏≠ÁöÑ <code>PIRQRC[A:D]</code> ÂØÑÂ≠òÂô®**Ëé∑ÂèñPCIÊÄªÁ∫øÊüêÊù°‰∏≠Êñ≠ËØ∑Ê±ÇÁ∫øÂØπÂ∫îÁöÑIOAPIC IRQÁ∫ø„ÄÇ**Âú®ËØ•ÂáΩÊï∞‰∏≠Êñ≠ÁÇπÊâìÂç∞e1000ÁΩëÂç°ÂØπÂ∫îÁöÑIRQÁ∫ø(<code>pci_irq</code>)ÔºåÂÖ∂ÂÄº‰∏∫11„ÄÇ</p>
<p><code>Virtual Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231727713.png" alt="image-20231123172659958" style="zoom:33%;" />
<p><code>piix3_set_irq_level</code> ÂáΩÊï∞Ëé∑ÂæóPCIËÆæÂ§áÂØπÂ∫îÁöÑIRQÁ∫øÂêé‰ºöË∞ÉÁî® <code>piix3_set_irq_pic</code> ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞ËøõËÄåË∞ÉÁî® <code>qemu_set_irq</code> ÂáΩÊï∞ÁªèÁî±4.4ËäÇ‰ªãÁªçÁöÑQEMU‰∏≠Êñ≠Ë∑ØÁî±ËøáÁ®ãÂêéÔºåÊúÄÁªàË∞ÉÁî® <code>kvm_set_irq</code> ÂáΩÊï∞Â∞Ü‰∏≠Êñ≠‰ø°Âè∑‰º†ÈÄíËá≥KVMÊ®°ÊãüÁöÑ‰∏≠Êñ≠ËäØÁâá„ÄÇË∞ÉÁî®GDB <code>backtrace</code> ÂëΩ‰ª§ÊâìÂç∞Âá∫ÂΩìÂâçÂáΩÊï∞Ë∞ÉÁî®Ê†àÂ∏ßÔºå‰∏éQEMU‰∏≠Êñ≠Ë∑ØÁî±ÊµÅÁ®ãÁõ∏Á¨¶„ÄÇÂ¶Ç‰∏ãÔºö</p>
<p><code>Virtual Machine Terminal 2</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231727828.png" alt="image-20231123172742648" style="zoom:33%;" />
<hr>
<p>**‰∏≠Êñ≠‰ø°Âè∑‰º†ÂÖ•KVMÂêéÔºå**ÁªèÁî±4.4ËäÇ‰ªãÁªçÁöÑÂÜÖÊ†∏‰∏≠Êñ≠Ë∑ØÁî±Ë°®ÔºåÂ∞Ü‰∏≠Êñ≠‰ø°Âè∑ÂèëÈÄÅËá≥ÊâÄÊúâÂèØËÉΩÁöÑËôöÊãü‰∏≠Êñ≠ÊéßÂà∂Âô®„ÄÇÂØπ‰∫éÊú¨ÂÆûÈ™åÊù•ËØ¥ÔºåËôöÊãüÊú∫‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÊéßÂà∂Âô®‰∏∫IOAPICÔºåÂØπÂ∫îÁöÑÂõûË∞ÉÂáΩÊï∞‰∏∫ <code>kvm_set_ioapic_irq</code>ÔºåËØ•ÂáΩÊï∞Â∞ÜË∞ÉÁî® <code>kvm_ioapic_set_irq</code> ÂáΩÊï∞Â§ÑÁêÜÊåáÂÆö‰∏≠Êñ≠ÂºïËÑö‰º†Êù•ÁöÑ‰∏≠Êñ≠‰ø°Âè∑„ÄÇÈÄöËøáGDBÂú®ËØ•ÂáΩÊï∞Â§ÑËÆæÁΩÆÊñ≠ÁÇπÔºåÂèØ‰ª•ÂèëÁé∞‰º†ÂÖ• <code>kvm_ioapic_set_irq</code> ÂáΩÊï∞ÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑‰∏∫11ÔºåÂç≥e1000‰∏≠Êñ≠ÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑‰∏∫11„ÄÇ</p>
<p><code>Physical Machine Terminal 1</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231728332.png" alt="image-20231123172820241" style="zoom:33%;" />
<p>Â¶ÇÂâçÊâÄËø∞Ôºå<code>kvm_ioapic_set_irq</code> ÂáΩÊï∞ÊúÄÁªàË∞ÉÁî® <code>ioapic_service</code> ÂáΩÊï∞Â§ÑÁêÜÊåáÂÆöÂºïËÑöÁöÑ‰∏≠Êñ≠ËØ∑Ê±Ç„ÄÇ<code>ioapic_service</code> ÂáΩÊï∞Ê†πÊçÆ‰º†ÂÖ•ÁöÑ‰∏≠Êñ≠ÂºïËÑöÂè∑Âú® <code>PRT(ioapic-&gt;redirtbl)</code> ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑRTEÂπ∂Ê†ºÂºèÂåñÂá∫‰∏ÄÊù°‰∏≠Êñ≠Ê∂àÊÅØ <code>irqe</code> ÂèëÈÄÅÁªôÊâÄÊúâÁöÑÁõÆÊ†áLAPIC„ÄÇ</p>
<p><code>irqe</code> ‰∏≠ÂåÖÂê´‰æõCPUÊúÄÁªà‰ΩøÁî®ÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑„ÄÇÂú® <code>ioapic_service</code> ÂáΩÊï∞‰∏≠ËÆæÁΩÆÊñ≠ÁÇπÊâìÂç∞‰∏≠Êñ≠Ê∂àÊÅØ <code>irqe</code>ÔºåÂèØ‰ª•ÂèëÁé∞e1000ÁΩëÂç°ÂØπÂ∫îÁöÑ‰∏≠Êñ≠ÂêëÈáèÂè∑‰∏∫38ÔºåËß¶ÂèëÊñπÂºè‰∏∫Ê∞¥Âπ≥Ëß¶Âèë (trig_mode=1)Ôºå‰∏éÈÄöËøáQEMUÁõëËßÜÂô®ÊâßË°å <code>info pic</code> ÂëΩ‰ª§ÂæóÂà∞ÁöÑ‰ø°ÊÅØÂÆåÂÖ®‰∏ÄËá¥„ÄÇ</p>
<p><code>Physical Machine Terminal 1</code></p>
<img src="https://cdn.jsdelivr.net/gh/MaskerDad/BlogImage@main/202311231729013.png" alt="image-20231123172852451" style="zoom:33%;" />
<p>ÂêéÁª≠ÊµÅÁ®ã‰∏∫Ôºö</p>
<ol>
<li>ËôöÊãüLAPICÊî∂Âà∞‰∏≠Êñ≠Ê∂àÊÅØÂêéÔºåÂ∞ÜËÆæÁΩÆ <code>IRR</code> Âπ∂Ë∞ÉÁî® <code>vcpu_kick</code> ÂáΩÊï∞ÈÄöÁü•vCPUÔºõ</li>
<li>ÂΩìvCPUÂÜçÊ¨°Ë∞ÉÁî® <code>vcpu_enter_guest</code> ÂáΩÊï∞ÂáÜÂ§áËøõÂÖ•ÈùûÊ†πÊ®°ÂºèÊó∂ÔºåÂèëÁé∞ÂΩìÂâçÊúâÂæÖÊ≥®ÂÖ•ÁöÑËôöÊãü‰∏≠Êñ≠„ÄÇÊúÄÁªà <code>vcpu_enter_guest</code> ÂáΩÊï∞‰ºöË∞ÉÁî® <code>vmx_inject_irq</code> ÂáΩÊï∞ËÆæÁΩÆVMCS VM-EntryÊéßÂà∂Âüü‰∏≠ÁöÑ‰∏≠Êñ≠‰ø°ÊÅØÂ≠óÊÆµÔºõ</li>
<li>ÂΩìËôöÊãüÊú∫ÊÅ¢Â§çËøêË°åÊó∂ÔºåCPU‰ºöÊ£ÄÊü•ËØ•Â≠óÊÆµÂèëÁé∞ÊúâÂæÖÂ§ÑÁêÜÁöÑe1000ÁΩëÂç°‰∏≠Êñ≠ÔºåÂàôCPUÂ∞ÜÊâßË°åÁõ∏Â∫îÁöÑ‰∏≠Êñ≠ÊúçÂä°‰æãÁ®ã„ÄÇ</li>
</ol>
<p>Ëá≥Ê≠§Ôºåe1000ÁΩëÂç°‰∫ßÁîüÁöÑËôöÊãü‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ãÂÆåÊàê„ÄÇ</p>
<hr>
<p>Êú¨ËäÇÈÄöËøáGDBÂ±ïÁ§∫‰∫Üe1000ÁΩëÂç°ËôöÊãü‰∏≠Êñ≠Â§ÑÁêÜÊµÅÁ®ãÔºåÁùÄÈáçÂ±ïÁ§∫‰∫Ü<strong>PCIËÆæÂ§á‰∏≠Êñ≠ÂºïËÑöÂè∑‰∏éIRQÂè∑ÁöÑÊò†Â∞Ñ</strong>‰ª•Âèä<strong>IRQÂè∑‰∏é‰∏≠Êñ≠ÂêëÈáèÂè∑ÁöÑÊò†Â∞Ñ</strong>ÂÖ≥Á≥ª„ÄÇ</p>
<h1 id="5-todo-giantvm-cpuËôöÊãüÂåñ">5 //TODO: GiantVM CPUËôöÊãüÂåñ
</h1>
</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 zcxGGmu
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<div id="particles-js"></div>

<script src=https://zcxggmu.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://zcxggmu.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>


    </body>
</html>
